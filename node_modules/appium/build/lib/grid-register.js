"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

const hubUri = config => {
  const protocol = config.hubProtocol || 'http';
  return `${protocol}://${config.hubHost}:${config.hubPort}`;
};

async function registerNode(configFile, addr, port) {
  let data;

  try {
    data = await _appiumSupport.fs.readFile(configFile, 'utf-8');
  } catch (err) {
    _logger.default.error(`Unable to load node configuration file to register with grid: ${err.message}`);

    return;
  }

  if (!data) {
    _logger.default.error('No data found in the node configuration file to send to the grid');

    return;
  }

  postRequest(data, addr, port);
}

async function registerToGrid(options_post, jsonObject) {
  try {
    let response = await (0, _requestPromise.default)(options_post);

    if (response === undefined || response.statusCode !== 200) {
      throw new Error('Request failed');
    }

    let logMessage = `Appium successfully registered with the grid on ${hubUri(jsonObject.configuration)}`;

    _logger.default.debug(logMessage);
  } catch (err) {
    _logger.default.error(`Request to register with grid was unsuccessful: ${err.message}`);
  }
}

function postRequest(data, addr, port) {
  let jsonObject;

  try {
    jsonObject = JSON.parse(data);
  } catch (err) {
    _logger.default.errorAndThrow(`Syntax error in node configuration file: ${err.message}`);
  }

  if (!jsonObject.hasOwnProperty('configuration')) {
    let configuration = {};

    for (let property in jsonObject) {
      if (jsonObject.hasOwnProperty(property) && property !== 'capabilities') {
        configuration[property] = jsonObject[property];
        delete jsonObject[property];
      }
    }

    jsonObject.configuration = configuration;
  }

  if (!jsonObject.configuration.url || !jsonObject.configuration.host || !jsonObject.configuration.port) {
    jsonObject.configuration.url = `http://${addr}:${port}/wd/hub`;
    jsonObject.configuration.host = addr;
    jsonObject.configuration.port = port;
  }

  if (!jsonObject.configuration.id) {
    jsonObject.configuration.id = `http://${jsonObject.configuration.host}:${jsonObject.configuration.port}`;
  }

  data = JSON.stringify(jsonObject);
  let post_headers = {
    'Content-Type': 'application/json',
    'Content-Length': data.length
  };
  let post_options = {
    url: `${hubUri(jsonObject.configuration)}/grid/register`,
    method: 'POST',
    body: data,
    headers: post_headers,
    resolveWithFullResponse: true
  };

  if (jsonObject.configuration.register !== true) {
    _logger.default.debug(`No registration sent (${jsonObject.configuration.register} = false)`);

    return;
  }

  let registerCycleTime = jsonObject.configuration.registerCycle;

  if (registerCycleTime !== null && registerCycleTime > 0) {
    let first = true;

    _logger.default.debug(`Starting auto register thread for grid. Will try to register every ${registerCycleTime} ms.`);

    setInterval(async function registerRetry() {
      if (first !== true) {
        let isRegistered = await isAlreadyRegistered(jsonObject);

        if (isRegistered !== null && isRegistered !== true) {
          await registerToGrid(post_options, jsonObject);
        }
      } else {
        first = false;
        await registerToGrid(post_options, jsonObject);
      }
    }, registerCycleTime);
  }
}

async function isAlreadyRegistered(jsonObject) {
  let id = jsonObject.configuration.id;

  try {
    let response = await (0, _requestPromise.default)({
      uri: `${hubUri(jsonObject.configuration)}/grid/api/proxy?id=${id}`,
      method: 'GET',
      timeout: 10000,
      resolveWithFullResponse: true
    });

    if (response === undefined || response.statusCode !== 200) {
      throw new Error(`Request failed`);
    }

    let responseData = JSON.parse(response.body);

    if (responseData.success !== true) {
      _logger.default.debug(`Grid registration error: ${responseData.msg}`);
    }

    return responseData.success;
  } catch (err) {
    _logger.default.debug(`Hub down or not responding: ${err.message}`);
  }
}

var _default = registerNode;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ncmlkLXJlZ2lzdGVyLmpzIl0sIm5hbWVzIjpbImh1YlVyaSIsImNvbmZpZyIsInByb3RvY29sIiwiaHViUHJvdG9jb2wiLCJodWJIb3N0IiwiaHViUG9ydCIsInJlZ2lzdGVyTm9kZSIsImNvbmZpZ0ZpbGUiLCJhZGRyIiwicG9ydCIsImRhdGEiLCJmcyIsInJlYWRGaWxlIiwiZXJyIiwibG9nZ2VyIiwiZXJyb3IiLCJtZXNzYWdlIiwicG9zdFJlcXVlc3QiLCJyZWdpc3RlclRvR3JpZCIsIm9wdGlvbnNfcG9zdCIsImpzb25PYmplY3QiLCJyZXNwb25zZSIsInVuZGVmaW5lZCIsInN0YXR1c0NvZGUiLCJFcnJvciIsImxvZ01lc3NhZ2UiLCJjb25maWd1cmF0aW9uIiwiZGVidWciLCJKU09OIiwicGFyc2UiLCJlcnJvckFuZFRocm93IiwiaGFzT3duUHJvcGVydHkiLCJwcm9wZXJ0eSIsInVybCIsImhvc3QiLCJpZCIsInN0cmluZ2lmeSIsInBvc3RfaGVhZGVycyIsImxlbmd0aCIsInBvc3Rfb3B0aW9ucyIsIm1ldGhvZCIsImJvZHkiLCJoZWFkZXJzIiwicmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2UiLCJyZWdpc3RlciIsInJlZ2lzdGVyQ3ljbGVUaW1lIiwicmVnaXN0ZXJDeWNsZSIsImZpcnN0Iiwic2V0SW50ZXJ2YWwiLCJyZWdpc3RlclJldHJ5IiwiaXNSZWdpc3RlcmVkIiwiaXNBbHJlYWR5UmVnaXN0ZXJlZCIsInVyaSIsInRpbWVvdXQiLCJyZXNwb25zZURhdGEiLCJzdWNjZXNzIiwibXNnIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLE1BQU0sR0FBSUMsTUFBRCxJQUFZO0FBQ3pCLFFBQU1DLFFBQVEsR0FBR0QsTUFBTSxDQUFDRSxXQUFQLElBQXNCLE1BQXZDO0FBQ0EsU0FBUSxHQUFFRCxRQUFTLE1BQUtELE1BQU0sQ0FBQ0csT0FBUSxJQUFHSCxNQUFNLENBQUNJLE9BQVEsRUFBekQ7QUFDRCxDQUhEOztBQUtBLGVBQWVDLFlBQWYsQ0FBNkJDLFVBQTdCLEVBQXlDQyxJQUF6QyxFQUErQ0MsSUFBL0MsRUFBcUQ7QUFDbkQsTUFBSUMsSUFBSjs7QUFDQSxNQUFJO0FBQ0ZBLElBQUFBLElBQUksR0FBRyxNQUFNQyxrQkFBR0MsUUFBSCxDQUFZTCxVQUFaLEVBQXdCLE9BQXhCLENBQWI7QUFDRCxHQUZELENBRUUsT0FBT00sR0FBUCxFQUFZO0FBQ1pDLG9CQUFPQyxLQUFQLENBQWMsaUVBQWdFRixHQUFHLENBQUNHLE9BQVEsRUFBMUY7O0FBQ0E7QUFDRDs7QUFHRCxNQUFJLENBQUNOLElBQUwsRUFBVztBQUNUSSxvQkFBT0MsS0FBUCxDQUFhLGtFQUFiOztBQUNBO0FBQ0Q7O0FBQ0RFLEVBQUFBLFdBQVcsQ0FBQ1AsSUFBRCxFQUFPRixJQUFQLEVBQWFDLElBQWIsQ0FBWDtBQUNEOztBQUVELGVBQWVTLGNBQWYsQ0FBK0JDLFlBQS9CLEVBQTZDQyxVQUE3QyxFQUF5RDtBQUN2RCxNQUFJO0FBQ0YsUUFBSUMsUUFBUSxHQUFHLE1BQU0sNkJBQVFGLFlBQVIsQ0FBckI7O0FBQ0EsUUFBSUUsUUFBUSxLQUFLQyxTQUFiLElBQTBCRCxRQUFRLENBQUNFLFVBQVQsS0FBd0IsR0FBdEQsRUFBMkQ7QUFDekQsWUFBTSxJQUFJQyxLQUFKLENBQVUsZ0JBQVYsQ0FBTjtBQUNEOztBQUNELFFBQUlDLFVBQVUsR0FBSSxtREFBa0R6QixNQUFNLENBQUNvQixVQUFVLENBQUNNLGFBQVosQ0FBMkIsRUFBckc7O0FBQ0FaLG9CQUFPYSxLQUFQLENBQWFGLFVBQWI7QUFDRCxHQVBELENBT0UsT0FBT1osR0FBUCxFQUFZO0FBQ1pDLG9CQUFPQyxLQUFQLENBQWMsbURBQWtERixHQUFHLENBQUNHLE9BQVEsRUFBNUU7QUFDRDtBQUNGOztBQUVELFNBQVNDLFdBQVQsQ0FBc0JQLElBQXRCLEVBQTRCRixJQUE1QixFQUFrQ0MsSUFBbEMsRUFBd0M7QUFFdEMsTUFBSVcsVUFBSjs7QUFDQSxNQUFJO0FBQ0ZBLElBQUFBLFVBQVUsR0FBR1EsSUFBSSxDQUFDQyxLQUFMLENBQVduQixJQUFYLENBQWI7QUFDRCxHQUZELENBRUUsT0FBT0csR0FBUCxFQUFZO0FBQ1pDLG9CQUFPZ0IsYUFBUCxDQUFzQiw0Q0FBMkNqQixHQUFHLENBQUNHLE9BQVEsRUFBN0U7QUFDRDs7QUFHRCxNQUFJLENBQUNJLFVBQVUsQ0FBQ1csY0FBWCxDQUEwQixlQUExQixDQUFMLEVBQWlEO0FBQy9DLFFBQUlMLGFBQWEsR0FBRyxFQUFwQjs7QUFDQSxTQUFLLElBQUlNLFFBQVQsSUFBcUJaLFVBQXJCLEVBQWlDO0FBQy9CLFVBQUlBLFVBQVUsQ0FBQ1csY0FBWCxDQUEwQkMsUUFBMUIsS0FBdUNBLFFBQVEsS0FBSyxjQUF4RCxFQUF3RTtBQUN0RU4sUUFBQUEsYUFBYSxDQUFDTSxRQUFELENBQWIsR0FBMEJaLFVBQVUsQ0FBQ1ksUUFBRCxDQUFwQztBQUNBLGVBQU9aLFVBQVUsQ0FBQ1ksUUFBRCxDQUFqQjtBQUNEO0FBQ0Y7O0FBQ0RaLElBQUFBLFVBQVUsQ0FBQ00sYUFBWCxHQUEyQkEsYUFBM0I7QUFDRDs7QUFPRCxNQUFJLENBQUNOLFVBQVUsQ0FBQ00sYUFBWCxDQUF5Qk8sR0FBMUIsSUFBaUMsQ0FBQ2IsVUFBVSxDQUFDTSxhQUFYLENBQXlCUSxJQUEzRCxJQUFtRSxDQUFDZCxVQUFVLENBQUNNLGFBQVgsQ0FBeUJqQixJQUFqRyxFQUF1RztBQUNyR1csSUFBQUEsVUFBVSxDQUFDTSxhQUFYLENBQXlCTyxHQUF6QixHQUFnQyxVQUFTekIsSUFBSyxJQUFHQyxJQUFLLFNBQXREO0FBQ0FXLElBQUFBLFVBQVUsQ0FBQ00sYUFBWCxDQUF5QlEsSUFBekIsR0FBZ0MxQixJQUFoQztBQUNBWSxJQUFBQSxVQUFVLENBQUNNLGFBQVgsQ0FBeUJqQixJQUF6QixHQUFnQ0EsSUFBaEM7QUFDRDs7QUFFRCxNQUFJLENBQUNXLFVBQVUsQ0FBQ00sYUFBWCxDQUF5QlMsRUFBOUIsRUFBa0M7QUFDaENmLElBQUFBLFVBQVUsQ0FBQ00sYUFBWCxDQUF5QlMsRUFBekIsR0FBK0IsVUFBU2YsVUFBVSxDQUFDTSxhQUFYLENBQXlCUSxJQUFLLElBQUdkLFVBQVUsQ0FBQ00sYUFBWCxDQUF5QmpCLElBQUssRUFBdkc7QUFDRDs7QUFHREMsRUFBQUEsSUFBSSxHQUFHa0IsSUFBSSxDQUFDUSxTQUFMLENBQWVoQixVQUFmLENBQVA7QUFHQSxNQUFJaUIsWUFBWSxHQUFHO0FBQ2pCLG9CQUFnQixrQkFEQztBQUVqQixzQkFBa0IzQixJQUFJLENBQUM0QjtBQUZOLEdBQW5CO0FBS0EsTUFBSUMsWUFBWSxHQUFHO0FBQ2pCTixJQUFBQSxHQUFHLEVBQUcsR0FBRWpDLE1BQU0sQ0FBQ29CLFVBQVUsQ0FBQ00sYUFBWixDQUEyQixnQkFEeEI7QUFFakJjLElBQUFBLE1BQU0sRUFBRSxNQUZTO0FBR2pCQyxJQUFBQSxJQUFJLEVBQUUvQixJQUhXO0FBSWpCZ0MsSUFBQUEsT0FBTyxFQUFFTCxZQUpRO0FBS2pCTSxJQUFBQSx1QkFBdUIsRUFBRTtBQUxSLEdBQW5COztBQVFBLE1BQUl2QixVQUFVLENBQUNNLGFBQVgsQ0FBeUJrQixRQUF6QixLQUFzQyxJQUExQyxFQUFnRDtBQUM5QzlCLG9CQUFPYSxLQUFQLENBQWMseUJBQXdCUCxVQUFVLENBQUNNLGFBQVgsQ0FBeUJrQixRQUFTLFdBQXhFOztBQUNBO0FBQ0Q7O0FBRUQsTUFBSUMsaUJBQWlCLEdBQUd6QixVQUFVLENBQUNNLGFBQVgsQ0FBeUJvQixhQUFqRDs7QUFDQSxNQUFJRCxpQkFBaUIsS0FBSyxJQUF0QixJQUE4QkEsaUJBQWlCLEdBQUcsQ0FBdEQsRUFBeUQ7QUFFdkQsUUFBSUUsS0FBSyxHQUFHLElBQVo7O0FBQ0FqQyxvQkFBT2EsS0FBUCxDQUFjLHNFQUFxRWtCLGlCQUFrQixNQUFyRzs7QUFDQUcsSUFBQUEsV0FBVyxDQUFDLGVBQWVDLGFBQWYsR0FBZ0M7QUFDMUMsVUFBSUYsS0FBSyxLQUFLLElBQWQsRUFBb0I7QUFDbEIsWUFBSUcsWUFBWSxHQUFHLE1BQU1DLG1CQUFtQixDQUFDL0IsVUFBRCxDQUE1Qzs7QUFDQSxZQUFJOEIsWUFBWSxLQUFLLElBQWpCLElBQXlCQSxZQUFZLEtBQUssSUFBOUMsRUFBb0Q7QUFFbEQsZ0JBQU1oQyxjQUFjLENBQUNxQixZQUFELEVBQWVuQixVQUFmLENBQXBCO0FBQ0Q7QUFDRixPQU5ELE1BTU87QUFDTDJCLFFBQUFBLEtBQUssR0FBRyxLQUFSO0FBQ0EsY0FBTTdCLGNBQWMsQ0FBQ3FCLFlBQUQsRUFBZW5CLFVBQWYsQ0FBcEI7QUFDRDtBQUNGLEtBWFUsRUFXUnlCLGlCQVhRLENBQVg7QUFZRDtBQUNGOztBQUVELGVBQWVNLG1CQUFmLENBQW9DL0IsVUFBcEMsRUFBZ0Q7QUFFOUMsTUFBSWUsRUFBRSxHQUFHZixVQUFVLENBQUNNLGFBQVgsQ0FBeUJTLEVBQWxDOztBQUNBLE1BQUk7QUFDRixRQUFJZCxRQUFRLEdBQUcsTUFBTSw2QkFBUTtBQUMzQitCLE1BQUFBLEdBQUcsRUFBRyxHQUFFcEQsTUFBTSxDQUFDb0IsVUFBVSxDQUFDTSxhQUFaLENBQTJCLHNCQUFxQlMsRUFBRyxFQUR0QztBQUUzQkssTUFBQUEsTUFBTSxFQUFFLEtBRm1CO0FBRzNCYSxNQUFBQSxPQUFPLEVBQUUsS0FIa0I7QUFJM0JWLE1BQUFBLHVCQUF1QixFQUFFO0FBSkUsS0FBUixDQUFyQjs7QUFNQSxRQUFJdEIsUUFBUSxLQUFLQyxTQUFiLElBQTBCRCxRQUFRLENBQUNFLFVBQVQsS0FBd0IsR0FBdEQsRUFBMkQ7QUFDekQsWUFBTSxJQUFJQyxLQUFKLENBQVcsZ0JBQVgsQ0FBTjtBQUNEOztBQUNELFFBQUk4QixZQUFZLEdBQUcxQixJQUFJLENBQUNDLEtBQUwsQ0FBV1IsUUFBUSxDQUFDb0IsSUFBcEIsQ0FBbkI7O0FBQ0EsUUFBSWEsWUFBWSxDQUFDQyxPQUFiLEtBQXlCLElBQTdCLEVBQW1DO0FBRWpDekMsc0JBQU9hLEtBQVAsQ0FBYyw0QkFBMkIyQixZQUFZLENBQUNFLEdBQUksRUFBMUQ7QUFDRDs7QUFDRCxXQUFPRixZQUFZLENBQUNDLE9BQXBCO0FBQ0QsR0FoQkQsQ0FnQkUsT0FBTzFDLEdBQVAsRUFBWTtBQUNaQyxvQkFBT2EsS0FBUCxDQUFjLCtCQUE4QmQsR0FBRyxDQUFDRyxPQUFRLEVBQXhEO0FBQ0Q7QUFDRjs7ZUFHY1YsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5jb25zdCBodWJVcmkgPSAoY29uZmlnKSA9PiB7XG4gIGNvbnN0IHByb3RvY29sID0gY29uZmlnLmh1YlByb3RvY29sIHx8ICdodHRwJztcbiAgcmV0dXJuIGAke3Byb3RvY29sfTovLyR7Y29uZmlnLmh1Ykhvc3R9OiR7Y29uZmlnLmh1YlBvcnR9YDtcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVyTm9kZSAoY29uZmlnRmlsZSwgYWRkciwgcG9ydCkge1xuICBsZXQgZGF0YTtcbiAgdHJ5IHtcbiAgICBkYXRhID0gYXdhaXQgZnMucmVhZEZpbGUoY29uZmlnRmlsZSwgJ3V0Zi04Jyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci5lcnJvcihgVW5hYmxlIHRvIGxvYWQgbm9kZSBjb25maWd1cmF0aW9uIGZpbGUgdG8gcmVnaXN0ZXIgd2l0aCBncmlkOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIC8vIENoZWNrIHByZXNlbmNlIG9mIGRhdGEgYmVmb3JlIHBvc3RpbmcgIGl0IHRvIHRoZSBzZWxlbml1bSBncmlkXG4gIGlmICghZGF0YSkge1xuICAgIGxvZ2dlci5lcnJvcignTm8gZGF0YSBmb3VuZCBpbiB0aGUgbm9kZSBjb25maWd1cmF0aW9uIGZpbGUgdG8gc2VuZCB0byB0aGUgZ3JpZCcpO1xuICAgIHJldHVybjtcbiAgfVxuICBwb3N0UmVxdWVzdChkYXRhLCBhZGRyLCBwb3J0KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVnaXN0ZXJUb0dyaWQgKG9wdGlvbnNfcG9zdCwganNvbk9iamVjdCkge1xuICB0cnkge1xuICAgIGxldCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3Qob3B0aW9uc19wb3N0KTtcbiAgICBpZiAocmVzcG9uc2UgPT09IHVuZGVmaW5lZCB8fCByZXNwb25zZS5zdGF0dXNDb2RlICE9PSAyMDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignUmVxdWVzdCBmYWlsZWQnKTtcbiAgICB9XG4gICAgbGV0IGxvZ01lc3NhZ2UgPSBgQXBwaXVtIHN1Y2Nlc3NmdWxseSByZWdpc3RlcmVkIHdpdGggdGhlIGdyaWQgb24gJHtodWJVcmkoanNvbk9iamVjdC5jb25maWd1cmF0aW9uKX1gO1xuICAgIGxvZ2dlci5kZWJ1Zyhsb2dNZXNzYWdlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yKGBSZXF1ZXN0IHRvIHJlZ2lzdGVyIHdpdGggZ3JpZCB3YXMgdW5zdWNjZXNzZnVsOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHBvc3RSZXF1ZXN0IChkYXRhLCBhZGRyLCBwb3J0KSB7XG4gIC8vIHBhcnNlIGpzb24gdG8gZ2V0IGh1YiBob3N0IGFuZCBwb3J0XG4gIGxldCBqc29uT2JqZWN0O1xuICB0cnkge1xuICAgIGpzb25PYmplY3QgPSBKU09OLnBhcnNlKGRhdGEpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgU3ludGF4IGVycm9yIGluIG5vZGUgY29uZmlndXJhdGlvbiBmaWxlOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG5cbiAgLy8gTW92ZSBTZWxlbml1bSAzIGNvbmZpZ3VyYXRpb24gcHJvcGVydGllcyB0byBjb25maWd1cmF0aW9uIG9iamVjdFxuICBpZiAoIWpzb25PYmplY3QuaGFzT3duUHJvcGVydHkoJ2NvbmZpZ3VyYXRpb24nKSkge1xuICAgIGxldCBjb25maWd1cmF0aW9uID0ge307XG4gICAgZm9yIChsZXQgcHJvcGVydHkgaW4ganNvbk9iamVjdCkge1xuICAgICAgaWYgKGpzb25PYmplY3QuaGFzT3duUHJvcGVydHkocHJvcGVydHkpICYmIHByb3BlcnR5ICE9PSAnY2FwYWJpbGl0aWVzJykge1xuICAgICAgICBjb25maWd1cmF0aW9uW3Byb3BlcnR5XSA9IGpzb25PYmplY3RbcHJvcGVydHldO1xuICAgICAgICBkZWxldGUganNvbk9iamVjdFtwcm9wZXJ0eV07XG4gICAgICB9XG4gICAgfVxuICAgIGpzb25PYmplY3QuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247XG4gIH1cblxuICAvLyBpZiB0aGUgbm9kZSBjb25maWcgZG9lcyBub3QgaGF2ZSB0aGUgYXBwaXVtL3dlYmRyaXZlciB1cmwsIGhvc3QsIGFuZCBwb3J0LFxuICAvLyBhdXRvbWF0aWNhbGx5IGFkZCBpdCBiYXNlZCBvbiBob3cgYXBwaXVtIHdhcyBpbml0aWFsaXplZFxuICAvLyBvdGhlcndpc2UsIHdlIHdpbGwgdGFrZSB3aGF0ZXZlciB0aGUgdXNlciBzZXR1cFxuICAvLyBiZWNhdXNlIHdlIHdpbGwgYWx3YXlzIHNldCBsb2NhbGhvc3QvMTI3LjAuMC4xLiB0aGlzIHdvbid0IHdvcmsgaWYgeW91clxuICAvLyBub2RlIGFuZCBncmlkIGFyZW4ndCBpbiB0aGUgc2FtZSBwbGFjZVxuICBpZiAoIWpzb25PYmplY3QuY29uZmlndXJhdGlvbi51cmwgfHwgIWpzb25PYmplY3QuY29uZmlndXJhdGlvbi5ob3N0IHx8ICFqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24ucG9ydCkge1xuICAgIGpzb25PYmplY3QuY29uZmlndXJhdGlvbi51cmwgPSBgaHR0cDovLyR7YWRkcn06JHtwb3J0fS93ZC9odWJgO1xuICAgIGpzb25PYmplY3QuY29uZmlndXJhdGlvbi5ob3N0ID0gYWRkcjtcbiAgICBqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24ucG9ydCA9IHBvcnQ7XG4gIH1cbiAgLy8gaWYgdGhlIG5vZGUgY29uZmlnIGRvZXMgbm90IGhhdmUgaWQgYXV0b21hdGljYWxseSBhZGQgaXRcbiAgaWYgKCFqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24uaWQpIHtcbiAgICBqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24uaWQgPSBgaHR0cDovLyR7anNvbk9iamVjdC5jb25maWd1cmF0aW9uLmhvc3R9OiR7anNvbk9iamVjdC5jb25maWd1cmF0aW9uLnBvcnR9YDtcbiAgfVxuXG4gIC8vIHJlLXNlcmlhbGl6ZSB0aGUgY29uZmlndXJhdGlvbiB3aXRoIHRoZSBhdXRvIHBvcHVsYXRlZCBkYXRhXG4gIGRhdGEgPSBKU09OLnN0cmluZ2lmeShqc29uT2JqZWN0KTtcblxuICAvLyBwcmVwYXJlIHRoZSBoZWFkZXJcbiAgbGV0IHBvc3RfaGVhZGVycyA9IHtcbiAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICdDb250ZW50LUxlbmd0aCc6IGRhdGEubGVuZ3RoXG4gIH07XG4gIC8vIHRoZSBwb3N0IG9wdGlvbnNcbiAgbGV0IHBvc3Rfb3B0aW9ucyA9IHtcbiAgICB1cmw6IGAke2h1YlVyaShqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24pfS9ncmlkL3JlZ2lzdGVyYCxcbiAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICBib2R5OiBkYXRhLFxuICAgIGhlYWRlcnM6IHBvc3RfaGVhZGVycyxcbiAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSAvLyByZXR1cm4gdGhlIGZ1bGwgcmVzcG9uc2UsIG5vdCBqdXN0IHRoZSBib2R5XG4gIH07XG5cbiAgaWYgKGpzb25PYmplY3QuY29uZmlndXJhdGlvbi5yZWdpc3RlciAhPT0gdHJ1ZSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgTm8gcmVnaXN0cmF0aW9uIHNlbnQgKCR7anNvbk9iamVjdC5jb25maWd1cmF0aW9uLnJlZ2lzdGVyfSA9IGZhbHNlKWApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxldCByZWdpc3RlckN5Y2xlVGltZSA9IGpzb25PYmplY3QuY29uZmlndXJhdGlvbi5yZWdpc3RlckN5Y2xlO1xuICBpZiAocmVnaXN0ZXJDeWNsZVRpbWUgIT09IG51bGwgJiYgcmVnaXN0ZXJDeWNsZVRpbWUgPiAwKSB7XG4gICAgLy8gaW5pdGlhdGUgYSBuZXcgVGhyZWFkXG4gICAgbGV0IGZpcnN0ID0gdHJ1ZTtcbiAgICBsb2dnZXIuZGVidWcoYFN0YXJ0aW5nIGF1dG8gcmVnaXN0ZXIgdGhyZWFkIGZvciBncmlkLiBXaWxsIHRyeSB0byByZWdpc3RlciBldmVyeSAke3JlZ2lzdGVyQ3ljbGVUaW1lfSBtcy5gKTtcbiAgICBzZXRJbnRlcnZhbChhc3luYyBmdW5jdGlvbiByZWdpc3RlclJldHJ5ICgpIHtcbiAgICAgIGlmIChmaXJzdCAhPT0gdHJ1ZSkge1xuICAgICAgICBsZXQgaXNSZWdpc3RlcmVkID0gYXdhaXQgaXNBbHJlYWR5UmVnaXN0ZXJlZChqc29uT2JqZWN0KTtcbiAgICAgICAgaWYgKGlzUmVnaXN0ZXJlZCAhPT0gbnVsbCAmJiBpc1JlZ2lzdGVyZWQgIT09IHRydWUpIHtcbiAgICAgICAgICAvLyBtYWtlIHRoZSBodHRwIFBPU1QgdG8gdGhlIGdyaWQgZm9yIHJlZ2lzdHJhdGlvblxuICAgICAgICAgIGF3YWl0IHJlZ2lzdGVyVG9HcmlkKHBvc3Rfb3B0aW9ucywganNvbk9iamVjdCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpcnN0ID0gZmFsc2U7XG4gICAgICAgIGF3YWl0IHJlZ2lzdGVyVG9HcmlkKHBvc3Rfb3B0aW9ucywganNvbk9iamVjdCk7XG4gICAgICB9XG4gICAgfSwgcmVnaXN0ZXJDeWNsZVRpbWUpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGlzQWxyZWFkeVJlZ2lzdGVyZWQgKGpzb25PYmplY3QpIHtcbiAgLy9jaGVjayBpZiBub2RlIGlzIGFscmVhZHkgcmVnaXN0ZXJlZFxuICBsZXQgaWQgPSBqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24uaWQ7XG4gIHRyeSB7XG4gICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCh7XG4gICAgICB1cmk6IGAke2h1YlVyaShqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24pfS9ncmlkL2FwaS9wcm94eT9pZD0ke2lkfWAsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgdGltZW91dDogMTAwMDAsXG4gICAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSAvLyByZXR1cm4gdGhlIGZ1bGwgcmVzcG9uc2UsIG5vdCBqdXN0IHRoZSBib2R5XG4gICAgfSk7XG4gICAgaWYgKHJlc3BvbnNlID09PSB1bmRlZmluZWQgfHwgcmVzcG9uc2Uuc3RhdHVzQ29kZSAhPT0gMjAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlcXVlc3QgZmFpbGVkYCk7XG4gICAgfVxuICAgIGxldCByZXNwb25zZURhdGEgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmJvZHkpO1xuICAgIGlmIChyZXNwb25zZURhdGEuc3VjY2VzcyAhPT0gdHJ1ZSkge1xuICAgICAgLy8gaWYgcmVnaXN0ZXIgZmFpbCwgcHJpbnQgdGhlIGRlYnVnIG1zZ1xuICAgICAgbG9nZ2VyLmRlYnVnKGBHcmlkIHJlZ2lzdHJhdGlvbiBlcnJvcjogJHtyZXNwb25zZURhdGEubXNnfWApO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2VEYXRhLnN1Y2Nlc3M7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci5kZWJ1ZyhgSHViIGRvd24gb3Igbm90IHJlc3BvbmRpbmc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuXG5leHBvcnQgZGVmYXVsdCByZWdpc3Rlck5vZGU7XG4iXSwiZmlsZSI6ImxpYi9ncmlkLXJlZ2lzdGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
