"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.DEFAULT_A4M_PORT = exports.DEFAULT_A4M_HOST = exports.AppiumForMac = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("./logger"));

var _teen_process = require("teen_process");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

const DEFAULT_A4M_HOST = '127.0.0.1';
exports.DEFAULT_A4M_HOST = DEFAULT_A4M_HOST;
const DEFAULT_A4M_PORT = 4622;
exports.DEFAULT_A4M_PORT = DEFAULT_A4M_PORT;

const REQ_A4M_APP_PATH = _path.default.resolve('/Applications', 'AppiumForMac.app');

const a4mLog = _appiumSupport.logger.getLogger('Appium4Mac');

class AppiumForMac {
  constructor() {
    this.proxyHost = DEFAULT_A4M_HOST;
    this.proxyPort = DEFAULT_A4M_PORT;
    this.proc = null;
    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.proxyHost,
      port: this.proxyPort
    });
  }

  start() {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (!(yield _appiumSupport.fs.exists(REQ_A4M_APP_PATH))) {
        throw new Error("Could not verify AppiumForMacDriver install; please install to your /Applications folder");
      }

      const startDetector = (stdout, stderr) => {
        return stderr.indexOf("Started HTTP server") !== -1;
      };

      let processIsAlive = false;

      try {
        yield _this.killAll();

        const a4mBinary = _path.default.resolve(REQ_A4M_APP_PATH, "Contents", "MacOS", "AppiumForMac");

        _this.proc = new _teen_process.SubProcess(a4mBinary, []);
        processIsAlive = true;
        var _arr = ['STDOUT', 'STDERR'];

        for (var _i = 0; _i < _arr.length; _i++) {
          let stream = _arr[_i];

          _this.proc.on(`lines-${stream.toLowerCase()}`, lines => {
            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
              for (var _iterator = lines[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                let l = _step.value;
                a4mLog.info(`[${stream}] ${l.trim()}`);
              }
            } catch (err) {
              _didIteratorError = true;
              _iteratorError = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion && _iterator.return != null) {
                  _iterator.return();
                }
              } finally {
                if (_didIteratorError) {
                  throw _iteratorError;
                }
              }
            }
          });
        }

        _this.proc.on('exit', (code, signal) => {
          processIsAlive = false;
          let msg = `AppiumForMac exited unexpectedly with code ${code}, ` + `signal ${signal}`;

          _logger.default.error(msg);
        });

        _logger.default.info(`Spawning AppiumForMac with: ${_this.appium4macdriver}`);

        yield _this.proc.start(startDetector);
        yield _this.waitForOnline();
      } catch (e) {
        _this.emit(AppiumForMac.EVENT_ERROR, e);

        if (processIsAlive) {
          yield _this.proc.stop();
        }

        _logger.default.errorAndThrow(e);
      }
    })();
  }

  sessionId() {
    if (this.state !== AppiumForMac.STATE_ONLINE) {
      return null;
    }

    return this.jwproxy.sessionId;
  }

  waitForOnline() {
    return (0, _asyncToGenerator2.default)(function* () {
      return true;
    })();
  }

  getStatus() {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      return yield _this2.sendCommand('/status', 'GET');
    })();
  }

  startSession(caps) {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _this3.proxyReqRes = _this3.jwproxy.proxyReqRes.bind(_this3.jwproxy);
      yield _this3.sendCommand('/session', 'POST', {
        desiredCapabilities: caps
      });
    })();
  }

  stop() {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      try {
        if (_this4.proc) {
          yield _this4.proc.stop();
        }
      } catch (e) {
        _logger.default.error(e);
      }
    })();
  }

  sendCommand(url, method, body) {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let res;

      try {
        res = yield _this5.jwproxy.command(url, method, body);
      } catch (e) {
        if (e.message.indexOf("Did not get a valid response object") === -1 || e.message.indexOf("value") !== -1) {
          throw e;
        }
      }

      return res;
    })();
  }

  proxyReq(req, res) {
    var _this6 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      return yield _this6.jwproxy.proxyReqRes(req, res);
    })();
  }

  killAll() {
    return (0, _asyncToGenerator2.default)(function* () {
      const processName = "AppiumForMac";

      _logger.default.info(`Killing any old AppiumForMac`);

      yield _appiumSupport.process.killProcess(processName);

      _logger.default.info("Successfully cleaned up old Appium4Mac servers");
    })();
  }

  deleteSession() {
    var _this7 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.debug('Deleting AppiumForMac server session');

      try {
        yield _this7.sendCommand('/', 'DELETE');
      } catch (err) {
        _logger.default.warn(`Did not get confirmation AppiumForMac deleteSession worked; ` + `Error was: ${err}`);
      }
    })();
  }

}

exports.AppiumForMac = AppiumForMac;
var _default = AppiumForMac;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hcHBpdW0tZm9yLW1hYy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX0E0TV9IT1NUIiwiREVGQVVMVF9BNE1fUE9SVCIsIlJFUV9BNE1fQVBQX1BBVEgiLCJwYXRoIiwicmVzb2x2ZSIsImE0bUxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIkFwcGl1bUZvck1hYyIsImNvbnN0cnVjdG9yIiwicHJveHlIb3N0IiwicHJveHlQb3J0IiwicHJvYyIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwicG9ydCIsInN0YXJ0IiwiZnMiLCJleGlzdHMiLCJFcnJvciIsInN0YXJ0RGV0ZWN0b3IiLCJzdGRvdXQiLCJzdGRlcnIiLCJpbmRleE9mIiwicHJvY2Vzc0lzQWxpdmUiLCJraWxsQWxsIiwiYTRtQmluYXJ5IiwiU3ViUHJvY2VzcyIsInN0cmVhbSIsIm9uIiwidG9Mb3dlckNhc2UiLCJsaW5lcyIsImwiLCJpbmZvIiwidHJpbSIsImNvZGUiLCJzaWduYWwiLCJtc2ciLCJsb2ciLCJlcnJvciIsImFwcGl1bTRtYWNkcml2ZXIiLCJ3YWl0Rm9yT25saW5lIiwiZSIsImVtaXQiLCJFVkVOVF9FUlJPUiIsInN0b3AiLCJlcnJvckFuZFRocm93Iiwic2Vzc2lvbklkIiwic3RhdGUiLCJTVEFURV9PTkxJTkUiLCJnZXRTdGF0dXMiLCJzZW5kQ29tbWFuZCIsInN0YXJ0U2Vzc2lvbiIsImNhcHMiLCJwcm94eVJlcVJlcyIsImJpbmQiLCJkZXNpcmVkQ2FwYWJpbGl0aWVzIiwidXJsIiwibWV0aG9kIiwiYm9keSIsInJlcyIsImNvbW1hbmQiLCJtZXNzYWdlIiwicHJveHlSZXEiLCJyZXEiLCJwcm9jZXNzTmFtZSIsInByb2Nlc3MiLCJraWxsUHJvY2VzcyIsImRlbGV0ZVNlc3Npb24iLCJkZWJ1ZyIsImVyciIsIndhcm4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBQUcs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QUFVLDhEQUFELEdBQ04sY0FBYUQsR0FBSSxFQURwQjtBQUVEO0FBVG9CO0FBVXRCOztBQWxJZ0I7OztlQXNJSi9ELFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgU3ViUHJvY2VzcyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBmcywgbG9nZ2VyLCBwcm9jZXNzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbmNvbnN0IERFRkFVTFRfQTRNX0hPU1QgPSAnMTI3LjAuMC4xJztcbmNvbnN0IERFRkFVTFRfQTRNX1BPUlQgPSA0NjIyO1xuXG5jb25zdCBSRVFfQTRNX0FQUF9QQVRIID0gcGF0aC5yZXNvbHZlKCcvQXBwbGljYXRpb25zJywgJ0FwcGl1bUZvck1hYy5hcHAnKTtcblxuY29uc3QgYTRtTG9nID0gbG9nZ2VyLmdldExvZ2dlcignQXBwaXVtNE1hYycpO1xuXG5jbGFzcyBBcHBpdW1Gb3JNYWMge1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgdGhpcy5wcm94eUhvc3QgPSBERUZBVUxUX0E0TV9IT1NUO1xuICAgIHRoaXMucHJveHlQb3J0ID0gREVGQVVMVF9BNE1fUE9SVDtcbiAgICB0aGlzLnByb2MgPSBudWxsO1xuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtzZXJ2ZXI6IHRoaXMucHJveHlIb3N0LCBwb3J0OiB0aGlzLnByb3h5UG9ydH0pO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKFJFUV9BNE1fQVBQX1BBVEgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgdmVyaWZ5IEFwcGl1bUZvck1hY0RyaXZlciBpbnN0YWxsOyBwbGVhc2UgaW5zdGFsbCB0byB5b3VyIC9BcHBsaWNhdGlvbnMgZm9sZGVyXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXJ0RGV0ZWN0b3IgPSAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgIHJldHVybiBzdGRlcnIuaW5kZXhPZihcIlN0YXJ0ZWQgSFRUUCBzZXJ2ZXJcIikgIT09IC0xO1xuICAgIH07XG5cbiAgICBsZXQgcHJvY2Vzc0lzQWxpdmUgPSBmYWxzZTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5raWxsQWxsKCk7XG5cbiAgICAgIC8vIHNldCB1cCBvdXIgc3VicHJvY2VzcyBvYmplY3RcbiAgICAgIGNvbnN0IGE0bUJpbmFyeSA9IHBhdGgucmVzb2x2ZShSRVFfQTRNX0FQUF9QQVRILCBcIkNvbnRlbnRzXCIsIFwiTWFjT1NcIiwgXCJBcHBpdW1Gb3JNYWNcIik7XG4gICAgICB0aGlzLnByb2MgPSBuZXcgU3ViUHJvY2VzcyhhNG1CaW5hcnksIFtdKTtcbiAgICAgIHByb2Nlc3NJc0FsaXZlID0gdHJ1ZTtcblxuICAgICAgLy8gaGFuZGxlIGxvZyBvdXRwdXRcbiAgICAgIGZvciAobGV0IHN0cmVhbSBvZiBbJ1NURE9VVCcsICdTVERFUlInXSkge1xuICAgICAgICB0aGlzLnByb2Mub24oYGxpbmVzLSR7c3RyZWFtLnRvTG93ZXJDYXNlKCl9YCwgKGxpbmVzKSA9PiB7XG4gICAgICAgICAgZm9yIChsZXQgbCBvZiBsaW5lcykge1xuICAgICAgICAgICAgYTRtTG9nLmluZm8oYFske3N0cmVhbX1dICR7bC50cmltKCl9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gaGFuZGxlIG91dC1vZi1ib3VuZCBleGl0IGJ5IHNpbXBseSBsb2dnaW5nXG4gICAgICAvLyBUT0RPIGFkZCBhYmlsaXR5IGZvciBkcml2ZXIgdG8gaGFuZGxlIHRoaXMgZ3JhY2VmdWxseSBhbmQgbWF5YmVcbiAgICAgIC8vIHJlc3RhcnRcbiAgICAgIHRoaXMucHJvYy5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgICAgcHJvY2Vzc0lzQWxpdmUgPSBmYWxzZTtcbiAgICAgICAgbGV0IG1zZyA9IGBBcHBpdW1Gb3JNYWMgZXhpdGVkIHVuZXhwZWN0ZWRseSB3aXRoIGNvZGUgJHtjb2RlfSwgYCArXG4gICAgICAgICAgICAgICAgICBgc2lnbmFsICR7c2lnbmFsfWA7XG4gICAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgfSk7XG4gICAgICBsb2cuaW5mbyhgU3Bhd25pbmcgQXBwaXVtRm9yTWFjIHdpdGg6ICR7dGhpcy5hcHBpdW00bWFjZHJpdmVyfWApO1xuXG4gICAgICAvLyBzdGFydCBzdWJwcm9jIGFuZCB3YWl0IGZvciBzdGFydERldGVjdG9yXG4gICAgICBhd2FpdCB0aGlzLnByb2Muc3RhcnQoc3RhcnREZXRlY3Rvcik7XG5cbiAgICAgIGF3YWl0IHRoaXMud2FpdEZvck9ubGluZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuZW1pdChBcHBpdW1Gb3JNYWMuRVZFTlRfRVJST1IsIGUpO1xuICAgICAgLy8ganVzdCBiZWNhdXNlIHdlIGhhZCBhbiBlcnJvciBkb2Vzbid0IG1lYW4gdGhlIHdpbmFwcGRyaXZlciBwcm9jZXNzXG4gICAgICAvLyBmaW5pc2hlZDsgd2Ugc2hvdWxkIGNsZWFuIHVwIGlmIG5lY2Vzc2FyeVxuICAgICAgaWYgKHByb2Nlc3NJc0FsaXZlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCk7XG4gICAgICB9XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhlKTtcbiAgICB9XG4gIH1cblxuICBzZXNzaW9uSWQgKCkge1xuICAgIGlmICh0aGlzLnN0YXRlICE9PSBBcHBpdW1Gb3JNYWMuU1RBVEVfT05MSU5FKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5qd3Byb3h5LnNlc3Npb25JZDtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JPbmxpbmUgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICAvLyBUT0RPOiBBY3R1YWxseSBjaGVjayB2aWEgSFRUUFxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgZ2V0U3RhdHVzICgpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kQ29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuICAgIGF3YWl0IHRoaXMuc2VuZENvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aGlzLnByb2MpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0b3AoKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZXJyb3IoZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VuZENvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgbGV0IHJlcztcbiAgICAvLyBuZWVkIHRvIGNvdmVyIG92ZXIgQTRNJ3MgYmFkIGhhbmRsaW5nIG9mIHJlc3BvbnNlcywgd2hpY2ggc29tZXRpbWVzXG4gICAgLy8gZG9uJ3QgaGF2ZSAndmFsdWUnIHByb3BlcnRpZXNcbiAgICB0cnkge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlLm1lc3NhZ2UuaW5kZXhPZihcIkRpZCBub3QgZ2V0IGEgdmFsaWQgcmVzcG9uc2Ugb2JqZWN0XCIpID09PSAtMSB8fFxuICAgICAgICAgIGUubWVzc2FnZS5pbmRleE9mKFwidmFsdWVcIikgIT09IC0xKSB7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBhc3luYyBwcm94eVJlcSAocmVxLCByZXMpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzKHJlcSwgcmVzKTtcbiAgfVxuXG4gIGFzeW5jIGtpbGxBbGwgKCkge1xuICAgIGNvbnN0IHByb2Nlc3NOYW1lID0gXCJBcHBpdW1Gb3JNYWNcIjtcbiAgICAvLyBqcyBoaW50IGNhbm5vdCBoYW5kbGUgYmFja3RpY2tzLCBldmVuIGVzY2FwZWQsIHdpdGhpbiB0ZW1wbGF0ZSBsaXRlcmFsc1xuICAgIGxvZy5pbmZvKGBLaWxsaW5nIGFueSBvbGQgQXBwaXVtRm9yTWFjYCk7XG4gICAgYXdhaXQgcHJvY2Vzcy5raWxsUHJvY2Vzcyhwcm9jZXNzTmFtZSk7XG4gICAgbG9nLmluZm8oXCJTdWNjZXNzZnVsbHkgY2xlYW5lZCB1cCBvbGQgQXBwaXVtNE1hYyBzZXJ2ZXJzXCIpO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nLmRlYnVnKCdEZWxldGluZyBBcHBpdW1Gb3JNYWMgc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5zZW5kQ29tbWFuZCgnLycsICdERUxFVEUnKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBEaWQgbm90IGdldCBjb25maXJtYXRpb24gQXBwaXVtRm9yTWFjIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgYEVycm9yIHdhczogJHtlcnJ9YCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IEFwcGl1bUZvck1hYywgREVGQVVMVF9BNE1fSE9TVCwgREVGQVVMVF9BNE1fUE9SVH07XG5leHBvcnQgZGVmYXVsdCBBcHBpdW1Gb3JNYWM7XG4iXSwiZmlsZSI6ImxpYi9hcHBpdW0tZm9yLW1hYy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
