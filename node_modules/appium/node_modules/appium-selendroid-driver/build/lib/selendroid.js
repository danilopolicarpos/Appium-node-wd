"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _installer = require("./installer");

const REQD_PARAMS = ['adb', 'appPackage', 'appActivity', 'tmpDir', 'apk', 'host', 'systemPort', 'devicePort'];

class SelendroidServer {
  constructor(opts = {}) {
    for (let req of REQD_PARAMS) {
      if (!opts || !opts[req]) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.modServerPkg = `selendroid.${this.appPackage}`;
    this.modServerPath = _path.default.resolve(this.tmpDir, `${this.modServerPkg}.apk`);
    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
  }

  async prepareModifiedServer() {
    let needsUninstall = false;

    if (!(await _appiumSupport.fs.exists(this.modServerPath))) {
      await this.buildNewModServer();
      needsUninstall = true;
    }

    needsUninstall = (await this.checkAndSignCert(this.modServerPath)) || needsUninstall;

    if (needsUninstall) {
      _logger.default.info('New server was built, uninstalling any instances of it');

      await this.adb.uninstallApk(this.modServerPkg);
    }
  }

  async installModifiedServer() {
    let installed = await this.adb.isAppInstalled(this.modServerPkg);

    if (!installed) {
      await this.adb.install(this.modServerPath);
    }
  }

  async buildNewModServer() {
    _logger.default.info(`Repackaging selendroid for: '${this.appPackage}'`);

    let packageTmpDir = _path.default.resolve(this.tmpDir, this.appPackage);

    let newManifestPath = _path.default.resolve(this.tmpDir, 'AndroidManifest.xml');

    _logger.default.info(`Creating new manifest: '${newManifestPath}'`);

    await _appiumSupport.fs.mkdir(packageTmpDir);
    await _appiumSupport.fs.copyFile(_installer.SE_MANIFEST_PATH, newManifestPath);
    await this.adb.initAapt();
    await this.adb.compileManifest(newManifestPath, this.modServerPkg, this.appPackage);
    await this.adb.insertManifest(newManifestPath, _installer.SE_APK_PATH, this.modServerPath);

    _logger.default.info(`Repackaged selendroid ready: '${this.modServerPath}'`);
  }

  async checkAndSignCert(apk) {
    let signed = await this.adb.checkApkCert(apk, this.appPackage);

    if (!signed) {
      await this.adb.sign(apk);
    }

    return !signed;
  }

  async startSession(caps) {
    let instrumentWith = `${this.modServerPkg}/` + `io.selendroid.server.ServerInstrumentation`;

    _logger.default.info(`Starting selendroid server with instrumentation: ` + `${instrumentWith}`);

    await this.adb.instrument(this.appPackage, this.appActivity, instrumentWith);

    _logger.default.info('Waiting for Selendroid to be online...');

    await (0, _asyncbox.retryInterval)(20, 1000, async () => {
      await this.jwproxy.command('/status', 'GET');
    });
    await this.jwproxy.command('/session', 'POST', {
      desiredCapabilities: caps
    });
  }

  async deleteSession() {
    _logger.default.debug('Deleting Selendroid server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation Selendroid deleteSession worked; ` + `Error was: ${err}`);
    }
  }

}

var _default = SelendroidServer;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZWxlbmRyb2lkLmpzIl0sIm5hbWVzIjpbIlJFUURfUEFSQU1TIiwiU2VsZW5kcm9pZFNlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0cyIsInJlcSIsIkVycm9yIiwibW9kU2VydmVyUGtnIiwiYXBwUGFja2FnZSIsIm1vZFNlcnZlclBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsInRtcERpciIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwicHJveHlSZXFSZXMiLCJiaW5kIiwicHJlcGFyZU1vZGlmaWVkU2VydmVyIiwibmVlZHNVbmluc3RhbGwiLCJmcyIsImV4aXN0cyIsImJ1aWxkTmV3TW9kU2VydmVyIiwiY2hlY2tBbmRTaWduQ2VydCIsImxvZ2dlciIsImluZm8iLCJhZGIiLCJ1bmluc3RhbGxBcGsiLCJpbnN0YWxsTW9kaWZpZWRTZXJ2ZXIiLCJpbnN0YWxsZWQiLCJpc0FwcEluc3RhbGxlZCIsImluc3RhbGwiLCJwYWNrYWdlVG1wRGlyIiwibmV3TWFuaWZlc3RQYXRoIiwibWtkaXIiLCJjb3B5RmlsZSIsIlNFX01BTklGRVNUX1BBVEgiLCJpbml0QWFwdCIsImNvbXBpbGVNYW5pZmVzdCIsImluc2VydE1hbmlmZXN0IiwiU0VfQVBLX1BBVEgiLCJhcGsiLCJzaWduZWQiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwic3RhcnRTZXNzaW9uIiwiY2FwcyIsImluc3RydW1lbnRXaXRoIiwiaW5zdHJ1bWVudCIsImFwcEFjdGl2aXR5IiwiY29tbWFuZCIsImRlc2lyZWRDYXBhYmlsaXRpZXMiLCJkZWxldGVTZXNzaW9uIiwiZGVidWciLCJlcnIiLCJ3YXJuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLFdBQVcsR0FBRyxDQUNsQixLQURrQixFQUNYLFlBRFcsRUFDRyxhQURILEVBQ2tCLFFBRGxCLEVBQzRCLEtBRDVCLEVBQ21DLE1BRG5DLEVBQzJDLFlBRDNDLEVBRWxCLFlBRmtCLENBQXBCOztBQUtBLE1BQU1DLGdCQUFOLENBQXVCO0FBQ3JCQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEIsU0FBSyxJQUFJQyxHQUFULElBQWdCSixXQUFoQixFQUE2QjtBQUMzQixVQUFJLENBQUNHLElBQUQsSUFBUyxDQUFDQSxJQUFJLENBQUNDLEdBQUQsQ0FBbEIsRUFBeUI7QUFDdkIsY0FBTSxJQUFJQyxLQUFKLENBQVcsV0FBVUQsR0FBSSxnQkFBekIsQ0FBTjtBQUNEOztBQUNELFdBQUtBLEdBQUwsSUFBWUQsSUFBSSxDQUFDQyxHQUFELENBQWhCO0FBQ0Q7O0FBR0QsU0FBS0UsWUFBTCxHQUFxQixjQUFhLEtBQUtDLFVBQVcsRUFBbEQ7QUFFQSxTQUFLQyxhQUFMLEdBQXFCQyxjQUFLQyxPQUFMLENBQWEsS0FBS0MsTUFBbEIsRUFBMkIsR0FBRSxLQUFLTCxZQUFhLE1BQS9DLENBQXJCO0FBQ0EsU0FBS00sT0FBTCxHQUFlLElBQUlDLHlCQUFKLENBQVk7QUFBQ0MsTUFBQUEsTUFBTSxFQUFFLEtBQUtDLElBQWQ7QUFBb0JDLE1BQUFBLElBQUksRUFBRSxLQUFLQztBQUEvQixLQUFaLENBQWY7QUFDQSxTQUFLQyxXQUFMLEdBQW1CLEtBQUtOLE9BQUwsQ0FBYU0sV0FBYixDQUF5QkMsSUFBekIsQ0FBOEIsS0FBS1AsT0FBbkMsQ0FBbkI7QUFDRDs7QUFFRCxRQUFNUSxxQkFBTixHQUErQjtBQUk3QixRQUFJQyxjQUFjLEdBQUcsS0FBckI7O0FBQ0EsUUFBSSxFQUFFLE1BQU1DLGtCQUFHQyxNQUFILENBQVUsS0FBS2YsYUFBZixDQUFSLENBQUosRUFBNEM7QUFDMUMsWUFBTSxLQUFLZ0IsaUJBQUwsRUFBTjtBQUNBSCxNQUFBQSxjQUFjLEdBQUcsSUFBakI7QUFDRDs7QUFDREEsSUFBQUEsY0FBYyxHQUFHLE9BQU0sS0FBS0ksZ0JBQUwsQ0FBc0IsS0FBS2pCLGFBQTNCLENBQU4sS0FBbURhLGNBQXBFOztBQUNBLFFBQUlBLGNBQUosRUFBb0I7QUFDbEJLLHNCQUFPQyxJQUFQLENBQVksd0RBQVo7O0FBQ0EsWUFBTSxLQUFLQyxHQUFMLENBQVNDLFlBQVQsQ0FBc0IsS0FBS3ZCLFlBQTNCLENBQU47QUFDRDtBQUNGOztBQUVELFFBQU13QixxQkFBTixHQUErQjtBQUM3QixRQUFJQyxTQUFTLEdBQUcsTUFBTSxLQUFLSCxHQUFMLENBQVNJLGNBQVQsQ0FBd0IsS0FBSzFCLFlBQTdCLENBQXRCOztBQUNBLFFBQUksQ0FBQ3lCLFNBQUwsRUFBZ0I7QUFDZCxZQUFNLEtBQUtILEdBQUwsQ0FBU0ssT0FBVCxDQUFpQixLQUFLekIsYUFBdEIsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsUUFBTWdCLGlCQUFOLEdBQTJCO0FBQ3pCRSxvQkFBT0MsSUFBUCxDQUFhLGdDQUErQixLQUFLcEIsVUFBVyxHQUE1RDs7QUFDQSxRQUFJMkIsYUFBYSxHQUFHekIsY0FBS0MsT0FBTCxDQUFhLEtBQUtDLE1BQWxCLEVBQTBCLEtBQUtKLFVBQS9CLENBQXBCOztBQUNBLFFBQUk0QixlQUFlLEdBQUcxQixjQUFLQyxPQUFMLENBQWEsS0FBS0MsTUFBbEIsRUFBMEIscUJBQTFCLENBQXRCOztBQUNBZSxvQkFBT0MsSUFBUCxDQUFhLDJCQUEwQlEsZUFBZ0IsR0FBdkQ7O0FBQ0EsVUFBTWIsa0JBQUdjLEtBQUgsQ0FBU0YsYUFBVCxDQUFOO0FBQ0EsVUFBTVosa0JBQUdlLFFBQUgsQ0FBWUMsMkJBQVosRUFBOEJILGVBQTlCLENBQU47QUFDQSxVQUFNLEtBQUtQLEdBQUwsQ0FBU1csUUFBVCxFQUFOO0FBQ0EsVUFBTSxLQUFLWCxHQUFMLENBQVNZLGVBQVQsQ0FBeUJMLGVBQXpCLEVBQTBDLEtBQUs3QixZQUEvQyxFQUN5QixLQUFLQyxVQUQ5QixDQUFOO0FBRUEsVUFBTSxLQUFLcUIsR0FBTCxDQUFTYSxjQUFULENBQXdCTixlQUF4QixFQUF5Q08sc0JBQXpDLEVBQ3dCLEtBQUtsQyxhQUQ3QixDQUFOOztBQUVBa0Isb0JBQU9DLElBQVAsQ0FBYSxpQ0FBZ0MsS0FBS25CLGFBQWMsR0FBaEU7QUFDRDs7QUFFRCxRQUFNaUIsZ0JBQU4sQ0FBd0JrQixHQUF4QixFQUE2QjtBQUMzQixRQUFJQyxNQUFNLEdBQUcsTUFBTSxLQUFLaEIsR0FBTCxDQUFTaUIsWUFBVCxDQUFzQkYsR0FBdEIsRUFBMkIsS0FBS3BDLFVBQWhDLENBQW5COztBQUNBLFFBQUksQ0FBQ3FDLE1BQUwsRUFBYTtBQUNYLFlBQU0sS0FBS2hCLEdBQUwsQ0FBU2tCLElBQVQsQ0FBY0gsR0FBZCxDQUFOO0FBQ0Q7O0FBR0QsV0FBTyxDQUFDQyxNQUFSO0FBQ0Q7O0FBRUQsUUFBTUcsWUFBTixDQUFvQkMsSUFBcEIsRUFBMEI7QUFDeEIsUUFBSUMsY0FBYyxHQUFJLEdBQUUsS0FBSzNDLFlBQWEsR0FBckIsR0FDQyw0Q0FEdEI7O0FBRUFvQixvQkFBT0MsSUFBUCxDQUFhLG1EQUFELEdBQ0YsR0FBRXNCLGNBQWUsRUFEM0I7O0FBRUEsVUFBTSxLQUFLckIsR0FBTCxDQUFTc0IsVUFBVCxDQUFvQixLQUFLM0MsVUFBekIsRUFBcUMsS0FBSzRDLFdBQTFDLEVBQXVERixjQUF2RCxDQUFOOztBQUVBdkIsb0JBQU9DLElBQVAsQ0FBWSx3Q0FBWjs7QUFFQSxVQUFNLDZCQUFjLEVBQWQsRUFBa0IsSUFBbEIsRUFBd0IsWUFBWTtBQUN4QyxZQUFNLEtBQUtmLE9BQUwsQ0FBYXdDLE9BQWIsQ0FBcUIsU0FBckIsRUFBZ0MsS0FBaEMsQ0FBTjtBQUNELEtBRkssQ0FBTjtBQUdBLFVBQU0sS0FBS3hDLE9BQUwsQ0FBYXdDLE9BQWIsQ0FBcUIsVUFBckIsRUFBaUMsTUFBakMsRUFBeUM7QUFBQ0MsTUFBQUEsbUJBQW1CLEVBQUVMO0FBQXRCLEtBQXpDLENBQU47QUFDRDs7QUFFRCxRQUFNTSxhQUFOLEdBQXVCO0FBQ3JCNUIsb0JBQU82QixLQUFQLENBQWEsb0NBQWI7O0FBR0EsUUFBSTtBQUNGLFlBQU0sS0FBSzNDLE9BQUwsQ0FBYXdDLE9BQWIsQ0FBcUIsR0FBckIsRUFBMEIsUUFBMUIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPSSxHQUFQLEVBQVk7QUFDWjlCLHNCQUFPK0IsSUFBUCxDQUFhLDREQUFELEdBQ0MsY0FBYUQsR0FBSSxFQUQ5QjtBQUVEO0FBQ0Y7O0FBMUZvQjs7ZUE2RlJ2RCxnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFNFX0FQS19QQVRILCBTRV9NQU5JRkVTVF9QQVRIIH0gZnJvbSAnLi9pbnN0YWxsZXInO1xuXG5cbmNvbnN0IFJFUURfUEFSQU1TID0gW1xuICAnYWRiJywgJ2FwcFBhY2thZ2UnLCAnYXBwQWN0aXZpdHknLCAndG1wRGlyJywgJ2FwaycsICdob3N0JywgJ3N5c3RlbVBvcnQnLFxuICAnZGV2aWNlUG9ydCcsXG5dO1xuXG5jbGFzcyBTZWxlbmRyb2lkU2VydmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGZvciAobGV0IHJlcSBvZiBSRVFEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICFvcHRzW3JlcV0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuXG4gICAgLy8gbmV3IHBhY2thZ2UgbmFtZSBmb3IgcmVwYWNrYWdlZCBzZWxlbmRyb2lkIHNlcnZlclxuICAgIHRoaXMubW9kU2VydmVyUGtnID0gYHNlbGVuZHJvaWQuJHt0aGlzLmFwcFBhY2thZ2V9YDtcbiAgICAvLyBwYXRoIHRvIHRoZSByZXBhY2thZ2VkIHNlbGVuZHJvaWQgc2VydmVyIHNwZWNpZmljIHRvIHRoaXMgYXBwXG4gICAgdGhpcy5tb2RTZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBgJHt0aGlzLm1vZFNlcnZlclBrZ30uYXBrYCk7XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe3NlcnZlcjogdGhpcy5ob3N0LCBwb3J0OiB0aGlzLnN5c3RlbVBvcnR9KTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcbiAgfVxuXG4gIGFzeW5jIHByZXBhcmVNb2RpZmllZFNlcnZlciAoKSB7XG4gICAgLy8gVE9ETyBtaWdodCBoYXZlIGEgcmFjZSBjb25kaXRpb24gaWYgd2UgdHJ5IGJ1aWxkaW5nIHRoaXMgd2l0aCBtdWx0aXBsZVxuICAgIC8vIHNlc3Npb25zIGF0IHRoZSBzYW1lIHRpbWUuIE9UT0ggd2UgcHJvYmFibHkgd2FudCB0byBzaGFyZSB0aGUgbW9kXG4gICAgLy8gc2VydmVyLi4uXG4gICAgbGV0IG5lZWRzVW5pbnN0YWxsID0gZmFsc2U7XG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpKSB7XG4gICAgICBhd2FpdCB0aGlzLmJ1aWxkTmV3TW9kU2VydmVyKCk7XG4gICAgICBuZWVkc1VuaW5zdGFsbCA9IHRydWU7XG4gICAgfVxuICAgIG5lZWRzVW5pbnN0YWxsID0gYXdhaXQgdGhpcy5jaGVja0FuZFNpZ25DZXJ0KHRoaXMubW9kU2VydmVyUGF0aCkgfHwgbmVlZHNVbmluc3RhbGw7XG4gICAgaWYgKG5lZWRzVW5pbnN0YWxsKSB7XG4gICAgICBsb2dnZXIuaW5mbygnTmV3IHNlcnZlciB3YXMgYnVpbHQsIHVuaW5zdGFsbGluZyBhbnkgaW5zdGFuY2VzIG9mIGl0Jyk7XG4gICAgICBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsodGhpcy5tb2RTZXJ2ZXJQa2cpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxNb2RpZmllZFNlcnZlciAoKSB7XG4gICAgbGV0IGluc3RhbGxlZCA9IGF3YWl0IHRoaXMuYWRiLmlzQXBwSW5zdGFsbGVkKHRoaXMubW9kU2VydmVyUGtnKTtcbiAgICBpZiAoIWluc3RhbGxlZCkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIuaW5zdGFsbCh0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGJ1aWxkTmV3TW9kU2VydmVyICgpIHtcbiAgICBsb2dnZXIuaW5mbyhgUmVwYWNrYWdpbmcgc2VsZW5kcm9pZCBmb3I6ICcke3RoaXMuYXBwUGFja2FnZX0nYCk7XG4gICAgbGV0IHBhY2thZ2VUbXBEaXIgPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsIHRoaXMuYXBwUGFja2FnZSk7XG4gICAgbGV0IG5ld01hbmlmZXN0UGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgJ0FuZHJvaWRNYW5pZmVzdC54bWwnKTtcbiAgICBsb2dnZXIuaW5mbyhgQ3JlYXRpbmcgbmV3IG1hbmlmZXN0OiAnJHtuZXdNYW5pZmVzdFBhdGh9J2ApO1xuICAgIGF3YWl0IGZzLm1rZGlyKHBhY2thZ2VUbXBEaXIpO1xuICAgIGF3YWl0IGZzLmNvcHlGaWxlKFNFX01BTklGRVNUX1BBVEgsIG5ld01hbmlmZXN0UGF0aCk7XG4gICAgYXdhaXQgdGhpcy5hZGIuaW5pdEFhcHQoKTsgLy8gVE9ETyB0aGlzIHNob3VsZCBiZSBpbnRlcm5hbCB0byBhZGJcbiAgICBhd2FpdCB0aGlzLmFkYi5jb21waWxlTWFuaWZlc3QobmV3TWFuaWZlc3RQYXRoLCB0aGlzLm1vZFNlcnZlclBrZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBQYWNrYWdlKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbnNlcnRNYW5pZmVzdChuZXdNYW5pZmVzdFBhdGgsIFNFX0FQS19QQVRILFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgbG9nZ2VyLmluZm8oYFJlcGFja2FnZWQgc2VsZW5kcm9pZCByZWFkeTogJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgfVxuXG4gIGFzeW5jIGNoZWNrQW5kU2lnbkNlcnQgKGFwaykge1xuICAgIGxldCBzaWduZWQgPSBhd2FpdCB0aGlzLmFkYi5jaGVja0Fwa0NlcnQoYXBrLCB0aGlzLmFwcFBhY2thZ2UpO1xuICAgIGlmICghc2lnbmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5zaWduKGFwayk7XG4gICAgfVxuXG4gICAgLy8gcmV0dXJuIHdoZXRoZXIgdGhlIGFwayB3YXMgc2lnbmVkXG4gICAgcmV0dXJuICFzaWduZWQ7XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICBsZXQgaW5zdHJ1bWVudFdpdGggPSBgJHt0aGlzLm1vZFNlcnZlclBrZ30vYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgYGlvLnNlbGVuZHJvaWQuc2VydmVyLlNlcnZlckluc3RydW1lbnRhdGlvbmA7XG4gICAgbG9nZ2VyLmluZm8oYFN0YXJ0aW5nIHNlbGVuZHJvaWQgc2VydmVyIHdpdGggaW5zdHJ1bWVudGF0aW9uOiBgICtcbiAgICAgICAgICAgICBgJHtpbnN0cnVtZW50V2l0aH1gKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbnN0cnVtZW50KHRoaXMuYXBwUGFja2FnZSwgdGhpcy5hcHBBY3Rpdml0eSwgaW5zdHJ1bWVudFdpdGgpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ1dhaXRpbmcgZm9yIFNlbGVuZHJvaWQgdG8gYmUgb25saW5lLi4uJyk7XG4gICAgLy8gd2FpdCAyMHMgZm9yIFNlbGVuZHJvaWQgdG8gYmUgb25saW5lXG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMCwgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdEZWxldGluZyBTZWxlbmRyb2lkIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvJywgJ0RFTEVURScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLndhcm4oYERpZCBub3QgZ2V0IGNvbmZpcm1hdGlvbiBTZWxlbmRyb2lkIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgICAgICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBTZWxlbmRyb2lkU2VydmVyO1xuIl0sImZpbGUiOiJsaWIvc2VsZW5kcm9pZC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
