"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setupSelendroid = setupSelendroid;
exports.serverExists = serverExists;
exports.SE_MANIFEST_PATH = exports.SE_APK_PATH = void 0;

require("source-map-support/register");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _fancyLog = _interopRequireDefault(require("fancy-log"));

var _crypto = _interopRequireDefault(require("crypto"));

const SE_VER = '0.17.0';
const SE_DOWNLOAD_CDNURL = process.env.npm_config_selendroid_driver_cdnurl || process.env.SELENDROID_DRIVER_CDNURL || 'https://repo1.maven.org/maven2/io/selendroid/selendroid-standalone';
const SE_DOWNLOAD = `${SE_DOWNLOAD_CDNURL}/${SE_VER}/selendroid-standalone-${SE_VER}-with-dependencies.jar`;
const SE_DOWNLOAD_SHA256 = '7cf7163ac47f1c46eff95b62f78b58c1dabdec534acc6632da3784739f6e9d82';

const SE_DIR = _path.default.resolve(__dirname, '..', '..', 'selendroid');

const SE_DOWNLOAD_DIR = _path.default.resolve(SE_DIR, 'download');

const SE_JAR_PATH_TMP = _path.default.resolve(SE_DOWNLOAD_DIR, 'selendroid-server.jar.tmp');

const SE_JAR_PATH = _path.default.resolve(SE_DOWNLOAD_DIR, `selendroid-server-${SE_DOWNLOAD_SHA256}.jar`);

const SE_APK_PATH = _path.default.resolve(SE_DIR, 'selendroid-server.apk');

exports.SE_APK_PATH = SE_APK_PATH;

const SE_MANIFEST_PATH = _path.default.resolve(SE_DIR, 'AndroidManifest.xml');

exports.SE_MANIFEST_PATH = SE_MANIFEST_PATH;

async function setupSelendroid() {
  try {
    await (0, _teen_process.exec)('jar');
  } catch (err) {
    if (err.message.indexOf('ENOENT') !== -1 || err.message.indexOf('exited with code 2') !== -1 || err.message.indexOf("Command 'jar' not found. Is it installed?") !== -1) {
      _fancyLog.default.error("Could not find Java's 'jar' executable on your PATH. Please " + 'ensure it is present and try running install again');

      return;
    }
  }

  if (await _appiumSupport.fs.exists(SE_JAR_PATH)) {
    (0, _fancyLog.default)('Standalone jar exists, skipping download: ' + SE_JAR_PATH);
  } else {
    await downloadSelendroid();
  }

  (0, _fancyLog.default)(`Determining AndroidManifest location`);
  let manifestPath = await getFilePathFromJar(/AndroidManifest.*\.xml$/, SE_JAR_PATH);
  (0, _fancyLog.default)(`Determining server apk location`);
  let serverPath = await getFilePathFromJar(/selendroid-server.*\.apk$/, SE_JAR_PATH);
  (0, _fancyLog.default)(`Extracting manifest and apk to ${SE_DOWNLOAD_DIR}`);
  await (0, _teen_process.exec)('jar', ['xf', SE_JAR_PATH, manifestPath, serverPath], {
    cwd: SE_DOWNLOAD_DIR
  });
  (0, _fancyLog.default)(`Copying manifest and apk to ${SE_DIR}`);

  let extractedManifestPath = _path.default.resolve(SE_DOWNLOAD_DIR, manifestPath);

  let extractedServerPath = _path.default.resolve(SE_DOWNLOAD_DIR, serverPath);

  await _appiumSupport.fs.copyFile(extractedManifestPath, SE_MANIFEST_PATH);
  await _appiumSupport.fs.copyFile(extractedServerPath, SE_APK_PATH);
  (0, _fancyLog.default)('Cleaning up temp files');
  await _appiumSupport.fs.rimraf(extractedManifestPath);
  await _appiumSupport.fs.rimraf(extractedServerPath);
  (0, _fancyLog.default)(`Fixing AndroidManifest icon bug`);
  await fixManifestIcons(SE_MANIFEST_PATH);

  if (!(await serverExists())) {
    throw new Error('Something went wrong in setting up selendroid');
  }
}

async function downloadSelendroid() {
  (0, _fancyLog.default)(`Ensuring ${SE_DOWNLOAD_DIR} exists`);
  await _appiumSupport.fs.mkdir(SE_DIR);
  await _appiumSupport.fs.mkdir(SE_DOWNLOAD_DIR);
  (0, _fancyLog.default)(`Downloading Selendroid standalone server version ${SE_VER} from ` + `${SE_DOWNLOAD} --> ${SE_JAR_PATH}`);
  let body = await _requestPromise.default.get({
    url: SE_DOWNLOAD,
    encoding: null
  });

  if (!(body instanceof Buffer)) {
    throw new Error(Object.prototype.toString.call(body));
  }

  (0, _fancyLog.default)(`Writing binary content to ${SE_JAR_PATH_TMP}`);
  await _appiumSupport.fs.writeFile(SE_JAR_PATH_TMP, body);
  await _appiumSupport.fs.chmod(SE_JAR_PATH_TMP, 0o0644);
  let fingerprint = sha256(body);

  if (fingerprint === SE_DOWNLOAD_SHA256) {
    await _appiumSupport.fs.rename(SE_JAR_PATH_TMP, SE_JAR_PATH);
    (0, _fancyLog.default)('Selendroid standalone server downloaded');
  } else {
    throw new Error(`Bad SHA256 fingerprint: '${fingerprint}', bytes: ${body.length}`);
  }
}

function sha256(buffer) {
  const hash = _crypto.default.createHash('sha256');

  return hash.update(buffer).digest('hex');
}

async function getFilePathFromJar(fileRegex, jarPath) {
  let {
    stdout
  } = await (0, _teen_process.exec)('jar', ['tf', jarPath]);

  for (let line of stdout.split('\n')) {
    if (fileRegex.test(line.trim())) {
      return line.trim();
    }
  }

  throw new Error(`Could not find ${fileRegex} in ${jarPath}`);
}

async function serverExists() {
  try {
    return (await _appiumSupport.fs.exists(SE_APK_PATH)) && (await _appiumSupport.fs.exists(SE_MANIFEST_PATH));
  } catch (e) {
    if (e.code.indexOf('ENOENT') !== -1) {
      return false;
    }

    throw e;
  }
}

async function fixManifestIcons(manifest) {
  let curData = (await _appiumSupport.fs.readFile(manifest)).toString('utf8');
  let iconRe = /application[\s\S]+android:icon="[^"]+"/;
  let newData = curData.replace(iconRe, 'application');
  await _appiumSupport.fs.writeFile(manifest, newData);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsZXIuanMiXSwibmFtZXMiOlsiU0VfVkVSIiwiU0VfRE9XTkxPQURfQ0ROVVJMIiwicHJvY2VzcyIsImVudiIsIm5wbV9jb25maWdfc2VsZW5kcm9pZF9kcml2ZXJfY2RudXJsIiwiU0VMRU5EUk9JRF9EUklWRVJfQ0ROVVJMIiwiU0VfRE9XTkxPQUQiLCJTRV9ET1dOTE9BRF9TSEEyNTYiLCJTRV9ESVIiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIlNFX0RPV05MT0FEX0RJUiIsIlNFX0pBUl9QQVRIX1RNUCIsIlNFX0pBUl9QQVRIIiwiU0VfQVBLX1BBVEgiLCJTRV9NQU5JRkVTVF9QQVRIIiwic2V0dXBTZWxlbmRyb2lkIiwiZXJyIiwibWVzc2FnZSIsImluZGV4T2YiLCJsb2ciLCJlcnJvciIsImZzIiwiZXhpc3RzIiwiZG93bmxvYWRTZWxlbmRyb2lkIiwibWFuaWZlc3RQYXRoIiwiZ2V0RmlsZVBhdGhGcm9tSmFyIiwic2VydmVyUGF0aCIsImN3ZCIsImV4dHJhY3RlZE1hbmlmZXN0UGF0aCIsImV4dHJhY3RlZFNlcnZlclBhdGgiLCJjb3B5RmlsZSIsInJpbXJhZiIsImZpeE1hbmlmZXN0SWNvbnMiLCJzZXJ2ZXJFeGlzdHMiLCJFcnJvciIsIm1rZGlyIiwiYm9keSIsInJlcXVlc3QiLCJnZXQiLCJ1cmwiLCJlbmNvZGluZyIsIkJ1ZmZlciIsIk9iamVjdCIsInByb3RvdHlwZSIsInRvU3RyaW5nIiwiY2FsbCIsIndyaXRlRmlsZSIsImNobW9kIiwiZmluZ2VycHJpbnQiLCJzaGEyNTYiLCJyZW5hbWUiLCJsZW5ndGgiLCJidWZmZXIiLCJoYXNoIiwiY3J5cHRvIiwiY3JlYXRlSGFzaCIsInVwZGF0ZSIsImRpZ2VzdCIsImZpbGVSZWdleCIsImphclBhdGgiLCJzdGRvdXQiLCJsaW5lIiwic3BsaXQiLCJ0ZXN0IiwidHJpbSIsImUiLCJjb2RlIiwibWFuaWZlc3QiLCJjdXJEYXRhIiwicmVhZEZpbGUiLCJpY29uUmUi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QUYsQ0FBT2hELE9BQVAsQ0FBZSxRQUFmLE1BQTZCLENBQUMsQ0FBbEMsRUFBcUM7QUFDbkMsYUFBTyxLQUFQO0FBQ0Q7O0FBQ0QsVUFBTStDLENBQU47QUFDRDtBQUNGOztBQUVELGVBQWVqQyxnQkFBZixDQUFpQ21DLFFBQWpDLEVBQTJDO0FBQ3pDLE1BQUlDLE9BQU8sR0FBRyxDQUFDLE1BQU0vQyxrQkFBR2dELFFBQUgsQ0FBWUYsUUFBWixDQUFQLEVBQThCdkIsUUFBOUIsQ0FBdUMsTUFBdkMsQ0FBZDtBQUNBLE1BQUkwQixNQUFNLEdBQUcsd0NBQWI7QUFDQSxNQUFJQyxPQUFPLEdBQUdILE9BQU8sQ0FBQ0ksT0FBUixDQUFnQkYsTUFBaEIsRUFBd0IsYUFBeEIsQ0FBZDtBQUNBLFFBQU1qRCxrQkFBR3lCLFNBQUgsQ0FBYXFCLFFBQWIsRUFBdUJJLE9BQXZCLENBQU47QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJ2ZhbmN5LWxvZyc7XG5pbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5cblxuY29uc3QgU0VfVkVSID0gJzAuMTcuMCc7XG5jb25zdCBTRV9ET1dOTE9BRF9DRE5VUkwgPSBwcm9jZXNzLmVudi5ucG1fY29uZmlnX3NlbGVuZHJvaWRfZHJpdmVyX2NkbnVybCB8fFxuICBwcm9jZXNzLmVudi5TRUxFTkRST0lEX0RSSVZFUl9DRE5VUkwgfHxcbiAgJ2h0dHBzOi8vcmVwbzEubWF2ZW4ub3JnL21hdmVuMi9pby9zZWxlbmRyb2lkL3NlbGVuZHJvaWQtc3RhbmRhbG9uZSc7XG5jb25zdCBTRV9ET1dOTE9BRCA9IGAke1NFX0RPV05MT0FEX0NETlVSTH0vJHtTRV9WRVJ9L3NlbGVuZHJvaWQtc3RhbmRhbG9uZS0ke1NFX1ZFUn0td2l0aC1kZXBlbmRlbmNpZXMuamFyYDtcbmNvbnN0IFNFX0RPV05MT0FEX1NIQTI1NiA9ICc3Y2Y3MTYzYWM0N2YxYzQ2ZWZmOTViNjJmNzhiNThjMWRhYmRlYzUzNGFjYzY2MzJkYTM3ODQ3MzlmNmU5ZDgyJztcbmNvbnN0IFNFX0RJUiA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdzZWxlbmRyb2lkJyk7XG5jb25zdCBTRV9ET1dOTE9BRF9ESVIgPSBwYXRoLnJlc29sdmUoU0VfRElSLCAnZG93bmxvYWQnKTtcbi8vIFVzZSBvZiB0ZW1wb3JhcnkgZmlsZSBtZWFucyB0aGF0IFNFX0pBUl9QQVRIIGNhbiBvbmx5IGV4aXN0IGlmIGl0IGhhc1xuLy8gdmVyaWZpZWQgY29udGVudC5cbmNvbnN0IFNFX0pBUl9QQVRIX1RNUCA9IHBhdGgucmVzb2x2ZShTRV9ET1dOTE9BRF9ESVIsICdzZWxlbmRyb2lkLXNlcnZlci5qYXIudG1wJyk7XG4vLyBQdXR0aW5nIGZpbmdlcnByaW50IGluIGZpbGUgbmFtZSBtZWFucyBkb3dubG9hZCB0cmlnZ2VyZWQgaWYgZmluZ2VycHJpbnQgY2hhbmdlZC5cbmNvbnN0IFNFX0pBUl9QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RPV05MT0FEX0RJUiwgYHNlbGVuZHJvaWQtc2VydmVyLSR7U0VfRE9XTkxPQURfU0hBMjU2fS5qYXJgKTtcbmNvbnN0IFNFX0FQS19QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RJUiwgJ3NlbGVuZHJvaWQtc2VydmVyLmFwaycpO1xuY29uc3QgU0VfTUFOSUZFU1RfUEFUSCA9IHBhdGgucmVzb2x2ZShTRV9ESVIsICdBbmRyb2lkTWFuaWZlc3QueG1sJyk7XG5cbmFzeW5jIGZ1bmN0aW9uIHNldHVwU2VsZW5kcm9pZCAoKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygnamFyJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCdFTk9FTlQnKSAhPT0gLTEgfHxcbiAgICAgICAgZXJyLm1lc3NhZ2UuaW5kZXhPZignZXhpdGVkIHdpdGggY29kZSAyJykgIT09IC0xIHx8XG4gICAgICAgIGVyci5tZXNzYWdlLmluZGV4T2YoXCJDb21tYW5kICdqYXInIG5vdCBmb3VuZC4gSXMgaXQgaW5zdGFsbGVkP1wiKSAhPT0gLTEpIHtcbiAgICAgIGxvZy5lcnJvcihcIkNvdWxkIG5vdCBmaW5kIEphdmEncyAnamFyJyBleGVjdXRhYmxlIG9uIHlvdXIgUEFUSC4gUGxlYXNlIFwiICtcbiAgICAgICAgICAgICAgICAnZW5zdXJlIGl0IGlzIHByZXNlbnQgYW5kIHRyeSBydW5uaW5nIGluc3RhbGwgYWdhaW4nKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhTRV9KQVJfUEFUSCkpIHtcbiAgICBsb2coJ1N0YW5kYWxvbmUgamFyIGV4aXN0cywgc2tpcHBpbmcgZG93bmxvYWQ6ICcgKyBTRV9KQVJfUEFUSCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgZG93bmxvYWRTZWxlbmRyb2lkKCk7XG4gIH1cbiAgbG9nKGBEZXRlcm1pbmluZyBBbmRyb2lkTWFuaWZlc3QgbG9jYXRpb25gKTtcbiAgbGV0IG1hbmlmZXN0UGF0aCA9IGF3YWl0IGdldEZpbGVQYXRoRnJvbUphcigvQW5kcm9pZE1hbmlmZXN0LipcXC54bWwkLyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTRV9KQVJfUEFUSCk7XG4gIGxvZyhgRGV0ZXJtaW5pbmcgc2VydmVyIGFwayBsb2NhdGlvbmApO1xuICBsZXQgc2VydmVyUGF0aCA9IGF3YWl0IGdldEZpbGVQYXRoRnJvbUphcigvc2VsZW5kcm9pZC1zZXJ2ZXIuKlxcLmFwayQvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTRV9KQVJfUEFUSCk7XG4gIGxvZyhgRXh0cmFjdGluZyBtYW5pZmVzdCBhbmQgYXBrIHRvICR7U0VfRE9XTkxPQURfRElSfWApO1xuICBhd2FpdCBleGVjKCdqYXInLCBbJ3hmJywgU0VfSkFSX1BBVEgsIG1hbmlmZXN0UGF0aCwgc2VydmVyUGF0aF0sIHtcbiAgICBjd2Q6IFNFX0RPV05MT0FEX0RJUlxuICB9KTtcbiAgbG9nKGBDb3B5aW5nIG1hbmlmZXN0IGFuZCBhcGsgdG8gJHtTRV9ESVJ9YCk7XG4gIGxldCBleHRyYWN0ZWRNYW5pZmVzdFBhdGggPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBtYW5pZmVzdFBhdGgpO1xuICBsZXQgZXh0cmFjdGVkU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZShTRV9ET1dOTE9BRF9ESVIsIHNlcnZlclBhdGgpO1xuICBhd2FpdCBmcy5jb3B5RmlsZShleHRyYWN0ZWRNYW5pZmVzdFBhdGgsIFNFX01BTklGRVNUX1BBVEgpO1xuICBhd2FpdCBmcy5jb3B5RmlsZShleHRyYWN0ZWRTZXJ2ZXJQYXRoLCBTRV9BUEtfUEFUSCk7XG4gIGxvZygnQ2xlYW5pbmcgdXAgdGVtcCBmaWxlcycpO1xuICBhd2FpdCBmcy5yaW1yYWYoZXh0cmFjdGVkTWFuaWZlc3RQYXRoKTtcbiAgYXdhaXQgZnMucmltcmFmKGV4dHJhY3RlZFNlcnZlclBhdGgpO1xuICBsb2coYEZpeGluZyBBbmRyb2lkTWFuaWZlc3QgaWNvbiBidWdgKTtcbiAgYXdhaXQgZml4TWFuaWZlc3RJY29ucyhTRV9NQU5JRkVTVF9QQVRIKTtcbiAgaWYgKCEoYXdhaXQgc2VydmVyRXhpc3RzKCkpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdTb21ldGhpbmcgd2VudCB3cm9uZyBpbiBzZXR0aW5nIHVwIHNlbGVuZHJvaWQnKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBkb3dubG9hZFNlbGVuZHJvaWQgKCkge1xuICBsb2coYEVuc3VyaW5nICR7U0VfRE9XTkxPQURfRElSfSBleGlzdHNgKTtcbiAgYXdhaXQgZnMubWtkaXIoU0VfRElSKTtcbiAgYXdhaXQgZnMubWtkaXIoU0VfRE9XTkxPQURfRElSKTtcbiAgbG9nKGBEb3dubG9hZGluZyBTZWxlbmRyb2lkIHN0YW5kYWxvbmUgc2VydmVyIHZlcnNpb24gJHtTRV9WRVJ9IGZyb20gYCArXG4gICAgICAgICAgIGAke1NFX0RPV05MT0FEfSAtLT4gJHtTRV9KQVJfUEFUSH1gKTtcbiAgbGV0IGJvZHkgPSBhd2FpdCByZXF1ZXN0LmdldCh7dXJsOiBTRV9ET1dOTE9BRCwgZW5jb2Rpbmc6IG51bGx9KTtcbiAgaWYgKCEoYm9keSBpbnN0YW5jZW9mIEJ1ZmZlcikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGJvZHkpKTtcbiAgfVxuICBsb2coYFdyaXRpbmcgYmluYXJ5IGNvbnRlbnQgdG8gJHtTRV9KQVJfUEFUSF9UTVB9YCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShTRV9KQVJfUEFUSF9UTVAsIGJvZHkpO1xuICBhd2FpdCBmcy5jaG1vZChTRV9KQVJfUEFUSF9UTVAsIDBvMDY0NCk7XG4gIGxldCBmaW5nZXJwcmludCA9IHNoYTI1Nihib2R5KTtcbiAgaWYgKGZpbmdlcnByaW50ID09PSBTRV9ET1dOTE9BRF9TSEEyNTYpIHtcbiAgICBhd2FpdCBmcy5yZW5hbWUoU0VfSkFSX1BBVEhfVE1QLCBTRV9KQVJfUEFUSCk7XG4gICAgbG9nKCdTZWxlbmRyb2lkIHN0YW5kYWxvbmUgc2VydmVyIGRvd25sb2FkZWQnKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEJhZCBTSEEyNTYgZmluZ2VycHJpbnQ6ICcke2ZpbmdlcnByaW50fScsIGJ5dGVzOiAke2JvZHkubGVuZ3RofWApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHNoYTI1NiAoYnVmZmVyKSB7XG4gIGNvbnN0IGhhc2ggPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMjU2Jyk7XG4gIHJldHVybiBoYXNoLnVwZGF0ZShidWZmZXIpLmRpZ2VzdCgnaGV4Jyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEZpbGVQYXRoRnJvbUphciAoZmlsZVJlZ2V4LCBqYXJQYXRoKSB7XG4gIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2phcicsIFsndGYnLCBqYXJQYXRoXSk7XG4gIGZvciAobGV0IGxpbmUgb2Ygc3Rkb3V0LnNwbGl0KCdcXG4nKSkge1xuICAgIGlmIChmaWxlUmVnZXgudGVzdChsaW5lLnRyaW0oKSkpIHtcbiAgICAgIHJldHVybiBsaW5lLnRyaW0oKTtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCAke2ZpbGVSZWdleH0gaW4gJHtqYXJQYXRofWApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXJ2ZXJFeGlzdHMgKCkge1xuICB0cnkge1xuICAgIHJldHVybiAoYXdhaXQgZnMuZXhpc3RzKFNFX0FQS19QQVRIKSAmJlxuICAgICAgICAgICAgYXdhaXQgZnMuZXhpc3RzKFNFX01BTklGRVNUX1BBVEgpKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLmNvZGUuaW5kZXhPZignRU5PRU5UJykgIT09IC0xKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4TWFuaWZlc3RJY29ucyAobWFuaWZlc3QpIHtcbiAgbGV0IGN1ckRhdGEgPSAoYXdhaXQgZnMucmVhZEZpbGUobWFuaWZlc3QpKS50b1N0cmluZygndXRmOCcpO1xuICBsZXQgaWNvblJlID0gL2FwcGxpY2F0aW9uW1xcc1xcU10rYW5kcm9pZDppY29uPVwiW15cIl0rXCIvO1xuICBsZXQgbmV3RGF0YSA9IGN1ckRhdGEucmVwbGFjZShpY29uUmUsICdhcHBsaWNhdGlvbicpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUobWFuaWZlc3QsIG5ld0RhdGEpO1xufVxuXG5leHBvcnQgeyBzZXR1cFNlbGVuZHJvaWQsIHNlcnZlckV4aXN0cywgU0VfQVBLX1BBVEgsIFNFX01BTklGRVNUX1BBVEggfTtcbiJdLCJmaWxlIjoibGliL2luc3RhbGxlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
