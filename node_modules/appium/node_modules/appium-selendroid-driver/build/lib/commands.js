"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _utf = _interopRequireDefault(require("utf7"));

var _appiumAndroidDriver = require("appium-android-driver");

var _driver = require("./driver");

const {
  imap
} = _utf.default;
let extensions = {},
    commands = {},
    helpers = {};

commands.launchApp = async function launchApp() {
  await this.startSelendroidSession();
};

commands.reset = async function reset() {
  _logger.default.debug('Running generic full reset');

  let oldImpWait = this.implicitWaitMs;
  let oldCommandTimeoutMs = this.commandTimeoutMs;
  let oldSessionId = this.sessionId;
  await this.deleteSession();

  _logger.default.debug('Restarting app');

  await this.startSelendroidSession();
  this.implicitWait(oldImpWait);
  this.timeouts('command', oldCommandTimeoutMs);
  this.sessionId = oldSessionId;
};

commands.performMultiAction = async function performMultiAction(elId, actions) {
  if (elId) {
    throw new Error('Selendroid actions do not support element id');
  }

  return await this.selendroid.jwproxy.command('/action', 'POST', {
    payload: actions
  });
};

function encodeString(value, unicode) {
  for (let i = 0; i < value.length; i++) {
    let c = value.charCodeAt(i);

    if (unicode && (c > 127 || c === 38)) {
      if (c >= parseInt('E000', 16) && c <= parseInt('E040', 16)) {} else {
        value = imap.encode(value);
        break;
      }
    }
  }

  return value;
}

commands.setValue = async function setValue(value, elementId) {
  if (value instanceof Array) {
    value = value.join('');
  }

  _logger.default.debug(`Setting text on element '${elementId}': '${value}'`);

  value = encodeString(value, this.opts.unicodeKeyboard);
  await this.selendroid.jwproxy.command(`/element/${elementId}/value`, 'POST', {
    value: [value]
  });
};

commands.getElementRect = async function getElementRect(elementId) {
  const location = await this.selendroid.jwproxy.command(`/element/${elementId}/location`, 'GET');
  const size = await this.selendroid.jwproxy.command(`/element/${elementId}/size`, 'GET');
  return Object.assign(location, size);
};

commands.keys = async function keys(value) {
  if (value instanceof Array) {
    value = value.join('');
  }

  _logger.default.debug(`Setting text: '${value}'`);

  value = encodeString(value, this.opts.unicodeKeyboard);
  await this.selendroid.jwproxy.command('/keys', 'POST', {
    value: [value]
  });
};

commands.keyevent = async function keyevent(keycode, metastate) {
  _logger.default.debug(`Ignoring metastate ${metastate}`);

  await this.adb.keyevent(keycode);
};

commands.back = async function back() {
  await this.adb.keyevent(4);
};

commands.getContexts = async function getContexts() {
  let chromiumViews = [];
  let webviews = await _appiumAndroidDriver.webviewHelpers.getWebviews(this.adb, this.opts.androidDeviceSocket);

  if (_lodash.default.includes(webviews, _appiumAndroidDriver.CHROMIUM_WIN)) {
    chromiumViews = [_appiumAndroidDriver.CHROMIUM_WIN];
  } else {
    chromiumViews = [];
  }

  _logger.default.info('Getting window handles from Selendroid');

  let selendroidViews = await this.selendroid.jwproxy.command('/window_handles', 'GET', {});
  this.contexts = _lodash.default.union(selendroidViews, chromiumViews);

  _logger.default.info(`Available contexts: ${JSON.stringify(this.contexts)}`);

  return this.contexts;
};

helpers.switchContext = async function switchContext(name) {
  await this.selendroid.jwproxy.command('/window', 'POST', {
    name
  });
};

helpers.isChromedriverContext = function isChromedriverContext(windowName) {
  return windowName === _appiumAndroidDriver.CHROMIUM_WIN;
};

helpers.wrapBootstrapDisconnect = async function wrapBootstrapDisconnect(wrapped) {
  await wrapped();
  await this.adb.restart();
  await this.adb.forwardPort(this.opts.systemPort, _driver.DEVICE_PORT);
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy5qcyJdLCJuYW1lcyI6WyJpbWFwIiwidXRmNyIsImV4dGVuc2lvbnMiLCJjb21tYW5kcyIsImhlbHBlcnMiLCJsYXVuY2hBcHAiLCJzdGFydFNlbGVuZHJvaWRTZXNzaW9uIiwicmVzZXQiLCJsb2ciLCJkZWJ1ZyIsIm9sZEltcFdhaXQiLCJpbXBsaWNpdFdhaXRNcyIsIm9sZENvbW1hbmRUaW1lb3V0TXMiLCJjb21tYW5kVGltZW91dE1zIiwib2xkU2Vzc2lvbklkIiwic2Vzc2lvbklkIiwiZGVsZXRlU2Vzc2lvbiIsImltcGxpY2l0V2FpdCIsInRpbWVvdXRzIiwicGVyZm9ybU11bHRpQWN0aW9uIiwiZWxJZCIsImFjdGlvbnMiLCJFcnJvciIsInNlbGVuZHJvaWQiLCJqd3Byb3h5IiwiY29tbWFuZCIsInBheWxvYWQiLCJlbmNvZGVTdHJpbmciLCJ2YWx1ZSIsInVuaWNvZGUiLCJpIiwibGVuZ3RoIiwiYyIsImNoYXJDb2RlQXQiLCJwYXJzZUludCIsImVuY29kZSIsInNldFZhbHVlIiwiZWxlbWVudElkIiwiQXJyYXkiLCJqb2luIiwib3B0cyIsInVuaWNvZGVLZXlib2FyZCIsImdldEVsZW1lbnRSZWN0IiwibG9jYXRpb24iLCJzaXplIiwiT2JqZWN0IiwiYXNzaWduIiwia2V5cyIsImtleWV2ZW50Iiwia2V5Y29kZSIsIm1ldGFzdGF0ZSIsImFkYiIsImJhY2siLCJnZXRDb250ZXh0cyIsImNocm9taXVtVmlld3MiLCJ3ZWJ2aWV3cyIsIndlYnZpZXdIZWxwZXJzIiwiZ2V0V2Vidmlld3MiLCJhbmRyb2lkRGV2aWNlU29ja2V0IiwiXyIsImluY2x1ZGVzIiwiQ0hST01JVU1fV0lOIiwiaW5mbyIsInNlbGVuZHJvaWRWaWV3cyIsImNvbnRleHRzIiwidW5pb24iLCJKU09OIiwic3RyaW5naWZ5Iiwic3dpdGNoQ29udGV4dCIsIm5hbWUiLCJpc0Nocm9tZWRyaXZlckNvbnRleHQiLCJ3aW5kb3dOYW1lIiwid3JhcEJvb3RzdHJhcERpc2Nvbm5lY3QiLCJ3cmFwcGVkIiwicmVzdGFydCIsImZvcndhcmRQb3J0Iiwic3lzdGVtUG9ydCIsIkRFVklDRV9QT1JUIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU07QUFBQ0EsRUFBQUE7QUFBRCxJQUFTQyxZQUFmO0FBRUEsSUFBSUMsVUFBVSxHQUFHLEVBQWpCO0FBQUEsSUFDSUMsUUFBUSxHQUFHLEVBRGY7QUFBQSxJQUVJQyxPQUFPLEdBQUcsRUFGZDs7QUFJQUQsUUFBUSxDQUFDRSxTQUFULEdBQXFCLGVBQWVBLFNBQWYsR0FBNEI7QUFDL0MsUUFBTSxLQUFLQyxzQkFBTCxFQUFOO0FBQ0QsQ0FGRDs7QUFHQUgsUUFBUSxDQUFDSSxLQUFULEdBQWlCLGVBQWVBLEtBQWYsR0FBd0I7QUFDdkNDLGtCQUFJQyxLQUFKLENBQVUsNEJBQVY7O0FBQ0EsTUFBSUMsVUFBVSxHQUFHLEtBQUtDLGNBQXRCO0FBQ0EsTUFBSUMsbUJBQW1CLEdBQUcsS0FBS0MsZ0JBQS9CO0FBQ0EsTUFBSUMsWUFBWSxHQUFHLEtBQUtDLFNBQXhCO0FBRUEsUUFBTSxLQUFLQyxhQUFMLEVBQU47O0FBQ0FSLGtCQUFJQyxLQUFKLENBQVUsZ0JBQVY7O0FBQ0EsUUFBTSxLQUFLSCxzQkFBTCxFQUFOO0FBQ0EsT0FBS1csWUFBTCxDQUFrQlAsVUFBbEI7QUFDQSxPQUFLUSxRQUFMLENBQWMsU0FBZCxFQUF5Qk4sbUJBQXpCO0FBQ0EsT0FBS0csU0FBTCxHQUFpQkQsWUFBakI7QUFDRCxDQVpEOztBQWNBWCxRQUFRLENBQUNnQixrQkFBVCxHQUE4QixlQUFlQSxrQkFBZixDQUFtQ0MsSUFBbkMsRUFBeUNDLE9BQXpDLEVBQWtEO0FBQzlFLE1BQUlELElBQUosRUFBVTtBQUNSLFVBQU0sSUFBSUUsS0FBSixDQUFVLDhDQUFWLENBQU47QUFDRDs7QUFDRCxTQUFPLE1BQU0sS0FBS0MsVUFBTCxDQUFnQkMsT0FBaEIsQ0FBd0JDLE9BQXhCLENBQWdDLFNB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Q2dFLGFBQVIsR0FBd0IsZUFBZUEsYUFBZixDQUE4QkMsSUFBOUIsRUFBb0M7QUFFMUQsUUFBTSxLQUFLOUMsVUFBTCxDQUFnQkMsT0FBaEIsQ0FBd0JDLE9BQXhCLENBQWdDLFNBQWhDLEVBQTJDLE1BQTNDLEVBQW1EO0FBQUM0QyxJQUFBQTtBQUFELEdBQW5ELENBQU47QUFDRCxDQUhEOztBQUtBakUsT0FBTyxDQUFDa0UscUJBQVIsR0FBZ0MsU0FBU0EscUJBQVQsQ0FBZ0NDLFVBQWhDLEVBQTRDO0FBQzFFLFNBQU9BLFVBQVUsS0FBS1YsaUNBQXRCO0FBQ0QsQ0FGRDs7QUFPQXpELE9BQU8sQ0FBQ29FLHVCQUFSLEdBQWtDLGVBQWVBLHVCQUFmLENBQXdDQyxPQUF4QyxFQUFpRDtBQUNqRixRQUFNQSxPQUFPLEVBQWI7QUFDQSxRQUFNLEtBQUt0QixHQUFMLENBQVN1QixPQUFULEVBQU47QUFDQSxRQUFNLEtBQUt2QixHQUFMLENBQVN3QixXQUFULENBQXFCLEtBQUtuQyxJQUFMLENBQVVvQyxVQUEvQixFQUEyQ0MsbUJBQTNDLENBQU47QUFDRCxDQUpEOztBQU1BaEMsTUFBTSxDQUFDQyxNQUFQLENBQWM1QyxVQUFkLEVBQTBCQyxRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUYsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB1dGY3IGZyb20gJ3V0ZjcnO1xuaW1wb3J0IHsgd2Vidmlld0hlbHBlcnMsIENIUk9NSVVNX1dJTiB9IGZyb20gJ2FwcGl1bS1hbmRyb2lkLWRyaXZlcic7XG5pbXBvcnQgeyBERVZJQ0VfUE9SVCB9IGZyb20gJy4vZHJpdmVyJztcblxuY29uc3Qge2ltYXB9ID0gdXRmNztcblxubGV0IGV4dGVuc2lvbnMgPSB7fSxcbiAgICBjb21tYW5kcyA9IHt9LFxuICAgIGhlbHBlcnMgPSB7fTtcblxuY29tbWFuZHMubGF1bmNoQXBwID0gYXN5bmMgZnVuY3Rpb24gbGF1bmNoQXBwICgpIHtcbiAgYXdhaXQgdGhpcy5zdGFydFNlbGVuZHJvaWRTZXNzaW9uKCk7XG59O1xuY29tbWFuZHMucmVzZXQgPSBhc3luYyBmdW5jdGlvbiByZXNldCAoKSB7XG4gIGxvZy5kZWJ1ZygnUnVubmluZyBnZW5lcmljIGZ1bGwgcmVzZXQnKTtcbiAgbGV0IG9sZEltcFdhaXQgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuICBsZXQgb2xkQ29tbWFuZFRpbWVvdXRNcyA9IHRoaXMuY29tbWFuZFRpbWVvdXRNcztcbiAgbGV0IG9sZFNlc3Npb25JZCA9IHRoaXMuc2Vzc2lvbklkO1xuXG4gIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICBsb2cuZGVidWcoJ1Jlc3RhcnRpbmcgYXBwJyk7XG4gIGF3YWl0IHRoaXMuc3RhcnRTZWxlbmRyb2lkU2Vzc2lvbigpO1xuICB0aGlzLmltcGxpY2l0V2FpdChvbGRJbXBXYWl0KTtcbiAgdGhpcy50aW1lb3V0cygnY29tbWFuZCcsIG9sZENvbW1hbmRUaW1lb3V0TXMpO1xuICB0aGlzLnNlc3Npb25JZCA9IG9sZFNlc3Npb25JZDtcbn07XG5cbmNvbW1hbmRzLnBlcmZvcm1NdWx0aUFjdGlvbiA9IGFzeW5jIGZ1bmN0aW9uIHBlcmZvcm1NdWx0aUFjdGlvbiAoZWxJZCwgYWN0aW9ucykge1xuICBpZiAoZWxJZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignU2VsZW5kcm9pZCBhY3Rpb25zIGRvIG5vdCBzdXBwb3J0IGVsZW1lbnQgaWQnKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5zZWxlbmRyb2lkLmp3cHJveHkuY29tbWFuZCgnL2FjdGlvbicsICdQT1NUJywge3BheWxvYWQ6IGFjdGlvbnN9KTtcbn07XG5cbmZ1bmN0aW9uIGVuY29kZVN0cmluZyAodmFsdWUsIHVuaWNvZGUpIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykge1xuICAgIGxldCBjID0gdmFsdWUuY2hhckNvZGVBdChpKTtcbiAgICAvLyBpZiB3ZSdyZSB1c2luZyB0aGUgdW5pY29kZSBrZXlib2FyZCwgYW5kIHRoaXMgaXMgdW5pY29kZSwgbWF5YmUgZW5jb2RlXG4gICAgaWYgKHVuaWNvZGUgJiYgKGMgPiAxMjcgfHwgYyA9PT0gMzgpKSB7XG4gICAgICAvLyB0aGlzIGlzIG5vdCBzaW1wbGUgYXNjaWksIG9yIGl0IGlzIGFuIGFtcGVyc2FuZCAoYCZgKVxuICAgICAgaWYgKGMgPj0gcGFyc2VJbnQoJ0UwMDAnLCAxNikgJiYgYyA8PSBwYXJzZUludCgnRTA0MCcsIDE2KSkge1xuICAgICAgICAvLyBTZWxlbml1bSB1c2VzIGEgVW5pY29kZSBQVUEgdG8gY292ZXIgY2VydGFpbiBzcGVjaWFsIGNoYXJhY3RlcnNcbiAgICAgICAgLy8gc2VlIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3Avc2VsZW5pdW0vc291cmNlL2Jyb3dzZS9qYXZhL2NsaWVudC9zcmMvb3JnL29wZW5xYS9zZWxlbml1bS9LZXlzLmphdmFcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGVuY29kZSB0aGUgdGV4dFxuICAgICAgICB2YWx1ZSA9IGltYXAuZW5jb2RlKHZhbHVlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiB2YWx1ZTtcbn1cblxuLy8gTmVlZCB0byBvdmVycmlkZSB0aGlzIGZvciBjb3JyZWN0IHVuaWNvZGUgc3VwcG9ydFxuY29tbWFuZHMuc2V0VmFsdWUgPSBhc3luYyBmdW5jdGlvbiBzZXRWYWx1ZSAodmFsdWUsIGVsZW1lbnRJZCkge1xuICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgIHZhbHVlID0gdmFsdWUuam9pbignJyk7XG4gIH1cbiAgbG9nLmRlYnVnKGBTZXR0aW5nIHRleHQgb24gZWxlbWVudCAnJHtlbGVtZW50SWR9JzogJyR7dmFsdWV9J2ApO1xuICB2YWx1ZSA9IGVuY29kZVN0cmluZyh2YWx1ZSwgdGhpcy5vcHRzLnVuaWNvZGVLZXlib2FyZCk7XG4gIGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoYC9lbGVtZW50LyR7ZWxlbWVudElkfS92YWx1ZWAsICdQT1NUJywge3ZhbHVlOiBbdmFsdWVdfSk7XG59O1xuXG4vLyBUaGlzIGlzIG5lZWRlZCB0byBzYXRpc2Z5IHVwZGF0ZWQgV2ViRWxlbWVudCBpbnRlcmZhY2UgaW4gU2VsZW5pdW0gM1xuY29tbWFuZHMuZ2V0RWxlbWVudFJlY3QgPSBhc3luYyBmdW5jdGlvbiBnZXRFbGVtZW50UmVjdCAoZWxlbWVudElkKSB7XG4gIGNvbnN0IGxvY2F0aW9uID0gYXdhaXQgdGhpcy5zZWxlbmRyb2lkLmp3cHJveHkuY29tbWFuZChgL2VsZW1lbnQvJHtlbGVtZW50SWR9L2xvY2F0aW9uYCwgJ0dFVCcpO1xuICBjb25zdCBzaXplID0gYXdhaXQgdGhpcy5zZWxlbmRyb2lkLmp3cHJveHkuY29tbWFuZChgL2VsZW1lbnQvJHtlbGVtZW50SWR9L3NpemVgLCAnR0VUJyk7XG4gIHJldHVybiBPYmplY3QuYXNzaWduKGxvY2F0aW9uLCBzaXplKTtcbn07XG5cbi8vIE5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBmb3IgY29ycmVjdCB1bmljb2RlIHN1cHBvcnRcbmNvbW1hbmRzLmtleXMgPSBhc3luYyBmdW5jdGlvbiBrZXlzICh2YWx1ZSkge1xuICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgIHZhbHVlID0gdmFsdWUuam9pbignJyk7XG4gIH1cbiAgbG9nLmRlYnVnKGBTZXR0aW5nIHRleHQ6ICcke3ZhbHVlfSdgKTtcbiAgdmFsdWUgPSBlbmNvZGVTdHJpbmcodmFsdWUsIHRoaXMub3B0cy51bmljb2RlS2V5Ym9hcmQpO1xuICBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuandwcm94eS5jb21tYW5kKCcva2V5cycsICdQT1NUJywge3ZhbHVlOiBbdmFsdWVdfSk7XG59O1xuXG4vLyBTZWxlbmRyb2lkIGRvZXNuJ3Qgc3VwcG9ydCBtZXRhc3RhdGUgZm9yIGtleWV2ZW50c1xuY29tbWFuZHMua2V5ZXZlbnQgPSBhc3luYyBmdW5jdGlvbiBrZXlldmVudCAoa2V5Y29kZSwgbWV0YXN0YXRlKSB7XG4gIGxvZy5kZWJ1ZyhgSWdub3JpbmcgbWV0YXN0YXRlICR7bWV0YXN0YXRlfWApO1xuICBhd2FpdCB0aGlzLmFkYi5rZXlldmVudChrZXljb2RlKTtcbn07XG5cbi8vIFVzZSBBREIgc2luY2Ugd2UgZG9uJ3QgaGF2ZSBVaUF1dG9tYXRvclxuY29tbWFuZHMuYmFjayA9IGFzeW5jIGZ1bmN0aW9uIGJhY2sgKCkge1xuICBhd2FpdCB0aGlzLmFkYi5rZXlldmVudCg0KTtcbn07XG5cbmNvbW1hbmRzLmdldENvbnRleHRzID0gYXN5bmMgZnVuY3Rpb24gZ2V0Q29udGV4dHMgKCkge1xuICBsZXQgY2hyb21pdW1WaWV3cyA9IFtdO1xuICBsZXQgd2Vidmlld3MgPSBhd2FpdCB3ZWJ2aWV3SGVscGVycy5nZXRXZWJ2aWV3cyh0aGlzLmFkYixcbiAgICAgIHRoaXMub3B0cy5hbmRyb2lkRGV2aWNlU29ja2V0KTtcbiAgaWYgKF8uaW5jbHVkZXMod2Vidmlld3MsIENIUk9NSVVNX1dJTikpIHtcbiAgICBjaHJvbWl1bVZpZXdzID0gW0NIUk9NSVVNX1dJTl07XG4gIH0gZWxzZSB7XG4gICAgY2hyb21pdW1WaWV3cyA9IFtdO1xuICB9XG5cbiAgbG9nLmluZm8oJ0dldHRpbmcgd2luZG93IGhhbmRsZXMgZnJvbSBTZWxlbmRyb2lkJyk7XG4gIGxldCBzZWxlbmRyb2lkVmlld3MgPSBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuandwcm94eS5jb21tYW5kKCcvd2luZG93X2hhbmRsZXMnLCAnR0VUJywge30pO1xuICB0aGlzLmNvbnRleHRzID0gXy51bmlvbihzZWxlbmRyb2lkVmlld3MsIGNocm9taXVtVmlld3MpO1xuICBsb2cuaW5mbyhgQXZhaWxhYmxlIGNvbnRleHRzOiAke0pTT04uc3RyaW5naWZ5KHRoaXMuY29udGV4dHMpfWApO1xuICByZXR1cm4gdGhpcy5jb250ZXh0cztcbn07XG5cbmhlbHBlcnMuc3dpdGNoQ29udGV4dCA9IGFzeW5jIGZ1bmN0aW9uIHN3aXRjaENvbnRleHQgKG5hbWUpIHtcbiAgLy8gY2FsbGVkIHdoZW4gc2V0dGluZyBjb250ZXh0XG4gIGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoJy93aW5kb3cnLCAnUE9TVCcsIHtuYW1lfSk7XG59O1xuXG5oZWxwZXJzLmlzQ2hyb21lZHJpdmVyQ29udGV4dCA9IGZ1bmN0aW9uIGlzQ2hyb21lZHJpdmVyQ29udGV4dCAod2luZG93TmFtZSkge1xuICByZXR1cm4gd2luZG93TmFtZSA9PT0gQ0hST01JVU1fV0lOO1xufTtcblxuLy8gTmVlZCB0byBvdmVycmlkZSBhbmRyb2lkLWRyaXZlcidzIHZlcnNpb24gb2YgdGhpcyBzaW5jZSB3ZSBkb24ndCBhY3R1YWxseVxuLy8gaGF2ZSBhIGJvb3RzdHJhcDsgaW5zdGVhZCB3ZSBqdXN0IHJlc3RhcnQgYWRiIGFuZCByZS1mb3J3YXJkIHRoZSBTZWxlbmRyb2lkXG4vLyBwb3J0XG5oZWxwZXJzLndyYXBCb290c3RyYXBEaXNjb25uZWN0ID0gYXN5bmMgZnVuY3Rpb24gd3JhcEJvb3RzdHJhcERpc2Nvbm5lY3QgKHdyYXBwZWQpIHtcbiAgYXdhaXQgd3JhcHBlZCgpO1xuICBhd2FpdCB0aGlzLmFkYi5yZXN0YXJ0KCk7XG4gIGF3YWl0IHRoaXMuYWRiLmZvcndhcmRQb3J0KHRoaXMub3B0cy5zeXN0ZW1Qb3J0LCBERVZJQ0VfUE9SVCk7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcblxuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
