"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.killAllInstruments = killAllInstruments;
exports.cleanAllTraces = cleanAllTraces;
exports.getInstrumentsPath = getInstrumentsPath;
exports.getAvailableDevices = getAvailableDevices;
exports.parseLaunchTimeout = parseLaunchTimeout;
exports.getIwdPath = getIwdPath;
exports.quickLaunch = quickLaunch;
exports.quickInstruments = quickInstruments;
exports.rootDir = void 0;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _teen_process = require("teen_process");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _appiumXcode = _interopRequireDefault(require("appium-xcode"));

var _lodash = _interopRequireDefault(require("lodash"));

var _instruments = _interopRequireDefault(require("./instruments"));

const rootDir = _path.default.resolve(__dirname, '../..');

exports.rootDir = rootDir;
const INST_STALL_TIMEOUT = 12000;

async function getInstrumentsPath() {
  let instrumentsPath;

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)('xcrun', ['-find', 'instruments']);
    instrumentsPath = (stdout || '').trim().replace('\n$', '');
  } catch (err) {
    if (err) {
      _logger.default.error(err.message);
    }
  }

  if (!instrumentsPath) {
    _logger.default.errorAndThrow('Could not find the instruments binary. Please ensure ' + '`xcrun -find instruments` can locate it.');
  }

  _logger.default.debug(`Instruments is at: ${instrumentsPath}`);

  return instrumentsPath;
}

async function getAvailableDevices(timeout = INST_STALL_TIMEOUT) {
  _logger.default.debug('Getting list of devices instruments supports');

  let instrumentsPath = await getInstrumentsPath();
  let opts = {
    timeout
  };
  let lines;

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)(instrumentsPath, ['-s', 'devices'], opts);
    lines = stdout.split('\n');
  } catch (err) {
    _logger.default.errorAndThrow(`Failed getting devices, err: ${err}.`);
  }

  let devices = lines.filter(line => {
    return /^.+ \(\d+\.(\d+\.)?\d+( Simulator)?\) \[.+\]( \(Simulator\))?$/.test(line);
  });

  _logger.default.debug(`Available devices: ${devices}`);

  return devices;
}

async function killAllInstruments() {
  _logger.default.debug('Killing all instruments');

  try {
    await (0, _teen_process.exec)('pkill', ['-f', 'instruments']);
  } catch (ign) {}
}

async function cleanAllTraces() {
  if (process.env.CLEAN_TRACES) {
    try {
      await _appiumSupport.fs.rimraf('instrumentscli*.trace');
    } catch (ign) {}
  }
}

function parseLaunchTimeout(launchTimeout) {
  if (_lodash.default.isString(launchTimeout)) {
    try {
      launchTimeout = JSON.parse(launchTimeout);
    } catch (err) {
      _logger.default.warn(`Invalid launch timeout: ${launchTimeout}`);
    }
  }

  if (_lodash.default.isNumber(launchTimeout)) {
    launchTimeout = {
      global: launchTimeout
    };
  }

  return launchTimeout;
}

async function getIwdPath(xcodeMajorVersion) {
  let thirdpartyPath = _path.default.resolve(rootDir, '..', 'instruments-iwd');

  let iwdPath = _path.default.resolve(thirdpartyPath, `iwd${xcodeMajorVersion}`);

  if (!(await _appiumSupport.fs.exists(iwdPath))) {
    iwdPath = _path.default.resolve(thirdpartyPath, 'iwd');
  }

  _logger.default.debug(`Found Insruments-Without-Delay: ${iwdPath}`);

  return iwdPath;
}

async function quickLaunch(udid, appPath = _path.default.resolve(__dirname, '..', '..', 'assets', 'TestApp.app')) {
  let traceTemplatePath = await _appiumXcode.default.getAutomationTraceTemplatePath();

  let scriptPath = _path.default.resolve(__dirname, '..', '..', 'assets', 'blank_instruments_test.js');

  let traceDocument = _path.default.resolve('/', 'tmp', 'testTrace.trace');

  let resultsPath = _path.default.resolve('/', 'tmp');

  await _appiumSupport.fs.rimraf(traceDocument);
  let args = ['instruments', '-D', traceDocument, '-t', traceTemplatePath, '-w', udid, appPath, '-e', 'UIASCRIPT', scriptPath, '-e', 'UIARESULTSPATH', resultsPath];

  _logger.default.debug(`Running command: 'xcrun ${args.join(' ')}'`);

  await (0, _teen_process.exec)('xcrun', args);
}

async function quickInstruments(opts = {}) {
  opts = _lodash.default.cloneDeep(opts);
  let xcodeTraceTemplatePath = opts.xcodeTraceTemplatePath || (await _appiumXcode.default.getAutomationTraceTemplatePath());

  _lodash.default.defaults(opts, {
    launchTimeout: 60000,
    template: xcodeTraceTemplatePath,
    withoutDelay: true,
    xcodeVersion: '8.1',
    webSocket: null,
    flakeyRetries: true,
    logNoColors: false
  });

  return new _instruments.default(opts);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0cnVtZW50cy91dGlscy5qcyJdLCJuYW1lcyI6WyJyb290RGlyIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJJTlNUX1NUQUxMX1RJTUVPVVQiLCJnZXRJbnN0cnVtZW50c1BhdGgiLCJpbnN0cnVtZW50c1BhdGgiLCJzdGRvdXQiLCJ0cmltIiwicmVwbGFjZSIsImVyciIsImxvZyIsImVycm9yIiwibWVzc2FnZSIsImVycm9yQW5kVGhyb3ciLCJkZWJ1ZyIsImdldEF2YWlsYWJsZURldmljZXMiLCJ0aW1lb3V0Iiwib3B0cyIsImxpbmVzIiwic3BsaXQiLCJkZXZpY2VzIiwiZmlsdGVyIiwibGluZSIsInRlc3QiLCJraWxsQWxsSW5zdHJ1bWVudHMiLCJpZ24iLCJjbGVhbkFsbFRyYWNlcyIsInByb2Nlc3MiLCJlbnYiLCJDTEVBTl9UUkFDRVMiLCJmcyIsInJpbXJhZiIsInBhcnNlTGF1bmNoVGltZW91dCIsImxhdW5jaFRpbWVvdXQiLCJfIiwiaXNTdHJpbmciLCJKU09OIiwicGFyc2UiLCJ3YXJuIiwiaXNOdW1iZXIiLCJnbG9iYWwiLCJnZXRJd2RQYXRoIiwieGNvZGVNYWpvclZlcnNpb24iLCJ0aGlyZHBhcnR5UGF0aCIsIml3ZFBhdGgiLCJleGlzdHMiLCJxdWlja0xhdW5jaCIsInVkaWQiLCJhcHBQYXRoIiwidHJhY2VUZW1wbGF0ZVBhdGgiLCJ4Y29kZSIsImdldEF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCIsInNjcmlwdFBhdGgiLCJ0cmFjZURvY3VtZW50IiwicmVzdWx0c1BhdGgiLCJhcmdzIiwiam9pbiIsInF1aWNrSW5zdHJ1bWVudHMiLCJjbG9uZURlZXAiLCJ4Y29kZVRyYWNlVGVtcGxhdGVQYXRoIiwiZGVmYXVsdHMiLCJ0ZW1wbGF0ZSIsIndpdGhvdXREZWxheSIsInhjb2RlVmVyc2lvbiIsIndlYlNvY2tldCIsImZsYWtleVJldHJpZXMiLCJsb2dOb0NvbG9ycyIsIkluc3RydW1lbnRzIl0sIm1hcHBp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IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHhjb2RlIGZyb20gJ2FwcGl1bS14Y29kZSc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEluc3RydW1lbnRzIGZyb20gJy4vaW5zdHJ1bWVudHMnO1xuXG5cbmNvbnN0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4nKTtcbmNvbnN0IElOU1RfU1RBTExfVElNRU9VVCA9IDEyMDAwO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRJbnN0cnVtZW50c1BhdGggKCkge1xuICBsZXQgaW5zdHJ1bWVudHNQYXRoO1xuICB0cnkge1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3hjcnVuJywgWyctZmluZCcsICdpbnN0cnVtZW50cyddKTtcbiAgICBpbnN0cnVtZW50c1BhdGggPSAoc3Rkb3V0IHx8ICcnKS50cmltKCkucmVwbGFjZSgnXFxuJCcsICcnKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgbG9nLmVycm9yKGVyci5tZXNzYWdlKTtcbiAgICB9XG4gIH1cbiAgaWYgKCFpbnN0cnVtZW50c1BhdGgpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdygnQ291bGQgbm90IGZpbmQgdGhlIGluc3RydW1lbnRzIGJpbmFyeS4gUGxlYXNlIGVuc3VyZSAnICtcbiAgICAgICAgICAgICAgICAgICAgICAnYHhjcnVuIC1maW5kIGluc3RydW1lbnRzYCBjYW4gbG9jYXRlIGl0LicpO1xuICB9XG4gIGxvZy5kZWJ1ZyhgSW5zdHJ1bWVudHMgaXMgYXQ6ICR7aW5zdHJ1bWVudHNQYXRofWApO1xuICByZXR1cm4gaW5zdHJ1bWVudHNQYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBdmFpbGFibGVEZXZpY2VzICh0aW1lb3V0ID0gSU5TVF9TVEFMTF9USU1FT1VUKSB7XG4gIGxvZy5kZWJ1ZygnR2V0dGluZyBsaXN0IG9mIGRldmljZXMgaW5zdHJ1bWVudHMgc3VwcG9ydHMnKTtcbiAgbGV0IGluc3RydW1lbnRzUGF0aCA9IGF3YWl0IGdldEluc3RydW1lbnRzUGF0aCgpO1xuICBsZXQgb3B0cyA9IHt0aW1lb3V0fTtcbiAgbGV0IGxpbmVzO1xuICB0cnkge1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoaW5zdHJ1bWVudHNQYXRoLCBbJy1zJywgJ2RldmljZXMnXSwgb3B0cyk7XG4gICAgbGluZXMgPSBzdGRvdXQuc3BsaXQoJ1xcbicpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgRmFpbGVkIGdldHRpbmcgZGV2aWNlcywgZXJyOiAke2Vycn0uYCk7XG4gIH1cbiAgbGV0IGRldmljZXMgPSBsaW5lcy5maWx0ZXIoKGxpbmUpID0+IHtcbiAgICAvLyBodHRwczovL3JlZ2V4MTAxLmNvbS9yL2FFNmFTMy82XG4gICAgcmV0dXJuIC9eLisgXFwoXFxkK1xcLihcXGQrXFwuKT9cXGQrKCBTaW11bGF0b3IpP1xcKSBcXFsuK1xcXSggXFwoU2ltdWxhdG9yXFwpKT8kLy50ZXN0KGxpbmUpO1xuICB9KTtcbiAgbG9nLmRlYnVnKGBBdmFpbGFibGUgZGV2aWNlczogJHtkZXZpY2VzfWApO1xuICByZXR1cm4gZGV2aWNlcztcbn1cblxuYXN5bmMgZnVuY3Rpb24ga2lsbEFsbEluc3RydW1lbnRzICgpIHtcbiAgbG9nLmRlYnVnKCdLaWxsaW5nIGFsbCBpbnN0cnVtZW50cycpO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJ3BraWxsJywgWyctZicsICdpbnN0cnVtZW50cyddKTtcbiAgfSBjYXRjaCAoaWduKSB7fVxufVxuXG5hc3luYyBmdW5jdGlvbiBjbGVhbkFsbFRyYWNlcyAoKSB7XG4gIGlmIChwcm9jZXNzLmVudi5DTEVBTl9UUkFDRVMpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKCdpbnN0cnVtZW50c2NsaSoudHJhY2UnKTtcbiAgICB9IGNhdGNoIChpZ24pIHt9XG4gIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VMYXVuY2hUaW1lb3V0IChsYXVuY2hUaW1lb3V0KSB7XG4gIC8vIG51bWJlciBvciBvYmplY3QgbGlrZSB7IGdsb2JhbDogNDAwMDAsIGFmdGVyU2ltTGF1bmNoOiA1MDAwIH1cbiAgLy8gbWF5IGFsc28gcGFyc2UgSlNPTiBzdHJpbmdzLlxuICBpZiAoXy5pc1N0cmluZyhsYXVuY2hUaW1lb3V0KSkge1xuICAgIHRyeSB7XG4gICAgICBsYXVuY2hUaW1lb3V0ID0gSlNPTi5wYXJzZShsYXVuY2hUaW1lb3V0KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBJbnZhbGlkIGxhdW5jaCB0aW1lb3V0OiAke2xhdW5jaFRpbWVvdXR9YCk7XG4gICAgfVxuICB9XG4gIGlmIChfLmlzTnVtYmVyKGxhdW5jaFRpbWVvdXQpKSB7XG4gICAgbGF1bmNoVGltZW91dCA9IHtcbiAgICAgIGdsb2JhbDogbGF1bmNoVGltZW91dFxuICAgIH07XG4gIH1cbiAgcmV0dXJuIGxhdW5jaFRpbWVvdXQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEl3ZFBhdGggKHhjb2RlTWFqb3JWZXJzaW9uKSB7XG4gIGxldCB0aGlyZHBhcnR5UGF0aCA9IHBhdGgucmVzb2x2ZShyb290RGlyLCAnLi4nLCAnaW5zdHJ1bWVudHMtaXdkJyk7XG4gIGxldCBpd2RQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXJkcGFydHlQYXRoLCBgaXdkJHt4Y29kZU1ham9yVmVyc2lvbn1gKTtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoaXdkUGF0aCkpIHtcbiAgICBpd2RQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXJkcGFydHlQYXRoLCAnaXdkJyk7XG4gIH1cbiAgbG9nLmRlYnVnKGBGb3VuZCBJbnNydW1lbnRzLVdpdGhvdXQtRGVsYXk6ICR7aXdkUGF0aH1gKTtcbiAgcmV0dXJuIGl3ZFBhdGg7XG59XG5cbi8vIHRoaXMgZnVuY3Rpb24gbGF1bmNoZXMgYW4gaW5zdHJ1bWVudHMgdGVzdCB3aXRoIGEgZGVmYXVsdCB0ZXN0XG4vLyB0aGF0IGltbWVkaWF0ZWx5IHBhc3Nlcy4gSW4gdGhpcyB3YXkgd2UgY2FuIHN0YXJ0IGEgc2ltdWxhdG9yXG4vLyBhbmQgYmUgbm90aWZpZWQgd2hlbiBpdCBjb21wbGV0ZWx5IGxhdW5jaGVzXG5hc3luYyBmdW5jdGlvbiBxdWlja0xhdW5jaCAodWRpZCwgYXBwUGF0aCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdhc3NldHMnLCAnVGVzdEFwcC5hcHAnKSkge1xuICBsZXQgdHJhY2VUZW1wbGF0ZVBhdGggPSBhd2FpdCB4Y29kZS5nZXRBdXRvbWF0aW9uVHJhY2VUZW1wbGF0ZVBhdGgoKTtcbiAgbGV0IHNjcmlwdFBhdGggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnYXNzZXRzJywgJ2JsYW5rX2luc3RydW1lbnRzX3Rlc3QuanMnKTtcbiAgbGV0IHRyYWNlRG9jdW1lbnQgPSBwYXRoLnJlc29sdmUoJy8nLCAndG1wJywgJ3Rlc3RUcmFjZS50cmFjZScpO1xuICBsZXQgcmVzdWx0c1BhdGggPSBwYXRoLnJlc29sdmUoJy8nLCAndG1wJyk7XG5cbiAgLy8gdGhlIHRyYWNlIGRvY3VtZW50IGNhbiBiZSBpbiBhIHdlaXJkIHN0YXRlXG4gIC8vIGJ1dCB3ZSBuZXZlciBkbyBhbnl0aGluZyB3aXRoIGl0LCBzbyBkZWxldGVcbiAgYXdhaXQgZnMucmltcmFmKHRyYWNlRG9jdW1lbnQpO1xuXG4gIGxldCBhcmdzID0gW1xuICAgICdpbnN0cnVtZW50cycsXG4gICAgJy1EJywgdHJhY2VEb2N1bWVudCxcbiAgICAnLXQnLCB0cmFjZVRlbXBsYXRlUGF0aCxcbiAgICAnLXcnLCB1ZGlkLFxuICAgIGFwcFBhdGgsXG4gICAgJy1lJywgJ1VJQVNDUklQVCcsIHNjcmlwdFBhdGgsXG4gICAgJy1lJywgJ1VJQVJFU1VMVFNQQVRIJywgcmVzdWx0c1BhdGhdO1xuICBsb2cuZGVidWcoYFJ1bm5pbmcgY29tbWFuZDogJ3hjcnVuICR7YXJncy5qb2luKCcgJyl9J2ApO1xuICBhd2FpdCBleGVjKCd4Y3J1bicsIGFyZ3MpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBxdWlja0luc3RydW1lbnRzIChvcHRzID0ge30pIHtcbiAgb3B0cyA9IF8uY2xvbmVEZWVwKG9wdHMpO1xuICBsZXQgeGNvZGVUcmFjZVRlbXBsYXRlUGF0aCA9IG9wdHMueGNvZGVUcmFjZVRlbXBsYXRlUGF0aCB8fFxuICAgICAgYXdhaXQgeGNvZGUuZ2V0QXV0b21hdGlvblRyYWNlVGVtcGxhdGVQYXRoKCk7XG4gIF8uZGVmYXVsdHMob3B0cywge1xuICAgIGxhdW5jaFRpbWVvdXQ6IDYwMDAwLFxuICAgIHRlbXBsYXRlOiB4Y29kZVRyYWNlVGVtcGxhdGVQYXRoLFxuICAgIHdpdGhvdXREZWxheTogdHJ1ZSxcbiAgICB4Y29kZVZlcnNpb246ICc4LjEnLFxuICAgIHdlYlNvY2tldDogbnVsbCxcbiAgICBmbGFrZXlSZXRyaWVzOiB0cnVlLFxuICAgIGxvZ05vQ29sb3JzOiBmYWxzZSxcbiAgfSk7XG4gIHJldHVybiBuZXcgSW5zdHJ1bWVudHMob3B0cyk7XG59XG5cbmV4cG9ydCB7XG4gIHJvb3REaXIsIGtpbGxBbGxJbnN0cnVtZW50cywgY2xlYW5BbGxUcmFjZXMsIGdldEluc3RydW1lbnRzUGF0aCxcbiAgZ2V0QXZhaWxhYmxlRGV2aWNlcywgcGFyc2VMYXVuY2hUaW1lb3V0LCBnZXRJd2RQYXRoLCBxdWlja0xhdW5jaCxcbiAgcXVpY2tJbnN0cnVtZW50cyxcbn07XG4iXSwiZmlsZSI6ImxpYi9pbnN0cnVtZW50cy91dGlscy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
