"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setLocale = setLocale;
exports.setPreferences = setPreferences;
exports.setLocaleAndPreferences = setLocaleAndPreferences;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

const SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
const SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

async function launchAndQuitSimulator(sim, safari) {
  _logger.default.debug('No simulator directories found.');

  return await sim.launchAndQuit(safari);
}

function checkPreferences(settings, opts = {}) {
  for (let setting of settings) {
    if (_lodash.default.has(opts, setting)) {
      return true;
    }
  }

  return false;
}

async function setLocaleAndPreferences(sim, opts, safari = false, shutdownFn = _lodash.default.noop) {
  const localConfig = await setLocale(sim, opts, {}, safari);
  const prefsUpdated = await setPreferences(sim, opts, safari);

  if (localConfig._updated || prefsUpdated) {
    _logger.default.debug('Updated settings. Rebooting the simulator if it is already open');

    await shutdownFn(sim);
  } else {
    _logger.default.debug('Setting did not need to be updated');
  }

  delete localConfig._updated;
  return localConfig;
}

async function setLocale(sim, opts, localeConfig = {}, safari = false) {
  if (!opts.language && !opts.locale && !opts.calendarFormat) {
    _logger.default.debug('No reason to set locale');

    return {
      _updated: false
    };
  }

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, safari);
  }

  _logger.default.debug('Setting locale information');

  localeConfig = {
    language: opts.language || localeConfig.language,
    locale: opts.locale || localeConfig.locale,
    calendarFormat: opts.calendarFormat || localeConfig.calendarFormat,
    _updated: false
  };

  try {
    let updated = await sim.updateLocale(opts.language, opts.locale, opts.calendarFormat);

    if (updated) {
      localeConfig._updated = true;
    }
  } catch (e) {
    _logger.default.errorAndThrow(`Appium was unable to set locale info: ${e}`);
  }

  return localeConfig;
}

async function setPreferences(sim, opts, safari = false) {
  let needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
  let needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);

  if (!needToSetPrefs && !needToSetSafariPrefs) {
    _logger.default.debug('No iOS / app preferences to set');

    return false;
  }

  _logger.default.debug('Setting iOS and app preferences');

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, safari);
  }

  let updated = false;

  try {
    if (needToSetPrefs) {
      updated = await setLocServicesPrefs(sim, opts);
    }
  } catch (e) {
    _logger.default.error('Error setting location services preferences, prefs will not work');

    _logger.default.error(e);
  }

  try {
    if (needToSetSafariPrefs) {
      updated = (await setSafariPrefs(sim, opts)) || updated;
    }
  } catch (e) {
    _logger.default.error('Error setting safari preferences, prefs will not work');

    _logger.default.error(e);
  }

  return updated;
}

async function setLocServicesPrefs(sim, opts = {}) {
  let locServ = _lodash.default.find([opts.locationServicesEnabled, opts.locationServicesAuthorized], c => {
    return !_lodash.default.isUndefined(c);
  });

  if (!_lodash.default.isUndefined(locServ)) {
    locServ = locServ ? 1 : 0;

    _logger.default.debug(`Setting location services to ${locServ}`);

    await sim.updateSettings('locationServices', {
      LocationServicesEnabled: locServ,
      'LocationServicesEnabledIn7.0': locServ,
      'LocationServicesEnabledIn8.0': locServ
    });
  }

  if (!_lodash.default.isUndefined(opts.locationServicesAuthorized)) {
    if (!opts.bundleId) {
      let msg = "Can't set location services for app without bundle ID";

      _logger.default.errorAndThrow(msg);
    }

    let locAuth = !!opts.locationServicesAuthorized;

    if (locAuth) {
      _logger.default.debug('Authorizing location services for app');
    } else {
      _logger.default.debug('De-authorizing location services for app');
    }

    await sim.updateLocationSettings(opts.bundleId, locAuth);
  }
}

async function setSafariPrefs(sim, opts = {}) {
  let safariSettings = {};

  if (_lodash.default.has(opts, 'safariAllowPopups')) {
    const val = !!opts.safariAllowPopups;

    _logger.default.debug(`Setting javascript window opening to '${val}'`);

    safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
    safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
  }

  if (_lodash.default.has(opts, 'safariIgnoreFraudWarning')) {
    const val = !opts.safariIgnoreFraudWarning;

    _logger.default.debug(`Setting fraudulent website warning to '${val}'`);

    safariSettings.WarnAboutFraudulentWebsites = val;
  }

  if (_lodash.default.has(opts, 'safariOpenLinksInBackground')) {
    const val = opts.safariOpenLinksInBackground ? 1 : 0;

    _logger.default.debug(`Setting opening links in background to '${!!val}'`);

    safariSettings.OpenLinksInBackground = val;
  }

  return _lodash.default.size(safariSettings) > 0 ? await sim.updateSafariSettings(safariSettings) : false;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXR0aW5ncy5qcyJdLCJuYW1lcyI6WyJTRVRUSU5HU19DQVBTIiwiU0FGQVJJX1NFVFRJTkdTX0NBUFMiLCJsYXVuY2hBbmRRdWl0U2ltdWxhdG9yIiwic2ltIiwic2FmYXJpIiwibG9nZ2VyIiwiZGVidWciLCJsYXVuY2hBbmRRdWl0IiwiY2hlY2tQcmVmZXJlbmNlcyIsInNldHRpbmdzIiwib3B0cyIsInNldHRpbmciLCJfIiwiaGFzIiwic2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMiLCJzaHV0ZG93bkZuIiwibm9vcCIsImxvY2FsQ29uZmlnIiwic2V0TG9jYWxlIiwicHJlZnNVcGRhdGVkIiwic2V0UHJlZmVyZW5jZXMiLCJfdXBkYXRlZCIsImxvY2FsZUNvbmZpZyIsImxhbmd1YWdlIiwibG9jYWxlIiwiY2FsZW5kYXJGb3JtYXQiLCJpc0ZyZXNoIiwidXBkYXRlZCIsInVwZGF0ZUxvY2FsZSIsImUiLCJlcnJvckFuZFRocm93IiwibmVlZFRvU2V0UHJlZnMiLCJuZWVkVG9TZXRTYWZhcmlQcmVmcyIsInNldExvY1NlcnZpY2VzUHJlZnMiLCJlcnJvciIsInNldFNhZmFyaVByZWZzIiwibG9jU2VydiIsImZpbmQiLCJsb2NhdGlvblNlcnZpY2VzRW5hYmxlZCIsImxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkIiwiYyIsImlzVW5kZWZpbmVkIiwidXBkYXRlU2V0dGluZ3MiLCJMb2NhdGlvblNlcnZpY2VzRW5hYmxlZCIsImJ1bmRsZUlkIiwibXNnIiwibG9jQXV0aCIsInVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MiLCJzYWZhcmlTZXR0aW5ncyIsInZhbCIsInNhZmFyaUFsbG93UG9wdXBzIiwiV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSIsIkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkiLCJzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmciLCJXYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMiLCJzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQiLCJPcGVuTGlua3NJbkJhY2tncm91bmQiLCJzaXplIiwidXBkYXRlU2FmYXJpU2V0dGluZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFHQSxNQUFNQSxhQUFhLEdBQUcsQ0FDcEIseUJBRG9CLEVBRXBCLDRCQUZvQixDQUF0QjtBQUlBLE1BQU1DLG9CQUFvQixHQUFHLENBQzNCLG1CQUQyQixFQUUzQiwwQkFGMkIsRUFHM0IsNkJBSDJCLENBQTdCOztBQU1BLGVBQWVDLHNCQUFmLENBQXVDQyxHQUF2QyxFQUE0Q0MsTUFBNUMsRUFBb0Q7QUFDbERDLGtCQUFPQyxLQUFQLENBQWEsaUNBQWI7O0FBQ0EsU0FBTyxNQUFNSCxHQUFHLENBQUNJLGFBQUosQ0FBa0JILE1BQWxCLENBQWI7QUFDRDs7QUFFRCxTQUFTSSxnQkFBVCxDQUEyQkMsUUFBM0IsRUFBcUNDLElBQUksR0FBRyxFQUE1QyxFQUFnRDtBQUM5QyxPQUFLLElBQUlDLE9BQVQsSUFBb0JGLFFBQXBCLEVBQThCO0FBQzVCLFFBQUlHLGdCQUFFQyxHQUFGLENBQU1ILElBQU4sRUFBWUMsT0FBWixDQUFKLEVBQTBCO0FBQ3hCLGFBQU8sSUFBUDtBQUNEO0FBQ0Y7O0FBQ0QsU0FBTyxLQUFQO0FBQ0Q7O0FBRUQsZUFBZUcsdUJBQWYsQ0FBd0NYLEdBQXhDLEVBQTZDTyxJQUE3QyxFQUFtRE4sTUFBTSxHQUFHLEtBQTVELEVBQW1FVyxVQUFVLEdBQUdILGdCQUFFSSxJQUFsRixFQUF3RjtBQUN0RixRQUFNQyxXQUFXLEdBQUcsTUFBTUMsU0FBUyxDQUFDZixHQUFELEVBQU1PLElBQU4sRUFBWSxFQUFaLEVBQWdCTixNQUFoQixDQUFuQztBQUNBLFFBQU1lLFlBQVksR0FBRyxNQUFNQyxjQUFjLENBQUNqQixHQUFELEVBQU1PLElBQU4sRUFBWU4sTUFBWixDQUF6Qzs7QUFDQSxNQUFJYSxXQUFXLENBQUNJLFFBQVosSUFBd0JGLFlBQTVCLEVBQTBDO0FBQ3hDZCxv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QUNBbEQsb0JBQU9DLEtBQVAsQ0FBYywyQ0FBMEMsQ0FBQyxDQUFDMkMsR0FBSSxHQUE5RDs7QUFDQUQsSUFBQUEsY0FBYyxDQUFDUSxxQkFBZixHQUF1Q1AsR0FBdkM7QUFDRDs7QUFDRCxTQUFRckMsZ0JBQUU2QyxJQUFGLENBQU9ULGNBQVAsSUFBeUIsQ0FBMUIsR0FDSCxNQUFNN0MsR0FBRyxDQUFDdUQsb0JBQUosQ0FBeUJWLGNBQXpCLENBREgsR0FFSCxLQUZKO0FBR0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5cblxuY29uc3QgU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ2xvY2F0aW9uU2VydmljZXNFbmFibGVkJyxcbiAgJ2xvY2F0aW9uU2VydmljZXNBdXRob3JpemVkJyxcbl07XG5jb25zdCBTQUZBUklfU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ3NhZmFyaUFsbG93UG9wdXBzJyxcbiAgJ3NhZmFyaUlnbm9yZUZyYXVkV2FybmluZycsXG4gICdzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQnLFxuXTtcblxuYXN5bmMgZnVuY3Rpb24gbGF1bmNoQW5kUXVpdFNpbXVsYXRvciAoc2ltLCBzYWZhcmkpIHtcbiAgbG9nZ2VyLmRlYnVnKCdObyBzaW11bGF0b3IgZGlyZWN0b3JpZXMgZm91bmQuJyk7XG4gIHJldHVybiBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdChzYWZhcmkpO1xufVxuXG5mdW5jdGlvbiBjaGVja1ByZWZlcmVuY2VzIChzZXR0aW5ncywgb3B0cyA9IHt9KSB7XG4gIGZvciAobGV0IHNldHRpbmcgb2Ygc2V0dGluZ3MpIHtcbiAgICBpZiAoXy5oYXMob3B0cywgc2V0dGluZykpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldExvY2FsZUFuZFByZWZlcmVuY2VzIChzaW0sIG9wdHMsIHNhZmFyaSA9IGZhbHNlLCBzaHV0ZG93bkZuID0gXy5ub29wKSB7XG4gIGNvbnN0IGxvY2FsQ29uZmlnID0gYXdhaXQgc2V0TG9jYWxlKHNpbSwgb3B0cywge30sIHNhZmFyaSk7XG4gIGNvbnN0IHByZWZzVXBkYXRlZCA9IGF3YWl0IHNldFByZWZlcmVuY2VzKHNpbSwgb3B0cywgc2FmYXJpKTtcbiAgaWYgKGxvY2FsQ29uZmlnLl91cGRhdGVkIHx8IHByZWZzVXBkYXRlZCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnVXBkYXRlZCBzZXR0aW5ncy4gUmVib290aW5nIHRoZSBzaW11bGF0b3IgaWYgaXQgaXMgYWxyZWFkeSBvcGVuJyk7XG4gICAgYXdhaXQgc2h1dGRvd25GbihzaW0pO1xuICB9IGVsc2Uge1xuICAgIGxvZ2dlci5kZWJ1ZygnU2V0dGluZyBkaWQgbm90IG5lZWQgdG8gYmUgdXBkYXRlZCcpO1xuICB9XG4gIGRlbGV0ZSBsb2NhbENvbmZpZy5fdXBkYXRlZDtcbiAgcmV0dXJuIGxvY2FsQ29uZmlnO1xufVxuXG4vLyBwYXNzIGluIHRoZSBzaW11bGF0b3Igc28gdGhhdCBvdGhlciBzeXN0ZW1zIHRoYXQgdXNlIHRoZSBmdW5jdGlvbiBjYW4gc3VwcGx5XG4vLyB3aGF0ZXZlciB0aGV5IGhhdmVcbmFzeW5jIGZ1bmN0aW9uIHNldExvY2FsZSAoc2ltLCBvcHRzLCBsb2NhbGVDb25maWcgPSB7fSwgc2FmYXJpID0gZmFsc2UpIHtcbiAgaWYgKCFvcHRzLmxhbmd1YWdlICYmICFvcHRzLmxvY2FsZSAmJiAhb3B0cy5jYWxlbmRhckZvcm1hdCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnTm8gcmVhc29uIHRvIHNldCBsb2NhbGUnKTtcbiAgICByZXR1cm4ge1xuICAgICAgX3VwZGF0ZWQ6IGZhbHNlLFxuICAgIH07XG4gIH1cblxuICAvLyB3ZSBuZWVkIHRoZSBzaW11bGF0b3IgdG8gaGF2ZSBpdHMgZGlyZWN0b3JpZXMgaW4gcGxhY2VcbiAgaWYgKGF3YWl0IHNpbS5pc0ZyZXNoKCkpIHtcbiAgICBhd2FpdCBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yKHNpbSwgc2FmYXJpKTtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZygnU2V0dGluZyBsb2NhbGUgaW5mb3JtYXRpb24nKTtcbiAgbG9jYWxlQ29uZmlnID0ge1xuICAgIGxhbmd1YWdlOiBvcHRzLmxhbmd1YWdlIHx8IGxvY2FsZUNvbmZpZy5sYW5ndWFnZSxcbiAgICBsb2NhbGU6IG9wdHMubG9jYWxlIHx8IGxvY2FsZUNvbmZpZy5sb2NhbGUsXG4gICAgY2FsZW5kYXJGb3JtYXQ6IG9wdHMuY2FsZW5kYXJGb3JtYXQgfHwgbG9jYWxlQ29uZmlnLmNhbGVuZGFyRm9ybWF0LFxuICAgIF91cGRhdGVkOiBmYWxzZSxcbiAgfTtcblxuICB0cnkge1xuICAgIGxldCB1cGRhdGVkID0gYXdhaXQgc2ltLnVwZGF0ZUxvY2FsZShvcHRzLmxhbmd1YWdlLCBvcHRzLmxvY2FsZSwgb3B0cy5jYWxlbmRhckZvcm1hdCk7XG4gICAgaWYgKHVwZGF0ZWQpIHtcbiAgICAgIGxvY2FsZUNvbmZpZy5fdXBkYXRlZCA9IHRydWU7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYEFwcGl1bSB3YXMgdW5hYmxlIHRvIHNldCBsb2NhbGUgaW5mbzogJHtlfWApO1xuICB9XG5cbiAgcmV0dXJuIGxvY2FsZUNvbmZpZztcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0UHJlZmVyZW5jZXMgKHNpbSwgb3B0cywgc2FmYXJpID0gZmFsc2UpIHtcbiAgbGV0IG5lZWRUb1NldFByZWZzID0gY2hlY2tQcmVmZXJlbmNlcyhTRVRUSU5HU19DQVBTLCBvcHRzKTtcbiAgbGV0IG5lZWRUb1NldFNhZmFyaVByZWZzID0gY2hlY2tQcmVmZXJlbmNlcyhTQUZBUklfU0VUVElOR1NfQ0FQUywgb3B0cyk7XG4gIGlmICghbmVlZFRvU2V0UHJlZnMgJiYgIW5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdObyBpT1MgLyBhcHAgcHJlZmVyZW5jZXMgdG8gc2V0Jyk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKCdTZXR0aW5nIGlPUyBhbmQgYXBwIHByZWZlcmVuY2VzJyk7XG5cbiAgaWYgKGF3YWl0IHNpbS5pc0ZyZXNoKCkpIHtcbiAgICBhd2FpdCBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yKHNpbSwgc2FmYXJpKTtcbiAgfVxuXG4gIGxldCB1cGRhdGVkID0gZmFsc2U7XG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFByZWZzKSB7XG4gICAgICB1cGRhdGVkID0gYXdhaXQgc2V0TG9jU2VydmljZXNQcmVmcyhzaW0sIG9wdHMpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5lcnJvcignRXJyb3Igc2V0dGluZyBsb2NhdGlvbiBzZXJ2aWNlcyBwcmVmZXJlbmNlcywgcHJlZnMgd2lsbCBub3Qgd29yaycpO1xuICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgICB1cGRhdGVkID0gYXdhaXQgc2V0U2FmYXJpUHJlZnMoc2ltLCBvcHRzKSB8fCB1cGRhdGVkO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5lcnJvcignRXJyb3Igc2V0dGluZyBzYWZhcmkgcHJlZmVyZW5jZXMsIHByZWZzIHdpbGwgbm90IHdvcmsnKTtcbiAgICBsb2dnZXIuZXJyb3IoZSk7XG4gIH1cblxuICByZXR1cm4gdXBkYXRlZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0TG9jU2VydmljZXNQcmVmcyAoc2ltLCBvcHRzID0ge30pIHtcbiAgbGV0IGxvY1NlcnYgPSBfLmZpbmQoW29wdHMubG9jYXRpb25TZXJ2aWNlc0VuYWJsZWQsIG9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWRdLCAoYykgPT4ge1xuICAgIHJldHVybiAhXy5pc1VuZGVmaW5lZChjKTtcbiAgfSk7XG4gIGlmICghXy5pc1VuZGVmaW5lZChsb2NTZXJ2KSkge1xuICAgIGxvY1NlcnYgPSBsb2NTZXJ2ID8gMSA6IDA7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIGxvY2F0aW9uIHNlcnZpY2VzIHRvICR7bG9jU2Vydn1gKTtcbiAgICBhd2FpdCBzaW0udXBkYXRlU2V0dGluZ3MoJ2xvY2F0aW9uU2VydmljZXMnLCB7XG4gICAgICBMb2NhdGlvblNlcnZpY2VzRW5hYmxlZDogbG9jU2VydixcbiAgICAgICdMb2NhdGlvblNlcnZpY2VzRW5hYmxlZEluNy4wJzogbG9jU2VydixcbiAgICAgICdMb2NhdGlvblNlcnZpY2VzRW5hYmxlZEluOC4wJzogbG9jU2VydlxuICAgIH0pO1xuICB9XG4gIGlmICghXy5pc1VuZGVmaW5lZChvcHRzLmxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkKSkge1xuICAgIGlmICghb3B0cy5idW5kbGVJZCkge1xuICAgICAgbGV0IG1zZyA9IFwiQ2FuJ3Qgc2V0IGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHAgd2l0aG91dCBidW5kbGUgSURcIjtcbiAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgfVxuICAgIGxldCBsb2NBdXRoID0gISFvcHRzLmxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkO1xuICAgIGlmIChsb2NBdXRoKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0F1dGhvcml6aW5nIGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHAnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdEZS1hdXRob3JpemluZyBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwJyk7XG4gICAgfVxuICAgIGF3YWl0IHNpbS51cGRhdGVMb2NhdGlvblNldHRpbmdzKG9wdHMuYnVuZGxlSWQsIGxvY0F1dGgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFNhZmFyaVByZWZzIChzaW0sIG9wdHMgPSB7fSkge1xuICBsZXQgc2FmYXJpU2V0dGluZ3MgPSB7fTtcblxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaUFsbG93UG9wdXBzJykpIHtcbiAgICBjb25zdCB2YWwgPSAhIW9wdHMuc2FmYXJpQWxsb3dQb3B1cHM7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIGphdmFzY3JpcHQgd2luZG93IG9wZW5pbmcgdG8gJyR7dmFsfSdgKTtcbiAgICBzYWZhcmlTZXR0aW5ncy5XZWJLaXRKYXZhU2NyaXB0Q2FuT3BlbldpbmRvd3NBdXRvbWF0aWNhbGx5ID0gdmFsO1xuICAgIHNhZmFyaVNldHRpbmdzLkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkgPSB2YWw7XG4gIH1cbiAgaWYgKF8uaGFzKG9wdHMsICdzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmcnKSkge1xuICAgIGNvbnN0IHZhbCA9ICFvcHRzLnNhZmFyaUlnbm9yZUZyYXVkV2FybmluZztcbiAgICBsb2dnZXIuZGVidWcoYFNldHRpbmcgZnJhdWR1bGVudCB3ZWJzaXRlIHdhcm5pbmcgdG8gJyR7dmFsfSdgKTtcbiAgICBzYWZhcmlTZXR0aW5ncy5XYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMgPSB2YWw7XG4gIH1cbiAgaWYgKF8uaGFzKG9wdHMsICdzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQnKSkge1xuICAgIGNvbnN0IHZhbCA9IG9wdHMuc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kID8gMSA6IDA7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIG9wZW5pbmcgbGlua3MgaW4gYmFja2dyb3VuZCB0byAnJHshIXZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuT3BlbkxpbmtzSW5CYWNrZ3JvdW5kID0gdmFsO1xuICB9XG4gIHJldHVybiAoXy5zaXplKHNhZmFyaVNldHRpbmdzKSA+IDApXG4gICAgPyBhd2FpdCBzaW0udXBkYXRlU2FmYXJpU2V0dGluZ3Moc2FmYXJpU2V0dGluZ3MpXG4gICAgOiBmYWxzZTtcbn1cblxuZXhwb3J0IHsgc2V0TG9jYWxlLCBzZXRQcmVmZXJlbmNlcywgc2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMgfTtcbiJdLCJmaWxlIjoibGliL3NldHRpbmdzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
