"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.runSimulatorReset = runSimulatorReset;
exports.isolateSimulatorDevice = isolateSimulatorDevice;
exports.checkSimulatorAvailable = checkSimulatorAvailable;
exports.moveBuiltInApp = moveBuiltInApp;
exports.getAdjustedDeviceName = getAdjustedDeviceName;
exports.endSimulator = endSimulator;
exports.runRealDeviceReset = runRealDeviceReset;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumIosSimulator = require("appium-ios-simulator");

var _path = _interopRequireDefault(require("path"));

var utils = _interopRequireWildcard(require("./utils"));

var _logger = _interopRequireDefault(require("./logger"));

async function checkSimulatorAvailable(opts, sdkVersion, availableDevices) {
  if (sdkVersion < 7.1) {
    _logger.default.debug('Instruments v < 7.1, not checking device string support');

    return;
  }

  _logger.default.debug('Checking whether our device string is supported');

  let dString = await getAdjustedDeviceName(opts);

  let noDevicesError = function () {
    let msg = `Could not find a device to launch. You requested ` + `'${dString}', but the available devices were: ` + JSON.stringify(availableDevices);

    _logger.default.errorAndThrow(msg);
  };

  if (sdkVersion >= 8) {
    let sim = utils.getSimForDeviceString(dString, availableDevices);

    if (sim[0] === null || sim[1] === null) {
      noDevicesError();
    }

    _logger.default.debug(`iOS sim UDID is ${sim[1]}`);

    return sim[1];
  } else if (!_lodash.default.includes(availableDevices, dString)) {
    noDevicesError();
  }
}

async function getAdjustedDeviceName(opts) {
  opts._adjustedDeviceName = opts._adjustedDeviceName || (await (0, _appiumIosSimulator.getDeviceString)(opts));
  return opts._adjustedDeviceName;
}

async function moveBuiltInApp() {}

async function runSimulatorReset(sim, opts, keepApp) {
  if (!opts.reset && !opts.fullReset) {
    _logger.default.debug('Reset not set, not ending sim');

    return;
  }

  _logger.default.debug('Running ios sim reset flow');

  await endSimulator(sim);

  if (opts.fullReset) {
    _logger.default.debug('Full reset is on, so erasing simulator');

    await fullResetSimulator(sim);
  } else if (opts.reset) {
    await resetSimulator(sim, opts, keepApp);
  }
}

async function fullResetSimulator(sim) {
  _logger.default.debug('Cleaning the simulator');

  if (sim) {
    await sim.clean();
  }
}

async function resetSimulator(sim, opts, keepApp) {
  if (!sim) return;

  _logger.default.debug('Cleaning sim state.');

  try {
    await clearAppData(sim, opts, keepApp);
  } catch (err) {
    _logger.default.warn(err);

    _logger.default.warn('Could not reset simulator. Leaving as is.');
  }
}

async function endSimulator(sim) {
  if (!sim) return;

  _logger.default.debug('Killing the simulator');

  await sim.shutdown();
}

async function isolateSimulatorDevice(sim, opts, sdkVersion) {
  if (opts.isolateSimDevice && sdkVersion >= 8) {
    await sim.isolateSim();
  }
}

async function clearAppData(sim, opts, keepApp) {
  if (!keepApp && opts.app && opts.bundleId) {
    await sim.cleanCustomApp(_path.default.basename(opts.app), opts.bundleId);
  }
}

async function resetRealDevice(device, opts) {
  if (opts.bundleId && opts.fullReset) {
    let bundleId = opts.bundleId;

    _logger.default.debug(`Full reset requested. Will try to uninstall the app '${bundleId}'.`);

    if (!(await device.isInstalled(bundleId))) {
      _logger.default.debug('App not installed. No need to uninstall');

      return;
    }

    try {
      await device.remove(bundleId);
    } catch (err) {
      _logger.default.error(`Could not remove '${bundleId}' from device`);

      throw err;
    }

    _logger.default.debug(`Removed ${bundleId}`);
  }
}

async function runRealDeviceReset(device, opts) {
  if (opts.reset || opts.fullReset) {
    _logger.default.debug('Running ios real device reset flow');

    if (opts.reset) {
      await resetRealDevice(device, opts);
    }
  } else {
    _logger.default.debug('Reset not set, continuing');
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UuanMiXSwibmFtZXMiOlsiY2hlY2tTaW11bGF0b3JBdmFpbGFibGUiLCJvcHRzIiwic2RrVmVyc2lvbiIsImF2YWlsYWJsZURldmljZXMiLCJsb2dnZXIiLCJkZWJ1ZyIsImRTdHJpbmciLCJnZXRBZGp1c3RlZERldmljZU5hbWUiLCJub0RldmljZXNFcnJvciIsIm1zZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnJvckFuZFRocm93Iiwic2ltIiwidXRpbHMiLCJnZXRTaW1Gb3JEZXZpY2VTdHJpbmciLCJfIiwiaW5jbHVkZXMiLCJfYWRqdXN0ZWREZXZpY2VOYW1lIiwibW92ZUJ1aWx0SW5BcHAiLCJydW5TaW11bGF0b3JSZXNldCIsImtlZXBBcHAiLCJyZXNldCIsImZ1bGxSZXNldCIsImVuZFNpbXVsYXRvciIsImZ1bGxSZXNldFNpbXVsYXRvciIsInJlc2V0U2ltdWxhdG9yIiwiY2xlYW4iLCJjbGVhckFwcERhdGEiLCJlcnIiLCJ3YXJuIiwic2h1dGRvd24iLCJpc29sYXRlU2ltdWxhdG9yRGV2aWNlIiwiaXNvbGF0ZVNpbURldmljZSIsImlzb2xhdGVTaW0iLCJhcHAiLCJidW5kbGVJZCIsImNsZWFuQ3VzdG9tQXBwIiwicGF0aCIsImJhc2VuYW1lIiwicmVzZXRSZWFsRGV2aWNlIiwiZGV2aWNlIiwiaXNJbnN0YWxsZWQiLCJyZW1vdmUiLCJlcnJvciIsInJ1blJlYWxEZXZpY2VSZXNldCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLGVBQWVBLHVCQUFmLENBQXdDQyxJQUF4QyxFQUE4Q0MsVUFBOUMsRUFBMERDLGdCQUExRCxFQUE0RTtBQUMxRSxNQUFJRCxVQUFVLEdBQUcsR0FBakIsRUFBc0I7QUFDcEJFLG9CQUFPQyxLQUFQLENBQWEseURBQWI7O0FBQ0E7QUFDRDs7QUFFREQsa0JBQU9DLEtBQVAsQ0FBYSxpREFBYjs7QUFFQSxNQUFJQyxPQUFP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RHpCLG9CQUFPQyxLQUFQLENBQWMsV0FBVStCLFFBQVMsRUFBakM7QUFDRDtBQUNGOztBQUVELGVBQWVTLGtCQUFmLENBQW1DSixNQUFuQyxFQUEyQ3hDLElBQTNDLEVBQWlEO0FBQy9DLE1BQUlBLElBQUksQ0FBQ3FCLEtBQUwsSUFBY3JCLElBQUksQ0FBQ3NCLFNBQXZCLEVBQWtDO0FBQ2hDbkIsb0JBQU9DLEtBQVAsQ0FBYSxvQ0FBYjs7QUFDQSxRQUFJSixJQUFJLENBQUNxQixLQUFULEVBQWdCO0FBQ2QsWUFBTWtCLGVBQWUsQ0FBQ0MsTUFBRCxFQUFTeEMsSUFBVCxDQUFyQjtBQUNEO0FBQ0YsR0FMRCxNQUtPO0FBQ0xHLG9CQUFPQyxLQUFQLENBQWEsMkJBQWI7QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGdldERldmljZVN0cmluZyB9IGZyb20gJ2FwcGl1bS1pb3Mtc2ltdWxhdG9yJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcblxuXG5hc3luYyBmdW5jdGlvbiBjaGVja1NpbXVsYXRvckF2YWlsYWJsZSAob3B0cywgc2RrVmVyc2lvbiwgYXZhaWxhYmxlRGV2aWNlcykge1xuICBpZiAoc2RrVmVyc2lvbiA8IDcuMSkge1xuICAgIGxvZ2dlci5kZWJ1ZygnSW5zdHJ1bWVudHMgdiA8IDcuMSwgbm90IGNoZWNraW5nIGRldmljZSBzdHJpbmcgc3VwcG9ydCcpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZygnQ2hlY2tpbmcgd2hldGhlciBvdXIgZGV2aWNlIHN0cmluZyBpcyBzdXBwb3J0ZWQnKTtcblxuICBsZXQgZFN0cmluZyA9IGF3YWl0IGdldEFkanVzdGVkRGV2aWNlTmFtZShvcHRzKTtcbiAgbGV0IG5vRGV2aWNlc0Vycm9yID0gZnVuY3Rpb24gKCkge1xuICAgIGxldCBtc2cgPSBgQ291bGQgbm90IGZpbmQgYSBkZXZpY2UgdG8gbGF1bmNoLiBZb3UgcmVxdWVzdGVkIGAgK1xuICAgICAgICAgICAgICBgJyR7ZFN0cmluZ30nLCBidXQgdGhlIGF2YWlsYWJsZSBkZXZpY2VzIHdlcmU6IGAgK1xuICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShhdmFpbGFibGVEZXZpY2VzKTtcbiAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICB9O1xuICBpZiAoc2RrVmVyc2lvbiA+PSA4KSB7XG4gICAgbGV0IHNpbSA9IHV0aWxzLmdldFNpbUZvckRldmljZVN0cmluZyhkU3RyaW5nLCBhdmFpbGFibGVEZXZpY2VzKTtcbiAgICBpZiAoc2ltWzBdID09PSBudWxsIHx8IHNpbVsxXSA9PT0gbnVsbCkge1xuICAgICAgbm9EZXZpY2VzRXJyb3IoKTtcbiAgICB9XG4gICAgbG9nZ2VyLmRlYnVnKGBpT1Mgc2ltIFVESUQgaXMgJHtzaW1bMV19YCk7XG4gICAgcmV0dXJuIHNpbVsxXTtcbiAgfSBlbHNlIGlmICghXy5pbmNsdWRlcyhhdmFpbGFibGVEZXZpY2VzLCBkU3RyaW5nKSkge1xuICAgIG5vRGV2aWNlc0Vycm9yKCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QWRqdXN0ZWREZXZpY2VOYW1lIChvcHRzKSB7XG4gIG9wdHMuX2FkanVzdGVkRGV2aWNlTmFtZSA9IG9wdHMuX2FkanVzdGVkRGV2aWNlTmFtZSB8fCBhd2FpdCBnZXREZXZpY2VTdHJpbmcob3B0cyk7XG4gIHJldHVybiBvcHRzLl9hZGp1c3RlZERldmljZU5hbWU7XG59XG5cbi8vIFRPRE86IHdoYXQgdG8gZG8gd2l0aCB0aGlzP1xuYXN5bmMgZnVuY3Rpb24gbW92ZUJ1aWx0SW5BcHAgKC8qc2ltKi8pIHtcbiAgLy8gY2FsbCBzaW0gZnVuY3Rpb24gb25jZSBpdCBpcyBpbiBwbGFjZVxufVxuXG5hc3luYyBmdW5jdGlvbiBydW5TaW11bGF0b3JSZXNldCAoc2ltLCBvcHRzLCBrZWVwQXBwKSB7XG4gIGlmICghb3B0cy5yZXNldCAmJiAhb3B0cy5mdWxsUmVzZXQpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1Jlc2V0IG5vdCBzZXQsIG5vdCBlbmRpbmcgc2ltJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKCdSdW5uaW5nIGlvcyBzaW0gcmVzZXQgZmxvdycpO1xuXG4gIC8vIFRoZSBzaW11bGF0b3IgcHJvY2VzcyBtdXN0IGJlIGVuZGVkIGJlZm9yZSB3ZSBkZWxldGUgYXBwbGljYXRpb25zLlxuICBhd2FpdCBlbmRTaW11bGF0b3Ioc2ltKTtcblxuICBpZiAob3B0cy5mdWxsUmVzZXQpIHtcbiAgICBsb2dnZXIuZGVidWcoJ0Z1bGwgcmVzZXQgaXMgb24sIHNvIGVyYXNpbmcgc2ltdWxhdG9yJyk7XG4gICAgYXdhaXQgZnVsbFJlc2V0U2ltdWxhdG9yKHNpbSk7XG4gIH0gZWxzZSBpZiAob3B0cy5yZXNldCkge1xuICAgIGF3YWl0IHJlc2V0U2ltdWxhdG9yKHNpbSwgb3B0cywga2VlcEFwcCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZnVsbFJlc2V0U2ltdWxhdG9yIChzaW0pIHtcbiAgbG9nZ2VyLmRlYnVnKCdDbGVhbmluZyB0aGUgc2ltdWxhdG9yJyk7XG4gIGlmIChzaW0pIHtcbiAgICBhd2FpdCBzaW0uY2xlYW4oKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiByZXNldFNpbXVsYXRvciAoc2ltLCBvcHRzLCBrZWVwQXBwKSB7XG4gIGlmICghc2ltKSByZXR1cm47IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICBsb2dnZXIuZGVidWcoJ0NsZWFuaW5nIHNpbSBzdGF0ZS4nKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBjbGVhckFwcERhdGEoc2ltLCBvcHRzLCBrZWVwQXBwKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLndhcm4oZXJyKTtcbiAgICBsb2dnZXIud2FybignQ291bGQgbm90IHJlc2V0IHNpbXVsYXRvci4gTGVhdmluZyBhcyBpcy4nKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBlbmRTaW11bGF0b3IgKHNpbSkge1xuICBpZiAoIXNpbSkgcmV0dXJuOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG5cbiAgbG9nZ2VyLmRlYnVnKCdLaWxsaW5nIHRoZSBzaW11bGF0b3InKTtcbiAgYXdhaXQgc2ltLnNodXRkb3duKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGlzb2xhdGVTaW11bGF0b3JEZXZpY2UgKHNpbSwgb3B0cywgc2RrVmVyc2lvbikge1xuICBpZiAob3B0cy5pc29sYXRlU2ltRGV2aWNlICYmIHNka1ZlcnNpb24gPj0gOCkge1xuICAgIGF3YWl0IHNpbS5pc29sYXRlU2ltKCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY2xlYXJBcHBEYXRhIChzaW0sIG9wdHMsIGtlZXBBcHApIHtcbiAgaWYgKCFrZWVwQXBwICYmIG9wdHMuYXBwICYmIG9wdHMuYnVuZGxlSWQpIHtcbiAgICBhd2FpdCBzaW0uY2xlYW5DdXN0b21BcHAocGF0aC5iYXNlbmFtZShvcHRzLmFwcCksIG9wdHMuYnVuZGxlSWQpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlc2V0UmVhbERldmljZSAoZGV2aWNlLCBvcHRzKSB7XG4gIGlmIChvcHRzLmJ1bmRsZUlkICYmIG9wdHMuZnVsbFJlc2V0KSB7XG4gICAgbGV0IGJ1bmRsZUlkID0gb3B0cy5idW5kbGVJZDtcbiAgICBsb2dnZXIuZGVidWcoYEZ1bGwgcmVzZXQgcmVxdWVzdGVkLiBXaWxsIHRyeSB0byB1bmluc3RhbGwgdGhlIGFwcCAnJHtidW5kbGVJZH0nLmApO1xuICAgIGlmICghYXdhaXQgZGV2aWNlLmlzSW5zdGFsbGVkKGJ1bmRsZUlkKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdBcHAgbm90IGluc3RhbGxlZC4gTm8gbmVlZCB0byB1bmluc3RhbGwnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGRldmljZS5yZW1vdmUoYnVuZGxlSWQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmVycm9yKGBDb3VsZCBub3QgcmVtb3ZlICcke2J1bmRsZUlkfScgZnJvbSBkZXZpY2VgKTtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gICAgbG9nZ2VyLmRlYnVnKGBSZW1vdmVkICR7YnVuZGxlSWR9YCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcnVuUmVhbERldmljZVJlc2V0IChkZXZpY2UsIG9wdHMpIHtcbiAgaWYgKG9wdHMucmVzZXQgfHwgb3B0cy5mdWxsUmVzZXQpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1J1bm5pbmcgaW9zIHJlYWwgZGV2aWNlIHJlc2V0IGZsb3cnKTtcbiAgICBpZiAob3B0cy5yZXNldCkge1xuICAgICAgYXdhaXQgcmVzZXRSZWFsRGV2aWNlKGRldmljZSwgb3B0cyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZ2dlci5kZWJ1ZygnUmVzZXQgbm90IHNldCwgY29udGludWluZycpO1xuICB9XG59XG5cblxuZXhwb3J0IHtcbiAgcnVuU2ltdWxhdG9yUmVzZXQsIGlzb2xhdGVTaW11bGF0b3JEZXZpY2UsIGNoZWNrU2ltdWxhdG9yQXZhaWxhYmxlLFxuICBtb3ZlQnVpbHRJbkFwcCwgZ2V0QWRqdXN0ZWREZXZpY2VOYW1lLCBlbmRTaW11bGF0b3IsIHJ1blJlYWxEZXZpY2VSZXNldCxcbn07XG4iXSwiZmlsZSI6ImxpYi9kZXZpY2UuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
