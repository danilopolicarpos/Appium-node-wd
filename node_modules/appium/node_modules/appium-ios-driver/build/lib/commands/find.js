"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _appiumBaseDriver = require("appium-base-driver");

var _lodash = _interopRequireDefault(require("lodash"));

var _js2xmlparser = _interopRequireDefault(require("js2xmlparser2"));

var _xmldom = _interopRequireDefault(require("xmldom"));

var _xpath = _interopRequireDefault(require("xpath"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _utils = require("../utils");

const MAGIC_FIRST_VIS_CHILD_SEL = /\/\*\[@firstVisible ?= ?('|")true\1\]/;
const MAGIC_SCROLLABLE_SEL = /\/\/\*\[@scrollable ?= ?('|")true\1\]/;
let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

helpers.findElOrEls = async function findElOrEls(strategy, selector, mult, context) {
  context = (0, _utils.unwrapEl)(context);

  if (this.isWebContext()) {
    return await this.findWebElementOrElements(strategy, selector, mult, context);
  } else {
    return await this.findUIElementOrElements(strategy, selector, mult, context);
  }
};

helpers.findUIElementOrElements = async function findUIElementOrElements(strategy, selector, mult, context) {
  if (strategy !== 'xpath') {
    selector = _appiumSupport.util.escapeSpecialChars(selector, "'");
  }

  if (typeof context === 'undefined' || !context) {
    context = '';
  } else if (typeof context === 'string') {
    context = _appiumSupport.util.escapeSpecialChars(context, "'");
  }

  if (strategy === 'xpath' && MAGIC_SCROLLABLE_SEL.test(selector)) {
    return await this.findScrollableElOrEls(mult, context);
  }

  if (strategy === 'xpath' && MAGIC_FIRST_VIS_CHILD_SEL.test(selector)) {
    if (mult) {
      throw new Error('Cannot get multiple first children');
    }

    return await this.getFirstVisibleChild(context);
  }

  if (strategy === 'class name' && selector.indexOf('UIA') !== 0) {
    throw new _appiumBaseDriver.errors.InvalidSelectorError(`The class name selector must use full UIA class names. Try 'UIA${selector}' instead.`);
  }

  if (!selector) new _appiumBaseDriver.errors.InvalidSelectorError('Missing selector');

  let createGetElementCommand = function (strategy, selector, mult, context) {
    let ext = mult ? 's' : '';
    let command = '';
    context = !context ? context : `, '${context}'`;

    switch (strategy) {
      case 'name':
        command = `au.getElement${ext}ByName('${selector}'${context})`;
        break;

      case 'accessibility id':
        command = `au.getElement${ext}ByAccessibilityId('${selector}'${context})`;
        break;

      case 'id':
        command = `au.getElement${ext}ById('${selector}')`;
        break;

      case '-ios uiautomation':
        command = `au.getElement${ext}ByUIAutomation('${selector}'${context})`;
        break;

      default:
        command = `au.getElement${ext}ByType('${selector}'${context})`;
    }

    return command;
  };

  let getLocalizedStringForSelector = function (selector, strings) {
    let newSelector = selector;

    if (strings) {
      let localizedSelector = strings[selector];

      if (localizedSelector) {
        newSelector = localizedSelector;
      } else {
        _logger.default.debug(`Id selector, '${selector}', not found in Localizable.strings.`);
      }
    }

    return newSelector;
  };

  let res;

  let doFind = async () => {
    if (strategy === 'xpath') {
      res = await this.findUIElementsByXpath(selector, mult, context);
    } else if (strategy === 'id') {
      let findByAxIdCmd = createGetElementCommand('accessibility id', selector, mult, context);
      res = await this.uiAutoClient.sendCommand(findByAxIdCmd);

      if (!(res && _lodash.default.size(res) > 0)) {
        let findByIdCmd = createGetElementCommand('id', getLocalizedStringForSelector(selector, this.opts.localizableStrings), mult, context);
        res = await this.uiAutoClient.sendCommand(findByIdCmd);
      }
    } else {
      let command = createGetElementCommand(strategy, selector, mult, context);
      res = await this.uiAutoClient.sendCommand(command);
    }

    return _lodash.default.size(res) > 0;
  };

  try {
    await this.implicitWaitForCondition(doFind);
  } catch (err) {
    if (err.message && err.message.match(/Condition unmet/)) {
      res = [];
    } else {
      throw err;
    }
  }

  if (mult) {
    return res;
  } else {
    if (!res || _lodash.default.size(res) === 0) {
      throw new _appiumBaseDriver.errors.NoSuchElementError();
    }

    return res;
  }
};

let _pathFromDomNode = function (node) {
  let path = null;

  for (let attrObj of _lodash.default.values(node.attributes)) {
    if (attrObj.name === 'path') {
      path = attrObj.value;
    }
  }

  return path;
};

let _xmlSourceFromJson = function (jsonSource) {
  if (typeof jsonSource === 'string') {
    jsonSource = JSON.parse(jsonSource);
  }

  return (0, _js2xmlparser.default)('AppiumAUT', jsonSource, {
    wrapArray: {
      enabled: false,
      elementName: 'element'
    },
    declaration: {
      include: true
    },
    prettyPrinting: {
      indentString: '    '
    }
  });
};

let _performXpathQueryOnJson = function _performXpathQueryOnJson(selector, jsonSource) {
  let xmlSource = _xmlSourceFromJson(jsonSource);

  let dom = new _xmldom.default.DOMParser().parseFromString(xmlSource);
  return _xpath.default.select(selector, dom);
};

commands.findUIElementsByXpath = async function findUIElementsByXpath(selector, mult, context = null, curRetry = 1) {
  let sourceXml;

  try {
    sourceXml = await this.getSourceForElementForXML(context);
  } catch (err) {
    _logger.default.warn("Error getting source, can't continue finding element by XPath");

    throw err;
  }

  let selectedNodes = _performXpathQueryOnJson(selector, sourceXml);

  if (!mult) {
    selectedNodes = selectedNodes.slice(0, 1);
  }

  let indexPaths = [];

  for (let node of selectedNodes) {
    let ip = _pathFromDomNode(node);

    if (ip !== null) {
      indexPaths.push(ip);
    }
  }

  if (indexPaths.length < 1) {
    return [];
  }

  let methodName;
  let methodArgs = [];

  if (!mult) {
    methodName = 'getElementByIndexPath';
    methodArgs[0] = `'${indexPaths[0]}'`;
  } else {
    methodName = 'getElementsByIndexPaths';
    methodArgs[0] = JSON.stringify(indexPaths);
  }

  if (context) {
    methodArgs[1] = `au.getElement('${context}')`;
  }

  let proxyCmd = `au.${methodName}(${methodArgs.join(', ')})`;
  let res;

  try {
    res = await this.uiAutoClient.sendCommand(proxyCmd);
  } catch (err) {
    if (curRetry < 3) {
      _logger.default.debug('Got a warning from uiauto that some index paths ' + 'could not be resolved, trying again');

      await _bluebird.default.delay(300);
      return await this.findUIElementsByXpath(selector, mult, context, curRetry + 1);
    }

    throw err;
  }

  return res;
};

helpers.findScrollableElOrEls = async function findScrollableElOrEls(mult, context) {
  const scrollTypes = ['UIAScrollView', 'UIATableView', 'UIACollectionView', 'UIAWebView'];
  let res = [];
  const ext = mult ? 's' : '';

  for (const scrollType of scrollTypes) {
    const command = `au.getElement${ext}ByType('${scrollType}'${context})`;

    if (mult) {
      let elements = await this.uiAutoClient.sendCommand(command);

      if (!_lodash.default.isEmpty(elements)) {
        res.push(...elements);
      }
    } else {
      let element = await this.uiAutoClient.sendCommand(command);

      if (element) {
        return element;
      }
    }
  }

  if (mult) {
    return res;
  }

  throw new _appiumBaseDriver.errors.NoSuchElementError();
};

helpers.getFirstVisibleChild = async function getFirstVisibleChild(elementId) {
  let visibleEls = await this.findElementsFromElement('-ios uiautomation', '.elements().withPredicate("isVisible == 1");', elementId);
  return _lodash.default.first(visibleEls);
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maW5kLmpzIl0sIm5hbWVzIjpbIk1BR0lDX0ZJUlNUX1ZJU19DSElMRF9TRUwiLCJNQUdJQ19TQ1JPTExBQkxFX1NFTCIsImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJmaW5kRWxPckVscyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsImlzV2ViQ29udGV4dCIsImZpbmRXZWJFbGVtZW50T3JFbGVtZW50cyIsImZpbmRVSUVsZW1lbnRPckVsZW1lbnRzIiwidXRpbCIsImVzY2FwZVNwZWNpYWxDaGFycyIsInRlc3QiLCJmaW5kU2Nyb2xsYWJsZUVsT3JFbHMiLCJFcnJvciIsImdldEZpcnN0VmlzaWJsZUNoaWxkIiwiaW5kZXhPZiIsImVycm9ycyIsIkludmFsaWRTZWxlY3RvckVycm9yIiwiY3JlYXRlR2V0RWxlbWVudENvbW1hbmQiLCJleHQiLCJjb21tYW5kIiwiZ2V0TG9jYWxpemVkU3RyaW5nRm9yU2VsZWN0b3IiLCJzdHJpbmdzIiwibmV3U2VsZWN0b3IiLCJsb2NhbGl6ZWRTZWxlY3RvciIsImxvZ2dlciIsImRlYnVnIiwicmVzIiwiZG9GaW5kIiwiZmluZFVJRWxlbWVudHNCeVhwYXRoIiwiZmluZEJ5QXhJZENtZCIsInVpQXV0b0NsaWVudCIsInNlbmRDb21tYW5kIiwiXyIsInNpemUiLCJmaW5kQnlJZENtZCIsIm9wdHMiLCJsb2NhbGl6YWJsZVN0cmluZ3MiLCJpbXBsaWNpdFdhaXRGb3JDb25kaXRpb24iLCJlcnIiLCJtZXNzYWdlIiwibWF0Y2giLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJfcGF0aEZyb21Eb21Ob2RlIiwibm9kZSIsInBhdGgiLCJhdHRyT2JqIiwidmFsdWVzIiwiYXR0cmlidXRlcyIsIm5hbWUiLCJ2YWx1ZSIsIl94bWxTb3VyY2VGcm9tSnNvbiIsImpzb25Tb3VyY2UiLCJKU09OIiwicGFyc2UiLCJ3cmFwQXJyYXkiLCJlbmFibGVkIiwiZWxlbWVudE5hbWUiLCJkZWNsYXJhdGlvbiIsImluY2x1ZGUiLCJwcmV0dHlQcmludGluZyIsImluZGVudFN0cmluZyIsIl9wZXJmb3JtWHBhdGhRdWVyeU9uSnNvbiIsInhtbFNvdXJjZSIsImRvbSIsIlhNTERvbSIsIkRPTVBhcnNlciIsInBhcnNlRnJvbVN0cmluZyIsInhwYXRoIiwic2VsZWN0IiwiY3VyUmV0cnkiLCJzb3VyY2VYbWwiLCJnZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MIiwid2FybiIsInNlbGVjdGVkTm9kZXMiLCJzbGljZSIsImluZGV4UGF0aHMiLCJpcCIsInB1c2giLCJsZW5ndGgiLCJtZXRob2ROYW1lIiwibWV0aG9kQXJncyIsInN0cmluZ2lmeSIsInByb3h5Q21kIiwiam9pbiIsIkIiLCJkZWxheSIsInNjcm9sbFR5cGVzIiwic2Nyb2xsVHlwZSIsImVsZW1lbnRzIiwiaXNFbXB0eSIsImVsZW1lbnQiLCJlbGVtZW50SWQiLCJ2aXNpYmxlRWxzIiwiZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQiLCJmaXJzdCIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQSxNQUFNQSx5QkFBeUIsR0FBRyx1Q0FBbEM7QUFJQSxNQUFNQyxvQkFBb0IsR0FBRyx1Q0FBN0I7QUFFQSxJQUFJQyxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7O0FBRUFELE9BQU8sQ0FBQ0UsV0FBUixHQUFzQixlQUFlQSxXQUFmLENBQTRCQyxRQUE1QixFQUFzQ0MsUUFBdEMsRUFBZ0RDLElBQWhELEVBQXNEQyxPQUF0RCxFQUErRDtBQUNuRkEsRUFBQUEsT0FBTyxHQUFHLHFCQUFTQSxPQUFULENBQVY7O0FBQ0EsTUFBSSxLQUFLQyxZQUFMLEVBQUosRUFBeUI7QUFDdkIsV0FBTyxNQUFNLEtBQUtDLHdCQUFM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TUFBTSxLQUFLMUQsWUFBTCxDQUFrQkMsV0FBbEIsQ0FBOEJaLE9BQTlCLENBQXJCOztBQUNBLFVBQUksQ0FBQ2EsZ0JBQUV5RCxPQUFGLENBQVVELFFBQVYsQ0FBTCxFQUEwQjtBQUN4QjlELFFBQUFBLEdBQUcsQ0FBQ21ELElBQUosQ0FBUyxHQUFHVyxRQUFaO0FBQ0Q7QUFDRixLQUxELE1BS087QUFDTCxVQUFJRSxPQUFPLEdBQUcsTUFBTSxLQUFLNUQsWUFBTCxDQUFrQkMsV0FBbEIsQ0FBOEJaLE9BQTlCLENBQXBCOztBQUNBLFVBQUl1RSxPQUFKLEVBQWE7QUFDWCxlQUFPQSxPQUFQO0FBQ0Q7QUFDRjtBQUNGOztBQUVELE1BQUl2RixJQUFKLEVBQVU7QUFDUixXQUFPdUIsR0FBUDtBQUNEOztBQUVELFFBQU0sSUFBSVgseUJBQU8wQixrQkFBWCxFQUFOO0FBQ0QsQ0F6QkQ7O0FBMkJBM0MsT0FBTyxDQUFDZSxvQkFBUixHQUErQixlQUFlQSxvQkFBZixDQUFxQzhFLFNBQXJDLEVBQWdEO0FBQzdFLE1BQUlDLFVBQVUsR0FBRyxNQUFNLEtBQUtDLHVCQUFMLENBQTZCLG1CQUE3QixFQUFrRCw4Q0FBbEQsRUFBa0dGLFNBQWxHLENBQXZCO0FBQ0EsU0FBTzNELGdCQUFFOEQsS0FBRixDQUFRRixVQUFSLENBQVA7QUFDRCxDQUhEOztBQUtBRyxNQUFNLENBQUNDLE1BQVAsQ0FBY2pHLFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGpzMnhtbCBmcm9tICdqczJ4bWxwYXJzZXIyJztcbmltcG9ydCBYTUxEb20gZnJvbSAneG1sZG9tJztcbmltcG9ydCB4cGF0aCBmcm9tICd4cGF0aCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyB1bndyYXBFbCB9IGZyb20gJy4uL3V0aWxzJztcblxuLy8gd2Ugb3ZlcnJpZGUgdGhlIHhwYXRoIHNlYXJjaCBmb3IgdGhpcyBmaXJzdC12aXNpYmxlLWNoaWxkIHNlbGVjdG9yLCB3aGljaFxuLy8gbG9va3MgbGlrZSAvKltAZmlyc3RWaXNpYmxlPVwidHJ1ZVwiXVxuY29uc3QgTUFHSUNfRklSU1RfVklTX0NISUxEX1NFTCA9IC9cXC9cXCpcXFtAZmlyc3RWaXNpYmxlID89ID8oJ3xcIil0cnVlXFwxXFxdLztcblxuLy8gd2UgbGlrZXdpc2Ugb3ZlcnJpZGUgeHBhdGggc2VhcmNoIHRvIHByb3ZpZGUgYSBzaG9ydGN1dCBmb3IgZmluZGluZyBhbGxcbi8vIHNjcm9sbGFibGUgZWxlbWVudHNcbmNvbnN0IE1BR0lDX1NDUk9MTEFCTEVfU0VMID0gL1xcL1xcL1xcKlxcW0BzY3JvbGxhYmxlID89ID8oJ3xcIil0cnVlXFwxXFxdLztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5oZWxwZXJzLmZpbmRFbE9yRWxzID0gYXN5bmMgZnVuY3Rpb24gZmluZEVsT3JFbHMgKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICBjb250ZXh0ID0gdW53cmFwRWwoY29udGV4dCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZFdlYkVsZW1lbnRPckVsZW1lbnRzKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZFVJRWxlbWVudE9yRWxlbWVudHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfVxufTtcblxuaGVscGVycy5maW5kVUlFbGVtZW50T3JFbGVtZW50cyA9IGFzeW5jIGZ1bmN0aW9uIGZpbmRVSUVsZW1lbnRPckVsZW1lbnRzIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgaWYgKHN0cmF0ZWd5ICE9PSAneHBhdGgnKSB7XG4gICAgc2VsZWN0b3IgPSB1dGlsLmVzY2FwZVNwZWNpYWxDaGFycyhzZWxlY3RvciwgXCInXCIpO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBjb250ZXh0ID09PSAndW5kZWZpbmVkJyB8fCAhY29udGV4dCkge1xuICAgIGNvbnRleHQgPSAnJztcbiAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dCA9PT0gJ3N0cmluZycpIHtcbiAgICBjb250ZXh0ID0gdXRpbC5lc2NhcGVTcGVjaWFsQ2hhcnMoY29udGV4dCwgXCInXCIpO1xuICB9XG5cbiAgaWYgKHN0cmF0ZWd5ID09PSAneHBhdGgnICYmIE1BR0lDX1NDUk9MTEFCTEVfU0VMLnRlc3Qoc2VsZWN0b3IpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZFNjcm9sbGFibGVFbE9yRWxzKG11bHQsIGNvbnRleHQpO1xuICB9XG5cbiAgaWYgKHN0cmF0ZWd5ID09PSAneHBhdGgnICYmIE1BR0lDX0ZJUlNUX1ZJU19DSElMRF9TRUwudGVzdChzZWxlY3RvcikpIHtcbiAgICBpZiAobXVsdCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZ2V0IG11bHRpcGxlIGZpcnN0IGNoaWxkcmVuJyk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldEZpcnN0VmlzaWJsZUNoaWxkKGNvbnRleHQpO1xuICB9XG5cbiAgLy8gcHJldmlvdXNseSBnZXRTZWxlY3RvckZvclN0cmF0ZWd5XG4gIGlmIChzdHJhdGVneSA9PT0gJ2NsYXNzIG5hbWUnICYmIHNlbGVjdG9yLmluZGV4T2YoJ1VJQScpICE9PSAwKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkU2VsZWN0b3JFcnJvcihcbiAgICAgIGBUaGUgY2xhc3MgbmFtZSBzZWxlY3RvciBtdXN0IHVzZSBmdWxsIFVJQSBjbGFzcyBuYW1lcy4gVHJ5ICdVSUEke3NlbGVjdG9yfScgaW5zdGVhZC5gKTtcbiAgfVxuXG4gIGlmICghc2VsZWN0b3IpIG5ldyBlcnJvcnMuSW52YWxpZFNlbGVjdG9yRXJyb3IoJ01pc3Npbmcgc2VsZWN0b3InKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuXG4gIGxldCBjcmVhdGVHZXRFbGVtZW50Q29tbWFuZCA9IGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgICBsZXQgZXh0ID0gbXVsdCA/ICdzJyA6ICcnO1xuICAgIGxldCBjb21tYW5kID0gJyc7XG4gICAgY29udGV4dCA9ICFjb250ZXh0ID8gY29udGV4dCA6IGAsICcke2NvbnRleHR9J2AgO1xuICAgIHN3aXRjaCAoc3RyYXRlZ3kpIHtcbiAgICAgIGNhc2UgJ25hbWUnOlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeU5hbWUoJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdhY2Nlc3NpYmlsaXR5IGlkJzpcbiAgICAgICAgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50JHtleHR9QnlBY2Nlc3NpYmlsaXR5SWQoJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdpZCc6XG4gICAgICAgIGNvbW1hbmQgPSBgYXUuZ2V0RWxlbWVudCR7ZXh0fUJ5SWQoJyR7c2VsZWN0b3J9JylgO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJy1pb3MgdWlhdXRvbWF0aW9uJzpcbiAgICAgICAgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50JHtleHR9QnlVSUF1dG9tYXRpb24oJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeVR5cGUoJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICB9XG5cbiAgICByZXR1cm4gY29tbWFuZDtcbiAgfTtcblxuICBsZXQgZ2V0TG9jYWxpemVkU3RyaW5nRm9yU2VsZWN0b3IgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIHN0cmluZ3MpIHtcbiAgICBsZXQgbmV3U2VsZWN0b3IgPSBzZWxlY3RvcjtcbiAgICBpZiAoc3RyaW5ncykge1xuICAgICAgbGV0IGxvY2FsaXplZFNlbGVjdG9yID0gc3RyaW5nc1tzZWxlY3Rvcl07XG4gICAgICBpZiAobG9jYWxpemVkU2VsZWN0b3IpIHtcbiAgICAgICAgbmV3U2VsZWN0b3IgPSBsb2NhbGl6ZWRTZWxlY3RvcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICBgSWQgc2VsZWN0b3IsICcke3NlbGVjdG9yfScsIG5vdCBmb3VuZCBpbiBMb2NhbGl6YWJsZS5zdHJpbmdzLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXdTZWxlY3RvcjtcbiAgfTtcblxuICBsZXQgcmVzO1xuICBsZXQgZG9GaW5kID0gYXN5bmMgKCkgPT4ge1xuICAgIGlmIChzdHJhdGVneSA9PT0gJ3hwYXRoJykge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5maW5kVUlFbGVtZW50c0J5WHBhdGgoc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICAgIH0gZWxzZSBpZiAoc3RyYXRlZ3kgPT09ICdpZCcpIHtcbiAgICAgIC8vIEZvciB0aGUgSUQgc3RyYXRlZ3ksIHdlIGZpcnN0IHdhbnQgdG8gaGFuZGxlIHRoZSBzZWxlY3RvciBhcyBhblxuICAgICAgLy8gYWNjZXNzaWJpbGl0eSBpZC4gSWYgbm8gZWxlbWVudCBpcyBmb3VuZCBieSB0aGF0IHN0cmF0ZWd5LCB3ZSBmYWxsXG4gICAgICAvLyBiYWNrIHRvIHNlYXJjaGluZyBmb3IgdGhlIHN0cmluZy5cbiAgICAgIGxldCBmaW5kQnlBeElkQ21kID0gY3JlYXRlR2V0RWxlbWVudENvbW1hbmQoJ2FjY2Vzc2liaWxpdHkgaWQnLCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChmaW5kQnlBeElkQ21kKTtcbiAgICAgIGlmICghKHJlcyAmJiBfLnNpemUocmVzKSA+IDApKSB7XG4gICAgICAgIC8vIFNpbmNlIG5vIGVsZW1lbnQgd2FzIGZvdW5kIHVzaW5nIHRoZSBhY2Nlc3NpYmlsaXR5IGlkLCB3ZSBmYWxsXG4gICAgICAgIC8vIGJhY2sgdG8gc2VhcmNoIGJ5IHN0cmluZy5cbiAgICAgICAgbGV0IGZpbmRCeUlkQ21kID0gY3JlYXRlR2V0RWxlbWVudENvbW1hbmQoJ2lkJywgZ2V0TG9jYWxpemVkU3RyaW5nRm9yU2VsZWN0b3Ioc2VsZWN0b3IsXG4gICAgICAgICAgdGhpcy5vcHRzLmxvY2FsaXphYmxlU3RyaW5ncyksIG11bHQsIGNvbnRleHQpO1xuICAgICAgICByZXMgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChmaW5kQnlJZENtZCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBjb21tYW5kID0gY3JlYXRlR2V0RWxlbWVudENvbW1hbmQoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICAgIH1cbiAgICByZXR1cm4gXy5zaXplKHJlcykgPiAwO1xuICB9O1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24oZG9GaW5kKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVyci5tZXNzYWdlICYmIGVyci5tZXNzYWdlLm1hdGNoKC9Db25kaXRpb24gdW5tZXQvKSkge1xuICAgICAgLy8gY29uZGl0aW9uIHdhcyBub3QgbWV0IHNldHRpbmcgcmVzIHRvIGVtcHR5IGFycmF5XG4gICAgICByZXMgPSBbXTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxuICBpZiAobXVsdCkge1xuICAgIHJldHVybiByZXM7XG4gIH0gZWxzZSB7XG4gICAgaWYgKCFyZXMgfHwgXy5zaXplKHJlcykgPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gICAgfVxuICAgIHJldHVybiByZXM7XG4gIH1cbn07XG5cbmxldCBfcGF0aEZyb21Eb21Ob2RlID0gZnVuY3Rpb24gKG5vZGUpIHtcbiAgbGV0IHBhdGggPSBudWxsO1xuICBmb3IgKGxldCBhdHRyT2JqIG9mIF8udmFsdWVzKG5vZGUuYXR0cmlidXRlcykpIHtcbiAgICBpZiAoYXR0ck9iai5uYW1lID09PSAncGF0aCcpIHtcbiAgICAgIHBhdGggPSBhdHRyT2JqLnZhbHVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcGF0aDtcbn07XG5cbmxldCBfeG1sU291cmNlRnJvbUpzb24gPSBmdW5jdGlvbiAoanNvblNvdXJjZSkge1xuICBpZiAodHlwZW9mIGpzb25Tb3VyY2UgPT09ICdzdHJpbmcnKSB7XG4gICAganNvblNvdXJjZSA9IEpTT04ucGFyc2UoanNvblNvdXJjZSk7XG4gIH1cbiAgcmV0dXJuIGpzMnhtbCgnQXBwaXVtQVVUJywganNvblNvdXJjZSwge1xuICAgIHdyYXBBcnJheToge2VuYWJsZWQ6IGZhbHNlLCBlbGVtZW50TmFtZTogJ2VsZW1lbnQnfSxcbiAgICBkZWNsYXJhdGlvbjoge2luY2x1ZGU6IHRydWV9LFxuICAgIHByZXR0eVByaW50aW5nOiB7aW5kZW50U3RyaW5nOiAnICAgICd9XG4gIH0pO1xufTtcblxubGV0IF9wZXJmb3JtWHBhdGhRdWVyeU9uSnNvbiA9IGZ1bmN0aW9uIF9wZXJmb3JtWHBhdGhRdWVyeU9uSnNvbiAoc2VsZWN0b3IsIGpzb25Tb3VyY2UpIHtcbiAgbGV0IHhtbFNvdXJjZSA9IF94bWxTb3VyY2VGcm9tSnNvbihqc29uU291cmNlKTtcbiAgbGV0IGRvbSA9IG5ldyBYTUxEb20uRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHhtbFNvdXJjZSk7XG4gIHJldHVybiB4cGF0aC5zZWxlY3Qoc2VsZWN0b3IsIGRvbSk7XG59O1xuXG5jb21tYW5kcy5maW5kVUlFbGVtZW50c0J5WHBhdGggPSBhc3luYyBmdW5jdGlvbiBmaW5kVUlFbGVtZW50c0J5WHBhdGggKHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0ID0gbnVsbCwgY3VyUmV0cnkgPSAxKSB7XG4gIGxldCBzb3VyY2VYbWw7XG4gIHRyeSB7XG4gICAgc291cmNlWG1sID0gYXdhaXQgdGhpcy5nZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MKGNvbnRleHQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIud2FybihcIkVycm9yIGdldHRpbmcgc291cmNlLCBjYW4ndCBjb250aW51ZSBmaW5kaW5nIGVsZW1lbnQgYnkgWFBhdGhcIik7XG4gICAgdGhyb3cgZXJyO1xuICB9XG4gIGxldCBzZWxlY3RlZE5vZGVzID0gX3BlcmZvcm1YcGF0aFF1ZXJ5T25Kc29uKHNlbGVjdG9yLCBzb3VyY2VYbWwpO1xuXG4gIGlmICghbXVsdCkge1xuICAgIHNlbGVjdGVkTm9kZXMgPSBzZWxlY3RlZE5vZGVzLnNsaWNlKDAsIDEpO1xuICB9XG4gIGxldCBpbmRleFBhdGhzID0gW107XG4gIC8vIGZpbHRlciBvdXQgZWxlbWVudHMgd2l0aG91dCAncGF0aCcgYXR0cmlidXRlXG4gIGZvciAobGV0IG5vZGUgb2Ygc2VsZWN0ZWROb2Rlcykge1xuICAgIGxldCBpcCA9IF9wYXRoRnJvbURvbU5vZGUobm9kZSk7XG4gICAgaWYgKGlwICE9PSBudWxsKSB7XG4gICAgICBpbmRleFBhdGhzLnB1c2goaXApO1xuICAgIH1cbiAgfVxuXG4gIGlmIChpbmRleFBhdGhzLmxlbmd0aCA8IDEpIHtcbiAgICAvLyBhbmQgaWYgd2UgZG9uJ3QgaGF2ZSBhbnkgbWF0Y2hpbmcgbm9kZXMsIHJldHVybiB0aGUgZW1wdHkgYXJyYXlcbiAgICByZXR1cm4gW107XG4gIH1cblxuICAvLyBvdGhlcndpc2UgbG9vayB1cCB0aGUgYWN0dWFsIGVsZW1lbnQgYnkgaXRzIGluZGV4IHBhdGhcbiAgbGV0IG1ldGhvZE5hbWU7XG4gIGxldCBtZXRob2RBcmdzID0gW107XG5cbiAgaWYgKCFtdWx0KSB7XG4gICAgbWV0aG9kTmFtZSA9ICdnZXRFbGVtZW50QnlJbmRleFBhdGgnO1xuICAgIG1ldGhvZEFyZ3NbMF0gPSBgJyR7aW5kZXhQYXRoc1swXX0nYDtcbiAgfSBlbHNlIHtcbiAgICBtZXRob2ROYW1lID0gJ2dldEVsZW1lbnRzQnlJbmRleFBhdGhzJztcbiAgICBtZXRob2RBcmdzWzBdID0gSlNPTi5zdHJpbmdpZnkoaW5kZXhQYXRocyk7XG4gIH1cblxuICBpZiAoY29udGV4dCkge1xuICAgIG1ldGhvZEFyZ3NbMV0gPSBgYXUuZ2V0RWxlbWVudCgnJHtjb250ZXh0fScpYDtcbiAgfVxuXG4gIGxldCBwcm94eUNtZCA9IGBhdS4ke21ldGhvZE5hbWV9KCR7bWV0aG9kQXJncy5qb2luKCcsICcpfSlgO1xuXG4gIC8vIGhhdmluZyBpbmRleCBwYXRocyBtZWFucyB3ZSB0aGluayBlbGVtZW50cyBzaG91bGQgYmUgdGhlcmUuIFNvbWV0aW1lc1xuICAvLyB1aWF1dG8gbGFncyBpbiBlbmFibGluZyB1cyB0byBnZXQgZWxlbWVudHMsIHNvIHdlIHJldHJ5IGEgZmV3IHRpbWVzIGlmXG4gIC8vIGl0IGNhbid0IGZpbmQgZWxlbWVudHMgd2Uga25vdyBzaG91bGQgYmUgdGhlcmUuIHNlZSB1aWF1dG8gY29kZVxuICAvLyBmb3IgbW9yZSBsb2dpY1xuICBsZXQgcmVzO1xuICB0cnkge1xuICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKHByb3h5Q21kKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gd2UgZ2V0IGEgU3RhbGVFbGVtZW50UmVmZXJlbmNlIGlmIHVpYXV0byBjYW4ndCBmaW5kIGFuIGVsZW1lbnRcbiAgICAvLyBieSB0aGUgcGF0aCB3ZSBtZW50aW9uZWRcbiAgICBpZiAoY3VyUmV0cnkgPCAzKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0dvdCBhIHdhcm5pbmcgZnJvbSB1aWF1dG8gdGhhdCBzb21lIGluZGV4IHBhdGhzICcgK1xuICAgICAgICAgICAgICAgICAgICdjb3VsZCBub3QgYmUgcmVzb2x2ZWQsIHRyeWluZyBhZ2FpbicpO1xuICAgICAgYXdhaXQgQi5kZWxheSgzMDApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZFVJRWxlbWVudHNCeVhwYXRoKHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0LCBjdXJSZXRyeSArIDEpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cbiAgcmV0dXJuIHJlcztcbn07XG5cbmhlbHBlcnMuZmluZFNjcm9sbGFibGVFbE9yRWxzID0gYXN5bmMgZnVuY3Rpb24gZmluZFNjcm9sbGFibGVFbE9yRWxzIChtdWx0LCBjb250ZXh0KSB7XG4gIGNvbnN0IHNjcm9sbFR5cGVzID0gWydVSUFTY3JvbGxWaWV3JywgJ1VJQVRhYmxlVmlldycsICdVSUFDb2xsZWN0aW9uVmlldycsICdVSUFXZWJWaWV3J107XG4gIGxldCByZXMgPSBbXTtcbiAgY29uc3QgZXh0ID0gbXVsdCA/ICdzJyA6ICcnO1xuICBmb3IgKGNvbnN0IHNjcm9sbFR5cGUgb2Ygc2Nyb2xsVHlwZXMpIHtcbiAgICBjb25zdCBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeVR5cGUoJyR7c2Nyb2xsVHlwZX0nJHtjb250ZXh0fSlgO1xuXG4gICAgaWYgKG11bHQpIHtcbiAgICAgIGxldCBlbGVtZW50cyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgaWYgKCFfLmlzRW1wdHkoZWxlbWVudHMpKSB7XG4gICAgICAgIHJlcy5wdXNoKC4uLmVsZW1lbnRzKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGVsZW1lbnQgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgICAgIGlmIChlbGVtZW50KSB7XG4gICAgICAgIHJldHVybiBlbGVtZW50O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChtdWx0KSB7XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG59O1xuXG5oZWxwZXJzLmdldEZpcnN0VmlzaWJsZUNoaWxkID0gYXN5bmMgZnVuY3Rpb24gZ2V0Rmlyc3RWaXNpYmxlQ2hpbGQgKGVsZW1lbnRJZCkge1xuICBsZXQgdmlzaWJsZUVscyA9IGF3YWl0IHRoaXMuZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQoJy1pb3MgdWlhdXRvbWF0aW9uJywgJy5lbGVtZW50cygpLndpdGhQcmVkaWNhdGUoXCJpc1Zpc2libGUgPT0gMVwiKTsnLCBlbGVtZW50SWQpO1xuICByZXR1cm4gXy5maXJzdCh2aXNpYmxlRWxzKTtcbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9maW5kLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
