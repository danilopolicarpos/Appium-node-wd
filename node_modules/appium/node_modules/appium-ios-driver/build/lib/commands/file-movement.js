"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _path = _interopRequireDefault(require("path"));

var _teen_process = require("teen_process");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

helpers.getSimFileFullPath = async function getSimFileFullPath(remotePath) {
  let basePath = this.sim.getDir();
  let appName = null;

  if (this.opts.app) {
    let appNameRegex = new RegExp(`\\${_path.default.sep}([\\w-]+\\.app)`);
    let appNameMatches = appNameRegex.exec(this.opts.app);

    if (appNameMatches) {
      appName = appNameMatches[1];
    }
  }

  if (_appiumSupport.system.isWindows()) {
    if (remotePath.indexof('://') === 1) {
      remotePath = remotePath.slice(4);
    }
  } else {
    if (remotePath.indexOf('/') === 0) {
      remotePath = remotePath.slice(1);
    }
  }

  if (remotePath.indexOf(appName) === 0) {
    _logger.default.debug('We want an app-relative file');

    let findPath = basePath;

    if (this.opts.platformVersion >= 8) {
      findPath = _path.default.resolve(basePath, 'Containers', 'Bundle');
    }

    findPath = findPath.replace(/\s/g, '\\ ');
    let {
      stdout
    } = await (0, _teen_process.exec)('find', [findPath, '-name', appName]);
    let appRoot = stdout.replace(/\n$/, '');
    let subPath = remotePath.substring(appName.length + 1);
    return _path.default.resolve(appRoot, subPath);
  } else {
    _logger.default.debug('We want a sim-relative file');

    return _path.default.resolve(basePath, remotePath);
  }
};

commands.pushFile = async function pushFile(remotePath, base64Data) {
  _logger.default.debug(`Pushing ${remotePath} to iOS simulator`);

  if (this.isRealDevice()) {
    _logger.default.debug('Unsupported: cannot write files to physical device');

    throw new _appiumBaseDriver.errors.NotYetImplementedError();
  }

  let fullPath = await this.getSimFileFullPath(remotePath);

  _logger.default.debug(`Attempting to write ${fullPath}...`);

  if (await _appiumSupport.fs.exists(fullPath)) {
    _logger.default.debug(`${fullPath} already exists, deleting...`);

    await _appiumSupport.fs.unlink(fullPath);
  }

  await (0, _appiumSupport.mkdirp)(_path.default.dirname(fullPath));
  let content = Buffer.from(base64Data, 'base64');
  await _appiumSupport.fs.writeFile(fullPath, content);

  _logger.default.debug(`Wrote ${content.length} bytes to ${fullPath}`);
};

commands.pullFile = async function pullFile(remotePath) {
  _logger.default.debug(`Pulling ${remotePath} from sim`);

  if (this.isRealDevice()) {
    throw new _appiumBaseDriver.errors.NotYetImplementedError();
  }

  let fullPath = await this.getSimFileFullPath(remotePath);

  _logger.default.debug(`Attempting to read ${fullPath}`);

  let data = await _appiumSupport.fs.readFile(fullPath, {
    encoding: 'base64'
  });
  return data;
};

commands.pullFolder = async function pullFolder(remotePath) {
  _logger.default.debug(`Pulling '${remotePath}' from sim`);

  if (this.isRealDevice()) {
    throw new _appiumBaseDriver.errors.NotYetImplementedError();
  }

  let fullPath = await this.getSimFileFullPath(remotePath);

  _logger.default.debug(`Adding ${fullPath} to an in-memory zip archive`);

  let buffer = await _appiumSupport.zip.toInMemoryZip(fullPath);

  _logger.default.debug('Converting in-memory zip file to base64 encoded string');

  let data = buffer.toString('base64');

  _logger.default.debug('Returning in-memory zip file as base54 encoded string');

  return data;
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJnZXRTaW1GaWxlRnVsbFBhdGgiLCJyZW1vdGVQYXRoIiwiYmFzZVBhdGgiLCJzaW0iLCJnZXREaXIiLCJhcHBOYW1lIiwib3B0cyIsImFwcCIsImFwcE5hbWVSZWdleCIsIlJlZ0V4cCIsInBhdGgiLCJzZXAiLCJhcHBOYW1lTWF0Y2hlcyIsImV4ZWMiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJpbmRleG9mIiwic2xpY2UiLCJpbmRleE9mIiwibG9nZ2VyIiwiZGVidWciLCJmaW5kUGF0aCIsInBsYXRmb3JtVmVyc2lvbiIsInJlc29sdmUiLCJyZXBsYWNlIiwic3Rkb3V0IiwiYXBwUm9vdCIsInN1YlBhdGgiLCJzdWJzdHJpbmciLCJsZW5ndGgiLCJwdXNoRmlsZSIsImJhc2U2NERhdGEiLCJpc1JlYWxEZXZpY2UiLCJlcnJvcnMiLCJOb3RZZXRJbXBsZW1lbnRlZEVycm9yIiwiZnVsbFBhdGgiLCJmcyIsImV4aXN0cyIsInVubGluayIsImRpcm5hbWUiLCJjb250ZW50IiwiQnVmZmVyIiwiZnJvbSIsIndyaXRlRmlsZSIsInB1bGxGaWxlIiwiZGF0YSIsInJlYWRGaWxlIiwiZW5jb2RpbmciLCJwdWxsRm9sZGVyIiwiYnVmZmVyIiwiemlwIiwidG9Jbk1lbW9yeVppcCIsInRvU3RyaW5nIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7Ozs7QUFXQUQsT0FBTyxDQUFDRSxrQkFBUixHQUE2QixlQUFlQSxrQkFBZixDQUFtQ0MsVUFBbkMsRUFBK0M7QUFDMUUsTUFBSUMsUUFBUSxHQUFHLEtB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RUFrQixrQkFBT0MsS0FBUCxDQUFjLFVBQVNlLFFBQVMsOEJBQWhDOztBQUNBLE1BQUljLE1BQU0sR0FBRyxNQUFNQyxtQkFBSUMsYUFBSixDQUFrQmhCLFFBQWxCLENBQW5COztBQUVBaEIsa0JBQU9DLEtBQVAsQ0FBYSx3REFBYjs7QUFDQSxNQUFJeUIsSUFBSSxHQUFHSSxNQUFNLENBQUNHLFFBQVAsQ0FBZ0IsUUFBaEIsQ0FBWDs7QUFDQWpDLGtCQUFPQyxLQUFQLENBQWEsdURBQWI7O0FBQ0EsU0FBT3lCLElBQVA7QUFDRCxDQWhCRDs7QUFrQkFRLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjdkQsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZnMsIHN5c3RlbSwgbWtkaXJwLCB6aXAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbi8vIFRPRE86IG1vcmUgZXhwbGljaXQgZXJyb3IgbWVzc2FnZSBmb3IgYWxsIHRoZSBmaWxlLW1vdmVtZW50IGNvbW1hbmRzXG5cbi8qXG4gKiAgR2V0IHRoZSBmdWxsIHBhdGggdG8gYW4gaU9TIHNpbXVsYXRvciBmaWxlLlxuICogIENhbGxzIGNiKGVyciwgZnVsbEZpbGVQYXRoKVxuICogIC9Tb21lL1BhdGggICAgICAgICAgICAgICAgICAgICAgICAgICBmZXRjaGVzIGEgZmlsZSByZWxhdGl2ZSB0byB0aGUgcm9vdCBvZiB0aGUgZGV2aWNlJ3MgZmlsZXN5c3RlbS5cbiAqICAvQXBwbGljYXRpb25zL0FwcE5hbWUuYXBwL1NvbWUvUGF0aCAgZmV0Y2hlcyBhIGZpbGUgcmVsYXRpdmUgdG8gdGhlIHJvb3Qgb2YgdGhhdCBBcHBsaWNhdGlvbidzIC5hcHAgZGlyZWN0b3J5LCBhZGRpbmcgaW4gdGhlIEdVSUQuXG4gKiAgU28gaXQgbG9va3Mgc29tZXRoaW5nIGxpa2U6IC9BcHBsaWNhdGlvbnMvR1VJRC1HVUlELUdVSUQtR1VJRC9Tb21lL1BhdGhcbiAqL1xuaGVscGVycy5nZXRTaW1GaWxlRnVsbFBhdGggPSBhc3luYyBmdW5jdGlvbiBnZXRTaW1GaWxlRnVsbFBhdGggKHJlbW90ZVBhdGgpIHtcbiAgbGV0IGJhc2VQYXRoID0gdGhpcy5zaW0uZ2V0RGlyKCk7XG4gIGxldCBhcHBOYW1lID0gbnVsbDtcblxuICBpZiAodGhpcy5vcHRzLmFwcCkge1xuICAgIGxldCBhcHBOYW1lUmVnZXggPSBuZXcgUmVnRXhwKGBcXFxcJHtwYXRoLnNlcH0oW1xcXFx3LV0rXFxcXC5hcHApYCk7XG4gICAgbGV0IGFwcE5hbWVNYXRjaGVzID0gYXBwTmFtZVJlZ2V4LmV4ZWModGhpcy5vcHRzLmFwcCk7XG4gICAgaWYgKGFwcE5hbWVNYXRjaGVzKSB7XG4gICAgICBhcHBOYW1lID0gYXBwTmFtZU1hdGNoZXNbMV07XG4gICAgfVxuICB9XG4gIC8vIGRlLWFic29sdXRpemUgdGhlIHBhdGhcbiAgaWYgKHN5c3RlbS5pc1dpbmRvd3MoKSkge1xuICAgIGlmIChyZW1vdGVQYXRoLmluZGV4b2YoJzovLycpID09PSAxKSB7XG4gICAgICByZW1vdGVQYXRoID0gcmVtb3RlUGF0aC5zbGljZSg0KTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKHJlbW90ZVBhdGguaW5kZXhPZignLycpID09PSAwKSB7XG4gICAgICByZW1vdGVQYXRoID0gcmVtb3RlUGF0aC5zbGljZSgxKTtcbiAgICB9XG4gIH1cblxuICBpZiAocmVtb3RlUGF0aC5pbmRleE9mKGFwcE5hbWUpID09PSAwKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdXZSB3YW50IGFuIGFwcC1yZWxhdGl2ZSBmaWxlJyk7XG5cbiAgICBsZXQgZmluZFBhdGggPSBiYXNlUGF0aDtcbiAgICBpZiAodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiA+PSA4KSB7XG4gICAgICAvLyB0aGUgLmFwcCBmaWxlIGFwcGVhcnMgaW4gL0NvbnRhaW5lcnMvRGF0YSBhbmQgL0NvbnRhaW5lcnMvQnVuZGxlIGJvdGguIFdlIG9ubHkgd2FudCAvQnVuZGxlXG4gICAgICBmaW5kUGF0aCA9IHBhdGgucmVzb2x2ZShiYXNlUGF0aCwgJ0NvbnRhaW5lcnMnLCAnQnVuZGxlJyk7XG4gICAgfVxuICAgIGZpbmRQYXRoID0gZmluZFBhdGgucmVwbGFjZSgvXFxzL2csICdcXFxcICcpO1xuXG4gICAgbGV0IHsgc3Rkb3V0IH0gPSBhd2FpdCBleGVjKCdmaW5kJywgW2ZpbmRQYXRoLCAnLW5hbWUnLCBhcHBOYW1lXSk7XG4gICAgbGV0IGFwcFJvb3QgPSBzdGRvdXQucmVwbGFjZSgvXFxuJC8sICcnKTtcbiAgICBsZXQgc3ViUGF0aCA9IHJlbW90ZVBhdGguc3Vic3RyaW5nKGFwcE5hbWUubGVuZ3RoICsgMSk7XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZShhcHBSb290LCBzdWJQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIuZGVidWcoJ1dlIHdhbnQgYSBzaW0tcmVsYXRpdmUgZmlsZScpO1xuICAgIHJldHVybiBwYXRoLnJlc29sdmUoYmFzZVBhdGgsIHJlbW90ZVBhdGgpO1xuICB9XG59O1xuXG5jb21tYW5kcy5wdXNoRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIHB1c2hGaWxlIChyZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgUHVzaGluZyAke3JlbW90ZVBhdGh9IHRvIGlPUyBzaW11bGF0b3JgKTtcblxuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGxvZ2dlci5kZWJ1ZygnVW5zdXBwb3J0ZWQ6IGNhbm5vdCB3cml0ZSBmaWxlcyB0byBwaHlzaWNhbCBkZXZpY2UnKTtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuXG4gIGxldCBmdWxsUGF0aCA9IGF3YWl0IHRoaXMuZ2V0U2ltRmlsZUZ1bGxQYXRoKHJlbW90ZVBhdGgpO1xuXG4gIGxvZ2dlci5kZWJ1ZyhgQXR0ZW1wdGluZyB0byB3cml0ZSAke2Z1bGxQYXRofS4uLmApO1xuICBpZiAoYXdhaXQgZnMuZXhpc3RzKGZ1bGxQYXRoKSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgJHtmdWxsUGF0aH0gYWxyZWFkeSBleGlzdHMsIGRlbGV0aW5nLi4uYCk7XG4gICAgYXdhaXQgZnMudW5saW5rKGZ1bGxQYXRoKTtcbiAgfVxuICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKGZ1bGxQYXRoKSk7XG4gIGxldCBjb250ZW50ID0gQnVmZmVyLmZyb20oYmFzZTY0RGF0YSwgJ2Jhc2U2NCcpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoZnVsbFBhdGgsIGNvbnRlbnQpO1xuICBsb2dnZXIuZGVidWcoYFdyb3RlICR7Y29udGVudC5sZW5ndGh9IGJ5dGVzIHRvICR7ZnVsbFBhdGh9YCk7XG59O1xuXG5jb21tYW5kcy5wdWxsRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIHB1bGxGaWxlIChyZW1vdGVQYXRoKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgUHVsbGluZyAke3JlbW90ZVBhdGh9IGZyb20gc2ltYCk7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuICBsZXQgZnVsbFBhdGggPSBhd2FpdCB0aGlzLmdldFNpbUZpbGVGdWxsUGF0aChyZW1vdGVQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoYEF0dGVtcHRpbmcgdG8gcmVhZCAke2Z1bGxQYXRofWApO1xuICBsZXQgZGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZ1bGxQYXRoLCB7ZW5jb2Rpbmc6ICdiYXNlNjQnfSk7XG4gIHJldHVybiBkYXRhO1xufTtcblxuY29tbWFuZHMucHVsbEZvbGRlciA9IGFzeW5jIGZ1bmN0aW9uIHB1bGxGb2xkZXIgKHJlbW90ZVBhdGgpIHtcbiAgbG9nZ2VyLmRlYnVnKGBQdWxsaW5nICcke3JlbW90ZVBhdGh9JyBmcm9tIHNpbWApO1xuXG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBsZXQgZnVsbFBhdGggPSBhd2FpdCB0aGlzLmdldFNpbUZpbGVGdWxsUGF0aChyZW1vdGVQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoYEFkZGluZyAke2Z1bGxQYXRofSB0byBhbiBpbi1tZW1vcnkgemlwIGFyY2hpdmVgKTtcbiAgbGV0IGJ1ZmZlciA9IGF3YWl0IHppcC50b0luTWVtb3J5WmlwKGZ1bGxQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoJ0NvbnZlcnRpbmcgaW4tbWVtb3J5IHppcCBmaWxlIHRvIGJhc2U2NCBlbmNvZGVkIHN0cmluZycpO1xuICBsZXQgZGF0YSA9IGJ1ZmZlci50b1N0cmluZygnYmFzZTY0Jyk7XG4gIGxvZ2dlci5kZWJ1ZygnUmV0dXJuaW5nIGluLW1lbW9yeSB6aXAgZmlsZSBhcyBiYXNlNTQgZW5jb2RlZCBzdHJpbmcnKTtcbiAgcmV0dXJuIGRhdGE7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZmlsZS1tb3ZlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
