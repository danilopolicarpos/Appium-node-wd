"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.exec = exec;
exports.default = void 0;

require("source-map-support/register");

var _child_process = require("child_process");

var _shellQuote = require("shell-quote");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

async function exec(cmd, args = [], opts = {}) {
  const rep = (0, _shellQuote.quote)([cmd, ...args]);
  opts = Object.assign({
    timeout: null,
    encoding: 'utf8',
    killSignal: 'SIGTERM',
    cwd: undefined,
    env: process.env,
    ignoreOutput: false,
    stdio: 'inherit',
    isBuffer: false,
    shell: undefined,
    logger: undefined
  }, opts);
  return await new _bluebird.default((resolve, reject) => {
    let proc = (0, _child_process.spawn)(cmd, args, {
      cwd: opts.cwd,
      env: opts.env,
      shell: opts.shell
    });
    let stdoutArr = [],
        stderrArr = [],
        timer = null;
    proc.on('error', err => {
      let msg = `Command '${rep}' errored out: ${err.stack}`;

      if (err.errno === 'ENOENT') {
        msg = `Command '${cmd}' not found. Is it installed?`;
      }

      reject(new Error(msg));
    });

    if (proc.stdin) {
      proc.stdin.on('error', err => {
        reject(new Error(`Standard input '${err.syscall}' error: ${err.stack}`));
      });
    }

    if (proc.stdout) {
      proc.stdout.on('error', err => {
        reject(new Error(`Standard output '${err.syscall}' error: ${err.stack}`));
      });

      if (!opts.ignoreOutput) {
        proc.stdout.on('data', data => {
          stdoutArr.push(data);

          if (opts.logger && _lodash.default.isFunction(opts.logger.debug)) {
            opts.logger.debug(data);
          }
        });
      }
    }

    if (proc.stderr) {
      proc.stderr.on('error', err => {
        reject(new Error(`Standard error '${err.syscall}' error: ${err.stack}`));
      });

      if (!opts.ignoreOutput) {
        proc.stderr.on('data', data => {
          stderrArr.push(data);

          if (opts.logger && _lodash.default.isFunction(opts.logger.error)) {
            opts.logger.error(data);
          }
        });
      }
    }

    function getStdio(isBuffer) {
      let stdout, stderr;

      if (isBuffer) {
        stdout = Buffer.concat(stdoutArr);
        stderr = Buffer.concat(stderrArr);
      } else {
        stdout = Buffer.concat(stdoutArr).toString(opts.encoding);
        stderr = Buffer.concat(stderrArr).toString(opts.encoding);
      }

      return {
        stdout,
        stderr
      };
    }

    proc.on('close', code => {
      if (timer) {
        clearTimeout(timer);
      }

      let {
        stdout,
        stderr
      } = getStdio(opts.isBuffer);

      if (code === 0) {
        resolve({
          stdout,
          stderr,
          code
        });
      } else {
        let err = new Error(`Command '${rep}' exited with code ${code}`);
        err = Object.assign(err, {
          stdout,
          stderr,
          code
        });
        reject(err);
      }
    });

    if (opts.timeout) {
      timer = setTimeout(() => {
        let {
          stdout,
          stderr
        } = getStdio(opts.isBuffer);
        let err = new Error(`Command '${rep}' timed out after ${opts.timeout}ms`);
        err = Object.assign(err, {
          stdout,
          stderr,
          code: null
        });
        reject(err);
        proc.kill(opts.killSignal);
      }, opts.timeout);
    }
  });
}

var _default = exec;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leGVjLmpzIl0sIm5hbWVzIjpbImV4ZWMiLCJjbWQiLCJhcmdzIiwib3B0cyIsInJlcCIsIk9iamVjdCIsImFzc2lnbiIsInRpbWVvdXQiLCJlbmNvZGluZyIsImtpbGxTaWduYWwiLCJjd2QiLCJ1bmRlZmluZWQiLCJlbnYiLCJwcm9jZXNzIiwiaWdub3JlT3V0cHV0Iiwic3RkaW8iLCJpc0J1ZmZlciIsInNoZWxsIiwibG9nZ2VyIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJwcm9jIiwic3Rkb3V0QXJyIiwic3RkZXJyQXJyIiwidGltZXIiLCJvbiIsImVyciIsIm1zZyIsInN0YWNrIiwiZXJybm8iLCJFcnJvciIsInN0ZGluIiwic3lzY2FsbCIsInN0ZG91dCIsImRhdGEiLCJwdXNoIiwiXyIsImlzRnVuY3Rpb24iLCJkZWJ1ZyIsInN0ZGVyciIsImVycm9yIiwiZ2V0U3RkaW8iLCJCdWZmZXIiLCJjb25jYXQiLCJ0b1N0cmluZyIsImNvZGUiLCJjbGVhclRpbWVvdXQiLCJzZXRUaW1lb3V0Iiwia2lsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsZUFBZUEsSUFBZixDQUFxQkMsR0FBckIsRUFBMEJDLElBQUksR0FBRyxFQUFqQyxFQUFxQ0MsSUFBSSxHQUFHLEVBQTVDLEVBQWdEO0FBRTlDLFFBQU1DLEdBQUcsR0FBRyx1QkFBTSxDQUFDSCxHQUFELEVBQU0sR0FBR0MsSUFBVCxDQUFOLENBQVo7QUFJQUMsRUFBQUEsSUFBSSxHQUFHRSxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUNuQkMsSUFBQUEsT0FBTyxFQUFFLElBRFU7QUFFbkJDLElBQUFBLFFBQVEsRUFBRSxNQUZTO0FBR25CQyxJQUFBQSxVQUFVLEVBQUUsU0FITztBQUluQkMsSUFBQUEsR0FBRyxFQUFFQyxTQUpjO0FBS25CQyxJQUFBQSxHQUFHLEVBQUVDLE9BQU8sQ0FBQ0QsR0FMTTtBQU1uQkUsSUFBQUEsWUFBWSxFQUFF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QVNEO0FBQ0YsR0EzRlksQ0FBYjtBQTRGRDs7ZUFHY1AsSSIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrcyAqL1xuXG5pbXBvcnQgeyBzcGF3biB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgcXVvdGUgfSBmcm9tICdzaGVsbC1xdW90ZSc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5cbmFzeW5jIGZ1bmN0aW9uIGV4ZWMgKGNtZCwgYXJncyA9IFtdLCBvcHRzID0ge30pIHtcbiAgLy8gZ2V0IGEgcXVvdGVkIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjb21tYW5kIGZvciBlcnJvciBzdHJpbmdzXG4gIGNvbnN0IHJlcCA9IHF1b3RlKFtjbWQsIC4uLmFyZ3NdKTtcblxuICAvLyBleHRlbmQgZGVmYXVsdCBvcHRpb25zOyB3ZSdyZSBiYXNpY2FsbHkgcmUtaW1wbGVtZW50aW5nIGV4ZWMncyBvcHRpb25zXG4gIC8vIGZvciB1c2UgaGVyZSB3aXRoIHNwYXduIHVuZGVyIHRoZSBob29kXG4gIG9wdHMgPSBPYmplY3QuYXNzaWduKHtcbiAgICB0aW1lb3V0OiBudWxsLFxuICAgIGVuY29kaW5nOiAndXRmOCcsXG4gICAga2lsbFNpZ25hbDogJ1NJR1RFUk0nLFxuICAgIGN3ZDogdW5kZWZpbmVkLFxuICAgIGVudjogcHJvY2Vzcy5lbnYsXG4gICAgaWdub3JlT3V0cHV0OiBmYWxzZSxcbiAgICBzdGRpbzogJ2luaGVyaXQnLFxuICAgIGlzQnVmZmVyOiBmYWxzZSxcbiAgICBzaGVsbDogdW5kZWZpbmVkLFxuICAgIGxvZ2dlcjogdW5kZWZpbmVkLFxuICB9LCBvcHRzKTtcblxuICAvLyB0aGlzIGlzIGFuIGFzeW5jIGZ1bmN0aW9uLCBzbyByZXR1cm4gYSBwcm9taXNlXG4gIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgLy8gc3Bhd24gdGhlIGNoaWxkIHByb2Nlc3Mgd2l0aCBvcHRpb25zOyB3ZSBkb24ndCBjdXJyZW50bHkgZXhwb3NlIGFueSBvZlxuICAgIC8vIHRoZSBvdGhlciAnc3Bhd24nIG9wdGlvbnMgdGhyb3VnaCB0aGUgQVBJXG4gICAgbGV0IHByb2MgPSBzcGF3bihjbWQsIGFyZ3MsIHtjd2Q6IG9wdHMuY3dkLCBlbnY6IG9wdHMuZW52LCBzaGVsbDogb3B0cy5zaGVsbH0pO1xuICAgIGxldCBzdGRvdXRBcnIgPSBbXSwgc3RkZXJyQXJyID0gW10sIHRpbWVyID0gbnVsbDtcblxuICAgIC8vIGlmIHRoZSBwcm9jZXNzIGVycm9ycyBvdXQsIHJlamVjdCB0aGUgcHJvbWlzZVxuICAgIHByb2Mub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgbGV0IG1zZyA9IGBDb21tYW5kICcke3JlcH0nIGVycm9yZWQgb3V0OiAke2Vyci5zdGFja31gO1xuICAgICAgaWYgKGVyci5lcnJubyA9PT0gJ0VOT0VOVCcpIHtcbiAgICAgICAgbXNnID0gYENvbW1hbmQgJyR7Y21kfScgbm90IGZvdW5kLiBJcyBpdCBpbnN0YWxsZWQ/YDtcbiAgICAgIH1cbiAgICAgIHJlamVjdChuZXcgRXJyb3IobXNnKSk7XG4gICAgfSk7XG4gICAgaWYgKHByb2Muc3RkaW4pIHtcbiAgICAgIHByb2Muc3RkaW4ub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKGBTdGFuZGFyZCBpbnB1dCAnJHtlcnIuc3lzY2FsbH0nIGVycm9yOiAke2Vyci5zdGFja31gKSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKHByb2Muc3Rkb3V0KSB7XG4gICAgICBwcm9jLnN0ZG91dC5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFN0YW5kYXJkIG91dHB1dCAnJHtlcnIuc3lzY2FsbH0nIGVycm9yOiAke2Vyci5zdGFja31gKSk7XG4gICAgICB9KTtcbiAgICAgIC8vIGtlZXAgdHJhY2sgb2Ygc3Rkb3V0IGlmIHdlIGhhdmUgbm90IHNhaWQgbm90IHRvXG4gICAgICBpZiAoIW9wdHMuaWdub3JlT3V0cHV0KSB7XG4gICAgICAgIHByb2Muc3Rkb3V0Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgICBzdGRvdXRBcnIucHVzaChkYXRhKTtcbiAgICAgICAgICBpZiAob3B0cy5sb2dnZXIgJiYgXy5pc0Z1bmN0aW9uKG9wdHMubG9nZ2VyLmRlYnVnKSkge1xuICAgICAgICAgICAgb3B0cy5sb2dnZXIuZGVidWcoZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHByb2Muc3RkZXJyKSB7XG4gICAgICBwcm9jLnN0ZGVyci5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFN0YW5kYXJkIGVycm9yICcke2Vyci5zeXNjYWxsfScgZXJyb3I6ICR7ZXJyLnN0YWNrfWApKTtcbiAgICAgIH0pO1xuICAgICAgLy8ga2VlcCB0cmFjayBvZiBzdGRlcnIgaWYgd2UgaGF2ZSBub3Qgc2FpZCBub3QgdG9cbiAgICAgIGlmICghb3B0cy5pZ25vcmVPdXRwdXQpIHtcbiAgICAgICAgcHJvYy5zdGRlcnIub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgIHN0ZGVyckFyci5wdXNoKGRhdGEpO1xuICAgICAgICAgIGlmIChvcHRzLmxvZ2dlciAmJiBfLmlzRnVuY3Rpb24ob3B0cy5sb2dnZXIuZXJyb3IpKSB7XG4gICAgICAgICAgICBvcHRzLmxvZ2dlci5lcnJvcihkYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldFN0ZGlvIChpc0J1ZmZlcikge1xuICAgICAgbGV0IHN0ZG91dCwgc3RkZXJyO1xuICAgICAgaWYgKGlzQnVmZmVyKSB7XG4gICAgICAgIHN0ZG91dCA9IEJ1ZmZlci5jb25jYXQoc3Rkb3V0QXJyKTtcbiAgICAgICAgc3RkZXJyID0gQnVmZmVyLmNvbmNhdChzdGRlcnJBcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3Rkb3V0ID0gQnVmZmVyLmNvbmNhdChzdGRvdXRBcnIpLnRvU3RyaW5nKG9wdHMuZW5jb2RpbmcpO1xuICAgICAgICBzdGRlcnIgPSBCdWZmZXIuY29uY2F0KHN0ZGVyckFycikudG9TdHJpbmcob3B0cy5lbmNvZGluZyk7XG4gICAgICB9XG4gICAgICByZXR1cm4ge3N0ZG91dCwgc3RkZXJyfTtcbiAgICB9XG5cbiAgICAvLyBpZiB0aGUgcHJvY2VzcyBlbmRzLCBlaXRoZXIgcmVzb2x2ZSBvciByZWplY3QgdGhlIHByb21pc2UgYmFzZWQgb24gdGhlXG4gICAgLy8gZXhpdCBjb2RlIG9mIHRoZSBwcm9jZXNzLiBlaXRoZXIgd2F5LCBhdHRhY2ggc3Rkb3V0LCBzdGRlcnIsIGFuZCBjb2RlLlxuICAgIC8vIEFsc28gY2xlYW4gdXAgdGhlIHRpbWVyIGlmIGl0IGV4aXN0c1xuICAgIHByb2Mub24oJ2Nsb3NlJywgKGNvZGUpID0+IHtcbiAgICAgIGlmICh0aW1lcikge1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgfVxuICAgICAgbGV0IHtzdGRvdXQsIHN0ZGVycn0gPSBnZXRTdGRpbyhvcHRzLmlzQnVmZmVyKTtcbiAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgIHJlc29sdmUoe3N0ZG91dCwgc3RkZXJyLCBjb2RlfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgZXJyID0gbmV3IEVycm9yKGBDb21tYW5kICcke3JlcH0nIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfWApO1xuICAgICAgICBlcnIgPSBPYmplY3QuYXNzaWduKGVyciwge3N0ZG91dCwgc3RkZXJyLCBjb2RlfSk7XG4gICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gaWYgd2Ugc2V0IGEgdGltZW91dCBvbiB0aGUgY2hpbGQgcHJvY2VzcywgY3V0IGludG8gdGhlIGV4ZWN1dGlvbiBhbmRcbiAgICAvLyByZWplY3QgaWYgdGhlIHRpbWVvdXQgaXMgcmVhY2hlZC4gQXR0YWNoIHRoZSBzdGRvdXQvc3RkZXJyIHdlIGN1cnJlbnRseVxuICAgIC8vIGhhdmUgaW4gY2FzZSBpdCdzIGhlbHBmdWwgaW4gZGVidWdnaW5nXG4gICAgaWYgKG9wdHMudGltZW91dCkge1xuICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgbGV0IHtzdGRvdXQsIHN0ZGVycn0gPSBnZXRTdGRpbyhvcHRzLmlzQnVmZmVyKTtcbiAgICAgICAgbGV0IGVyciA9IG5ldyBFcnJvcihgQ29tbWFuZCAnJHtyZXB9JyB0aW1lZCBvdXQgYWZ0ZXIgJHtvcHRzLnRpbWVvdXR9bXNgKTtcbiAgICAgICAgZXJyID0gT2JqZWN0LmFzc2lnbihlcnIsIHtzdGRvdXQsIHN0ZGVyciwgY29kZTogbnVsbH0pO1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgLy8gcmVqZWN0IGFuZCBUSEVOIGtpbGwgdG8gYXZvaWQgcmFjZSBjb25kaXRpb25zIHdpdGggdGhlIGhhbmRsZXJzXG4gICAgICAgIC8vIGFib3ZlXG4gICAgICAgIHByb2Mua2lsbChvcHRzLmtpbGxTaWduYWwpO1xuICAgICAgfSwgb3B0cy50aW1lb3V0KTtcbiAgICB9XG4gIH0pO1xufVxuXG5leHBvcnQgeyBleGVjIH07XG5leHBvcnQgZGVmYXVsdCBleGVjO1xuIl0sImZpbGUiOiJsaWIvZXhlYy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
