"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SubProcess = void 0;

require("source-map-support/register");

var _child_process = require("child_process");

var _events = _interopRequireDefault(require("events"));

var _through = _interopRequireDefault(require("through"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _shellQuote = require("shell-quote");

var _lodash = _interopRequireDefault(require("lodash"));

const {
  EventEmitter
} = _events.default;

class SubProcess extends EventEmitter {
  constructor(cmd, args = [], opts = {}) {
    super();
    if (!cmd) throw new Error('Command is required');
    if (!_lodash.default.isString(cmd)) throw new Error('Command must be a string');
    if (!_lodash.default.isArray(args)) throw new Error('Args must be an array');
    this.cmd = cmd;
    this.args = args;
    this.proc = null;
    this.opts = opts;
    this.expectingExit = false;
    this.rep = (0, _shellQuote.quote)([cmd, ...args]);
  }

  get isRunning() {
    return !!this.proc;
  }

  emitLines(stream, lines) {
    for (let line of lines) {
      this.emit('stream-line', `[${stream.toUpperCase()}] ${line}`);
    }
  }

  async start(startDetector = null, timeoutMs = null, detach = false) {
    let startDelay = 10;

    const genericStartDetector = function genericStartDetector(stdout, stderr) {
      return stdout || stderr;
    };

    if (startDetector === null) {
      startDetector = genericStartDetector;
    }

    if (_lodash.default.isNumber(startDetector)) {
      startDelay = startDetector;
      startDetector = null;
    }

    if (_lodash.default.isBoolean(startDetector) && startDetector) {
      if (!this.opts.detached) {
        throw new Error(`Unable to detach process that is not started with 'detached' option`);
      }

      detach = true;
      startDetector = genericStartDetector;
    } else if (_lodash.default.isBoolean(timeoutMs) && timeoutMs) {
      if (!this.opts.detached) {
        throw new Error(`Unable to detach process that is not started with 'detached' option`);
      }

      detach = true;
      timeoutMs = null;
    }

    return await new _bluebird.default((resolve, reject) => {
      this.proc = (0, _child_process.spawn)(this.cmd, this.args, this.opts);

      if (this.proc.stdout) {
        this.proc.stdout.setEncoding(this.opts.encoding || 'utf8');
      }

      if (this.proc.stderr) {
        this.proc.stderr.setEncoding(this.opts.encoding || 'utf8');
      }

      this.lastLinePortion = {
        stdout: '',
        stderr: ''
      };

      const handleOutput = data => {
        try {
          if (startDetector && startDetector(data.stdout, data.stderr)) {
            startDetector = null;
            resolve();
          }
        } catch (e) {
          reject(e);
        }

        this.emit('output', data.stdout, data.stderr);

        for (const stream of ['stdout', 'stderr']) {
          if (!data[stream]) continue;
          let lines = data[stream].split('\n');

          if (lines.length > 1) {
            let retLines = lines.slice(0, -1);
            retLines[0] = this.lastLinePortion[stream] + retLines[0];
            this.lastLinePortion[stream] = lines[lines.length - 1];
            this.emit(`lines-${stream}`, retLines);
            this.emitLines(stream, retLines);
          } else {
            this.lastLinePortion[stream] += lines[0];
          }
        }
      };

      this.proc.on('error', err => {
        this.proc.removeAllListeners('exit');
        this.proc.kill('SIGINT');

        if (err.errno === 'ENOENT') {
          err = new Error(`Command '${this.cmd}' not found. Is it installed?`);
        }

        reject(err);
      });

      if (this.proc.stdout) {
        this.proc.stdout.pipe((0, _through.default)(stdout => {
          handleOutput({
            stdout,
            stderr: ''
          });
        }));
      }

      if (this.proc.stderr) {
        this.proc.stderr.pipe((0, _through.default)(stderr => {
          handleOutput({
            stdout: '',
            stderr
          });
        }));
      }

      this.proc.on('exit', (code, signal) => {
        this.handleLastLines();
        this.emit('exit', code, signal);
        let event = this.expectingExit ? 'stop' : 'die';

        if (!this.expectingExit && code === 0) {
          event = 'end';
        }

        this.emit(event, code, signal);
        this.proc = null;
        this.expectingExit = false;
      });

      if (!startDetector) {
        setTimeout(() => {
          resolve();
        }, startDelay);
      }

      if (_lodash.default.isNumber(timeoutMs)) {
        setTimeout(() => {
          reject(new Error(`The process did not start within ${timeoutMs}ms ` + `(cmd: '${this.rep}')`));
        }, timeoutMs);
      }
    }).finally(() => {
      if (detach && this.proc) {
        this.proc.unref();
      }
    });
  }

  handleLastLines() {
    for (let stream of ['stdout', 'stderr']) {
      if (this.lastLinePortion[stream]) {
        const lastLines = [this.lastLinePortion[stream]];
        this.emit(`lines-${stream}`, lastLines);
        this.emitLines(stream, lastLines);
        this.lastLinePortion[stream] = '';
      }
    }
  }

  async stop(signal = 'SIGTERM', timeout = 10000) {
    if (!this.isRunning) {
      throw new Error(`Can't stop process; it's not currently running (cmd: '${this.rep}')`);
    }

    this.handleLastLines();
    return await new _bluebird.default((resolve, reject) => {
      this.proc.on('close', resolve);
      this.expectingExit = true;
      this.proc.kill(signal);
      setTimeout(() => {
        reject(new Error(`Process didn't end after ${timeout}ms (cmd: '${this.rep}')`));
      }, timeout);
    });
  }

  async join(allowedExitCodes = [0]) {
    if (!this.isRunning) {
      throw new Error(`Cannot join process; it is not currently running (cmd: '${this.rep}')`);
    }

    return await new _bluebird.default((resolve, reject) => {
      this.proc.on('exit', code => {
        if (allowedExitCodes.indexOf(code) === -1) {
          reject(new Error(`Process ended with exitcode ${code} (cmd: '${this.rep}')`));
        } else {
          resolve(code);
        }
      });
    });
  }

  detachProcess() {
    if (!this.opts.detached) {
      throw new Error(`Unable to detach process that is not started with 'detached' option`);
    }

    if (this.proc) {
      this.proc.unref();
    }
  }

  get pid() {
    return this.proc ? this.proc.pid : null;
  }

}

exports.SubProcess = SubProcess;
var _default = SubProcess;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zdWJwcm9jZXNzLmpzIl0sIm5hbWVzIjpbIkV2ZW50RW1pdHRlciIsImV2ZW50cyIsIlN1YlByb2Nlc3MiLCJjb25zdHJ1Y3RvciIsImNtZCIsImFyZ3MiLCJvcHRzIiwiRXJyb3IiLCJfIiwiaXNTdHJpbmciLCJpc0FycmF5IiwicHJvYyIsImV4cGVjdGluZ0V4aXQiLCJyZXAiLCJpc1J1bm5pbmciLCJlbWl0TGluZXMiLCJzdHJlYW0iLCJsaW5lcyIsImxpbmUiLCJlbWl0IiwidG9VcHBlckNhc2UiLCJzdGFydCIsInN0YXJ0RGV0ZWN0b3IiLCJ0aW1lb3V0TXMiLCJkZXRhY2giLCJzdGFydERlbGF5IiwiZ2VuZXJpY1N0YXJ0RGV0ZWN0b3IiLCJzdGRvdXQiLCJzdGRlcnIiLCJpc051bWJlciIsImlzQm9vbGVhbiIsImRldGFjaGVkIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJzZXRFbmNvZGluZyIsImVuY29kaW5nIiwibGFzdExpbmVQb3J0aW9uIiwiaGFuZGxlT3V0cHV0IiwiZGF0YSIsImUiLCJzcGxpdCIsImxlbmd0aCIsInJldExpbmVzIiwic2xpY2UiLCJvbiIsImVyciIsInJlbW92ZUFsbExpc3RlbmVycyIsImtpbGwiLCJlcnJubyIsInBpcGUiLCJjb2RlIiwic2lnbmFsIiwiaGFuZGxlTGFzdExpbmVzIiwiZXZlbnQiLCJzZXRUaW1lb3V0IiwiZmluYWxseSIsInVucmVmIiwibGFzdExpbmVzIiwic3RvcCIsInRpbWVvdXQiLCJqb2luIiwiYWxsb3dlZEV4aXRDb2RlcyIsImluZGV4T2YiLCJkZXRhY2hQcm9jZXNzIiwicGlkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUhBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFtQkMsZUFBekI7O0FBTUEsTUFBTUMsVUFBTixTQUF5QkYsWUFBekIsQ0FBc0M7QUFDcENHLEVBQUFBLFdBQVcsQ0FBRUMsR0FBRixFQUFP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bnQtZGlzYWJsZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3MgKi9cblxuaW1wb3J0IHsgc3Bhd24gfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBldmVudHMgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB0aHJvdWdoIGZyb20gJ3Rocm91Z2gnO1xuY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IGV2ZW50cztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHF1b3RlIH0gZnJvbSAnc2hlbGwtcXVvdGUnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jbGFzcyBTdWJQcm9jZXNzIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgY29uc3RydWN0b3IgKGNtZCwgYXJncyA9IFtdLCBvcHRzID0ge30pIHtcbiAgICBzdXBlcigpO1xuICAgIGlmICghY21kKSB0aHJvdyBuZXcgRXJyb3IoJ0NvbW1hbmQgaXMgcmVxdWlyZWQnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgIGlmICghXy5pc1N0cmluZyhjbWQpKSB0aHJvdyBuZXcgRXJyb3IoJ0NvbW1hbmQgbXVzdCBiZSBhIHN0cmluZycpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgaWYgKCFfLmlzQXJyYXkoYXJncykpIHRocm93IG5ldyBFcnJvcignQXJncyBtdXN0IGJlIGFuIGFycmF5Jyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICAgIHRoaXMuY21kID0gY21kO1xuICAgIHRoaXMuYXJncyA9IGFyZ3M7XG4gICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICB0aGlzLm9wdHMgPSBvcHRzO1xuICAgIHRoaXMuZXhwZWN0aW5nRXhpdCA9IGZhbHNlO1xuXG4gICAgLy8gZ2V0IGEgcXVvdGVkIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjb21tYW5kIGZvciBlcnJvciBzdHJpbmdzXG4gICAgdGhpcy5yZXAgPSBxdW90ZShbY21kLCAuLi5hcmdzXSk7XG4gIH1cblxuICBnZXQgaXNSdW5uaW5nICgpIHtcbiAgICAvLyBwcmVzZW5jZSBvZiBgcHJvY2AgbWVhbnMgd2UgaGF2ZSBjb25uZWN0ZWQgYW5kIHN0YXJ0ZWRcbiAgICByZXR1cm4gISF0aGlzLnByb2M7XG4gIH1cblxuICBlbWl0TGluZXMgKHN0cmVhbSwgbGluZXMpIHtcbiAgICBmb3IgKGxldCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgICB0aGlzLmVtaXQoJ3N0cmVhbS1saW5lJywgYFske3N0cmVhbS50b1VwcGVyQ2FzZSgpfV0gJHtsaW5lfWApO1xuICAgIH1cbiAgfVxuXG4gIC8vIHNwYXduIHRoZSBzdWJwcm9jZXNzIGFuZCByZXR1cm4gY29udHJvbCB3aGVuZXZlciB3ZSBkZWVtIHRoYXQgaXQgaGFzIGZ1bGx5XG4gIC8vIFwic3RhcnRlZFwiXG4gIGFzeW5jIHN0YXJ0IChzdGFydERldGVjdG9yID0gbnVsbCwgdGltZW91dE1zID0gbnVsbCwgZGV0YWNoID0gZmFsc2UpIHtcbiAgICBsZXQgc3RhcnREZWxheSA9IDEwO1xuXG4gICAgY29uc3QgZ2VuZXJpY1N0YXJ0RGV0ZWN0b3IgPSBmdW5jdGlvbiBnZW5lcmljU3RhcnREZXRlY3RvciAoc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgIHJldHVybiBzdGRvdXQgfHwgc3RkZXJyO1xuICAgIH07XG5cbiAgICAvLyB0aGUgZGVmYXVsdCBzdGFydCBkZXRlY3RvciBzaW1wbHkgcmV0dXJucyB0cnVlIHdoZW4gd2UgZ2V0IGFueSBvdXRwdXRcbiAgICBpZiAoc3RhcnREZXRlY3RvciA9PT0gbnVsbCkge1xuICAgICAgc3RhcnREZXRlY3RvciA9IGdlbmVyaWNTdGFydERldGVjdG9yO1xuICAgIH1cblxuICAgIC8vIGlmIHRoZSB1c2VyIHBhc3NlcyBhIG51bWJlciwgdGhlbiB3ZSBzaW1wbHkgZGVsYXkgYSBjZXJ0YWluIGFtb3VudCBvZlxuICAgIC8vIHRpbWUgYmVmb3JlIHJldHVybmluZyBjb250cm9sLCByYXRoZXIgdGhhbiB3YWl0aW5nIGZvciBhIGNvbmRpdGlvblxuICAgIGlmIChfLmlzTnVtYmVyKHN0YXJ0RGV0ZWN0b3IpKSB7XG4gICAgICBzdGFydERlbGF5ID0gc3RhcnREZXRlY3RvcjtcbiAgICAgIHN0YXJ0RGV0ZWN0b3IgPSBudWxsO1xuICAgIH1cblxuICAgIC8vIGlmIHRoZSB1c2VyIHBhc3NlcyBpbiBhIGJvb2xlYW4gYXMgb25lIG9mIHRoZSBhcmd1bWVudHMsIHVzZSBpdCBmb3IgYGRldGFjaGBcbiAgICBpZiAoXy5pc0Jvb2xlYW4oc3RhcnREZXRlY3RvcikgJiYgc3RhcnREZXRlY3Rvcikge1xuICAgICAgaWYgKCF0aGlzLm9wdHMuZGV0YWNoZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZGV0YWNoIHByb2Nlc3MgdGhhdCBpcyBub3Qgc3RhcnRlZCB3aXRoICdkZXRhY2hlZCcgb3B0aW9uYCk7XG4gICAgICB9XG4gICAgICBkZXRhY2ggPSB0cnVlO1xuICAgICAgc3RhcnREZXRlY3RvciA9IGdlbmVyaWNTdGFydERldGVjdG9yO1xuICAgIH0gZWxzZSBpZiAoXy5pc0Jvb2xlYW4odGltZW91dE1zKSAmJiB0aW1lb3V0TXMpIHtcbiAgICAgIGlmICghdGhpcy5vcHRzLmRldGFjaGVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGRldGFjaCBwcm9jZXNzIHRoYXQgaXMgbm90IHN0YXJ0ZWQgd2l0aCAnZGV0YWNoZWQnIG9wdGlvbmApO1xuICAgICAgfVxuICAgICAgZGV0YWNoID0gdHJ1ZTtcbiAgICAgIHRpbWVvdXRNcyA9IG51bGw7XG4gICAgfVxuXG4gICAgLy8gcmV0dXJuIGEgcHJvbWlzZSBzbyB3ZSBjYW4gd3JhcCB0aGUgYXN5bmMgYmVoYXZpb3JcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gYWN0dWFsbHkgc3Bhd24gdGhlIHN1YnByb2NcbiAgICAgIHRoaXMucHJvYyA9IHNwYXduKHRoaXMuY21kLCB0aGlzLmFyZ3MsIHRoaXMub3B0cyk7XG5cbiAgICAgIGlmICh0aGlzLnByb2Muc3Rkb3V0KSB7XG4gICAgICAgIHRoaXMucHJvYy5zdGRvdXQuc2V0RW5jb2RpbmcodGhpcy5vcHRzLmVuY29kaW5nIHx8ICd1dGY4Jyk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5wcm9jLnN0ZGVycikge1xuICAgICAgICB0aGlzLnByb2Muc3RkZXJyLnNldEVuY29kaW5nKHRoaXMub3B0cy5lbmNvZGluZyB8fCAndXRmOCcpO1xuICAgICAgfVxuICAgICAgdGhpcy5sYXN0TGluZVBvcnRpb24gPSB7c3Rkb3V0OiAnJywgc3RkZXJyOiAnJ307XG5cbiAgICAgIC8vIHRoaXMgZnVuY3Rpb24gaGFuZGxlcyBvdXRwdXQgdGhhdCB3ZSBjb2xsZWN0IGZyb20gdGhlIHN1YnByb2NcbiAgICAgIGNvbnN0IGhhbmRsZU91dHB1dCA9IChkYXRhKSA9PiB7XG4gICAgICAgIC8vIGlmIHdlIGhhdmUgYSBzdGFydERldGVjdG9yLCBydW4gaXQgb24gdGhlIG91dHB1dCBzbyB3ZSBjYW4gcmVzb2x2ZS9cbiAgICAgICAgLy8gcmVqZWN0IGFuZCBtb3ZlIG9uIGZyb20gc3RhcnRcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBpZiAoc3RhcnREZXRlY3RvciAmJiBzdGFydERldGVjdG9yKGRhdGEuc3Rkb3V0LCBkYXRhLnN0ZGVycikpIHtcbiAgICAgICAgICAgIHN0YXJ0RGV0ZWN0b3IgPSBudWxsO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGVtaXQgdGhlIGFjdHVhbCBvdXRwdXQgZm9yIHdob21ldmVyJ3MgbGlzdGVuaW5nXG4gICAgICAgIHRoaXMuZW1pdCgnb3V0cHV0JywgZGF0YS5zdGRvdXQsIGRhdGEuc3RkZXJyKTtcblxuICAgICAgICAvLyB3ZSBhbHNvIHdhbnQgdG8gZW1pdCBsaW5lcywgYnV0IGl0J3MgbW9yZSBjb21wbGV4IHNpbmNlIG91dHB1dFxuICAgICAgICAvLyBjb21lcyBpbiBjaHVua3MgYW5kIGEgbGluZSBjb3VsZCBjb21lIGluIHR3byBkaWZmZXJlbnQgY2h1bmtzLCBzb1xuICAgICAgICAvLyB3ZSBoYXZlIGxvZ2ljIHRvIGhhbmRsZSB0aGF0IGNhc2UgKHVzaW5nIHRoaXMubGFzdExpbmVQb3J0aW9uIHRvXG4gICAgICAgIC8vIHJlbWVtYmVyIGEgbGluZSB0aGF0IHN0YXJ0ZWQgYnV0IGRpZCBub3QgZmluaXNoIGluIHRoZSBsYXN0IGNodW5rKVxuICAgICAgICBmb3IgKGNvbnN0IHN0cmVhbSBvZiBbJ3N0ZG91dCcsICdzdGRlcnInXSkge1xuICAgICAgICAgIGlmICghZGF0YVtzdHJlYW1dKSBjb250aW51ZTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgICAgICAgIGxldCBsaW5lcyA9IGRhdGFbc3RyZWFtXS5zcGxpdCgnXFxuJyk7XG4gICAgICAgICAgaWYgKGxpbmVzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIGxldCByZXRMaW5lcyA9IGxpbmVzLnNsaWNlKDAsIC0xKTtcbiAgICAgICAgICAgIHJldExpbmVzWzBdID0gdGhpcy5sYXN0TGluZVBvcnRpb25bc3RyZWFtXSArIHJldExpbmVzWzBdO1xuICAgICAgICAgICAgdGhpcy5sYXN0TGluZVBvcnRpb25bc3RyZWFtXSA9IGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgdGhpcy5lbWl0KGBsaW5lcy0ke3N0cmVhbX1gLCByZXRMaW5lcyk7XG4gICAgICAgICAgICB0aGlzLmVtaXRMaW5lcyhzdHJlYW0sIHJldExpbmVzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sYXN0TGluZVBvcnRpb25bc3RyZWFtXSArPSBsaW5lc1swXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIC8vIGlmIHdlIGdldCBhbiBlcnJvciBzcGF3bmluZyB0aGUgcHJvYywgcmVqZWN0IGFuZCBjbGVhbiB1cCB0aGUgcHJvY1xuICAgICAgdGhpcy5wcm9jLm9uKCdlcnJvcicsIGVyciA9PiB7XG4gICAgICAgIHRoaXMucHJvYy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4aXQnKTtcbiAgICAgICAgdGhpcy5wcm9jLmtpbGwoJ1NJR0lOVCcpO1xuXG4gICAgICAgIGlmIChlcnIuZXJybm8gPT09ICdFTk9FTlQnKSB7XG4gICAgICAgICAgZXJyID0gbmV3IEVycm9yKGBDb21tYW5kICcke3RoaXMuY21kfScgbm90IGZvdW5kLiBJcyBpdCBpbnN0YWxsZWQ/YCk7XG4gICAgICAgIH1cbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9KTtcblxuICAgICAgaWYgKHRoaXMucHJvYy5zdGRvdXQpIHtcbiAgICAgICAgdGhpcy5wcm9jLnN0ZG91dC5waXBlKHRocm91Z2goc3Rkb3V0ID0+IHtcbiAgICAgICAgICBoYW5kbGVPdXRwdXQoe3N0ZG91dCwgc3RkZXJyOiAnJ30pO1xuICAgICAgICB9KSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLnByb2Muc3RkZXJyKSB7XG4gICAgICAgIHRoaXMucHJvYy5zdGRlcnIucGlwZSh0aHJvdWdoKHN0ZGVyciA9PiB7XG4gICAgICAgICAgaGFuZGxlT3V0cHV0KHtzdGRvdXQ6ICcnLCBzdGRlcnJ9KTtcbiAgICAgICAgfSkpO1xuICAgICAgfVxuXG4gICAgICAvLyB3aGVuIHRoZSBwcm9jIGV4aXRzLCB3ZSBtaWdodCBzdGlsbCBoYXZlIGEgYnVmZmVyIG9mIGxpbmVzIHdlIHdlcmVcbiAgICAgIC8vIHdhaXRpbmcgb24gbW9yZSBjaHVua3MgdG8gY29tcGxldGUuIEdvIGFoZWFkIGFuZCBlbWl0IHRob3NlLCB0aGVuXG4gICAgICAvLyByZS1lbWl0IHRoZSBleGl0IHNvIGEgbGlzdGVuZXIgY2FuIGhhbmRsZSB0aGUgcG9zc2libHktdW5leHBlY3RlZCBleGl0XG4gICAgICB0aGlzLnByb2Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAgIHRoaXMuaGFuZGxlTGFzdExpbmVzKCk7XG5cbiAgICAgICAgdGhpcy5lbWl0KCdleGl0JywgY29kZSwgc2lnbmFsKTtcblxuICAgICAgICAvLyBpbiBhZGRpdGlvbiB0byB0aGUgYmFyZSBleGl0IGV2ZW50LCBhbHNvIGVtaXQgb25lIG9mIHRocmVlIG90aGVyXG4gICAgICAgIC8vIGV2ZW50cyB0aGF0IGNvbnRhaW4gbW9yZSBoZWxwZnVsIGluZm9ybWF0aW9uOlxuICAgICAgICAvLyAnc3RvcCc6IHdlIHN0b3BwZWQgdGhpc1xuICAgICAgICAvLyAnZGllJzogdGhlIHByb2Nlc3MgZW5kZWQgb3V0IG9mIG91ciBjb250cm9sIHdpdGggYSBub24temVybyBleGl0XG4gICAgICAgIC8vICdlbmQnOiB0aGUgcHJvY2VzcyBlbmRlZCBvdXQgb2Ygb3VyIGNvbnRyb2wgd2l0aCBhIHplcm8gZXhpdFxuICAgICAgICBsZXQgZXZlbnQgPSB0aGlzLmV4cGVjdGluZ0V4aXQgPyAnc3RvcCcgOiAnZGllJztcbiAgICAgICAgaWYgKCF0aGlzLmV4cGVjdGluZ0V4aXQgJiYgY29kZSA9PT0gMCkge1xuICAgICAgICAgIGV2ZW50ID0gJ2VuZCc7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lbWl0KGV2ZW50LCBjb2RlLCBzaWduYWwpO1xuXG4gICAgICAgIC8vIGZpbmFsbHkgY2xlYW4gdXAgdGhlIHByb2MgYW5kIG1ha2Ugc3VyZSB0byByZXNldCBvdXIgZXhpdFxuICAgICAgICAvLyBleHBlY3RhdGlvbnNcbiAgICAgICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICAgICAgdGhpcy5leHBlY3RpbmdFeGl0ID0gZmFsc2U7XG4gICAgICB9KTtcblxuICAgICAgLy8gaWYgdGhlIHVzZXIgaGFzbid0IGdpdmVuIHVzIGEgc3RhcnREZXRlY3RvciwgaW5zdGVhZCBqdXN0IHJlc29sdmVcbiAgICAgIC8vIHdoZW4gc3RhcnREZWxheSBtcyBoYXZlIHBhc3NlZFxuICAgICAgaWYgKCFzdGFydERldGVjdG9yKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyByZXNvbHZlKCk7IH0sIHN0YXJ0RGVsYXkpO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiB0aGUgdXNlciBoYXMgZ2l2ZW4gdXMgYSB0aW1lb3V0LCBzdGFydCB0aGUgY2xvY2sgZm9yIHJlamVjdGluZ1xuICAgICAgLy8gdGhlIHByb21pc2UgaWYgd2UgdGFrZSB0b28gbG9uZyB0byBzdGFydFxuICAgICAgaWYgKF8uaXNOdW1iZXIodGltZW91dE1zKSkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBUaGUgcHJvY2VzcyBkaWQgbm90IHN0YXJ0IHdpdGhpbiAke3RpbWVvdXRNc31tcyBgICtcbiAgICAgICAgICAgIGAoY21kOiAnJHt0aGlzLnJlcH0nKWApKTtcbiAgICAgICAgfSwgdGltZW91dE1zKTtcbiAgICAgIH1cbiAgICB9KS5maW5hbGx5KCgpID0+IHtcbiAgICAgIGlmIChkZXRhY2ggJiYgdGhpcy5wcm9jKSB7XG4gICAgICAgIHRoaXMucHJvYy51bnJlZigpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlTGFzdExpbmVzICgpIHtcbiAgICBmb3IgKGxldCBzdHJlYW0gb2YgWydzdGRvdXQnLCAnc3RkZXJyJ10pIHtcbiAgICAgIGlmICh0aGlzLmxhc3RMaW5lUG9ydGlvbltzdHJlYW1dKSB7XG4gICAgICAgIGNvbnN0IGxhc3RMaW5lcyA9IFt0aGlzLmxhc3RMaW5lUG9ydGlvbltzdHJlYW1dXTtcbiAgICAgICAgdGhpcy5lbWl0KGBsaW5lcy0ke3N0cmVhbX1gLCBsYXN0TGluZXMpO1xuICAgICAgICB0aGlzLmVtaXRMaW5lcyhzdHJlYW0sIGxhc3RMaW5lcyk7XG4gICAgICAgIHRoaXMubGFzdExpbmVQb3J0aW9uW3N0cmVhbV0gPSAnJztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBzdG9wIChzaWduYWwgPSAnU0lHVEVSTScsIHRpbWVvdXQgPSAxMDAwMCkge1xuICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2FuJ3Qgc3RvcCBwcm9jZXNzOyBpdCdzIG5vdCBjdXJyZW50bHkgcnVubmluZyAoY21kOiAnJHt0aGlzLnJlcH0nKWApO1xuICAgIH1cbiAgICAvLyBtYWtlIHN1cmUgdG8gZW1pdCBhbnkgZGF0YSBpbiBvdXIgbGluZXMgYnVmZmVyIHdoZW5ldmVyIHdlJ3JlIGRvbmUgd2l0aFxuICAgIC8vIHRoZSBwcm9jXG4gICAgdGhpcy5oYW5kbGVMYXN0TGluZXMoKTtcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5wcm9jLm9uKCdjbG9zZScsIHJlc29sdmUpO1xuICAgICAgdGhpcy5leHBlY3RpbmdFeGl0ID0gdHJ1ZTtcbiAgICAgIHRoaXMucHJvYy5raWxsKHNpZ25hbCk7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgUHJvY2VzcyBkaWRuJ3QgZW5kIGFmdGVyICR7dGltZW91dH1tcyAoY21kOiAnJHt0aGlzLnJlcH0nKWApKTtcbiAgICAgIH0sIHRpbWVvdXQpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgam9pbiAoYWxsb3dlZEV4aXRDb2RlcyA9IFswXSkge1xuICAgIGlmICghdGhpcy5pc1J1bm5pbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGpvaW4gcHJvY2VzczsgaXQgaXMgbm90IGN1cnJlbnRseSBydW5uaW5nIChjbWQ6ICcke3RoaXMucmVwfScpYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMucHJvYy5vbignZXhpdCcsIChjb2RlKSA9PiB7XG4gICAgICAgIGlmIChhbGxvd2VkRXhpdENvZGVzLmluZGV4T2YoY29kZSkgPT09IC0xKSB7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgUHJvY2VzcyBlbmRlZCB3aXRoIGV4aXRjb2RlICR7Y29kZX0gKGNtZDogJyR7dGhpcy5yZXB9JylgKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzb2x2ZShjb2RlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKlxuICAgKiBUaGlzIHdpbGwgb25seSB3b3JrIGlmIHRoZSBwcm9jZXNzIGlzIGNyZWF0ZWQgd2l0aCB0aGUgYGRldGFjaGVkYCBvcHRpb25cbiAgICovXG4gIGRldGFjaFByb2Nlc3MgKCkge1xuICAgIGlmICghdGhpcy5vcHRzLmRldGFjaGVkKSB7XG4gICAgICAvLyB0aGlzIG1lYW5zIHRoYXQgdGhlcmUgaXMgYSBtaXNjb25maWd1cmF0aW9uIGluIHRoZSBjYWxsaW5nIGNvZGVcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGRldGFjaCBwcm9jZXNzIHRoYXQgaXMgbm90IHN0YXJ0ZWQgd2l0aCAnZGV0YWNoZWQnIG9wdGlvbmApO1xuICAgIH1cbiAgICBpZiAodGhpcy5wcm9jKSB7XG4gICAgICB0aGlzLnByb2MudW5yZWYoKTtcbiAgICB9XG4gIH1cblxuICBnZXQgcGlkICgpIHtcbiAgICByZXR1cm4gdGhpcy5wcm9jID8gdGhpcy5wcm9jLnBpZCA6IG51bGw7XG4gIH1cbn1cblxuZXhwb3J0IHsgU3ViUHJvY2VzcyB9O1xuZXhwb3J0IGRlZmF1bHQgU3ViUHJvY2VzcztcbiJdLCJmaWxlIjoibGliL3N1YnByb2Nlc3MuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
