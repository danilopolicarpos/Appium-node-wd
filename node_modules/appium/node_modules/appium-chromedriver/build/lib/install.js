"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.install = install;
exports.installAll = installAll;
exports.conditionalInstall = conditionalInstall;
exports.doInstall = doInstall;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _chromedriver = require("./chromedriver");

var _utils = require("./utils");

var _fancyLog = _interopRequireDefault(require("fancy-log"));

var _semver = _interopRequireDefault(require("semver"));

function log(line) {
  (0, _fancyLog.default)(`[Chromedriver Install] ${line}`);
}

const CD_CDN = process.env.npm_config_chromedriver_cdnurl || process.env.CHROMEDRIVER_CDNURL || 'https://chromedriver.storage.googleapis.com';
const CD_PLATS = ['linux', 'win', 'mac'];
const CD_ARCHS = ['32', '64'];

async function getArchAndPlatform() {
  let arch = await _appiumSupport.system.arch();
  let platform = (0, _utils.getCurPlatform)();

  if (platform !== 'linux' && platform !== 'mac') {
    arch = '32';
  }

  const cdVer = _semver.default.coerce(_chromedriver.CD_VER);

  if (platform === 'mac' && _semver.default.lt(cdVer, _utils.MAC_32_ONLY)) {
    arch = '32';
  }

  return {
    arch,
    platform
  };
}

function getDownloadUrl(version, platform, arch) {
  return `${CD_CDN}/${version}/chromedriver_${platform}${arch}.zip`;
}

function validatePlatform(platform, arch) {
  if (!_lodash.default.includes(CD_PLATS, platform)) {
    throw new Error(`Invalid platform: ${platform}`);
  }

  if (!_lodash.default.includes(CD_ARCHS, arch)) {
    throw new Error(`Invalid arch: ${arch}`);
  }

  if (arch === '64' && platform !== 'linux' && platform !== 'mac') {
    throw new Error('Only linux has a 64-bit version of Chromedriver');
  }
}

async function installForPlatform(version, platform, arch) {
  if (version === 'LATEST') {
    version = (await _requestPromise.default.get({
      uri: `${CD_CDN}/LATEST_RELEASE`
    })).trim();
  }

  validatePlatform(platform, arch);
  const url = getDownloadUrl(version, platform, arch);
  log(`Installing Chromedriver version '${version}' for platform '${platform}' and architecture '${arch}'`);
  const binarySpec = `chromedriver_${platform}${arch}`;
  log(`Opening temp file to write '${binarySpec}' to...`);
  const tempFile = await _appiumSupport.tempDir.open({
    prefix: binarySpec,
    suffix: '.zip'
  });
  log(`Opened temp file '${tempFile.path}'`);
  log(`Downloading ${url}...`);
  const body = await _requestPromise.default.get({
    url,
    encoding: 'binary'
  });
  log(`Writing binary content to ${tempFile.path}...`);
  await _appiumSupport.fs.writeFile(tempFile.path, body, {
    encoding: 'binary'
  });
  await _appiumSupport.fs.chmod(tempFile.path, 0o0644);

  const tempUnzipped = _path.default.resolve(_path.default.dirname(tempFile.path), binarySpec);

  log(`Extracting ${tempFile.path} to ${tempUnzipped}`);
  await (0, _appiumSupport.mkdirp)(tempUnzipped);
  await _appiumSupport.zip.extractAllTo(tempFile.path, tempUnzipped);

  let extractedBin = _path.default.resolve(tempUnzipped, 'chromedriver');

  if (platform === 'win') {
    extractedBin += '.exe';
  }

  log(`Creating ${_path.default.resolve(_utils.CD_BASE_DIR, platform)}...`);
  await (0, _appiumSupport.mkdirp)(_path.default.resolve(_utils.CD_BASE_DIR, platform));
  const newBin = await (0, _utils.getChromedriverBinaryPath)(platform, arch);
  log(`Copying unzipped binary, reading from ${extractedBin}...`);
  const binContents = await _appiumSupport.fs.readFile(extractedBin, {
    encoding: 'binary'
  });
  log(`Writing to ${newBin}...`);
  await _appiumSupport.fs.writeFile(newBin, binContents, {
    encoding: 'binary',
    mode: 0o755
  });
  log(`${newBin} successfully put in place`);
}

async function install() {
  const {
    arch,
    platform
  } = await getArchAndPlatform();
  await installForPlatform(_chromedriver.CD_VER, platform, arch);
}

async function conditionalInstall() {
  const {
    arch,
    platform
  } = await getArchAndPlatform();
  const binPath = await (0, _utils.getChromedriverBinaryPath)(platform, arch);

  if (!(await _appiumSupport.fs.exists(binPath))) {
    await installForPlatform(_chromedriver.CD_VER, platform, arch);
  } else {
    log(`No need to install chromedriver, ${binPath} exists`);
  }
}

async function installAll() {
  let downloads = [];

  for (let [platform, arch] of (0, _utils.getPlatforms)()) {
    downloads.push(installForPlatform(_chromedriver.CD_VER, platform, arch));
  }

  await (0, _asyncbox.parallel)(downloads);
}

async function doInstall() {
  if (_lodash.default.includes(process.argv, '--all') || process.env.npm_config_chromedriver_install_all) {
    await installAll();
  } else if (_lodash.default.includes(process.argv, '--conditional')) {
    await conditionalInstall();
  } else {
    await install();
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsLmpzIl0sIm5hbWVzIjpbImxvZyIsImxpbmUiLCJDRF9DRE4iLCJwcm9jZXNzIiwiZW52IiwibnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfY2RudXJsIiwiQ0hST01FRFJJVkVSX0NETlVSTCIsIkNEX1BMQVRTIiwiQ0RfQVJDSFMiLCJnZXRBcmNoQW5kUGxhdGZvcm0iLCJhcmNoIiwic3lzdGVtIiwicGxhdGZvcm0iLCJjZFZlciIsInNlbXZlciIsImNvZXJjZSIsIkNEX1ZFUiIsImx0IiwiTUFDXzMyX09OTFkiLCJnZXREb3dubG9hZFVybCIsInZlcnNpb24iLCJ2YWxpZGF0ZVBsYXRmb3JtIiwiXyIsImluY2x1ZGVzIiwiRXJyb3IiLCJpbnN0YWxsRm9yUGxhdGZvcm0iLCJyZXF1ZXN0IiwiZ2V0IiwidXJpIiwidHJpbSIsInVybCIsImJpbmFyeVNwZWMiLCJ0ZW1wRmlsZSIsInRlbXBEaXIiLCJvcGVuIiwicHJlZml4Iiwic3VmZml4IiwicGF0aCIsImJvZHkiLCJlbmNvZGluZyIsImZzIiwid3JpdGVGaWxlIiwiY2htb2QiLCJ0ZW1wVW56aXBwZWQiLCJyZXNvbHZlIiwiZGlybmFtZSIsInppcCIsImV4dHJhY3RBbGxUbyIsImV4dHJhY3RlZEJpbiIsIkNEX0JBU0VfRElSIiwibmV3QmluIiwiYmluQ29udGVudHMiLCJyZWFkRmlsZSIsIm1vZGUiLCJpbnN0YWxsIiwiY29uZGl0aW9uYWxJbnN0YWxsIiwiYmluUGF0aCIsImV4aXN0cyIsImluc3RhbGxBbGwiLCJkb3dubG9hZHMiLCJwdXNoIiwiZG9JbnN0YWxsIiwiYXJndiIsIm5wbV9jb25maWdfY2hyb21lZHJpdmVyX2luc3RhbGxfYWxsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUdBLFNBQVNBLEdBQVQsQ0FBY0MsSUFBZCxFQUFvQjtBQUNsQix5QkFBUSwwQkFBeUJB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b0JBQUQsRUFBU0osUUFBVCxFQUFtQkYsSUFBbkIsQ0FBeEI7QUFDRCxHQUZELE1BRU87QUFDTFYsSUFBQUEsR0FBRyxDQUFFLG9DQUFtQ3dELE9BQVEsU0FBN0MsQ0FBSDtBQUNEO0FBQ0Y7O0FBRUQsZUFBZUUsVUFBZixHQUE2QjtBQUMzQixNQUFJQyxTQUFTLEdBQUcsRUFBaEI7O0FBQ0EsT0FBSyxJQUFJLENBQUMvQyxRQUFELEVBQVdGLElBQVgsQ0FBVCxJQUE2QiwwQkFBN0IsRUFBNkM7QUFDM0NpRCxJQUFBQSxTQUFTLENBQUNDLElBQVYsQ0FBZW5DLGtCQUFrQixDQUFDVCxvQkFBRCxFQUFTSixRQUFULEVBQW1CRixJQUFuQixDQUFqQztBQUNEOztBQUNELFFBQU0sd0JBQUdpRCxTQUFILENBQU47QUFDRDs7QUFFRCxlQUFlRSxTQUFmLEdBQTRCO0FBQzFCLE1BQUl2QyxnQkFBRUMsUUFBRixDQUFXcEIsT0FBTyxDQUFDMkQsSUFBbkIsRUFBeUIsT0FBekIsS0FDQTNELE9BQU8sQ0FBQ0MsR0FBUixDQUFZMkQsbUNBRGhCLEVBQ3FEO0FBQ25ELFVBQU1MLFVBQVUsRUFBaEI7QUFDRCxHQUhELE1BR08sSUFBSXBDLGdCQUFFQyxRQUFGLENBQVdwQixPQUFPLENBQUMyRCxJQUFuQixFQUF5QixlQUF6QixDQUFKLEVBQStDO0FBQ3BELFVBQU1QLGtCQUFrQixFQUF4QjtBQUNELEdBRk0sTUFFQTtBQUNMLFVBQU1ELE9BQU8sRUFBYjtBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHsgcGFyYWxsZWwgYXMgbGwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBzeXN0ZW0sIHRlbXBEaXIsIGZzLCB6aXAsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IENEX1ZFUiB9IGZyb20gJy4vY2hyb21lZHJpdmVyJztcbmltcG9ydCB7IENEX0JBU0VfRElSLCBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoLCBnZXRDdXJQbGF0Zm9ybSxcbiAgICAgICAgIGdldFBsYXRmb3JtcywgTUFDXzMyX09OTFkgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnZmFuY3ktbG9nJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcblxuXG5mdW5jdGlvbiBsb2cgKGxpbmUpIHtcbiAgbG9nZ2VyKGBbQ2hyb21lZHJpdmVyIEluc3RhbGxdICR7bGluZX1gKTtcbn1cblxuY29uc3QgQ0RfQ0ROID0gcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfY2RudXJsIHx8XG4gICAgICAgICAgICAgICBwcm9jZXNzLmVudi5DSFJPTUVEUklWRVJfQ0ROVVJMIHx8XG4gICAgICAgICAgICAgICAnaHR0cHM6Ly9jaHJvbWVkcml2ZXIuc3RvcmFnZS5nb29nbGVhcGlzLmNvbSc7XG5jb25zdCBDRF9QTEFUUyA9IFsnbGludXgnLCAnd2luJywgJ21hYyddO1xuY29uc3QgQ0RfQVJDSFMgPSBbJzMyJywgJzY0J107XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFyY2hBbmRQbGF0Zm9ybSAoKSB7XG4gIGxldCBhcmNoID0gYXdhaXQgc3lzdGVtLmFyY2goKTtcbiAgbGV0IHBsYXRmb3JtID0gZ2V0Q3VyUGxhdGZvcm0oKTtcbiAgaWYgKHBsYXRmb3JtICE9PSAnbGludXgnICYmIHBsYXRmb3JtICE9PSAnbWFjJykge1xuICAgIGFyY2ggPSAnMzInO1xuICB9XG5cbiAgY29uc3QgY2RWZXIgPSBzZW12ZXIuY29lcmNlKENEX1ZFUik7XG4gIGlmIChwbGF0Zm9ybSA9PT0gJ21hYycgJiYgc2VtdmVyLmx0KGNkVmVyLCBNQUNfMzJfT05MWSkpIHtcbiAgICBhcmNoID0gJzMyJztcbiAgfVxuICByZXR1cm4ge2FyY2gsIHBsYXRmb3JtfTtcbn1cblxuZnVuY3Rpb24gZ2V0RG93bmxvYWRVcmwgKHZlcnNpb24sIHBsYXRmb3JtLCBhcmNoKSB7XG4gIHJldHVybiBgJHtDRF9DRE59LyR7dmVyc2lvbn0vY2hyb21lZHJpdmVyXyR7cGxhdGZvcm19JHthcmNofS56aXBgO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZVBsYXRmb3JtIChwbGF0Zm9ybSwgYXJjaCkge1xuICBpZiAoIV8uaW5jbHVkZXMoQ0RfUExBVFMsIHBsYXRmb3JtKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwbGF0Zm9ybTogJHtwbGF0Zm9ybX1gKTtcbiAgfVxuICBpZiAoIV8uaW5jbHVkZXMoQ0RfQVJDSFMsIGFyY2gpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGFyY2g6ICR7YXJjaH1gKTtcbiAgfVxuICBpZiAoYXJjaCA9PT0gJzY0JyAmJiBwbGF0Zm9ybSAhPT0gJ2xpbnV4JyAmJiBwbGF0Zm9ybSAhPT0gJ21hYycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ09ubHkgbGludXggaGFzIGEgNjQtYml0IHZlcnNpb24gb2YgQ2hyb21lZHJpdmVyJyk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbEZvclBsYXRmb3JtICh2ZXJzaW9uLCBwbGF0Zm9ybSwgYXJjaCkge1xuICBpZiAodmVyc2lvbiA9PT0gJ0xBVEVTVCcpIHtcbiAgICB2ZXJzaW9uID0gKGF3YWl0IHJlcXVlc3QuZ2V0KHt1cmk6IGAke0NEX0NETn0vTEFURVNUX1JFTEVBU0VgfSkpLnRyaW0oKTtcbiAgfVxuICB2YWxpZGF0ZVBsYXRmb3JtKHBsYXRmb3JtLCBhcmNoKTtcblxuICBjb25zdCB1cmwgPSBnZXREb3dubG9hZFVybCh2ZXJzaW9uLCBwbGF0Zm9ybSwgYXJjaCk7XG5cbiAgbG9nKGBJbnN0YWxsaW5nIENocm9tZWRyaXZlciB2ZXJzaW9uICcke3ZlcnNpb259JyBmb3IgcGxhdGZvcm0gJyR7cGxhdGZvcm19JyBhbmQgYXJjaGl0ZWN0dXJlICcke2FyY2h9J2ApO1xuXG4gIC8vIHNldCB1cCBhIHRlbXAgZmlsZSB0byBkb3dubG9hZCB0aGUgY2hyb21lZHJpdmVyIHppcGZpbGUgdG9cbiAgY29uc3QgYmluYXJ5U3BlYyA9IGBjaHJvbWVkcml2ZXJfJHtwbGF0Zm9ybX0ke2FyY2h9YDtcbiAgbG9nKGBPcGVuaW5nIHRlbXAgZmlsZSB0byB3cml0ZSAnJHtiaW5hcnlTcGVjfScgdG8uLi5gKTtcbiAgY29uc3QgdGVtcEZpbGUgPSBhd2FpdCB0ZW1wRGlyLm9wZW4oe1xuICAgIHByZWZpeDogYmluYXJ5U3BlYyxcbiAgICBzdWZmaXg6ICcuemlwJ1xuICB9KTtcbiAgbG9nKGBPcGVuZWQgdGVtcCBmaWxlICcke3RlbXBGaWxlLnBhdGh9J2ApO1xuXG4gIC8vIGFjdHVhbGx5IGRvd25sb2FkIHRoZSB6aXBmaWxlIGFuZCB3cml0ZSBpdCB3aXRoIGFwcHJvcHJpYXRlIHBlcm1zXG4gIGxvZyhgRG93bmxvYWRpbmcgJHt1cmx9Li4uYCk7XG4gIGNvbnN0IGJvZHkgPSBhd2FpdCByZXF1ZXN0LmdldCh7dXJsLCBlbmNvZGluZzogJ2JpbmFyeSd9KTtcbiAgbG9nKGBXcml0aW5nIGJpbmFyeSBjb250ZW50IHRvICR7dGVtcEZpbGUucGF0aH0uLi5gKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBGaWxlLnBhdGgsIGJvZHksIHtlbmNvZGluZzogJ2JpbmFyeSd9KTtcbiAgYXdhaXQgZnMuY2htb2QodGVtcEZpbGUucGF0aCwgMG8wNjQ0KTtcblxuICAvLyBleHRyYWN0IGRvd25sb2FkZWQgemlwZmlsZSB0byB0ZW1wZGlyXG4gIGNvbnN0IHRlbXBVbnppcHBlZCA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUodGVtcEZpbGUucGF0aCksIGJpbmFyeVNwZWMpO1xuICBsb2coYEV4dHJhY3RpbmcgJHt0ZW1wRmlsZS5wYXRofSB0byAke3RlbXBVbnppcHBlZH1gKTtcbiAgYXdhaXQgbWtkaXJwKHRlbXBVbnppcHBlZCk7XG4gIGF3YWl0IHppcC5leHRyYWN0QWxsVG8odGVtcEZpbGUucGF0aCwgdGVtcFVuemlwcGVkKTtcbiAgbGV0IGV4dHJhY3RlZEJpbiA9IHBhdGgucmVzb2x2ZSh0ZW1wVW56aXBwZWQsICdjaHJvbWVkcml2ZXInKTtcbiAgaWYgKHBsYXRmb3JtID09PSAnd2luJykge1xuICAgIGV4dHJhY3RlZEJpbiArPSAnLmV4ZSc7XG4gIH1cblxuICAvLyBtYWtlIGJ1aWxkIGRpcnMgdGhhdCB3aWxsIGhvbGQgdGhlIGNocm9tZWRyaXZlciBiaW5hcnlcbiAgbG9nKGBDcmVhdGluZyAke3BhdGgucmVzb2x2ZShDRF9CQVNFX0RJUiwgcGxhdGZvcm0pfS4uLmApO1xuICBhd2FpdCBta2RpcnAocGF0aC5yZXNvbHZlKENEX0JBU0VfRElSLCBwbGF0Zm9ybSkpO1xuXG4gIC8vIGNvcHkgdGhlIGV4dHJhY3RlZCBiaW5hcnkgdG8gdGhlIGNvcnJlY3QgYnVpbGQgZGlyXG4gIGNvbnN0IG5ld0JpbiA9IGF3YWl0IGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgocGxhdGZvcm0sIGFyY2gpO1xuICBsb2coYENvcHlpbmcgdW56aXBwZWQgYmluYXJ5LCByZWFkaW5nIGZyb20gJHtleHRyYWN0ZWRCaW59Li4uYCk7XG4gIGNvbnN0IGJpbkNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUoZXh0cmFjdGVkQmluLCB7ZW5jb2Rpbmc6ICdiaW5hcnknfSk7XG4gIGxvZyhgV3JpdGluZyB0byAke25ld0Jpbn0uLi5gKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKG5ld0JpbiwgYmluQ29udGVudHMsIHtlbmNvZGluZzogJ2JpbmFyeScsIG1vZGU6IDBvNzU1fSk7XG4gIGxvZyhgJHtuZXdCaW59IHN1Y2Nlc3NmdWxseSBwdXQgaW4gcGxhY2VgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbCAoKSB7XG4gIGNvbnN0IHthcmNoLCBwbGF0Zm9ybX0gPSBhd2FpdCBnZXRBcmNoQW5kUGxhdGZvcm0oKTtcbiAgYXdhaXQgaW5zdGFsbEZvclBsYXRmb3JtKENEX1ZFUiwgcGxhdGZvcm0sIGFyY2gpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjb25kaXRpb25hbEluc3RhbGwgKCkge1xuICBjb25zdCB7YXJjaCwgcGxhdGZvcm19ID0gYXdhaXQgZ2V0QXJjaEFuZFBsYXRmb3JtKCk7XG4gIGNvbnN0IGJpblBhdGggPSBhd2FpdCBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoKHBsYXRmb3JtLCBhcmNoKTtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoYmluUGF0aCkpIHtcbiAgICBhd2FpdCBpbnN0YWxsRm9yUGxhdGZvcm0oQ0RfVkVSLCBwbGF0Zm9ybSwgYXJjaCk7XG4gIH0gZWxzZSB7XG4gICAgbG9nKGBObyBuZWVkIHRvIGluc3RhbGwgY2hyb21lZHJpdmVyLCAke2JpblBhdGh9IGV4aXN0c2ApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxBbGwgKCkge1xuICBsZXQgZG93bmxvYWRzID0gW107XG4gIGZvciAobGV0IFtwbGF0Zm9ybSwgYXJjaF0gb2YgZ2V0UGxhdGZvcm1zKCkpIHtcbiAgICBkb3dubG9hZHMucHVzaChpbnN0YWxsRm9yUGxhdGZvcm0oQ0RfVkVSLCBwbGF0Zm9ybSwgYXJjaCkpO1xuICB9XG4gIGF3YWl0IGxsKGRvd25sb2Fkcyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRvSW5zdGFsbCAoKSB7XG4gIGlmIChfLmluY2x1ZGVzKHByb2Nlc3MuYXJndiwgJy0tYWxsJykgfHxcbiAgICAgIHByb2Nlc3MuZW52Lm5wbV9jb25maWdfY2hyb21lZHJpdmVyX2luc3RhbGxfYWxsKSB7XG4gICAgYXdhaXQgaW5zdGFsbEFsbCgpO1xuICB9IGVsc2UgaWYgKF8uaW5jbHVkZXMocHJvY2Vzcy5hcmd2LCAnLS1jb25kaXRpb25hbCcpKSB7XG4gICAgYXdhaXQgY29uZGl0aW9uYWxJbnN0YWxsKCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgaW5zdGFsbCgpO1xuICB9XG59XG5cbmV4cG9ydCB7IGluc3RhbGwsIGluc3RhbGxBbGwsIGNvbmRpdGlvbmFsSW5zdGFsbCwgZG9JbnN0YWxsIH07XG4iXSwiZmlsZSI6ImxpYi9pbnN0YWxsLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
