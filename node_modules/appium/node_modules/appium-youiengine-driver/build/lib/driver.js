"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.YouiEngineDriver = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _desiredCaps = require("./desired-caps");

var _logger = _interopRequireDefault(require("./logger"));

var _commands = _interopRequireDefault(require("./commands"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _asyncbox = require("asyncbox");

var _appiumAndroidDriver = _interopRequireDefault(require("appium-android-driver"));

var _appiumIosDriver = _interopRequireDefault(require("appium-ios-driver"));

var _appiumXcuitestDriver = _interopRequireDefault(require("appium-xcuitest-driver"));

var _appiumMacDriver = _interopRequireDefault(require("appium-mac-driver"));

var _bluesky = _interopRequireDefault(require("./bluesky"));

var _tvos = _interopRequireDefault(require("./tvos"));

var _tvossimulator = _interopRequireDefault(require("./tvossimulator"));

var _yimac = _interopRequireDefault(require("./yimac"));

const TO_PROXY_COMMON = ['background', 'closeApp', 'getLog', 'getLogTypes', 'getOrientation', 'getStrings', 'installApp', 'launchApp', 'lock', 'removeApp', 'setOrientation'];
const TO_PROXY_IOS_ONLY = ['mobileShake'];
const TO_PROXY_ANDROID_ONLY = ['getNetworkConnection', 'isAppInstalled', 'isLocked', 'longPressKeyCode', 'pressKeyCode', 'setNetworkConnection', 'toggleLocationServices', 'unlock'];
const TO_PROXY_IOS = TO_PROXY_IOS_ONLY.concat(TO_PROXY_COMMON);
const TO_PROXY_ANDROID = TO_PROXY_ANDROID_ONLY.concat(TO_PROXY_COMMON);
const TO_PROXY_MAC = TO_PROXY_COMMON;
const MAX_RETRY_COUNT = 10;
const RETRY_BACKOFF = 3000;

class YouiEngineDriver extends _appiumBaseDriver.BaseDriver {
  resetYouiEngine() {
    this.ready = false;
    this.socket = null;
    this.locatorStrategies = ['id', 'name', 'class name', 'accessibility id'];
    this.proxydriver = null;
    this.proxyAllowList = '';
    this.device = null;
  }

  constructor(opts, shouldValidateCaps) {
    super(opts, shouldValidateCaps);
    this.desiredCapConstraints = _desiredCaps.desiredCapConstraints;
    this.settings = new _appiumBaseDriver.DeviceSettings({
      'TimeDilation': 1,
      'SourceTreeFilter': ''
    }, this.onSettingsUpdate.bind(this));
    this.resetYouiEngine();
  }

  validateLocatorStrategy(strategy) {
    super.validateLocatorStrategy(strategy, false);
  }

  async createSession(caps) {
    try {
      let [sessionId] = await super.createSession(caps);

      if (caps.platformName !== null) {
        let appPlatform = caps.platformName.toLowerCase();

        switch (appPlatform) {
          case 'ios':
            await this.startIOSSession(caps);
            break;

          case 'android':
            await this.startAndroidSession(caps);
            break;

          case 'mac':
            await this.startMacSession(caps);
            break;

          case 'yimac':
            this.device = new _yimac.default();
            await this.device.startSession(caps);
            break;

          case 'bluesky':
            this.device = new _bluesky.default();
            await this.device.startSession(caps);
            break;

          case 'yitvos':
            {
              let shell = require('shelljs');

              if (shell.exec(`instruments -s devices | grep '${caps.udid}'`).includes('(Simulator)')) {
                this.device = new _tvossimulator.default();
              } else {
                this.device = new _tvos.default();
              }

              await this.device.startSession(caps, this);
              break;
            }

          case 'noproxy':
          case 'connecttoapp':
            break;

          default:
            _logger.default.errorAndThrow(`Unsupported platformName: ${caps.platformName}`);

        }
      }

      await this.connectSocket();

      if (caps.fullSourceTree === true) {} else {
        await this.updateSettings({
          SourceTreeFilter: "[@isDisplayed='true']"
        });
      }

      return [sessionId, this.opts];
    } catch (e) {
      await this.deleteSession();
      throw e;
    }
  }

  async onSettingsUpdate(key, value) {
    if (key === 'TimeDilation') {
      await this.setTimeDilation(value);
    } else if (key === 'SourceTreeFilter') {
      await this.setSourceTreeFilter(value);
    }
  }

  async stop() {
    this.ready = false;
  }

  async deleteSession() {
    _logger.default.debug('Deleting YouiEngine session');

    if (this.caps.platformName !== null) {
      let appPlatform = this.caps.platformName.toLowerCase();

      if (['yimac', 'yitvos', 'bluesky'].includes(appPlatform)) {
        if (this.device) {
          this.device.endSession();
        }
      }
    }

    if (this.proxydriver !== null) {
      await this.proxydriver.deleteSession();
    }

    await super.deleteSession();
    await this.stop();
  }

  driverShouldDoProxyCmd(command) {
    if (!this.proxydriver) {
      return false;
    }

    for (let allowedCommand of this.proxyAllowList) {
      if (allowedCommand === command) {
        return true;
      }
    }

    return false;
  }

  async executeCommand(cmd, ...args) {
    if (cmd === 'receiveAsyncResponse') {
      _logger.default.debug(`Executing YouiEngineDriver response '${cmd}'`);

      return await this.receiveAsyncResponse(...args);
    } else if (this.ready) {
      if (this.driverShouldDoProxyCmd(cmd)) {
        _logger.default.debug(`Executing proxied WebDriver command '${cmd}'`);

        this.clearNewCommandTimeout();
        let result = this.proxydriver.executeCommand(cmd, ...args);
        this.startNewCommandTimeout(cmd);
        return result;
      } else {
        _logger.default.debug(`Executing YouiEngine WebDriver command '${cmd}'`);

        return super.executeCommand(cmd, ...args);
      }
    } else {
      _logger.default.debug(`Command Error '${cmd}'`);

      throw new _appiumBaseDriver.errors.NoSuchDriverError(`Driver is not ready, cannot execute ${cmd}.`);
    }
  }

  validateDesiredCaps(caps) {
    let res = super.validateDesiredCaps(caps);

    if (!res) {
      return res;
    }

    if (!caps.youiEngineAppAddress) {
      let msg = 'The desired capabilities must include youiEngineAppAddress';

      _logger.default.errorAndThrow(msg);
    }

    if (caps.platformName.toLowerCase() !== 'connecttoapp' && caps.platformName.toLowerCase() !== 'noproxy') {
      if (!caps.app) {
        let msg = 'The desired capabilities must include app';

        _logger.default.errorAndThrow(msg);
      }

      const fs = require('fs');

      const path = require('path');

      if (!fs.existsSync(caps.app)) {
        let absolutepath = path.resolve(caps.app);
        let msg = 'The app could not be found in following location: ' + absolutepath;

        _logger.default.errorAndThrow(msg);
      }

      if (caps.deviceName.toLowerCase() === 'android') {
        if (!caps.avd) {
          let msg = 'The desired capabilities must include avd';

          _logger.default.errorAndThrow(msg);
        }
      }
    }

    return true;
  }

  async setupNewIOSDriver(caps) {
    let iosArgs = {
      javascriptEnabled: true
    };
    let iosdriver = new _appiumXcuitestDriver.default(iosArgs);

    if (caps.platformVersion) {
      let majorVer = caps.platformVersion.toString().split('.')[0];

      if (parseInt(majorVer, 10) < 10) {
        iosdriver = new _appiumIosDriver.default(iosArgs);
      }
    }

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await iosdriver.createSession(capsCopy);
    return iosdriver;
  }

  async startIOSSession(caps) {
    _logger.default.info('Starting an IOS proxy session');

    this.proxyAllowList = TO_PROXY_IOS;
    this.proxydriver = await this.setupNewIOSDriver(caps);
  }

  async setupNewAndroidDriver(caps) {
    let androidArgs = {
      javascriptEnabled: true
    };
    let androiddriver = new _appiumAndroidDriver.default(androidArgs);

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await androiddriver.createSession(capsCopy);
    return androiddriver;
  }

  async startAndroidSession(caps) {
    _logger.default.info('Starting an Android proxy session');

    this.proxyAllowList = TO_PROXY_ANDROID;
    this.proxydriver = await this.setupNewAndroidDriver(caps);
  }

  async setupNewMacDriver(caps) {
    let macArgs = {
      javascriptEnabled: true
    };
    let macdriver = new _appiumMacDriver.default(macArgs);

    let capsCopy = _lodash.default.cloneDeep(caps);

    capsCopy.newCommandTimeout = 0;
    await macdriver.createSession(capsCopy);
    return macdriver;
  }

  async startMacSession(caps) {
    _logger.default.info('Starting a Mac proxy session');

    this.proxyAllowList = TO_PROXY_MAC;
    this.proxydriver = await this.setupNewMacDriver(caps);
  }

  async connectSocket() {
    let retryCount = 0;
    let connected = false;

    while (retryCount < MAX_RETRY_COUNT && !connected) {
      if (retryCount > 0) {
        _logger.default.info('Waiting ' + RETRY_BACKOFF / 1000 + ' seconds before trying...');

        await (0, _asyncbox.sleep)(RETRY_BACKOFF);
      }

      _logger.default.info('Attempt #' + (retryCount + 1));

      let connectedPromise = new _bluebird.default(resolve => {
        let net = require('net');

        let HOST = this.opts.youiEngineAppAddress;
        let PORT;

        if (this.caps.youiEngineAppPort) {
          PORT = this.caps.youiEngineAppPort;
        } else if (this.caps.platformName.toLowerCase() === 'yips4') {
          PORT = 40123;
        } else {
          PORT = 12345;
        }

        {
          _logger.default.info('Connecting to WebDriver: ' + HOST + ':' + PORT);
        }
        this.socket = new net.Socket();
        this.socket.on('error', function (ex) {
          _logger.default.error(ex);

          _logger.default.error('Check that WebDriver is enabled in application, if a device ensure the proper IP address is used.');

          resolve(false);
        });
        this.socket.on('close', function () {
          _logger.default.info('Connection closed');
        });
        this.socket.on('timeout', function () {
          _logger.default.error('Connection timed out');

          resolve(false);
        });
        this.socket.connect(PORT, HOST, function () {
          _logger.default.info('Connected');

          resolve(true);
        });
      });
      retryCount++;
      connected = await connectedPromise;

      if (!connected && retryCount === MAX_RETRY_COUNT - 1) {
        _logger.default.errorAndThrow('Failed to connect ' + MAX_RETRY_COUNT + ' times. Aborting.');
      }
    }

    retryCount = 0;
    this.ready = connected;
  }

  async executeSocketCommand(cmd) {
    if (!this.socket.writable) {
      _logger.default.info('Socket is not writable. Trying to reconnect.');

      await this.connectSocket();
    }

    let cmdPromise = new _bluebird.default(resolve => {
      _logger.default.debug('COMMAND: ' + cmd);

      let totaldata = [];
      let endMarker = new Buffer('youiend');
      let socketClient = this.socket;

      let dataHandler = function (data) {
        if (data.length >= endMarker.length) {
          let dataend = new Buffer(endMarker.length);
          let startIndex = data.length - endMarker.length;
          data.copy(dataend, 0, startIndex, startIndex + endMarker.length);

          if (dataend.equals(endMarker)) {
            let lastData = data.slice(0, startIndex);
            totaldata.push(lastData);
            socketClient.removeListener('data', dataHandler);
            resolve(Buffer.concat(totaldata));
          } else {
            totaldata.push(data);
          }
        }
      };

      socketClient.write(cmd + '\n', 'UTF8', () => {
        socketClient.on('data', dataHandler);
      });
    });
    return await cmdPromise;
  }

}

exports.YouiEngineDriver = YouiEngineDriver;

for (let [cmd, fn] of _lodash.default.toPairs(_commands.default)) {
  YouiEngineDriver.prototype[cmd] = fn;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOlsiVE9fUFJPWFlfQ09NTU9OIiwiVE9fUFJPWFlfSU9TX09OTFkiLCJUT19QUk9YWV9BTkRST0lEX09OTFkiLCJUT19QUk9YWV9JT1MiLCJjb25jYXQiLCJUT19QUk9YWV9BTkRST0lEIiwiVE9fUFJPWFlfTUFDIiwiTUFYX1JFVFJZX0NPVU5UIiwiUkVUUllfQkFDS09GRiIsIllvdWlFbmdpbmVEcml2ZXIiLCJCYXNlRHJpdmVyIiwicmVzZXRZb3VpRW5naW5lIiwicmVhZHkiLCJzb2NrZXQiLCJsb2NhdG9yU3RyYXRlZ2llcyIsInByb3h5ZHJpdmVyIiwicHJveHlBbGxvd0xpc3QiLCJkZXZpY2UiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJzaG91bGRWYWxpZGF0ZUNhcHMiLCJkZXNpcmVkQ2FwQ29uc3RyYWludHMiLCJzZXR0aW5ncyIsIkRldmljZVNldHRpbmdzIiwib25TZXR0aW5nc1VwZGF0ZSIsImJpbmQiLCJ2YWxpZGF0ZUxvY2F0b3JTdHJhdGVneSIsInN0cmF0ZWd5IiwiY3JlYXRlU2Vzc2lvbiIsImNhcHMiLCJzZXNzaW9uSWQiLCJwbGF0Zm9ybU5hbWUiLCJhcHBQbGF0Zm9ybSIsInRvTG93ZXJDYXNlIiwic3RhcnRJT1NTZXNzaW9uIiwic3RhcnRBbmRyb2lkU2Vzc2lvbiIsInN0YXJ0TWFjU2Vzc2lvbiIsIllpTWFjIiwic3RhcnRTZXNzaW9uIiwiQmx1ZVNreSIsInNoZWxsIiwicmVxdWlyZSIsImV4ZWMiLCJ1ZGlkIiwiaW5jbHVkZXMiLCJUdk9zU2ltdWxhdG9yIiwiVHZPcyIsImxvZ2dlciIsImVycm9yQW5kVGhyb3ciLCJjb25uZWN0U29ja2V0IiwiZnVsbFNvdXJjZVRyZWUiLCJ1cGRhdGVTZXR0aW5ncyIsIlNvdXJjZVRyZWVGaWx0ZXIiLCJlIiwiZGVsZXRlU2Vzc2lvbiIsImtleSIsInZhbHVlIiwic2V0VGltZURpbGF0aW9uIiwic2V0U291cmNlVHJlZUZpbHRlciIsInN0b3AiLCJkZWJ1ZyIsImVuZFNlc3Npb24iLCJkcml2ZXJTaG91bGREb1Byb3h5Q21kIiwiY29tbWFuZCIsImFsbG93ZWRDb21tYW5kIiwiZXhlY3V0ZUNvbW1hbmQiLCJjbWQiLCJhcmdzIiwicmVjZWl2ZUFzeW5jUmVzcG9uc2UiLCJjbGVhck5ld0NvbW1hbmRUaW1lb3V0IiwicmVzdWx0Iiwic3RhcnROZXdDb21tYW5kVGltZW91dCIsImVycm9ycyIsIk5vU3VjaERyaXZlckVycm9yIiwidmFsaWRhdGVEZXNpcmVkQ2FwcyIsInJlcyIsInlvdWlFbmdpbmVBcHBBZGRyZXNzIiwibXNnIiwiYXBwIiwiZnMiLCJwYXRoIiwiZXhpc3RzU3luYyIsImFic29sdXRlcGF0aCIsInJlc29sdmUiLCJkZXZpY2VOYW1lIiwiYXZkIiwic2V0dXBOZXdJT1NEcml2ZXIiLCJpb3NBcmdzIiwiamF2YXNjcmlwdEVuYWJsZWQiLCJpb3Nkcml2ZXIiLCJYQ1VJVGVzdERyaXZlciIsInBsYXRmb3JtVmVyc2lvbiIsIm1ham9yVmVyIiwidG9TdHJpbmciLCJzcGxpdCIsInBhcnNlSW50IiwiSU9TRHJpdmVyIiwiY2Fwc0NvcHkiLCJfIiwiY2xvbmVEZWVwIiwibmV3Q29tbWFuZFRpbWVvdXQiLCJpbmZvIiwic2V0dXBOZXdBbmRyb2lkRHJpdmVyIiwiYW5kcm9pZEFyZ3MiLCJhbmRyb2lkZHJpdmVyIiwiQW5kcm9pZERyaXZlciIsInNldHVwTmV3TWFjRHJpdmVyIiwibWFjQXJncyIsIm1hY2RyaXZlciIsIk1hY0RyaXZlciIsInJldHJ5Q291bnQiLCJjb25uZWN0ZWQiLCJjb25uZWN0ZWRQcm9taXNlIiwiQiIsIm5ldCIsIkhPU1QiLCJQT1JUIiwieW91aUVuZ2luZUFwcFBvcnQiLCJTb2NrZXQiLCJvbiIsImV4IiwiZXJyb3IiLCJjb25uZWN0IiwiZXhlY3V0ZVNvY2tldENvbW1hbmQiLCJ3cml0YWJsZSIsImNtZFByb21pc2UiLCJ0b3RhbGRhdGEiLCJlbmRNYXJrZXIiLCJCdWZmZXIiLCJzb2NrZXRDbGllbnQiLCJkYXRhSGFuZGxlciIsImRhdGEiLCJsZW5ndGgiLCJkYXRhZW5kIiwic3RhcnRJbmRleCIsImNvcHkiLCJlcXVhbHMiLCJsYXN0RGF0YSIsInNsaWNlIiwicHVzaCIsInJlbW92ZUxpc3RlbmVyIiwid3JpdGUiLCJmbiIsInRvUGFpcnMiLCJjb21tYW5kcyIsInByb3RvdHlwZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFNQSxNQUFNQSxlQUFlLEdBQUcsQ0FDdEIsWUFEc0IsRUFFdEIsVUFGc0IsRUFHdEIsUUFIc0IsRUFJdEIsYUFKc0IsRUFLdEIsZ0JBTHNCLEVBTXRCLFlBTnNCLEVBT3RCLFlBUHNCLEVBUXRCLFdBUnNCLEVBU3RCLE1BVHNCLEVBVXRCLFdBVnNCLEVBV3RCLGdCQVhzQixDQUF4QjtBQWNBLE1BQU1DLGlCQUFpQixHQUFHLENBQ3hCLGFBRHdCLENBQTFCO0FBSUEsTUFBTUMscUJBQXFCLEdBQUcsQ0FDNUIsc0JBRDRCLEVBRTVCLGdCQUY0QixFQUc1QixVQUg0QixFQUk1QixrQkFKNEIsRUFLNUIsY0FMNEIsRUFNNUIsc0JBTjRCLEVBTzVCLHdCQVA0QixFQVE1QixRQVI0QixDQUE5QjtBQVdBLE1BQU1DLFlBQVksR0FBR0YsaUJBQWlCLENBQUNHLE1BQWxCLENBQXlCSixlQUF6QixDQUFyQjtBQUNBLE1BQU1LLGdCQUFnQixHQUFHSCxxQkFBcUIsQ0FBQ0UsTUFBdEIsQ0FBNkJKLGVBQTdCLENBQXpCO0FBQ0EsTUFBTU0sWUFBWSxHQUFHTixlQUFyQjtBQUVBLE1BQU1PLGVBQWUsR0FBRyxFQUF4QjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxJQUF0Qjs7QUFFQSxNQUFNQyxnQkFBTixTQUErQkMsNEJBQS9CLENBQTBDO0FBQ3hDQyxFQUFBQSxlQUFlLEdBQUk7QUFFakIsU0FBS0MsS0FBTCxHQUFhLEtBQWI7QUFDQSxTQUFLQyxN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QUFnQixNQUFoQixFQUF3QlcsV0FBeEI7QUFDRCxPQUZEO0FBR0QsS0FyQ2dCLENBQWpCO0FBc0NBLFdBQU8sTUFBTUwsVUFBYjtBQUNEOztBQXZYdUM7Ozs7QUEwWDFDLEtBQUssSUFBSSxDQUFDM0QsR0FBRCxFQUFNNEUsRUFBTixDQUFULElBQXNCNUMsZ0JBQUU2QyxPQUFGLENBQVVDLGlCQUFWLENBQXRCLEVBQTJDO0FBQ3pDdkksRUFBQUEsZ0JBQWdCLENBQUN3SSxTQUFqQixDQUEyQi9FLEdBQTNCLElBQWtDNEUsRUFBbEM7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VEcml2ZXIsIERldmljZVNldHRpbmdzLCBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZGVzaXJlZENhcENvbnN0cmFpbnRzIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgc2xlZXAgfSBmcm9tICdhc3luY2JveCc7XG5cbi8vIGZvciBwcm94aWVzXG5pbXBvcnQgQW5kcm9pZERyaXZlciBmcm9tICdhcHBpdW0tYW5kcm9pZC1kcml2ZXInO1xuaW1wb3J0IElPU0RyaXZlciBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgWENVSVRlc3REcml2ZXIgZnJvbSAnYXBwaXVtLXhjdWl0ZXN0LWRyaXZlcic7XG5pbXBvcnQgTWFjRHJpdmVyIGZyb20gJ2FwcGl1bS1tYWMtZHJpdmVyJztcbmltcG9ydCBCbHVlU2t5IGZyb20gJy4vYmx1ZXNreSc7XG5pbXBvcnQgVHZPcyBmcm9tICcuL3R2b3MnO1xuaW1wb3J0IFR2T3NTaW11bGF0b3IgZnJvbSAnLi90dm9zc2ltdWxhdG9yJztcbmltcG9ydCBZaU1hYyBmcm9tICcuL3lpbWFjJztcblxuXG4vLyBBZGQgY29tbWFuZHMgZnJvbSB0aGUgZm9sbG93aW5nIGxvY2F0aW9uIHRoYXQgc2hvdWxkIGJlIG1hcHBlZCB0byBleGlzdGluZyBkcml2ZXJzOlxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0tYmFzZS1kcml2ZXIvYmxvYi9tYXN0ZXIvbGliL21qc29ud3Avcm91dGVzLmpzXG5cbmNvbnN0IFRPX1BST1hZX0NPTU1PTiA9IFtcbiAgJ2JhY2tncm91bmQnLFxuICAnY2xvc2VBcHAnLFxuICAnZ2V0TG9nJyxcbiAgJ2dldExvZ1R5cGVzJyxcbiAgJ2dldE9yaWVudGF0aW9uJyxcbiAgJ2dldFN0cmluZ3MnLFxuICAnaW5zdGFsbEFwcCcsXG4gICdsYXVuY2hBcHAnLFxuICAnbG9jaycsXG4gICdyZW1vdmVBcHAnLFxuICAnc2V0T3JpZW50YXRpb24nLFxuXTtcblxuY29uc3QgVE9fUFJPWFlfSU9TX09OTFkgPSBbXG4gICdtb2JpbGVTaGFrZScsXG5dO1xuXG5jb25zdCBUT19QUk9YWV9BTkRST0lEX09OTFkgPSBbXG4gICdnZXROZXR3b3JrQ29ubmVjdGlvbicsXG4gICdpc0FwcEluc3RhbGxlZCcsXG4gICdpc0xvY2tlZCcsXG4gICdsb25nUHJlc3NLZXlDb2RlJyxcbiAgJ3ByZXNzS2V5Q29kZScsXG4gICdzZXROZXR3b3JrQ29ubmVjdGlvbicsXG4gICd0b2dnbGVMb2NhdGlvblNlcnZpY2VzJyxcbiAgJ3VubG9jaycsXG5dO1xuXG5jb25zdCBUT19QUk9YWV9JT1MgPSBUT19QUk9YWV9JT1NfT05MWS5jb25jYXQoVE9fUFJPWFlfQ09NTU9OKTtcbmNvbnN0IFRPX1BST1hZX0FORFJPSUQgPSBUT19QUk9YWV9BTkRST0lEX09OTFkuY29uY2F0KFRPX1BST1hZX0NPTU1PTik7XG5jb25zdCBUT19QUk9YWV9NQUMgPSBUT19QUk9YWV9DT01NT047XG5cbmNvbnN0IE1BWF9SRVRSWV9DT1VOVCA9IDEwO1xuY29uc3QgUkVUUllfQkFDS09GRiA9IDMwMDA7XG5cbmNsYXNzIFlvdWlFbmdpbmVEcml2ZXIgZXh0ZW5kcyBCYXNlRHJpdmVyIHtcbiAgcmVzZXRZb3VpRW5naW5lICgpIHtcblxuICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcbiAgICB0aGlzLnNvY2tldCA9IG51bGw7XG4gICAgdGhpcy5sb2NhdG9yU3RyYXRlZ2llcyA9IFsnaWQnLCAnbmFtZScsICdjbGFzcyBuYW1lJywgJ2FjY2Vzc2liaWxpdHkgaWQnXTtcbiAgICB0aGlzLnByb3h5ZHJpdmVyID0gbnVsbDtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gJyc7XG4gICAgdGhpcy5kZXZpY2UgPSBudWxsO1xuICB9XG5cbiAgY29uc3RydWN0b3IgKG9wdHMsIHNob3VsZFZhbGlkYXRlQ2Fwcykge1xuICAgIHN1cGVyKG9wdHMsIHNob3VsZFZhbGlkYXRlQ2Fwcyk7XG5cbiAgICB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cyA9IGRlc2lyZWRDYXBDb25zdHJhaW50cztcbiAgICB0aGlzLnNldHRpbmdzID0gbmV3IERldmljZVNldHRpbmdzKHsnVGltZURpbGF0aW9uJzogMSwgJ1NvdXJjZVRyZWVGaWx0ZXInOiAnJ30sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25TZXR0aW5nc1VwZGF0ZS5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnJlc2V0WW91aUVuZ2luZSgpO1xuXG4gIH1cblxuICB2YWxpZGF0ZUxvY2F0b3JTdHJhdGVneSAoc3RyYXRlZ3kpIHtcbiAgICBzdXBlci52YWxpZGF0ZUxvY2F0b3JTdHJhdGVneShzdHJhdGVneSwgZmFsc2UpO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU2Vzc2lvbiAoY2Fwcykge1xuICAgIHRyeSB7XG4gICAgICBsZXQgW3Nlc3Npb25JZF0gPSBhd2FpdCBzdXBlci5jcmVhdGVTZXNzaW9uKGNhcHMpO1xuXG4gICAgICAvLyBzZXR1cCBwcm94aWVzIC0gaWYgcGxhdGZvcm1OYW1lIGlzIG5vdCBlbXB0eSwgbWFrZSBpdCBsZXNzIGNhc2Ugc2Vuc2l0aXZlXG4gICAgICBpZiAoY2Fwcy5wbGF0Zm9ybU5hbWUgIT09IG51bGwpIHtcbiAgICAgICAgbGV0IGFwcFBsYXRmb3JtID0gY2Fwcy5wbGF0Zm9ybU5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgc3dpdGNoIChhcHBQbGF0Zm9ybSkge1xuICAgICAgICAgIGNhc2UgJ2lvcyc6XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0SU9TU2Vzc2lvbihjYXBzKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2FuZHJvaWQnOlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFydEFuZHJvaWRTZXNzaW9uKGNhcHMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnbWFjJzpcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRNYWNTZXNzaW9uKGNhcHMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAneWltYWMnOlxuICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgWWlNYWMoKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGV2aWNlLnN0YXJ0U2Vzc2lvbihjYXBzKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2JsdWVza3knOlxuICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgQmx1ZVNreSgpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5kZXZpY2Uuc3RhcnRTZXNzaW9uKGNhcHMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAneWl0dm9zJzoge1xuICAgICAgICAgICAgbGV0IHNoZWxsID0gcmVxdWlyZSgnc2hlbGxqcycpO1xuICAgICAgICAgICAgaWYgKHNoZWxsLmV4ZWMoYGluc3RydW1lbnRzIC1zIGRldmljZXMgfCBncmVwICcke2NhcHMudWRpZH0nYCkuaW5jbHVkZXMoJyhTaW11bGF0b3IpJykpIHtcbiAgICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgVHZPc1NpbXVsYXRvcigpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5kZXZpY2UgPSBuZXcgVHZPcygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5kZXZpY2Uuc3RhcnRTZXNzaW9uKGNhcHMsIHRoaXMpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNhc2UgJ25vcHJveHknOlxuICAgICAgICAgIGNhc2UgJ2Nvbm5lY3R0b2FwcCc6XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYFVuc3VwcG9ydGVkIHBsYXRmb3JtTmFtZTogJHtjYXBzLnBsYXRmb3JtTmFtZX1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLmNvbm5lY3RTb2NrZXQoKTtcblxuICAgICAgaWYgKGNhcHMuZnVsbFNvdXJjZVRyZWUgPT09IHRydWUpIHtcbiAgICAgICAgLy9EbyBub3Qgc2V0IGZpbHRlclxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVTZXR0aW5ncyh7U291cmNlVHJlZUZpbHRlcjogXCJbQGlzRGlzcGxheWVkPSd0cnVlJ11cIn0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gW3Nlc3Npb25JZCwgdGhpcy5vcHRzXTtcblxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBvblNldHRpbmdzVXBkYXRlIChrZXksIHZhbHVlKSB7XG4gICAgaWYgKGtleSA9PT0gJ1RpbWVEaWxhdGlvbicpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VGltZURpbGF0aW9uKHZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ1NvdXJjZVRyZWVGaWx0ZXInKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFNvdXJjZVRyZWVGaWx0ZXIodmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3AgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ0RlbGV0aW5nIFlvdWlFbmdpbmUgc2Vzc2lvbicpO1xuXG4gICAgaWYgKHRoaXMuY2Fwcy5wbGF0Zm9ybU5hbWUgIT09IG51bGwpIHtcbiAgICAgIGxldCBhcHBQbGF0Zm9ybSA9IHRoaXMuY2Fwcy5wbGF0Zm9ybU5hbWUudG9Mb3dlckNhc2UoKTtcblxuICAgICAgaWYgKFsneWltYWMnLCAneWl0dm9zJywgJ2JsdWVza3knXS5pbmNsdWRlcyhhcHBQbGF0Zm9ybSkpIHtcbiAgICAgICAgaWYgKHRoaXMuZGV2aWNlKSB7XG4gICAgICAgICAgdGhpcy5kZXZpY2UuZW5kU2Vzc2lvbigpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucHJveHlkcml2ZXIgIT09IG51bGwpIHtcbiAgICAgIGF3YWl0IHRoaXMucHJveHlkcml2ZXIuZGVsZXRlU2Vzc2lvbigpO1xuICAgIH1cbiAgICBhd2FpdCBzdXBlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG4gIH1cblxuICBkcml2ZXJTaG91bGREb1Byb3h5Q21kIChjb21tYW5kKSB7XG4gICAgaWYgKCF0aGlzLnByb3h5ZHJpdmVyKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gb25seSBhbGxvdyB3aGl0ZSBsaXN0ZWQgY29tbWFuZHNcbiAgICBmb3IgKGxldCBhbGxvd2VkQ29tbWFuZCBvZiB0aGlzLnByb3h5QWxsb3dMaXN0KSB7XG4gICAgICBpZiAoYWxsb3dlZENvbW1hbmQgPT09IGNvbW1hbmQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVDb21tYW5kIChjbWQsIC4uLmFyZ3MpIHtcbiAgICBpZiAoY21kID09PSAncmVjZWl2ZUFzeW5jUmVzcG9uc2UnKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYEV4ZWN1dGluZyBZb3VpRW5naW5lRHJpdmVyIHJlc3BvbnNlICcke2NtZH0nYCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5yZWNlaXZlQXN5bmNSZXNwb25zZSguLi5hcmdzKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucmVhZHkpIHtcblxuICAgICAgaWYgKHRoaXMuZHJpdmVyU2hvdWxkRG9Qcm94eUNtZChjbWQpKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nIHByb3hpZWQgV2ViRHJpdmVyIGNvbW1hbmQgJyR7Y21kfSdgKTtcblxuICAgICAgICAvLyBUaGVyZSBhcmUgMiBDb21tYW5kVGltZW91dCAoWW91aUVuZ2luZURyaXZlciBhbmQgcHJveHkpXG4gICAgICAgIC8vIE9ubHkgWW91aUVuZ2luZURyaXZlciBDb21tYW5kVGltZW91dCBpcyB1c2VkOyBQcm94eSBpcyBkaXNhYmxlZFxuICAgICAgICAvLyBBbGwgcHJveHkgY29tbWFuZHMgbmVlZHMgdG8gcmVzZXQgdGhlIFlvdWlFbmdpbmVEcml2ZXIgQ29tbWFuZFRpbWVvdXRcbiAgICAgICAgLy8gSGVyZSB3ZSBtYW51YWxseSByZXNldCB0aGUgWW91aUVuZ2luZURyaXZlciBDb21tYW5kVGltZW91dCBmb3IgY29tbWFuZHMgdGhhdCBnb2UgdG8gcHJveHkuXG4gICAgICAgIHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuICAgICAgICBsZXQgcmVzdWx0ID0gdGhpcy5wcm94eWRyaXZlci5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICAgICAgICB0aGlzLnN0YXJ0TmV3Q29tbWFuZFRpbWVvdXQoY21kKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nIFlvdWlFbmdpbmUgV2ViRHJpdmVyIGNvbW1hbmQgJyR7Y21kfSdgKTtcbiAgICAgICAgcmV0dXJuIHN1cGVyLmV4ZWN1dGVDb21tYW5kKGNtZCwgLi4uYXJncyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgQ29tbWFuZCBFcnJvciAnJHtjbWR9J2ApO1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hEcml2ZXJFcnJvcihgRHJpdmVyIGlzIG5vdCByZWFkeSwgY2Fubm90IGV4ZWN1dGUgJHtjbWR9LmApO1xuICAgIH1cbiAgfVxuXG4gIHZhbGlkYXRlRGVzaXJlZENhcHMgKGNhcHMpIHtcbiAgICAvLyBjaGVjayB3aXRoIHRoZSBiYXNlIGNsYXNzLCBhbmQgcmV0dXJuIGlmIGl0IGZhaWxzXG4gICAgbGV0IHJlcyA9IHN1cGVyLnZhbGlkYXRlRGVzaXJlZENhcHMoY2Fwcyk7XG4gICAgaWYgKCFyZXMpIHtcbiAgICAgIHJldHVybiByZXM7XG4gICAgfVxuXG4gICAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIGNhcGFiaWxpdGllcyBoYXMgeW91aUVuZ2luZUFwcEFkZHJlc3NcbiAgICBpZiAoIWNhcHMueW91aUVuZ2luZUFwcEFkZHJlc3MpIHtcbiAgICAgIGxldCBtc2cgPSAnVGhlIGRlc2lyZWQgY2FwYWJpbGl0aWVzIG11c3QgaW5jbHVkZSB5b3VpRW5naW5lQXBwQWRkcmVzcyc7XG4gICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgIH1cblxuICAgIC8vIEFwcCBpcyBiZWluZyBsYXVuY2hlZFxuICAgIGlmIChjYXBzLnBsYXRmb3JtTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnY29ubmVjdHRvYXBwJyAmJiBjYXBzLnBsYXRmb3JtTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnbm9wcm94eScpIHtcblxuICAgICAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIGNhcGFiaWxpdGllcyBoYXMgYXBwXG4gICAgICBpZiAoIWNhcHMuYXBwKSB7XG4gICAgICAgIGxldCBtc2cgPSAnVGhlIGRlc2lyZWQgY2FwYWJpbGl0aWVzIG11c3QgaW5jbHVkZSBhcHAnO1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgICAgfVxuICAgICAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuICAgICAgY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhjYXBzLmFwcCkpIHtcbiAgICAgICAgbGV0IGFic29sdXRlcGF0aCA9IHBhdGgucmVzb2x2ZShjYXBzLmFwcCk7XG4gICAgICAgIGxldCBtc2cgPSAnVGhlIGFwcCBjb3VsZCBub3QgYmUgZm91bmQgaW4gZm9sbG93aW5nIGxvY2F0aW9uOiAnICsgYWJzb2x1dGVwYXRoO1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgICAgfVxuXG4gICAgICAvL0FuZHJvaWQgZW11bGF0b3Igd2l0aCBwcm94eVxuICAgICAgaWYgKGNhcHMuZGV2aWNlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnYW5kcm9pZCcpIHtcbiAgICAgICAgaWYgKCFjYXBzLmF2ZCkge1xuICAgICAgICAgIGxldCBtc2cgPSAnVGhlIGRlc2lyZWQgY2FwYWJpbGl0aWVzIG11c3QgaW5jbHVkZSBhdmQnO1xuICAgICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBmaW5hbGx5LCByZXR1cm4gdHJ1ZSBzaW5jZSB0aGUgc3VwZXJjbGFzcyBjaGVjayBwYXNzZWQsIGFzIGRpZCB0aGlzXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBzZXR1cE5ld0lPU0RyaXZlciAoY2Fwcykge1xuICAgIGxldCBpb3NBcmdzID0ge1xuICAgICAgamF2YXNjcmlwdEVuYWJsZWQ6IHRydWUsXG4gICAgfTtcblxuICAgIGxldCBpb3Nkcml2ZXIgPSBuZXcgWENVSVRlc3REcml2ZXIoaW9zQXJncyk7XG4gICAgLy8gSWYgaU9TIHZlcnNpb24gaXMgMTAgb3IgYWJvdmUgd2UgbmVlZCB0byB1c2UgWENVSVRlc3REcml2ZXIgKGFuZCBYY29kZSA4KylcbiAgICBpZiAoY2Fwcy5wbGF0Zm9ybVZlcnNpb24pIHtcbiAgICAgIGxldCBtYWpvclZlciA9IGNhcHMucGxhdGZvcm1WZXJzaW9uLnRvU3RyaW5nKCkuc3BsaXQoJy4nKVswXTtcbiAgICAgIGlmIChwYXJzZUludChtYWpvclZlciwgMTApIDwgMTApIHtcbiAgICAgICAgaW9zZHJpdmVyID0gbmV3IElPU0RyaXZlcihpb3NBcmdzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgbGV0IGNhcHNDb3B5ID0gXy5jbG9uZURlZXAoY2Fwcyk7XG4gICAgLy8gRGlzYWJsaW5nIHRoZSBwcm94eSBDb21tYW5kVGltZW91dCBpbiB0aGUgaU9TIGRyaXZlciBzaW5jZSB3ZSBhcmUgbm93IGhhbmRsaW5nIGl0IGluIHRoZSBZb3VpRW5naW5lIERyaXZlclxuICAgIGNhcHNDb3B5Lm5ld0NvbW1hbmRUaW1lb3V0ID0gMDtcbiAgICBhd2FpdCBpb3Nkcml2ZXIuY3JlYXRlU2Vzc2lvbihjYXBzQ29weSk7XG5cbiAgICByZXR1cm4gaW9zZHJpdmVyO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRJT1NTZXNzaW9uIChjYXBzKSB7XG4gICAgbG9nZ2VyLmluZm8oJ1N0YXJ0aW5nIGFuIElPUyBwcm94eSBzZXNzaW9uJyk7XG4gICAgdGhpcy5wcm94eUFsbG93TGlzdCA9IFRPX1BST1hZX0lPUztcblxuICAgIHRoaXMucHJveHlkcml2ZXIgPSBhd2FpdCB0aGlzLnNldHVwTmV3SU9TRHJpdmVyKGNhcHMpO1xuICB9XG5cbiAgYXN5bmMgc2V0dXBOZXdBbmRyb2lkRHJpdmVyIChjYXBzKSB7XG4gICAgbGV0IGFuZHJvaWRBcmdzID0ge1xuICAgICAgamF2YXNjcmlwdEVuYWJsZWQ6IHRydWVcbiAgICB9O1xuICAgIGxldCBhbmRyb2lkZHJpdmVyID0gbmV3IEFuZHJvaWREcml2ZXIoYW5kcm9pZEFyZ3MpO1xuICAgIGxldCBjYXBzQ29weSA9IF8uY2xvbmVEZWVwKGNhcHMpO1xuICAgIC8vIERpc2FibGluZyB0aGUgcHJveHkgQ29tbWFuZFRpbWVvdXQgaW4gdGhlIEFuZHJvaWQgZHJpdmVyIHNpbmNlIHdlIGFyZSBub3cgaGFuZGxpbmcgaXQgaW4gdGhlIFlvdWlFbmdpbmUgRHJpdmVyXG4gICAgY2Fwc0NvcHkubmV3Q29tbWFuZFRpbWVvdXQgPSAwO1xuXG4gICAgYXdhaXQgYW5kcm9pZGRyaXZlci5jcmVhdGVTZXNzaW9uKGNhcHNDb3B5KTtcblxuICAgIHJldHVybiBhbmRyb2lkZHJpdmVyO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRBbmRyb2lkU2Vzc2lvbiAoY2Fwcykge1xuICAgIGxvZ2dlci5pbmZvKCdTdGFydGluZyBhbiBBbmRyb2lkIHByb3h5IHNlc3Npb24nKTtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gVE9fUFJPWFlfQU5EUk9JRDtcblxuICAgIHRoaXMucHJveHlkcml2ZXIgPSBhd2FpdCB0aGlzLnNldHVwTmV3QW5kcm9pZERyaXZlcihjYXBzKTtcbiAgfVxuXG4gIGFzeW5jIHNldHVwTmV3TWFjRHJpdmVyIChjYXBzKSB7XG4gICAgbGV0IG1hY0FyZ3MgPSB7XG4gICAgICBqYXZhc2NyaXB0RW5hYmxlZDogdHJ1ZVxuICAgIH07XG4gICAgbGV0IG1hY2RyaXZlciA9IG5ldyBNYWNEcml2ZXIobWFjQXJncyk7XG4gICAgbGV0IGNhcHNDb3B5ID0gXy5jbG9uZURlZXAoY2Fwcyk7XG4gICAgLy8gRGlzYWJsaW5nIHRoZSBwcm94eSBDb21tYW5kVGltZW91dCBpbiB0aGUgcHJveGllZCBkcml2ZXIgc2luY2Ugd2UgYXJlIG5vdyBoYW5kbGluZyBpdCBpbiB0aGUgWW91aUVuZ2luZSBEcml2ZXJcbiAgICBjYXBzQ29weS5uZXdDb21tYW5kVGltZW91dCA9IDA7XG5cbiAgICBhd2FpdCBtYWNkcml2ZXIuY3JlYXRlU2Vzc2lvbihjYXBzQ29weSk7XG5cbiAgICByZXR1cm4gbWFjZHJpdmVyO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRNYWNTZXNzaW9uIChjYXBzKSB7XG4gICAgbG9nZ2VyLmluZm8oJ1N0YXJ0aW5nIGEgTWFjIHByb3h5IHNlc3Npb24nKTtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gVE9fUFJPWFlfTUFDO1xuXG4gICAgdGhpcy5wcm94eWRyaXZlciA9IGF3YWl0IHRoaXMuc2V0dXBOZXdNYWNEcml2ZXIoY2Fwcyk7XG4gIH1cblxuICAvLyBTT0NLRVRTXG4gIGFzeW5jIGNvbm5lY3RTb2NrZXQgKCkge1xuICAgIGxldCByZXRyeUNvdW50ID0gMDtcbiAgICBsZXQgY29ubmVjdGVkID0gZmFsc2U7XG4gICAgd2hpbGUgKHJldHJ5Q291bnQgPCBNQVhfUkVUUllfQ09VTlQgJiYgIWNvbm5lY3RlZCkge1xuICAgICAgaWYgKHJldHJ5Q291bnQgPiAwKSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdXYWl0aW5nICcgKyAoUkVUUllfQkFDS09GRiAvIDEwMDApICsgJyBzZWNvbmRzIGJlZm9yZSB0cnlpbmcuLi4nKTtcbiAgICAgICAgYXdhaXQgc2xlZXAoUkVUUllfQkFDS09GRik7XG4gICAgICB9XG4gICAgICBsb2dnZXIuaW5mbygnQXR0ZW1wdCAjJyArIChyZXRyeUNvdW50ICsgMSkpO1xuXG4gICAgICBsZXQgY29ubmVjdGVkUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlKSA9PiB7XG4gICAgICAgIGxldCBuZXQgPSByZXF1aXJlKCduZXQnKTtcblxuICAgICAgICBsZXQgSE9TVCA9IHRoaXMub3B0cy55b3VpRW5naW5lQXBwQWRkcmVzcztcbiAgICAgICAgbGV0IFBPUlQ7XG5cbiAgICAgICAgaWYgKHRoaXMuY2Fwcy55b3VpRW5naW5lQXBwUG9ydCkge1xuICAgICAgICAgIFBPUlQgPSB0aGlzLmNhcHMueW91aUVuZ2luZUFwcFBvcnQ7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5jYXBzLnBsYXRmb3JtTmFtZS50b0xvd2VyQ2FzZSgpID09PSAneWlwczQnKSB7XG4gICAgICAgICAgUE9SVCA9IDQwMTIzOyAvL2RlZmF1bHQgcG9ydCBmb3IgUFM0XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgUE9SVCA9IDEyMzQ1OyAvL2RlZmF1bHQgcG9ydFxuICAgICAgICB9XG4gICAgICAgIHtsb2dnZXIuaW5mbygnQ29ubmVjdGluZyB0byBXZWJEcml2ZXI6ICcgKyBIT1NUICsgJzonICsgUE9SVCk7fVxuXG4gICAgICAgIHRoaXMuc29ja2V0ID0gbmV3IG5ldC5Tb2NrZXQoKTtcblxuICAgICAgICAvLyBBZGQgYW4gJ2Vycm9yJyBldmVudCBoYW5kbGVyIGZvciB0aGUgY2xpZW50IHNvY2tldFxuICAgICAgICB0aGlzLnNvY2tldC5vbiAoJ2Vycm9yJywgZnVuY3Rpb24gKGV4KSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKGV4KTtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0NoZWNrIHRoYXQgV2ViRHJpdmVyIGlzIGVuYWJsZWQgaW4gYXBwbGljYXRpb24sIGlmIGEgZGV2aWNlIGVuc3VyZSB0aGUgcHJvcGVyIElQIGFkZHJlc3MgaXMgdXNlZC4nKTtcbiAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIEFkZCBhICdjbG9zZScgZXZlbnQgaGFuZGxlciBmb3IgdGhlIGNsaWVudCBzb2NrZXRcbiAgICAgICAgdGhpcy5zb2NrZXQub24gKCdjbG9zZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbygnQ29ubmVjdGlvbiBjbG9zZWQnKTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIEFkZCBhICd0aW1lb3V0JyBldmVudCBoYW5kbGVyIGZvciB0aGUgY2xpZW50IHNvY2tldFxuICAgICAgICB0aGlzLnNvY2tldC5vbiAoJ3RpbWVvdXQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKCdDb25uZWN0aW9uIHRpbWVkIG91dCcpO1xuICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zb2NrZXQuY29ubmVjdCAoUE9SVCwgSE9TVCwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxvZ2dlci5pbmZvKCdDb25uZWN0ZWQnKTtcbiAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgcmV0cnlDb3VudCsrO1xuICAgICAgY29ubmVjdGVkID0gYXdhaXQgY29ubmVjdGVkUHJvbWlzZTtcblxuICAgICAgaWYgKCFjb25uZWN0ZWQgJiYgcmV0cnlDb3VudCA9PT0gKE1BWF9SRVRSWV9DT1VOVCAtIDEpKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KCdGYWlsZWQgdG8gY29ubmVjdCAnICsgTUFYX1JFVFJZX0NPVU5UICsgJyB0aW1lcy4gQWJvcnRpbmcuJyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHJ5Q291bnQgPSAwO1xuICAgIHRoaXMucmVhZHkgPSBjb25uZWN0ZWQ7XG4gIH1cblxuICAvLyByZXNwb25zZXMgdG8gdGhlIGNvbW1hbmRzIGFyZSBCSU5BUllcbiAgYXN5bmMgZXhlY3V0ZVNvY2tldENvbW1hbmQgKGNtZCkge1xuXG4gICAgaWYgKCF0aGlzLnNvY2tldC53cml0YWJsZSkge1xuICAgICAgbG9nZ2VyLmluZm8oJ1NvY2tldCBpcyBub3Qgd3JpdGFibGUuIFRyeWluZyB0byByZWNvbm5lY3QuJyk7XG4gICAgICBhd2FpdCB0aGlzLmNvbm5lY3RTb2NrZXQoKTtcbiAgICB9XG5cbiAgICBsZXQgY21kUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlKSA9PiB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0NPTU1BTkQ6ICcgKyBjbWQpO1xuXG4gICAgICBsZXQgdG90YWxkYXRhID0gW107XG4gICAgICBsZXQgZW5kTWFya2VyID0gbmV3IEJ1ZmZlcigneW91aWVuZCcpO1xuICAgICAgbGV0IHNvY2tldENsaWVudCA9IHRoaXMuc29ja2V0O1xuXG5cbiAgICAgIGxldCBkYXRhSGFuZGxlciA9IGZ1bmN0aW9uIChkYXRhKSB7XG5cbiAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHRoaXMgaW5jbHVkZXMgYW4gZW5kIHBhcmtlclxuICAgICAgICAvLyBnZXQgbGFzdCBmZXcgdmFsdWVzIG9mIGJ1ZmZlclxuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPj0gZW5kTWFya2VyLmxlbmd0aCkge1xuICAgICAgICAgIGxldCBkYXRhZW5kID0gbmV3IEJ1ZmZlcihlbmRNYXJrZXIubGVuZ3RoKTtcbiAgICAgICAgICBsZXQgc3RhcnRJbmRleCA9IGRhdGEubGVuZ3RoIC0gZW5kTWFya2VyLmxlbmd0aDtcbiAgICAgICAgICBkYXRhLmNvcHkoZGF0YWVuZCwgMCwgc3RhcnRJbmRleCwgc3RhcnRJbmRleCArIGVuZE1hcmtlci5sZW5ndGgpO1xuICAgICAgICAgIC8vbG9nZ2VyLmRlYnVnKCdEQVRBRU5EJyArIGRhdGFlbmQudG9TdHJpbmcoKSk7XG4gICAgICAgICAgaWYgKGRhdGFlbmQuZXF1YWxzKGVuZE1hcmtlcikpIHtcbiAgICAgICAgICAgIC8vIHJlbW92ZSBkYXRhIGVuZFxuICAgICAgICAgICAgbGV0IGxhc3REYXRhID0gZGF0YS5zbGljZSgwLCBzdGFydEluZGV4KTtcbiAgICAgICAgICAgIC8vbG9nZ2VyLmRlYnVnKCdMQVNUIERBVEE6ICcgKyBsYXN0RGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIHRvdGFsZGF0YS5wdXNoKGxhc3REYXRhKTtcblxuICAgICAgICAgICAgLy9yZW1vdmUgaGFuZGxlclxuICAgICAgICAgICAgc29ja2V0Q2xpZW50LnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgZGF0YUhhbmRsZXIpO1xuXG4gICAgICAgICAgICAvLyByZXNvbHZlXG4gICAgICAgICAgICByZXNvbHZlKEJ1ZmZlci5jb25jYXQodG90YWxkYXRhKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRvdGFsZGF0YS5wdXNoKGRhdGEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgc29ja2V0Q2xpZW50LndyaXRlKGNtZCArICdcXG4nLCAnVVRGOCcsICgpID0+IHtcbiAgICAgICAgc29ja2V0Q2xpZW50Lm9uKCdkYXRhJywgZGF0YUhhbmRsZXIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGF3YWl0IGNtZFByb21pc2U7XG4gIH1cbn1cblxuZm9yIChsZXQgW2NtZCwgZm5dIG9mIF8udG9QYWlycyhjb21tYW5kcykpIHtcbiAgWW91aUVuZ2luZURyaXZlci5wcm90b3R5cGVbY21kXSA9IGZuO1xufVxuZXhwb3J0IHsgWW91aUVuZ2luZURyaXZlciB9O1xuIl0sImZpbGUiOiJsaWIvZHJpdmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
