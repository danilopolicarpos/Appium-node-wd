"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger.js"));

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _helpers = require("../helpers.js");

var _asyncLock = _interopRequireDefault(require("async-lock"));

const BASE_APK = 'base-master.apk';

const LANGUAGE_APK = lang => `base-${lang}.apk`;

const APKS_CACHE = new _lruCache.default({
  max: 10,
  dispose: (apksHash, extractedFilesRoot) => _appiumSupport.fs.rimraf(extractedFilesRoot)
});
const APKS_CACHE_GUARD = new _asyncLock.default();

async function extractFromApks(apks, dstPath) {
  if (!_lodash.default.isArray(dstPath)) {
    dstPath = [dstPath];
  }

  return await APKS_CACHE_GUARD.acquire(apks, async () => {
    const apksHash = await _appiumSupport.fs.hash(apks);

    _logger.default.debug(`Calculated '${apks}' hash: ${apksHash}`);

    if (APKS_CACHE.has(apksHash)) {
      const resultPath = _path.default.resolve(APKS_CACHE.get(apksHash), ...dstPath);

      if (await _appiumSupport.fs.exists(resultPath)) {
        return resultPath;
      }

      APKS_CACHE.del(apksHash);
    }

    const tmpRoot = await _appiumSupport.tempDir.openDir();

    _logger.default.debug(`Unpacking application bundle at '${apks}' to '${tmpRoot}'`);

    await (0, _helpers.unzipFile)(apks, tmpRoot);

    const resultPath = _path.default.resolve(tmpRoot, ...dstPath);

    if (!(await _appiumSupport.fs.exists(resultPath))) {
      throw new Error(`${dstPath.join(_path.default.sep)} cannot be found in '${apks}' bundle. ` + `Does the archive contain a valid application bundle?`);
    }

    APKS_CACHE.set(apksHash, tmpRoot);
    return resultPath;
  });
}

let apksUtilsMethods = {};

apksUtilsMethods.execBundletool = async function execBundletool(args, errorMsg) {
  await this.initBundletool();
  args = ['-jar', this.binaries.bundletool, ...args];

  _logger.default.debug(`Executing bundletool with arguments: ${JSON.stringify(args)}`);

  let stdout;

  try {
    ({
      stdout
    } = await (0, _teen_process.exec)((0, _helpers.getJavaForOs)(), args));

    _logger.default.debug(`Command stdout: ${_lodash.default.truncate(stdout, {
      length: 300
    })}`);

    return stdout;
  } catch (e) {
    if (e.stdout) {
      _logger.default.debug(`Command stdout: ${e.stdout}`);
    }

    if (e.stderr) {
      _logger.default.debug(`Command stderr: ${e.stderr}`);
    }

    throw new Error(`${errorMsg}. Original error: ${e.message}`);
  }
};

apksUtilsMethods.getDeviceSpec = async function getDeviceSpec(specLocation) {
  const args = ['get-device-spec', '--adb', this.executable.path, '--device-id', this.curDeviceId, '--output', specLocation];

  _logger.default.debug(`Getting the spec for the device '${this.curDeviceId}'`);

  await this.execBundletool(args, 'Cannot retrieve the device spec');
  return specLocation;
};

apksUtilsMethods.installApks = async function installApks(apks, options = {}) {
  options = _lodash.default.cloneDeep(options);

  _lodash.default.defaults(options, {
    timeout: this.adbExecTimeout === _helpers.DEFAULT_ADB_EXEC_TIMEOUT ? _helpers.APKS_INSTALL_TIMEOUT : this.adbExecTimeout,
    timeoutCapName: 'androidInstallTimeout'
  });

  Object.assign(options, {
    replace: true
  });
  const tmpRoot = await _appiumSupport.tempDir.openDir();

  try {
    const specPath = await this.getDeviceSpec(_path.default.resolve(tmpRoot, 'deviceSpec.json'));
    const args = ['extract-apks', '--apks', apks, '--output-dir', tmpRoot, '--device-spec', specPath];

    _logger.default.debug(`Extracting the apk files from '${apks}'`);

    await this.execBundletool(args, `Cannot extract the application bundle at '${apks}'`);
    const installArgs = (0, _helpers.buildInstallArgs)((await this.getApiLevel()), options);
    const apkPathsToInstall = (await _appiumSupport.fs.readdir(tmpRoot)).filter(name => name.endsWith(_helpers.APK_EXTENSION)).map(name => _path.default.resolve(tmpRoot, name));

    _logger.default.debug('Got the following apk files to install: ' + JSON.stringify(apkPathsToInstall.map(x => _path.default.basename(x))));

    const output = await this.adbExec(['install-multiple', ...installArgs, ...apkPathsToInstall], {
      timeout: options.timeout,
      timeoutCapName: options.timeoutCapName
    });
    const truncatedOutput = !_lodash.default.isString(output) || output.length <= 300 ? output : `${output.substr(0, 150)}...${output.substr(output.length - 150)}`;

    _logger.default.debug(`Install command stdout: ${truncatedOutput}`);

    if (_lodash.default.includes(output, 'INSTALL_FAILED')) {
      throw new Error(output);
    }
  } finally {
    await _appiumSupport.fs.rimraf(tmpRoot);
  }
};

apksUtilsMethods.extractBaseApk = async function extractBaseApk(apks) {
  return await extractFromApks(apks, ['splits', BASE_APK]);
};

apksUtilsMethods.extractLanguageApk = async function extractLanguageApk(apks, language = null) {
  if (language) {
    try {
      return await extractFromApks(apks, ['splits', LANGUAGE_APK(language)]);
    } catch (e) {
      _logger.default.debug(e.message);

      _logger.default.info(`Assuming that splitting by language is not enabled for the '${apks}' bundle ` + `and returning the main apk instead`);

      return await this.extractBaseApk(apks);
    }
  }

  const defaultLanguages = ['en', 'en_us'];

  for (const lang of defaultLanguages) {
    try {
      return await extractFromApks(apks, ['splits', LANGUAGE_APK(lang)]);
    } catch (ign) {}
  }

  _logger.default.info(`Cannot find any split apk for the default languages ${JSON.stringify(defaultLanguages)}. ` + `Returning the main apk instead.`);

  return await this.extractBaseApk(apks);
};

var _default = apksUtilsMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hcGtzLXV0aWxzLmpzIl0sIm5hbWVzIjpbIkJBU0VfQVBLIiwiTEFOR1VBR0VfQVBLIiwibGFuZyIsIkFQS1NfQ0FDSEUiLCJMUlUiLCJtYXgiLCJkaXNwb3NlIiwiYXBrc0hhc2giLCJleHRyYWN0ZWRGaWxlc1Jvb3QiLCJmcyIsInJpbXJhZiIsIkFQS1NfQ0FDSEVfR1VBUkQiLCJBc3luY0xvY2siLCJleHRyYWN0RnJvbUFwa3MiLCJhcGtzIiwiZHN0UGF0aCIsIl8iLCJpc0FycmF5IiwiYWNxdWlyZSIsImhhc2giLCJsb2ciLCJkZWJ1ZyIsImhhcyIsInJlc3VsdFBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsImdldCIsImV4aXN0cyIsImRlbCIsInRtcFJvb3QiLCJ0ZW1wRGlyIiwib3BlbkRpciIsIkVycm9yIiwiam9pbiIsInNlcCIsInNldCIsImFwa3NVdGlsc01ldGhvZHMiLCJleGVjQnVuZGxldG9vbCIsImFyZ3MiLCJlcnJvck1zZyIsImluaXRCdW5kbGV0b29sIiwiYmluYXJpZXMiLCJidW5kbGV0b29sIiwiSlNPTiIsInN0cmluZ2lmeSIsInN0ZG91dCIsInRydW5jYXRlIiwibGVuZ3RoIiwiZSIsInN0ZGVyciIsIm1lc3NhZ2UiLCJnZXREZXZpY2VTcGVjIiwic3BlY0xvY2F0aW9uIiwiZXhlY3V0YWJsZSIsImN1ckRldmljZUlkIiwiaW5zdGFsbEFwa3MiLCJvcHRpb25zIiwiY2xvbmVEZWVwIiwiZGVmYXVsdHMiLCJ0aW1lb3V0IiwiYWRiRXhlY1RpbWVvdXQiLCJERUZBVUxUX0FEQl9FWEVDX1RJTUVPVVQiLCJBUEtTX0lOU1RBTExfVElNRU9VVCIsInRpbWVvdXRDYXBOYW1lIiwiT2JqZWN0IiwiYXNzaWduIiwicmVwbGFjZSIsInNwZWNQYXRoIiwiaW5zdGFsbEFyZ3MiLCJnZXRBcGlMZXZlbCIsImFwa1BhdGhzVG9JbnN0YWxsIiwicmVhZGRpciIsImZpbHRlciIsIm5hbWUiLCJlbmRzV2l0aCIsIkFQS19FWFRFTlNJT04iLCJtYXAiLCJ4IiwiYmFzZW5hbWUiLCJvdXRwdXQiLCJhZGJFeGVjIiwidHJ1bmNhdGVkT3V0cHV0IiwiaXNTdHJpbmciLCJzdWJzdHIiLCJpbmNsdWRlcyIsImV4dHJhY3RCYXNlQXBrIiwiZXh0cmFjdExhbmd1YWdlQXBrIiwibGFuZ3VhZ2UiLCJpbmZvIiwiZGVmYXVsdExhbmd1YWdlcyIsImlnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQTs7QUFFQSxNQUFNQSxRQUFRLEdBQUcsaUJBQWpCOztBQUNBLE1BQU1DLFlBQVksR0FBSUMsSUFBRCxJQUFXLFFBQU9BLElBQUssTUFBNUM7O0FBQ0EsTUFBTUMsVUFBVSxHQUFHLElBQUlDLGlCQUFKLENBQVE7QUFDekJDLEVBQUFBLEdBQUcsRUFBRSxFQURvQjtBQUV6QkMsRUFBQUEsT0FBTyxFQUFFLENBQUNDLFFBQUQsRUFBV0Msa0JBQVgsS0FBa0NDLGtCQUFHQyxNQUFILENBQVVGLGtCQUFWO0FBRmxCLENBQVIsQ0FBbkI7QUFJQSxNQUFNRyxnQkFBZ0IsR0FBRyxJQUFJQyxrQkFBSixFQUF6Qjs7QUFlQSxlQUFlQyxlQUFmLENBQWdDQyxJQUFoQyxFQUFzQ0MsT0FBdEMsRUFBK0M7QUFDN0MsTUFBSSxDQUFDQyxnQkFBRUMsT0FBRixDQUFVRixPQUFWLENBQUwsRUFBeUI7QUFDdkJBLElBQUFBLE9BQU8sR0FBRyxDQUFDQSxPQUFELENBQVY7QUFDRDs7QUFFRCxTQUFPLE1BQU1KLGdCQUFnQixDQUFDTyxPQUFqQixDQUF5QkosSUFBekIsRUFBK0IsWUFBWTtBQUl0RCxVQUFNUCxRQUFRLEdBQUcsTUFBTUUsa0JBQUdVLElBQUgsQ0FBUUwsSUFBUixDQUF2Qjs7QUFDQU0sb0JBQUlDLEtBQUosQ0FBVyxlQUFjUCxJQUFLLFdBQVVQLFFBQVMsRUFBakQ7O0FBRUEsUUFBSUosVUFBVSxDQUFDbUIsR0FBWCxDQUFlZixRQUFmLENBQUosRUFBOEI7QUFDNUIsWUFB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RUEsU0FBTyxNQUFNLEtBQUtKLGNBQUwsQ0FBb0J2RSxJQUFwQixDQUFiO0FBQ0QsQ0F0QkQ7O2VBd0Jlc0IsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyLmpzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IExSVSBmcm9tICdscnUtY2FjaGUnO1xuaW1wb3J0IHtcbiAgZ2V0SmF2YUZvck9zLCB1bnppcEZpbGUsIGJ1aWxkSW5zdGFsbEFyZ3MsXG4gIEFQS1NfSU5TVEFMTF9USU1FT1VULCBBUEtfRVhURU5TSU9OLFxuICBERUZBVUxUX0FEQl9FWEVDX1RJTUVPVVQgfSBmcm9tICcuLi9oZWxwZXJzLmpzJztcbmltcG9ydCBBc3luY0xvY2sgZnJvbSAnYXN5bmMtbG9jayc7XG5cbmNvbnN0IEJBU0VfQVBLID0gJ2Jhc2UtbWFzdGVyLmFwayc7XG5jb25zdCBMQU5HVUFHRV9BUEsgPSAobGFuZykgPT4gYGJhc2UtJHtsYW5nfS5hcGtgO1xuY29uc3QgQVBLU19DQUNIRSA9IG5ldyBMUlUoe1xuICBtYXg6IDEwLFxuICBkaXNwb3NlOiAoYXBrc0hhc2gsIGV4dHJhY3RlZEZpbGVzUm9vdCkgPT4gZnMucmltcmFmKGV4dHJhY3RlZEZpbGVzUm9vdCksXG59KTtcbmNvbnN0IEFQS1NfQ0FDSEVfR1VBUkQgPSBuZXcgQXN5bmNMb2NrKCk7XG5cbi8qKlxuICogRXh0cmFjdHMgdGhlIHBhcnRpY3VsYXIgYXBrcyBwYWNrYWdlIGludG8gYSB0ZW1wb3JhcnkgZm9sZGVyLFxuICogZmluZHMgYW5kIHJldHVybnMgdGhlIGZ1bGwgcGF0aCB0byB0aGUgZmlsZSBjb250YWluZWQgaW4gdGhpcyBhcGsuXG4gKiBUaGUgcmVzdWx0aW5nIHRlbXBvcmFyeSBwYXRoLCB3aGVyZSB0aGUgLmFwa3MgZmlsZSBoYXMgYmVlbiBleHRyYWN0ZWQsXG4gKiB3aWxsIGJlIHN0b3JlZCBpbnRvIHRoZSBpbnRlcm5hbCBMUlUgY2FjaGUgZm9yIGJldHRlciBwZXJmb3JtYW5jZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrcyAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIC5hcGtzIGZpbGVcbiAqIEBwYXJhbSB7c3RyaW5nfEFycmF5PFN0cmluZz59IGRzdFBhdGggLSBUaGUgcmVsYXRpdmUgcGF0aCB0byB0aGUgZGVzdGluYXRpb24gZmlsZSxcbiAqIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGV4dHJhY3RlZCwgd2hlcmUgZWFjaCBwYXRoIGNvbXBvbmVudCBpcyBhbiBhcnJheSBpdGVtXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBGdWxsIHBhdGggdG8gdGhlIGV4dHJhY3RlZCBmaWxlXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHJlcXVlc3RlZCBpdGVtIGRvZXMgbm90IGV4aXN0IGluIHRoZSBleHRyYWN0ZWQgYXJjaGl2ZSBvciB0aGUgcHJvdmlkZXNcbiAqIGFwa3MgZmlsZSBpcyBub3QgYSB2YWxpZCBidW5kbGVcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZXh0cmFjdEZyb21BcGtzIChhcGtzLCBkc3RQYXRoKSB7XG4gIGlmICghXy5pc0FycmF5KGRzdFBhdGgpKSB7XG4gICAgZHN0UGF0aCA9IFtkc3RQYXRoXTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCBBUEtTX0NBQ0hFX0dVQVJELmFjcXVpcmUoYXBrcywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIEl0IG1pZ2h0IGJlIHRoYXQgdGhlIG9yaWdpbmFsIGZpbGUgaGFzIGJlZW4gcmVwbGFjZWQsXG4gICAgLy8gc28gd2UgbmVlZCB0byBrZWVwIHRoZSBoYXNoIHN1bXMgaW5zdGVhZCBvZiB0aGUgYWN0dWFsIGZpbGUgcGF0aHNcbiAgICAvLyBhcyBjYWNoaW5nIGtleXNcbiAgICBjb25zdCBhcGtzSGFzaCA9IGF3YWl0IGZzLmhhc2goYXBrcyk7XG4gICAgbG9nLmRlYnVnKGBDYWxjdWxhdGVkICcke2Fwa3N9JyBoYXNoOiAke2Fwa3NIYXNofWApO1xuXG4gICAgaWYgKEFQS1NfQ0FDSEUuaGFzKGFwa3NIYXNoKSkge1xuICAgICAgY29uc3QgcmVzdWx0UGF0aCA9IHBhdGgucmVzb2x2ZShBUEtTX0NBQ0hFLmdldChhcGtzSGFzaCksIC4uLmRzdFBhdGgpO1xuICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhyZXN1bHRQYXRoKSkge1xuICAgICAgICByZXR1cm4gcmVzdWx0UGF0aDtcbiAgICAgIH1cbiAgICAgIEFQS1NfQ0FDSEUuZGVsKGFwa3NIYXNoKTtcbiAgICB9XG5cbiAgICBjb25zdCB0bXBSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gICAgbG9nLmRlYnVnKGBVbnBhY2tpbmcgYXBwbGljYXRpb24gYnVuZGxlIGF0ICcke2Fwa3N9JyB0byAnJHt0bXBSb290fSdgKTtcbiAgICBhd2FpdCB1bnppcEZpbGUoYXBrcywgdG1wUm9vdCk7XG4gICAgY29uc3QgcmVzdWx0UGF0aCA9IHBhdGgucmVzb2x2ZSh0bXBSb290LCAuLi5kc3RQYXRoKTtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhyZXN1bHRQYXRoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2RzdFBhdGguam9pbihwYXRoLnNlcCl9IGNhbm5vdCBiZSBmb3VuZCBpbiAnJHthcGtzfScgYnVuZGxlLiBgICtcbiAgICAgICAgYERvZXMgdGhlIGFyY2hpdmUgY29udGFpbiBhIHZhbGlkIGFwcGxpY2F0aW9uIGJ1bmRsZT9gKTtcbiAgICB9XG4gICAgQVBLU19DQUNIRS5zZXQoYXBrc0hhc2gsIHRtcFJvb3QpO1xuICAgIHJldHVybiByZXN1bHRQYXRoO1xuICB9KTtcbn1cblxubGV0IGFwa3NVdGlsc01ldGhvZHMgPSB7fTtcblxuLyoqXG4gKiBFeGVjdXRlcyBidW5kbGV0b29sIHV0aWxpdHkgd2l0aCBnaXZlbiBhcmd1bWVudHMgYW5kIHJldHVybnMgdGhlIGFjdHVhbCBzdGRvdXRcbiAqXG4gKiBAcGFyYW0ge0FycmF5PFN0cmluZz59IGFyZ3MgLSB0aGUgbGlzdCBvZiBidW5kbGV0b29sIGFyZ3VtZW50c1xuICogQHBhcmFtIHtzdHJpbmd9IGVycm9yTXNnIC0gVGhlIGN1c3RvbWl6ZWQgZXJyb3IgbWVzc2FnZSBzdHJpbmdcbiAqIEByZXR1cm5zIHtzdHJpbmd9IHRoZSBhY3R1YWwgY29tbWFuZCBzdGRvdXRcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBidW5kbGV0b29sIGphciBkb2VzIG5vdCBleGlzdCBpbiBQQVRIIG9yIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZVxuICogZXhlY3V0aW5nIGl0XG4gKi9cbmFwa3NVdGlsc01ldGhvZHMuZXhlY0J1bmRsZXRvb2wgPSBhc3luYyBmdW5jdGlvbiBleGVjQnVuZGxldG9vbCAoYXJncywgZXJyb3JNc2cpIHtcbiAgYXdhaXQgdGhpcy5pbml0QnVuZGxldG9vbCgpO1xuICBhcmdzID0gW1xuICAgICctamFyJywgdGhpcy5iaW5hcmllcy5idW5kbGV0b29sLFxuICAgIC4uLmFyZ3NcbiAgXTtcbiAgbG9nLmRlYnVnKGBFeGVjdXRpbmcgYnVuZGxldG9vbCB3aXRoIGFyZ3VtZW50czogJHtKU09OLnN0cmluZ2lmeShhcmdzKX1gKTtcbiAgbGV0IHN0ZG91dDtcbiAgdHJ5IHtcbiAgICAoe3N0ZG91dH0gPSBhd2FpdCBleGVjKGdldEphdmFGb3JPcygpLCBhcmdzKSk7XG4gICAgbG9nLmRlYnVnKGBDb21tYW5kIHN0ZG91dDogJHtfLnRydW5jYXRlKHN0ZG91dCwge2xlbmd0aDogMzAwfSl9YCk7XG4gICAgcmV0dXJuIHN0ZG91dDtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLnN0ZG91dCkge1xuICAgICAgbG9nLmRlYnVnKGBDb21tYW5kIHN0ZG91dDogJHtlLnN0ZG91dH1gKTtcbiAgICB9XG4gICAgaWYgKGUuc3RkZXJyKSB7XG4gICAgICBsb2cuZGVidWcoYENvbW1hbmQgc3RkZXJyOiAke2Uuc3RkZXJyfWApO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZXJyb3JNc2d9LiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbn07XG5cbi8qKlxuICogQHBhcmFtIHtzdHJpbmd9IHNwZWNMb2NhdGlvbiAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGdlbmVyYXRlZCBkZXZpY2Ugc3BlYyBsb2NhdGlvblxuICogQHJldHVybnMge3N0cmluZ30gVGhlIHNhbWUgYHNwZWNMb2NhdGlvbmAgdmFsdWVcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBpdCBpcyBub3QgcG9zc2libGUgdG8gcmV0cmlldmUgdGhlIHNwZWMgZm9yIHRoZSBjdXJyZW50IGRldmljZVxuICovXG5hcGtzVXRpbHNNZXRob2RzLmdldERldmljZVNwZWMgPSBhc3luYyBmdW5jdGlvbiBnZXREZXZpY2VTcGVjIChzcGVjTG9jYXRpb24pIHtcbiAgY29uc3QgYXJncyA9IFtcbiAgICAnZ2V0LWRldmljZS1zcGVjJyxcbiAgICAnLS1hZGInLCB0aGlzLmV4ZWN1dGFibGUucGF0aCxcbiAgICAnLS1kZXZpY2UtaWQnLCB0aGlzLmN1ckRldmljZUlkLFxuICAgICctLW91dHB1dCcsIHNwZWNMb2NhdGlvbixcbiAgXTtcbiAgbG9nLmRlYnVnKGBHZXR0aW5nIHRoZSBzcGVjIGZvciB0aGUgZGV2aWNlICcke3RoaXMuY3VyRGV2aWNlSWR9J2ApO1xuICBhd2FpdCB0aGlzLmV4ZWNCdW5kbGV0b29sKGFyZ3MsICdDYW5ub3QgcmV0cmlldmUgdGhlIGRldmljZSBzcGVjJyk7XG4gIHJldHVybiBzcGVjTG9jYXRpb247XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEluc3RhbGxBcGtzT3B0aW9uc1xuICogQHByb3BlcnR5IHs/bnVtYmVyfHN0cmluZ30gdGltZW91dCBbMjAwMDBdIC0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIGluc3RhbGxhdGlvbiBpcyBjb21wbGV0ZWRcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB0aW1lb3V0Q2FwTmFtZSBbYW5kcm9pZEluc3RhbGxUaW1lb3V0XSAtIFRoZSB0aW1lb3V0IG9wdGlvbiBuYW1lXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VycyBjYW4gaW5jcmVhc2UgdGhlIHRpbWVvdXQuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsbG93VGVzdFBhY2thZ2VzIFtmYWxzZV0gLSBTZXQgdG8gdHJ1ZSBpbiBvcmRlciB0byBhbGxvdyB0ZXN0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWNrYWdlcyBpbnN0YWxsYXRpb24uXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IHVzZVNkY2FyZCBbZmFsc2VdIC0gU2V0IHRvIHRydWUgdG8gaW5zdGFsbCB0aGUgYXBwIG9uIHNkY2FyZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RlYWQgb2YgdGhlIGRldmljZSBtZW1vcnkuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGdyYW50UGVybWlzc2lvbnMgW2ZhbHNlXSAtIFNldCB0byB0cnVlIGluIG9yZGVyIHRvIGdyYW50IGFsbCB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVybWlzc2lvbnMgcmVxdWVzdGVkIGluIHRoZSBhcHBsaWNhdGlvbidzIG1hbmlmZXN0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9tYXRpY2FsbHkgYWZ0ZXIgdGhlIGluc3RhbGxhdGlvbiBpcyBjb21wbGV0ZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5kZXIgQW5kcm9pZCA2Ky5cbiAqL1xuXG4vKipcbiAqIEluc3RhbGxzIHRoZSBnaXZlbiAuYXBrcyBwYWNrYWdlIGludG8gdGhlIGRldmljZSB1bmRlciB0ZXN0XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwa3MgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSAuYXBrcyBmaWxlXG4gKiBAcGFyYW0gez9JbnN0YWxsQXBrc09wdGlvbnN9IG9wdGlvbnMgLSBJbnN0YWxsYXRpb24gb3B0aW9uc1xuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSAuYXBrcyBidW5kbGUgY2Fubm90IGJlIGluc3RhbGxlZFxuICovXG5hcGtzVXRpbHNNZXRob2RzLmluc3RhbGxBcGtzID0gYXN5bmMgZnVuY3Rpb24gaW5zdGFsbEFwa3MgKGFwa3MsIG9wdGlvbnMgPSB7fSkge1xuICBvcHRpb25zID0gXy5jbG9uZURlZXAob3B0aW9ucyk7XG4gIF8uZGVmYXVsdHMob3B0aW9ucywge1xuICAgIHRpbWVvdXQ6IHRoaXMuYWRiRXhlY1RpbWVvdXQgPT09IERFRkFVTFRfQURCX0VYRUNfVElNRU9VVCA/IEFQS1NfSU5TVEFMTF9USU1FT1VUIDogdGhpcy5hZGJFeGVjVGltZW91dCxcbiAgICB0aW1lb3V0Q2FwTmFtZTogJ2FuZHJvaWRJbnN0YWxsVGltZW91dCcsXG4gIH0pO1xuICBPYmplY3QuYXNzaWduKG9wdGlvbnMsIHtyZXBsYWNlOiB0cnVlfSk7XG5cbiAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICB0cnkge1xuICAgIGNvbnN0IHNwZWNQYXRoID0gYXdhaXQgdGhpcy5nZXREZXZpY2VTcGVjKHBhdGgucmVzb2x2ZSh0bXBSb290LCAnZGV2aWNlU3BlYy5qc29uJykpO1xuICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAnZXh0cmFjdC1hcGtzJyxcbiAgICAgICctLWFwa3MnLCBhcGtzLFxuICAgICAgJy0tb3V0cHV0LWRpcicsIHRtcFJvb3QsXG4gICAgICAnLS1kZXZpY2Utc3BlYycsIHNwZWNQYXRoLFxuICAgIF07XG4gICAgbG9nLmRlYnVnKGBFeHRyYWN0aW5nIHRoZSBhcGsgZmlsZXMgZnJvbSAnJHthcGtzfSdgKTtcbiAgICBhd2FpdCB0aGlzLmV4ZWNCdW5kbGV0b29sKGFyZ3MsIGBDYW5ub3QgZXh0cmFjdCB0aGUgYXBwbGljYXRpb24gYnVuZGxlIGF0ICcke2Fwa3N9J2ApO1xuICAgIGNvbnN0IGluc3RhbGxBcmdzID0gYnVpbGRJbnN0YWxsQXJncyhhd2FpdCB0aGlzLmdldEFwaUxldmVsKCksIG9wdGlvbnMpO1xuICAgIGNvbnN0IGFwa1BhdGhzVG9JbnN0YWxsID0gKGF3YWl0IGZzLnJlYWRkaXIodG1wUm9vdCkpXG4gICAgICAuZmlsdGVyKChuYW1lKSA9PiBuYW1lLmVuZHNXaXRoKEFQS19FWFRFTlNJT04pKVxuICAgICAgLm1hcCgobmFtZSkgPT4gcGF0aC5yZXNvbHZlKHRtcFJvb3QsIG5hbWUpKTtcbiAgICBsb2cuZGVidWcoJ0dvdCB0aGUgZm9sbG93aW5nIGFwayBmaWxlcyB0byBpbnN0YWxsOiAnICtcbiAgICAgIEpTT04uc3RyaW5naWZ5KGFwa1BhdGhzVG9JbnN0YWxsLm1hcCgoeCkgPT4gcGF0aC5iYXNlbmFtZSh4KSkpKTtcbiAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCB0aGlzLmFkYkV4ZWMoWydpbnN0YWxsLW11bHRpcGxlJywgLi4uaW5zdGFsbEFyZ3MsIC4uLmFwa1BhdGhzVG9JbnN0YWxsXSwge1xuICAgICAgdGltZW91dDogb3B0aW9ucy50aW1lb3V0LFxuICAgICAgdGltZW91dENhcE5hbWU6IG9wdGlvbnMudGltZW91dENhcE5hbWUsXG4gICAgfSk7XG4gICAgY29uc3QgdHJ1bmNhdGVkT3V0cHV0ID0gKCFfLmlzU3RyaW5nKG91dHB1dCkgfHwgb3V0cHV0Lmxlbmd0aCA8PSAzMDApID9cbiAgICAgIG91dHB1dCA6IGAke291dHB1dC5zdWJzdHIoMCwgMTUwKX0uLi4ke291dHB1dC5zdWJzdHIob3V0cHV0Lmxlbmd0aCAtIDE1MCl9YDtcbiAgICBsb2cuZGVidWcoYEluc3RhbGwgY29tbWFuZCBzdGRvdXQ6ICR7dHJ1bmNhdGVkT3V0cHV0fWApO1xuICAgIGlmIChfLmluY2x1ZGVzKG91dHB1dCwgJ0lOU1RBTExfRkFJTEVEJykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihvdXRwdXQpO1xuICAgIH1cbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYodG1wUm9vdCk7XG4gIH1cbn07XG5cbi8qKlxuICogRXh0cmFjdHMgYW5kIHJldHVybnMgdGhlIGZ1bGwgcGF0aCB0byB0aGUgbWFzdGVyIC5hcGsgZmlsZSBpbnNpZGUgdGhlIGJ1bmRsZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrcyAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIC5hcGtzIGZpbGVcbiAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBmdWxsIHBhdGggdG8gdGhlIG1hc3RlciBidW5kbGUgLmFwa1xuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBleHRyYWN0aW5nL2ZpbmRpbmcgdGhlIGZpbGVcbiAqL1xuYXBrc1V0aWxzTWV0aG9kcy5leHRyYWN0QmFzZUFwayA9IGFzeW5jIGZ1bmN0aW9uIGV4dHJhY3RCYXNlQXBrIChhcGtzKSB7XG4gIHJldHVybiBhd2FpdCBleHRyYWN0RnJvbUFwa3MoYXBrcywgWydzcGxpdHMnLCBCQVNFX0FQS10pO1xufTtcblxuLyoqXG4gKiBFeHRyYWN0cyBhbmQgcmV0dXJucyB0aGUgZnVsbCBwYXRoIHRvIHRoZSAuYXBrLCB3aGljaCBjb250YWlucyB0aGUgY29ycmVzcG9uZGluZ1xuICogcmVzb3VyY2VzIGZvciB0aGUgZ2l2ZW4gbGFuZ3VhZ2UgaW4gdGhlIC5hcGtzIGJ1bmRsZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrcyAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIC5hcGtzIGZpbGVcbiAqIEBwYXJhbSB7P3N0cmluZ30gbGFuZ3VhZ2UgLSBUaGUgbGFuZ3VhZ2UgYWJicmV2aWF0aW9uLiBUaGUgZGVmYXVsdCBsYW5ndWFnZSBpc1xuICogZ29pbmcgdG8gYmUgc2VsZWN0ZWQgaWYgaXQgaXMgbm90IHNldC5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBmdWxsIHBhdGggdG8gdGhlIGNvcnJlc3BvbmRpbmcgbGFuZ3VhZ2UgLmFwayBvciB0aGUgbWFzdGVyIC5hcGtcbiAqIGlmIGxhbmd1YWdlIHNwbGl0IGlzIG5vdCBlbmFibGVkIGZvciB0aGUgYnVuZGxlLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBleHRyYWN0aW5nL2ZpbmRpbmcgdGhlIGZpbGVcbiAqL1xuYXBrc1V0aWxzTWV0aG9kcy5leHRyYWN0TGFuZ3VhZ2VBcGsgPSBhc3luYyBmdW5jdGlvbiBleHRyYWN0TGFuZ3VhZ2VBcGsgKGFwa3MsIGxhbmd1YWdlID0gbnVsbCkge1xuICBpZiAobGFuZ3VhZ2UpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IGV4dHJhY3RGcm9tQXBrcyhhcGtzLCBbJ3NwbGl0cycsIExBTkdVQUdFX0FQSyhsYW5ndWFnZSldKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZGVidWcoZS5tZXNzYWdlKTtcbiAgICAgIGxvZy5pbmZvKGBBc3N1bWluZyB0aGF0IHNwbGl0dGluZyBieSBsYW5ndWFnZSBpcyBub3QgZW5hYmxlZCBmb3IgdGhlICcke2Fwa3N9JyBidW5kbGUgYCArXG4gICAgICAgIGBhbmQgcmV0dXJuaW5nIHRoZSBtYWluIGFwayBpbnN0ZWFkYCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5leHRyYWN0QmFzZUFwayhhcGtzKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBkZWZhdWx0TGFuZ3VhZ2VzID0gWydlbicsICdlbl91cyddO1xuICBmb3IgKGNvbnN0IGxhbmcgb2YgZGVmYXVsdExhbmd1YWdlcykge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgZXh0cmFjdEZyb21BcGtzKGFwa3MsIFsnc3BsaXRzJywgTEFOR1VBR0VfQVBLKGxhbmcpXSk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICB9XG5cbiAgbG9nLmluZm8oYENhbm5vdCBmaW5kIGFueSBzcGxpdCBhcGsgZm9yIHRoZSBkZWZhdWx0IGxhbmd1YWdlcyAke0pTT04uc3RyaW5naWZ5KGRlZmF1bHRMYW5ndWFnZXMpfS4gYCArXG4gICAgYFJldHVybmluZyB0aGUgbWFpbiBhcGsgaW5zdGVhZC5gKTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBrcyk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBhcGtzVXRpbHNNZXRob2RzO1xuIl0sImZpbGUiOiJsaWIvdG9vbHMvYXBrcy11dGlscy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
