"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger.js"));

var _helpers = require("../helpers.js");

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _xmldom = _interopRequireDefault(require("xmldom"));

var _xpath = _interopRequireDefault(require("xpath"));

var _shellQuote = require("shell-quote");

let manifestMethods = {};

manifestMethods.processFromManifest = async function processFromManifest(localApk) {
  await this.initAapt();

  _logger.default.info('Retrieving process from manifest');

  let args = ['dump', 'xmltree', localApk, 'AndroidManifest.xml'];
  let {
    stdout
  } = await (0, _teen_process.exec)(this.binaries.aapt, args);
  let result = null;
  let lines = stdout.split('\n');
  let applicationRegex = new RegExp(/\s+E: application \(line=\d+\).*/);
  let applicationFound = false;
  let attributeRegex = new RegExp(/\s+A: .+/);
  let processRegex = new RegExp(/\s+A: android:process\(0x01010011\)="([^"]+).*"/);

  for (let line of lines) {
    if (!applicationFound) {
      if (applicationRegex.test(line)) {
        applicationFound = true;
      }
    } else {
      let notAttribute = !attributeRegex.test(line);

      if (notAttribute) {
        break;
      }

      let process = processRegex.exec(line);

      if (process && process.length > 1) {
        result = process[1];

        if (result.length > 15) {
          result = result.substr(result.length - 15);
        }

        break;
      }
    }
  }

  return result;
};

async function extractApkInfoWithApkTools(localApk, aaptPath, jarPath, tmpRoot) {
  _logger.default.info('Extracting package and launch activity from manifest');

  let args = ['dump', 'badging', localApk];
  let stdout = (await (0, _teen_process.exec)(aaptPath, args)).stdout;
  let apkPackage = new RegExp(/package: name='([^']+)'/g).exec(stdout);

  if (!apkPackage || apkPackage.length < 2) {
    throw new Error(`Cannot parse package name from ` + `'${_lodash.default.join([aaptPath, 'dump', 'badging', '"' + localApk + '"'], ' ')}' command  output`);
  }

  apkPackage = apkPackage[1];
  let apkActivity = new RegExp(/launchable-activity: name='([^']+)'/g).exec(stdout);

  if (apkActivity && apkActivity.length >= 2) {
    apkActivity = apkActivity[1];
    return {
      apkPackage,
      apkActivity
    };
  }

  let outputPath = _path.default.resolve(tmpRoot, apkPackage);

  let getLaunchActivity = ['-jar', jarPath, 'printLaunchActivity', localApk, outputPath];
  const output = await (0, _teen_process.exec)('java', getLaunchActivity);

  if (output.stderr) {
    throw new Error(`Cannot parse launchActivity from manifest: ${output.stderr}`);
  }

  stdout = output.stdout;
  let act = new RegExp(/Launch activity parsed:([^']+)/g).exec(stdout);

  if (act && act.length >= 2) {
    apkActivity = act[1];
    return {
      apkPackage,
      apkActivity
    };
  }

  throw new Error(`Cannot parse main activity name from '${stdout}' command  output`);
}

async function extractApkInfoWithApkanalyzer(localApk, apkanalyzerPath) {
  const args = ['-h', 'manifest', 'print', localApk];

  _logger.default.debug(`Starting '${apkanalyzerPath}' with args ${JSON.stringify(args)}`);

  const manifestXml = (await (0, _teen_process.exec)(apkanalyzerPath, args, {
    shell: true,
    cwd: _path.default.dirname(apkanalyzerPath)
  })).stdout;
  const doc = new _xmldom.default.DOMParser().parseFromString(manifestXml);

  const apkPackageAttribute = _xpath.default.select1('//manifest/@package', doc);

  if (!apkPackageAttribute) {
    throw new Error(`Cannot parse package name from ${manifestXml}`);
  }

  const apkPackage = apkPackageAttribute.value;

  const apkActivityAttribute = _xpath.default.select1("//application/*[starts-with(name(), 'activity') " + "and .//action[@*[local-name()='name' and .='android.intent.action.MAIN']] " + "and .//category[@*[local-name()='name' and .='android.intent.category.LAUNCHER']]]" + "/@*[local-name()='name']", doc);

  if (!apkActivityAttribute) {
    throw new Error(`Cannot parse main activity name from ${manifestXml}`);
  }

  const apkActivity = apkActivityAttribute.value;
  return {
    apkPackage,
    apkActivity
  };
}

manifestMethods.packageAndLaunchActivityFromManifest = async function packageAndLaunchActivityFromManifest(appPath) {
  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  const apkInfoGetters = [async () => {
    const apkanalyzerPath = await (0, _helpers.getApkanalyzerForOs)(this);
    return await extractApkInfoWithApkanalyzer(appPath, apkanalyzerPath);
  }, async () => {
    await this.initAapt();
    return await extractApkInfoWithApkTools(appPath, this.binaries.aapt, this.jars['appium_apk_tools.jar'], this.tmpDir);
  }];
  let savedError;

  for (const infoGetter of apkInfoGetters) {
    try {
      const {
        apkPackage,
        apkActivity
      } = await infoGetter();

      _logger.default.info(`Package name: '${apkPackage}'`);

      _logger.default.info(`Main activity name: '${apkActivity}'`);

      return {
        apkPackage,
        apkActivity
      };
    } catch (e) {
      if (infoGetter !== _lodash.default.last(apkInfoGetters)) {
        _logger.default.info(`Using the alternative activity name detection method because of: ${e.message}`);
      }

      savedError = e;
    }
  }

  throw new Error(`packageAndLaunchActivityFromManifest failed. Original error: ${savedError.message}` + (savedError.stderr ? `; StdErr: ${savedError.stderr}` : ''));
};

manifestMethods.targetSdkVersionFromManifest = async function targetSdkVersionFromManifest(appPath) {
  await this.initAapt();

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  _logger.default.info('Extracting package and launch activity from manifest');

  let args = ['dump', 'badging', appPath];
  let output;

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)(this.binaries.aapt, args);
    output = stdout;
  } catch (e) {
    throw new Error(`fetching targetSdkVersion from local APK failed. Original error: ${e.message}`);
  }

  let targetSdkVersion = new RegExp(/targetSdkVersion:'([^']+)'/g).exec(output);

  if (!targetSdkVersion) {
    throw new Error(`targetSdkVersion is not specified in the application.`);
  }

  return parseInt(targetSdkVersion[1], 10);
};

manifestMethods.targetSdkVersionUsingPKG = async function targetSdkVersionUsingPKG(pkg, cmdOutput = null) {
  let stdout = cmdOutput || (await this.shell(['dumpsys', 'package', pkg]));
  let targetSdkVersion = new RegExp(/targetSdk=([^\s\s]+)/g).exec(stdout);

  if (targetSdkVersion && targetSdkVersion.length >= 2) {
    targetSdkVersion = targetSdkVersion[1];
  } else {
    targetSdkVersion = 0;
  }

  return parseInt(targetSdkVersion, 10);
};

manifestMethods.compileManifest = async function compileManifest(manifest, manifestPackage, targetPackage) {
  const {
    platform,
    platformPath
  } = await (0, _helpers.getAndroidPlatformAndPath)();

  if (!platform) {
    throw new Error('Cannot compile the manifest. The required platform does not exist (API level >= 17)');
  }

  const resultPath = `${manifest}.apk`;
  const args = ['package', '-M', manifest, '--rename-manifest-package', manifestPackage, '--rename-instrumentation-target-package', targetPackage, '-I', _path.default.resolve(platformPath, 'android.jar'), '-F', resultPath, '-f'];

  try {
    await this.initAapt();

    _logger.default.debug(`Compiling the manifest: ${this.binaries.aapt} ${(0, _shellQuote.quote)(args)}`);

    await (0, _teen_process.exec)(this.binaries.aapt, args);

    _logger.default.debug(`Compiled the manifest at '${resultPath}'`);
  } catch (err) {
    throw new Error(`Cannot compile the manifest. Original error: ${err.message}`);
  }
};

manifestMethods.insertManifest = async function insertManifest(manifest, srcApk, dstApk) {
  _logger.default.debug(`Inserting manifest, src: ${srcApk} dst: ${dstApk}`);

  await this.initAapt();
  await (0, _helpers.unzipFile)(`${manifest}.apk`);
  await _appiumSupport.fs.copyFile(srcApk, dstApk);

  _logger.default.debug('Testing new tmp apk');

  await _appiumSupport.zip.assertValidZip(dstApk);

  _logger.default.debug('Moving manifest');

  try {
    await (0, _teen_process.exec)(this.binaries.aapt, ['remove', dstApk, _path.default.basename(manifest)]);
  } catch (ign) {}

  await (0, _teen_process.exec)(this.binaries.aapt, ['add', dstApk, _path.default.basename(manifest)], {
    cwd: _path.default.dirname(manifest)
  });

  _logger.default.debug('Inserted manifest.');
};

manifestMethods.hasInternetPermissionFromManifest = async function hasInternetPermissionFromManifest(appPath) {
  await this.initAapt();

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  _logger.default.debug(`Checking if '${appPath}' requires internet access permission in the manifest`);

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)(this.binaries.aapt, ['dump', 'badging', appPath]);
    return new RegExp(/uses-permission:.*'android.permission.INTERNET'/).test(stdout);
  } catch (e) {
    throw new Error(`Cannot check if '${appPath}' requires internet access permission. ` + `Original error: ${e.message}`);
  }
};

manifestMethods.printManifestFromApk = async function printManifestFromApk(appPath, logLevel = 'debug') {
  await this.initAapt();

  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    appPath = await this.extractBaseApk(appPath);
  }

  _logger.default[logLevel](`Extracting the manifest from '${appPath}'`);

  let out = false;
  const {
    stdout
  } = await (0, _teen_process.exec)(this.binaries.aapt, ['l', '-a', appPath]);

  for (const line of stdout.split('\n')) {
    if (!out && line.includes('Android manifest:')) {
      out = true;
    }

    if (out) {
      _logger.default[logLevel](line);
    }
  }
};

var _default = manifestMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hbmRyb2lkLW1hbmlmZXN0LmpzIl0sIm5hbWVzIjpbIm1hbmlmZXN0TWV0aG9kcyIsInByb2Nlc3NGcm9tTWFuaWZlc3QiLCJsb2NhbEFwayIsImluaXRBYXB0IiwibG9nIiwiaW5mbyIsImFyZ3MiLCJzdGRvdXQiLCJiaW5hcmllcyIsImFhcHQiLCJyZXN1bHQiLCJsaW5lcyIsInNwbGl0IiwiYXBwbGljYXRpb25SZWdleCIsIlJlZ0V4cCIsImFwcGxpY2F0aW9uRm91bmQiLCJhdHRyaWJ1dGVSZWdleCIsInByb2Nlc3NSZWdleCIsImxpbmUiLCJ0ZXN0Iiwibm90QXR0cmlidXRlIiwicHJvY2VzcyIsImV4ZWMiLCJsZW5ndGgiLCJzdWJzdHIiLCJleHRyYWN0QXBrSW5mb1dpdGhBcGtUb29scyIsImFhcHRQYXRoIiwiamFyUGF0aCIsInRtcFJvb3QiLCJhcGtQYWNrYWdlIiwiRXJyb3IiLCJfIiwiam9pbiIsImFwa0FjdGl2aXR5Iiwib3V0cHV0UGF0aCIsInBhdGgiLCJyZXNvbHZlIiwiZ2V0TGF1bmNoQWN0aXZpdHkiLCJvdXRwdXQiLCJzdGRlcnIiLCJhY3QiLCJleHRyYWN0QXBrSW5mb1dpdGhBcGthbmFseXplciIsImFwa2FuYWx5emVyUGF0aCIsImRlYnVnIiwiSlNPTiIsInN0cmluZ2lmeSIsIm1hbmlmZXN0WG1sIiwic2hlbGwiLCJjd2QiLCJkaXJuYW1lIiwiZG9jIiwieG1sZG9tIiwiRE9NUGFyc2VyIiwicGFyc2VGcm9tU3RyaW5nIiwiYXBrUGFja2FnZUF0dHJpYnV0ZSIsInhwYXRoIiwic2VsZWN0MSIsInZhbHVlIiwiYXBrQWN0aXZpdHlBdHRyaWJ1dGUiLCJwYWNrYWdlQW5kTGF1bmNoQWN0aXZpdHlGcm9tTWFuaWZlc3QiLCJhcHBQYXRoIiwiZW5kc1dpdGgiLCJBUEtTX0VYVEVOU0lPTiIsImV4dHJhY3RCYXNlQXBrIiwiYXBrSW5mb0dldHRlcnMiLCJqYXJzIiwidG1wRGlyIiwic2F2ZWRFcnJvciIsImluZm9HZXR0ZXIiLCJlIiwibGFzdCIsIm1lc3NhZ2UiLCJ0YXJnZXRTZGtWZXJzaW9uRnJvbU1hbmlmZXN0IiwidGFyZ2V0U2RrVmVyc2lvbiIsInBhcnNlSW50IiwidGFyZ2V0U2RrVmVyc2lvblVzaW5nUEtHIiwicGtnIiwiY21kT3V0cHV0IiwiY29tcGlsZU1hbmlmZXN0IiwibWFuaWZlc3QiLCJtYW5pZmVzdFBhY2thZ2UiLCJ0YXJnZXRQYWNrYWdlIiwicGxhdGZvcm0iLCJwbGF0Zm9ybVBhdGgiLCJyZXN1bHRQYXRoIiwiZXJyIiwiaW5zZXJ0TWFuaWZlc3QiLCJzcmNBcGsiLCJkc3RBcGsiLCJmcyIsImNvcHlGaWxlIiwiemlwIiwiYXNzZXJ0VmFsaWRaaXAiLCJiYXNlbmFtZSIsImlnbiIsImhhc0ludGVybmV0UGVybWlzc2lvbkZyb21NYW5pZmVzdCIsInByaW50TWFuaWZlc3RGcm9tQXBrIiwibG9nTGV2ZWwiLCJvdXQiLCJpbmNsdWRlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxlQUFlLEdBQUcsRUFBdEI7O0FBTUFBLGVBQWUsQ0FBQ0MsbUJBQWhCLEdBQXNDLGVBQWVBLG1CQUFmLENBQW9DQyxRQUFwQyxFQUE4QztBQUNsRixRQUFNLEtBQUtDLFFBQUwsRUFBTjs7QUFDQUMsa0JBQUlDLElBQUosQ0FBUyxrQ0FBVDs7QUFDQSxNQUFJQyxJQUFJLEdBQUcsQ0FBQyxNQUFELEVBQVMsU0FBVCxFQUFvQkosUUFBcEIsRUFBOEIscUJBQTlCLENBQVg7QUFDQSxNQUFJO0FBQUNLLElBQUFBO0FBQUQsTUFBVyxNQUFNLHdCQUFLLEtBQUtDLFFBQUwsQ0FBY0MsSUFBbkIsRUFBeUJILElBQXpCLENBQXJCO0FBQ0EsTUFBSUksTUFBTSxHQUFHLElBQWI7QUFDQSxNQUFJQyxLQUFLLEdBQUdKLE1BQU0sQ0FBQ0ssS0FBUCxDQUFhLElBQWIsQ0FBWjtBQUNBLE1BQUlDLGdCQUFnQixH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QUFZbUQsT0FBWixDQUF6QixDQUF2Qjs7QUFDQSxPQUFLLE1BQU0xQyxJQUFYLElBQW1CWCxNQUFNLENBQUNLLEtBQVAsQ0FBYSxJQUFiLENBQW5CLEVBQXVDO0FBQ3JDLFFBQUksQ0FBQ3NGLEdBQUQsSUFBUWhGLElBQUksQ0FBQ2lGLFFBQUwsQ0FBYyxtQkFBZCxDQUFaLEVBQWdEO0FBQzlDRCxNQUFBQSxHQUFHLEdBQUcsSUFBTjtBQUNEOztBQUNELFFBQUlBLEdBQUosRUFBUztBQUNQOUYsc0JBQUk2RixRQUFKLEVBQWMvRSxJQUFkO0FBQ0Q7QUFDRjtBQUNGLENBbEJEOztlQXFCZWxCLGUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyLmpzJztcbmltcG9ydCB7XG4gIGdldEFuZHJvaWRQbGF0Zm9ybUFuZFBhdGgsIHVuemlwRmlsZSxcbiAgZ2V0QXBrYW5hbHl6ZXJGb3JPcywgQVBLU19FWFRFTlNJT04gfSBmcm9tICcuLi9oZWxwZXJzLmpzJztcbmltcG9ydCB7IGZzLCB6aXAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeG1sZG9tIGZyb20gJ3htbGRvbSc7XG5pbXBvcnQgeHBhdGggZnJvbSAneHBhdGgnO1xuaW1wb3J0IHsgcXVvdGUgfSBmcm9tICdzaGVsbC1xdW90ZSc7XG5cbmxldCBtYW5pZmVzdE1ldGhvZHMgPSB7fTtcblxuLy8gYW5kcm9pZDpwcm9jZXNzPSBtYXkgYmUgZGVmaW5lZCBpbiBBbmRyb2lkTWFuaWZlc3QueG1sXG4vLyBodHRwOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3JlZmVyZW5jZS9hbmRyb2lkL1IuYXR0ci5odG1sI3Byb2Nlc3Ncbi8vIG5vdGUgdGhhdCB0aGUgcHJvY2VzcyBuYW1lIHdoZW4gdXNlZCB3aXRoIHBzIG11c3QgYmUgdHJ1bmNhdGVkIHRvIHRoZSBsYXN0IDE1IGNoYXJzXG4vLyBwcyAtYyBjb20uZXhhbXBsZS5hbmRyb2lkLmFwaXMgYmVjb21lcyBwcyAtYyBsZS5hbmRyb2lkLmFwaXNcbm1hbmlmZXN0TWV0aG9kcy5wcm9jZXNzRnJvbU1hbmlmZXN0ID0gYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0Zyb21NYW5pZmVzdCAobG9jYWxBcGspIHtcbiAgYXdhaXQgdGhpcy5pbml0QWFwdCgpO1xuICBsb2cuaW5mbygnUmV0cmlldmluZyBwcm9jZXNzIGZyb20gbWFuaWZlc3QnKTtcbiAgbGV0IGFyZ3MgPSBbJ2R1bXAnLCAneG1sdHJlZScsIGxvY2FsQXBrLCAnQW5kcm9pZE1hbmlmZXN0LnhtbCddO1xuICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuYWFwdCwgYXJncyk7XG4gIGxldCByZXN1bHQgPSBudWxsO1xuICBsZXQgbGluZXMgPSBzdGRvdXQuc3BsaXQoJ1xcbicpO1xuICBsZXQgYXBwbGljYXRpb25SZWdleCA9IG5ldyBSZWdFeHAoL1xccytFOiBhcHBsaWNhdGlvbiBcXChsaW5lPVxcZCtcXCkuKi8pO1xuICBsZXQgYXBwbGljYXRpb25Gb3VuZCA9IGZhbHNlO1xuICBsZXQgYXR0cmlidXRlUmVnZXggPSBuZXcgUmVnRXhwKC9cXHMrQTogLisvKTtcbiAgbGV0IHByb2Nlc3NSZWdleCA9IG5ldyBSZWdFeHAoL1xccytBOiBhbmRyb2lkOnByb2Nlc3NcXCgweDAxMDEwMDExXFwpPVwiKFteXCJdKykuKlwiLyk7XG4gIGZvciAobGV0IGxpbmUgb2YgbGluZXMpIHtcbiAgICBpZiAoIWFwcGxpY2F0aW9uRm91bmQpIHtcbiAgICAgIGlmIChhcHBsaWNhdGlvblJlZ2V4LnRlc3QobGluZSkpIHtcbiAgICAgICAgYXBwbGljYXRpb25Gb3VuZCA9IHRydWU7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBub3RBdHRyaWJ1dGUgPSAhYXR0cmlidXRlUmVnZXgudGVzdChsaW5lKTtcbiAgICAgIC8vIHByb2Nlc3MgbXVzdCBiZSBhbiBhdHRyaWJ1dGUgYWZ0ZXIgYXBwbGljYXRpb24uXG4gICAgICBpZiAobm90QXR0cmlidXRlKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgbGV0IHByb2Nlc3MgPSBwcm9jZXNzUmVnZXguZXhlYyhsaW5lKTtcbiAgICAgIC8vIHRoaXMgaXMgYW4gYXBwbGljYXRpb24gYXR0cmlidXRlIHByb2Nlc3MuXG4gICAgICBpZiAocHJvY2VzcyAmJiBwcm9jZXNzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgcmVzdWx0ID0gcHJvY2Vzc1sxXTtcbiAgICAgICAgLy8gbXVzdCB0cmltIHRvIGxhc3QgMTUgZm9yIGFuZHJvaWQncyBwcyBiaW5hcnlcbiAgICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiAxNSkge1xuICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5zdWJzdHIocmVzdWx0Lmxlbmd0aCAtIDE1KTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQVBLSW5mb1xuICogQHByb3BlcnR5IHtzdHJpbmd9IGFwa1BhY2thZ2UgLSBUaGUgbmFtZSBvZiBhcHBsaWNhdGlvbiBwYWNrYWdlLCBmb3IgZXhhbXBsZSAnY29tLmFjbWUuYXBwJy5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBhcGtBY3Rpdml0eSAtIFRoZSBuYW1lIG9mIG1haW4gYXBwbGljYXRpb24gYWN0aXZpdHkuXG4gKi9cblxuLyoqXG4gKiBFeHRyYWN0IHBhY2thZ2UgYW5kIG1haW4gYWN0aXZpdHkgbmFtZSBmcm9tIGFwcGxpY2F0aW9uIG1hbmlmZXN0IHVzaW5nXG4gKiB0aGUgY3VzdG9tIGFwayB0b29scy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbG9jYWxBcGsgLSBUaGUgZnVsbCBwYXRoIHRvIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKiBAcGFyYW0ge3N0cmluZ30gYWFwdFBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIGFwcHQgYmluYXJ5LlxuICogQHBhcmFtIHtzdHJpbmd9IGphclBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIGFwcGl1bV9hcGtfdG9vbHMuamFyIHV0aWxpdHlcbiAqIEBwYXJhbSB7c3RyaW5nfSB0bXBSb290IC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgY2xhc3Mtd2lkZSB0ZW1wb3JhcnkgZm9sZGVyLlxuICogQHJldHVybiB7QVBLSW5mb30gVGhlIHBhcnNlZCBhcHBsaWNhdGlvbiBpbmZvLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBnZXR0aW5nIHRoZSBkYXRhIGZyb20gdGhlIGdpdmVuXG4gKiAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gcGFja2FnZS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZXh0cmFjdEFwa0luZm9XaXRoQXBrVG9vbHMgKGxvY2FsQXBrLCBhYXB0UGF0aCwgamFyUGF0aCwgdG1wUm9vdCkge1xuICBsb2cuaW5mbygnRXh0cmFjdGluZyBwYWNrYWdlIGFuZCBsYXVuY2ggYWN0aXZpdHkgZnJvbSBtYW5pZmVzdCcpO1xuICBsZXQgYXJncyA9IFsnZHVtcCcsICdiYWRnaW5nJywgbG9jYWxBcGtdO1xuICBsZXQgc3Rkb3V0ID0gKGF3YWl0IGV4ZWMoYWFwdFBhdGgsIGFyZ3MpKS5zdGRvdXQ7XG4gIGxldCBhcGtQYWNrYWdlID0gbmV3IFJlZ0V4cCgvcGFja2FnZTogbmFtZT0nKFteJ10rKScvZykuZXhlYyhzdGRvdXQpO1xuICBpZiAoIWFwa1BhY2thZ2UgfHwgYXBrUGFja2FnZS5sZW5ndGggPCAyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgcGFja2FnZSBuYW1lIGZyb20gYCArXG4gICAgICBgJyR7Xy5qb2luKFthYXB0UGF0aCwgJ2R1bXAnLCAnYmFkZ2luZycsICdcIicgKyBsb2NhbEFwayArICdcIiddLCAnICcpfScgY29tbWFuZCAgb3V0cHV0YCk7XG4gIH1cbiAgYXBrUGFja2FnZSA9IGFwa1BhY2thZ2VbMV07XG4gIGxldCBhcGtBY3Rpdml0eSA9IG5ldyBSZWdFeHAoL2xhdW5jaGFibGUtYWN0aXZpdHk6IG5hbWU9JyhbXiddKyknL2cpLmV4ZWMoc3Rkb3V0KTtcbiAgaWYgKGFwa0FjdGl2aXR5ICYmIGFwa0FjdGl2aXR5Lmxlbmd0aCA+PSAyKSB7XG4gICAgYXBrQWN0aXZpdHkgPSBhcGtBY3Rpdml0eVsxXTtcbiAgICByZXR1cm4ge2Fwa1BhY2thZ2UsIGFwa0FjdGl2aXR5fTtcbiAgfVxuXG4gIGxldCBvdXRwdXRQYXRoID0gcGF0aC5yZXNvbHZlKHRtcFJvb3QsIGFwa1BhY2thZ2UpO1xuICBsZXQgZ2V0TGF1bmNoQWN0aXZpdHkgPSBbXG4gICAgJy1qYXInLCBqYXJQYXRoLFxuICAgICdwcmludExhdW5jaEFjdGl2aXR5JywgbG9jYWxBcGssXG4gICAgb3V0cHV0UGF0aFxuICBdO1xuICBjb25zdCBvdXRwdXQgPSBhd2FpdCBleGVjKCdqYXZhJywgZ2V0TGF1bmNoQWN0aXZpdHkpO1xuICBpZiAob3V0cHV0LnN0ZGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHBhcnNlIGxhdW5jaEFjdGl2aXR5IGZyb20gbWFuaWZlc3Q6ICR7b3V0cHV0LnN0ZGVycn1gKTtcbiAgfVxuICBzdGRvdXQgPSBvdXRwdXQuc3Rkb3V0O1xuICBsZXQgYWN0ID0gbmV3IFJlZ0V4cCgvTGF1bmNoIGFjdGl2aXR5IHBhcnNlZDooW14nXSspL2cpLmV4ZWMoc3Rkb3V0KTtcbiAgaWYgKGFjdCAmJiBhY3QubGVuZ3RoID49IDIpIHtcbiAgICBhcGtBY3Rpdml0eSA9IGFjdFsxXTtcbiAgICByZXR1cm4ge2Fwa1BhY2thZ2UsIGFwa0FjdGl2aXR5fTtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBwYXJzZSBtYWluIGFjdGl2aXR5IG5hbWUgZnJvbSAnJHtzdGRvdXR9JyBjb21tYW5kICBvdXRwdXRgKTtcbn1cblxuLyoqXG4gKiBFeHRyYWN0IHBhY2thZ2UgYW5kIG1haW4gYWN0aXZpdHkgbmFtZSBmcm9tIGFwcGxpY2F0aW9uIG1hbmlmZXN0IHVzaW5nXG4gKiBhcGthbmFseXplciB0b29sLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhbEFwayAtIFRoZSBmdWxsIHBhdGggdG8gYXBwbGljYXRpb24gcGFja2FnZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGthbmFseXplclBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIGFwa2FuYWx5emVyIHRvb2wuXG4gKiBAcmV0dXJuIHtBUEtJbmZvfSBUaGUgcGFyc2VkIGFwcGxpY2F0aW9uIGluZm8uXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIGRhdGEgZnJvbSB0aGUgZ2l2ZW5cbiAqICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBwYWNrYWdlIG9yIGlmIHRoZSB0b29sIGl0c2VsZlxuICogICAgICAgICAgICAgICAgIGlzIG5vdCBwcmVzZW50IG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZXh0cmFjdEFwa0luZm9XaXRoQXBrYW5hbHl6ZXIgKGxvY2FsQXBrLCBhcGthbmFseXplclBhdGgpIHtcbiAgY29uc3QgYXJncyA9IFsnLWgnLCAnbWFuaWZlc3QnLCAncHJpbnQnLCBsb2NhbEFwa107XG4gIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgJyR7YXBrYW5hbHl6ZXJQYXRofScgd2l0aCBhcmdzICR7SlNPTi5zdHJpbmdpZnkoYXJncyl9YCk7XG4gIGNvbnN0IG1hbmlmZXN0WG1sID0gKGF3YWl0IGV4ZWMoYXBrYW5hbHl6ZXJQYXRoLCBhcmdzLCB7XG4gICAgc2hlbGw6IHRydWUsXG4gICAgY3dkOiBwYXRoLmRpcm5hbWUoYXBrYW5hbHl6ZXJQYXRoKVxuICB9KSkuc3Rkb3V0O1xuICBjb25zdCBkb2MgPSBuZXcgeG1sZG9tLkRPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhtYW5pZmVzdFhtbCk7XG4gIGNvbnN0IGFwa1BhY2thZ2VBdHRyaWJ1dGUgPSB4cGF0aC5zZWxlY3QxKCcvL21hbmlmZXN0L0BwYWNrYWdlJywgZG9jKTtcbiAgaWYgKCFhcGtQYWNrYWdlQXR0cmlidXRlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgcGFja2FnZSBuYW1lIGZyb20gJHttYW5pZmVzdFhtbH1gKTtcbiAgfVxuICBjb25zdCBhcGtQYWNrYWdlID0gYXBrUGFja2FnZUF0dHJpYnV0ZS52YWx1ZTtcbiAgLy8gTG9vayBmb3IgYWN0aXZpdHkgb3IgYWN0aXZpdHktYWxpYXMgd2l0aFxuICAvLyBhY3Rpb24gPT0gYW5kcm9pZC5pbnRlbnQuYWN0aW9uLk1BSU4gYW5kXG4gIC8vIGNhdGVnb3J5ID09IGFuZHJvaWQuaW50ZW50LmNhdGVnb3J5LkxBVU5DSEVSXG4gIC8vIGRlc2NlbmRhbnRzXG4gIGNvbnN0IGFwa0FjdGl2aXR5QXR0cmlidXRlID0geHBhdGguc2VsZWN0MShcbiAgICBcIi8vYXBwbGljYXRpb24vKltzdGFydHMtd2l0aChuYW1lKCksICdhY3Rpdml0eScpIFwiICtcbiAgICBcImFuZCAuLy9hY3Rpb25bQCpbbG9jYWwtbmFtZSgpPSduYW1lJyBhbmQgLj0nYW5kcm9pZC5pbnRlbnQuYWN0aW9uLk1BSU4nXV0gXCIgK1xuICAgIFwiYW5kIC4vL2NhdGVnb3J5W0AqW2xvY2FsLW5hbWUoKT0nbmFtZScgYW5kIC49J2FuZHJvaWQuaW50ZW50LmNhdGVnb3J5LkxBVU5DSEVSJ11dXVwiICtcbiAgICBcIi9AKltsb2NhbC1uYW1lKCk9J25hbWUnXVwiLCBkb2MpO1xuICBpZiAoIWFwa0FjdGl2aXR5QXR0cmlidXRlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgbWFpbiBhY3Rpdml0eSBuYW1lIGZyb20gJHttYW5pZmVzdFhtbH1gKTtcbiAgfVxuICBjb25zdCBhcGtBY3Rpdml0eSA9IGFwa0FjdGl2aXR5QXR0cmlidXRlLnZhbHVlO1xuICByZXR1cm4ge2Fwa1BhY2thZ2UsIGFwa0FjdGl2aXR5fTtcbn1cblxuLyoqXG4gKiBFeHRyYWN0IHBhY2thZ2UgYW5kIG1haW4gYWN0aXZpdHkgbmFtZSBmcm9tIGFwcGxpY2F0aW9uIG1hbmlmZXN0LlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byBhcHBsaWNhdGlvbiAuYXBrKHMpIHBhY2thZ2VcbiAqIEByZXR1cm4ge0FQS0luZm99IFRoZSBwYXJzZWQgYXBwbGljYXRpb24gaW5mby5cbiAqIEB0aHJvd3Mge2Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgZ2V0dGluZyB0aGUgZGF0YSBmcm9tIHRoZSBnaXZlblxuICogICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy5wYWNrYWdlQW5kTGF1bmNoQWN0aXZpdHlGcm9tTWFuaWZlc3QgPSBhc3luYyBmdW5jdGlvbiBwYWNrYWdlQW5kTGF1bmNoQWN0aXZpdHlGcm9tTWFuaWZlc3QgKGFwcFBhdGgpIHtcbiAgaWYgKGFwcFBhdGguZW5kc1dpdGgoQVBLU19FWFRFTlNJT04pKSB7XG4gICAgYXBwUGF0aCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBwUGF0aCk7XG4gIH1cblxuICBjb25zdCBhcGtJbmZvR2V0dGVycyA9IFtcbiAgICBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhcGthbmFseXplclBhdGggPSBhd2FpdCBnZXRBcGthbmFseXplckZvck9zKHRoaXMpO1xuICAgICAgcmV0dXJuIGF3YWl0IGV4dHJhY3RBcGtJbmZvV2l0aEFwa2FuYWx5emVyKGFwcFBhdGgsIGFwa2FuYWx5emVyUGF0aCk7XG4gICAgfSxcbiAgICBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLmluaXRBYXB0KCk7XG4gICAgICByZXR1cm4gYXdhaXQgZXh0cmFjdEFwa0luZm9XaXRoQXBrVG9vbHMoYXBwUGF0aCxcbiAgICAgICAgdGhpcy5iaW5hcmllcy5hYXB0LCB0aGlzLmphcnNbJ2FwcGl1bV9hcGtfdG9vbHMuamFyJ10sIHRoaXMudG1wRGlyKTtcbiAgICB9LFxuICBdO1xuXG4gIGxldCBzYXZlZEVycm9yO1xuICBmb3IgKGNvbnN0IGluZm9HZXR0ZXIgb2YgYXBrSW5mb0dldHRlcnMpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qge2Fwa1BhY2thZ2UsIGFwa0FjdGl2aXR5fSA9IGF3YWl0IGluZm9HZXR0ZXIoKTtcbiAgICAgIGxvZy5pbmZvKGBQYWNrYWdlIG5hbWU6ICcke2Fwa1BhY2thZ2V9J2ApO1xuICAgICAgbG9nLmluZm8oYE1haW4gYWN0aXZpdHkgbmFtZTogJyR7YXBrQWN0aXZpdHl9J2ApO1xuICAgICAgcmV0dXJuIHthcGtQYWNrYWdlLCBhcGtBY3Rpdml0eX07XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGluZm9HZXR0ZXIgIT09IF8ubGFzdChhcGtJbmZvR2V0dGVycykpIHtcbiAgICAgICAgbG9nLmluZm8oYFVzaW5nIHRoZSBhbHRlcm5hdGl2ZSBhY3Rpdml0eSBuYW1lIGRldGVjdGlvbiBtZXRob2QgYmVjYXVzZSBvZjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgICBzYXZlZEVycm9yID0gZTtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBwYWNrYWdlQW5kTGF1bmNoQWN0aXZpdHlGcm9tTWFuaWZlc3QgZmFpbGVkLiBPcmlnaW5hbCBlcnJvcjogJHtzYXZlZEVycm9yLm1lc3NhZ2V9YCArXG4gICAgICAgICAgICAgICAgICAoc2F2ZWRFcnJvci5zdGRlcnIgPyBgOyBTdGRFcnI6ICR7c2F2ZWRFcnJvci5zdGRlcnJ9YCA6ICcnKSk7XG59O1xuXG4vKipcbiAqIEV4dHJhY3QgdGFyZ2V0IFNESyB2ZXJzaW9uIGZyb20gYXBwbGljYXRpb24gbWFuaWZlc3QuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBUaGUgZnVsbCBwYXRoIHRvIC5hcGsocykgcGFja2FnZS5cbiAqIEByZXR1cm4ge251bWJlcn0gVGhlIHZlcnNpb24gb2YgdGhlIHRhcmdldCBTREsuXG4gKiBAdGhyb3dzIHtlcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIGRhdGEgZnJvbSB0aGUgZ2l2ZW5cbiAqICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICovXG5tYW5pZmVzdE1ldGhvZHMudGFyZ2V0U2RrVmVyc2lvbkZyb21NYW5pZmVzdCA9IGFzeW5jIGZ1bmN0aW9uIHRhcmdldFNka1ZlcnNpb25Gcm9tTWFuaWZlc3QgKGFwcFBhdGgpIHtcbiAgYXdhaXQgdGhpcy5pbml0QWFwdCgpO1xuXG4gIGlmIChhcHBQYXRoLmVuZHNXaXRoKEFQS1NfRVhURU5TSU9OKSkge1xuICAgIGFwcFBhdGggPSBhd2FpdCB0aGlzLmV4dHJhY3RCYXNlQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgbG9nLmluZm8oJ0V4dHJhY3RpbmcgcGFja2FnZSBhbmQgbGF1bmNoIGFjdGl2aXR5IGZyb20gbWFuaWZlc3QnKTtcbiAgbGV0IGFyZ3MgPSBbJ2R1bXAnLCAnYmFkZ2luZycsIGFwcFBhdGhdO1xuICBsZXQgb3V0cHV0O1xuICB0cnkge1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBhcmdzKTtcbiAgICBvdXRwdXQgPSBzdGRvdXQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGZldGNoaW5nIHRhcmdldFNka1ZlcnNpb24gZnJvbSBsb2NhbCBBUEsgZmFpbGVkLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbiAgbGV0IHRhcmdldFNka1ZlcnNpb24gPSBuZXcgUmVnRXhwKC90YXJnZXRTZGtWZXJzaW9uOicoW14nXSspJy9nKS5leGVjKG91dHB1dCk7XG4gIGlmICghdGFyZ2V0U2RrVmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihgdGFyZ2V0U2RrVmVyc2lvbiBpcyBub3Qgc3BlY2lmaWVkIGluIHRoZSBhcHBsaWNhdGlvbi5gKTtcbiAgfVxuICByZXR1cm4gcGFyc2VJbnQodGFyZ2V0U2RrVmVyc2lvblsxXSwgMTApO1xufTtcblxuLyoqXG4gKiBFeHRyYWN0IHRhcmdldCBTREsgdmVyc2lvbiBmcm9tIHBhY2thZ2UgaW5mb3JtYXRpb24uXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBrZyAtIFRoZSBjbGFzcyBuYW1lIG9mIHRoZSBwYWNrYWdlIGluc3RhbGxlZCBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiBAcGFyYW0gez9zdHJpbmd9IGNtZE91dHB1dCAtIE9wdGlvbmFsIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSBvdXRwdXQgb2ZcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2R1bXBzeXMgcGFja2FnZV8gY29tbWFuZC4gSXQgbWF5IHNwZWVkIHVwIHRoZSBtZXRob2QgZXhlY3V0aW9uLlxuICogQHJldHVybiB7bnVtYmVyfSBUaGUgdmVyc2lvbiBvZiB0aGUgdGFyZ2V0IFNESy5cbiAqL1xubWFuaWZlc3RNZXRob2RzLnRhcmdldFNka1ZlcnNpb25Vc2luZ1BLRyA9IGFzeW5jIGZ1bmN0aW9uIHRhcmdldFNka1ZlcnNpb25Vc2luZ1BLRyAocGtnLCBjbWRPdXRwdXQgPSBudWxsKSB7XG4gIGxldCBzdGRvdXQgPSBjbWRPdXRwdXQgfHwgYXdhaXQgdGhpcy5zaGVsbChbJ2R1bXBzeXMnLCAncGFja2FnZScsIHBrZ10pO1xuICBsZXQgdGFyZ2V0U2RrVmVyc2lvbiA9IG5ldyBSZWdFeHAoL3RhcmdldFNkaz0oW15cXHNcXHNdKykvZykuZXhlYyhzdGRvdXQpO1xuICBpZiAodGFyZ2V0U2RrVmVyc2lvbiAmJiB0YXJnZXRTZGtWZXJzaW9uLmxlbmd0aCA+PSAyKSB7XG4gICAgdGFyZ2V0U2RrVmVyc2lvbiA9IHRhcmdldFNka1ZlcnNpb25bMV07XG4gIH0gZWxzZSB7XG4gICAgLy8gdGFyZ2V0U2RrIG5vdCBmb3VuZCBpbiB0aGUgZHVtcCwgYXNzaWduaW5nIDAgdG8gdGFyZ2V0U2RrVmVyc2lvblxuICAgIHRhcmdldFNka1ZlcnNpb24gPSAwO1xuICB9XG4gIHJldHVybiBwYXJzZUludCh0YXJnZXRTZGtWZXJzaW9uLCAxMCk7XG59O1xuXG4vKipcbiAqIENyZWF0ZSBiaW5hcnkgcmVwcmVzZW50YXRpb24gb2YgcGFja2FnZSBtYW5pZmVzdCAodXN1YWxseSBBbmRyb2lkTWFuaWZlc3QueG1sKS5cbiAqIGAke21hbmlmZXN0fS5hcGtgIGZpbGUgd2lsbCBiZSBjcmVhdGVkIGFzIHRoZSByZXN1bHQgb2YgdGhpcyBtZXRob2RcbiAqIGNvbnRhaW5pbmcgdGhlIGNvbXBpbGVkIG1hbmlmZXN0LlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBtYW5pZmVzdCAtIEZ1bGwgcGF0aCB0byB0aGUgaW5pdGlhbCBtYW5pZmVzdCB0ZW1wbGF0ZVxuICogQHBhcmFtIHtzdHJpbmd9IG1hbmlmZXN0UGFja2FnZSAtIFRoZSBuYW1lIG9mIHRoZSBtYW5pZmVzdCBwYWNrYWdlXG4gKiBAcGFyYW0ge3N0cmluZ30gdGFyZ2V0UGFja2FnZSAtIFRoZSBuYW1lIG9mIHRoZSBkZXN0aW5hdGlvbiBwYWNrYWdlXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy5jb21waWxlTWFuaWZlc3QgPSBhc3luYyBmdW5jdGlvbiBjb21waWxlTWFuaWZlc3QgKG1hbmlmZXN0LCBtYW5pZmVzdFBhY2thZ2UsIHRhcmdldFBhY2thZ2UpIHtcbiAgY29uc3Qge3BsYXRmb3JtLCBwbGF0Zm9ybVBhdGh9ID0gYXdhaXQgZ2V0QW5kcm9pZFBsYXRmb3JtQW5kUGF0aCgpO1xuICBpZiAoIXBsYXRmb3JtKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgY29tcGlsZSB0aGUgbWFuaWZlc3QuIFRoZSByZXF1aXJlZCBwbGF0Zm9ybSBkb2VzIG5vdCBleGlzdCAoQVBJIGxldmVsID49IDE3KScpO1xuICB9XG4gIGNvbnN0IHJlc3VsdFBhdGggPSBgJHttYW5pZmVzdH0uYXBrYDtcbiAgY29uc3QgYXJncyA9IFtcbiAgICAncGFja2FnZScsXG4gICAgJy1NJywgbWFuaWZlc3QsXG4gICAgJy0tcmVuYW1lLW1hbmlmZXN0LXBhY2thZ2UnLCBtYW5pZmVzdFBhY2thZ2UsXG4gICAgJy0tcmVuYW1lLWluc3RydW1lbnRhdGlvbi10YXJnZXQtcGFja2FnZScsIHRhcmdldFBhY2thZ2UsXG4gICAgJy1JJywgcGF0aC5yZXNvbHZlKHBsYXRmb3JtUGF0aCwgJ2FuZHJvaWQuamFyJyksXG4gICAgJy1GJywgcmVzdWx0UGF0aCxcbiAgICAnLWYnLFxuICBdO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuaW5pdEFhcHQoKTtcbiAgICBsb2cuZGVidWcoYENvbXBpbGluZyB0aGUgbWFuaWZlc3Q6ICR7dGhpcy5iaW5hcmllcy5hYXB0fSAke3F1b3RlKGFyZ3MpfWApO1xuICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy5hYXB0LCBhcmdzKTtcbiAgICBsb2cuZGVidWcoYENvbXBpbGVkIHRoZSBtYW5pZmVzdCBhdCAnJHtyZXN1bHRQYXRofSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY29tcGlsZSB0aGUgbWFuaWZlc3QuIE9yaWdpbmFsIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG59O1xuXG4vKipcbiAqIFJlcGxhY2UvaW5zZXJ0IHRoZSBzcGVjaWFsbHkgcHJlY29tcGlsZWQgbWFuaWZlc3QgZmlsZSBpbnRvIHRoZVxuICogcGFydGljdWxhciBwYWNrYWdlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBtYW5pZmVzdCAtIEZ1bGwgcGF0aCB0byB0aGUgcHJlY29tcGlsZWQgbWFuaWZlc3RcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZWQgYnkgYGNvbXBpbGVNYW5pZmVzdGAgbWV0aG9kIGNhbGxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpdGhvdXQgLmFwayBleHRlbnNpb25cbiAqIEBwYXJhbSB7c3RyaW5nfSBzcmNBcGsgLSBGdWxsIHBhdGggdG8gdGhlIGV4aXN0aW5nIHZhbGlkIGFwcGxpY2F0aW9uIHBhY2thZ2UsIHdoZXJlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcyBtYW5pZmVzdCBoYXMgdG8gYmUgaW5zZXRyZWQgdG8uIFRoaXMgcGFja2FnZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGwgTk9UIGJlIG1vZGlmaWVkLlxuICogQHBhcmFtIHtzdHJpbmd9IGRzdEFwayAtIEZ1bGwgcGF0aCB0byB0aGUgcmVzdWx0aW5nIHBhY2thZ2UuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGZpbGUgd2lsbCBiZSBvdmVycmlkZW4gaWYgaXQgYWxyZWFkeSBleGlzdHMuXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy5pbnNlcnRNYW5pZmVzdCA9IGFzeW5jIGZ1bmN0aW9uIGluc2VydE1hbmlmZXN0IChtYW5pZmVzdCwgc3JjQXBrLCBkc3RBcGspIHtcbiAgbG9nLmRlYnVnKGBJbnNlcnRpbmcgbWFuaWZlc3QsIHNyYzogJHtzcmNBcGt9IGRzdDogJHtkc3RBcGt9YCk7XG4gIGF3YWl0IHRoaXMuaW5pdEFhcHQoKTtcbiAgYXdhaXQgdW56aXBGaWxlKGAke21hbmlmZXN0fS5hcGtgKTtcbiAgYXdhaXQgZnMuY29weUZpbGUoc3JjQXBrLCBkc3RBcGspO1xuICBsb2cuZGVidWcoJ1Rlc3RpbmcgbmV3IHRtcCBhcGsnKTtcbiAgYXdhaXQgemlwLmFzc2VydFZhbGlkWmlwKGRzdEFwayk7XG4gIGxvZy5kZWJ1ZygnTW92aW5nIG1hbmlmZXN0Jyk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQsIFtcbiAgICAgICdyZW1vdmUnLCBkc3RBcGssIHBhdGguYmFzZW5hbWUobWFuaWZlc3QpXG4gICAgXSk7XG4gIH0gY2F0Y2ggKGlnbikge31cbiAgYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQsIFtcbiAgICAnYWRkJywgZHN0QXBrLCBwYXRoLmJhc2VuYW1lKG1hbmlmZXN0KVxuICBdLCB7Y3dkOiBwYXRoLmRpcm5hbWUobWFuaWZlc3QpfSk7XG4gIGxvZy5kZWJ1ZygnSW5zZXJ0ZWQgbWFuaWZlc3QuJyk7XG59O1xuXG4vKipcbiAqIENoZWNrIHdoZXRoZXIgcGFja2FnZSBtYW5pZmVzdCBjb250YWlucyBJbnRlcm5ldCBwZXJtaXNzaW9ucy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gLmFwayhzKSBwYWNrYWdlLlxuICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgbWFuaWZlc3QgcmVxdWlyZXMgSW50ZXJuZXQgYWNjZXNzIHBlcm1pc3Npb24uXG4gKi9cbm1hbmlmZXN0TWV0aG9kcy5oYXNJbnRlcm5ldFBlcm1pc3Npb25Gcm9tTWFuaWZlc3QgPSBhc3luYyBmdW5jdGlvbiBoYXNJbnRlcm5ldFBlcm1pc3Npb25Gcm9tTWFuaWZlc3QgKGFwcFBhdGgpIHtcbiAgYXdhaXQgdGhpcy5pbml0QWFwdCgpO1xuXG4gIGlmIChhcHBQYXRoLmVuZHNXaXRoKEFQS1NfRVhURU5TSU9OKSkge1xuICAgIGFwcFBhdGggPSBhd2FpdCB0aGlzLmV4dHJhY3RCYXNlQXBrKGFwcFBhdGgpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBDaGVja2luZyBpZiAnJHthcHBQYXRofScgcmVxdWlyZXMgaW50ZXJuZXQgYWNjZXNzIHBlcm1pc3Npb24gaW4gdGhlIG1hbmlmZXN0YCk7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQsIFsnZHVtcCcsICdiYWRnaW5nJywgYXBwUGF0aF0pO1xuICAgIHJldHVybiBuZXcgUmVnRXhwKC91c2VzLXBlcm1pc3Npb246LionYW5kcm9pZC5wZXJtaXNzaW9uLklOVEVSTkVUJy8pLnRlc3Qoc3Rkb3V0KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGNoZWNrIGlmICcke2FwcFBhdGh9JyByZXF1aXJlcyBpbnRlcm5ldCBhY2Nlc3MgcGVybWlzc2lvbi4gYCArXG4gICAgICAgICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbn07XG5cbi8qKlxuICogUHJpbnRzIG91dCB0aGUgbWFuaWZlc3QgZXh0cmFjdGVkIGZyb20gdGhlIGFwa1xuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICogQHBhcmFtIHs/c3RyaW5nfSBsb2dMZXZlbCAtIFRoZSBsZXZlbCBhdCB3aGljaCB0byBsb2cuIEUuZy4sICdkZWJ1ZydcbiAqL1xubWFuaWZlc3RNZXRob2RzLnByaW50TWFuaWZlc3RGcm9tQXBrID0gYXN5bmMgZnVuY3Rpb24gcHJpbnRNYW5pZmVzdEZyb21BcGsgKGFwcFBhdGgsIGxvZ0xldmVsID0gJ2RlYnVnJykge1xuICBhd2FpdCB0aGlzLmluaXRBYXB0KCk7XG5cbiAgaWYgKGFwcFBhdGguZW5kc1dpdGgoQVBLU19FWFRFTlNJT04pKSB7XG4gICAgYXBwUGF0aCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBwUGF0aCk7XG4gIH1cblxuICBsb2dbbG9nTGV2ZWxdKGBFeHRyYWN0aW5nIHRoZSBtYW5pZmVzdCBmcm9tICcke2FwcFBhdGh9J2ApO1xuICBsZXQgb3V0ID0gZmFsc2U7XG4gIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLmFhcHQsIFsnbCcsICctYScsIGFwcFBhdGhdKTtcbiAgZm9yIChjb25zdCBsaW5lIG9mIHN0ZG91dC5zcGxpdCgnXFxuJykpIHtcbiAgICBpZiAoIW91dCAmJiBsaW5lLmluY2x1ZGVzKCdBbmRyb2lkIG1hbmlmZXN0OicpKSB7XG4gICAgICBvdXQgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAob3V0KSB7XG4gICAgICBsb2dbbG9nTGV2ZWxdKGxpbmUpO1xuICAgIH1cbiAgfVxufTtcblxuXG5leHBvcnQgZGVmYXVsdCBtYW5pZmVzdE1ldGhvZHM7XG4iXSwiZmlsZSI6ImxpYi90b29scy9hbmRyb2lkLW1hbmlmZXN0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
