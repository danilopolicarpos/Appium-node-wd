"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.killAllSimulators = killAllSimulators;
exports.endAllSimulatorDaemons = endAllSimulatorDaemons;
exports.safeRimRaf = safeRimRaf;
exports.simExists = simExists;
exports.getSimulatorInfo = getSimulatorInfo;
exports.installSSLCert = installSSLCert;
exports.uninstallSSLCert = uninstallSSLCert;
exports.hasSSLCert = hasSSLCert;
exports.execSQLiteQuery = execSQLiteQuery;
exports.toBiometricDomainComponent = toBiometricDomainComponent;
exports.getDeveloperRoot = getDeveloperRoot;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _asyncbox = require("asyncbox");

var _appiumXcode = require("appium-xcode");

var _nodeSimctl = require("node-simctl");

var _appiumSupport = require("appium-support");

var _certificate = require("./certificate");

var _path = _interopRequireDefault(require("path"));

var _simulatorXcode = _interopRequireDefault(require("./simulator-xcode-6"));

var _fkill = _interopRequireDefault(require("fkill"));

const DEFAULT_SIM_SHUTDOWN_TIMEOUT = 30000;
const BIOMETRICS = {
  touchId: 'fingerTouch',
  faceId: 'pearl'
};

function toBiometricDomainComponent(name) {
  if (!BIOMETRICS[name]) {
    throw new Error(`'${name}' is not a valid biometric. Use one of: ${JSON.stringify(_lodash.default.keys(BIOMETRICS))}`);
  }

  return BIOMETRICS[name];
}

async function pkill(appName, forceKill = false) {
  let args = forceKill ? ['-9'] : [];
  args.push('-x', appName);

  try {
    await (0, _teen_process.exec)('pkill', args);
    return 0;
  } catch (err) {
    if (!_lodash.default.isUndefined(err.code)) {
      throw new Error(`Cannot forcefully terminate ${appName}. pkill error code: ${err.code}`);
    }

    _logger.default.error(`Received unexpected error while trying to kill ${appName}: ${err.message}`);

    throw err;
  }
}

async function killAllSimulators(timeout = DEFAULT_SIM_SHUTDOWN_TIMEOUT) {
  _logger.default.debug('Killing all iOS Simulators');

  const xcodeVersion = await (0, _appiumXcode.getVersion)(true);
  const appName = xcodeVersion.major >= 7 ? 'Simulator' : 'iOS Simulator';
  timeout = timeout * (xcodeVersion.major >= 8 ? 2 : 1);

  try {
    await (0, _teen_process.exec)('xcrun', ['simctl', 'shutdown', xcodeVersion.major > 8 ? 'all' : 'booted'], {
      timeout
    });
  } catch (ign) {}

  const pids = [];

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)('pgrep', ['-f', `${appName}.app/Contents/MacOS/`]);

    if (stdout.trim()) {
      pids.push(...stdout.trim().split(/\s+/));
    }
  } catch (e) {
    if (e.code === 1) {
      _logger.default.debug(`${appName} is not running. Continuing...`);

      return;
    }

    if (_lodash.default.isEmpty(pids)) {
      _logger.default.warn(`pgrep error ${e.code} while detecting whether ${appName} is running. Trying to kill anyway.`);
    }
  }

  if (!_lodash.default.isEmpty(pids)) {
    _logger.default.debug(`Using fkill to kill processes: ${pids.join(', ')}`);

    try {
      await (0, _fkill.default)(pids, {
        force: true
      });
    } catch (ign) {}
  }

  _logger.default.debug(`Using pkill to kill application: ${appName}`);

  try {
    await pkill(appName, true);
  } catch (ign) {}

  let remainingDevices = [];

  async function allSimsAreDown() {
    remainingDevices = [];
    let devices = await (0, _nodeSimctl.getDevices)();
    devices = _lodash.default.flatten(_lodash.default.values(devices));
    return _lodash.default.every(devices, sim => {
      let state = sim.state.toLowerCase();
      let done = state === 'shutdown' || state === 'unavailable' || state === 'disconnected';

      if (!done) {
        remainingDevices.push(`${sim.name} (${sim.sdk}, udid: ${sim.udid}) is still in state '${state}'`);
      }

      return done;
    });
  }

  try {
    await (0, _asyncbox.waitForCondition)(allSimsAreDown, {
      waitMs: timeout,
      intervalMs: 200
    });
  } catch (err) {
    if (remainingDevices.length > 0) {
      _logger.default.warn(`The following devices are still not in the correct state after ${timeout} ms:`);

      for (let device of remainingDevices) {
        _logger.default.warn(`    ${device}`);
      }
    }

    throw err;
  }
}

async function endAllSimulatorDaemons() {
  _logger.default.debug('Ending all simulator daemons');

  for (let servicePattern of ['com.apple.iphonesimulator', 'com.apple.CoreSimulator']) {
    _logger.default.debug(`Killing any other ${servicePattern} daemons`);

    let launchCtlCommand = `launchctl list | grep ${servicePattern} | cut -f 3 | xargs -n 1 launchctl`;

    try {
      let stopCmd = `${launchCtlCommand} stop`;
      await (0, _teen_process.exec)('bash', ['-c', stopCmd]);
    } catch (err) {
      _logger.default.warn(`Could not stop ${servicePattern} daemons, carrying on anyway!`);
    }

    try {
      let removeCmd = `${launchCtlCommand} remove`;
      await (0, _teen_process.exec)('bash', ['-c', removeCmd]);
    } catch (err) {
      _logger.default.warn(`Could not remove ${servicePattern} daemons, carrying on anyway!`);
    }
  }

  try {
    await (0, _asyncbox.waitForCondition)(async () => {
      let {
        stdout
      } = await (0, _teen_process.exec)('bash', ['-c', `ps -e  | grep launchd_sim | grep -v bash | grep -v grep | awk {'print$1'}`]);
      return stdout.trim().length === 0;
    }, {
      waitMs: 5000,
      intervalMs: 500
    });
  } catch (err) {
    _logger.default.warn(`Could not end all simulator daemons, carrying on!`);
  }

  _logger.default.debug('Finishing ending all simulator daemons');
}

async function getSimulatorInfo(udid) {
  let devices = await (0, _nodeSimctl.getDevices)();
  devices = _lodash.default.toPairs(devices).map(pair => pair[1]).reduce((a, b) => a.concat(b), []);
  return _lodash.default.find(devices, sim => sim.udid === udid);
}

async function simExists(udid) {
  return !!(await getSimulatorInfo(udid));
}

async function safeRimRaf(delPath, tryNum = 0) {
  try {
    await _appiumSupport.fs.rimraf(delPath);
  } catch (err) {
    if (tryNum < 20) {
      if (err.message.indexOf('ENOTEMPTY') !== -1) {
        _logger.default.debug(`Path '${delPath}' was not empty during delete; retrying`);

        return await safeRimRaf(delPath, tryNum + 1);
      } else if (err.message.indexOf('ENOENT') !== -1) {
        _logger.default.debug(`Path '${delPath}' did not exist when we tried to delete, ignoring`);

        return await safeRimRaf(delPath, tryNum + 1);
      }
    }
  }
}

async function installSSLCert(pemText, udid) {
  try {
    await _appiumSupport.fs.which('openssl');
  } catch (e) {
    _logger.default.debug(`customSSLCert requires openssl to be available on path`);

    _logger.default.errorAndThrow(`Command 'openssl' not found`);
  }

  try {
    await _appiumSupport.fs.which('sqlite3');
  } catch (e) {
    _logger.default.debug(`customSSLCert requires sqlite3 to be available on path`);

    _logger.default.errorAndThrow(`Command 'sqlite3' not found`);
  }

  let tempFileName = _path.default.resolve((await _appiumSupport.tempDir.openDir()), 'temp-ssl-cert.pem');

  let pathToKeychain = new _simulatorXcode.default(udid).getDir();
  await _appiumSupport.fs.writeFile(tempFileName, pemText);

  try {
    await _appiumSupport.fs.stat(pathToKeychain);
  } catch (e) {
    _logger.default.debug(`Could not install SSL certificate. No simulator with udid '${udid}'`);

    _logger.default.errorAndThrow(e);
  }

  let certificate = new _certificate.Certificate(tempFileName);

  _logger.default.debug(`Installing certificate to ${pathToKeychain}`);

  await certificate.add(pathToKeychain);
  await _appiumSupport.fs.unlink(tempFileName);
  return certificate;
}

async function uninstallSSLCert(pemText, udid) {
  try {
    let tempFileName = _path.default.resolve(__dirname, 'temp-ssl-cert.pem');

    let pathToKeychain = _path.default.resolve(new _simulatorXcode.default(udid).getDir());

    await _appiumSupport.fs.writeFile(tempFileName, pemText);
    let certificate = new _certificate.Certificate(tempFileName);
    await certificate.remove(pathToKeychain);
    await _appiumSupport.fs.unlink(tempFileName);
    return certificate;
  } catch (e) {
    _logger.default.debug(`Could not uninstall SSL certificate. No simulator with udid '${udid}'`);

    _logger.default.errorAndThrow(e);
  }
}

async function hasSSLCert(pemText, udid) {
  const tempFileName = _path.default.resolve((await _appiumSupport.tempDir.openDir()), 'temp-ssl-cert.pem');

  const pathToKeychain = new _simulatorXcode.default(udid).getDir();
  await _appiumSupport.fs.writeFile(tempFileName, pemText);
  const certificate = new _certificate.Certificate(tempFileName);
  return certificate.has(pathToKeychain);
}

async function execSQLiteQuery(db, query, ...queryParams) {
  query = query.replace(/\n+/g, ' ');
  let queryTokens = query.split('?');
  let formattedQuery = [];
  queryParams.map(param => `${param}`).forEach((param, i) => {
    formattedQuery.push(queryTokens[i]);
    formattedQuery.push(param.replace(/'/g, "''"));
  });
  formattedQuery.push(queryTokens[queryTokens.length - 1]);

  _logger.default.debug(`Executing SQL query "${formattedQuery.join('')}" on '${db}'`);

  try {
    return (await (0, _teen_process.exec)('sqlite3', ['-line', db, formattedQuery.join('')])).stdout;
  } catch (err) {
    throw new Error(`Cannot execute SQLite query "${formattedQuery.join('')}" to '${db}'. ` + `Original error: ${err.stderr}`);
  }
}

async function getDeveloperRoot() {
  const {
    stdout
  } = await (0, _teen_process.exec)('xcode-select', ['-p']);
  return stdout.trim();
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1NJTV9TSFVURE9XTl9USU1FT1VUIiwiQklPTUVUUklDUyIsInRvdWNoSWQiLCJmYWNlSWQiLCJ0b0Jpb21ldHJpY0RvbWFpbkNvbXBvbmVudCIsIm5hbWUiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJfIiwia2V5cyIsInBraWxsIiwiYXBwTmFtZSIsImZvcmNlS2lsbCIsImFyZ3MiLCJwdXNoIiwiZXJyIiwiaXNVbmRlZmluZWQiLCJjb2RlIiwibG9nIiwiZXJyb3IiLCJtZXNzYWdlIiwia2lsbEFsbFNpbXVsYXRvcnMiLCJ0aW1lb3V0IiwiZGVidWciLCJ4Y29kZVZlcnNpb24iLCJtYWpvciIsImlnbiIsInBpZHMiLCJzdGRvdXQiLCJ0cmltIiwic3BsaXQiLCJlIiwiaXNFbXB0eSIsIndhcm4iLCJqb2luIiwiZm9yY2UiLCJyZW1haW5pbmdEZXZpY2VzIiwiYWxsU2ltc0FyZURvd24iLCJkZXZpY2VzIiwiZmxhdHRlbiIsInZhbHVlcyIsImV2ZXJ5Iiwic2ltIiwic3RhdGUiLCJ0b0xvd2VyQ2FzZSIsImRvbmUiLCJzZGsiLCJ1ZGlkIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImxlbmd0aCIsImRldmljZSIsImVuZEFsbFNpbXVsYXRvckRhZW1vbnMiLCJzZXJ2aWNlUGF0dGVybiIsImxhdW5jaEN0bENvbW1hbmQiLCJzdG9wQ21kIiwicmVtb3ZlQ21kIiwiZ2V0U2ltdWxhdG9ySW5mbyIsInRvUGFpcnMiLCJtYXAiLCJwYWlyIiwicmVkdWNlIiwiYSIsImIiLCJjb25jYXQiLCJmaW5kIiwic2ltRXhpc3RzIiwic2FmZVJpbVJhZiIsImRlbFBhdGgiLCJ0cnlOdW0iLCJmcyIsInJpbXJhZiIsImluZGV4T2YiLCJpbnN0YWxsU1NMQ2VydCIsInBlbVRleHQiLCJ3aGljaCIsImVycm9yQW5kVGhyb3ciLCJ0ZW1wRmlsZU5hbWUiLCJwYXRoIiwicmVzb2x2ZSIsInRlbXBEaXIiLCJvcGVuRGlyIiwicGF0aFRvS2V5Y2hhaW4iLCJTaW11bGF0b3IiLCJnZXREaXIiLCJ3cml0ZUZpbGUiLCJzdGF0IiwiY2VydGlmaWNhdGUiLCJDZXJ0aWZpY2F0ZSIsImFkZCIsInVubGluayIsInVuaW5zdGFsbFNTTENlcnQiLCJfX2Rpcm5hbWUiLCJyZW1vdmUiLCJoYXNTU0xDZXJ0IiwiaGFzIiwiZXhlY1NRTGl0ZVF1ZXJ5IiwiZGIiLCJxdWVyeSIsInF1ZXJ5UGFyYW1zIiwicmVwbGFjZSIsInF1ZXJ5VG9rZW5zIiwiZm9ybWF0dGVkUXVlcnkiLCJwYXJhbSIsImZvckVhY2giLCJpIiwic3RkZXJyIiwiZ2V0RGV2ZWxvcGVyUm9vdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsNEJBQTRCLEdBQUcsS0FBckM7QUFFQSxNQUFNQyxVQUFVLEdBQUc7QUFDakJDLEVBQUFBLE9BQU8sRUFBRSxhQURRO0FBRWpCQyxFQUFBQSxNQUFNLEVBQUU7QUFGUyxDQUFuQjs7QUFLQSxTQUFTQywwQkFBVCxDQUFxQ0MsSUFBckMsRUFBMkM7QUFDekMsTUFBSSxDQUFDSixVQUFVLENBQUNJLElBQUQsQ0FBZixFQUF1QjtBQUNyQixVQUFNLElBQUlDLEtBQUosQ0FBVyxJQUFHRCxJQUFLLDJDQUEwQ0UsSUFBSSxDQUFDQyxTQUFMLENBQWVDLGdCQUFFQyxJQUFGLENBQU9ULFVBQVAsQ0FBZixDQUFtQyxFQUFoRyxDQUFOO0FBQ0Q7O0FBQ0QsU0FBT0EsVUFBVSxDQUFDSSxJQUFELENBQWpCO0FBQ0Q7O0FBUUQsZUFBZU0sS0FBZixDQUFzQkMsT0FBdEIsRUFBK0JDLFNBQVMsR0FBRyxLQUEzQyxFQUFrRDtBQUNoRCxNQUFJQyxJQUFJLEdBQUdELFNBQVMsR0FBRyxDQUFDLElBQUQsQ0FBSCxHQUFZLEVBQWhDO0FBQ0FDLEVBQUFBLElBQUksQ0FBQ0MsSUFBTCxDQUFVLElBQVYsRUFBZ0JILE9BQWhCOztBQUNBLE1BQUk7QUFDRixVQUFNLHdCQUFLLE9BQUwsRUFBY0UsSUFBZCxDQUFOO0FBQ0EsV0FBTyxDQUFQO0FBQ0QsR0FIRCxDQUdFLE9BQU9FLEdBQVAsRUFBWTtBQUNaLFFBQUksQ0FBQ1AsZ0JBQUVRLFdBQUYsQ0FBY0QsR0FBRyxDQUFDRSxJQUFsQixDQUFMLEVBQThCO0FBQzVCLFlBQU0sSUFBSVosS0FBSixDQUFXLCtCQUE4Qk0sT0FBUSx1QkFBc0JJLEdBQUcsQ0FBQ0UsSUFBSyxFQUFoRixDQUFOO0FBQ0Q7O0FBQ0RDLG9CQUFJQyxLQUFKLENBQVcsa0RBQWlEUixPQUFRLEtBQUlJLEdBQUcsQ0FBQ0ssT0FBUSxFQUFwRjs7QUFDQSxVQUFNTCxHQUFOO0FBQ0Q7QUFDRjs7QUFFRCxlQUFlTSxpQkFBZixDQUFrQ0MsT0FBTyxHQUFHdkIsNEJBQTVDLEVBQTBFO0FBQ3hFbUIsa0JBQUlLLEtBQUosQ0FBVSw0QkFBVjs7QUFDQSxRQUFNQyxZQUFZLEdBQUcsTUFBTSw2QkFBVyxJQUFYLENBQTNCO0FBQ0EsUUFBTWIsT0FBTyxHQUFHYSxZQUFZLENBQUNDLEtBQWIsSUFBc0IsQ0FBdEIsR0FBMEIsV0FBMUIsR0FBd0MsZUFBeEQ7QUFHQUgsRUFBQUEsT0FBTyxHQUFHQSxPQUFPLElBQUlFLFlBQVksQ0FBQ0MsS0FBYixJQUFzQixDQUF0QixHQUEwQixDQUExQixHQUE4QixDQUFsQyxDQUFqQjs7QUFFQSxNQUFJO0FBQ0YsVUFBTSx3QkFBSyxPQUFMLEVBQWMsQ0FBQyxRQUFELEVBQVcsVUFBWCxFQUF1QkQsWUFBWSxDQUFDQyxLQUFiLEdBQXFCLENBQXJCLEdBQXlCLEtBQXpCLEdBQWlDLFFBQXhELENBQWQsRUFBaUY7QUFBQ0gsTUFBQUE7QUFBRCxLQUFqRixDQUFOO0FBQ0QsR0FGRCxDQUVFLE9BQU9JLEdBQVAsRUFBWSxDQUFFOztBQUVoQixRQUFNQyxJQUFJLEdBQUcsRUFBYjs7QUFDQSxNQUFJO0FBQ0YsVUFBTTtBQUFDQyxNQUFBQTtBQUFELFFBQVcsTUFBTSx3QkFBSyxPQUFMLEVBQWMsQ0FBQyxJQUFELEVBQVEsR0FBRWpCLE9BQVEsc0JBQWxCLENBQWQsQ0FBdkI7O0FBQ0EsUUFBSWlCLE1BQU0sQ0FBQ0MsSUFBUCxFQUFKLEVBQW1CO0FBQ2pCRixNQUFBQSxJQUFJLENBQUNiLElBQUwsQ0FBVSxHQUFJYyxNQUFNLENBQUNDLElBQVAsR0FBY0MsS0FBZCxDQUFvQixLQUFwQixDQUFkO0FBQ0Q7QUFDRixHQUxELENBS0UsT0FBT0MsQ0FBUCxFQUFVO0FBQ1YsUUFBSUEsQ0FBQyxDQUFDZCxJQUFGLEtBQVcsQ0FBZixFQUFrQjtBQUNoQkMsc0JBQUlLLEtBQUosQ0FBVyxHQUFFWixPQUFRLGdDQUFyQjs7QUFDQTtBQUNEOztBQUNELFFBQUlILGdCQUFFd0IsT0FBRixDQUFVTCxJQUFWLENBQUosRUFBcUI7QUFDbkJULHNCQUFJZSxJQUFKLENBQVUsZUFBY0YsQ0FBQyxDQUFDZCxJQUFLLDRCQUEyQk4sT0FBUSxxQ0FBbEU7QUFDRDtBQUNGOztBQUNELE1BQUksQ0FBQ0gsZ0JBQUV3QixPQUFGLENBQVVMLElBQVYsQ0FBTCxFQUFzQjtBQUNwQlQsb0JBQUlLLEtBQUosQ0FBVyxrQ0FBaUNJLElBQUksQ0FBQ08sSUFBTCxDQUFVLElBQVYsQ0FBZ0IsRUFBNUQ7O0FBQ0EsUUFBSTtBQUNGLFlBQU0sb0JBQU1QLElBQU4sRUFBWTtBQUFDUSxRQUFBQSxLQUFLLEVBQUU7QUFBUixPQUFaLENBQU47QUFDRCxLQUZELENBRUUsT0FBT1QsR0FBUCxFQUFZLENBQUU7QUFDakI7O0FBRURSLGtCQUFJSyxLQUFKLENBQVcsb0NBQW1DWixPQUFRLEVBQXREOztBQUNBLE1BQUk7QUFDRixVQUFNRCxLQUFLLENBQUNDLE9BQUQsRUFBVSxJQUFWLENBQVg7QUFDRCxHQUZELENBRUUsT0FBT2UsR0FBUCxFQUFZLENBQUU7O0FBSWhCLE1BQUlVLGdCQUFnQixHQUFHLEVBQXZCOztBQUNBLGlCQUFlQyxjQUFmLEdBQWlDO0FBQy9CRCxJQUFBQSxnQkFBZ0IsR0FBRyxFQUFuQjtBQUNBLFFBQUlFLE9BQU8sR0FBRyxNQUFNLDZCQUFwQjtBQUNBQSxJQUFBQSxPQUFPLEdBQUc5QixnQkFBRStCLE9BQUYsQ0FBVS9CLGdCQUFFZ0MsTUFBRixDQUFTRixPQUFULENBQVYsQ0FBVjtBQUNBLFdBQU85QixnQkFBRWlDLEtBQUYsQ0FBUUgsT0FBUixFQUFrQkksR0FBRCxJQUFTO0FBQy9CLFVBQUlDLEtBQUssR0FBR0QsR0FBRyxDQUFDQyxLQUFKLENBQVVDLFdBQVYsRUFBWjtBQUNBLFVBQUlDLElBQUksR0FBR0YsS0FBSyxLQUFLLFVBQVYsSUFDQUEsS0FBSyxLQUFLLGFBRFYsSUFFQUEsS0FBSyxLQUFLLGNBRnJCOztBQUdBLFVBQUksQ0FBQ0UsSUFBTCxFQUFXO0FBQ1RULFFBQUFBLGdCQUFnQixDQUFDdEIsSUFBakIsQ0FBdUIsR0FBRTRCLEdBQUcsQ0FBQ3RDLElBQUssS0FBSXNDLEdBQUcsQ0FBQ0ksR0FBSSxXQUFVSixHQUFHLENBQUNLLElBQUssd0JBQXVCSixLQUFNLEdBQTlGO0FBQ0Q7O0FBQ0QsYUFBT0UsSUFBUDtBQUNELEtBVE0sQ0FBUDtBQVVEOztBQUNELE1BQUk7QUFDRixVQUFNLGdDQUFpQlIsY0FBakIsRUFBaUM7QUFDckNXLE1BQUFBLE1BQU0sRUFBRTFCLE9BRDZCO0FBRXJDMkIsTUFBQUEsVUFBVSxFQUFFO0FBRnlCLEtBQWpDLENBQU47QUFJRCxHQUxELENBS0UsT0FBT2xDLEdBQVAsRUFBWTtBQUNaLFFBQUlxQixnQkFBZ0IsQ0FBQ2MsTUFBakIsR0FBMEIsQ0FBOUIsRUFBaUM7QUFDL0JoQyxzQkFBSWUsSUFBSixDQUFVLGtFQUFpRVgsT0FBUSxNQUFuRjs7QUFDQSxXQUFLLElBQUk2QixNQUFULElBQW1CZixnQkFBbkIsRUFBcUM7QUFDbkNsQix3QkFBSWUsSUFBSixDQUFVLE9BQU1rQixNQUFPLEVBQXZCO0FBQ0Q7QUFDRjs7QUFDRCxVQUFNcEMsR0FBTjtBQUNEO0FBQ0Y7O0FBRUQsZUFBZXFDLHNCQUFmLEdBQXlDO0FBQ3ZDbEMsa0JBQUlLLEtBQUosQ0FBVSw4QkFBVjs7QUFDQSxPQUFLLElBQUk4QixjQUFULElBQTJCLENBQUMsMkJBQUQsRUFBOEIseUJBQTlCLENBQTNCLEVBQXFGO0FBQ25GbkMsb0JBQUlLLEtBQUosQ0FBVyxxQkFBb0I4QixjQUFlLFVBQTlDOztBQUNBLFFBQUlDLGdCQUFnQixHQUFJLHlCQUF3QkQsY0FBZSxvQ0FBL0Q7O0FBQ0EsUUFBSTtBQUNGLFVBQUlFLE9BQU8sR0FBSSxHQUFFRCxnQkFBaUIsT0FBbEM7QUFDQSxZQUFNLHdCQUFLLE1BQUwsRUFBYSxDQUFDLElBQUQsRUFBT0MsT0FBUCxDQUFiLENBQU47QUFDRCxLQUhELENBR0UsT0FBT3hDLEdBQVAsRUFBWTtBQUNaRyxzQkFBSWUsSUFBSixDQUFVLGtCQUFpQm9CLGNBQWUsK0JBQTFDO0FBQ0Q7O0FBQ0QsUUFBSTtBQUNGLFVBQUlHLFNBQVMsR0FBSSxHQUFFRixnQkFBaUIsU0FBcEM7QUFDQSxZQUFNLHdCQUFLLE1BQUwsRUFBYSxDQUFDLElBQUQsRUFBT0UsU0FBUCxDQUFiLENBQU47QUFDRCxLQUhELENBR0UsT0FBT3pDLEdBQVAsRUFBWTtBQUNaRyxzQkFBSWUsSUFBSixDQUFVLG9CQUFtQm9CLGNBQWUsK0JBQTVDO0FBQ0Q7QUFDRjs7QUFFRCxNQUFJO0FBQ0YsVUFBTSxnQ0FBaUIsWUFBWTtBQUNqQyxVQUFJO0FBQUN6QixRQUFBQTtBQUFELFVBQVcsTUFBTSx3QkFBSyxNQUFMLEVBQWEsQ0FBQyxJQUFELEVBQy9CLDJFQUQrQixDQUFiLENBQXJCO0FBRUEsYUFBT0EsTUFBTSxDQUFDQyxJQUFQLEdBQWNxQixNQUFkLEtBQXlCLENBQWhDO0FBQ0QsS0FKSyxFQUlIO0FBQUNGLE1BQUFBLE1BQU0sRUFBRSxJQUFUO0FBQWVDLE1BQUFBLFVBQVUsRUFBRTtBQUEzQixLQUpHLENBQU47QUFLRCxHQU5ELENBTUUsT0FBT2xDLEdBQVAsRUFBWTtBQUNaRyxvQkFBSWUsSUFBSixDQUFVLG1EQUFWO0FBQ0Q7O0FBQ0RmLGtCQUFJSyxLQUFKLENBQVUsd0NBQVY7QUFDRDs7QUFFRCxlQUFla0MsZ0JBQWYsQ0FBaUNWLElBQWpDLEVBQXVDO0FBRXJDLE1BQUlULE9BQU8sR0FBRyxNQUFNLDZCQUFwQjtBQUVBQSxFQUFBQSxPQUFPLEdBQUc5QixnQkFBRWtELE9BQUYsQ0FBVXBCLE9BQVYsRUFDUHFCLEdBRE8sQ0FDRkMsSUFBRCxJQUFVQSxJQUFJLENBQUMsQ0FBRCxDQURYLEVBRVBDLE1BRk8sQ0FFQSxDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVUQsQ0FBQyxDQUFDRSxNQUFGLENBQVNELENBQVQsQ0FGVixFQUV1QixFQUZ2QixDQUFWO0FBR0EsU0FBT3ZELGdCQUFFeUQsSUFBRixDQUFPM0IsT0FBUCxFQUFpQkksR0FBRCxJQUFTQSxHQUFHLENBQUNLLElBQUosS0FBYUEsSUFBdEMsQ0FBUDtBQUNEOztBQUVELGVBQWVtQixTQUFmLENBQTBCbkIsSUFBMUIsRUFBZ0M7QUFDOUIsU0FBTyxDQUFDLEVBQUUsTUFBTVUsZ0JBQWdCLENBQUNWLElBQUQsQ0FBeEIsQ0FBUjtBQUNEOztBQUVELGVBQWVvQixVQUFmLENBQTJCQyxPQUEzQixFQUFvQ0MsTUFBTSxHQUFHLENBQTdDLEVBQWdEO0FBQzlDLE1BQUk7QUFDRixVQUFNQyxrQkFBR0MsTUFBSCxDQUFVSCxPQUFWLENBQU47QUFDRCxHQUZELENBRUUsT0FBT3JELEdBQVAsRUFBWTtBQUNaLFFBQUlzRCxNQUFNLEdBQUcsRUFBYixFQUFpQjtBQUNmLFVBQUl0RCxHQUFHLENBQUNLLE9BQUosQ0FBWW9ELE9BQVosQ0FBb0IsV0FBcEIsTUFBcUMsQ0FBQyxDQUExQyxFQUE2QztBQUMzQ3RELHdCQUFJSyxLQUFKLENBQVcsU0FBUTZDLE9BQVEseUNBQTNCOztBQUNBLGVBQU8sTUFBTUQsVUFBVSxDQUFDQyxPQUFELEVBQVVDLE1BQU0sR0FBRyxDQUFuQixDQUF2QjtBQUNELE9BSEQsTUFHTyxJQUFJdEQsR0FBRyxDQUFDSyxPQUFKLENBQVlvRCxPQUFaLENBQW9CLFFBQXBCLE1BQWtDLENBQUMsQ0FBdkMsRUFBMEM7QUFDL0N0RCx3QkFBSUssS0FBSixDQUFXLFNBQVE2QyxPQUFRLG1EQUEzQjs7QUFDQSxlQUFPLE1BQU1ELFVBQVUsQ0FBQ0MsT0FBRCxFQUFVQyxNQUFNLEdBQUcsQ0FBbkIsQ0FBdkI7QUFDRDtBQUNGO0FBQ0Y7QUFDRjs7QUFPRCxlQUFlSSxjQUFmLENBQStCQyxPQUEvQixFQUF3QzNCLElBQXhDLEVBQThDO0FBRTVDLE1BQUk7QUFDRixVQUFNdUIsa0JBQUdLLEtBQUgsQ0FBUyxTQUFULENBQU47QUFDRCxHQUZELENBRUUsT0FBTzVDLENBQVAsRUFBVTtBQUNWYixvQkFBSUssS0FBSixDQUFXLHdEQUFYOztBQUNBTCxvQkFBSTBELGFBQUosQ0FBbUIsNkJBQW5CO0FBQ0Q7O0FBR0QsTUFBSTtBQUNGLFVBQU1OLGtCQUFHSyxLQUFILENBQVMsU0FBVCxDQUFOO0FBQ0QsR0FGRCxDQUVFLE9BQU81QyxDQUFQLEVBQVU7QUFDVmIsb0JBQUlLLEtBQUosQ0FBVyx3REFBWDs7QUFDQUwsb0JBQUkwRCxhQUFKLENBQW1CLDZCQUFuQjtBQUNEOztBQUlELE1BQUlDLFlBQVksR0FBR0MsY0FBS0MsT0FBTCxFQUFhLE1BQU1DLHVCQUFRQyxPQUFSLEVBQW5CLEdBQXNDLG1CQUF0QyxDQUFuQjs7QUFDQSxNQUFJQyxjQUFjLEdBQUcsSUFBSUMsdUJBQUosQ0FBY3BDLElBQWQsRUFBb0JxQyxNQUFwQixFQUFyQjtBQUNBLFFBQU1kLGtCQUFHZSxTQUFILENBQWFSLFlBQWIsRUFBMkJILE9BQTNCLENBQU47O0FBQ0EsTUFBSTtBQUNGLFVBQU1KLGtCQUFHZ0IsSUFBSCxDQUFRSixjQUFSLENBQU47QUFDRCxHQUZELENBRUUsT0FBT25ELENBQVAsRUFBVTtBQUNWYixvQkFBSUssS0FBSixDQUFXLDhEQUE2RHdCLElBQUssR0FBN0U7O0FBQ0E3QixvQkFBSTBELGFBQUosQ0FBa0I3QyxDQUFsQjtBQUNEOztBQUdELE1BQUl3RCxXQUFXLEdBQUcsSUFBSUMsd0JBQUosQ0FBZ0JYLFlBQWhCLENBQWxCOztBQUNBM0Qsa0JBQUlLLEtBQUosQ0FBVyw2QkFBNEIyRCxjQUFlLEVBQXREOztBQUNBLFFBQU1LLFdBQVcsQ0FBQ0UsR0FBWixDQUFnQlAsY0FBaEIsQ0FBTjtBQUdBLFFBQU1aLGtCQUFHb0IsTUFBSCxDQUFVYixZQUFWLENBQU47QUFFQSxTQUFPVSxXQUFQO0FBQ0Q7O0FBRUQsZUFBZUksZ0JBQWYsQ0FBaUNqQixPQUFqQyxFQUEwQzNCLElBQTFDLEVBQWdEO0FBQzlDLE1BQUk7QUFDRixRQUFJOEIsWUFBWSxHQUFHQyxjQUFLQyxPQUFMLENBQWFhLFNBQWIsRUFBd0IsbUJBQXhCLENBQW5COztBQUNBLFFBQUlWLGNBQWMsR0FBR0osY0FBS0MsT0FBTCxDQUFhLElBQUlJLHVCQUFKLENBQWNwQyxJQUFkLEVBQW9CcUMsTUFBcEIsRUFBYixDQUFyQjs7QUFDQSxVQUFNZCxrQkFBR2UsU0FBSCxDQUFhUixZQUFiLEVBQTJCSCxPQUEzQixDQUFOO0FBQ0EsUUFBSWEsV0FBVyxHQUFHLElBQUlDLHdCQUFKLENBQWdCWCxZQUFoQixDQUFsQjtBQUNBLFVBQU1VLFdBQVcsQ0FBQ00sTUFBWixDQUFtQlgsY0FBbkIsQ0FBTjtBQUNBLFVBQU1aLGtCQUFHb0IsTUFBSCxDQUFVYixZQUFWLENBQU47QUFDQSxXQUFPVSxXQUFQO0FBQ0QsR0FSRCxDQVFFLE9BQU94RCxDQUFQLEVBQVU7QUFDVmIsb0JBQUlLLEtBQUosQ0FBVyxnRUFBK0R3QixJQUFLLEdBQS9FOztBQUNBN0Isb0JBQUkwRCxhQUFKLENBQWtCN0MsQ0FBbEI7QUFDRDtBQUNGOztBQU9ELGVBQWUrRCxVQUFmLENBQTJCcEIsT0FBM0IsRUFBb0MzQixJQUFwQyxFQUEwQztBQUN4QyxRQUFNOEIsWUFBWSxHQUFHQyxjQUFLQyxPQUFMLEVBQWEsTUFBTUMsdUJBQVFDLE9BQVIsRUFBbkIsR0FBc0MsbUJBQXRDLENBQXJCOztBQUNBLFFBQU1DLGNBQWMsR0FBRyxJQUFJQyx1QkFBSixDQUFjcEMsSUFBZCxFQUFvQnFDLE1BQXBCLEVBQXZCO0FBQ0EsUUFBTWQsa0JBQUdlLFNBQUgsQ0FBYVIsWUFBYixFQUEyQkgsT0FBM0IsQ0FBTjtBQUNBLFFBQU1hLFdBQVcsR0FBRyxJQUFJQyx3QkFBSixDQUFnQlgsWUFBaEIsQ0FBcEI7QUFDQSxTQUFPVSxXQUFXLENBQUNRLEdBQVosQ0FBZ0JiLGNBQWhCLENBQVA7QUFDRDs7QUFVRCxlQUFlYyxlQUFmLENBQWdDQyxFQUFoQyxFQUFvQ0MsS0FBcEMsRUFBMkMsR0FBR0MsV0FBOUMsRUFBMkQ7QUFDekRELEVBQUFBLEtBQUssR0FBR0EsS0FBSyxDQUFDRSxPQUFOLENBQWMsTUFBZCxFQUFzQixHQUF0QixDQUFSO0FBQ0EsTUFBSUMsV0FBVyxHQUFHSCxLQUFLLENBQUNwRSxLQUFOLENBQVksR0FBWixDQUFsQjtBQUNBLE1BQUl3RSxjQUFjLEdBQUcsRUFBckI7QUFDQUgsRUFBQUEsV0FBVyxDQUNSeEMsR0FESCxDQUNRNEMsS0FBRCxJQUFZLEdBQUVBLEtBQU0sRUFEM0IsRUFFR0MsT0FGSCxDQUVXLENBQUNELEtBQUQsRUFBUUUsQ0FBUixLQUFjO0FBQ3JCSCxJQUFBQSxjQUFjLENBQUN4RixJQUFmLENBQW9CdUYsV0FBVyxDQUFDSSxDQUFELENBQS9CO0FBQ0FILElBQUFBLGNBQWMsQ0FBQ3hGLElBQWYsQ0FBb0J5RixLQUFLLENBQUNILE9BQU4sQ0FBYyxJQUFkLEVBQW9CLElBQXBCLENBQXBCO0FBQ0QsR0FMSDtBQU1BRSxFQUFBQSxjQUFjLENBQUN4RixJQUFmLENBQW9CdUYsV0FBVyxDQUFDQSxXQUFXLENBQUNuRCxNQUFaLEdBQXFCLENBQXRCLENBQS9COztBQUVBaEMsa0JBQUlLLEtBQUosQ0FBVyx3QkFBdUIrRSxjQUFjLENBQUNwRSxJQUFmLENBQW9CLEVBQXBCLENBQXdCLFNBQVErRCxFQUFHLEdBQXJFOztBQUNBLE1BQUk7QUFDRixXQUFPLENBQUMsTUFBTSx3QkFBSyxTQUFMLEVBQWdCLENBQUMsT0FBRCxFQUFVQSxFQUFWLEVBQWNLLGNBQWMsQ0FBQ3BFLElBQWYsQ0FBb0IsRUFBcEIsQ0FBZCxDQUFoQixDQUFQLEVBQWdFTixNQUF2RTtBQUNELEdBRkQsQ0FFRSxPQUFPYixHQUFQLEVBQVk7QUFDWixVQUFNLElBQUlWLEtBQUosQ0FBVyxnQ0FBK0JpRyxjQUFjLENBQUNwRSxJQUFmLENBQW9CLEVBQXBCLENBQXdCLFNBQVErRCxFQUFHLEtBQW5FLEdBQ2IsbUJBQWtCbEYsR0FBRyxDQUFDMkYsTUFBTyxFQUQxQixDQUFOO0FBRUQ7QUFDRjs7QUFFRCxlQUFlQyxnQkFBZixHQUFtQztBQUNqQyxRQUFNO0FBQUMvRSxJQUFBQTtBQUFELE1BQVcsTUFBTSx3QkFBSyxjQUFMLEVBQXFCLENBQUMsSUFBRCxDQUFyQixDQUF2QjtBQUNBLFNBQU9BLE1BQU0sQ0FBQ0MsSUFBUCxFQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBnZXRWZXJzaW9uIH0gZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCB7IGdldERldmljZXMgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyBmcywgdGVtcERpciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IENlcnRpZmljYXRlIH0gZnJvbSAnLi9jZXJ0aWZpY2F0ZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBTaW11bGF0b3IgZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtNic7XG5pbXBvcnQgZmtpbGwgZnJvbSAnZmtpbGwnO1xuXG5cbmNvbnN0IERFRkFVTFRfU0lNX1NIVVRET1dOX1RJTUVPVVQgPSAzMDAwMDtcblxuY29uc3QgQklPTUVUUklDUyA9IHtcbiAgdG91Y2hJZDogJ2ZpbmdlclRvdWNoJyxcbiAgZmFjZUlkOiAncGVhcmwnLFxufTtcblxuZnVuY3Rpb24gdG9CaW9tZXRyaWNEb21haW5Db21wb25lbnQgKG5hbWUpIHtcbiAgaWYgKCFCSU9NRVRSSUNTW25hbWVdKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAnJHtuYW1lfScgaXMgbm90IGEgdmFsaWQgYmlvbWV0cmljLiBVc2Ugb25lIG9mOiAke0pTT04uc3RyaW5naWZ5KF8ua2V5cyhCSU9NRVRSSUNTKSl9YCk7XG4gIH1cbiAgcmV0dXJuIEJJT01FVFJJQ1NbbmFtZV07XG59XG5cbi8vIHBncmVwL3BraWxsIGV4aXQgY29kZXM6XG4vLyAwICAgICAgIE9uZSBvciBtb3JlIHByb2Nlc3NlcyB3ZXJlIG1hdGNoZWQuXG4vLyAxICAgICAgIE5vIHByb2Nlc3NlcyB3ZXJlIG1hdGNoZWQuXG4vLyAyICAgICAgIEludmFsaWQgb3B0aW9ucyB3ZXJlIHNwZWNpZmllZCBvbiB0aGUgY29tbWFuZCBsaW5lLlxuLy8gMyAgICAgICBBbiBpbnRlcm5hbCBlcnJvciBvY2N1cnJlZC5cblxuYXN5bmMgZnVuY3Rpb24gcGtpbGwgKGFwcE5hbWUsIGZvcmNlS2lsbCA9IGZhbHNlKSB7XG4gIGxldCBhcmdzID0gZm9yY2VLaWxsID8gWyctOSddIDogW107XG4gIGFyZ3MucHVzaCgnLXgnLCBhcHBOYW1lKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKCdwa2lsbCcsIGFyZ3MpO1xuICAgIHJldHVybiAwO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoIV8uaXNVbmRlZmluZWQoZXJyLmNvZGUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmb3JjZWZ1bGx5IHRlcm1pbmF0ZSAke2FwcE5hbWV9LiBwa2lsbCBlcnJvciBjb2RlOiAke2Vyci5jb2RlfWApO1xuICAgIH1cbiAgICBsb2cuZXJyb3IoYFJlY2VpdmVkIHVuZXhwZWN0ZWQgZXJyb3Igd2hpbGUgdHJ5aW5nIHRvIGtpbGwgJHthcHBOYW1lfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24ga2lsbEFsbFNpbXVsYXRvcnMgKHRpbWVvdXQgPSBERUZBVUxUX1NJTV9TSFVURE9XTl9USU1FT1VUKSB7XG4gIGxvZy5kZWJ1ZygnS2lsbGluZyBhbGwgaU9TIFNpbXVsYXRvcnMnKTtcbiAgY29uc3QgeGNvZGVWZXJzaW9uID0gYXdhaXQgZ2V0VmVyc2lvbih0cnVlKTtcbiAgY29uc3QgYXBwTmFtZSA9IHhjb2RlVmVyc2lvbi5tYWpvciA+PSA3ID8gJ1NpbXVsYXRvcicgOiAnaU9TIFNpbXVsYXRvcic7XG5cbiAgLy8gbGF0ZXIgdmVyc2lvbnMgYXJlIHNsb3dlciB0byBjbG9zZVxuICB0aW1lb3V0ID0gdGltZW91dCAqICh4Y29kZVZlcnNpb24ubWFqb3IgPj0gOCA/IDIgOiAxKTtcblxuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJ3hjcnVuJywgWydzaW1jdGwnLCAnc2h1dGRvd24nLCB4Y29kZVZlcnNpb24ubWFqb3IgPiA4ID8gJ2FsbCcgOiAnYm9vdGVkJ10sIHt0aW1lb3V0fSk7XG4gIH0gY2F0Y2ggKGlnbikge31cblxuICBjb25zdCBwaWRzID0gW107XG4gIHRyeSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdwZ3JlcCcsIFsnLWYnLCBgJHthcHBOYW1lfS5hcHAvQ29udGVudHMvTWFjT1MvYF0pO1xuICAgIGlmIChzdGRvdXQudHJpbSgpKSB7XG4gICAgICBwaWRzLnB1c2goLi4uKHN0ZG91dC50cmltKCkuc3BsaXQoL1xccysvKSkpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLmNvZGUgPT09IDEpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgJHthcHBOYW1lfSBpcyBub3QgcnVubmluZy4gQ29udGludWluZy4uLmApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoXy5pc0VtcHR5KHBpZHMpKSB7XG4gICAgICBsb2cud2FybihgcGdyZXAgZXJyb3IgJHtlLmNvZGV9IHdoaWxlIGRldGVjdGluZyB3aGV0aGVyICR7YXBwTmFtZX0gaXMgcnVubmluZy4gVHJ5aW5nIHRvIGtpbGwgYW55d2F5LmApO1xuICAgIH1cbiAgfVxuICBpZiAoIV8uaXNFbXB0eShwaWRzKSkge1xuICAgIGxvZy5kZWJ1ZyhgVXNpbmcgZmtpbGwgdG8ga2lsbCBwcm9jZXNzZXM6ICR7cGlkcy5qb2luKCcsICcpfWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBma2lsbChwaWRzLCB7Zm9yY2U6IHRydWV9KTtcbiAgICB9IGNhdGNoIChpZ24pIHt9XG4gIH1cblxuICBsb2cuZGVidWcoYFVzaW5nIHBraWxsIHRvIGtpbGwgYXBwbGljYXRpb246ICR7YXBwTmFtZX1gKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBwa2lsbChhcHBOYW1lLCB0cnVlKTtcbiAgfSBjYXRjaCAoaWduKSB7fVxuXG4gIC8vIHdhaXQgZm9yIGFsbCB0aGUgZGV2aWNlcyB0byBiZSBzaHV0ZG93biBiZWZvcmUgQ29udGludWluZ1xuICAvLyBidXQgb25seSBwcmludCBvdXQgdGhlIGZhaWxlZCBvbmVzIHdoZW4gdGhleSBhcmUgYWN0dWFsbHkgZnVsbHkgZmFpbGVkXG4gIGxldCByZW1haW5pbmdEZXZpY2VzID0gW107XG4gIGFzeW5jIGZ1bmN0aW9uIGFsbFNpbXNBcmVEb3duICgpIHtcbiAgICByZW1haW5pbmdEZXZpY2VzID0gW107XG4gICAgbGV0IGRldmljZXMgPSBhd2FpdCBnZXREZXZpY2VzKCk7XG4gICAgZGV2aWNlcyA9IF8uZmxhdHRlbihfLnZhbHVlcyhkZXZpY2VzKSk7XG4gICAgcmV0dXJuIF8uZXZlcnkoZGV2aWNlcywgKHNpbSkgPT4ge1xuICAgICAgbGV0IHN0YXRlID0gc2ltLnN0YXRlLnRvTG93ZXJDYXNlKCk7XG4gICAgICBsZXQgZG9uZSA9IHN0YXRlID09PSAnc2h1dGRvd24nIHx8XG4gICAgICAgICAgICAgICAgIHN0YXRlID09PSAndW5hdmFpbGFibGUnIHx8XG4gICAgICAgICAgICAgICAgIHN0YXRlID09PSAnZGlzY29ubmVjdGVkJztcbiAgICAgIGlmICghZG9uZSkge1xuICAgICAgICByZW1haW5pbmdEZXZpY2VzLnB1c2goYCR7c2ltLm5hbWV9ICgke3NpbS5zZGt9LCB1ZGlkOiAke3NpbS51ZGlkfSkgaXMgc3RpbGwgaW4gc3RhdGUgJyR7c3RhdGV9J2ApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRvbmU7XG4gICAgfSk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFsbFNpbXNBcmVEb3duLCB7XG4gICAgICB3YWl0TXM6IHRpbWVvdXQsXG4gICAgICBpbnRlcnZhbE1zOiAyMDBcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHJlbWFpbmluZ0RldmljZXMubGVuZ3RoID4gMCkge1xuICAgICAgbG9nLndhcm4oYFRoZSBmb2xsb3dpbmcgZGV2aWNlcyBhcmUgc3RpbGwgbm90IGluIHRoZSBjb3JyZWN0IHN0YXRlIGFmdGVyICR7dGltZW91dH0gbXM6YCk7XG4gICAgICBmb3IgKGxldCBkZXZpY2Ugb2YgcmVtYWluaW5nRGV2aWNlcykge1xuICAgICAgICBsb2cud2FybihgICAgICR7ZGV2aWNlfWApO1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZW5kQWxsU2ltdWxhdG9yRGFlbW9ucyAoKSB7XG4gIGxvZy5kZWJ1ZygnRW5kaW5nIGFsbCBzaW11bGF0b3IgZGFlbW9ucycpO1xuICBmb3IgKGxldCBzZXJ2aWNlUGF0dGVybiBvZiBbJ2NvbS5hcHBsZS5pcGhvbmVzaW11bGF0b3InLCAnY29tLmFwcGxlLkNvcmVTaW11bGF0b3InXSkge1xuICAgIGxvZy5kZWJ1ZyhgS2lsbGluZyBhbnkgb3RoZXIgJHtzZXJ2aWNlUGF0dGVybn0gZGFlbW9uc2ApO1xuICAgIGxldCBsYXVuY2hDdGxDb21tYW5kID0gYGxhdW5jaGN0bCBsaXN0IHwgZ3JlcCAke3NlcnZpY2VQYXR0ZXJufSB8IGN1dCAtZiAzIHwgeGFyZ3MgLW4gMSBsYXVuY2hjdGxgO1xuICAgIHRyeSB7XG4gICAgICBsZXQgc3RvcENtZCA9IGAke2xhdW5jaEN0bENvbW1hbmR9IHN0b3BgO1xuICAgICAgYXdhaXQgZXhlYygnYmFzaCcsIFsnLWMnLCBzdG9wQ21kXSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ291bGQgbm90IHN0b3AgJHtzZXJ2aWNlUGF0dGVybn0gZGFlbW9ucywgY2Fycnlpbmcgb24gYW55d2F5IWApO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgbGV0IHJlbW92ZUNtZCA9IGAke2xhdW5jaEN0bENvbW1hbmR9IHJlbW92ZWA7XG4gICAgICBhd2FpdCBleGVjKCdiYXNoJywgWyctYycsIHJlbW92ZUNtZF0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYENvdWxkIG5vdCByZW1vdmUgJHtzZXJ2aWNlUGF0dGVybn0gZGFlbW9ucywgY2Fycnlpbmcgb24gYW55d2F5IWApO1xuICAgIH1cbiAgfVxuICAvLyB3YWl0aW5nIHVudGlsIHRoZSBzaW11bGF0b3Igc2VydmljZSBoYXMgZGllZC5cbiAgdHJ5IHtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2Jhc2gnLCBbJy1jJyxcbiAgICAgICAgYHBzIC1lICB8IGdyZXAgbGF1bmNoZF9zaW0gfCBncmVwIC12IGJhc2ggfCBncmVwIC12IGdyZXAgfCBhd2sgeydwcmludCQxJ31gXSk7XG4gICAgICByZXR1cm4gc3Rkb3V0LnRyaW0oKS5sZW5ndGggPT09IDA7XG4gICAgfSwge3dhaXRNczogNTAwMCwgaW50ZXJ2YWxNczogNTAwfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDb3VsZCBub3QgZW5kIGFsbCBzaW11bGF0b3IgZGFlbW9ucywgY2Fycnlpbmcgb24hYCk7XG4gIH1cbiAgbG9nLmRlYnVnKCdGaW5pc2hpbmcgZW5kaW5nIGFsbCBzaW11bGF0b3IgZGFlbW9ucycpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTaW11bGF0b3JJbmZvICh1ZGlkKSB7XG4gIC8vIHNlZSB0aGUgUkVBRE1FIGZvciBnaXRodWIuY29tL2FwcGl1bS9ub2RlLXNpbWN0bCBmb3IgZXhhbXBsZSBvdXRwdXQgb2YgZ2V0RGV2aWNlcygpXG4gIGxldCBkZXZpY2VzID0gYXdhaXQgZ2V0RGV2aWNlcygpO1xuXG4gIGRldmljZXMgPSBfLnRvUGFpcnMoZGV2aWNlcylcbiAgICAubWFwKChwYWlyKSA9PiBwYWlyWzFdKVxuICAgIC5yZWR1Y2UoKGEsIGIpID0+IGEuY29uY2F0KGIpLCBbXSk7XG4gIHJldHVybiBfLmZpbmQoZGV2aWNlcywgKHNpbSkgPT4gc2ltLnVkaWQgPT09IHVkaWQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaW1FeGlzdHMgKHVkaWQpIHtcbiAgcmV0dXJuICEhKGF3YWl0IGdldFNpbXVsYXRvckluZm8odWRpZCkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzYWZlUmltUmFmIChkZWxQYXRoLCB0cnlOdW0gPSAwKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMucmltcmFmKGRlbFBhdGgpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAodHJ5TnVtIDwgMjApIHtcbiAgICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCdFTk9URU1QVFknKSAhPT0gLTEpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBQYXRoICcke2RlbFBhdGh9JyB3YXMgbm90IGVtcHR5IGR1cmluZyBkZWxldGU7IHJldHJ5aW5nYCk7XG4gICAgICAgIHJldHVybiBhd2FpdCBzYWZlUmltUmFmKGRlbFBhdGgsIHRyeU51bSArIDEpO1xuICAgICAgfSBlbHNlIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCdFTk9FTlQnKSAhPT0gLTEpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBQYXRoICcke2RlbFBhdGh9JyBkaWQgbm90IGV4aXN0IHdoZW4gd2UgdHJpZWQgdG8gZGVsZXRlLCBpZ25vcmluZ2ApO1xuICAgICAgICByZXR1cm4gYXdhaXQgc2FmZVJpbVJhZihkZWxQYXRoLCB0cnlOdW0gKyAxKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBJbnN0YWxsIGFuIFNTTCBjZXJ0aWZpY2F0ZSB0byBhIGRldmljZSB3aXRoIGdpdmVuIHVkaWRcbiAqIEBwYXJhbSB7c3RyaW5nfSBwZW1UZXh0IFNTTCBwZW0gdGV4dFxuICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgSWRlbnRpZmllciBvZiB0aGUgU2ltdWxhdG9yXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxTU0xDZXJ0IChwZW1UZXh0LCB1ZGlkKSB7XG4gIC8vIENoZWNrIHRoYXQgb3BlbnNzbCBpcyBpbnN0YWxsZWQgb24gdGhlIHBhdGhcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53aGljaCgnb3BlbnNzbCcpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKGBjdXN0b21TU0xDZXJ0IHJlcXVpcmVzIG9wZW5zc2wgdG8gYmUgYXZhaWxhYmxlIG9uIHBhdGhgKTtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ29tbWFuZCAnb3BlbnNzbCcgbm90IGZvdW5kYCk7XG4gIH1cblxuICAvLyBDaGVjayB0aGF0IHNxbGl0ZTMgaXMgaW5zdGFsbGVkIG9uIHRoZSBwYXRoXG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud2hpY2goJ3NxbGl0ZTMnKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5kZWJ1ZyhgY3VzdG9tU1NMQ2VydCByZXF1aXJlcyBzcWxpdGUzIHRvIGJlIGF2YWlsYWJsZSBvbiBwYXRoYCk7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENvbW1hbmQgJ3NxbGl0ZTMnIG5vdCBmb3VuZGApO1xuICB9XG5cbiAgLy8gQ3JlYXRlIGEgdGVtcG9yYXJ5IGZpbGUgdG8gc3RvcmUgUEVNIHRleHRcbiAgLy8gKGEgdGVtcCBmaWxlIGlzIG5lY2Vzc2FyeSB0byBydW4gYG9wZW5zc2xgIHNoZWxsIGNvbW1hbmRzLCBjYW4ndCBiZSBkb25lIGluIG1lbW9yeSlcbiAgbGV0IHRlbXBGaWxlTmFtZSA9IHBhdGgucmVzb2x2ZShhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKSwgJ3RlbXAtc3NsLWNlcnQucGVtJyk7XG4gIGxldCBwYXRoVG9LZXljaGFpbiA9IG5ldyBTaW11bGF0b3IodWRpZCkuZ2V0RGlyKCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZSh0ZW1wRmlsZU5hbWUsIHBlbVRleHQpO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLnN0YXQocGF0aFRvS2V5Y2hhaW4pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKGBDb3VsZCBub3QgaW5zdGFsbCBTU0wgY2VydGlmaWNhdGUuIE5vIHNpbXVsYXRvciB3aXRoIHVkaWQgJyR7dWRpZH0nYCk7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coZSk7XG4gIH1cblxuICAvLyBEbyB0aGUgY2VydGlmaWNhdGUgaW5zdGFsbGF0aW9uXG4gIGxldCBjZXJ0aWZpY2F0ZSA9IG5ldyBDZXJ0aWZpY2F0ZSh0ZW1wRmlsZU5hbWUpO1xuICBsb2cuZGVidWcoYEluc3RhbGxpbmcgY2VydGlmaWNhdGUgdG8gJHtwYXRoVG9LZXljaGFpbn1gKTtcbiAgYXdhaXQgY2VydGlmaWNhdGUuYWRkKHBhdGhUb0tleWNoYWluKTtcblxuICAvLyBSZW1vdmUgdGhlIHRlbXBvcmFyeSBmaWxlXG4gIGF3YWl0IGZzLnVubGluayh0ZW1wRmlsZU5hbWUpO1xuXG4gIHJldHVybiBjZXJ0aWZpY2F0ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdW5pbnN0YWxsU1NMQ2VydCAocGVtVGV4dCwgdWRpZCkge1xuICB0cnkge1xuICAgIGxldCB0ZW1wRmlsZU5hbWUgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAndGVtcC1zc2wtY2VydC5wZW0nKTtcbiAgICBsZXQgcGF0aFRvS2V5Y2hhaW4gPSBwYXRoLnJlc29sdmUobmV3IFNpbXVsYXRvcih1ZGlkKS5nZXREaXIoKSk7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBGaWxlTmFtZSwgcGVtVGV4dCk7XG4gICAgbGV0IGNlcnRpZmljYXRlID0gbmV3IENlcnRpZmljYXRlKHRlbXBGaWxlTmFtZSk7XG4gICAgYXdhaXQgY2VydGlmaWNhdGUucmVtb3ZlKHBhdGhUb0tleWNoYWluKTtcbiAgICBhd2FpdCBmcy51bmxpbmsodGVtcEZpbGVOYW1lKTtcbiAgICByZXR1cm4gY2VydGlmaWNhdGU7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoYENvdWxkIG5vdCB1bmluc3RhbGwgU1NMIGNlcnRpZmljYXRlLiBObyBzaW11bGF0b3Igd2l0aCB1ZGlkICcke3VkaWR9J2ApO1xuICAgIGxvZy5lcnJvckFuZFRocm93KGUpO1xuICB9XG59XG5cbi8qKlxuICogQ2hlY2sgaWYgdGhlIFNpbXVsYXRvciBhbHJlYWR5IGhhcyB0aGlzIFNTTCBjZXJ0aWZpY2F0ZVxuICogQHBhcmFtIHtzdHJpbmd9IHBlbVRleHQgUEVNIHRleHQgb2YgU1NMIGNlcnRcbiAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIElkZW50aWZpZXIgb2YgdGhlIFNpbXVsYXRvclxuICovXG5hc3luYyBmdW5jdGlvbiBoYXNTU0xDZXJ0IChwZW1UZXh0LCB1ZGlkKSB7XG4gIGNvbnN0IHRlbXBGaWxlTmFtZSA9IHBhdGgucmVzb2x2ZShhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKSwgJ3RlbXAtc3NsLWNlcnQucGVtJyk7XG4gIGNvbnN0IHBhdGhUb0tleWNoYWluID0gbmV3IFNpbXVsYXRvcih1ZGlkKS5nZXREaXIoKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBGaWxlTmFtZSwgcGVtVGV4dCk7XG4gIGNvbnN0IGNlcnRpZmljYXRlID0gbmV3IENlcnRpZmljYXRlKHRlbXBGaWxlTmFtZSk7XG4gIHJldHVybiBjZXJ0aWZpY2F0ZS5oYXMocGF0aFRvS2V5Y2hhaW4pO1xufVxuXG4vKipcbiAqIFJ1bnMgYSBjb21tYW5kIGxpbmUgc3FsaXRlMyBxdWVyeVxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBkYiAtIEZ1bGwgcGF0aCB0byBzcWxpdGUgZGF0YWJhc2VcbiAqIEBwYXJhbSB7c3RyaW5nfSBxdWVyeSAtIFRoZSBhY3R1YWwgcXVlcnkgc3RyaW5nXG4gKiBAcGFyYW0gey4uLnN0cmluZ30gcXVlcnlQYXJhbXMgLSBUaGUgbGlzdCBvZiBxdWVyeSBwYXJhbWV0ZXJzXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBzcWxpdGUgY29tbWFuZCBzdGRvdXRcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZXhlY1NRTGl0ZVF1ZXJ5IChkYiwgcXVlcnksIC4uLnF1ZXJ5UGFyYW1zKSB7XG4gIHF1ZXJ5ID0gcXVlcnkucmVwbGFjZSgvXFxuKy9nLCAnICcpO1xuICBsZXQgcXVlcnlUb2tlbnMgPSBxdWVyeS5zcGxpdCgnPycpO1xuICBsZXQgZm9ybWF0dGVkUXVlcnkgPSBbXTtcbiAgcXVlcnlQYXJhbXNcbiAgICAubWFwKChwYXJhbSkgPT4gYCR7cGFyYW19YClcbiAgICAuZm9yRWFjaCgocGFyYW0sIGkpID0+IHtcbiAgICAgIGZvcm1hdHRlZFF1ZXJ5LnB1c2gocXVlcnlUb2tlbnNbaV0pO1xuICAgICAgZm9ybWF0dGVkUXVlcnkucHVzaChwYXJhbS5yZXBsYWNlKC8nL2csIFwiJydcIikpO1xuICAgIH0pO1xuICBmb3JtYXR0ZWRRdWVyeS5wdXNoKHF1ZXJ5VG9rZW5zW3F1ZXJ5VG9rZW5zLmxlbmd0aCAtIDFdKTtcblxuICBsb2cuZGVidWcoYEV4ZWN1dGluZyBTUUwgcXVlcnkgXCIke2Zvcm1hdHRlZFF1ZXJ5LmpvaW4oJycpfVwiIG9uICcke2RifSdgKTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gKGF3YWl0IGV4ZWMoJ3NxbGl0ZTMnLCBbJy1saW5lJywgZGIsIGZvcm1hdHRlZFF1ZXJ5LmpvaW4oJycpXSkpLnN0ZG91dDtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZXhlY3V0ZSBTUUxpdGUgcXVlcnkgXCIke2Zvcm1hdHRlZFF1ZXJ5LmpvaW4oJycpfVwiIHRvICcke2RifScuIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5zdGRlcnJ9YCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGV2ZWxvcGVyUm9vdCAoKSB7XG4gIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygneGNvZGUtc2VsZWN0JywgWyctcCddKTtcbiAgcmV0dXJuIHN0ZG91dC50cmltKCk7XG59XG5cbmV4cG9ydCB7XG4gIGtpbGxBbGxTaW11bGF0b3JzLFxuICBlbmRBbGxTaW11bGF0b3JEYWVtb25zLFxuICBzYWZlUmltUmFmLFxuICBzaW1FeGlzdHMsXG4gIGdldFNpbXVsYXRvckluZm8sXG4gIGluc3RhbGxTU0xDZXJ0LFxuICB1bmluc3RhbGxTU0xDZXJ0LFxuICBoYXNTU0xDZXJ0LFxuICBleGVjU1FMaXRlUXVlcnksXG4gIHRvQmlvbWV0cmljRG9tYWluQ29tcG9uZW50LFxuICBnZXREZXZlbG9wZXJSb290LFxufTtcbiJdLCJmaWxlIjoibGliL3V0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
