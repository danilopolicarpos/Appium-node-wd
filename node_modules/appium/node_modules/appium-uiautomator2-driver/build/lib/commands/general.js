"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

let extensions = {},
    commands = {},
    helpers = {};

commands.getPageSource = async function () {
  return await this.uiautomator2.jwproxy.command('/source', 'GET', {});
};

commands.doSendKeys = async function (params) {
  await this.uiautomator2.jwproxy.command('/keys', 'POST', params);
};

commands.keyevent = async function (keycode, metastate) {
  _logger.default.debug(`Ignoring metastate ${metastate}`);

  await this.adb.keyevent(keycode);
};

commands.back = async function () {
  await this.adb.keyevent(4);
};

commands.getStrings = async function (language) {
  if (!language) {
    language = await this.adb.getDeviceLanguage();

    _logger.default.info(`No language specified, returning strings for: ${language}`);
  }

  const preprocessStringsMap = function (mapping) {
    const result = {};

    for (const [key, value] of _lodash.default.toPairs(mapping)) {
      result[key] = _lodash.default.isString(value) ? value : JSON.stringify(value);
    }

    return result;
  };

  if (this.apkStrings[language]) {
    return preprocessStringsMap(this.apkStrings[language]);
  }

  if (!this.opts.app && !this.opts.appPackage) {
    _logger.default.errorAndThrow("One of 'app' or 'appPackage' capabilities should must be specified");
  }

  let app = this.opts.app;
  const tmpRoot = await _appiumSupport.tempDir.openDir();

  try {
    if (!app) {
      try {
        app = await this.adb.pullApk(this.opts.appPackage, tmpRoot);
      } catch (err) {
        _logger.default.errorAndThrow(`Failed to pull an apk from '${this.opts.appPackage}'. Original error: ${err.message}`);
      }
    }

    if (!(await _appiumSupport.fs.exists(app))) {
      _logger.default.errorAndThrow(`The app at '${app}' does not exist`);
    }

    try {
      const {
        apkStrings
      } = await this.adb.extractStringsFromApk(app, language, tmpRoot);
      this.apkStrings[language] = apkStrings;
      return preprocessStringsMap(apkStrings);
    } catch (err) {
      _logger.default.errorAndThrow(`Cannot extract strings from '${app}'. Original error: ${err.message}`);
    }
  } finally {
    await _appiumSupport.fs.rimraf(tmpRoot);
  }
};

commands.getWindowSize = async function () {
  return await this.uiautomator2.jwproxy.command('/window/current/size', 'GET', {});
};

commands.getWindowRect = async function () {
  const {
    width,
    height
  } = await this.getWindowSize();
  return {
    width,
    height,
    x: 0,
    y: 0
  };
};

extensions.executeMobile = async function (mobileCommand, opts = {}) {
  const mobileCommandsMapping = {
    shell: 'mobileShell',
    scrollBackTo: 'mobileScrollBackTo',
    viewportScreenshot: 'mobileViewportScreenshot',
    deepLink: 'mobileDeepLink',
    startLogsBroadcast: 'mobileStartLogsBroadcast',
    stopLogsBroadcast: 'mobileStopLogsBroadcast',
    acceptAlert: 'mobileAcceptAlert',
    dismissAlert: 'mobileDismissAlert',
    batteryInfo: 'mobileGetBatteryInfo',
    deviceInfo: 'mobileGetDeviceInfo',
    changePermissions: 'mobileChangePermissions',
    getPermissions: 'mobileGetPermissions',
    performEditorAction: 'mobilePerformEditorAction'
  };

  if (!_lodash.default.has(mobileCommandsMapping, mobileCommand)) {
    throw new _appiumBaseDriver.errors.UnknownCommandError(`Unknown mobile command "${mobileCommand}". ` + `Only ${_lodash.default.keys(mobileCommandsMapping)} commands are supported.`);
  }

  return await this[mobileCommandsMapping[mobileCommand]](opts);
};

commands.mobileScrollBackTo = async function (opts) {
  const {
    elementId,
    elementToId
  } = opts;
  return await this.uiautomator2.jwproxy.command(`/appium/element/${elementId}/scroll_to/${elementToId}`, 'POST', {});
};

commands.mobileViewportScreenshot = async function () {
  return await this.getViewportScreenshot();
};

commands.setUrl = async function (url) {
  await this.adb.startUri(url, this.opts.appPackage);
};

commands.mobileDeepLink = async function (opts = {}) {
  const {
    url,
    package: pkg
  } = opts;
  return await this.adb.startUri(url, pkg);
};

commands.openNotifications = async function () {
  return await this.uiautomator2.jwproxy.command('/appium/device/open_notifications', 'POST', {});
};

commands.updateSettings = async function (settings) {
  let driverOnlySettings = {};
  let serverSettings = {};

  for (let [setting, value] of _lodash.default.toPairs(settings)) {
    if (_appiumBaseDriver.BASEDRIVER_HANDLED_SETTINGS.includes(setting)) {
      driverOnlySettings[setting] = value;
    } else {
      serverSettings[setting] = value;
    }
  }

  if (!_lodash.default.isEmpty(driverOnlySettings)) {
    _logger.default.info(`Found some settings designed to be handled by BaseDriver: ` + `${JSON.stringify(_lodash.default.keys(driverOnlySettings))}. Not ` + `sending these on to the UiAutomator2 server and instead ` + `setting directly on the driver`);

    await this.settings.update(driverOnlySettings);
  }

  if (!_lodash.default.isEmpty(serverSettings)) {
    _logger.default.info('Forwarding the following settings to the UiAutomator2 server: ' + JSON.stringify(_lodash.default.keys(serverSettings)));

    await this.uiautomator2.jwproxy.command('/appium/settings', 'POST', {
      settings: serverSettings
    });
  }
};

commands.getSettings = async function () {
  const driverOnlySettings = this.settings.getSettings();
  const serverSettings = await this.uiautomator2.jwproxy.command('/appium/settings', 'GET');
  return (0, _objectSpread2.default)({}, driverOnlySettings, serverSettings);
};

helpers.wrapBootstrapDisconnect = async function (wrapped) {
  await wrapped();
};

helpers.suspendChromedriverProxy = function () {
  this.chromedriver = null;
  this.proxyReqRes = this.uiautomator2.proxyReqRes.bind(this.uiautomator2);
  this.jwpProxyActive = true;
};

commands.mobileGetDeviceInfo = async function () {
  return await this.uiautomator2.jwproxy.command('/appium/device/info', 'GET');
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImV4dGVuc2lvbnMiLCJjb21tYW5kcyIsImhlbHBlcnMiLCJnZXRQYWdlU291cmNlIiwidWlhdXRvbWF0b3IyIiwiandwcm94eSIsImNvbW1hbmQiLCJkb1NlbmRLZXlzIiwicGFyYW1zIiwia2V5ZXZlbnQiLCJrZXljb2RlIiwibWV0YXN0YXRlIiwibG9nIiwiZGVidWciLCJhZGIiLCJiYWNrIiwiZ2V0U3RyaW5ncyIsImxhbmd1YWdlIiwiZ2V0RGV2aWNlTGFuZ3VhZ2UiLCJpbmZvIiwicHJlcHJvY2Vzc1N0cmluZ3NNYXAiLCJtYXBwaW5nIiwicmVzdWx0Iiwia2V5IiwidmFsdWUiLCJfIiwidG9QYWlycyIsImlzU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsImFwa1N0cmluZ3MiLCJvcHRzIiwiYXBwIiwiYXBwUGFja2FnZSIsImVycm9yQW5kVGhyb3ciLCJ0bXBSb290IiwidGVtcERpciIsIm9wZW5EaXIiLCJwdWxsQXBrIiwiZXJyIiwibWVzc2FnZSIsImZzIiwiZXhpc3RzIiwiZXh0cmFjdFN0cmluZ3NGcm9tQXBrIiwicmltcmFmIiwiZ2V0V2luZG93U2l6ZSIsImdldFdpbmRvd1JlY3QiLCJ3aWR0aCIsImhlaWdodCIsIngiLCJ5IiwiZXhlY3V0ZU1vYmlsZSIsIm1vYmlsZUNvbW1hbmQiLCJtb2JpbGVDb21tYW5kc01hcHBpbmciLCJzaGVsbCIsInNjcm9sbEJhY2tUbyIsInZpZXdwb3J0U2NyZWVuc2hvdCIsImRlZXBMaW5rIiwic3RhcnRMb2dzQnJvYWRjYXN0Iiwic3RvcExvZ3NCcm9hZGNhc3QiLCJhY2NlcHRBbGVydCIsImRpc21pc3NBbGVydCIsImJhdHRlcnlJbmZvIiwiZGV2aWNlSW5mbyIsImNoYW5nZVBlcm1pc3Npb25zIiwiZ2V0UGVybWlzc2lvbnMiLCJwZXJmb3JtRWRpdG9yQWN0aW9uIiwiaGFzIiwiZXJyb3JzIiwiVW5rbm93bkNvbW1hbmRFcnJvciIsImtleXMiLCJtb2JpbGVTY3JvbGxCYWNrVG8iLCJlbGVtZW50SWQiLCJlbGVtZW50VG9JZCIsIm1vYmlsZVZpZXdwb3J0U2NyZWVuc2hvdCIsImdldFZpZXdwb3J0U2NyZWVuc2hvdCIsInNldFVybCIsInVybCIsInN0YXJ0VXJpIiwibW9iaWxlRGVlcExpbmsiLCJwYWNrYWdlIiwicGtnIiwib3Blbk5vdGlmaWNhdGlvbnMiLCJ1cGRhdGVTZXR0aW5ncyIsInNldHRpbmdzIiwiZHJpdmVyT25seVNldHRpbmdzIiwic2VydmVyU2V0dGluZ3MiLCJzZXR0aW5nIiwiQkFTRURSSVZFUl9IQU5ETEVEX1NFVFRJTkdTIiwiaW5jbHVkZXMiLCJpc0VtcHR5IiwidXBkYXRlIiwiZ2V0U2V0dGluZ3MiLCJ3cmFwQm9vdHN0cmFwRGlzY29ubmVjdCIsIndyYXBwZWQiLCJzdXNwZW5kQ2hyb21lZHJpdmVyUHJveHkiLCJjaHJvbWVkcml2ZXIiLCJwcm94eVJlcVJlcyIsImJpbmQiLCJqd3BQcm94eUFjdGl2ZSIsIm1vYmlsZUdldERldmljZUluZm8iLCJPYmplY3QiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxVQUFVLEdBQUcsRUFBakI7QUFBQSxJQUNJQyxRQUFRLEdBQUcsRUFEZjtBQUFBLElBRUlDLE9BQU8sR0FBRyxFQUZkOztBQUlBRCxRQUFRLENBQUNFLGFBQVQsR0FBeUIsa0JBQWtCO0FBQ3pDLFNBQU8sTUFBTSxLQUFLQyxZQUFMLENBQWtCQyxPQUFsQixDQUEwQkMsT0FBMUIsQ0FBa0MsU0FBbEMsRUFBNkMsS0FBN0MsRUFBb0QsRUFBcEQsQ0FBYjtBQUNELENBRkQ7O0FBS0FMLFFBQVEsQ0FBQ00sVUFBVCxHQUFzQixnQkFBZ0JDLE1BQWhCLEVBQXdCO0FBQzVDLFFBQU0sS0FBS0osWUFBTCxDQUFrQkMsT0FBbEIsQ0FBMEJDLE9BQTFCLENBQWtDLE9BQWxDLEVBQTJDLE1BQTNDLEVBQW1ERSxNQUFuRCxDQUFOO0FBQ0Qs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ICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZXJyb3JzLCBCQVNFRFJJVkVSX0hBTkRMRURfU0VUVElOR1MgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZnMsIHRlbXBEaXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmxldCBleHRlbnNpb25zID0ge30sXG4gICAgY29tbWFuZHMgPSB7fSxcbiAgICBoZWxwZXJzID0ge307XG5cbmNvbW1hbmRzLmdldFBhZ2VTb3VyY2UgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLnVpYXV0b21hdG9yMi5qd3Byb3h5LmNvbW1hbmQoJy9zb3VyY2UnLCAnR0VUJywge30pO1xufTtcblxuLy8gTmVlZCB0byBvdmVycmlkZSB0aGlzIGZvciBjb3JyZWN0IHVuaWNvZGUgc3VwcG9ydFxuY29tbWFuZHMuZG9TZW5kS2V5cyA9IGFzeW5jIGZ1bmN0aW9uIChwYXJhbXMpIHtcbiAgYXdhaXQgdGhpcy51aWF1dG9tYXRvcjIuandwcm94eS5jb21tYW5kKCcva2V5cycsICdQT1NUJywgcGFyYW1zKTtcbn07XG5cbi8vIHVpYXV0b21hdG9yMiBkb2Vzbid0IHN1cHBvcnQgbWV0YXN0YXRlIGZvciBrZXlldmVudHNcbmNvbW1hbmRzLmtleWV2ZW50ID0gYXN5bmMgZnVuY3Rpb24gKGtleWNvZGUsIG1ldGFzdGF0ZSkge1xuICBsb2cuZGVidWcoYElnbm9yaW5nIG1ldGFzdGF0ZSAke21ldGFzdGF0ZX1gKTtcbiAgYXdhaXQgdGhpcy5hZGIua2V5ZXZlbnQoa2V5Y29kZSk7XG59O1xuXG4vLyBVc2UgQURCIHNpbmNlIHdlIGRvbid0IGhhdmUgVWlBdXRvbWF0b3JcbmNvbW1hbmRzLmJhY2sgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGF3YWl0IHRoaXMuYWRiLmtleWV2ZW50KDQpO1xufTtcblxuY29tbWFuZHMuZ2V0U3RyaW5ncyA9IGFzeW5jIGZ1bmN0aW9uIChsYW5ndWFnZSkge1xuICBpZiAoIWxhbmd1YWdlKSB7XG4gICAgbGFuZ3VhZ2UgPSBhd2FpdCB0aGlzLmFkYi5nZXREZXZpY2VMYW5ndWFnZSgpO1xuICAgIGxvZy5pbmZvKGBObyBsYW5ndWFnZSBzcGVjaWZpZWQsIHJldHVybmluZyBzdHJpbmdzIGZvcjogJHtsYW5ndWFnZX1gKTtcbiAgfVxuXG4gIC8vIENsaWVudHMgcmVxdWlyZSB0aGUgcmVzdWx0aW5nIG1hcHBpbmcgdG8gaGF2ZSBib3RoIGtleXNcbiAgLy8gYW5kIHZhbHVlcyBvZiB0eXBlIHN0cmluZ1xuICBjb25zdCBwcmVwcm9jZXNzU3RyaW5nc01hcCA9IGZ1bmN0aW9uIChtYXBwaW5nKSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgXy50b1BhaXJzKG1hcHBpbmcpKSB7XG4gICAgICByZXN1bHRba2V5XSA9IF8uaXNTdHJpbmcodmFsdWUpID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgaWYgKHRoaXMuYXBrU3RyaW5nc1tsYW5ndWFnZV0pIHtcbiAgICAvLyBSZXR1cm4gY2FjaGVkIHN0cmluZ3NcbiAgICByZXR1cm4gcHJlcHJvY2Vzc1N0cmluZ3NNYXAodGhpcy5hcGtTdHJpbmdzW2xhbmd1YWdlXSk7XG4gIH1cblxuICBpZiAoIXRoaXMub3B0cy5hcHAgJiYgIXRoaXMub3B0cy5hcHBQYWNrYWdlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coXCJPbmUgb2YgJ2FwcCcgb3IgJ2FwcFBhY2thZ2UnIGNhcGFiaWxpdGllcyBzaG91bGQgbXVzdCBiZSBzcGVjaWZpZWRcIik7XG4gIH1cblxuICBsZXQgYXBwID0gdGhpcy5vcHRzLmFwcDtcbiAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICB0cnkge1xuICAgIGlmICghYXBwKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhcHAgPSBhd2FpdCB0aGlzLmFkYi5wdWxsQXBrKHRoaXMub3B0cy5hcHBQYWNrYWdlLCB0bXBSb290KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgRmFpbGVkIHRvIHB1bGwgYW4gYXBrIGZyb20gJyR7dGhpcy5vcHRzLmFwcFBhY2thZ2V9Jy4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMoYXBwKSkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSBhcHAgYXQgJyR7YXBwfScgZG9lcyBub3QgZXhpc3RgKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qge2Fwa1N0cmluZ3N9ID0gYXdhaXQgdGhpcy5hZGIuZXh0cmFjdFN0cmluZ3NGcm9tQXBrKGFwcCwgbGFuZ3VhZ2UsIHRtcFJvb3QpO1xuICAgICAgdGhpcy5hcGtTdHJpbmdzW2xhbmd1YWdlXSA9IGFwa1N0cmluZ3M7XG4gICAgICByZXR1cm4gcHJlcHJvY2Vzc1N0cmluZ3NNYXAoYXBrU3RyaW5ncyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ2Fubm90IGV4dHJhY3Qgc3RyaW5ncyBmcm9tICcke2FwcH0nLiBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB9XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKHRtcFJvb3QpO1xuICB9XG59O1xuXG4vLyBtZW1vaXplZCBpbiBjb25zdHJ1Y3RvclxuY29tbWFuZHMuZ2V0V2luZG93U2l6ZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMudWlhdXRvbWF0b3IyLmp3cHJveHkuY29tbWFuZCgnL3dpbmRvdy9jdXJyZW50L3NpemUnLCAnR0VUJywge30pO1xufTtcblxuLy8gRm9yIFczQ1xuY29tbWFuZHMuZ2V0V2luZG93UmVjdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgY29uc3Qge3dpZHRoLCBoZWlnaHR9ID0gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplKCk7XG4gIHJldHVybiB7XG4gICAgd2lkdGgsXG4gICAgaGVpZ2h0LFxuICAgIHg6IDAsXG4gICAgeTogMCxcbiAgfTtcbn07XG5cbmV4dGVuc2lvbnMuZXhlY3V0ZU1vYmlsZSA9IGFzeW5jIGZ1bmN0aW9uIChtb2JpbGVDb21tYW5kLCBvcHRzID0ge30pIHtcbiAgY29uc3QgbW9iaWxlQ29tbWFuZHNNYXBwaW5nID0ge1xuICAgIHNoZWxsOiAnbW9iaWxlU2hlbGwnLFxuXG4gICAgc2Nyb2xsQmFja1RvOiAnbW9iaWxlU2Nyb2xsQmFja1RvJyxcbiAgICB2aWV3cG9ydFNjcmVlbnNob3Q6ICdtb2JpbGVWaWV3cG9ydFNjcmVlbnNob3QnLFxuXG4gICAgZGVlcExpbms6ICdtb2JpbGVEZWVwTGluaycsXG5cbiAgICBzdGFydExvZ3NCcm9hZGNhc3Q6ICdtb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QnLFxuICAgIHN0b3BMb2dzQnJvYWRjYXN0OiAnbW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QnLFxuXG4gICAgYWNjZXB0QWxlcnQ6ICdtb2JpbGVBY2NlcHRBbGVydCcsXG4gICAgZGlzbWlzc0FsZXJ0OiAnbW9iaWxlRGlzbWlzc0FsZXJ0JyxcblxuICAgIGJhdHRlcnlJbmZvOiAnbW9iaWxlR2V0QmF0dGVyeUluZm8nLFxuXG4gICAgZGV2aWNlSW5mbzogJ21vYmlsZUdldERldmljZUluZm8nLFxuXG4gICAgY2hhbmdlUGVybWlzc2lvbnM6ICdtb2JpbGVDaGFuZ2VQZXJtaXNzaW9ucycsXG4gICAgZ2V0UGVybWlzc2lvbnM6ICdtb2JpbGVHZXRQZXJtaXNzaW9ucycsXG5cbiAgICBwZXJmb3JtRWRpdG9yQWN0aW9uOiAnbW9iaWxlUGVyZm9ybUVkaXRvckFjdGlvbicsXG4gIH07XG5cbiAgaWYgKCFfLmhhcyhtb2JpbGVDb21tYW5kc01hcHBpbmcsIG1vYmlsZUNvbW1hbmQpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duQ29tbWFuZEVycm9yKGBVbmtub3duIG1vYmlsZSBjb21tYW5kIFwiJHttb2JpbGVDb21tYW5kfVwiLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYE9ubHkgJHtfLmtleXMobW9iaWxlQ29tbWFuZHNNYXBwaW5nKX0gY29tbWFuZHMgYXJlIHN1cHBvcnRlZC5gKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpc1ttb2JpbGVDb21tYW5kc01hcHBpbmdbbW9iaWxlQ29tbWFuZF1dKG9wdHMpO1xufTtcblxuY29tbWFuZHMubW9iaWxlU2Nyb2xsQmFja1RvID0gYXN5bmMgZnVuY3Rpb24gKG9wdHMpIHtcbiAgY29uc3Qge2VsZW1lbnRJZCwgZWxlbWVudFRvSWR9ID0gb3B0cztcbiAgcmV0dXJuIGF3YWl0IHRoaXMudWlhdXRvbWF0b3IyLmp3cHJveHkuY29tbWFuZChgL2FwcGl1bS9lbGVtZW50LyR7ZWxlbWVudElkfS9zY3JvbGxfdG8vJHtlbGVtZW50VG9JZH1gLCAnUE9TVCcsIHt9KTtcbn07XG5cbmNvbW1hbmRzLm1vYmlsZVZpZXdwb3J0U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0Vmlld3BvcnRTY3JlZW5zaG90KCk7XG59O1xuXG5jb21tYW5kcy5zZXRVcmwgPSBhc3luYyBmdW5jdGlvbiAodXJsKSB7XG4gIGF3YWl0IHRoaXMuYWRiLnN0YXJ0VXJpKHVybCwgdGhpcy5vcHRzLmFwcFBhY2thZ2UpO1xufTtcblxuY29tbWFuZHMubW9iaWxlRGVlcExpbmsgPSBhc3luYyBmdW5jdGlvbiAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHt1cmwsIHBhY2thZ2U6IHBrZ30gPSBvcHRzO1xuICByZXR1cm4gYXdhaXQgdGhpcy5hZGIuc3RhcnRVcmkodXJsLCBwa2cpO1xufTtcblxuY29tbWFuZHMub3Blbk5vdGlmaWNhdGlvbnMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLnVpYXV0b21hdG9yMi5qd3Byb3h5LmNvbW1hbmQoJy9hcHBpdW0vZGV2aWNlL29wZW5fbm90aWZpY2F0aW9ucycsICdQT1NUJywge30pO1xufTtcblxuY29tbWFuZHMudXBkYXRlU2V0dGluZ3MgPSBhc3luYyBmdW5jdGlvbiAoc2V0dGluZ3MpIHtcbiAgLy8gd2UgaGF2ZSBzb21lIHNldHRpbmdzIHRoYXQgYXJlIHNldCBvbiB0aGUgc2V0dGluZ3Mgb2JqZWN0IGluIHRoZSBkcml2ZXJcbiAgLy8gb25seSwgZm9yIGV4YW1wbGUgaW1hZ2UgZmluZGluZyBzZXR0aW5ncy4gVGhlIHVpYXV0bzIgc2VydmVyIGRvZXMgbm90IGtub3dcbiAgLy8gd2hhdCB0byBkbyB3aXRoIHRoZW0sIHNvIGp1c3Qgc2V0IHRoZW0gb24gdGhpcyBkcml2ZXIncyBzZXR0aW5ncyBpbnN0YW5jZSxcbiAgLy8gYW5kIGRvbid0IGZvcndhcmQgdGhlbSB0byB0aGUgc2VydmVyXG4gIGxldCBkcml2ZXJPbmx5U2V0dGluZ3MgPSB7fTtcbiAgbGV0IHNlcnZlclNldHRpbmdzID0ge307XG4gIGZvciAobGV0IFtzZXR0aW5nLCB2YWx1ZV0gb2YgXy50b1BhaXJzKHNldHRpbmdzKSkge1xuICAgIGlmIChCQVNFRFJJVkVSX0hBTkRMRURfU0VUVElOR1MuaW5jbHVkZXMoc2V0dGluZykpIHtcbiAgICAgIGRyaXZlck9ubHlTZXR0aW5nc1tzZXR0aW5nXSA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZXJ2ZXJTZXR0aW5nc1tzZXR0aW5nXSA9IHZhbHVlO1xuICAgIH1cbiAgfVxuICBpZiAoIV8uaXNFbXB0eShkcml2ZXJPbmx5U2V0dGluZ3MpKSB7XG4gICAgbG9nLmluZm8oYEZvdW5kIHNvbWUgc2V0dGluZ3MgZGVzaWduZWQgdG8gYmUgaGFuZGxlZCBieSBCYXNlRHJpdmVyOiBgICtcbiAgICAgICAgICAgICBgJHtKU09OLnN0cmluZ2lmeShfLmtleXMoZHJpdmVyT25seVNldHRpbmdzKSl9LiBOb3QgYCArXG4gICAgICAgICAgICAgYHNlbmRpbmcgdGhlc2Ugb24gdG8gdGhlIFVpQXV0b21hdG9yMiBzZXJ2ZXIgYW5kIGluc3RlYWQgYCArXG4gICAgICAgICAgICAgYHNldHRpbmcgZGlyZWN0bHkgb24gdGhlIGRyaXZlcmApO1xuICAgIGF3YWl0IHRoaXMuc2V0dGluZ3MudXBkYXRlKGRyaXZlck9ubHlTZXR0aW5ncyk7XG4gIH1cbiAgaWYgKCFfLmlzRW1wdHkoc2VydmVyU2V0dGluZ3MpKSB7XG4gICAgbG9nLmluZm8oJ0ZvcndhcmRpbmcgdGhlIGZvbGxvd2luZyBzZXR0aW5ncyB0byB0aGUgVWlBdXRvbWF0b3IyIHNlcnZlcjogJyArXG4gICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoXy5rZXlzKHNlcnZlclNldHRpbmdzKSkpO1xuICAgIGF3YWl0IHRoaXMudWlhdXRvbWF0b3IyLmp3cHJveHkuY29tbWFuZCgnL2FwcGl1bS9zZXR0aW5ncycsICdQT1NUJyxcbiAgICAgIHtzZXR0aW5nczogc2VydmVyU2V0dGluZ3N9KTtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0U2V0dGluZ3MgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIC8vIGFzIGFib3ZlLCB3ZSBtaWdodCBoYXZlIHNvbWUgZHJpdmVyLW9ubHkgc2V0dGluZ3MgdG8gcmV0dXJuIGFzIHdlbGxcbiAgY29uc3QgZHJpdmVyT25seVNldHRpbmdzID0gdGhpcy5zZXR0aW5ncy5nZXRTZXR0aW5ncygpO1xuICBjb25zdCBzZXJ2ZXJTZXR0aW5ncyA9IGF3YWl0IHRoaXMudWlhdXRvbWF0b3IyLmp3cHJveHkuY29tbWFuZCgnL2FwcGl1bS9zZXR0aW5ncycsICdHRVQnKTtcbiAgcmV0dXJuIHsuLi5kcml2ZXJPbmx5U2V0dGluZ3MsIC4uLnNlcnZlclNldHRpbmdzfTtcbn07XG5cbi8qKlxuICogT3ZlcnJpZGluZyBhcHBpdW0tYW5kcm9pZC1kcml2ZXIncyB3cmFwQm9vdHN0cmFwRGlzY29ubmVjdCxcbiAqIHVubGlrZSBpbiBhcHBpdW0tYW5kcm9pZC1kcml2ZXIgYXZvaWRpbmcgYWRiIHJlc3RhcnRpbmcgYXMgaXQgaW50ZXJuXG4gKiBraWxscyBVaUF1dG9tYXRvcjIgc2VydmVyIHJ1bm5pbmcgaW4gdGhlIGRldmljZS5cbiAqKi9cbmhlbHBlcnMud3JhcEJvb3RzdHJhcERpc2Nvbm5lY3QgPSBhc3luYyBmdW5jdGlvbiAod3JhcHBlZCkge1xuICBhd2FpdCB3cmFwcGVkKCk7XG59O1xuXG4vLyBTdG9wIHByb3h5aW5nIHRvIGFueSBDaHJvbWVkcml2ZXIgYW5kIHJlZGlyZWN0IHRvIHVpYXV0b21hdG9yMlxuaGVscGVycy5zdXNwZW5kQ2hyb21lZHJpdmVyUHJveHkgPSBmdW5jdGlvbiAoKSB7XG4gIHRoaXMuY2hyb21lZHJpdmVyID0gbnVsbDtcbiAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMudWlhdXRvbWF0b3IyLnByb3h5UmVxUmVzLmJpbmQodGhpcy51aWF1dG9tYXRvcjIpO1xuICB0aGlzLmp3cFByb3h5QWN0aXZlID0gdHJ1ZTtcbn07XG5cbi8qKlxuICogVGhlIGxpc3Qgb2YgYXZhaWxhYmxlIGluZm8gZW50cmllcyBjYW4gYmUgZm91bmQgYXRcbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtLXVpYXV0b21hdG9yMi1zZXJ2ZXIvYmxvYi9tYXN0ZXIvYXBwL3NyYy9tYWluL2phdmEvaW8vYXBwaXVtL3VpYXV0b21hdG9yMi9oYW5kbGVyL0dldERldmljZUluZm8uamF2YVxuICovXG5jb21tYW5kcy5tb2JpbGVHZXREZXZpY2VJbmZvID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy51aWF1dG9tYXRvcjIuandwcm94eS5jb21tYW5kKCcvYXBwaXVtL2RldmljZS9pbmZvJywgJ0dFVCcpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5cbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
