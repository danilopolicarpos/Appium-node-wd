"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

var _protocol = require("../../protocol");

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _capabilities = require("../capabilities");

let commands = {};

commands.createSession = async function createSession(jsonwpDesiredCapabilities, jsonwpRequiredCaps, w3cCapabilities) {
  if (this.sessionId !== null) {
    throw new _protocol.errors.SessionNotCreatedError('Cannot create a new session ' + 'while one is in progress');
  }

  _logger.default.debug();

  let caps;

  if (w3cCapabilities) {
    this.setProtocolW3C();

    if (jsonwpDesiredCapabilities) {
      _logger.default.debug(`W3C capabilities ${_lodash.default.truncate(JSON.stringify(w3cCapabilities))} and MJSONWP desired capabilities ${_lodash.default.truncate(JSON.stringify(jsonwpDesiredCapabilities))} were provided`);
    }

    if (jsonwpDesiredCapabilities && !_lodash.default.isPlainObject(w3cCapabilities)) {
      if (!_lodash.default.isEmpty(w3cCapabilities)) {
        _logger.default.warn(`Expected W3C "capabilities" to be a JSON Object but was provided with: ${JSON.stringify(w3cCapabilities)}`);
      }

      _logger.default.warn(`Falling back to MJSONWP desired capabilities`);

      this.setProtocolMJSONWP();
      caps = jsonwpDesiredCapabilities;
    } else {
      _logger.default.debug(`Creating session with W3C capabilities: ${_lodash.default.truncate(JSON.stringify(w3cCapabilities))}`);

      caps = (0, _capabilities.processCapabilities)(w3cCapabilities, this.desiredCapConstraints, this.shouldValidateCaps);
    }
  } else {
    this.setProtocolMJSONWP();

    _logger.default.debug(`Creating session with MJSONWP desired capabilities: ${_lodash.default.truncate(JSON.stringify(jsonwpDesiredCapabilities))}`);

    caps = jsonwpDesiredCapabilities || {};
  }

  caps = fixCaps(caps, this.desiredCapConstraints);
  this.validateDesiredCaps(caps);
  this.sessionId = _uuidJs.default.create().hex;
  this.caps = caps;
  this.opts = _lodash.default.cloneDeep(this.initialOpts);
  Object.assign(this.opts, this.caps);

  if (this.opts.noReset && this.opts.fullReset) {
    throw new Error("The 'noReset' and 'fullReset' capabilities are mutually " + 'exclusive and should not both be set to true. You ' + "probably meant to just use 'fullReset' on its own");
  }

  if (this.opts.noReset === true) {
    this.opts.fullReset = false;
  }

  if (this.opts.fullReset === true) {
    this.opts.noReset = false;
  }

  this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
  this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;

  if (typeof this.opts.app === 'string' && this.opts.app.trim() === '') {
    this.opts.app = null;
  }

  if (!_lodash.default.isUndefined(this.caps.newCommandTimeout)) {
    this.newCommandTimeoutMs = this.caps.newCommandTimeout * 1000;
  }

  this.resetOnUnexpectedShutdown();

  _logger.default.info(`Session created with session id: ${this.sessionId}`);

  return [this.sessionId, caps];
};

commands.getSessions = async function getSessions() {
  let ret = [];

  if (this.sessionId) {
    ret.push({
      id: this.sessionId,
      capabilities: this.caps
    });
  }

  return ret;
};

commands.getSession = async function getSession() {
  if (this.caps.eventTimings) {
    return Object.assign({}, this.caps, {
      events: this.eventHistory
    });
  }

  return this.caps;
};

commands.deleteSession = async function deleteSession() {
  this.clearNewCommandTimeout();
  this.sessionId = null;
};

function fixCaps(originalCaps, desiredCapConstraints = {}) {
  let caps = _lodash.default.clone(originalCaps);

  let booleanCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isBoolean === true));

  for (let cap of booleanCaps) {
    let value = originalCaps[cap];

    if (_lodash.default.isString(value)) {
      value = value.toLowerCase();

      if (value === 'true' || value === 'false') {
        _logger.default.warn(`Capability '${cap}' changed from string to boolean. This may cause unexpected behavior`);

        caps[cap] = value === 'true';
      }
    }
  }

  let intCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isNumber === true));

  for (let cap of intCaps) {
    let value = originalCaps[cap];

    if (_lodash.default.isString(value) && !isNaN(value)) {
      value = value.trim();
      let newValue = parseInt(value, 10);

      if (value !== `${newValue}`) {
        newValue = parseFloat(value);
      }

      _logger.default.warn(`Capability '${cap}' changed from string ('${value}') to integer (${newValue}). This may cause unexpected behavior`);

      caps[cap] = newValue;
    }
  }

  return caps;
}

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3Nlc3Npb24uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJjcmVhdGVTZXNzaW9uIiwianNvbndwRGVzaXJlZENhcGFiaWxpdGllcyIsImpzb253cFJlcXVpcmVkQ2FwcyIsInczY0NhcGFiaWxpdGllcyIsInNlc3Npb25JZCIsImVycm9ycyIsIlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IiLCJsb2ciLCJkZWJ1ZyIsImNhcHMiLCJzZXRQcm90b2NvbFczQyIsIl8iLCJ0cnVuY2F0ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJpc1BsYWluT2JqZWN0IiwiaXNFbXB0eSIsIndhcm4iLCJzZXRQcm90b2NvbE1KU09OV1AiLCJkZXNpcmVkQ2FwQ29uc3RyYWludHMiLCJzaG91bGRWYWxpZGF0ZUNhcHMiLCJmaXhDYXBzIiwidmFsaWRhdGVEZXNpcmVkQ2FwcyIsIlVVSUQiLCJjcmVhdGUiLCJoZXgiLCJvcHRzIiwiY2xvbmVEZWVwIiwiaW5pdGlhbE9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJub1Jlc2V0IiwiZnVsbFJlc2V0IiwiRXJyb3IiLCJmYXN0UmVzZXQiLCJza2lwVW5pbnN0YWxsIiwiYXBwIiwidHJpbSIsImlzVW5kZWZpbmVkIiwibmV3Q29tbWFuZFRpbWVvdXQiLCJuZXdDb21tYW5kVGltZW91dE1zIiwicmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93biIsImluZm8iLCJnZXRTZXNzaW9ucyIsInJldCIsInB1c2giLCJpZCIsImNhcGFiaWxpdGllcyIsImdldFNlc3Npb24iLCJldmVudFRpbWluZ3MiLCJldmVudHMiLCJldmVudEhpc3RvcnkiLCJkZWxldGVTZXNzaW9uIiwiY2xlYXJOZXdDb21tYW5kVGltZW91dCIsIm9yaWdpbmFsQ2FwcyIsImNsb25lIiwiYm9vbGVhbkNhcHMiLCJrZXlzIiwicGlja0J5IiwiayIsImlzQm9vbGVhbiIsImNhcCIsInZhbHVlIiwiaXNTdHJpbmciLCJ0b0xvd2VyQ2FzZSIsImludENhcHMiLCJpc051bWJlciIsImlzTmFOIiwibmV3VmFsdWUiLCJwYXJzZUludCIsInBhcnNlRmxvYXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7O0FBRUFBLFFBQVEsQ0FBQ0MsYUFBVCxHQUF5QixlQUFlQSxhQUFmLENBQThCQyx5QkFBOUIsRUFBeURDLGtCQUF6RCxFQUE2RUMsZUFBN0UsRUFBOEY7QUFDckgsTUFBSSxLQUFLQyxTQUFMLEtBQW1CLElBQXZCLEVBQTZCO0FBQzNCLFVBQU0sSUFBSUMsaUJBQU9DLHNCQUFYLENBQWtDLGlDQUNBLDBCQURsQyxDQUFOO0FBRUQ7O0FBRURDLGtCQUFJQyxLQUFKOztBQUdBLE1BQUlDLElBQUo7O0FBQ0EsTUFBSU4sZUFBSixFQUFxQjtBQUNuQixTQUFLTyxjQUFMOztBQUNBLFFBQUlULHlCQUFKLEVBQStCO0FBQzdCTSxzQkFBSUMsS0FBSixDQUFXLG9CQUFtQkcsZ0JBQUVDLFFBQUYsQ0FBV0MsSUFBSSxDQUFDQyxTQUFMLENBQWVYLGVBQWYsQ0FBWCxDQUE0QyxxQ0FBb0NRLGdCQUFFQyxRQUFGLENBQVdDLElBQUksQ0FBQ0MsU0FBTCxDQUFlYix5QkFBZixDQUFYLENBQXNELGdCQUFwSztBQUNEOztBQUVELFFBQUlBLHlCQUF5QixJQUFJLENBQUNVLGdCQUFFSSxhQUFGLENBQWdCWixlQUFoQixDQUFsQyxFQUFvRTtBQUdsRSxVQUFJLENBQUNRLGdCQUFFSyxPQUFGLENBQVViLGVBQVYsQ0FBTCxFQUFpQztBQUMvQkksd0JBQUlVLElBQUosQ0FBVSwwRUFBeUVKLElBQUksQ0FBQ0MsU0FBTCxDQUFlWCxlQUFmLENBQWdDLEVBQW5IO0FBQ0Q7O0FBQ0RJLHNCQUFJVSxJQUFKLENBQVUsOENBQVY7O0FBQ0EsV0FBS0Msa0JBQUw7QUFDQVQsTUFBQUEsSUFBSSxHQUFHUix5QkFBUDtBQUNELEtBVEQsTUFTTztBQUNMTSxzQkFBSUMsS0FBSixDQUFXLDJDQUEwQ0csZ0JBQUVDLFFBQUYsQ0FBV0MsSUFBSSxDQUFDQyxTQUFMLENBQWVYLGVBQWYsQ0FBWCxDQUE0QyxFQUFqRzs7QUFDQU0sTUFBQUEsSUFBSSxHQUFHLHVDQUFvQk4sZUFBcEIsRUFBcUMsS0FBS2dCLHFCQUExQyxFQUFpRSxLQUFLQyxrQkFBdEUsQ0FBUDtBQUNEO0FBQ0YsR0FuQkQsTUFtQk87QUFDTCxTQUFLRixrQkFBTDs7QUFDQVgsb0JBQUlDLEtBQUosQ0FBVyx1REFBc0RHLGdCQUFFQyxRQUFGLENBQVdDLElBQUksQ0FBQ0MsU0FBTCxDQUFlYix5QkFBZixDQUFYLENBQXNELEVBQXZIOztBQUNBUSxJQUFBQSxJQUFJLEdBQUdSLHlCQUF5QixJQUFJLEVBQXBDO0FBQ0Q7O0FBRURRLEVBQUFBLElBQUksR0FBR1ksT0FBTyxDQUFDWixJQUFELEVBQU8sS0FBS1UscUJBQVosQ0FBZDtBQUNBLE9BQUtHLG1CQUFMLENBQXlCYixJQUF6QjtBQUVBLE9BQUtMLFNBQUwsR0FBaUJtQixnQkFBS0MsTUFBTCxHQUFjQyxHQUEvQjtBQUNBLE9BQUtoQixJQUFMLEdBQVlBLElBQVo7QUFDQSxPQUFLaUIsSUFBTCxHQUFZZixnQkFBRWdCLFNBQUYsQ0FBWSxLQUFLQyxXQUFqQixDQUFaO0FBR0FDLEVBQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEtBQUtKLElBQW5CLEVBQXlCLEtBQUtqQixJQUE5Qjs7QUFLQSxNQUFJLEtBQUtpQixJQUFMLENBQVVLLE9BQVYsSUFBcUIsS0FBS0wsSUFBTCxDQUFVTSxTQUFuQyxFQUE4QztBQUM1QyxVQUFNLElBQUlDLEtBQUosQ0FBVSw2REFDQSxvREFEQSxHQUVBLG1EQUZWLENBQU47QUFHRDs7QUFDRCxNQUFJLEtBQUtQLElBQUwsQ0FBVUssT0FBVixLQUFzQixJQUExQixFQUFnQztBQUM5QixTQUFLTCxJQUFMLENBQVVNLFNBQVYsR0FBc0IsS0FBdEI7QUFDRDs7QUFDRCxNQUFJLEtBQUtOLElBQUwsQ0FBVU0sU0FBVixLQUF3QixJQUE1QixFQUFrQztBQUNoQyxTQUFLTixJQUFMLENBQVVLLE9BQVYsR0FBb0IsS0FBcEI7QUFDRDs7QUFDRCxPQUFLTCxJQUFMLENBQVVRLFNBQVYsR0FBc0IsQ0FBQyxLQUFLUixJQUFMLENBQVVNLFNBQVgsSUFBd0IsQ0FBQyxLQUFLTixJQUFMLENBQVVLLE9BQXpEO0FBQ0EsT0FBS0wsSUFBTCxDQUFVUyxhQUFWLEdBQTBCLEtBQUtULElBQUwsQ0FBVVEsU0FBVixJQUF1QixLQUFLUixJQUFMLENBQVVLLE9BQTNEOztBQUdBLE1BQUksT0FBTyxLQUFLTCxJQUFMLENBQVVVLEdBQWpCLEtBQXlCLFFBQXpCLElBQXFDLEtBQUtWLElBQUwsQ0FBVVUsR0FBVixDQUFjQyxJQUFkLE9BQXlCLEVBQWxFLEVBQXNFO0FBQ3BFLFNBQUtYLElBQUwsQ0FBVVUsR0FBVixHQUFnQixJQUFoQjtBQUNEOztBQUVELE1BQUksQ0FBQ3pCLGdCQUFFMkIsV0FBRixDQUFjLEtBQUs3QixJQUFMLENBQVU4QixpQkFBeEIsQ0FBTCxFQUFpRDtBQUMvQyxTQUFLQyxtQkFBTCxHQUE0QixLQUFLL0IsSUFBTCxDQUFVOEIsaUJBQVYsR0FBOEIsSUFBMUQ7QUFDRDs7QUFJRCxPQUFLRSx5QkFBTDs7QUFFQWxDLGtCQUFJbUMsSUFBSixDQUFVLG9DQUFtQyxLQUFLdEMsU0FBVSxFQUE1RDs7QUFFQSxTQUFPLENBQUMsS0FBS0EsU0FBTixFQUFpQkssSUFBakIsQ0FBUDtBQUNELENBOUVEOztBQWdGQVYsUUFBUSxDQUFDNEMsV0FBVCxHQUF1QixlQUFlQSxXQUFmLEdBQThCO0FBQ25ELE1BQUlDLEdBQUcsR0FBRyxFQUFWOztBQUVBLE1BQUksS0FBS3hDLFNBQVQsRUFBb0I7QUFDbEJ3QyxJQUFBQSxHQUFHLENBQUNDLElBQUosQ0FBUztBQUNQQyxNQUFBQSxFQUFFLEVBQUUsS0FBSzFDLFNBREY7QUFFUDJDLE1BQUFBLFlBQVksRUFBRSxLQUFLdEM7QUFGWixLQUFUO0FBSUQ7O0FBRUQsU0FBT21DLEdBQVA7QUFDRCxDQVhEOztBQWFBN0MsUUFBUSxDQUFDaUQsVUFBVCxHQUFzQixlQUFlQSxVQUFmLEdBQTZCO0FBQ2pELE1BQUksS0FBS3ZDLElBQUwsQ0FBVXdDLFlBQWQsRUFBNEI7QUFDMUIsV0FBT3BCLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0IsS0FBS3JCLElBQXZCLEVBQTZCO0FBQUN5QyxNQUFBQSxNQUFNLEVBQUUsS0FBS0M7QUFBZCxLQUE3QixDQUFQO0FBQ0Q7O0FBQ0QsU0FBTyxLQUFLMUMsSUFBWjtBQUNELENBTEQ7O0FBT0FWLFFBQVEsQ0FBQ3FELGFBQVQsR0FBeUIsZUFBZUEsYUFBZixHQUErQztBQUN0RSxPQUFLQyxzQkFBTDtBQUNBLE9BQUtqRCxTQUFMLEdBQWlCLElBQWpCO0FBQ0QsQ0FIRDs7QUFLQSxTQUFTaUIsT0FBVCxDQUFrQmlDLFlBQWxCLEVBQWdDbkMscUJBQXFCLEdBQUcsRUFBeEQsRUFBNEQ7QUFDMUQsTUFBSVYsSUFBSSxHQUFHRSxnQkFBRTRDLEtBQUYsQ0FBUUQsWUFBUixDQUFYOztBQUlBLE1BQUlFLFdBQVcsR0FBRzdDLGdCQUFFOEMsSUFBRixDQUFPOUMsZ0JBQUUrQyxNQUFGLENBQVN2QyxxQkFBVCxFQUFpQ3dDLENBQUQsSUFBT0EsQ0FBQyxDQUFDQyxTQUFGLEtBQWdCLElBQXZELENBQVAsQ0FBbEI7O0FBQ0EsT0FBSyxJQUFJQyxHQUFULElBQWdCTCxXQUFoQixFQUE2QjtBQUMzQixRQUFJTSxLQUFLLEdBQUdSLFlBQVksQ0FBQ08sR0FBRCxDQUF4Qjs7QUFDQSxRQUFJbEQsZ0JBQUVvRCxRQUFGLENBQVdELEtBQVgsQ0FBSixFQUF1QjtBQUNyQkEsTUFBQUEsS0FBSyxHQUFHQSxLQUFLLENBQUNFLFdBQU4sRUFBUjs7QUFDQSxVQUFJRixLQUFLLEtBQUssTUFBVixJQUFvQkEsS0FBSyxLQUFLLE9BQWxDLEVBQTJDO0FBQ3pDdkQsd0JBQUlVLElBQUosQ0FBVSxlQUFjNEMsR0FBSSxzRUFBNUI7O0FBQ0FwRCxRQUFBQSxJQUFJLENBQUNvRCxHQUFELENBQUosR0FBYUMsS0FBSyxLQUFLLE1BQXZCO0FBQ0Q7QUFDRjtBQUNGOztBQUdELE1BQUlHLE9BQU8sR0FBR3RELGdCQUFFOEMsSUFBRixDQUFPOUMsZ0JBQUUrQyxNQUFGLENBQVN2QyxxQkFBVCxFQUFpQ3dDLENBQUQsSUFBT0EsQ0FBQyxDQUFDTyxRQUFGLEtBQWUsSUFBdEQsQ0FBUCxDQUFkOztBQUNBLE9BQUssSUFBSUwsR0FBVCxJQUFnQkksT0FBaEIsRUFBeUI7QUFDdkIsUUFBSUgsS0FBSyxHQUFHUixZQUFZLENBQUNPLEdBQUQsQ0FBeEI7O0FBQ0EsUUFBSWxELGdCQUFFb0QsUUFBRixDQUFXRCxLQUFYLEtBQXFCLENBQUNLLEtBQUssQ0FBQ0wsS0FBRCxDQUEvQixFQUF3QztBQUN0Q0EsTUFBQUEsS0FBSyxHQUFHQSxLQUFLLENBQUN6QixJQUFOLEVBQVI7QUFDQSxVQUFJK0IsUUFBUSxHQUFHQyxRQUFRLENBQUNQLEtBQUQsRUFBUSxFQUFSLENBQXZCOztBQUNBLFVBQUlBLEtBQUssS0FBTSxHQUFFTSxRQUFTLEVBQTFCLEVBQTZCO0FBQzNCQSxRQUFBQSxRQUFRLEdBQUdFLFVBQVUsQ0FBQ1IsS0FBRCxDQUFyQjtBQUNEOztBQUNEdkQsc0JBQUlVLElBQUosQ0FBVSxlQUFjNEMsR0FBSSwyQkFBMEJDLEtBQU0sa0JBQWlCTSxRQUFTLHVDQUF0Rjs7QUFDQTNELE1BQUFBLElBQUksQ0FBQ29ELEdBQUQsQ0FBSixHQUFZTyxRQUFaO0FBQ0Q7QUFDRjs7QUFFRCxTQUFPM0QsSUFBUDtBQUNEOztlQUVjVixRIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgcmVxdWlyZS1hd2FpdCAqL1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJy4uLy4uL3Byb3RvY29sJztcbmltcG9ydCBVVUlEIGZyb20gJ3V1aWQtanMnO1xuaW1wb3J0IHsgcHJvY2Vzc0NhcGFiaWxpdGllcyB9IGZyb20gJy4uL2NhcGFiaWxpdGllcyc7XG5cbmxldCBjb21tYW5kcyA9IHt9O1xuXG5jb21tYW5kcy5jcmVhdGVTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gY3JlYXRlU2Vzc2lvbiAoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcywganNvbndwUmVxdWlyZWRDYXBzLCB3M2NDYXBhYmlsaXRpZXMpIHtcbiAgaWYgKHRoaXMuc2Vzc2lvbklkICE9PSBudWxsKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5TZXNzaW9uTm90Q3JlYXRlZEVycm9yKCdDYW5ub3QgY3JlYXRlIGEgbmV3IHNlc3Npb24gJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd3aGlsZSBvbmUgaXMgaW4gcHJvZ3Jlc3MnKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygpO1xuXG4gIC8vIERldGVybWluZSB3ZWF0aGVyIHdlIHNob3VsZCB1c2UganNvbndwRGVzaXJlZENhcGFiaWxpdGllcyBvciB3M2NDYXBhYmlsaXRpZXMgdG8gZ2V0IGNhcHMgZnJvbVxuICBsZXQgY2FwcztcbiAgaWYgKHczY0NhcGFiaWxpdGllcykge1xuICAgIHRoaXMuc2V0UHJvdG9jb2xXM0MoKTtcbiAgICBpZiAoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcykge1xuICAgICAgbG9nLmRlYnVnKGBXM0MgY2FwYWJpbGl0aWVzICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeSh3M2NDYXBhYmlsaXRpZXMpKX0gYW5kIE1KU09OV1AgZGVzaXJlZCBjYXBhYmlsaXRpZXMgJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMpKX0gd2VyZSBwcm92aWRlZGApO1xuICAgIH1cblxuICAgIGlmIChqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzICYmICFfLmlzUGxhaW5PYmplY3QodzNjQ2FwYWJpbGl0aWVzKSkge1xuICAgICAgLy8gSWYgVzNDIENhcGFiaWxpdGllcyBhbmQgTUpTT05XUCBDYXBhYmlsaXRpZXMgd2VyZSBwcm92aWRlZCBhbmQgVzNDIGNhcHMgYXJlbid0IGEgcGxhaW4gb2JqZWN0LFxuICAgICAgLy8gbG9nIGEgd2FybmluZyBhbmQgZmFsbCBiYWNrIHRvIE1KU09OV1BcbiAgICAgIGlmICghXy5pc0VtcHR5KHczY0NhcGFiaWxpdGllcykpIHtcbiAgICAgICAgbG9nLndhcm4oYEV4cGVjdGVkIFczQyBcImNhcGFiaWxpdGllc1wiIHRvIGJlIGEgSlNPTiBPYmplY3QgYnV0IHdhcyBwcm92aWRlZCB3aXRoOiAke0pTT04uc3RyaW5naWZ5KHczY0NhcGFiaWxpdGllcyl9YCk7XG4gICAgICB9XG4gICAgICBsb2cud2FybihgRmFsbGluZyBiYWNrIHRvIE1KU09OV1AgZGVzaXJlZCBjYXBhYmlsaXRpZXNgKTtcbiAgICAgIHRoaXMuc2V0UHJvdG9jb2xNSlNPTldQKCk7XG4gICAgICBjYXBzID0ganNvbndwRGVzaXJlZENhcGFiaWxpdGllcztcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKGBDcmVhdGluZyBzZXNzaW9uIHdpdGggVzNDIGNhcGFiaWxpdGllczogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHczY0NhcGFiaWxpdGllcykpfWApO1xuICAgICAgY2FwcyA9IHByb2Nlc3NDYXBhYmlsaXRpZXModzNjQ2FwYWJpbGl0aWVzLCB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cywgdGhpcy5zaG91bGRWYWxpZGF0ZUNhcHMpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICB0aGlzLnNldFByb3RvY29sTUpTT05XUCgpO1xuICAgIGxvZy5kZWJ1ZyhgQ3JlYXRpbmcgc2Vzc2lvbiB3aXRoIE1KU09OV1AgZGVzaXJlZCBjYXBhYmlsaXRpZXM6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzKSl9YCk7XG4gICAgY2FwcyA9IGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMgfHwge307XG4gIH1cblxuICBjYXBzID0gZml4Q2FwcyhjYXBzLCB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cyk7XG4gIHRoaXMudmFsaWRhdGVEZXNpcmVkQ2FwcyhjYXBzKTtcblxuICB0aGlzLnNlc3Npb25JZCA9IFVVSUQuY3JlYXRlKCkuaGV4O1xuICB0aGlzLmNhcHMgPSBjYXBzO1xuICB0aGlzLm9wdHMgPSBfLmNsb25lRGVlcCh0aGlzLmluaXRpYWxPcHRzKTtcblxuICAvLyBtZXJnZSBjYXBzIG9udG8gb3B0cyBzbyB3ZSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IHdoYXQncyB3aGVyZVxuICBPYmplY3QuYXNzaWduKHRoaXMub3B0cywgdGhpcy5jYXBzKTtcblxuICAvLyBkZWFsIHdpdGggcmVzZXRzXG4gIC8vIHNvbWUgcGVvcGxlIGxpa2UgdG8gZG8gd2VpcmQgdGhpbmdzIGJ5IHNldHRpbmcgbm9SZXNldCBhbmQgZnVsbFJlc2V0XG4gIC8vIGJvdGggdG8gdHJ1ZSwgYnV0IHRoaXMgaXMgbWlzZ3VpZGVkIGFuZCBzdHJhbmdlLCBzbyBlcnJvciBoZXJlIGluc3RlYWRcbiAgaWYgKHRoaXMub3B0cy5ub1Jlc2V0ICYmIHRoaXMub3B0cy5mdWxsUmVzZXQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGUgJ25vUmVzZXQnIGFuZCAnZnVsbFJlc2V0JyBjYXBhYmlsaXRpZXMgYXJlIG11dHVhbGx5IFwiICtcbiAgICAgICAgICAgICAgICAgICAgJ2V4Y2x1c2l2ZSBhbmQgc2hvdWxkIG5vdCBib3RoIGJlIHNldCB0byB0cnVlLiBZb3UgJyArXG4gICAgICAgICAgICAgICAgICAgIFwicHJvYmFibHkgbWVhbnQgdG8ganVzdCB1c2UgJ2Z1bGxSZXNldCcgb24gaXRzIG93blwiKTtcbiAgfVxuICBpZiAodGhpcy5vcHRzLm5vUmVzZXQgPT09IHRydWUpIHtcbiAgICB0aGlzLm9wdHMuZnVsbFJlc2V0ID0gZmFsc2U7XG4gIH1cbiAgaWYgKHRoaXMub3B0cy5mdWxsUmVzZXQgPT09IHRydWUpIHtcbiAgICB0aGlzLm9wdHMubm9SZXNldCA9IGZhbHNlO1xuICB9XG4gIHRoaXMub3B0cy5mYXN0UmVzZXQgPSAhdGhpcy5vcHRzLmZ1bGxSZXNldCAmJiAhdGhpcy5vcHRzLm5vUmVzZXQ7XG4gIHRoaXMub3B0cy5za2lwVW5pbnN0YWxsID0gdGhpcy5vcHRzLmZhc3RSZXNldCB8fCB0aGlzLm9wdHMubm9SZXNldDtcblxuICAvLyBQcmV2ZW50cyBlbXB0eSBzdHJpbmcgY2FwcyBzbyB3ZSBkb24ndCBuZWVkIHRvIHRlc3QgaXQgZXZlcnl3aGVyZVxuICBpZiAodHlwZW9mIHRoaXMub3B0cy5hcHAgPT09ICdzdHJpbmcnICYmIHRoaXMub3B0cy5hcHAudHJpbSgpID09PSAnJykge1xuICAgIHRoaXMub3B0cy5hcHAgPSBudWxsO1xuICB9XG5cbiAgaWYgKCFfLmlzVW5kZWZpbmVkKHRoaXMuY2Fwcy5uZXdDb21tYW5kVGltZW91dCkpIHtcbiAgICB0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMgPSAodGhpcy5jYXBzLm5ld0NvbW1hbmRUaW1lb3V0ICogMTAwMCk7XG4gIH1cblxuICAvLyBXZSBuZWVkIHRvIGluaW5pdGlhbGl6ZSBvbmUgb25VbmV4cGVjdGVkU2h1dGRvdyBwcm9taXNlIHBlciBzZXNzaW9uXG4gIC8vIHRvIGF2b2lkIHRoZSBwcm9taXNlIGZ1bGZpbG1lbnQgYmVpbmcgcHJvcGFnYXRlZCBiZXR3ZWVuIHNlc3Npb25zLlxuICB0aGlzLnJlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24oKTtcblxuICBsb2cuaW5mbyhgU2Vzc2lvbiBjcmVhdGVkIHdpdGggc2Vzc2lvbiBpZDogJHt0aGlzLnNlc3Npb25JZH1gKTtcblxuICByZXR1cm4gW3RoaXMuc2Vzc2lvbklkLCBjYXBzXTtcbn07XG5cbmNvbW1hbmRzLmdldFNlc3Npb25zID0gYXN5bmMgZnVuY3Rpb24gZ2V0U2Vzc2lvbnMgKCkge1xuICBsZXQgcmV0ID0gW107XG5cbiAgaWYgKHRoaXMuc2Vzc2lvbklkKSB7XG4gICAgcmV0LnB1c2goe1xuICAgICAgaWQ6IHRoaXMuc2Vzc2lvbklkLFxuICAgICAgY2FwYWJpbGl0aWVzOiB0aGlzLmNhcHNcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiByZXQ7XG59O1xuXG5jb21tYW5kcy5nZXRTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gZ2V0U2Vzc2lvbiAoKSB7XG4gIGlmICh0aGlzLmNhcHMuZXZlbnRUaW1pbmdzKSB7XG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHRoaXMuY2Fwcywge2V2ZW50czogdGhpcy5ldmVudEhpc3Rvcnl9KTtcbiAgfVxuICByZXR1cm4gdGhpcy5jYXBzO1xufTtcblxuY29tbWFuZHMuZGVsZXRlU2Vzc2lvbiA9IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZVNlc3Npb24gKC8qIHNlc3Npb25JZCAqLykge1xuICB0aGlzLmNsZWFyTmV3Q29tbWFuZFRpbWVvdXQoKTtcbiAgdGhpcy5zZXNzaW9uSWQgPSBudWxsO1xufTtcblxuZnVuY3Rpb24gZml4Q2FwcyAob3JpZ2luYWxDYXBzLCBkZXNpcmVkQ2FwQ29uc3RyYWludHMgPSB7fSkge1xuICBsZXQgY2FwcyA9IF8uY2xvbmUob3JpZ2luYWxDYXBzKTtcblxuICAvLyBib29sZWFuIGNhcGFiaWxpdGllcyBjYW4gYmUgcGFzc2VkIGluIGFzIHN0cmluZ3MgJ2ZhbHNlJyBhbmQgJ3RydWUnXG4gIC8vIHdoaWNoIHdlIHdhbnQgdG8gdHJhbnNsYXRlIGludG8gYm9vbGVhbiB2YWx1ZXNcbiAgbGV0IGJvb2xlYW5DYXBzID0gXy5rZXlzKF8ucGlja0J5KGRlc2lyZWRDYXBDb25zdHJhaW50cywgKGspID0+IGsuaXNCb29sZWFuID09PSB0cnVlKSk7XG4gIGZvciAobGV0IGNhcCBvZiBib29sZWFuQ2Fwcykge1xuICAgIGxldCB2YWx1ZSA9IG9yaWdpbmFsQ2Fwc1tjYXBdO1xuICAgIGlmIChfLmlzU3RyaW5nKHZhbHVlKSkge1xuICAgICAgdmFsdWUgPSB2YWx1ZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKHZhbHVlID09PSAndHJ1ZScgfHwgdmFsdWUgPT09ICdmYWxzZScpIHtcbiAgICAgICAgbG9nLndhcm4oYENhcGFiaWxpdHkgJyR7Y2FwfScgY2hhbmdlZCBmcm9tIHN0cmluZyB0byBib29sZWFuLiBUaGlzIG1heSBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW9yYCk7XG4gICAgICAgIGNhcHNbY2FwXSA9ICh2YWx1ZSA9PT0gJ3RydWUnKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBpbnQgY2FwYWJpbGl0aWVzIGFyZSBvZnRlbiBzZW50IGluIGFzIHN0cmluZ3MgYnkgZnJhbWV3b3Jrc1xuICBsZXQgaW50Q2FwcyA9IF8ua2V5cyhfLnBpY2tCeShkZXNpcmVkQ2FwQ29uc3RyYWludHMsIChrKSA9PiBrLmlzTnVtYmVyID09PSB0cnVlKSk7XG4gIGZvciAobGV0IGNhcCBvZiBpbnRDYXBzKSB7XG4gICAgbGV0IHZhbHVlID0gb3JpZ2luYWxDYXBzW2NhcF07XG4gICAgaWYgKF8uaXNTdHJpbmcodmFsdWUpICYmICFpc05hTih2YWx1ZSkpIHtcbiAgICAgIHZhbHVlID0gdmFsdWUudHJpbSgpO1xuICAgICAgbGV0IG5ld1ZhbHVlID0gcGFyc2VJbnQodmFsdWUsIDEwKTtcbiAgICAgIGlmICh2YWx1ZSAhPT0gYCR7bmV3VmFsdWV9YCkge1xuICAgICAgICBuZXdWYWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpO1xuICAgICAgfVxuICAgICAgbG9nLndhcm4oYENhcGFiaWxpdHkgJyR7Y2FwfScgY2hhbmdlZCBmcm9tIHN0cmluZyAoJyR7dmFsdWV9JykgdG8gaW50ZWdlciAoJHtuZXdWYWx1ZX0pLiBUaGlzIG1heSBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW9yYCk7XG4gICAgICBjYXBzW2NhcF0gPSBuZXdWYWx1ZTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gY2Fwcztcbn1cblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3Nlc3Npb24uanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4ifQ==
