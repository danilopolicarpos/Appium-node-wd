"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.CUSTOM_STRATEGY = exports.IMAGE_STRATEGY = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../../..");

var _images = require("./images");

var _imageElement = require("../image-element");

const commands = {},
      helpers = {},
      extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const IMAGE_STRATEGY = '-image';
exports.IMAGE_STRATEGY = IMAGE_STRATEGY;
const CUSTOM_STRATEGY = '-custom';
exports.CUSTOM_STRATEGY = CUSTOM_STRATEGY;
const FLOAT_PRECISION = 100000;

helpers.findElOrElsWithProcessing = async function findElOrElsWithProcessing(strategy, selector, mult, context) {
  this.validateLocatorStrategy(strategy);

  try {
    return await this.findElOrEls(strategy, selector, mult, context);
  } catch (err) {
    if (this.opts.printPageSourceOnFindFailure) {
      const src = await this.getPageSource();

      _logger.default.debug(`Error finding element${mult ? 's' : ''}: ${err.message}`);

      _logger.default.debug(`Page source requested through 'printPageSourceOnFindFailure':`);

      _logger.default.debug(src);
    }

    throw err;
  }
};

commands.findElement = async function findElement(strategy, selector) {
  if (strategy === IMAGE_STRATEGY) {
    return await this.findByImage(selector, {
      multiple: false
    });
  } else if (strategy === CUSTOM_STRATEGY) {
    return await this.findByCustom(selector, false);
  }

  return await this.findElOrElsWithProcessing(strategy, selector, false);
};

commands.findElements = async function findElements(strategy, selector) {
  if (strategy === IMAGE_STRATEGY) {
    return await this.findByImage(selector, {
      multiple: true
    });
  } else if (strategy === CUSTOM_STRATEGY) {
    return await this.findByCustom(selector, true);
  }

  return await this.findElOrElsWithProcessing(strategy, selector, true);
};

commands.findElementFromElement = async function findElementFromElement(strategy, selector, elementId) {
  return await this.findElOrElsWithProcessing(strategy, selector, false, elementId);
};

commands.findElementsFromElement = async function findElementsFromElement(strategy, selector, elementId) {
  return await this.findElOrElsWithProcessing(strategy, selector, true, elementId);
};

commands.findByCustom = async function findByCustom(selector, multiple) {
  const plugins = this.opts.customFindModules;

  if (!plugins) {
    throw new Error('Finding an element using a plugin is currently an ' + 'incubating feature. To use it you must manually install one or more ' + 'plugin modules in a way that they can be required by Appium, for ' + 'example installing them from the Appium directory, installing them ' + 'globally, or installing them elsewhere and passing an absolute path as ' + 'the capability. Then construct an object where the key is the shortcut ' + 'name for this plugin and the value is the module name or absolute path, ' + 'for example: {"p1": "my-find-plugin"}, and pass this in as the ' + "'customFindModules' capability.");
  }

  if (!_lodash.default.isPlainObject(plugins)) {
    throw new Error("Invalid format for the 'customFindModules' capability. " + 'It should be an object with keys corresponding to the short names and ' + 'values corresponding to the full names of the element finding plugins');
  }

  let [plugin, realSelector] = selector.split(':');

  if (_lodash.default.size(plugins) > 1 && !realSelector) {
    throw new Error(`Multiple element finding plugins were registered ` + `(${_lodash.default.keys(plugins)}), but your selector did not indicate which plugin ` + `to use. Ensure you put the short name of the plugin followed by ':' as ` + `the initial part of the selector string.`);
  }

  if (_lodash.default.size(plugins) === 1 && !realSelector) {
    realSelector = plugin;
    plugin = _lodash.default.keys(plugins)[0];
  }

  if (!plugins[plugin]) {
    throw new Error(`Selector specified use of element finding plugin ` + `'${plugin}' but it was not registered in the 'customFindModules' ` + `capability.`);
  }

  let finder;

  try {
    _logger.default.debug(`Find plugin '${plugin}' requested; will attempt to use it ` + `from '${plugins[plugin]}'`);

    finder = require(plugins[plugin]);
  } catch (err) {
    throw new Error(`Could not load your custom find module '${plugin}'. Did ` + `you put it somewhere Appium can 'require' it? Original error: ${err}`);
  }

  if (!finder || !_lodash.default.isFunction(finder.find)) {
    throw new Error('Your custom find module did not appear to be constructed ' + 'correctly. It needs to export an object with a `find` method.');
  }

  const customFinderLog = _appiumSupport.logger.getLogger(plugin);

  let elements;

  const condition = async () => {
    elements = await finder.find(this, customFinderLog, realSelector, multiple);

    if (!_lodash.default.isEmpty(elements) || multiple) {
      return true;
    }

    return false;
  };

  try {
    await this.implicitWaitForCondition(condition);
  } catch (err) {
    if (err.message.match(/Condition unmet/)) {
      throw new _2.errors.NoSuchElementError();
    }

    throw err;
  }

  return multiple ? elements : elements[0];
};

helpers.findByImage = async function findByImage(b64Template, {
  shouldCheckStaleness = false,
  multiple = false,
  ignoreDefaultImageTemplateScale = false
}) {
  const {
    imageMatchThreshold: threshold,
    fixImageTemplateSize,
    fixImageTemplateScale,
    defaultImageTemplateScale
  } = this.settings.getSettings();

  _logger.default.info(`Finding image element with match threshold ${threshold}`);

  if (!this.getWindowSize) {
    throw new Error("This driver does not support the required 'getWindowSize' command");
  }

  const {
    width: screenWidth,
    height: screenHeight
  } = await this.getWindowSize();

  if (fixImageTemplateSize) {
    b64Template = await this.ensureTemplateSize(b64Template, screenWidth, screenHeight);
  }

  let rect = null;

  const condition = async () => {
    try {
      const {
        b64Screenshot,
        scale
      } = await this.getScreenshotForImageFind(screenWidth, screenHeight);
      b64Template = await this.fixImageTemplateScale(b64Template, {
        defaultImageTemplateScale,
        ignoreDefaultImageTemplateScale,
        fixImageTemplateScale,
        ...scale
      });
      rect = (await this.compareImages(_images.MATCH_TEMPLATE_MODE, b64Screenshot, b64Template, {
        threshold
      })).rect;
      return true;
    } catch (err) {
      if (err.message.match(/Cannot find any occurrences/)) {
        return false;
      }

      throw err;
    }
  };

  try {
    await this.implicitWaitForCondition(condition);
  } catch (err) {
    if (!err.message.match(/Condition unmet/)) {
      throw err;
    }
  }

  if (!rect) {
    if (multiple) {
      return [];
    }

    throw new _2.errors.NoSuchElementError();
  }

  _logger.default.info(`Image template matched: ${JSON.stringify(rect)}`);

  const imgEl = new _imageElement.ImageElement(b64Template, rect);

  if (shouldCheckStaleness) {
    return imgEl;
  }

  const protocolEl = this.registerImageElement(imgEl);
  return multiple ? [protocolEl] : protocolEl;
};

helpers.ensureTemplateSize = async function ensureTemplateSize(b64Template, screenWidth, screenHeight) {
  let imgObj = await _appiumSupport.imageUtil.getJimpImage(b64Template);
  let {
    width: tplWidth,
    height: tplHeight
  } = imgObj.bitmap;

  _logger.default.info(`Template image is ${tplWidth}x${tplHeight}. Screen size is ${screenWidth}x${screenHeight}`);

  if (tplWidth <= screenWidth && tplHeight <= screenHeight) {
    return b64Template;
  }

  _logger.default.info(`Scaling template image from ${tplWidth}x${tplHeight} to match ` + `screen at ${screenWidth}x${screenHeight}`);

  imgObj = imgObj.scaleToFit(screenWidth, screenHeight);
  return (await imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
};

helpers.getScreenshotForImageFind = async function getScreenshotForImageFind(screenWidth, screenHeight) {
  if (!this.getScreenshot) {
    throw new Error("This driver does not support the required 'getScreenshot' command");
  }

  let b64Screenshot = await this.getScreenshot();

  if (!this.settings.getSettings().fixImageFindScreenshotDims) {
    _logger.default.info(`Not verifying screenshot dimensions match screen`);

    return {
      b64Screenshot
    };
  }

  _logger.default.info('Verifying screenshot size and aspect ratio');

  let imgObj = await _appiumSupport.imageUtil.getJimpImage(b64Screenshot);
  let {
    width: shotWidth,
    height: shotHeight
  } = imgObj.bitmap;

  if (screenWidth === shotWidth && screenHeight === shotHeight) {
    _logger.default.info('Screenshot size matched screen size');

    return {
      b64Screenshot
    };
  }

  const scale = {
    xScale: 1.0,
    yScale: 1.0
  };
  const screenAR = screenWidth / screenHeight;
  const shotAR = shotWidth / shotHeight;

  if (Math.round(screenAR * FLOAT_PRECISION) === Math.round(shotAR * FLOAT_PRECISION)) {
    _logger.default.info(`Screenshot aspect ratio '${shotAR}' (${shotWidth}x${shotHeight}) matched ` + `screen aspect ratio '${screenAR}' (${screenWidth}x${screenHeight})`);
  } else {
    _logger.default.warn(`When trying to find an element, determined that the screen ` + `aspect ratio and screenshot aspect ratio are different. Screen ` + `is ${screenWidth}x${screenHeight} whereas screenshot is ` + `${shotWidth}x${shotHeight}.`);

    const xScale = 1.0 * shotWidth / screenWidth;
    const yScale = 1.0 * shotHeight / screenHeight;
    const scaleFactor = xScale >= yScale ? yScale : xScale;

    _logger.default.warn(`Resizing screenshot to ${shotWidth * scaleFactor}x${shotHeight * scaleFactor} to match ` + `screen aspect ratio so that image element coordinates have a ` + `greater chance of being correct.`);

    imgObj = imgObj.resize(shotWidth * scaleFactor, shotHeight * scaleFactor);
    scale.xScale *= scaleFactor;
    scale.yScale *= scaleFactor;
    shotWidth = imgObj.bitmap.width;
    shotHeight = imgObj.bitmap.height;
  }

  if (screenWidth !== shotWidth && screenHeight !== shotHeight) {
    _logger.default.info(`Scaling screenshot from ${shotWidth}x${shotHeight} to match ` + `screen at ${screenWidth}x${screenHeight}`);

    imgObj = imgObj.resize(screenWidth, screenHeight);
    scale.xScale *= 1.0 * screenWidth / shotWidth;
    scale.yScale *= 1.0 * screenHeight / shotHeight;
  }

  b64Screenshot = (await imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
  return {
    b64Screenshot,
    scale
  };
};

const DEFAULT_FIX_IMAGE_TEMPLATE_SCALE = 1;

helpers.fixImageTemplateScale = async function fixImageTemplateScale(b64Template, opts = {}) {
  if (!opts) {
    return b64Template;
  }

  let {
    fixImageTemplateScale = false,
    defaultImageTemplateScale = _imageElement.DEFAULT_TEMPLATE_IMAGE_SCALE,
    ignoreDefaultImageTemplateScale = false,
    xScale = DEFAULT_FIX_IMAGE_TEMPLATE_SCALE,
    yScale = DEFAULT_FIX_IMAGE_TEMPLATE_SCALE
  } = opts;

  if (ignoreDefaultImageTemplateScale) {
    defaultImageTemplateScale = _imageElement.DEFAULT_TEMPLATE_IMAGE_SCALE;
  }

  if (defaultImageTemplateScale === _imageElement.DEFAULT_TEMPLATE_IMAGE_SCALE && !fixImageTemplateScale) {
    return b64Template;
  }

  if (fixImageTemplateScale) {
    xScale *= defaultImageTemplateScale;
    yScale *= defaultImageTemplateScale;
  } else {
    xScale = yScale = 1 * defaultImageTemplateScale;
  }

  if (!parseFloat(xScale) || !parseFloat(yScale)) {
    return b64Template;
  }

  if (Math.round(xScale * FLOAT_PRECISION) === Math.round(DEFAULT_FIX_IMAGE_TEMPLATE_SCALE * FLOAT_PRECISION) && Math.round(yScale * FLOAT_PRECISION === Math.round(DEFAULT_FIX_IMAGE_TEMPLATE_SCALE * FLOAT_PRECISION))) {
    return b64Template;
  }

  let imgTempObj = await _appiumSupport.imageUtil.getJimpImage(b64Template);
  let {
    width: baseTempWidth,
    height: baseTempHeigh
  } = imgTempObj.bitmap;
  const scaledWidth = baseTempWidth * xScale;
  const scaledHeight = baseTempHeigh * yScale;

  _logger.default.info(`Scaling template image from ${baseTempWidth}x${baseTempHeigh}` + ` to ${scaledWidth}x${scaledHeight}`);

  _logger.default.info(`The ratio is ${xScale} and ${yScale}`);

  imgTempObj = await imgTempObj.resize(scaledWidth, scaledHeight);
  return (await imgTempObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL2ZpbmQuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIklNQUdFX1NUUkFURUdZIiwiQ1VTVE9NX1NUUkFURUdZIiwiRkxPQVRfUFJFQ0lTSU9OIiwiZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsInZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5IiwiZmluZEVsT3JFbHMiLCJlcnIiLCJvcHRzIiwicHJpbnRQYWdlU291cmNlT25GaW5kRmFpbHVyZSIsInNyYyIsImdldFBhZ2VTb3VyY2UiLCJsb2ciLCJkZWJ1ZyIsIm1lc3NhZ2UiLCJmaW5kRWxlbWVudCIsImZpbmRCeUltYWdlIiwibXVsdGlwbGUiLCJmaW5kQnlDdXN0b20iLCJmaW5kRWxlbWVudHMiLCJmaW5kRWxlbWVudEZyb21FbGVtZW50IiwiZWxlbWVudElkIiwiZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQiLCJwbHVnaW5zIiwiY3VzdG9tRmluZE1vZHVsZXMiLCJFcnJvciIsIl8iLCJpc1BsYWluT2JqZWN0IiwicGx1Z2luIiwicmVhbFNlbGVjdG9yIiwic3BsaXQiLCJzaXplIiwia2V5cyIsImZpbmRlciIsInJlcXVpcmUiLCJpc0Z1bmN0aW9uIiwiZmluZCIsImN1c3RvbUZpbmRlckxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsImVsZW1lbnRzIiwiY29uZGl0aW9uIiwiaXNFbXB0eSIsImltcGxpY2l0V2FpdEZvckNvbmRpdGlvbiIsIm1hdGNoIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiYjY0VGVtcGxhdGUiLCJzaG91bGRDaGVja1N0YWxlbmVzcyIsImlnbm9yZURlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUiLCJpbWFnZU1hdGNoVGhyZXNob2xkIiwidGhyZXNob2xkIiwiZml4SW1hZ2VUZW1wbGF0ZVNpemUiLCJmaXhJbWFnZVRlbXBsYXRlU2NhbGUiLCJkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlIiwic2V0dGluZ3MiLCJnZXRTZXR0aW5ncyIsImluZm8iLCJnZXRXaW5kb3dTaXplIiwid2lkdGgiLCJzY3JlZW5XaWR0aCIsImhlaWdodCIsInNjcmVlbkhlaWdodCIsImVuc3VyZVRlbXBsYXRlU2l6ZSIsInJlY3QiLCJiNjRTY3JlZW5zaG90Iiwic2NhbGUiLCJnZXRTY3JlZW5zaG90Rm9ySW1hZ2VGaW5kIiwiY29tcGFyZUltYWdlcyIsIk1BVENIX1RFTVBMQVRFX01PREUiLCJKU09OIiwic3RyaW5naWZ5IiwiaW1nRWwiLCJJbWFnZUVsZW1lbnQiLCJwcm90b2NvbEVsIiwicmVnaXN0ZXJJbWFnZUVsZW1lbnQiLCJpbWdPYmoiLCJpbWFnZVV0aWwiLCJnZXRKaW1wSW1hZ2UiLCJ0cGxXaWR0aCIsInRwbEhlaWdodCIsImJpdG1hcCIsInNjYWxlVG9GaXQiLCJnZXRCdWZmZXIiLCJNSU1FX1BORyIsInRvU3RyaW5nIiwiZ2V0U2NyZWVuc2hvdCIsImZpeEltYWdlRmluZFNjcmVlbnNob3REaW1zIiwic2hvdFdpZHRoIiwic2hvdEhlaWdodCIsInhTY2FsZSIsInlTY2FsZSIsInNjcmVlbkFSIiwic2hvdEFSIiwiTWF0aCIsInJvdW5kIiwid2FybiIsInNjYWxlRmFjdG9yIiwicmVzaXplIiwiREVGQVVMVF9GSVhfSU1BR0VfVEVNUExBVEVfU0NBTEUiLCJERUZBVUxUX1RFTVBMQVRFX0lNQUdFX1NDQUxFIiwicGFyc2VGbG9hdCIsImltZ1RlbXBPYmoiLCJiYXNlVGVtcFdpZHRoIiwiYmFzZVRlbXBIZWlnaCIsInNjYWxlZFdpZHRoIiwic2NhbGVkSGVpZ2h0IiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLFFBQVEsR0FBRyxFQUFqQjtBQUFBLE1BQXFCQyxPQUFPLEdBQUcsRUFBL0I7QUFBQSxNQUFtQ0Ms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LFNBQU8sQ0FBQyxNQUFNSixVQUFVLENBQUNuQixTQUFYLENBQXFCTix5QkFBVU8sUUFBL0IsQ0FBUCxFQUFpREMsUUFBakQsQ0FBMEQsUUFBMUQsQ0FBUDtBQUNELENBbkREOztBQXFEQXNCLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjaEgsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBsb2dnZXIsIGltYWdlVXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi8uLi8uLic7XG5pbXBvcnQgeyBNQVRDSF9URU1QTEFURV9NT0RFIH0gZnJvbSAnLi9pbWFnZXMnO1xuaW1wb3J0IHsgSW1hZ2VFbGVtZW50LCBERUZBVUxUX1RFTVBMQVRFX0lNQUdFX1NDQUxFIH0gZnJvbSAnLi4vaW1hZ2UtZWxlbWVudCc7XG5cblxuY29uc3QgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbnN0IElNQUdFX1NUUkFURUdZID0gJy1pbWFnZSc7XG5jb25zdCBDVVNUT01fU1RSQVRFR1kgPSAnLWN1c3RvbSc7XG5cbi8vIFVzZWQgdG8gY29tcGFyZSByYXRpbyBhbmQgc2NyZWVuIHdpZHRoXG4vLyBQaXhlbCBpcyBiYXNpY2FsbHkgdW5kZXIgMTA4MCBmb3IgZXhhbXBsZS4gMTAwSyBpcyBwcm9iYWJseSBlbm91Z2ggZm8gYSB3aGlsZS5cbmNvbnN0IEZMT0FUX1BSRUNJU0lPTiA9IDEwMDAwMDtcblxuLy8gT3ZlcnJpZGUgdGhlIGZvbGxvd2luZyBmdW5jdGlvbiBmb3IgeW91ciBvd24gZHJpdmVyLCBhbmQgdGhlIHJlc3QgaXMgdGFrZW5cbi8vIGNhcmUgb2YhXG5cbi8vIGhlbHBlcnMuZmluZEVsT3JFbHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7fVxuLy8gICBzdHJhdGVneTogbG9jYXRvciBzdHJhdGVneVxuLy8gICBzZWxlY3RvcjogdGhlIGFjdHVhbCBzZWxlY3RvciBmb3IgZmluZGluZyBhbiBlbGVtZW50XG4vLyAgIG11bHQ6IG11bHRpcGxlIGVsZW1lbnRzIG9yIGp1c3Qgb25lP1xuLy8gICBjb250ZXh0OiBmaW5kaW5nIGFuIGVsZW1lbnQgZnJvbSB0aGUgcm9vdCBjb250ZXh0PyBvciBzdGFydGluZyBmcm9tIGFub3RoZXIgZWxlbWVudFxuLy9cbi8vIFJldHVybnMgYW4gb2JqZWN0IHdoaWNoIGFkaGVyZXMgdG8gdGhlIHdheSB0aGUgSlNPTiBXaXJlIFByb3RvY29sIHJlcHJlc2VudHMgZWxlbWVudHM6XG4vLyB7IEVMRU1FTlQ6ICMgfSAgICBlZzogeyBFTEVNRU5UOiAzIH0gIG9yIHsgRUxFTUVOVDogMS4wMjMgfVxuXG5oZWxwZXJzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3NpbmcgPSBhc3luYyBmdW5jdGlvbiBmaW5kRWxPckVsc1dpdGhQcm9jZXNzaW5nIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgdGhpcy52YWxpZGF0ZUxvY2F0b3JTdHJhdGVneShzdHJhdGVneSk7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsT3JFbHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHRoaXMub3B0cy5wcmludFBhZ2VTb3VyY2VPbkZpbmRGYWlsdXJlKSB7XG4gICAgICBjb25zdCBzcmMgPSBhd2FpdCB0aGlzLmdldFBhZ2VTb3VyY2UoKTtcbiAgICAgIGxvZy5kZWJ1ZyhgRXJyb3IgZmluZGluZyBlbGVtZW50JHttdWx0ID8gJ3MnIDogJyd9OiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgbG9nLmRlYnVnKGBQYWdlIHNvdXJjZSByZXF1ZXN0ZWQgdGhyb3VnaCAncHJpbnRQYWdlU291cmNlT25GaW5kRmFpbHVyZSc6YCk7XG4gICAgICBsb2cuZGVidWcoc3JjKTtcbiAgICB9XG4gICAgLy8gc3RpbGwgd2FudCB0aGUgZXJyb3IgdG8gb2NjdXJcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmZpbmRFbGVtZW50ID0gYXN5bmMgZnVuY3Rpb24gZmluZEVsZW1lbnQgKHN0cmF0ZWd5LCBzZWxlY3Rvcikge1xuICBpZiAoc3RyYXRlZ3kgPT09IElNQUdFX1NUUkFURUdZKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEJ5SW1hZ2Uoc2VsZWN0b3IsIHttdWx0aXBsZTogZmFsc2V9KTtcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gQ1VTVE9NX1NUUkFURUdZKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEJ5Q3VzdG9tKHNlbGVjdG9yLCBmYWxzZSk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgdGhpcy5maW5kRWxPckVsc1dpdGhQcm9jZXNzaW5nKHN0cmF0ZWd5LCBzZWxlY3RvciwgZmFsc2UpO1xufTtcblxuY29tbWFuZHMuZmluZEVsZW1lbnRzID0gYXN5bmMgZnVuY3Rpb24gZmluZEVsZW1lbnRzIChzdHJhdGVneSwgc2VsZWN0b3IpIHtcbiAgaWYgKHN0cmF0ZWd5ID09PSBJTUFHRV9TVFJBVEVHWSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRCeUltYWdlKHNlbGVjdG9yLCB7bXVsdGlwbGU6IHRydWV9KTtcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gQ1VTVE9NX1NUUkFURUdZKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEJ5Q3VzdG9tKHNlbGVjdG9yLCB0cnVlKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3Npbmcoc3RyYXRlZ3ksIHNlbGVjdG9yLCB0cnVlKTtcbn07XG5cbmNvbW1hbmRzLmZpbmRFbGVtZW50RnJvbUVsZW1lbnQgPSBhc3luYyBmdW5jdGlvbiBmaW5kRWxlbWVudEZyb21FbGVtZW50IChzdHJhdGVneSwgc2VsZWN0b3IsIGVsZW1lbnRJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5maW5kRWxPckVsc1dpdGhQcm9jZXNzaW5nKHN0cmF0ZWd5LCBzZWxlY3RvciwgZmFsc2UsIGVsZW1lbnRJZCk7XG59O1xuXG5jb21tYW5kcy5maW5kRWxlbWVudHNGcm9tRWxlbWVudCA9IGFzeW5jIGZ1bmN0aW9uIGZpbmRFbGVtZW50c0Zyb21FbGVtZW50IChzdHJhdGVneSwgc2VsZWN0b3IsIGVsZW1lbnRJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5maW5kRWxPckVsc1dpdGhQcm9jZXNzaW5nKHN0cmF0ZWd5LCBzZWxlY3RvciwgdHJ1ZSwgZWxlbWVudElkKTtcbn07XG5cbi8qKlxuICogRmluZCBhbiBlbGVtZW50IHVzaW5nIGEgY3VzdG9tIHBsdWdpbiBzcGVjaWZpZWQgYnkgdGhlIGN1c3RvbUZpbmRNb2R1bGVzIGNhcC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gc2VsZWN0b3IgLSB0aGUgc2VsZWN0b3Igd2hpY2ggdGhlIHBsdWdpbiB3aWxsIHVzZSB0byBmaW5kXG4gKiBlbGVtZW50c1xuICogQHBhcmFtIHtib29sZWFufSBtdWx0aXBsZSAtIHdoZXRoZXIgd2Ugd2FudCBvbmUgZWxlbWVudCBvciBtdWx0aXBsZVxuICpcbiAqIEByZXR1cm5zIHtXZWJFbGVtZW50fSAtIFdlYkRyaXZlciBlbGVtZW50IG9yIGxpc3Qgb2YgZWxlbWVudHNcbiAqL1xuY29tbWFuZHMuZmluZEJ5Q3VzdG9tID0gYXN5bmMgZnVuY3Rpb24gZmluZEJ5Q3VzdG9tIChzZWxlY3RvciwgbXVsdGlwbGUpIHtcbiAgY29uc3QgcGx1Z2lucyA9IHRoaXMub3B0cy5jdXN0b21GaW5kTW9kdWxlcztcblxuICAvLyBmaXJzdCBlbnN1cmUgdGhlIHVzZXIgaGFzIHJlZ2lzdGVyZWQgb25lIG9yIG1vcmUgZmluZCBwbHVnaW5zXG4gIGlmICghcGx1Z2lucykge1xuICAgIC8vIFRPRE8gdGhpcyBpbmZvIHNob3VsZCBnbyBpbiBkb2NzIGluc3RlYWQ7IHVwZGF0ZSB3aGVuIGRvY3MgZm9yIHRoaXNcbiAgICAvLyBmZWF0dXJlIGV4aXN0XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGaW5kaW5nIGFuIGVsZW1lbnQgdXNpbmcgYSBwbHVnaW4gaXMgY3VycmVudGx5IGFuICcgK1xuICAgICAgJ2luY3ViYXRpbmcgZmVhdHVyZS4gVG8gdXNlIGl0IHlvdSBtdXN0IG1hbnVhbGx5IGluc3RhbGwgb25lIG9yIG1vcmUgJyArXG4gICAgICAncGx1Z2luIG1vZHVsZXMgaW4gYSB3YXkgdGhhdCB0aGV5IGNhbiBiZSByZXF1aXJlZCBieSBBcHBpdW0sIGZvciAnICtcbiAgICAgICdleGFtcGxlIGluc3RhbGxpbmcgdGhlbSBmcm9tIHRoZSBBcHBpdW0gZGlyZWN0b3J5LCBpbnN0YWxsaW5nIHRoZW0gJyArXG4gICAgICAnZ2xvYmFsbHksIG9yIGluc3RhbGxpbmcgdGhlbSBlbHNld2hlcmUgYW5kIHBhc3NpbmcgYW4gYWJzb2x1dGUgcGF0aCBhcyAnICtcbiAgICAgICd0aGUgY2FwYWJpbGl0eS4gVGhlbiBjb25zdHJ1Y3QgYW4gb2JqZWN0IHdoZXJlIHRoZSBrZXkgaXMgdGhlIHNob3J0Y3V0ICcgK1xuICAgICAgJ25hbWUgZm9yIHRoaXMgcGx1Z2luIGFuZCB0aGUgdmFsdWUgaXMgdGhlIG1vZHVsZSBuYW1lIG9yIGFic29sdXRlIHBhdGgsICcgK1xuICAgICAgJ2ZvciBleGFtcGxlOiB7XCJwMVwiOiBcIm15LWZpbmQtcGx1Z2luXCJ9LCBhbmQgcGFzcyB0aGlzIGluIGFzIHRoZSAnICtcbiAgICAgIFwiJ2N1c3RvbUZpbmRNb2R1bGVzJyBjYXBhYmlsaXR5LlwiKTtcbiAgfVxuXG4gIC8vIHRoZW4gZG8gc29tZSBiYXNpYyBjaGVja2luZyBvZiB0aGUgdHlwZSBvZiB0aGUgY2FwYWJpbGl0eVxuICBpZiAoIV8uaXNQbGFpbk9iamVjdChwbHVnaW5zKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgZm9ybWF0IGZvciB0aGUgJ2N1c3RvbUZpbmRNb2R1bGVzJyBjYXBhYmlsaXR5LiBcIiArXG4gICAgICAnSXQgc2hvdWxkIGJlIGFuIG9iamVjdCB3aXRoIGtleXMgY29ycmVzcG9uZGluZyB0byB0aGUgc2hvcnQgbmFtZXMgYW5kICcgK1xuICAgICAgJ3ZhbHVlcyBjb3JyZXNwb25kaW5nIHRvIHRoZSBmdWxsIG5hbWVzIG9mIHRoZSBlbGVtZW50IGZpbmRpbmcgcGx1Z2lucycpO1xuICB9XG5cbiAgLy8gZ2V0IHRoZSBuYW1lIG9mIHRoZSBwYXJ0aWN1bGFyIHBsdWdpbiB1c2VkIGZvciB0aGlzIGludm9jYXRpb24gb2YgZmluZCxcbiAgLy8gYW5kIHNlcGFyYXRlIGl0IGZyb20gdGhlIHNlbGVjdG9yIHdlIHdpbGwgcGFzcyB0byB0aGUgcGx1Z2luXG4gIGxldCBbcGx1Z2luLCByZWFsU2VsZWN0b3JdID0gc2VsZWN0b3Iuc3BsaXQoJzonKTtcblxuICAvLyBpZiB0aGUgdXNlciBkaWRuJ3Qgc3BlY2lmeSBhIHBsdWdpbiBmb3IgdGhpcyBmaW5kIGludm9jYXRpb24sIGFuZCB3ZSBoYWRcbiAgLy8gbXVsdGlwbGUgcGx1Z2lucyByZWdpc3RlcmVkLCB0aGF0J3MgYSBwcm9ibGVtXG4gIGlmIChfLnNpemUocGx1Z2lucykgPiAxICYmICFyZWFsU2VsZWN0b3IpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE11bHRpcGxlIGVsZW1lbnQgZmluZGluZyBwbHVnaW5zIHdlcmUgcmVnaXN0ZXJlZCBgICtcbiAgICAgIGAoJHtfLmtleXMocGx1Z2lucyl9KSwgYnV0IHlvdXIgc2VsZWN0b3IgZGlkIG5vdCBpbmRpY2F0ZSB3aGljaCBwbHVnaW4gYCArXG4gICAgICBgdG8gdXNlLiBFbnN1cmUgeW91IHB1dCB0aGUgc2hvcnQgbmFtZSBvZiB0aGUgcGx1Z2luIGZvbGxvd2VkIGJ5ICc6JyBhcyBgICtcbiAgICAgIGB0aGUgaW5pdGlhbCBwYXJ0IG9mIHRoZSBzZWxlY3RvciBzdHJpbmcuYCk7XG4gIH1cblxuICAvLyBidXQgaWYgdGhleSBkaWQgbm90IHNwZWNpZnkgYSBwbHVnaW4gYW5kIHdlIG9ubHkgaGF2ZSBvbmUgcGx1Z2luLCBqdXN0IHVzZVxuICAvLyB0aGF0IG9uZVxuICBpZiAoXy5zaXplKHBsdWdpbnMpID09PSAxICYmICFyZWFsU2VsZWN0b3IpIHtcbiAgICByZWFsU2VsZWN0b3IgPSBwbHVnaW47XG4gICAgcGx1Z2luID0gXy5rZXlzKHBsdWdpbnMpWzBdO1xuICB9XG5cbiAgaWYgKCFwbHVnaW5zW3BsdWdpbl0pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFNlbGVjdG9yIHNwZWNpZmllZCB1c2Ugb2YgZWxlbWVudCBmaW5kaW5nIHBsdWdpbiBgICtcbiAgICAgIGAnJHtwbHVnaW59JyBidXQgaXQgd2FzIG5vdCByZWdpc3RlcmVkIGluIHRoZSAnY3VzdG9tRmluZE1vZHVsZXMnIGAgK1xuICAgICAgYGNhcGFiaWxpdHkuYCk7XG4gIH1cblxuICBsZXQgZmluZGVyO1xuICB0cnkge1xuICAgIGxvZy5kZWJ1ZyhgRmluZCBwbHVnaW4gJyR7cGx1Z2lufScgcmVxdWVzdGVkOyB3aWxsIGF0dGVtcHQgdG8gdXNlIGl0IGAgK1xuICAgICAgYGZyb20gJyR7cGx1Z2luc1twbHVnaW5dfSdgKTtcbiAgICBmaW5kZXIgPSByZXF1aXJlKHBsdWdpbnNbcGx1Z2luXSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGxvYWQgeW91ciBjdXN0b20gZmluZCBtb2R1bGUgJyR7cGx1Z2lufScuIERpZCBgICtcbiAgICAgIGB5b3UgcHV0IGl0IHNvbWV3aGVyZSBBcHBpdW0gY2FuICdyZXF1aXJlJyBpdD8gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyfWApO1xuICB9XG5cbiAgaWYgKCFmaW5kZXIgfHwgIV8uaXNGdW5jdGlvbihmaW5kZXIuZmluZCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdXIgY3VzdG9tIGZpbmQgbW9kdWxlIGRpZCBub3QgYXBwZWFyIHRvIGJlIGNvbnN0cnVjdGVkICcgK1xuICAgICAgICAnY29ycmVjdGx5LiBJdCBuZWVkcyB0byBleHBvcnQgYW4gb2JqZWN0IHdpdGggYSBgZmluZGAgbWV0aG9kLicpO1xuICB9XG5cbiAgY29uc3QgY3VzdG9tRmluZGVyTG9nID0gbG9nZ2VyLmdldExvZ2dlcihwbHVnaW4pO1xuXG4gIGxldCBlbGVtZW50cztcbiAgY29uc3QgY29uZGl0aW9uID0gYXN5bmMgKCkgPT4ge1xuICAgIC8vIGdldCBhIGxpc3Qgb2YgbWF0Y2hlZCBlbGVtZW50cyBmcm9tIHRoZSBjdXN0b20gZmluZGVyLCB3aGljaCBjYW5cbiAgICAvLyBwb3RlbnRpYWxseSB1c2UgdGhlIGVudGlyZSBzdWl0ZSBvZiBtZXRob2RzIHRoZSBjdXJyZW50IGRyaXZlciBwcm92aWRlcy5cbiAgICAvLyB0aGUgZmluZGVyIHNob3VsZCBhbHdheXMgcmV0dXJuIGEgbGlzdCBvZiBlbGVtZW50cywgYnV0IG1heSB1c2UgdGhlXG4gICAgLy8ga25vd2xlZGdlIG9mIHdoZXRoZXIgd2UgYXJlIGxvb2tpbmcgZm9yIG9uZSBvciBtYW55IHRvIHBlcmZvcm0gaW50ZXJuYWxcbiAgICAvLyBvcHRpbWl6YXRpb25zXG4gICAgZWxlbWVudHMgPSBhd2FpdCBmaW5kZXIuZmluZCh0aGlzLCBjdXN0b21GaW5kZXJMb2csIHJlYWxTZWxlY3RvciwgbXVsdGlwbGUpO1xuXG4gICAgLy8gaWYgd2UncmUgbG9va2luZyBmb3IgbXVsdGlwbGUgZWxlbWVudHMsIG9yIGlmIHdlJ3JlIGxvb2tpbmcgZm9yIG9ubHlcbiAgICAvLyBvbmUgYW5kIGZvdW5kIGl0LCB3ZSdyZSBkb25lXG4gICAgaWYgKCFfLmlzRW1wdHkoZWxlbWVudHMpIHx8IG11bHRpcGxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBvdGhlcndpc2Ugd2Ugc2hvdWxkIHJldHJ5LCBzbyByZXR1cm4gZmFsc2UgdG8gdHJpZ2dlciB0aGUgcmV0cnkgbG9vcFxuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcblxuICB0cnkge1xuICAgIC8vIG1ha2Ugc3VyZSB3ZSByZXNwZWN0IGltcGxpY2l0IHdhaXRcbiAgICBhd2FpdCB0aGlzLmltcGxpY2l0V2FpdEZvckNvbmRpdGlvbihjb25kaXRpb24pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLm1lc3NhZ2UubWF0Y2goL0NvbmRpdGlvbiB1bm1ldC8pKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cblxuICByZXR1cm4gbXVsdGlwbGUgPyBlbGVtZW50cyA6IGVsZW1lbnRzWzBdO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBGaW5kQnlJbWFnZU9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW3Nob3VsZENoZWNrU3RhbGVuZXNzPWZhbHNlXSAtIHdoZXRoZXIgdGhpcyBjYWxsIHRvIGZpbmQgYW5cbiAqIGltYWdlIGlzIG1lcmVseSB0byBjaGVjayBzdGFsZW5lc3MuIElmIHNvIHdlIGNhbiBieXBhc3MgYSBsb3Qgb2YgbG9naWNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW211bHRpcGxlPWZhbHNlXSAtIFdoZXRoZXIgd2UgYXJlIGZpbmRpbmcgb25lIGVsZW1lbnQgb3JcbiAqIG11bHRpcGxlXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IFtpZ25vcmVEZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlPWZhbHNlXSAtIFdoZXRoZXIgd2VcbiAqIGlnbm9yZSBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlLiBJdCBjYW4gYmUgdXNlZCB3aGVuIHlvdSB3b3VsZCBsaWtlIHRvXG4gKiBzY2FsZSBiNjRUZW1wbGF0ZSB3aXRoIGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgc2V0dGluZy5cbiAqL1xuXG4vKipcbiAqIEZpbmQgYSBzY3JlZW4gcmVjdCByZXByZXNlbnRlZCBieSBhbiBJbWFnZUVsZW1lbnQgY29ycmVzcG9uZGluZyB0byBhbiBpbWFnZVxuICogdGVtcGxhdGUgc2VudCBpbiBieSB0aGUgY2xpZW50XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGI2NFRlbXBsYXRlIC0gYmFzZTY0LWVuY29kZWQgaW1hZ2UgdXNlZCBhcyBhIHRlbXBsYXRlIHRvIGJlXG4gKiBtYXRjaGVkIGluIHRoZSBzY3JlZW5zaG90XG4gKiBAcGFyYW0ge0ZpbmRCeUltYWdlT3B0aW9uc30gLSBhZGRpdGlvbmFsIG9wdGlvbnNcbiAqXG4gKiBAcmV0dXJucyB7V2ViRWxlbWVudH0gLSBXZWJEcml2ZXIgZWxlbWVudCB3aXRoIGEgc3BlY2lhbCBpZCBwcmVmaXhcbiAqL1xuaGVscGVycy5maW5kQnlJbWFnZSA9IGFzeW5jIGZ1bmN0aW9uIGZpbmRCeUltYWdlIChiNjRUZW1wbGF0ZSwge1xuICBzaG91bGRDaGVja1N0YWxlbmVzcyA9IGZhbHNlLFxuICBtdWx0aXBsZSA9IGZhbHNlLFxuICBpZ25vcmVEZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlID0gZmFsc2UsXG59KSB7XG4gIGNvbnN0IHtcbiAgICBpbWFnZU1hdGNoVGhyZXNob2xkOiB0aHJlc2hvbGQsXG4gICAgZml4SW1hZ2VUZW1wbGF0ZVNpemUsXG4gICAgZml4SW1hZ2VUZW1wbGF0ZVNjYWxlLFxuICAgIGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGVcbiAgfSA9IHRoaXMuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKTtcblxuICBsb2cuaW5mbyhgRmluZGluZyBpbWFnZSBlbGVtZW50IHdpdGggbWF0Y2ggdGhyZXNob2xkICR7dGhyZXNob2xkfWApO1xuICBpZiAoIXRoaXMuZ2V0V2luZG93U2l6ZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlRoaXMgZHJpdmVyIGRvZXMgbm90IHN1cHBvcnQgdGhlIHJlcXVpcmVkICdnZXRXaW5kb3dTaXplJyBjb21tYW5kXCIpO1xuICB9XG4gIGNvbnN0IHt3aWR0aDogc2NyZWVuV2lkdGgsIGhlaWdodDogc2NyZWVuSGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuXG4gIC8vIHNvbWVvbmUgbWlnaHQgaGF2ZSBzZW50IGluIGEgdGVtcGxhdGUgdGhhdCdzIGxhcmdlciB0aGFuIHRoZSBzY3JlZW5cbiAgLy8gZGltZW5zaW9ucy4gSWYgc28gbGV0J3MgY2hlY2sgYW5kIGN1dCBpdCBkb3duIHRvIHNpemUgc2luY2UgdGhlIGFsZ29yaXRobVxuICAvLyB3aWxsIG5vdCB3b3JrIHVubGVzcyB3ZSBkby4gQnV0IGJlY2F1c2UgaXQgcmVxdWlyZXMgc29tZSBwb3RlbnRpYWxseVxuICAvLyBleHBlbnNpdmUgY29tbWFuZHMsIG9ubHkgZG8gdGhpcyBpZiB0aGUgdXNlciBoYXMgcmVxdWVzdGVkIGl0IGluIHNldHRpbmdzLlxuICBpZiAoZml4SW1hZ2VUZW1wbGF0ZVNpemUpIHtcbiAgICBiNjRUZW1wbGF0ZSA9IGF3YWl0IHRoaXMuZW5zdXJlVGVtcGxhdGVTaXplKGI2NFRlbXBsYXRlLCBzY3JlZW5XaWR0aCxcbiAgICAgIHNjcmVlbkhlaWdodCk7XG4gIH1cblxuICBsZXQgcmVjdCA9IG51bGw7XG4gIGNvbnN0IGNvbmRpdGlvbiA9IGFzeW5jICgpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qge2I2NFNjcmVlbnNob3QsIHNjYWxlfSA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdEZvckltYWdlRmluZChzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KTtcblxuICAgICAgYjY0VGVtcGxhdGUgPSBhd2FpdCB0aGlzLmZpeEltYWdlVGVtcGxhdGVTY2FsZShiNjRUZW1wbGF0ZSwge1xuICAgICAgICBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlLCBpZ25vcmVEZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlLFxuICAgICAgICBmaXhJbWFnZVRlbXBsYXRlU2NhbGUsIC4uLnNjYWxlXG4gICAgICB9KTtcblxuICAgICAgcmVjdCA9IChhd2FpdCB0aGlzLmNvbXBhcmVJbWFnZXMoTUFUQ0hfVEVNUExBVEVfTU9ERSwgYjY0U2NyZWVuc2hvdCxcbiAgICAgICAgYjY0VGVtcGxhdGUsIHt0aHJlc2hvbGR9KSkucmVjdDtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gaWYgY29tcGFyZUltYWdlcyBmYWlscywgd2UnbGwgZ2V0IGEgc3BlY2lmaWMgZXJyb3IsIGJ1dCB3ZSBzaG91bGRcbiAgICAgIC8vIHJldHJ5LCBzbyB0cmFwIHRoYXQgYW5kIGp1c3QgcmV0dXJuIGZhbHNlIHRvIHRyaWdnZXIgdGhlIG5leHQgcm91bmQgb2ZcbiAgICAgIC8vIGltcGxpY2l0bHkgd2FpdGluZy4gRm9yIG90aGVyIGVycm9ycywgdGhyb3cgdGhlbSB0byBnZXQgb3V0IG9mIHRoZVxuICAgICAgLy8gaW1wbGljaXQgd2FpdCBsb29wXG4gICAgICBpZiAoZXJyLm1lc3NhZ2UubWF0Y2goL0Nhbm5vdCBmaW5kIGFueSBvY2N1cnJlbmNlcy8pKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH07XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmltcGxpY2l0V2FpdEZvckNvbmRpdGlvbihjb25kaXRpb24pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyB0aGlzIGBpbXBsaWNpdFdhaXRGb3JDb25kaXRpb25gIG1ldGhvZCB3aWxsIHRocm93IGEgJ0NvbmRpdGlvbiB1bm1ldCdcbiAgICAvLyBlcnJvciBpZiBhbiBlbGVtZW50IGlzIG5vdCBmb3VuZCBldmVudHVhbGx5LiBJbiB0aGF0IGNhc2UsIHdlIHdpbGxcbiAgICAvLyBoYW5kbGUgdGhlIGVsZW1lbnQgbm90IGZvdW5kIHJlc3BvbnNlIGJlbG93LiBJbiB0aGUgY2FzZSB3aGVyZSBnZXQgc29tZVxuICAgIC8vIF9vdGhlcl8ga2luZCBvZiBlcnJvciwgaXQgbWVhbnMgc29tZXRoaW5nIGJsZXcgdXAgdG90YWxseSBhcGFydCBmcm9tIHRoZVxuICAgIC8vIGltcGxpY2l0IHdhaXQgdGltZW91dC4gV2Ugc2hvdWxkIG5vdCBtYXNrIHRoYXQgZXJyb3IgYW5kIGluc3RlYWQgdGhyb3dcbiAgICAvLyBpdCBzdHJhaWdodGF3YXlcbiAgICBpZiAoIWVyci5tZXNzYWdlLm1hdGNoKC9Db25kaXRpb24gdW5tZXQvKSkge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxuXG4gIGlmICghcmVjdCkge1xuICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICB9XG5cbiAgbG9nLmluZm8oYEltYWdlIHRlbXBsYXRlIG1hdGNoZWQ6ICR7SlNPTi5zdHJpbmdpZnkocmVjdCl9YCk7XG4gIGNvbnN0IGltZ0VsID0gbmV3IEltYWdlRWxlbWVudChiNjRUZW1wbGF0ZSwgcmVjdCk7XG5cbiAgLy8gaWYgd2UncmUganVzdCBjaGVja2luZyBzdGFsZW5lc3MsIHJldHVybiBzdHJhaWdodGF3YXkgc28gd2UgZG9uJ3QgYWRkXG4gIC8vIGEgbmV3IGVsZW1lbnQgdG8gdGhlIGNhY2hlLiBzaG91bGRDaGVja1N0YWxlbmVzcyBkb2VzIG5vdCBzdXBwb3J0IG11bHRpcGxlXG4gIC8vIGVsZW1lbnRzLCBzaW5jZSBpdCBpcyBhIHB1cmVseSBpbnRlcm5hbCBtZWNoYW5pc21cbiAgaWYgKHNob3VsZENoZWNrU3RhbGVuZXNzKSB7XG4gICAgcmV0dXJuIGltZ0VsO1xuICB9XG5cbiAgY29uc3QgcHJvdG9jb2xFbCA9IHRoaXMucmVnaXN0ZXJJbWFnZUVsZW1lbnQoaW1nRWwpO1xuXG4gIHJldHVybiBtdWx0aXBsZSA/IFtwcm90b2NvbEVsXSA6IHByb3RvY29sRWw7XG59O1xuXG4vKipcbiAqIEVuc3VyZSB0aGF0IHRoZSBpbWFnZSB0ZW1wbGF0ZSBzZW50IGluIGZvciBhIGZpbmQgaXMgb2YgYSBzdWl0YWJsZSBzaXplXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGI2NFRlbXBsYXRlIC0gYmFzZTY0LWVuY29kZWQgaW1hZ2VcbiAqIEBwYXJhbSB7aW50fSBzY3JlZW5XaWR0aCAtIHdpZHRoIG9mIHNjcmVlblxuICogQHBhcmFtIHtpbnR9IHNjcmVlbkhlaWdodCAtIGhlaWdodCBvZiBzY3JlZW5cbiAqXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBiYXNlNjQtZW5jb2RlZCBpbWFnZSwgcG90ZW50aWFsbHkgcmVzaXplZFxuICovXG5oZWxwZXJzLmVuc3VyZVRlbXBsYXRlU2l6ZSA9IGFzeW5jIGZ1bmN0aW9uIGVuc3VyZVRlbXBsYXRlU2l6ZSAoYjY0VGVtcGxhdGUsIHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQpIHtcbiAgbGV0IGltZ09iaiA9IGF3YWl0IGltYWdlVXRpbC5nZXRKaW1wSW1hZ2UoYjY0VGVtcGxhdGUpO1xuICBsZXQge3dpZHRoOiB0cGxXaWR0aCwgaGVpZ2h0OiB0cGxIZWlnaHR9ID0gaW1nT2JqLmJpdG1hcDtcblxuICBsb2cuaW5mbyhgVGVtcGxhdGUgaW1hZ2UgaXMgJHt0cGxXaWR0aH14JHt0cGxIZWlnaHR9LiBTY3JlZW4gc2l6ZSBpcyAke3NjcmVlbldpZHRofXgke3NjcmVlbkhlaWdodH1gKTtcbiAgLy8gaWYgdGhlIHRlbXBsYXRlIGZpdHMgaW5zaWRlIHRoZSBzY3JlZW4gZGltZW5zaW9ucywgd2UncmUgZ29vZFxuICBpZiAodHBsV2lkdGggPD0gc2NyZWVuV2lkdGggJiYgdHBsSGVpZ2h0IDw9IHNjcmVlbkhlaWdodCkge1xuICAgIHJldHVybiBiNjRUZW1wbGF0ZTtcbiAgfVxuXG4gIGxvZy5pbmZvKGBTY2FsaW5nIHRlbXBsYXRlIGltYWdlIGZyb20gJHt0cGxXaWR0aH14JHt0cGxIZWlnaHR9IHRvIG1hdGNoIGAgK1xuICAgICAgICAgICBgc2NyZWVuIGF0ICR7c2NyZWVuV2lkdGh9eCR7c2NyZWVuSGVpZ2h0fWApO1xuICAvLyBvdGhlcndpc2UsIHNjYWxlIGl0IHRvIGZpdCBpbnNpZGUgdGhlIHNjcmVlbiBkaW1lbnNpb25zXG4gIGltZ09iaiA9IGltZ09iai5zY2FsZVRvRml0KHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQpO1xuICByZXR1cm4gKGF3YWl0IGltZ09iai5nZXRCdWZmZXIoaW1hZ2VVdGlsLk1JTUVfUE5HKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTY3JlZW5zaG90XG4gKiBAcHJvcGVydHkge3N0cmluZ30gYjY0U2NyZWVuc2hvdCAtIGJhc2U2NCBiYXNlZCBzY3JlZW5zaG90IHN0cmluZ1xuICovXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFNjcmVlbnNob3RTY2FsZVxuICogQHByb3BlcnR5IHtmbG9hdH0geFNjYWxlIC0gU2NhbGUgcmF0aW8gZm9yIHdpZHRoXG4gKiBAcHJvcGVydHkge2Zsb2F0fSB5U2NhbGUgLSBTY2FsZSByYXRpbyBmb3IgaGVpZ2h0XG4gKi9cbi8qKlxuICogR2V0IHRoZSBzY3JlZW5zaG90IGltYWdlIHRoYXQgd2lsbCBiZSB1c2VkIGZvciBmaW5kIGJ5IGVsZW1lbnQsIHBvdGVudGlhbGx5XG4gKiBhbHRlcmluZyBpdCBpbiB2YXJpb3VzIHdheXMgYmFzZWQgb24gdXNlci1yZXF1ZXN0ZWQgc2V0dGluZ3NcbiAqXG4gKiBAcGFyYW0ge2ludH0gc2NyZWVuV2lkdGggLSB3aWR0aCBvZiBzY3JlZW5cbiAqIEBwYXJhbSB7aW50fSBzY3JlZW5IZWlnaHQgLSBoZWlnaHQgb2Ygc2NyZWVuXG4gKlxuICogQHJldHVybnMge1NjcmVlbnNob3QsID9TY3JlZW5zaG90U2NhbGV9IGJhc2U2NC1lbmNvZGVkIHNjcmVlbnNob3QgYW5kIFNjcmVlbnNob3RTY2FsZVxuICovXG5oZWxwZXJzLmdldFNjcmVlbnNob3RGb3JJbWFnZUZpbmQgPSBhc3luYyBmdW5jdGlvbiBnZXRTY3JlZW5zaG90Rm9ySW1hZ2VGaW5kIChzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KSB7XG4gIGlmICghdGhpcy5nZXRTY3JlZW5zaG90KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVGhpcyBkcml2ZXIgZG9lcyBub3Qgc3VwcG9ydCB0aGUgcmVxdWlyZWQgJ2dldFNjcmVlbnNob3QnIGNvbW1hbmRcIik7XG4gIH1cblxuICBsZXQgYjY0U2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdCgpO1xuXG4gIC8vIGlmIHRoZSB1c2VyIGhhcyByZXF1ZXN0ZWQgbm90IHRvIGNvcnJlY3QgZm9yIGFzcGVjdCBvciBzaXplIGRpZmZlcmVuY2VzXG4gIC8vIGJldHdlZW4gdGhlIHNjcmVlbnNob3QgYW5kIHRoZSBzY3JlZW4sIGp1c3QgcmV0dXJuIHRoZSBzY3JlZW5zaG90IG5vd1xuICBpZiAoIXRoaXMuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKS5maXhJbWFnZUZpbmRTY3JlZW5zaG90RGltcykge1xuICAgIGxvZy5pbmZvKGBOb3QgdmVyaWZ5aW5nIHNjcmVlbnNob3QgZGltZW5zaW9ucyBtYXRjaCBzY3JlZW5gKTtcbiAgICByZXR1cm4ge2I2NFNjcmVlbnNob3R9O1xuICB9XG5cbiAgLy8gb3RoZXJ3aXNlLCBkbyBzb21lIHZlcmlmaWNhdGlvbiBvbiB0aGUgc2NyZWVuc2hvdCB0byBtYWtlIHN1cmUgaXQgbWF0Y2hlc1xuICAvLyB0aGUgc2NyZWVuIHNpemUgYW5kIGFzcGVjdCByYXRpb1xuICBsb2cuaW5mbygnVmVyaWZ5aW5nIHNjcmVlbnNob3Qgc2l6ZSBhbmQgYXNwZWN0IHJhdGlvJyk7XG5cbiAgbGV0IGltZ09iaiA9IGF3YWl0IGltYWdlVXRpbC5nZXRKaW1wSW1hZ2UoYjY0U2NyZWVuc2hvdCk7XG4gIGxldCB7d2lkdGg6IHNob3RXaWR0aCwgaGVpZ2h0OiBzaG90SGVpZ2h0fSA9IGltZ09iai5iaXRtYXA7XG5cbiAgaWYgKHNjcmVlbldpZHRoID09PSBzaG90V2lkdGggJiYgc2NyZWVuSGVpZ2h0ID09PSBzaG90SGVpZ2h0KSB7XG4gICAgLy8gdGhlIGhlaWdodCBhbmQgd2lkdGggb2YgdGhlIHNjcmVlbnNob3QgYW5kIHRoZSBkZXZpY2Ugc2NyZWVuIG1hdGNoLCB3aGljaFxuICAgIC8vIG1lYW5zIHdlIHNob3VsZCBiZSBzYWZlIHdoZW4gZG9pbmcgdGVtcGxhdGUgbWF0Y2hlc1xuICAgIGxvZy5pbmZvKCdTY3JlZW5zaG90IHNpemUgbWF0Y2hlZCBzY3JlZW4gc2l6ZScpO1xuICAgIHJldHVybiB7YjY0U2NyZWVuc2hvdH07XG4gIH1cblxuICAvLyBvdGhlcndpc2UsIGlmIHRoZXkgZG9uJ3QgbWF0Y2gsIGl0IGNvdWxkIHNwZWxsIHByb2JsZW1zIGZvciB0aGUgYWNjdXJhY3lcbiAgLy8gb2YgY29vcmRpbmF0ZXMgcmV0dXJuZWQgYnkgdGhlIGltYWdlIG1hdGNoIGFsZ29yaXRobSwgc2luY2Ugd2UgbWF0Y2ggYmFzZWRcbiAgLy8gb24gdGhlIHNjcmVlbnNob3QgY29vcmRpbmF0ZXMgbm90IHRoZSBkZXZpY2UgY29vcmRpbmF0ZXMgdGhlbXNlbHZlcy4gVGhlcmVcbiAgLy8gYXJlIHR3byBwb3RlbnRpYWwgdHlwZXMgb2YgbWlzbWF0Y2g6IGFzcGVjdCByYXRpbyBtaXNtYXRjaCBhbmQgc2NhbGVcbiAgLy8gbWlzbWF0Y2guIFdlIG5lZWQgdG8gZGV0ZWN0IGFuZCBmaXggYm90aFxuXG4gIGNvbnN0IHNjYWxlID0ge3hTY2FsZTogMS4wLCB5U2NhbGU6IDEuMH07XG5cbiAgY29uc3Qgc2NyZWVuQVIgPSBzY3JlZW5XaWR0aCAvIHNjcmVlbkhlaWdodDtcbiAgY29uc3Qgc2hvdEFSID0gc2hvdFdpZHRoIC8gc2hvdEhlaWdodDtcbiAgaWYgKE1hdGgucm91bmQoc2NyZWVuQVIgKiBGTE9BVF9QUkVDSVNJT04pID09PSBNYXRoLnJvdW5kKHNob3RBUiAqIEZMT0FUX1BSRUNJU0lPTikpIHtcbiAgICBsb2cuaW5mbyhgU2NyZWVuc2hvdCBhc3BlY3QgcmF0aW8gJyR7c2hvdEFSfScgKCR7c2hvdFdpZHRofXgke3Nob3RIZWlnaHR9KSBtYXRjaGVkIGAgK1xuICAgICAgYHNjcmVlbiBhc3BlY3QgcmF0aW8gJyR7c2NyZWVuQVJ9JyAoJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9KWApO1xuICB9IGVsc2Uge1xuICAgIGxvZy53YXJuKGBXaGVuIHRyeWluZyB0byBmaW5kIGFuIGVsZW1lbnQsIGRldGVybWluZWQgdGhhdCB0aGUgc2NyZWVuIGAgK1xuICAgICAgICAgICAgIGBhc3BlY3QgcmF0aW8gYW5kIHNjcmVlbnNob3QgYXNwZWN0IHJhdGlvIGFyZSBkaWZmZXJlbnQuIFNjcmVlbiBgICtcbiAgICAgICAgICAgICBgaXMgJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9IHdoZXJlYXMgc2NyZWVuc2hvdCBpcyBgICtcbiAgICAgICAgICAgICBgJHtzaG90V2lkdGh9eCR7c2hvdEhlaWdodH0uYCk7XG5cbiAgICAvLyBJbiB0aGUgY2FzZSB3aGVyZSB0aGUgeC1zY2FsZSBhbmQgeS1zY2FsZSBhcmUgZGlmZmVyZW50LCB3ZSBuZWVkIHRvIGRlY2lkZVxuICAgIC8vIHdoaWNoIG9uZSB0byByZXNwZWN0LCBvdGhlcndpc2UgdGhlIHNjcmVlbnNob3QgYW5kIHRlbXBsYXRlIHdpbGwgZW5kIHVwXG4gICAgLy8gYmVpbmcgcmVzaXplZCBpbiBhIHdheSB0aGF0IGNoYW5nZXMgaXRzIGFzcGVjdCByYXRpbyAoZGlzdG9ydHMgaXQpLiBGb3IgZXhhbXBsZSwgbGV0J3Mgc2F5OlxuICAgIC8vIHRoaXMuZ2V0U2NyZWVuc2hvdChzaG90V2lkdGgsIHNob3RIZWlnaHQpIGlzIDU0MHgzOTcsXG4gICAgLy8gdGhpcy5nZXREZXZpY2VTaXplKHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQpIGlzIDEwODB4MTkyMC5cbiAgICAvLyBUaGUgcmF0aW8gd291bGQgdGhlbiBiZSB7eFNjYWxlOiAwLjUsIHlTY2FsZTogMC4yfS5cbiAgICAvLyBJbiB0aGlzIGNhc2UsIHdlIG11c3Qgc2hvdWxkIGB5U2NhbGU6IDAuMmAgYXMgc2NhbGVGYWN0b3IsIGJlY2F1c2VcbiAgICAvLyBpZiB3ZSBzZWxlY3QgdGhlIHhTY2FsZSwgdGhlIGhlaWdodCB3aWxsIGJlIGJpZ2dlciB0aGFuIHJlYWwgc2NyZWVuc2hvdCBzaXplXG4gICAgLy8gd2hpY2ggaXMgdXNlZCB0byBpbWFnZSBjb21wYXJpc29uIGJ5IE9wZW5DViBhcyBhIGJhc2UgaW1hZ2UuXG4gICAgLy8gQWxsIG9mIHRoaXMgaXMgcHJpbWFyaWx5IHVzZWZ1bCB3aGVuIHRoZSBzY3JlZW5zaG90IGlzIGEgaG9yaXpvbnRhbCBzbGljZSB0YWtlbiBvdXQgb2YgdGhlXG4gICAgLy8gc2NyZWVuIChmb3IgZXhhbXBsZSBub3QgaW5jbHVkaW5nIHRvcC9ib3R0b20gbmF2IGJhcnMpXG4gICAgY29uc3QgeFNjYWxlID0gKDEuMCAqIHNob3RXaWR0aCkgLyBzY3JlZW5XaWR0aDtcbiAgICBjb25zdCB5U2NhbGUgPSAoMS4wICogc2hvdEhlaWdodCkgLyBzY3JlZW5IZWlnaHQ7XG4gICAgY29uc3Qgc2NhbGVGYWN0b3IgPSB4U2NhbGUgPj0geVNjYWxlID8geVNjYWxlIDogeFNjYWxlO1xuXG4gICAgbG9nLndhcm4oYFJlc2l6aW5nIHNjcmVlbnNob3QgdG8gJHtzaG90V2lkdGggKiBzY2FsZUZhY3Rvcn14JHtzaG90SGVpZ2h0ICogc2NhbGVGYWN0b3J9IHRvIG1hdGNoIGAgK1xuICAgICAgICAgICAgIGBzY3JlZW4gYXNwZWN0IHJhdGlvIHNvIHRoYXQgaW1hZ2UgZWxlbWVudCBjb29yZGluYXRlcyBoYXZlIGEgYCArXG4gICAgICAgICAgICAgYGdyZWF0ZXIgY2hhbmNlIG9mIGJlaW5nIGNvcnJlY3QuYCk7XG4gICAgaW1nT2JqID0gaW1nT2JqLnJlc2l6ZShzaG90V2lkdGggKiBzY2FsZUZhY3Rvciwgc2hvdEhlaWdodCAqIHNjYWxlRmFjdG9yKTtcblxuICAgIHNjYWxlLnhTY2FsZSAqPSBzY2FsZUZhY3RvcjtcbiAgICBzY2FsZS55U2NhbGUgKj0gc2NhbGVGYWN0b3I7XG5cbiAgICBzaG90V2lkdGggPSBpbWdPYmouYml0bWFwLndpZHRoO1xuICAgIHNob3RIZWlnaHQgPSBpbWdPYmouYml0bWFwLmhlaWdodDtcbiAgfVxuXG4gIC8vIFJlc2l6ZSBiYXNlZCBvbiB0aGUgc2NyZWVuIGRpbWVuc2lvbnMgb25seSBpZiBib3RoIHdpZHRoIGFuZCBoZWlnaHQgYXJlIG1pc21hdGNoZWRcbiAgLy8gc2luY2UgZXhjZXB0IGZvciB0aGF0LCBpdCBtaWdodCBiZSBhIHNpdHVhdGlvbiB3aGljaCBpcyBkaWZmZXJlbnQgd2luZG93IHJlY3QgYW5kXG4gIC8vIHNjcmVlbnNob3Qgc2l6ZSBsaWtlIGBAZHJpdmVyLndpbmRvd19yZWN0ICM9Png9MCwgeT0wLCB3aWR0aD0xMDgwLCBoZWlnaHQ9MTc5NGAgYW5kXG4gIC8vIGBcImRldmljZVNjcmVlblNpemVcIj0+XCIxMDgweDE5MjBcImBcbiAgaWYgKHNjcmVlbldpZHRoICE9PSBzaG90V2lkdGggJiYgc2NyZWVuSGVpZ2h0ICE9PSBzaG90SGVpZ2h0KSB7XG4gICAgbG9nLmluZm8oYFNjYWxpbmcgc2NyZWVuc2hvdCBmcm9tICR7c2hvdFdpZHRofXgke3Nob3RIZWlnaHR9IHRvIG1hdGNoIGAgK1xuICAgICAgICAgICAgIGBzY3JlZW4gYXQgJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9YCk7XG4gICAgaW1nT2JqID0gaW1nT2JqLnJlc2l6ZShzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KTtcblxuICAgIHNjYWxlLnhTY2FsZSAqPSAoMS4wICogc2NyZWVuV2lkdGgpIC8gc2hvdFdpZHRoO1xuICAgIHNjYWxlLnlTY2FsZSAqPSAoMS4wICogc2NyZWVuSGVpZ2h0KSAvIHNob3RIZWlnaHQ7XG4gIH1cblxuICBiNjRTY3JlZW5zaG90ID0gKGF3YWl0IGltZ09iai5nZXRCdWZmZXIoaW1hZ2VVdGlsLk1JTUVfUE5HKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICByZXR1cm4ge2I2NFNjcmVlbnNob3QsIHNjYWxlfTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gSW1hZ2VUZW1wbGF0ZVNldHRpbmdzXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGZpeEltYWdlVGVtcGxhdGVTY2FsZSAtIGZpeEltYWdlVGVtcGxhdGVTY2FsZSBpbiBkZXZpY2Utc2V0dGluZ3NcbiAqIEBwcm9wZXJ0eSB7ZmxvYXR9IGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgLSBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlIGluIGRldmljZS1zZXR0aW5nc1xuICogQHByb3BlcnR5IHtib29sZWFufSBpZ25vcmVEZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlIC0gSWdub3JlIGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgaWYgaXQgaGFzIHRydWUuXG4gKiBJZiBiNjRUZW1wbGF0ZSBoYXMgYmVlbiBzY2FsZWQgdG8gZGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZSBvciBzaG91bGQgaWdub3JlIHRoZSBzY2FsZSxcbiAqIHRoaXMgcGFyYW1ldGVyIHNob3VsZCBiZSB0cnVlLiBlLmcuIGNsaWNrIGluIGltYWdlLWVsZW1lbnQgbW9kdWxlXG4gKiBAcHJvcGVydHkge2Zsb2F0fSB4U2NhbGUgLSBTY2FsZSByYXRpbyBmb3Igd2lkdGhcbiAqIEBwcm9wZXJ0eSB7ZmxvYXR9IHlTY2FsZSAtIFNjYWxlIHJhdGlvIGZvciBoZWlnaHRcblxuICovXG4vKipcbiAqIEdldCBhIGltYWdlIHRoYXQgd2lsbCBiZSB1c2VkIGZvciB0ZW1wbGF0ZSBtYWNoaW5nLlxuICogUmV0dXJucyBzY2FsZWQgaW1hZ2UgaWYgc2NhbGUgcmF0aW8gaXMgcHJvdmlkZWQuXG4gKlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBiNjRUZW1wbGF0ZSAtIGJhc2U2NC1lbmNvZGVkIGltYWdlIHVzZWQgYXMgYSB0ZW1wbGF0ZSB0byBiZVxuICogbWF0Y2hlZCBpbiB0aGUgc2NyZWVuc2hvdFxuICogQHBhcmFtIHtJbWFnZVRlbXBsYXRlU2V0dGluZ3N9IG9wdHMgLSBJbWFnZSB0ZW1wbGF0ZSBzY2FsZSByZWxhdGVkIG9wdGlvbnNcbiAqXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBiYXNlNjQtZW5jb2RlZCBzY2FsZWQgdGVtcGxhdGUgc2NyZWVuc2hvdFxuICovXG5jb25zdCBERUZBVUxUX0ZJWF9JTUFHRV9URU1QTEFURV9TQ0FMRSA9IDE7XG5oZWxwZXJzLmZpeEltYWdlVGVtcGxhdGVTY2FsZSA9IGFzeW5jIGZ1bmN0aW9uIGZpeEltYWdlVGVtcGxhdGVTY2FsZSAoYjY0VGVtcGxhdGUsIG9wdHMgPSB7fSkge1xuICBpZiAoIW9wdHMpIHtcbiAgICByZXR1cm4gYjY0VGVtcGxhdGU7XG4gIH1cblxuICBsZXQge1xuICAgIGZpeEltYWdlVGVtcGxhdGVTY2FsZSA9IGZhbHNlLFxuICAgIGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgPSBERUZBVUxUX1RFTVBMQVRFX0lNQUdFX1NDQUxFLFxuICAgIGlnbm9yZURlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgPSBmYWxzZSxcbiAgICB4U2NhbGUgPSBERUZBVUxUX0ZJWF9JTUFHRV9URU1QTEFURV9TQ0FMRSxcbiAgICB5U2NhbGUgPSBERUZBVUxUX0ZJWF9JTUFHRV9URU1QTEFURV9TQ0FMRVxuICB9ID0gb3B0cztcblxuICBpZiAoaWdub3JlRGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZSkge1xuICAgIGRlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgPSBERUZBVUxUX1RFTVBMQVRFX0lNQUdFX1NDQUxFO1xuICB9XG5cbiAgLy8gRGVmYXVsdFxuICBpZiAoZGVmYXVsdEltYWdlVGVtcGxhdGVTY2FsZSA9PT0gREVGQVVMVF9URU1QTEFURV9JTUFHRV9TQ0FMRSAmJiAhZml4SW1hZ2VUZW1wbGF0ZVNjYWxlKSB7XG4gICAgcmV0dXJuIGI2NFRlbXBsYXRlO1xuICB9XG5cbiAgLy8gQ2FsY3VsYXRlIHhTY2FsZSBhbmQgeVNjYWxlIEFwcGl1bSBzaG91bGQgc2NhbGVcbiAgaWYgKGZpeEltYWdlVGVtcGxhdGVTY2FsZSkge1xuICAgIHhTY2FsZSAqPSBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlO1xuICAgIHlTY2FsZSAqPSBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlO1xuICB9IGVsc2Uge1xuICAgIHhTY2FsZSA9IHlTY2FsZSA9IDEgKiBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlO1xuICB9XG5cbiAgLy8geFNjYWxlIGFuZCB5U2NhbGUgY2FuIGJlIE5hTiBpZiBkZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlIGlzIHN0cmluZywgZm9yIGV4YW1wbGVcbiAgaWYgKCFwYXJzZUZsb2F0KHhTY2FsZSkgfHwgIXBhcnNlRmxvYXQoeVNjYWxlKSkge1xuICAgIHJldHVybiBiNjRUZW1wbGF0ZTtcbiAgfVxuXG4gIC8vIFJldHVybiBpZiB0aGUgc2NhbGUgaXMgZGVmYXVsdCwgMSwgdmFsdWVcbiAgaWYgKE1hdGgucm91bmQoeFNjYWxlICogRkxPQVRfUFJFQ0lTSU9OKSA9PT0gTWF0aC5yb3VuZChERUZBVUxUX0ZJWF9JTUFHRV9URU1QTEFURV9TQ0FMRSAqIEZMT0FUX1BSRUNJU0lPTilcbiAgICAgICYmIE1hdGgucm91bmQoeVNjYWxlICogRkxPQVRfUFJFQ0lTSU9OID09PSBNYXRoLnJvdW5kKERFRkFVTFRfRklYX0lNQUdFX1RFTVBMQVRFX1NDQUxFICogRkxPQVRfUFJFQ0lTSU9OKSkpIHtcbiAgICByZXR1cm4gYjY0VGVtcGxhdGU7XG4gIH1cblxuICBsZXQgaW1nVGVtcE9iaiA9IGF3YWl0IGltYWdlVXRpbC5nZXRKaW1wSW1hZ2UoYjY0VGVtcGxhdGUpO1xuICBsZXQge3dpZHRoOiBiYXNlVGVtcFdpZHRoLCBoZWlnaHQ6IGJhc2VUZW1wSGVpZ2h9ID0gaW1nVGVtcE9iai5iaXRtYXA7XG5cbiAgY29uc3Qgc2NhbGVkV2lkdGggPSBiYXNlVGVtcFdpZHRoICogeFNjYWxlO1xuICBjb25zdCBzY2FsZWRIZWlnaHQgPSBiYXNlVGVtcEhlaWdoICogeVNjYWxlO1xuICBsb2cuaW5mbyhgU2NhbGluZyB0ZW1wbGF0ZSBpbWFnZSBmcm9tICR7YmFzZVRlbXBXaWR0aH14JHtiYXNlVGVtcEhlaWdofWAgK1xuICAgICAgICAgICAgYCB0byAke3NjYWxlZFdpZHRofXgke3NjYWxlZEhlaWdodH1gKTtcbiAgbG9nLmluZm8oYFRoZSByYXRpbyBpcyAke3hTY2FsZX0gYW5kICR7eVNjYWxlfWApO1xuICBpbWdUZW1wT2JqID0gYXdhaXQgaW1nVGVtcE9iai5yZXNpemUoc2NhbGVkV2lkdGgsIHNjYWxlZEhlaWdodCk7XG4gIHJldHVybiAoYXdhaXQgaW1nVGVtcE9iai5nZXRCdWZmZXIoaW1hZ2VVdGlsLk1JTUVfUE5HKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycywgSU1BR0VfU1RSQVRFR1ksIENVU1RPTV9TVFJBVEVHWSB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvY29tbWFuZHMvZmluZC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
