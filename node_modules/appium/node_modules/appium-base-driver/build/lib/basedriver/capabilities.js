"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseCaps = parseCaps;
exports.processCapabilities = processCapabilities;
exports.validateCaps = validateCaps;
exports.mergeCaps = mergeCaps;
exports.findNonPrefixedCaps = findNonPrefixedCaps;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _desiredCaps = require("./desired-caps");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _errors = require("../protocol/errors");

function mergeCaps(primary = {}, secondary = {}) {
  let result = Object.assign({}, primary);

  for (let [name, value] of _lodash.default.toPairs(secondary)) {
    if (!_lodash.default.isUndefined(primary[name])) {
      throw new _errors.errors.InvalidArgumentError(`property '${name}' should not exist on both primary (${JSON.stringify(primary)}) and secondary (${JSON.stringify(secondary)}) object`);
    }

    result[name] = value;
  }

  return result;
}

function validateCaps(caps, constraints = {}, opts = {}) {
  let {
    skipPresenceConstraint
  } = opts;

  if (!_lodash.default.isPlainObject(caps)) {
    throw new _errors.errors.InvalidArgumentError(`must be a JSON object`);
  }

  constraints = _lodash.default.cloneDeep(constraints);

  if (skipPresenceConstraint) {
    for (let key of _lodash.default.keys(constraints)) {
      delete constraints[key].presence;
    }
  }

  let validationErrors = _desiredCaps.validator.validate(_lodash.default.pickBy(caps, _appiumSupport.util.hasValue), constraints, {
    fullMessages: false
  });

  if (validationErrors) {
    let message = [];

    for (let [attribute, reasons] of _lodash.default.toPairs(validationErrors)) {
      for (let reason of reasons) {
        message.push(`'${attribute}' ${reason}`);
      }
    }

    throw new _errors.errors.InvalidArgumentError(message.join('; '));
  }

  return caps;
}

const STANDARD_CAPS = ['browserName', 'browserVersion', 'platformName', 'acceptInsecureCerts', 'pageLoadStrategy', 'proxy', 'setWindowRect', 'timeouts', 'unhandledPromptBehavior'];

function isStandardCap(cap) {
  return !!_lodash.default.find(STANDARD_CAPS, standardCap => standardCap.toLowerCase() === `${cap}`.toLowerCase());
}

function stripAppiumPrefixes(caps) {
  const prefix = 'appium:';

  const prefixedCaps = _lodash.default.filter(_lodash.default.keys(caps), cap => `${cap}`.startsWith(prefix));

  const badPrefixedCaps = [];

  for (let prefixedCap of prefixedCaps) {
    const strippedCapName = prefixedCap.substr(prefix.length);

    if (isStandardCap(strippedCapName)) {
      badPrefixedCaps.push(strippedCapName);
    }

    caps[strippedCapName] = caps[prefixedCap];
    delete caps[prefixedCap];
  }

  if (badPrefixedCaps.length > 0) {
    throw new _errors.errors.InvalidArgumentError(`The capabilities ${JSON.stringify(badPrefixedCaps)} are standard capabilities and should not have the "appium:" prefix`);
  }
}

function findNonPrefixedCaps({
  alwaysMatch = {},
  firstMatch = []
}) {
  return _lodash.default.chain([alwaysMatch, ...firstMatch]).reduce((unprefixedCaps, caps) => [...unprefixedCaps, ...(0, _lodash.default)(caps).keys().filter(cap => !cap.includes(':') && !isStandardCap(cap))], []).uniq().value();
}

function parseCaps(caps, constraints = {}, shouldValidateCaps = true) {
  if (!_lodash.default.isPlainObject(caps)) {
    throw new _errors.errors.InvalidArgumentError('The capabilities argument was not valid for the following reason(s): "capabilities" must be a JSON object.');
  }

  let {
    alwaysMatch: requiredCaps = {},
    firstMatch: allFirstMatchCaps = [{}]
  } = caps;

  if (!_lodash.default.isArray(allFirstMatchCaps)) {
    throw new _errors.errors.InvalidArgumentError('The capabilities.firstMatch argument was not valid for the following reason(s): "capabilities.firstMatch" must be a JSON array or undefined');
  }

  if (allFirstMatchCaps.length === 0) {
    allFirstMatchCaps.push({});
  }

  let nonPrefixedCaps = findNonPrefixedCaps(caps);

  if (!_lodash.default.isEmpty(nonPrefixedCaps)) {
    _logger.default.warn(`The capabilities ${JSON.stringify(nonPrefixedCaps)} are not standard capabilities and should have an extension prefix`);
  }

  stripAppiumPrefixes(requiredCaps);

  for (let firstMatchCaps of allFirstMatchCaps) {
    stripAppiumPrefixes(firstMatchCaps);
  }

  if (shouldValidateCaps) {
    requiredCaps = validateCaps(requiredCaps, constraints, {
      skipPresenceConstraint: true
    });
  }

  let filteredConstraints = { ...constraints
  };

  let requiredCapsKeys = _lodash.default.keys(requiredCaps);

  for (let key of _lodash.default.keys(filteredConstraints)) {
    if (requiredCapsKeys.includes(key)) {
      delete filteredConstraints[key];
    }
  }

  let validationErrors = [];
  let validatedFirstMatchCaps = allFirstMatchCaps.map(firstMatchCaps => {
    try {
      return shouldValidateCaps ? validateCaps(firstMatchCaps, filteredConstraints) : firstMatchCaps;
    } catch (e) {
      validationErrors.push(e.message);
      return null;
    }
  }).filter(caps => !_lodash.default.isNull(caps));
  let matchedCaps = null;

  for (let firstMatchCaps of validatedFirstMatchCaps) {
    try {
      matchedCaps = mergeCaps(requiredCaps, firstMatchCaps);

      if (matchedCaps) {
        break;
      }
    } catch (err) {
      _logger.default.warn(err.message);
    }
  }

  return {
    requiredCaps,
    allFirstMatchCaps,
    validatedFirstMatchCaps,
    matchedCaps,
    validationErrors
  };
}

function processCapabilities(caps, constraints = {}, shouldValidateCaps = true) {
  const {
    matchedCaps,
    validationErrors
  } = parseCaps(caps, constraints, shouldValidateCaps);

  if (!_appiumSupport.util.hasValue(matchedCaps)) {
    if (_lodash.default.isArray(caps.firstMatch) && caps.firstMatch.length > 1) {
      throw new _errors.errors.InvalidArgumentError(`Could not find matching capabilities from ${JSON.stringify(caps)}:\n ${validationErrors.join('\n')}`);
    } else {
      throw new _errors.errors.InvalidArgumentError(validationErrors[0]);
    }
  }

  return matchedCaps;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NhcGFiaWxpdGllcy5qcyJdLCJuYW1lcyI6WyJtZXJnZUNhcHMiLCJwcmltYXJ5Iiwic2Vjb25kYXJ5IiwicmVzdWx0IiwiT2JqZWN0IiwiYXNzaWduIiwibmFtZSIsInZhbHVlIiwiXyIsInRvUGFpcnMiLCJpc1VuZGVmaW5lZCIsImVycm9ycyIsIkludmFsaWRBcmd1bWVudEVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsInZhbGlkYXRlQ2FwcyIsImNhcHMiLCJjb25zdHJhaW50cyIsIm9wdHMiLCJza2lwUHJlc2VuY2VDb25zdHJhaW50IiwiaXNQbGFpbk9iamVjdCIsImNsb25lRGVlcCIsImtleSIsImtleXMiLCJwcmVzZW5jZSIsInZhbGlkYXRpb25FcnJvcnMiLCJ2YWxpZGF0b3IiLCJ2YWxpZGF0ZSIsInBpY2tCeSIsInV0aWwiLCJoYXNWYWx1ZSIsImZ1bGxNZXNzYWdlcyIsIm1lc3NhZ2UiLCJhdHRyaWJ1dGUiLCJyZWFzb25zIiwicmVhc29uIiwicHVzaCIsImpvaW4iLCJTVEFOREFSRF9DQVBTIiwiaXNTdGFuZGFyZENhcCIsImNhcCIsImZpbmQiLCJzdGFuZGFyZENhcCIsInRvTG93ZXJDYXNlIiwic3RyaXBBcHBpdW1QcmVmaXhlcyIsInByZWZpeCIsInByZWZpeGVkQ2FwcyIsImZpbHRlciIsInN0YXJ0c1dpdGgiLCJiYWRQcmVmaXhlZENhcHMiLCJwcmVmaXhlZENhcCIsInN0cmlwcGVkQ2FwTmFtZSIsInN1YnN0ciIsImxlbmd0aCIsImZpbmROb25QcmVmaXhlZENhcHMiLCJhbHdheXNNYXRjaCIsImZpcnN0TWF0Y2giLCJjaGFpbiIsInJlZHVjZSIsInVucHJlZml4ZWRDYXBzIiwiaW5jbHVkZXMiLCJ1bmlxIiwicGFyc2VDYXBzIiwic2hvdWxkVmFsaWRhdGVDYXBzIiwicmVxdWlyZWRDYXBzIiwiYWxsRmlyc3RNYXRjaENhcHMiLCJpc0FycmF5Iiwibm9uUHJlZml4ZWRDYXBzIiwiaXNFbXB0eSIsImxvZyIsIndhcm4iLCJmaXJzdE1hdGNoQ2FwcyIsImZpbHRlcmVkQ29uc3RyYWludHMiLCJyZXF1aXJlZENhcHNLZXlzIiwidmFsaWRhdGVkRmlyc3RNYXRjaENhcHMiLCJtYXAiLCJlIiwiaXNOdWxsIiwibWF0Y2hlZENhcHMiLCJlcnIiLCJwcm9jZXNzQ2FwYWJpbGl0aWVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQSxTQUFTQSxTQUFULENBQW9CQyxPQUFPLEdBQUcsRUFBOUIsRUFBa0NDLFNBQVMsR0FBRyxFQUE5QyxFQUFrRDtBQUNoRCxNQUFJQyxNQUFNLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JKLE9BQWxCLENBQWI7O0FBRUEsT0FBSyxJQUFJLENBQUNLLElBQUQsRUFBT0MsS0FBUCxDQUFULElBQTBCQyxnQkFBRUMsT0FBRixDQUFVUCxTQUFWLENBQTFCLEVBQWdEO0FBRTlDLFFBQUksQ0FBQ00sZ0JBQUVFLFdBQUYsQ0FBY1QsT0FBTyxDQUFDSyxJQUFELENBQXJCLENBQUwsRUFBbUM7QUFDakMsWUFBTSxJQUFJSyxlQUFPQyxvQkFBWCxDQUFpQyxhQUFZTixJQUFLLHVDQUFzQ08sSUFBSSxDQUFDQyxTQUFMLENBQWViLE9BQWYsQ0FBd0Isb0JBQW1CWSxJQUFJLENBQUNDLFNBQUwsQ0FBZVosU0FBZixDQUEwQixVQUE3SixDQUFOO0FBQ0Q7O0FBQ0RDLElBQUFBLE1BQU0sQ0FBQ0csSUFBRCxDQUFOLEdBQWVDLEtBQWY7QUFDRDs7QUFFRCxTQUFPSixNQUFQO0FBQ0Q7O0FBR0QsU0FBU1ksWUFBVCxDQUF1QkMsSUFBdkIsRUFBNkJDLFdBQVcsR0FBRyxFQUEzQyxFQUErQ0MsSUFBSSxHQUFHLEVBQXRELEVBQTBEO0FBRXhELE1BQUk7QUFBQ0MsSUFBQUE7QUFBRCxNQUEyQkQsSUFBL0I7O0FBRUEsTUFBSSxDQUFDVixnQkFBRVksYUFBRixDQUFnQkosSUFBaEIsQ0FBTCxFQUE0QjtBQUMxQixV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QVgsQ0FBaUMsNkNBQTRDQyxJQUFJLENBQUNDLFNBQUwsQ0FBZUUsSUFBZixDQUFxQixPQUFNUyxnQkFBZ0IsQ0FBQ1ksSUFBakIsQ0FBc0IsSUFBdEIsQ0FBNEIsRUFBcEksQ0FBTjtBQUNELEtBSEQsTUFHTztBQUVMLFlBQU0sSUFBSTFCLGVBQU9DLG9CQUFYLENBQWdDYSxnQkFBZ0IsQ0FBQyxDQUFELENBQWhELENBQU47QUFDRDtBQUNGOztBQUVELFNBQU9xRCxXQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdmFsaWRhdG9yIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnLi4vcHJvdG9jb2wvZXJyb3JzJztcblxuLy8gVGFrZXMgcHJpbWFyeSBjYXBzIG9iamVjdCBhbmQgbWVyZ2VzIGl0IGludG8gYSBzZWNvbmRhcnkgY2FwcyBvYmplY3QuXG4vLyAoc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93ZWJkcml2ZXIvI2Rmbi1tZXJnaW5nLWNhcGFiaWxpdGllcylcbmZ1bmN0aW9uIG1lcmdlQ2FwcyAocHJpbWFyeSA9IHt9LCBzZWNvbmRhcnkgPSB7fSkge1xuICBsZXQgcmVzdWx0ID0gT2JqZWN0LmFzc2lnbih7fSwgcHJpbWFyeSk7XG5cbiAgZm9yIChsZXQgW25hbWUsIHZhbHVlXSBvZiBfLnRvUGFpcnMoc2Vjb25kYXJ5KSkge1xuICAgIC8vIE92ZXJ3cml0aW5nIGlzIG5vdCBhbGxvd2VkLiBQcmltYXJ5IGFuZCBzZWNvbmRhcnkgbXVzdCBoYXZlIGRpZmZlcmVudCBwcm9wZXJ0aWVzICh3M2MgcnVsZSA0LjQpXG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHByaW1hcnlbbmFtZV0pKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRBcmd1bWVudEVycm9yKGBwcm9wZXJ0eSAnJHtuYW1lfScgc2hvdWxkIG5vdCBleGlzdCBvbiBib3RoIHByaW1hcnkgKCR7SlNPTi5zdHJpbmdpZnkocHJpbWFyeSl9KSBhbmQgc2Vjb25kYXJ5ICgke0pTT04uc3RyaW5naWZ5KHNlY29uZGFyeSl9KSBvYmplY3RgKTtcbiAgICB9XG4gICAgcmVzdWx0W25hbWVdID0gdmFsdWU7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG4vLyBWYWxpZGF0ZXMgY2FwcyBhZ2FpbnN0IGEgc2V0IG9mIGNvbnN0cmFpbnRzXG5mdW5jdGlvbiB2YWxpZGF0ZUNhcHMgKGNhcHMsIGNvbnN0cmFpbnRzID0ge30sIG9wdHMgPSB7fSkge1xuXG4gIGxldCB7c2tpcFByZXNlbmNlQ29uc3RyYWludH0gPSBvcHRzO1xuXG4gIGlmICghXy5pc1BsYWluT2JqZWN0KGNhcHMpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcihgbXVzdCBiZSBhIEpTT04gb2JqZWN0YCk7XG4gIH1cblxuICBjb25zdHJhaW50cyA9IF8uY2xvbmVEZWVwKGNvbnN0cmFpbnRzKTsgLy8gRGVmZW5zaXZlIGNvcHlcblxuICBpZiAoc2tpcFByZXNlbmNlQ29uc3RyYWludCkge1xuICAgIC8vIFJlbW92ZSB0aGUgJ3ByZXNlbmNlJyBjb25zdHJhaW50IGlmIHdlJ3JlIG5vdCBjaGVja2luZyBmb3IgaXRcbiAgICBmb3IgKGxldCBrZXkgb2YgXy5rZXlzKGNvbnN0cmFpbnRzKSkge1xuICAgICAgZGVsZXRlIGNvbnN0cmFpbnRzW2tleV0ucHJlc2VuY2U7XG4gICAgfVxuICB9XG5cbiAgbGV0IHZhbGlkYXRpb25FcnJvcnMgPSB2YWxpZGF0b3IudmFsaWRhdGUoXy5waWNrQnkoY2FwcywgdXRpbC5oYXNWYWx1ZSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3RyYWludHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge2Z1bGxNZXNzYWdlczogZmFsc2V9KTtcblxuICBpZiAodmFsaWRhdGlvbkVycm9ycykge1xuICAgIGxldCBtZXNzYWdlID0gW107XG4gICAgZm9yIChsZXQgW2F0dHJpYnV0ZSwgcmVhc29uc10gb2YgXy50b1BhaXJzKHZhbGlkYXRpb25FcnJvcnMpKSB7XG4gICAgICBmb3IgKGxldCByZWFzb24gb2YgcmVhc29ucykge1xuICAgICAgICBtZXNzYWdlLnB1c2goYCcke2F0dHJpYnV0ZX0nICR7cmVhc29ufWApO1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRBcmd1bWVudEVycm9yKG1lc3NhZ2Uuam9pbignOyAnKSk7XG4gIH1cblxuICAvLyBSZXR1cm4gY2Fwc1xuICByZXR1cm4gY2Fwcztcbn1cblxuLy8gU3RhbmRhcmQsIG5vbi1wcmVmaXhlZCBjYXBhYmlsaXRpZXMgKHNlZSBodHRwczovL3d3dy53My5vcmcvVFIvd2ViZHJpdmVyLyNkZm4tdGFibGUtb2Ytc3RhbmRhcmQtY2FwYWJpbGl0aWVzKVxuY29uc3QgU1RBTkRBUkRfQ0FQUyA9IFtcbiAgJ2Jyb3dzZXJOYW1lJyxcbiAgJ2Jyb3dzZXJWZXJzaW9uJyxcbiAgJ3BsYXRmb3JtTmFtZScsXG4gICdhY2NlcHRJbnNlY3VyZUNlcnRzJyxcbiAgJ3BhZ2VMb2FkU3RyYXRlZ3knLFxuICAncHJveHknLFxuICAnc2V0V2luZG93UmVjdCcsXG4gICd0aW1lb3V0cycsXG4gICd1bmhhbmRsZWRQcm9tcHRCZWhhdmlvcidcbl07XG5cbmZ1bmN0aW9uIGlzU3RhbmRhcmRDYXAgKGNhcCkge1xuICByZXR1cm4gISFfLmZpbmQoU1RBTkRBUkRfQ0FQUywgKHN0YW5kYXJkQ2FwKSA9PiBzdGFuZGFyZENhcC50b0xvd2VyQ2FzZSgpID09PSBgJHtjYXB9YC50b0xvd2VyQ2FzZSgpKTtcbn1cblxuLy8gSWYgdGhlICdhcHBpdW06JyBwcmVmaXggd2FzIHByb3ZpZGVkIGFuZCBpdCdzIGEgdmFsaWQgY2FwYWJpbGl0eSwgc3RyaXAgb3V0IHRoZSBwcmVmaXggKHNlZSBodHRwczovL3d3dy53My5vcmcvVFIvd2ViZHJpdmVyLyNkZm4tZXh0ZW5zaW9uLWNhcGFiaWxpdGllcylcbi8vIChOT1RFOiBNZXRob2QgaXMgZGVzdHJ1Y3RpdmUgYW5kIG11dGF0ZXMgY29udGVudHMgb2YgY2FwcylcbmZ1bmN0aW9uIHN0cmlwQXBwaXVtUHJlZml4ZXMgKGNhcHMpIHtcbiAgY29uc3QgcHJlZml4ID0gJ2FwcGl1bTonO1xuICBjb25zdCBwcmVmaXhlZENhcHMgPSBfLmZpbHRlcihfLmtleXMoY2FwcyksIGNhcCA9PiBgJHtjYXB9YC5zdGFydHNXaXRoKHByZWZpeCkpO1xuICBjb25zdCBiYWRQcmVmaXhlZENhcHMgPSBbXTtcblxuICAvLyBTdHJpcCBvdXQgdGhlICdhcHBpdW06JyBwcmVmaXhcbiAgZm9yIChsZXQgcHJlZml4ZWRDYXAgb2YgcHJlZml4ZWRDYXBzKSB7XG4gICAgY29uc3Qgc3RyaXBwZWRDYXBOYW1lID0gcHJlZml4ZWRDYXAuc3Vic3RyKHByZWZpeC5sZW5ndGgpO1xuXG4gICAgLy8gSWYgaXQncyBzdGFuZGFyZCBjYXBhYmlsaXR5IHRoYXQgd2FzIHByZWZpeGVkLCBhZGQgaXQgdG8gYW4gYXJyYXkgb2YgaW5jb3JyZWN0bHkgcHJlZml4ZWQgY2FwYWJpbGl0aWVzXG4gICAgaWYgKGlzU3RhbmRhcmRDYXAoc3RyaXBwZWRDYXBOYW1lKSkge1xuICAgICAgYmFkUHJlZml4ZWRDYXBzLnB1c2goc3RyaXBwZWRDYXBOYW1lKTtcbiAgICB9XG5cbiAgICAvLyBTdHJpcCBvdXQgdGhlIHByZWZpeFxuICAgIGNhcHNbc3RyaXBwZWRDYXBOYW1lXSA9IGNhcHNbcHJlZml4ZWRDYXBdO1xuICAgIGRlbGV0ZSBjYXBzW3ByZWZpeGVkQ2FwXTtcbiAgfVxuXG4gIC8vIElmIHdlIGZvdW5kIHN0YW5kYXJkIGNhcHMgdGhhdCB3ZXJlIGluY29ycmVjdGx5IHByZWZpeGVkLCB0aHJvdyBhbiBleGNlcHRpb24gKGUuZy46IGRvbid0IGFjY2VwdCAnYXBwaXVtOnBsYXRmb3JtTmFtZScsIG9ubHkgYWNjZXB0IGp1c3QgJ3BsYXRmb3JtTmFtZScpXG4gIGlmIChiYWRQcmVmaXhlZENhcHMubGVuZ3RoID4gMCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoYFRoZSBjYXBhYmlsaXRpZXMgJHtKU09OLnN0cmluZ2lmeShiYWRQcmVmaXhlZENhcHMpfSBhcmUgc3RhbmRhcmQgY2FwYWJpbGl0aWVzIGFuZCBzaG91bGQgbm90IGhhdmUgdGhlIFwiYXBwaXVtOlwiIHByZWZpeGApO1xuICB9XG59XG5cbi8qKlxuICogR2V0IGFuIGFycmF5IG9mIGFsbCB0aGUgdW5wcmVmaXhlZCBjYXBzIHRoYXQgYXJlIGJlaW5nIHVzZWQgaW4gJ2Fsd2F5c01hdGNoJyBhbmQgYWxsIG9mIHRoZSAnZmlyc3RNYXRjaCcgb2JqZWN0XG4gKiBAcGFyYW0ge09iamVjdH0gY2FwcyBBIGNhcGFiaWxpdGllcyBvYmplY3RcbiAqL1xuZnVuY3Rpb24gZmluZE5vblByZWZpeGVkQ2FwcyAoe2Fsd2F5c01hdGNoID0ge30sIGZpcnN0TWF0Y2ggPSBbXX0pIHtcbiAgcmV0dXJuIF8uY2hhaW4oW2Fsd2F5c01hdGNoLCAuLi5maXJzdE1hdGNoXSlcbiAgICAucmVkdWNlKCh1bnByZWZpeGVkQ2FwcywgY2FwcykgPT4gW1xuICAgICAgLi4udW5wcmVmaXhlZENhcHMsXG4gICAgICAuLi5fKGNhcHMpLmtleXMoKS5maWx0ZXIoKGNhcCkgPT4gIWNhcC5pbmNsdWRlcygnOicpICYmICFpc1N0YW5kYXJkQ2FwKGNhcCkpLFxuICAgIF0sIFtdKVxuICAgIC51bmlxKClcbiAgICAudmFsdWUoKTtcbn1cblxuLy8gUGFyc2UgY2FwYWJpbGl0aWVzIChiYXNlZCBvbiBodHRwczovL3d3dy53My5vcmcvVFIvd2ViZHJpdmVyLyNwcm9jZXNzaW5nLWNhcGFiaWxpdGllcylcbmZ1bmN0aW9uIHBhcnNlQ2FwcyAoY2FwcywgY29uc3RyYWludHMgPSB7fSwgc2hvdWxkVmFsaWRhdGVDYXBzID0gdHJ1ZSkge1xuICAvLyBJZiBjYXBhYmlsaXRpZXMgcmVxdWVzdCBpcyBub3QgYW4gb2JqZWN0LCByZXR1cm4gZXJyb3IgKCMxLjEpXG4gIGlmICghXy5pc1BsYWluT2JqZWN0KGNhcHMpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcignVGhlIGNhcGFiaWxpdGllcyBhcmd1bWVudCB3YXMgbm90IHZhbGlkIGZvciB0aGUgZm9sbG93aW5nIHJlYXNvbihzKTogXCJjYXBhYmlsaXRpZXNcIiBtdXN0IGJlIGEgSlNPTiBvYmplY3QuJyk7XG4gIH1cblxuICAvLyBMZXQgJ3JlcXVpcmVkQ2FwcycgYmUgcHJvcGVydHkgbmFtZWQgJ2Fsd2F5c01hdGNoJyBmcm9tIGNhcGFiaWxpdGllcyByZXF1ZXN0ICgjMikgYW5kICdhbGxGaXJzdE1hdGNoQ2FwcycgYmUgcHJvcGVydHkgbmFtZWQgJ2ZpcnN0TWF0Y2ggZnJvbSBjYXBhYmlsaXRpZXMgcmVxdWVzdCAoIzMpXG4gIGxldCB7XG4gICAgYWx3YXlzTWF0Y2g6IHJlcXVpcmVkQ2FwcyA9IHt9LCAvLyBJZiAncmVxdWlyZWRDYXBzJyBpcyB1bmRlZmluZWQsIHNldCBpdCB0byBhbiBlbXB0eSBKU09OIG9iamVjdCAoIzIuMSlcbiAgICBmaXJzdE1hdGNoOiBhbGxGaXJzdE1hdGNoQ2FwcyA9IFt7fV0sIC8vIElmICdmaXJzdE1hdGNoJyBpcyB1bmRlZmluZWQgc2V0IGl0IHRvIGEgc2luZ2xldG9uIGxpc3Qgd2l0aCBvbmUgZW1wdHkgb2JqZWN0ICgjMy4xKVxuICB9ID0gY2FwcztcblxuICAvLyBSZWplY3QgJ2ZpcnN0TWF0Y2gnIGFyZ3VtZW50IGlmIGl0J3Mgbm90IGFuIGFycmF5ICgjMy4yKVxuICBpZiAoIV8uaXNBcnJheShhbGxGaXJzdE1hdGNoQ2FwcykpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRBcmd1bWVudEVycm9yKCdUaGUgY2FwYWJpbGl0aWVzLmZpcnN0TWF0Y2ggYXJndW1lbnQgd2FzIG5vdCB2YWxpZCBmb3IgdGhlIGZvbGxvd2luZyByZWFzb24ocyk6IFwiY2FwYWJpbGl0aWVzLmZpcnN0TWF0Y2hcIiBtdXN0IGJlIGEgSlNPTiBhcnJheSBvciB1bmRlZmluZWQnKTtcbiAgfVxuXG4gIC8vIElmIGFuIGVtcHR5IGFycmF5IGFzIHByb3ZpZGVkLCB3ZSdsbCBiZSBmb3JnaXZpbmcgYW5kIG1ha2UgaXQgYW4gYXJyYXkgb2Ygb25lIGVtcHR5IG9iamVjdFxuICBpZiAoYWxsRmlyc3RNYXRjaENhcHMubGVuZ3RoID09PSAwKSB7XG4gICAgYWxsRmlyc3RNYXRjaENhcHMucHVzaCh7fSk7XG4gIH1cblxuICAvLyBDaGVjayBmb3Igbm9uLXByZWZpeGVkLCBub24tc3RhbmRhcmQgY2FwYWJpbGl0aWVzIGFuZCBsb2cgd2FybmluZ3MgaWYgdGhleSBhcmUgZm91bmRcbiAgbGV0IG5vblByZWZpeGVkQ2FwcyA9IGZpbmROb25QcmVmaXhlZENhcHMoY2Fwcyk7XG4gIGlmICghXy5pc0VtcHR5KG5vblByZWZpeGVkQ2FwcykpIHtcbiAgICBsb2cud2FybihgVGhlIGNhcGFiaWxpdGllcyAke0pTT04uc3RyaW5naWZ5KG5vblByZWZpeGVkQ2Fwcyl9IGFyZSBub3Qgc3RhbmRhcmQgY2FwYWJpbGl0aWVzIGFuZCBzaG91bGQgaGF2ZSBhbiBleHRlbnNpb24gcHJlZml4YCk7XG4gIH1cblxuICAvLyBTdHJpcCBvdXQgdGhlICdhcHBpdW06JyBwcmVmaXggZnJvbSBhbGxcbiAgc3RyaXBBcHBpdW1QcmVmaXhlcyhyZXF1aXJlZENhcHMpO1xuICBmb3IgKGxldCBmaXJzdE1hdGNoQ2FwcyBvZiBhbGxGaXJzdE1hdGNoQ2Fwcykge1xuICAgIHN0cmlwQXBwaXVtUHJlZml4ZXMoZmlyc3RNYXRjaENhcHMpO1xuICB9XG5cbiAgLy8gVmFsaWRhdGUgdGhlIHJlcXVpcmVkQ2Fwcy4gQnV0IGRvbid0IHZhbGlkYXRlICdwcmVzZW5jZScgYmVjYXVzZSBpZiB0aGF0IGNvbnN0cmFpbnQgZmFpbHMgb24gJ2Fsd2F5c01hdGNoJyBpdCBjb3VsZCBzdGlsbCBwYXNzIG9uIG9uZSBvZiB0aGUgJ2ZpcnN0TWF0Y2gnIGtleXNcbiAgaWYgKHNob3VsZFZhbGlkYXRlQ2Fwcykge1xuICAgIHJlcXVpcmVkQ2FwcyA9IHZhbGlkYXRlQ2FwcyhyZXF1aXJlZENhcHMsIGNvbnN0cmFpbnRzLCB7c2tpcFByZXNlbmNlQ29uc3RyYWludDogdHJ1ZX0pO1xuICB9XG5cblxuICAvLyBSZW1vdmUgdGhlICdwcmVzZW5jZScgY29uc3RyYWludCBmb3IgYW55IGtleXMgdGhhdCBhcmUgYWxyZWFkeSBwcmVzZW50IGluICdyZXF1aXJlZENhcHMnXG4gIC8vIHNpbmNlIHdlIGtub3cgdGhhdCB0aGlzIGNvbnN0cmFpbnQgaGFzIGFscmVhZHkgcGFzc2VkXG4gIGxldCBmaWx0ZXJlZENvbnN0cmFpbnRzID0gey4uLmNvbnN0cmFpbnRzfTtcbiAgbGV0IHJlcXVpcmVkQ2Fwc0tleXMgPSBfLmtleXMocmVxdWlyZWRDYXBzKTtcbiAgZm9yIChsZXQga2V5IG9mIF8ua2V5cyhmaWx0ZXJlZENvbnN0cmFpbnRzKSkge1xuICAgIGlmIChyZXF1aXJlZENhcHNLZXlzLmluY2x1ZGVzKGtleSkpIHtcbiAgICAgIGRlbGV0ZSBmaWx0ZXJlZENvbnN0cmFpbnRzW2tleV07XG4gICAgfVxuICB9XG5cbiAgLy8gVmFsaWRhdGUgYWxsIG9mIHRoZSBmaXJzdCBtYXRjaCBjYXBhYmlsaXRpZXMgYW5kIHJldHVybiBhbiBhcnJheSB3aXRoIG9ubHkgdGhlIHZhbGlkIGNhcHMgKHNlZSBzcGVjICM1KVxuICBsZXQgdmFsaWRhdGlvbkVycm9ycyA9IFtdO1xuICBsZXQgdmFsaWRhdGVkRmlyc3RNYXRjaENhcHMgPSBhbGxGaXJzdE1hdGNoQ2Fwcy5tYXAoKGZpcnN0TWF0Y2hDYXBzKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFZhbGlkYXRlIGZpcnN0TWF0Y2ggY2Fwc1xuICAgICAgcmV0dXJuIHNob3VsZFZhbGlkYXRlQ2FwcyA/IHZhbGlkYXRlQ2FwcyhmaXJzdE1hdGNoQ2FwcywgZmlsdGVyZWRDb25zdHJhaW50cykgOiBmaXJzdE1hdGNoQ2FwcztcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB2YWxpZGF0aW9uRXJyb3JzLnB1c2goZS5tZXNzYWdlKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfSkuZmlsdGVyKChjYXBzKSA9PiAhXy5pc051bGwoY2FwcykpO1xuXG4gIC8vIFRyeSB0byBtZXJnZSByZXF1aXJlZENhcHMgd2l0aCBmaXJzdCBtYXRjaCBjYXBhYmlsaXRpZXMsIGJyZWFrIG9uY2UgaXQgZmluZHMgaXRzIGZpcnN0IG1hdGNoIChzZWUgc3BlYyAjNilcbiAgbGV0IG1hdGNoZWRDYXBzID0gbnVsbDtcbiAgZm9yIChsZXQgZmlyc3RNYXRjaENhcHMgb2YgdmFsaWRhdGVkRmlyc3RNYXRjaENhcHMpIHtcbiAgICB0cnkge1xuICAgICAgbWF0Y2hlZENhcHMgPSBtZXJnZUNhcHMocmVxdWlyZWRDYXBzLCBmaXJzdE1hdGNoQ2Fwcyk7XG4gICAgICBpZiAobWF0Y2hlZENhcHMpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihlcnIubWVzc2FnZSk7XG4gICAgfVxuICB9XG5cbiAgLy8gUmV0dXJucyB2YXJpYWJsZXMgZm9yIHRlc3RpbmcgcHVycG9zZXNcbiAgcmV0dXJuIHtyZXF1aXJlZENhcHMsIGFsbEZpcnN0TWF0Y2hDYXBzLCB2YWxpZGF0ZWRGaXJzdE1hdGNoQ2FwcywgbWF0Y2hlZENhcHMsIHZhbGlkYXRpb25FcnJvcnN9O1xufVxuXG4vLyBDYWxscyBwYXJzZUNhcHMgYW5kIGp1c3QgcmV0dXJucyB0aGUgbWF0Y2hlZENhcHMgdmFyaWFibGVcbmZ1bmN0aW9uIHByb2Nlc3NDYXBhYmlsaXRpZXMgKGNhcHMsIGNvbnN0cmFpbnRzID0ge30sIHNob3VsZFZhbGlkYXRlQ2FwcyA9IHRydWUpIHtcbiAgY29uc3Qge21hdGNoZWRDYXBzLCB2YWxpZGF0aW9uRXJyb3JzfSA9IHBhcnNlQ2FwcyhjYXBzLCBjb25zdHJhaW50cywgc2hvdWxkVmFsaWRhdGVDYXBzKTtcblxuICAvLyBJZiB3ZSBmb3VuZCBhbiBlcnJvciB0aHJvdyBhbiBleGNlcHRpb25cbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKG1hdGNoZWRDYXBzKSkge1xuICAgIGlmIChfLmlzQXJyYXkoY2Fwcy5maXJzdE1hdGNoKSAmJiBjYXBzLmZpcnN0TWF0Y2gubGVuZ3RoID4gMSkge1xuICAgICAgLy8gSWYgdGhlcmUgd2FzIG1vcmUgdGhhbiBvbmUgJ2ZpcnN0TWF0Y2gnIGNhcCwgaW5kaWNhdGUgdGhhdCB3ZSBjb3VsZG4ndCBmaW5kIGEgbWF0Y2hpbmcgY2FwYWJpbGl0aWVzIHNldCBhbmQgc2hvdyBhbGwgdGhlIGVycm9yc1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcihgQ291bGQgbm90IGZpbmQgbWF0Y2hpbmcgY2FwYWJpbGl0aWVzIGZyb20gJHtKU09OLnN0cmluZ2lmeShjYXBzKX06XFxuICR7dmFsaWRhdGlvbkVycm9ycy5qb2luKCdcXG4nKX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gT3RoZXJ3aXNlLCBqdXN0IHNob3cgdGhlIHNpbmd1bGFyIGVycm9yIG1lc3NhZ2VcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IodmFsaWRhdGlvbkVycm9yc1swXSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1hdGNoZWRDYXBzO1xufVxuXG5cbmV4cG9ydCB7IHBhcnNlQ2FwcywgcHJvY2Vzc0NhcGFiaWxpdGllcywgdmFsaWRhdGVDYXBzLCBtZXJnZUNhcHMsIGZpbmROb25QcmVmaXhlZENhcHMgfTtcbiJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvY2FwYWJpbGl0aWVzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
