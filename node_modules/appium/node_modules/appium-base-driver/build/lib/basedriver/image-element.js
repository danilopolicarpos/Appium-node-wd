"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getImgElFromArgs = getImgElFromArgs;
exports.makeImageElementCache = makeImageElementCache;
exports.DEFAULT_TEMPLATE_IMAGE_SCALE = exports.IMAGE_EL_TAP_STRATEGY_W3C = exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = exports.ImageElement = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../..");

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _protocol = require("../protocol/protocol");

var _logger = _interopRequireDefault(require("./logger"));

var _uuidJs = _interopRequireDefault(require("uuid-js"));

const MAX_CACHE_SIZE = 1024 * 1024 * 40;
const TAP_DURATION_MS = 125;
const IMAGE_EL_TAP_STRATEGY_W3C = 'w3cActions';
exports.IMAGE_EL_TAP_STRATEGY_W3C = IMAGE_EL_TAP_STRATEGY_W3C;
const IMAGE_EL_TAP_STRATEGY_MJSONWP = 'touchActions';
exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = IMAGE_EL_TAP_STRATEGY_MJSONWP;
const IMAGE_TAP_STRATEGIES = [IMAGE_EL_TAP_STRATEGY_MJSONWP, IMAGE_EL_TAP_STRATEGY_W3C];
const DEFAULT_TEMPLATE_IMAGE_SCALE = 1.0;
exports.DEFAULT_TEMPLATE_IMAGE_SCALE = DEFAULT_TEMPLATE_IMAGE_SCALE;

class ImageElement {
  constructor(b64Template, rect) {
    this.template = b64Template;
    this.rect = rect;
    this.id = `${_protocol.IMAGE_ELEMENT_PREFIX}${_uuidJs.default.create().hex}`;
  }

  get size() {
    return {
      width: this.rect.width,
      height: this.rect.height
    };
  }

  get location() {
    return {
      x: this.rect.x,
      y: this.rect.y
    };
  }

  get center() {
    return {
      x: this.rect.x + this.rect.width / 2,
      y: this.rect.y + this.rect.height / 2
    };
  }

  asElement(protocolKey) {
    return {
      [protocolKey]: this.id
    };
  }

  equals(other) {
    return this.rect.x === other.rect.x && this.rect.y === other.rect.y && this.rect.width === other.rect.width && this.rect.height === other.rect.height;
  }

  async click(driver) {
    let newImgEl;
    const {
      autoUpdateImageElementPosition: updatePos,
      checkForImageElementStaleness,
      imageElementTapStrategy
    } = driver.settings.getSettings();

    if (!IMAGE_TAP_STRATEGIES.includes(imageElementTapStrategy)) {
      throw new Error(`Incorrect imageElementTapStrategy setting ` + `'${imageElementTapStrategy}'. Must be one of ` + JSON.stringify(IMAGE_TAP_STRATEGIES));
    }

    if (checkForImageElementStaleness || updatePos) {
      _logger.default.info('Checking image element for staleness before clicking');

      try {
        newImgEl = await driver.findByImage(this.template, {
          shouldCheckStaleness: true,
          ignoreDefaultImageTemplateScale: true
        });
      } catch (err) {
        throw new _2.errors.StaleElementReferenceError();
      }

      if (!this.equals(newImgEl)) {
        _logger.default.warn(`When trying to click on an image element, the image changed ` + `position from where it was originally found. It is now at ` + `${JSON.stringify(newImgEl.rect)} and was originally at ` + `${JSON.stringify(this.rect)}.`);

        if (updatePos) {
          _logger.default.warn('Click will proceed at new coordinates');

          this.rect = _lodash.default.clone(newImgEl.rect);
        } else {
          _logger.default.warn('Click will take place at original coordinates. If you ' + 'would like Appium to automatically click the new ' + "coordinates, set the 'autoUpdateImageElementPosition' " + 'setting to true');
        }
      }
    }

    const {
      x,
      y
    } = this.center;

    _logger.default.info(`Will tap on image element at coordinate [${x}, ${y}]`);

    if (imageElementTapStrategy === IMAGE_EL_TAP_STRATEGY_W3C) {
      _logger.default.info('Will tap using W3C actions');

      const action = {
        type: 'pointer',
        id: 'mouse',
        parameters: {
          pointerType: 'touch'
        },
        actions: [{
          type: 'pointerMove',
          x,
          y,
          duration: 0
        }, {
          type: 'pointerDown'
        }, {
          type: 'pause',
          duration: TAP_DURATION_MS
        }, {
          type: 'pointerUp'
        }]
      };

      if (driver.performActions) {
        return await driver.performActions([action]);
      }

      _logger.default.warn('Driver does not seem to implement W3C actions, falling back ' + 'to TouchActions');
    }

    _logger.default.info('Will tap using MJSONWP TouchActions');

    const action = {
      action: 'tap',
      options: {
        x,
        y
      }
    };

    if (driver.performTouch) {
      return await driver.performTouch([action]);
    }

    throw new Error("Driver did not implement the 'performTouch' command. " + 'For drivers to support finding image elements, they ' + "should support 'performTouch' and 'performActions'");
  }

  static async execute(driver, cmd, imgElId) {
    if (!driver._imgElCache.has(imgElId)) {
      throw new _2.errors.NoSuchElementError();
    }

    const imgEl = driver._imgElCache.get(imgElId);

    switch (cmd) {
      case 'click':
        return await imgEl.click(driver);

      case 'elementDisplayed':
        return true;

      case 'getSize':
        return imgEl.size;

      case 'getLocation':
      case 'getLocationInView':
        return imgEl.location;

      case 'getElementRect':
        return imgEl.rect;

      default:
        throw new _2.errors.NotYetImplementedError();
    }
  }

}

exports.ImageElement = ImageElement;

function makeImageElementCache(max = MAX_CACHE_SIZE) {
  return new _lruCache.default({
    max,
    length: el => el.template.length
  });
}

function getImgElFromArgs(args) {
  for (let arg of args) {
    if (_lodash.default.isString(arg) && arg.startsWith(_protocol.IMAGE_ELEMENT_PREFIX)) {
      return arg;
    }
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2ltYWdlLWVsZW1lbnQuanMiXSwibmFtZXMiOlsiTUFYX0NBQ0hFX1NJWkUiLCJUQVBfRFVSQVRJT05fTVMiLCJJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDIiwiSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AiLCJJTUFHRV9UQVBfU1RSQVRFR0lFUyIsIkRFRkFVTFRfVEVNUExBVEVfSU1BR0VfU0NBTEUiLCJJbWFnZUVsZW1lbnQiLCJjb25zdHJ1Y3RvciIsImI2NFRlbXBsYXRlIiwicmVjdCIsInRlbXBsYXRlIiwiaWQiLCJJTUFHRV9FTEVNRU5UX1BSRUZJWCIsIlVVSUQiLCJjcmVhdGUiLCJoZXgiLCJzaXplIiwid2lkdGgiLCJoZWlnaHQiLCJsb2NhdGlvbiIsIngiLCJ5IiwiY2VudGVyIiwiYXNFbGVtZW50IiwicHJvdG9jb2xLZXkiLCJlcXVhbHMiLCJvdGhlciIsImNsaWNrIiwiZHJpdmVyIiwibmV3SW1nRWwiLCJhdXRvVXBkYXRlSW1hZ2VFbGVtZW50UG9zaXRpb24iLCJ1cGRhdGVQb3MiLCJjaGVja0ZvckltYWdlRWxlbWVudFN0YWxlbmVzcyIsImltYWdlRWxlbWVudFRhcFN0cmF0ZWd5Iiwic2V0dGluZ3MiLCJnZXRTZXR0aW5ncyIsImluY2x1ZGVzIiwiRXJyb3IiLCJKU09OIiwic3RyaW5naWZ5IiwibG9nIiwiaW5mbyIsImZpbmRCeUltYWdlIiwic2hvdWxkQ2hlY2tTdGFsZW5lc3MiLCJpZ25vcmVEZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlIiwiZXJyIiwiZXJyb3JzIiwiU3RhbGVFbGVtZW50UmVmZXJlbmNlRXJyb3IiLCJ3YXJuIiwiXyIsImNsb25lIiwiYWN0aW9uIiwidHlwZSIsInBhcmFtZXRlcnMiLCJwb2ludGVyVHlwZSIsImFjdGlvbnMiLCJkdXJhdGlvbiIsInBlcmZvcm1BY3Rpb25zIiwib3B0aW9ucyIsInBlcmZvcm1Ub3VjaCIsImV4ZWN1dGUiLCJjbWQiLCJpbWdFbElkIiwiX2ltZ0VsQ2FjaGUiLCJoYXMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJpbWdFbCIsImdldCIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJtYWtlSW1hZ2VFbGVtZW50Q2FjaGUiLCJtYXgiLCJMUlUiLCJsZW5ndGgiLCJlbCIsImdldEltZ0VsRnJvbUFyZ3MiLCJhcmdzIiwiYXJnIiwiaXNTdHJpbmciLCJzdGFydHNXaXRoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsY0FBYyxHQUFHLE9BQU8sSUFBUCxHQUFjLEVBQXJDO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLEdBQXhCO0FBQ0EsTUFBTUMseUJBQXlCLEdBQUcsWUFBbEM7O0FBQ0EsTUFBTUMsNkJBQTZCLEdBQUcsY0FBdEM7O0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUcsQ0FDM0JELDZCQUQyQixFQUUzQkQseUJBRjJCLENBQTdCO0FBSUEsTUFBTUcsNEJBQTRCLEdBQUcsR0FBckM7OztBQTBCQSxNQUFNQyxZQUFOLENBQW1CO0FBU2pCQyxFQUFBQSxXQUFXLENBQUVDLFdBQUYsRUFBZUMsSUFBZixFQUFxQjtBQUM5QixTQUFLQyxRQUFMLEdBQWdCRixXQUFoQjtBQUNBLFNBQUtDLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtFLEVBQUwsR0FBVyxHQUFFQyw4QkFBcUIsR0FBRUMsZ0JBQUtDLE1BQUwsR0FBY0MsR0FBSSxFQUF0RDtBQUNEOztBQUtELE1BQUlDLElBQUosR0FBWTtBQUNWLFdBQU87QUFBQ0MsTUFBQUEsS0FBSyxFQUFFLEtBQUtSLElBQUwsQ0FBVVEsS0FBbEI7QUFBeUJDLE1BQUFBLE1BQU0sRUFBRSxLQUFLVCxJQUFMLENBQVVTO0FBQTNDLEtBQVA7QUFDRDs7QUFLRCxNQUFJQyxRQUFKLEdBQWdCO0FBQ2QsV0FBTztBQUFDQyxNQUFBQSxDQUFDLEVBQUUsS0FBS1gsSUFBTCxDQUFVVyxDQUFkO0FBQWlCQyxNQUFBQSxDQUFDLEVBQUUsS0FBS1os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QUFHLENBQUNFLFVBQUosQ0FBZWxFLDhCQUFmLENBQXZCLEVBQTZEO0FBQzNELGFBQU9nRSxHQUFQO0FBQ0Q7QUFDRjtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJy4uLy4uJztcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcbmltcG9ydCB7IElNQUdFX0VMRU1FTlRfUFJFRklYIH0gZnJvbSAnLi4vcHJvdG9jb2wvcHJvdG9jb2wnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgVVVJRCBmcm9tICd1dWlkLWpzJztcblxuY29uc3QgTUFYX0NBQ0hFX1NJWkUgPSAxMDI0ICogMTAyNCAqIDQwOyAvLyA0MG1iXG5jb25zdCBUQVBfRFVSQVRJT05fTVMgPSAxMjU7XG5jb25zdCBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDID0gJ3czY0FjdGlvbnMnO1xuY29uc3QgSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AgPSAndG91Y2hBY3Rpb25zJztcbmNvbnN0IElNQUdFX1RBUF9TVFJBVEVHSUVTID0gW1xuICBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfTUpTT05XUCxcbiAgSU1BR0VfRUxfVEFQX1NUUkFURUdZX1czQ1xuXTtcbmNvbnN0IERFRkFVTFRfVEVNUExBVEVfSU1BR0VfU0NBTEUgPSAxLjA7XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUmVjdFxuICogQHByb3BlcnR5IHtpbnR9IHggLSB4LWNvb3JkaW5hdGUgb2YgdG9wLWxlZnQgY29ybmVyXG4gKiBAcHJvcGVydHkge2ludH0geSAtIHktY29vcmRpbmF0ZSBvZiB0b3AtbGVmdCBjb3JuZXJcbiAqIEBwcm9wZXJ0eSB7aW50fSB3aWR0aCAtIHdpZHRoIG9mIHJlY3RcbiAqIEBwcm9wZXJ0eSB7aW50fSBoZWlnaHQgLSBoZWlnaHQgb2YgcmVjdFxuICovXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gRGltZW5zaW9uXG4gKiBAcHJvcGVydHkge2ludH0gd2lkdGggLSB3aWR0aCBvZiByZWN0XG4gKiBAcHJvcGVydHkge2ludH0gaGVpZ2h0IC0gaGVpZ2h0IG9mIHJlY3RcbiAqL1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFBvc2l0aW9uXG4gKiBAcHJvcGVydHkge2ludH0geCAtIHggY29vcmRpbmF0ZVxuICogQHByb3BlcnR5IHtpbnR9IHkgLSB5IGNvb3JkaW5hdGVcbiAqL1xuXG4vKipcbiAqIFJlcHJlc2VudGF0aW9uIG9mIGFuIFwiaW1hZ2UgZWxlbWVudFwiLCB3aGljaCBpcyBzaW1wbHkgYSBzZXQgb2YgY29vcmRpbmF0ZXNcbiAqIGFuZCBtZXRob2RzIHRoYXQgY2FuIGJlIHVzZWQgb24gdGhhdCBzZXQgb2YgY29vcmRpbmF0ZXMgdmlhIHRoZSBkcml2ZXJcbiAqL1xuY2xhc3MgSW1hZ2VFbGVtZW50IHtcblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGI2NFRlbXBsYXRlIC0gdGhlIGJhc2U2NC1lbmNvZGVkIGltYWdlIHdoaWNoIHdhcyB1c2VkIHRvXG4gICAqIGZpbmQgdGhpcyBJbWFnZUVsZW1lbnRcbiAgICogQHBhcmFtIHtSZWN0fSByZWN0IC0gYm91bmRzIG9mIG1hdGNoZWQgaW1hZ2UgZWxlbWVudFxuICAgKlxuICAgKiBAcmV0dXJucyB7SW1hZ2VFbGVtZW50fVxuICAgKi9cbiAgY29uc3RydWN0b3IgKGI2NFRlbXBsYXRlLCByZWN0KSB7XG4gICAgdGhpcy50ZW1wbGF0ZSA9IGI2NFRlbXBsYXRlO1xuICAgIHRoaXMucmVjdCA9IHJlY3Q7XG4gICAgdGhpcy5pZCA9IGAke0lNQUdFX0VMRU1FTlRfUFJFRklYfSR7VVVJRC5jcmVhdGUoKS5oZXh9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7RGltZW5zaW9ufSAtIGRpbWVuc2lvbiBvZiBlbGVtZW50XG4gICAqL1xuICBnZXQgc2l6ZSAoKSB7XG4gICAgcmV0dXJuIHt3aWR0aDogdGhpcy5yZWN0LndpZHRoLCBoZWlnaHQ6IHRoaXMucmVjdC5oZWlnaHR9O1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtQb3NpdGlvbn0gLSBjb29yZGluYXRlcyBvZiB0b3AtbGVmdCBjb3JuZXIgb2YgZWxlbWVudFxuICAgKi9cbiAgZ2V0IGxvY2F0aW9uICgpIHtcbiAgICByZXR1cm4ge3g6IHRoaXMucmVjdC54LCB5OiB0aGlzLnJlY3QueX07XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge1Bvc2l0aW9ufSAtIGNvb3JkaW5hdGVzIG9mIGNlbnRlciBvZiBlbGVtZW50XG4gICAqL1xuICBnZXQgY2VudGVyICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgeDogdGhpcy5yZWN0LnggKyB0aGlzLnJlY3Qud2lkdGggLyAyLFxuICAgICAgeTogdGhpcy5yZWN0LnkgKyB0aGlzLnJlY3QuaGVpZ2h0IC8gMixcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwcm90b2NvbEtleSAtIHRoZSBwcm90b2NvbC1zcGVjaWZpYyBKU09OIGtleSBmb3JcbiAgICogYSBXZWJFbGVtZW50XG4gICAqXG4gICAqIEByZXR1cm5zIHtXZWJFbGVtZW50fSAtIHRoaXMgaW1hZ2UgZWxlbWVudCBhcyBhIFdlYkVsZW1lbnRcbiAgICovXG4gIGFzRWxlbWVudCAocHJvdG9jb2xLZXkpIHtcbiAgICByZXR1cm4ge1twcm90b2NvbEtleV06IHRoaXMuaWR9O1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7SW1hZ2VFbGVtZW50fSBvdGhlciAtIGFuIEltYWdlRWxlbWVudCB0byBjb21wYXJlIHdpdGggdGhpcyBvbmVcbiAgICpcbiAgICogQHJldHVybnMge2Jvb2xlYW59IC0gd2hldGhlciB0aGUgb3RoZXIgZWxlbWVudCBhbmQgdGhpcyBvbmUgaGF2ZSB0aGUgc2FtZVxuICAgKiBwcm9wZXJ0aWVzXG4gICAqL1xuICBlcXVhbHMgKG90aGVyKSB7XG4gICAgcmV0dXJuIHRoaXMucmVjdC54ID09PSBvdGhlci5yZWN0LnggJiZcbiAgICAgICAgICAgdGhpcy5yZWN0LnkgPT09IG90aGVyLnJlY3QueSAmJlxuICAgICAgICAgICB0aGlzLnJlY3Qud2lkdGggPT09IG90aGVyLnJlY3Qud2lkdGggJiZcbiAgICAgICAgICAgdGhpcy5yZWN0LmhlaWdodCA9PT0gb3RoZXIucmVjdC5oZWlnaHQ7XG4gIH1cblxuICAvKipcbiAgICogVXNlIGEgZHJpdmVyIHRvIHRhcCB0aGUgc2NyZWVuIGF0IHRoZSBjZW50ZXIgb2YgdGhpcyBJbWFnZUVsZW1lbnQnc1xuICAgKiBwb3NpdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge0Jhc2VEcml2ZXJ9IGRyaXZlciAtIGRyaXZlciBmb3IgY2FsbGluZyBhY3Rpb25zIHdpdGhcbiAgICovXG4gIGFzeW5jIGNsaWNrIChkcml2ZXIpIHtcbiAgICAvLyBiZWZvcmUgd2UgY2xpY2sgd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIGVsZW1lbnQgaXMgYWN0dWFsbHkgc3RpbGwgdGhlcmVcbiAgICAvLyB3aGVyZSB3ZSBleHBlY3QgaXQgdG8gYmVcbiAgICBsZXQgbmV3SW1nRWw7XG4gICAgY29uc3Qge1xuICAgICAgYXV0b1VwZGF0ZUltYWdlRWxlbWVudFBvc2l0aW9uOiB1cGRhdGVQb3MsXG4gICAgICBjaGVja0ZvckltYWdlRWxlbWVudFN0YWxlbmVzcyxcbiAgICAgIGltYWdlRWxlbWVudFRhcFN0cmF0ZWd5LFxuICAgIH0gPSBkcml2ZXIuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKTtcblxuICAgIC8vIHZhbGlkYXRlIHRhcCBzdHJhdGVneVxuICAgIGlmICghSU1BR0VfVEFQX1NUUkFURUdJRVMuaW5jbHVkZXMoaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3kpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEluY29ycmVjdCBpbWFnZUVsZW1lbnRUYXBTdHJhdGVneSBzZXR0aW5nIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtpbWFnZUVsZW1lbnRUYXBTdHJhdGVneX0nLiBNdXN0IGJlIG9uZSBvZiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShJTUFHRV9UQVBfU1RSQVRFR0lFUykpO1xuICAgIH1cblxuICAgIGlmIChjaGVja0ZvckltYWdlRWxlbWVudFN0YWxlbmVzcyB8fCB1cGRhdGVQb3MpIHtcbiAgICAgIGxvZy5pbmZvKCdDaGVja2luZyBpbWFnZSBlbGVtZW50IGZvciBzdGFsZW5lc3MgYmVmb3JlIGNsaWNraW5nJyk7XG4gICAgICB0cnkge1xuICAgICAgICBuZXdJbWdFbCA9IGF3YWl0IGRyaXZlci5maW5kQnlJbWFnZSh0aGlzLnRlbXBsYXRlLCB7XG4gICAgICAgICAgc2hvdWxkQ2hlY2tTdGFsZW5lc3M6IHRydWUsXG4gICAgICAgICAgLy8gU2V0IGlnbm9yZURlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgYmVjYXVzZSB0aGlzLnRlbXBsYXRlIGlzIGRldmljZSBzY3JlZW5zaG90IGJhc2VkIGltYWdlXG4gICAgICAgICAgLy8gbWFuYWdlZCBpbnNpZGUgQXBwaXVtIGFmdGVyIGZpbmlkbmcgaW1hZ2UgYnkgdGVtcGxhdGUgd2hpY2ggbWFuYWdlZCBieSBhIHVzZXJcbiAgICAgICAgICBpZ25vcmVEZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuU3RhbGVFbGVtZW50UmVmZXJlbmNlRXJyb3IoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCF0aGlzLmVxdWFscyhuZXdJbWdFbCkpIHtcbiAgICAgICAgbG9nLndhcm4oYFdoZW4gdHJ5aW5nIHRvIGNsaWNrIG9uIGFuIGltYWdlIGVsZW1lbnQsIHRoZSBpbWFnZSBjaGFuZ2VkIGAgK1xuICAgICAgICAgICAgICAgICBgcG9zaXRpb24gZnJvbSB3aGVyZSBpdCB3YXMgb3JpZ2luYWxseSBmb3VuZC4gSXQgaXMgbm93IGF0IGAgK1xuICAgICAgICAgICAgICAgICBgJHtKU09OLnN0cmluZ2lmeShuZXdJbWdFbC5yZWN0KX0gYW5kIHdhcyBvcmlnaW5hbGx5IGF0IGAgK1xuICAgICAgICAgICAgICAgICBgJHtKU09OLnN0cmluZ2lmeSh0aGlzLnJlY3QpfS5gKTtcbiAgICAgICAgaWYgKHVwZGF0ZVBvcykge1xuICAgICAgICAgIGxvZy53YXJuKCdDbGljayB3aWxsIHByb2NlZWQgYXQgbmV3IGNvb3JkaW5hdGVzJyk7XG4gICAgICAgICAgdGhpcy5yZWN0ID0gXy5jbG9uZShuZXdJbWdFbC5yZWN0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsb2cud2FybignQ2xpY2sgd2lsbCB0YWtlIHBsYWNlIGF0IG9yaWdpbmFsIGNvb3JkaW5hdGVzLiBJZiB5b3UgJyArXG4gICAgICAgICAgICAgICAgICAgJ3dvdWxkIGxpa2UgQXBwaXVtIHRvIGF1dG9tYXRpY2FsbHkgY2xpY2sgdGhlIG5ldyAnICtcbiAgICAgICAgICAgICAgICAgICBcImNvb3JkaW5hdGVzLCBzZXQgdGhlICdhdXRvVXBkYXRlSW1hZ2VFbGVtZW50UG9zaXRpb24nIFwiICtcbiAgICAgICAgICAgICAgICAgICAnc2V0dGluZyB0byB0cnVlJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB7eCwgeX0gPSB0aGlzLmNlbnRlcjtcbiAgICBsb2cuaW5mbyhgV2lsbCB0YXAgb24gaW1hZ2UgZWxlbWVudCBhdCBjb29yZGluYXRlIFske3h9LCAke3l9XWApO1xuXG4gICAgaWYgKGltYWdlRWxlbWVudFRhcFN0cmF0ZWd5ID09PSBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDKSB7XG4gICAgICAvLyBzZXQgdXAgYSBXM0MgYWN0aW9uIHRvIGNsaWNrIG9uIHRoZSBpbWFnZSBieSBwb3NpdGlvblxuICAgICAgbG9nLmluZm8oJ1dpbGwgdGFwIHVzaW5nIFczQyBhY3Rpb25zJyk7XG4gICAgICBjb25zdCBhY3Rpb24gPSB7XG4gICAgICAgIHR5cGU6ICdwb2ludGVyJyxcbiAgICAgICAgaWQ6ICdtb3VzZScsXG4gICAgICAgIHBhcmFtZXRlcnM6IHtwb2ludGVyVHlwZTogJ3RvdWNoJ30sXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICB7dHlwZTogJ3BvaW50ZXJNb3ZlJywgeCwgeSwgZHVyYXRpb246IDB9LFxuICAgICAgICAgIHt0eXBlOiAncG9pbnRlckRvd24nfSxcbiAgICAgICAgICB7dHlwZTogJ3BhdXNlJywgZHVyYXRpb246IFRBUF9EVVJBVElPTl9NU30sXG4gICAgICAgICAge3R5cGU6ICdwb2ludGVyVXAnfSxcbiAgICAgICAgXVxuICAgICAgfTtcblxuICAgICAgLy8gY2hlY2sgaWYgdGhlIGRyaXZlciBoYXMgdGhlIGFwcHJvcHJpYXRlIHBlcmZvcm1BY3Rpb25zIG1ldGhvZFxuICAgICAgaWYgKGRyaXZlci5wZXJmb3JtQWN0aW9ucykge1xuICAgICAgICByZXR1cm4gYXdhaXQgZHJpdmVyLnBlcmZvcm1BY3Rpb25zKFthY3Rpb25dKTtcbiAgICAgIH1cblxuICAgICAgLy8gaWYgbm90LCB3YXJuIGFuZCBmYWxsIGJhY2sgdG8gdGhlIG90aGVyIG1ldGhvZFxuICAgICAgbG9nLndhcm4oJ0RyaXZlciBkb2VzIG5vdCBzZWVtIHRvIGltcGxlbWVudCBXM0MgYWN0aW9ucywgZmFsbGluZyBiYWNrICcgK1xuICAgICAgICAgICAgICAgJ3RvIFRvdWNoQWN0aW9ucycpO1xuICAgIH1cblxuICAgIC8vIGlmIHRoZSB3M2Mgc3RyYXRlZ3kgd2FzIG5vdCByZXF1ZXN0ZWQsIGRvIHRoZSBvbmx5IG90aGVyIG9wdGlvbiAobWpzb253cFxuICAgIC8vIHRvdWNoIGFjdGlvbnMpXG4gICAgbG9nLmluZm8oJ1dpbGwgdGFwIHVzaW5nIE1KU09OV1AgVG91Y2hBY3Rpb25zJyk7XG4gICAgY29uc3QgYWN0aW9uID0ge1xuICAgICAgYWN0aW9uOiAndGFwJyxcbiAgICAgIG9wdGlvbnM6IHt4LCB5fVxuICAgIH07XG5cbiAgICBpZiAoZHJpdmVyLnBlcmZvcm1Ub3VjaCkge1xuICAgICAgcmV0dXJuIGF3YWl0IGRyaXZlci5wZXJmb3JtVG91Y2goW2FjdGlvbl0pO1xuICAgIH1cblxuICAgIHRocm93IG5ldyBFcnJvcihcIkRyaXZlciBkaWQgbm90IGltcGxlbWVudCB0aGUgJ3BlcmZvcm1Ub3VjaCcgY29tbWFuZC4gXCIgK1xuICAgICAgICAgICAgICAgICAgICAnRm9yIGRyaXZlcnMgdG8gc3VwcG9ydCBmaW5kaW5nIGltYWdlIGVsZW1lbnRzLCB0aGV5ICcgK1xuICAgICAgICAgICAgICAgICAgICBcInNob3VsZCBzdXBwb3J0ICdwZXJmb3JtVG91Y2gnIGFuZCAncGVyZm9ybUFjdGlvbnMnXCIpO1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSB2YXJpb3VzIEFwcGl1bSBjb21tYW5kcyB0aGF0IGludm9sdmUgYW4gaW1hZ2UgZWxlbWVudFxuICAgKlxuICAgKiBAcGFyYW0ge0Jhc2VEcml2ZXJ9IGRyaXZlciAtIHRoZSBkcml2ZXIgdG8gdXNlIGZvciBjb21tYW5kc1xuICAgKiBAcGFyYW0ge3N0cmluZ30gY21kIC0gdGhlIG5hbWUgb2YgdGhlIGRyaXZlciBjb21tYW5kXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBpbWdFbElkIC0gdGhlIGlkIG9mIHRoZSBJbWFnZUVsZW1lbnQgdG8gd29yayB3aXRoXG4gICAqXG4gICAqIEByZXR1cm5zIHtPYmplY3R9IC0gdGhlIHJlc3VsdCBvZiBydW5uaW5nIGEgY29tbWFuZFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGV4ZWN1dGUgKGRyaXZlciwgY21kLCBpbWdFbElkKSB7XG4gICAgaWYgKCFkcml2ZXIuX2ltZ0VsQ2FjaGUuaGFzKGltZ0VsSWQpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cblxuICAgIGNvbnN0IGltZ0VsID0gZHJpdmVyLl9pbWdFbENhY2hlLmdldChpbWdFbElkKTtcblxuICAgIHN3aXRjaCAoY21kKSB7XG4gICAgICBjYXNlICdjbGljayc6XG4gICAgICAgIHJldHVybiBhd2FpdCBpbWdFbC5jbGljayhkcml2ZXIpO1xuICAgICAgY2FzZSAnZWxlbWVudERpc3BsYXllZCc6XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgY2FzZSAnZ2V0U2l6ZSc6XG4gICAgICAgIHJldHVybiBpbWdFbC5zaXplO1xuICAgICAgY2FzZSAnZ2V0TG9jYXRpb24nOlxuICAgICAgY2FzZSAnZ2V0TG9jYXRpb25JblZpZXcnOlxuICAgICAgICByZXR1cm4gaW1nRWwubG9jYXRpb247XG4gICAgICBjYXNlICdnZXRFbGVtZW50UmVjdCc6XG4gICAgICAgIHJldHVybiBpbWdFbC5yZWN0O1xuICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIG1ha2VJbWFnZUVsZW1lbnRDYWNoZSAobWF4ID0gTUFYX0NBQ0hFX1NJWkUpIHtcbiAgcmV0dXJuIG5ldyBMUlUoe1xuICAgIG1heCxcbiAgICBsZW5ndGg6IChlbCkgPT4gZWwudGVtcGxhdGUubGVuZ3RoLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0SW1nRWxGcm9tQXJncyAoYXJncykge1xuICBmb3IgKGxldCBhcmcgb2YgYXJncykge1xuICAgIGlmIChfLmlzU3RyaW5nKGFyZykgJiYgYXJnLnN0YXJ0c1dpdGgoSU1BR0VfRUxFTUVOVF9QUkVGSVgpKSB7XG4gICAgICByZXR1cm4gYXJnO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQge1xuICBJbWFnZUVsZW1lbnQsIGdldEltZ0VsRnJvbUFyZ3MsIG1ha2VJbWFnZUVsZW1lbnRDYWNoZSxcbiAgSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AsIElNQUdFX0VMX1RBUF9TVFJBVEVHWV9XM0MsXG4gIERFRkFVTFRfVEVNUExBVEVfSU1BR0VfU0NBTEVcbn07XG4iXSwiZmlsZSI6ImxpYi9iYXNlZHJpdmVyL2ltYWdlLWVsZW1lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
