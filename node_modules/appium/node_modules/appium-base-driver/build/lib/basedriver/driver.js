"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.BaseDriver = void 0;

require("source-map-support/register");

var _protocol = require("../protocol");

var _os = _interopRequireDefault(require("os"));

var _commands = _interopRequireDefault(require("./commands"));

var helpers = _interopRequireWildcard(require("./helpers"));

var _logger = _interopRequireDefault(require("./logger"));

var _deviceSettings = _interopRequireDefault(require("./device-settings"));

var _desiredCaps = require("./desired-caps");

var _capabilities = require("./capabilities");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _imageElement = require("./image-element");

var _protocol2 = require("../protocol/protocol");

_bluebird.default.config({
  cancellation: true
});

const NEW_COMMAND_TIMEOUT_MS = 60 * 1000;
const EVENT_SESSION_INIT = 'newSessionRequested';
const EVENT_SESSION_START = 'newSessionStarted';
const EVENT_SESSION_QUIT_START = 'quitSessionRequested';
const EVENT_SESSION_QUIT_DONE = 'quitSessionFinished';

class BaseDriver extends _protocol.Protocol {
  constructor(opts = {}, shouldValidateCaps = true) {
    super();
    this.sessionId = null;
    this.opts = opts;
    this.caps = null;
    this.helpers = helpers;
    this.newCommandTimeoutMs = NEW_COMMAND_TIMEOUT_MS;
    this.implicitWaitMs = 0;
    this._constraints = _lodash.default.cloneDeep(_desiredCaps.desiredCapabilityConstraints);
    this.locatorStrategies = [];
    this.webLocatorStrategies = [];
    this.opts.tmpDir = this.opts.tmpDir || process.env.APPIUM_TMP_DIR || _os.default.tmpdir();
    this.curCommand = _bluebird.default.resolve();
    this.curCommandCancellable = _bluebird.default.resolve();
    this.shutdownUnexpectedly = false;
    this.noCommandTimer = null;
    this.shouldValidateCaps = shouldValidateCaps;
    this.settings = new _deviceSettings.default({}, _lodash.default.noop);
    this.resetOnUnexpectedShutdown();
    this.initialOpts = _lodash.default.cloneDeep(this.opts);
    this.managedDrivers = [];
    this._eventHistory = {
      commands: []
    };
    this._imgElCache = (0, _imageElement.makeImageElementCache)();
    this.protocol = null;
  }

  get driverData() {
    return {};
  }

  get isCommandsQueueEnabled() {
    return true;
  }

  get eventHistory() {
    return _lodash.default.cloneDeep(this._eventHistory);
  }

  logEvent(eventName) {
    if (eventName === 'commands') {
      throw new Error('Cannot log commands directly');
    }

    if (typeof eventName !== 'string') {
      throw new Error(`Invalid eventName ${eventName}`);
    }

    if (!this._eventHistory[eventName]) {
      this._eventHistory[eventName] = [];
    }

    let ts = Date.now();
    let logTime = new Date(ts).toTimeString();

    this._eventHistory[eventName].push(ts);

    _logger.default.debug(`Event '${eventName}' logged at ${ts} (${logTime})`);
  }

  async getStatus() {
    return {};
  }

  resetOnUnexpectedShutdown() {
    if (this.onUnexpectedShutdown && !this.onUnexpectedShutdown.isFulfilled()) {
      this.onUnexpectedShutdown.cancel();
    }

    this.onUnexpectedShutdown = new _bluebird.default((resolve, reject, onCancel) => {
      onCancel(() => reject(new _bluebird.default.CancellationError()));
      this.unexpectedShutdownDeferred = {
        resolve,
        reject
      };
    });
    this.onUnexpectedShutdown.catch(() => {});
  }

  set desiredCapConstraints(constraints) {
    this._constraints = Object.assign(this._constraints, constraints);

    for (const [, value] of _lodash.default.toPairs(this._constraints)) {
      if (value && value.presence === true) {
        value.presence = {
          allowEmpty: false
        };
      }
    }
  }

  get desiredCapConstraints() {
    return this._constraints;
  }

  sessionExists(sessionId) {
    if (!sessionId) return false;
    return sessionId === this.sessionId;
  }

  driverForSession() {
    return this;
  }

  logExtraCaps(caps) {
    let extraCaps = _lodash.default.difference(_lodash.default.keys(caps), _lodash.default.keys(this._constraints));

    if (extraCaps.length) {
      _logger.default.warn(`The following capabilities were provided, but are not ` + `recognized by Appium:`);

      for (const cap of extraCaps) {
        _logger.default.warn(`  ${cap}`);
      }
    }
  }

  validateDesiredCaps(caps) {
    if (!this.shouldValidateCaps) {
      return true;
    }

    try {
      (0, _capabilities.validateCaps)(caps, this._constraints);
    } catch (e) {
      _logger.default.errorAndThrow(new _protocol.errors.SessionNotCreatedError(`The desiredCapabilities object was not valid for the ` + `following reason(s): ${e.message}`));
    }

    this.logExtraCaps(caps);
    return true;
  }

  isMjsonwpProtocol() {
    return this.protocol === BaseDriver.DRIVER_PROTOCOL.MJSONWP;
  }

  isW3CProtocol() {
    return this.protocol === BaseDriver.DRIVER_PROTOCOL.W3C;
  }

  setProtocolMJSONWP() {
    this.protocol = BaseDriver.DRIVER_PROTOCOL.MJSONWP;
  }

  setProtocolW3C() {
    this.protocol = BaseDriver.DRIVER_PROTOCOL.W3C;
  }

  static determineProtocol(desiredCapabilities, requiredCapabilities, capabilities) {
    return _lodash.default.isPlainObject(capabilities) ? BaseDriver.DRIVER_PROTOCOL.W3C : BaseDriver.DRIVER_PROTOCOL.MJSONWP;
  }

  async executeCommand(cmd, ...args) {
    let startTime = Date.now();

    if (cmd === 'createSession') {
      this.protocol = BaseDriver.determineProtocol(...args);
      this.logEvent(EVENT_SESSION_INIT);
    } else if (cmd === 'deleteSession') {
      this.logEvent(EVENT_SESSION_QUIT_START);
    }

    this.clearNewCommandTimeout();
    const imgElId = (0, _imageElement.getImgElFromArgs)(args);

    if (!this[cmd] && !imgElId) {
      throw new _protocol.errors.NotYetImplementedError();
    }

    let res;

    if (this.isCommandsQueueEnabled) {
      const nextCommand = this.curCommand.then(() => {
        if (this.shutdownUnexpectedly) {
          return _bluebird.default.reject(new _protocol.errors.NoSuchDriverError('The driver was unexpectedly shut down!'));
        }

        let reject;
        this.curCommandCancellable = _bluebird.default.resolve().then(() => {
          const cancelPromise = new _bluebird.default(function (_, _reject) {
            reject = _reject;
          });
          return _bluebird.default.race([imgElId ? _imageElement.ImageElement.execute(this, cmd, imgElId) : this[cmd](...args), cancelPromise]);
        });

        this.curCommandCancellable.cancel = function cancel(err) {
          if (reject) {
            reject(err);
          }
        };

        return this.curCommandCancellable;
      });
      this.curCommand = nextCommand.catch(() => {});
      res = await nextCommand;
    } else {
      if (this.shutdownUnexpectedly) {
        throw new _protocol.errors.NoSuchDriverError('The driver was unexpectedly shut down!');
      }

      res = await this[cmd](...args);
    }

    if (this.isCommandsQueueEnabled && cmd !== 'deleteSession') {
      this.startNewCommandTimeout();
    }

    const endTime = Date.now();

    this._eventHistory.commands.push({
      cmd,
      startTime,
      endTime
    });

    if (cmd === 'createSession') {
      this.logEvent(EVENT_SESSION_START);
    } else if (cmd === 'deleteSession') {
      this.logEvent(EVENT_SESSION_QUIT_DONE);
    }

    return res;
  }

  async startUnexpectedShutdown(err = new _protocol.errors.NoSuchDriverError('The driver was unexpectedly shut down!')) {
    this.unexpectedShutdownDeferred.reject(err);
    this.shutdownUnexpectedly = true;
    await this.deleteSession(this.sessionId);
    this.shutdownUnexpectedly = false;
    this.curCommandCancellable.cancel(err);
  }

  validateLocatorStrategy(strategy, webContext = false) {
    let validStrategies = this.locatorStrategies;

    _logger.default.debug(`Valid locator strategies for this request: ${validStrategies.join(', ')}`);

    if (webContext) {
      validStrategies = validStrategies.concat(this.webLocatorStrategies);
    }

    if (!_lodash.default.includes(validStrategies, strategy)) {
      throw new _protocol.errors.InvalidSelectorError(`Locator Strategy '${strategy}' is not supported for this session`);
    }
  }

  async reset() {
    _logger.default.debug('Resetting app mid-session');

    _logger.default.debug('Running generic full reset');

    let currentConfig = {};

    for (let property of ['implicitWaitMs', 'newCommandTimeoutMs', 'sessionId', 'resetOnUnexpectedShutdown']) {
      currentConfig[property] = this[property];
    }

    this.resetOnUnexpectedShutdown = () => {};

    const args = this.protocol === BaseDriver.DRIVER_PROTOCOL.W3C ? [undefined, undefined, {
      alwaysMatch: this.caps,
      firstMatch: [{}]
    }] : [this.caps];

    try {
      await this.deleteSession(this.sessionId);

      _logger.default.debug('Restarting app');

      await this.createSession(...args);
    } finally {
      for (let [key, value] of _lodash.default.toPairs(currentConfig)) {
        this[key] = value;
      }
    }

    this.clearNewCommandTimeout();
  }

  async getSwipeOptions(gestures, touchCount = 1) {
    let startX = this.helpers.getCoordDefault(gestures[0].options.x),
        startY = this.helpers.getCoordDefault(gestures[0].options.y),
        endX = this.helpers.getCoordDefault(gestures[2].options.x),
        endY = this.helpers.getCoordDefault(gestures[2].options.y),
        duration = this.helpers.getSwipeTouchDuration(gestures[1]),
        element = gestures[0].options.element,
        destElement = gestures[2].options.element || gestures[0].options.element;

    if (_appiumSupport.util.hasValue(destElement)) {
      let locResult = await this.getLocationInView(destElement);
      let sizeResult = await this.getSize(destElement);
      let offsetX = Math.abs(endX) < 1 && Math.abs(endX) > 0 ? sizeResult.width * endX : endX;
      let offsetY = Math.abs(endY) < 1 && Math.abs(endY) > 0 ? sizeResult.height * endY : endY;
      endX = locResult.x + offsetX;
      endY = locResult.y + offsetY;

      if (_appiumSupport.util.hasValue(element)) {
        let firstElLocation = await this.getLocationInView(element);
        endX -= firstElLocation.x;
        endY -= firstElLocation.y;
      }
    }

    return {
      startX,
      startY,
      endX,
      endY,
      duration,
      touchCount,
      element
    };
  }

  proxyActive() {
    return false;
  }

  getProxyAvoidList() {
    return [];
  }

  canProxy() {
    return false;
  }

  proxyRouteIsAvoided(sessionId, method, url) {
    for (let avoidSchema of this.getProxyAvoidList(sessionId)) {
      if (!_lodash.default.isArray(avoidSchema) || avoidSchema.length !== 2) {
        throw new Error('Proxy avoidance must be a list of pairs');
      }

      let [avoidMethod, avoidPathRegex] = avoidSchema;

      if (!_lodash.default.includes(['GET', 'POST', 'DELETE'], avoidMethod)) {
        throw new Error(`Unrecognized proxy avoidance method '${avoidMethod}'`);
      }

      if (!_lodash.default.isRegExp(avoidPathRegex)) {
        throw new Error('Proxy avoidance path must be a regular expression');
      }

      let normalizedUrl = url.replace(/^\/wd\/hub/, '');

      if (avoidMethod === method && avoidPathRegex.test(normalizedUrl)) {
        return true;
      }
    }

    return false;
  }

  addManagedDriver(driver) {
    this.managedDrivers.push(driver);
  }

  getManagedDrivers() {
    return this.managedDrivers;
  }

  registerImageElement(imgEl) {
    this._imgElCache.set(imgEl.id, imgEl);

    const protoKey = this.isW3CProtocol() ? _protocol2.W3C_ELEMENT_KEY : _protocol2.MJSONWP_ELEMENT_KEY;
    return imgEl.asElement(protoKey);
  }

}

exports.BaseDriver = BaseDriver;
BaseDriver.DRIVER_PROTOCOL = {
  W3C: 'W3C',
  MJSONWP: 'MJSONWP'
};

for (let [cmd, fn] of _lodash.default.toPairs(_commands.default)) {
  BaseDriver.prototype[cmd] = fn;
}

var _default = BaseDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2RyaXZlci5qcyJdLCJuYW1lcyI6WyJCIiwiY29uZmlnIiwiY2FuY2VsbGF0aW9uIiwiTkVXX0NPTU1BTkRfVElNRU9VVF9NUyIsIkVWRU5UX1NFU1NJT05fSU5JVCIsIkVWRU5UX1NFU1NJT05fU1RBUlQiLCJFVkVOVF9TRVNTSU9OX1FVSVRfU1RBUlQiLCJFVkVOVF9TRVNTSU9OX1FVSVRfRE9ORSIsIkJhc2VEcml2ZXIiLCJQcm90b2NvbCIsImNvbnN0cnVjdG9yIiwib3B0cyIsInNob3VsZFZhbGlkYXRlQ2FwcyIsInNlc3Npb25JZCIsImNhcHMiLCJoZWxwZXJzIiwibmV3Q29tbWFuZFRpbWVvdXRNcyIsImltcGxpY2l0V2FpdE1zIiwiX2NvbnN0cmFpbnRzIiwiXyIsImNsb25lRGVlcCIsImRlc2lyZWRDYXBhYmlsaXR5Q29uc3RyYWludHMiLCJsb2NhdG9yU3RyYXRlZ2llcyIsIndlYkxvY2F0b3JTdHJhdGVnaWVzIiwidG1wRGlyIiwicHJvY2VzcyIsImVudiIsIkFQUElVTV9UTVBfRElSIiwib3MiLCJ0bXBkaXIiLCJjdXJDb21tYW5kIiwicmVzb2x2ZSIsImN1ckNvbW1hbmRDYW5jZWxsYWJsZSIsInNodXRkb3duVW5leHBlY3RlZGx5Iiwibm9Db21tYW5kVGltZXIiLCJzZXR0aW5ncyIsIkRldmljZVNldHRpbmdzIiwibm9vcCIsInJlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24iLCJpbml0aWFsT3B0cyIsIm1hbmFnZWREcml2ZXJzIiwiX2V2ZW50SGlzdG9yeSIsImNvbW1hbmRzIiwiX2ltZ0VsQ2FjaGUiLCJwcm90b2NvbCIsImRyaXZlckRhdGEiLCJpc0NvbW1hbmRzUXVldWVFbmFibGVkIiwiZXZlbnRIaXN0b3J5IiwibG9nRXZlbnQiLCJldmVudE5hbWUiLCJFcnJvciIsInRzIiwiRGF0ZSIsIm5vdyIsImxvZ1RpbWUiLCJ0b1RpbWVTdHJpbmciLCJwdXNoIiwibG9nIiwiZGVidWciLCJnZXRTdGF0dXMiLCJvblVuZXhwZWN0ZWRTaHV0ZG93biIsImlzRnVsZmlsbGVkIiwiY2FuY2VsIiwicmVqZWN0Iiwib25DYW5jZWwiLCJDYW5jZWxsYXRpb25FcnJvciIsInVuZXhwZWN0ZWRTaHV0ZG93bkRlZmVycmVkIiwiY2F0Y2giLCJkZXNpcmVkQ2FwQ29uc3RyYWludHMiLCJjb25zdHJhaW50cyIsIk9iamVjdCIsImFzc2lnbiIsInZhbHVlIiwidG9QYWlycyIsInByZXNlbmNlIiwiYWxsb3dFbXB0eSIsInNlc3Npb25FeGlzdHMiLCJkcml2ZXJGb3JTZXNzaW9uIiwibG9nRXh0cmFDYXBzIiwiZXh0cmFDYXBzIiwiZGlmZmVyZW5jZSIsImtleXMiLCJsZW5ndGgiLCJ3YXJuIiwiY2FwIiwidmFsaWRhdGVEZXNpcmVkQ2FwcyIsImUiLCJlcnJvckFuZFRocm93IiwiZXJyb3JzIiwiU2Vzc2lvbk5vdENyZWF0ZWRFcnJvciIsIm1lc3NhZ2UiLCJpc01qc29ud3BQcm90b2NvbCIsIkRSSVZFUl9QUk9UT0NPTCIsIk1KU09OV1AiLCJpc1czQ1Byb3RvY29sIiwiVzNDIiwic2V0UHJvdG9jb2xNSlNPTldQIiwic2V0UHJvdG9jb2xXM0MiLCJkZXRlcm1pbmVQcm90b2NvbCIsImRlc2lyZWRDYXBhYmlsaXRpZXMiLCJyZXF1aXJlZENhcGFiaWxpdGllcyIsImNhcGFiaWxpdGllcyIsImlzUGxhaW5PYmplY3QiLCJleGVjdXRlQ29tbWFuZCIsImNtZCIsImFyZ3MiLCJzdGFydFRpbWUiLCJjbGVhck5ld0NvbW1hbmRUaW1lb3V0IiwiaW1nRWxJZCIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJyZXMiLCJuZXh0Q29tbWFuZCIsInRoZW4iLCJOb1N1Y2hEcml2ZXJFcnJvciIsImNhbmNlbFByb21pc2UiLCJfcmVqZWN0IiwicmFjZSIsIkltYWdlRWxlbWVudCIsImV4ZWN1dGUiLCJlcnIiLCJzdGFydE5ld0NvbW1hbmRUaW1lb3V0IiwiZW5kVGltZSIsInN0YXJ0VW5leHBlY3RlZFNodXRkb3duIiwiZGVsZXRlU2Vzc2lvbiIsInZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5Iiwic3RyYXRlZ3kiLCJ3ZWJDb250ZXh0IiwidmFsaWRTdHJhdGVnaWVzIiwiam9pbiIsImNvbmNhdCIsImluY2x1ZGVzIiwiSW52YWxpZFNlbGVjdG9yRXJyb3IiLCJyZXNldCIsImN1cnJlbnRDb25maWciLCJwcm9wZXJ0eSIsInVuZGVmaW5lZCIsImFsd2F5c01hdGNoIiwiZmlyc3RNYXRjaCIsImNyZWF0ZVNlc3Npb24iLCJrZXkiLCJnZXRTd2lwZU9wdGlvbnMiLCJnZXN0dXJlcyIsInRvdWNoQ291bnQiLCJzdGFydFgiLCJnZXRDb29yZERlZmF1bHQiLCJvcHRpb25zIiwieCIsInN0YXJ0WSIsInkiLCJlbmRYIiwiZW5kWSIsImR1cmF0aW9uIiwiZ2V0U3dpcGVUb3VjaER1cmF0aW9uIiwiZWxlbWVudCIsImRlc3RFbGVtZW50IiwidXRpbCIsImhhc1ZhbHVlIiwibG9jUmVzdWx0IiwiZ2V0TG9jYXRpb25JblZpZXciLCJzaXplUmVzdWx0IiwiZ2V0U2l6ZSIsIm9mZnNldFgiLCJNYXRoIiwiYWJzIiwid2lkdGgiLCJvZmZzZXRZIiwiaGVpZ2h0IiwiZmlyc3RFbExvY2F0aW9uIiwicHJveHlBY3RpdmUiLCJnZXRQcm94eUF2b2lkTGlzdCIsImNhblByb3h5IiwicHJveHlSb3V0ZUlzQXZvaWRlZCIsIm1ldGhvZCIsInVybCIsImF2b2lkU2NoZW1hIiwiaXNBcnJheSIsImF2b2lkTWV0aG9kIiwiYXZvaWRQYXRoUmVnZXgiLCJpc1JlZ0V4cCIsIm5vcm1hbGl6ZWRVcmwiLCJyZXBsYWNlIiwidGVzdCIsImFkZE1hbmFnZWREcml2ZXIiLCJkcml2ZXIiLCJnZXRNYW5hZ2VkRHJpdmVycyIsInJlZ2lzdGVySW1hZ2VFbGVtZW50IiwiaW1nRWwiLCJzZXQiLCJpZCIsInByb3RvS2V5IiwiVzNDX0VMRU1FTlRfS0VZIiwiTUpTT05XUF9FTEVNRU5UX0tFWSIsImFzRWxlbWVudCIsImZuIiwicHJvdG90eXBlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7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bnRlbnQiOlsiaW1wb3J0IHsgUHJvdG9jb2wsIGVycm9ycyB9IGZyb20gJy4uL3Byb3RvY29sJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcyc7XG5pbXBvcnQgKiBhcyBoZWxwZXJzIGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBEZXZpY2VTZXR0aW5ncyBmcm9tICcuL2RldmljZS1zZXR0aW5ncyc7XG5pbXBvcnQgeyBkZXNpcmVkQ2FwYWJpbGl0eUNvbnN0cmFpbnRzIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuaW1wb3J0IHsgdmFsaWRhdGVDYXBzIH0gZnJvbSAnLi9jYXBhYmlsaXRpZXMnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBJbWFnZUVsZW1lbnQsIG1ha2VJbWFnZUVsZW1lbnRDYWNoZSwgZ2V0SW1nRWxGcm9tQXJncyB9IGZyb20gJy4vaW1hZ2UtZWxlbWVudCc7XG5pbXBvcnQgeyBXM0NfRUxFTUVOVF9LRVksIE1KU09OV1BfRUxFTUVOVF9LRVkgfSBmcm9tICcuLi9wcm90b2NvbC9wcm90b2NvbCc7XG5cblxuQi5jb25maWcoe1xuICBjYW5jZWxsYXRpb246IHRydWUsXG59KTtcblxuY29uc3QgTkVXX0NPTU1BTkRfVElNRU9VVF9NUyA9IDYwICogMTAwMDtcblxuY29uc3QgRVZFTlRfU0VTU0lPTl9JTklUID0gJ25ld1Nlc3Npb25SZXF1ZXN0ZWQnO1xuY29uc3QgRVZFTlRfU0VTU0lPTl9TVEFSVCA9ICduZXdTZXNzaW9uU3RhcnRlZCc7XG5jb25zdCBFVkVOVF9TRVNTSU9OX1FVSVRfU1RBUlQgPSAncXVpdFNlc3Npb25SZXF1ZXN0ZWQnO1xuY29uc3QgRVZFTlRfU0VTU0lPTl9RVUlUX0RPTkUgPSAncXVpdFNlc3Npb25GaW5pc2hlZCc7XG5cbmNsYXNzIEJhc2VEcml2ZXIgZXh0ZW5kcyBQcm90b2NvbCB7XG5cbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSwgc2hvdWxkVmFsaWRhdGVDYXBzID0gdHJ1ZSkge1xuICAgIHN1cGVyKCk7XG5cbiAgICAvLyBzZXR1cCBzdGF0ZVxuICAgIHRoaXMuc2Vzc2lvbklkID0gbnVsbDtcbiAgICB0aGlzLm9wdHMgPSBvcHRzO1xuICAgIHRoaXMuY2FwcyA9IG51bGw7XG4gICAgdGhpcy5oZWxwZXJzID0gaGVscGVycztcblxuICAgIC8vIHRpbWVvdXQgaW5pdGlhbGl6YXRpb25cbiAgICB0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMgPSBORVdfQ09NTUFORF9USU1FT1VUX01TO1xuICAgIHRoaXMuaW1wbGljaXRXYWl0TXMgPSAwO1xuXG4gICAgdGhpcy5fY29uc3RyYWludHMgPSBfLmNsb25lRGVlcChkZXNpcmVkQ2FwYWJpbGl0eUNvbnN0cmFpbnRzKTtcbiAgICB0aGlzLmxvY2F0b3JTdHJhdGVnaWVzID0gW107XG4gICAgdGhpcy53ZWJMb2NhdG9yU3RyYXRlZ2llcyA9IFtdO1xuXG4gICAgLy8gdXNlIGEgY3VzdG9tIHRtcCBkaXIgdG8gYXZvaWQgbG9zaW5nIGRhdGEgYW5kIGFwcCB3aGVuIGNvbXB1dGVyIGlzXG4gICAgLy8gcmVzdGFydGVkXG4gICAgdGhpcy5vcHRzLnRtcERpciA9IHRoaXMub3B0cy50bXBEaXIgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuQVBQSVVNX1RNUF9ESVIgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgb3MudG1wZGlyKCk7XG5cbiAgICAvLyBiYXNlLWRyaXZlciBpbnRlcm5hbHNcbiAgICB0aGlzLmN1ckNvbW1hbmQgPSBCLnJlc29sdmUoKTsgLy8gc2VlIG5vdGUgaW4gZXhlY3V0ZVxuICAgIHRoaXMuY3VyQ29tbWFuZENhbmNlbGxhYmxlID0gQi5yZXNvbHZlKCk7IC8vIHNlZSBub3RlIGluIGV4ZWN1dGVcbiAgICB0aGlzLnNodXRkb3duVW5leHBlY3RlZGx5ID0gZmFsc2U7XG4gICAgdGhpcy5ub0NvbW1hbmRUaW1lciA9IG51bGw7XG4gICAgdGhpcy5zaG91bGRWYWxpZGF0ZUNhcHMgPSBzaG91bGRWYWxpZGF0ZUNhcHM7XG5cbiAgICAvLyBzZXR0aW5ncyBzaG91bGQgYmUgaW5zdGFudGlhdGVkIGJ5IGRyaXZlcnMgd2hpY2ggZXh0ZW5kIEJhc2VEcml2ZXIsIGJ1dFxuICAgIC8vIHdlIHNldCBpdCB0byBhbiBlbXB0eSBEZXZpY2VTZXR0aW5ncyBpbnN0YW5jZSBoZXJlIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZVxuICAgIC8vIGRlZmF1bHQgc2V0dGluZ3MgYXJlIGFwcGxpZWQgZXZlbiBpZiBhbiBleHRlbmRpbmcgZHJpdmVyIGRvZXNuJ3QgdXRpbGl6ZVxuICAgIC8vIHRoZSBzZXR0aW5ncyBmdW5jdGlvbmFsaXR5IGl0c2VsZlxuICAgIHRoaXMuc2V0dGluZ3MgPSBuZXcgRGV2aWNlU2V0dGluZ3Moe30sIF8ubm9vcCk7XG5cbiAgICB0aGlzLnJlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24oKTtcblxuICAgIC8vIGtlZXBpbmcgdHJhY2sgb2YgaW5pdGlhbCBvcHRzXG4gICAgdGhpcy5pbml0aWFsT3B0cyA9IF8uY2xvbmVEZWVwKHRoaXMub3B0cyk7XG5cbiAgICAvLyBhbGxvdyBzdWJjbGFzc2VzIHRvIGhhdmUgaW50ZXJuYWwgZHJpdmVyc1xuICAgIHRoaXMubWFuYWdlZERyaXZlcnMgPSBbXTtcblxuICAgIC8vIHN0b3JlIGV2ZW50IHRpbWluZ3NcbiAgICB0aGlzLl9ldmVudEhpc3RvcnkgPSB7XG4gICAgICBjb21tYW5kczogW10gLy8gY29tbWFuZHMgZ2V0IGEgc3BlY2lhbCBwbGFjZVxuICAgIH07XG5cbiAgICAvLyBjYWNoZSB0aGUgaW1hZ2UgZWxlbWVudHNcbiAgICB0aGlzLl9pbWdFbENhY2hlID0gbWFrZUltYWdlRWxlbWVudENhY2hlKCk7XG5cbiAgICB0aGlzLnByb3RvY29sID0gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIHByb3BlcnR5IGlzIHVzZWQgYnkgQXBwaXVtRHJpdmVyIHRvIHN0b3JlIHRoZSBkYXRhIG9mIHRoZVxuICAgKiBzcGVjaWZpYyBkcml2ZXIgc2Vzc2lvbnMuIFRoaXMgZGF0YSBjYW4gYmUgbGF0ZXIgdXNlZCB0byBhZGp1c3RcbiAgICogcHJvcGVydGllcyBmb3IgZHJpdmVyIGluc3RhbmNlcyBydW5uaW5nIGluIHBhcmFsbGVsLlxuICAgKiBPdmVycmlkZSBpdCBpbiBpbmhlcml0ZWQgZHJpdmVyIGNsYXNzZXMgaWYgbmVjZXNzYXJ5LlxuICAgKlxuICAgKiBAcmV0dXJuIHtvYmplY3R9IERyaXZlciBwcm9wZXJ0aWVzIG1hcHBpbmdcbiAgICovXG4gIGdldCBkcml2ZXJEYXRhICgpIHtcbiAgICByZXR1cm4ge307XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBwcm9wZXJ0eSBjb250cm9scyB0aGUgd2F5IHsjZXhlY3V0ZUNvbW1hbmR9IG1ldGhvZFxuICAgKiBoYW5kbGVzIG5ldyBkcml2ZXIgY29tbWFuZHMgcmVjZWl2ZWQgZnJvbSB0aGUgY2xpZW50LlxuICAgKiBPdmVycmlkZSBpdCBmb3IgaW5oZXJpdGVkIGNsYXNzZXMgb25seSBpbiBzcGVjaWFsIGNhc2VzLlxuICAgKlxuICAgKiBAcmV0dXJuIHtib29sZWFufSBJZiB0aGUgcmV0dXJuZWQgdmFsdWUgaXMgdHJ1ZSAoZGVmYXVsdCkgdGhlbiBhbGwgdGhlIGNvbW1hbmRzXG4gICAqICAgcmVjZWl2ZWQgYnkgdGhlIHBhcnRpY3VsYXIgZHJpdmVyIGluc3RhbmNlIGFyZSBnb2luZyB0byBiZSBwdXQgaW50byB0aGUgcXVldWUsXG4gICAqICAgc28gZWFjaCBmb2xsb3dpbmcgY29tbWFuZCB3aWxsIG5vdCBiZSBleGVjdXRlZCB1bnRpbCB0aGUgcHJldmlvdXMgY29tbWFuZFxuICAgKiAgIGV4ZWN1dGlvbiBpcyBjb21wbGV0ZWQuIEZhbHNlIHZhbHVlIGRpc2FibGVzIHRoYXQgcXVldWUsIHNvIGVhY2ggZHJpdmVyIGNvbW1hbmRcbiAgICogICBpcyBleGVjdXRlZCBpbmRlcGVuZGVudGx5IGFuZCBkb2VzIG5vdCB3YWl0IGZvciBhbnl0aGluZy5cbiAgICovXG4gIGdldCBpc0NvbW1hbmRzUXVldWVFbmFibGVkICgpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qXG4gICAqIG1ha2UgZXZlbnRIaXN0b3J5IGEgcHJvcGVydHkgYW5kIHJldHVybiBhIGNsb25lZCBvYmplY3Qgc28gYSBjb25zdW1lciBjYW4ndFxuICAgKiBpbmFkdmVydGVudGx5IGNoYW5nZSBkYXRhIG91dHNpZGUgb2YgbG9nRXZlbnRcbiAgICovXG4gIGdldCBldmVudEhpc3RvcnkgKCkge1xuICAgIHJldHVybiBfLmNsb25lRGVlcCh0aGlzLl9ldmVudEhpc3RvcnkpO1xuICB9XG5cbiAgLypcbiAgICogQVBJIG1ldGhvZCBmb3IgZHJpdmVyIGRldmVsb3BlcnMgdG8gbG9nIHRpbWluZ3MgZm9yIGltcG9ydGFudCBldmVudHNcbiAgICovXG4gIGxvZ0V2ZW50IChldmVudE5hbWUpIHtcbiAgICBpZiAoZXZlbnROYW1lID09PSAnY29tbWFuZHMnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2cgY29tbWFuZHMgZGlyZWN0bHknKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBldmVudE5hbWUgIT09ICdzdHJpbmcnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgZXZlbnROYW1lICR7ZXZlbnROYW1lfWApO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuX2V2ZW50SGlzdG9yeVtldmVudE5hbWVdKSB7XG4gICAgICB0aGlzLl9ldmVudEhpc3RvcnlbZXZlbnROYW1lXSA9IFtdO1xuICAgIH1cbiAgICBsZXQgdHMgPSBEYXRlLm5vdygpO1xuICAgIGxldCBsb2dUaW1lID0gKG5ldyBEYXRlKHRzKSkudG9UaW1lU3RyaW5nKCk7XG4gICAgdGhpcy5fZXZlbnRIaXN0b3J5W2V2ZW50TmFtZV0ucHVzaCh0cyk7XG4gICAgbG9nLmRlYnVnKGBFdmVudCAnJHtldmVudE5hbWV9JyBsb2dnZWQgYXQgJHt0c30gKCR7bG9nVGltZX0pYCk7XG4gIH1cblxuICAvKlxuICAgKiBPdmVycmlkZGVuIGluIGFwcGl1bSBkcml2ZXIsIGJ1dCBoZXJlIHNvIHRoYXQgaW5kaXZpZHVhbCBkcml2ZXJzIGNhbiBiZVxuICAgKiB0ZXN0ZWQgd2l0aCBjbGllbnRzIHRoYXQgcG9sbFxuICAgKi9cbiAgYXN5bmMgZ2V0U3RhdHVzICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgLypcbiAgICogSW5pdGlhbGl6ZSBhIG5ldyBvblVuZXhwZWN0ZWRTaHV0ZG93biBwcm9taXNlLCBjYW5jZWxsaW5nIGV4aXN0aW5nIG9uZS5cbiAgICovXG4gIHJlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24gKCkge1xuICAgIGlmICh0aGlzLm9uVW5leHBlY3RlZFNodXRkb3duICYmICF0aGlzLm9uVW5leHBlY3RlZFNodXRkb3duLmlzRnVsZmlsbGVkKCkpIHtcbiAgICAgIHRoaXMub25VbmV4cGVjdGVkU2h1dGRvd24uY2FuY2VsKCk7XG4gICAgfVxuICAgIHRoaXMub25VbmV4cGVjdGVkU2h1dGRvd24gPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0LCBvbkNhbmNlbCkgPT4ge1xuICAgICAgb25DYW5jZWwoKCkgPT4gcmVqZWN0KG5ldyBCLkNhbmNlbGxhdGlvbkVycm9yKCkpKTtcbiAgICAgIHRoaXMudW5leHBlY3RlZFNodXRkb3duRGVmZXJyZWQgPSB7cmVzb2x2ZSwgcmVqZWN0fTtcbiAgICB9KTtcbiAgICAvLyBub29wIGhhbmRsZXIgdG8gYXZvaWQgd2FybmluZy5cbiAgICB0aGlzLm9uVW5leHBlY3RlZFNodXRkb3duLmNhdGNoKCgpID0+IHt9KTtcbiAgfVxuXG4gIC8vIHdlIG9ubHkgd2FudCBzdWJjbGFzc2VzIHRvIGV2ZXIgZXh0ZW5kIHRoZSBjb250cmFpbnRzXG4gIHNldCBkZXNpcmVkQ2FwQ29uc3RyYWludHMgKGNvbnN0cmFpbnRzKSB7XG4gICAgdGhpcy5fY29uc3RyYWludHMgPSBPYmplY3QuYXNzaWduKHRoaXMuX2NvbnN0cmFpbnRzLCBjb25zdHJhaW50cyk7XG4gICAgLy8gJ3ByZXNlbmNlJyBtZWFucyBkaWZmZXJlbnQgdGhpbmdzIGluIGRpZmZlcmVudCB2ZXJzaW9ucyBvZiB0aGUgdmFsaWRhdG9yLFxuICAgIC8vIHdoZW4gd2Ugc2F5ICd0cnVlJyB3ZSBtZWFuIHRoYXQgaXQgc2hvdWxkIG5vdCBiZSBhYmxlIHRvIGJlIGVtcHR5XG4gICAgZm9yIChjb25zdCBbLCB2YWx1ZV0gb2YgXy50b1BhaXJzKHRoaXMuX2NvbnN0cmFpbnRzKSkge1xuICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLnByZXNlbmNlID09PSB0cnVlKSB7XG4gICAgICAgIHZhbHVlLnByZXNlbmNlID0ge1xuICAgICAgICAgIGFsbG93RW1wdHk6IGZhbHNlLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdldCBkZXNpcmVkQ2FwQ29uc3RyYWludHMgKCkge1xuICAgIHJldHVybiB0aGlzLl9jb25zdHJhaW50cztcbiAgfVxuXG4gIC8vIG1ldGhvZCByZXF1aXJlZCBieSBNSlNPTldQIGluIG9yZGVyIHRvIGRldGVybWluZSB3aGV0aGVyIGl0IHNob3VsZFxuICAvLyByZXNwb25kIHdpdGggYW4gaW52YWxpZCBzZXNzaW9uIHJlc3BvbnNlXG4gIHNlc3Npb25FeGlzdHMgKHNlc3Npb25JZCkge1xuICAgIGlmICghc2Vzc2lvbklkKSByZXR1cm4gZmFsc2U7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICByZXR1cm4gc2Vzc2lvbklkID09PSB0aGlzLnNlc3Npb25JZDtcbiAgfVxuXG4gIC8vIG1ldGhvZCByZXF1aXJlZCBieSBNSlNPTldQIGluIG9yZGVyIHRvIGRldGVybWluZSBpZiB0aGUgY29tbWFuZCBzaG91bGRcbiAgLy8gYmUgcHJveGllZCBkaXJlY3RseSB0byB0aGUgZHJpdmVyXG4gIGRyaXZlckZvclNlc3Npb24gKC8qc2Vzc2lvbklkKi8pIHtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGxvZ0V4dHJhQ2FwcyAoY2Fwcykge1xuICAgIGxldCBleHRyYUNhcHMgPSBfLmRpZmZlcmVuY2UoXy5rZXlzKGNhcHMpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5rZXlzKHRoaXMuX2NvbnN0cmFpbnRzKSk7XG4gICAgaWYgKGV4dHJhQ2Fwcy5sZW5ndGgpIHtcbiAgICAgIGxvZy53YXJuKGBUaGUgZm9sbG93aW5nIGNhcGFiaWxpdGllcyB3ZXJlIHByb3ZpZGVkLCBidXQgYXJlIG5vdCBgICtcbiAgICAgICAgICAgICAgIGByZWNvZ25pemVkIGJ5IEFwcGl1bTpgKTtcbiAgICAgIGZvciAoY29uc3QgY2FwIG9mIGV4dHJhQ2Fwcykge1xuICAgICAgICBsb2cud2FybihgICAke2NhcH1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICB2YWxpZGF0ZURlc2lyZWRDYXBzIChjYXBzKSB7XG4gICAgaWYgKCF0aGlzLnNob3VsZFZhbGlkYXRlQ2Fwcykge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIHZhbGlkYXRlQ2FwcyhjYXBzLCB0aGlzLl9jb25zdHJhaW50cyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3cobmV3IGVycm9ycy5TZXNzaW9uTm90Q3JlYXRlZEVycm9yKGBUaGUgZGVzaXJlZENhcGFiaWxpdGllcyBvYmplY3Qgd2FzIG5vdCB2YWxpZCBmb3IgdGhlIGAgK1xuICAgICAgICAgICAgICAgICAgICBgZm9sbG93aW5nIHJlYXNvbihzKTogJHtlLm1lc3NhZ2V9YCkpO1xuICAgIH1cblxuICAgIHRoaXMubG9nRXh0cmFDYXBzKGNhcHMpO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpc01qc29ud3BQcm90b2NvbCAoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvdG9jb2wgPT09IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MLk1KU09OV1A7XG4gIH1cblxuICBpc1czQ1Byb3RvY29sICgpIHtcbiAgICByZXR1cm4gdGhpcy5wcm90b2NvbCA9PT0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuVzNDO1xuICB9XG5cbiAgc2V0UHJvdG9jb2xNSlNPTldQICgpIHtcbiAgICB0aGlzLnByb3RvY29sID0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuTUpTT05XUDtcbiAgfVxuXG4gIHNldFByb3RvY29sVzNDICgpIHtcbiAgICB0aGlzLnByb3RvY29sID0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuVzNDO1xuICB9XG5cbiAgLyoqXG4gICAqIFRlc3QgY3JlYXRlU2Vzc2lvbiBpbnB1dHMgdG8gc2VlIGlmIHRoaXMgaXMgYSBXM0MgU2Vzc2lvbiBvciBhIE1KU09OV1AgU2Vzc2lvblxuICAgKi9cbiAgc3RhdGljIGRldGVybWluZVByb3RvY29sIChkZXNpcmVkQ2FwYWJpbGl0aWVzLCByZXF1aXJlZENhcGFiaWxpdGllcywgY2FwYWJpbGl0aWVzKSB7XG4gICAgcmV0dXJuIF8uaXNQbGFpbk9iamVjdChjYXBhYmlsaXRpZXMpID9cbiAgICAgIEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MLlczQyA6XG4gICAgICBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTC5NSlNPTldQO1xuICB9XG5cbiAgLy8gVGhpcyBpcyB0aGUgbWFpbiBjb21tYW5kIGhhbmRsZXIgZm9yIHRoZSBkcml2ZXIuIEl0IHdyYXBzIGNvbW1hbmRcbiAgLy8gZXhlY3V0aW9uIHdpdGggdGltZW91dCBsb2dpYywgY2hlY2tpbmcgdGhhdCB3ZSBoYXZlIGEgdmFsaWQgc2Vzc2lvbixcbiAgLy8gYW5kIGVuc3VyaW5nIHRoYXQgd2UgZXhlY3V0ZSBjb21tYW5kcyBvbmUgYXQgYSB0aW1lLiBUaGlzIG1ldGhvZCBpcyBjYWxsZWRcbiAgLy8gYnkgTUpTT05XUCdzIGV4cHJlc3Mgcm91dGVyLlxuICBhc3luYyBleGVjdXRlQ29tbWFuZCAoY21kLCAuLi5hcmdzKSB7XG4gICAgLy8gZ2V0IHN0YXJ0IHRpbWUgZm9yIHRoaXMgY29tbWFuZCwgYW5kIGxvZyBpbiBzcGVjaWFsIGNhc2VzXG4gICAgbGV0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgaWYgKGNtZCA9PT0gJ2NyZWF0ZVNlc3Npb24nKSB7XG4gICAgICAvLyBJZiBjcmVhdGluZyBhIHNlc3Npb24gZGV0ZXJtaW5lIGlmIFczQyBvciBNSlNPTldQIHByb3RvY29sIHdhcyByZXF1ZXN0ZWQgYW5kIHJlbWVtYmVyIHRoZSBjaG9pY2VcbiAgICAgIHRoaXMucHJvdG9jb2wgPSBCYXNlRHJpdmVyLmRldGVybWluZVByb3RvY29sKC4uLmFyZ3MpO1xuICAgICAgdGhpcy5sb2dFdmVudChFVkVOVF9TRVNTSU9OX0lOSVQpO1xuICAgIH0gZWxzZSBpZiAoY21kID09PSAnZGVsZXRlU2Vzc2lvbicpIHtcbiAgICAgIHRoaXMubG9nRXZlbnQoRVZFTlRfU0VTU0lPTl9RVUlUX1NUQVJUKTtcbiAgICB9XG5cbiAgICAvLyBpZiB3ZSBoYWQgYSBjb21tYW5kIHRpbWVyIHJ1bm5pbmcsIGNsZWFyIGl0IG5vdyB0aGF0IHdlJ3JlIHN0YXJ0aW5nXG4gICAgLy8gYSBuZXcgY29tbWFuZCBhbmQgc28gZG9uJ3Qgd2FudCB0byB0aW1lIG91dFxuICAgIHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuXG4gICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSB0aGlzIGNvbW1hbmQsIGl0IG11c3Qgbm90IGJlIGltcGxlbWVudGVkXG4gICAgLy8gSWYgdGhlIHRhcmdldCBlbGVtZW50IGlzIEltYWdlRWxlbWVudCwgd2UgbXVzdCB0cnkgdG8gY2FsbCBgSW1hZ2VFbGVtZW50LmV4ZWN1dGVgIHdoaWNoIGV4aXN0IGZvbGxvd2luZyBsaW5lc1xuICAgIC8vIHNpbmNlIEltYWdlRWxlbWVudCBzdXBwb3J0cyBmZXcgY29tbWFuZHMgYnkgaXRzZWxmXG4gICAgY29uc3QgaW1nRWxJZCA9IGdldEltZ0VsRnJvbUFyZ3MoYXJncyk7XG4gICAgaWYgKCF0aGlzW2NtZF0gJiYgIWltZ0VsSWQpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICAgIH1cblxuICAgIGxldCByZXM7XG4gICAgaWYgKHRoaXMuaXNDb21tYW5kc1F1ZXVlRW5hYmxlZCkge1xuICAgICAgLy8gV2hhdCB3ZSdyZSBkb2luZyBoZXJlIGlzIHByZXR0eSBjbGV2ZXIuIHRoaXMuY3VyQ29tbWFuZCBpcyBhbHdheXNcbiAgICAgIC8vIGEgcHJvbWlzZSByZXByZXNlbnRpbmcgdGhlIGNvbW1hbmQgY3VycmVudGx5IGJlaW5nIGV4ZWN1dGVkIGJ5IHRoZVxuICAgICAgLy8gZHJpdmVyLCBvciB0aGUgbGFzdCBjb21tYW5kIGV4ZWN1dGVkIGJ5IHRoZSBkcml2ZXIgKGl0IHN0YXJ0cyBvZmYgYXNcbiAgICAgIC8vIGVzc2VudGlhbGx5IGEgcHJlLXJlc29sdmVkIHByb21pc2UpLiBXaGVuIGEgY29tbWFuZCBjb21lcyBpbiwgd2UgdGFjayBpdFxuICAgICAgLy8gdG8gdGhlIGVuZCBvZiB0aGlzLmN1ckNvbW1hbmQsIGVzc2VudGlhbGx5IHNheWluZyB3ZSB3YW50IHRvIGV4ZWN1dGUgaXRcbiAgICAgIC8vIHdoZW5ldmVyIHRoaXMuY3VyQ29tbWFuZCBpcyBkb25lLiBXZSBjYWxsIHRoaXMgbmV3IHByb21pc2UgbmV4dENvbW1hbmQsXG4gICAgICAvLyBhbmQgaXRzIHJlc29sdXRpb24gaXMgd2hhdCB3ZSB1bHRpbWF0ZWx5IHdpbGwgcmV0dXJuIHRvIHdob21ldmVyIGNhbGxlZFxuICAgICAgLy8gdXMuIE1lYW53aGlsZSwgd2UgcmVzZXQgdGhpcy5jdXJDb21tYW5kIHRvIF9iZV8gbmV4dENvbW1hbmQgKGJ1dFxuICAgICAgLy8gaWdub3JpbmcgYW55IHJlamVjdGlvbnMpLCBzbyB0aGF0IGlmIGFub3RoZXIgY29tbWFuZCBjb21lcyBpbnRvIHRoZVxuICAgICAgLy8gc2VydmVyLCBpdCBnZXRzIHRhY2tlZCBvbiB0byB0aGUgZW5kIG9mIG5leHRDb21tYW5kLiBUaHVzIHdlIGNyZWF0ZVxuICAgICAgLy8gYSBjaGFpbiBvZiBwcm9taXNlcyB0aGF0IGFjdHMgYXMgYSBxdWV1ZSB3aXRoIHNpbmdsZSBjb25jdXJyZW5jeS5cbiAgICAgIGNvbnN0IG5leHRDb21tYW5kID0gdGhpcy5jdXJDb21tYW5kLnRoZW4oKCkgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLXRoZW5cbiAgICAgICAgLy8gaWYgd2UgdW5leHBlY3RlZGx5IHNodXQgZG93biwgd2UgbmVlZCB0byByZWplY3QgZXZlcnkgY29tbWFuZCBpblxuICAgICAgICAvLyB0aGUgcXVldWUgYmVmb3JlIHdlIGFjdHVhbGx5IHRyeSB0byBydW4gaXRcbiAgICAgICAgaWYgKHRoaXMuc2h1dGRvd25VbmV4cGVjdGVkbHkpIHtcbiAgICAgICAgICByZXR1cm4gQi5yZWplY3QobmV3IGVycm9ycy5Ob1N1Y2hEcml2ZXJFcnJvcignVGhlIGRyaXZlciB3YXMgdW5leHBlY3RlZGx5IHNodXQgZG93biEnKSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gV2UgYWxzbyBuZWVkIHRvIHR1cm4gdGhlIGNvbW1hbmQgaW50byBhIGNhbmNlbGxhYmxlIHByb21pc2Ugc28gaWYgd2VcbiAgICAgICAgLy8gaGF2ZSBhbiB1bmV4cGVjdGVkIHNodXRkb3duIGV2ZW50LCBmb3IgZXhhbXBsZSwgd2UgY2FuIGNhbmNlbCBpdCBmcm9tXG4gICAgICAgIC8vIG91dHNpZGUsIHJlamVjdGluZyB0aGUgY3VycmVudCBjb21tYW5kIGltbWVkaWF0ZWx5XG4gICAgICAgIGxldCByZWplY3Q7XG4gICAgICAgIHRoaXMuY3VyQ29tbWFuZENhbmNlbGxhYmxlID0gQi5yZXNvbHZlKCkudGhlbigoKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tdGhlblxuICAgICAgICAgIC8vIGluIG9yZGVyIHRvIGFib3J0IHRoZSBwcm9taXNlLCB3ZSBuZWVkIHRvIGhhdmUgaXQgaW4gYSByYWNlXG4gICAgICAgICAgLy8gd2l0aCBvbmUgd2UgY2FuIHJlamVjdCBmcm9tIG91dHNpZGVcbiAgICAgICAgICBjb25zdCBjYW5jZWxQcm9taXNlID0gbmV3IEIoZnVuY3Rpb24gKF8sIF9yZWplY3QpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bnVzZWQtdmFyc1xuICAgICAgICAgICAgcmVqZWN0ID0gX3JlamVjdDtcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIC8vIGlmIG9uZSBvZiB0aGUgYXJncyBpcyBhbiBpbWFnZSBlbGVtZW50LCBoYW5kbGUgaXQgc2VwYXJhdGVseVxuICAgICAgICAgIHJldHVybiBCLnJhY2UoW1xuICAgICAgICAgICAgaW1nRWxJZCA/IEltYWdlRWxlbWVudC5leGVjdXRlKHRoaXMsIGNtZCwgaW1nRWxJZCkgOiB0aGlzW2NtZF0oLi4uYXJncyksXG4gICAgICAgICAgICBjYW5jZWxQcm9taXNlLFxuICAgICAgICAgIF0pO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gb3ZlcnJpZGUgdGhlIEIjY2FuY2VsIGZ1bmN0aW9uLCB3aGljaCBqdXN0IHR1cm5zIG9mZiBsaXN0ZW5lcnNcbiAgICAgICAgdGhpcy5jdXJDb21tYW5kQ2FuY2VsbGFibGUuY2FuY2VsID0gZnVuY3Rpb24gY2FuY2VsIChlcnIpIHtcbiAgICAgICAgICBpZiAocmVqZWN0KSB7XG4gICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiB0aGlzLmN1ckNvbW1hbmRDYW5jZWxsYWJsZTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5jdXJDb21tYW5kID0gbmV4dENvbW1hbmQuY2F0Y2goKCkgPT4ge30pO1xuICAgICAgcmVzID0gYXdhaXQgbmV4dENvbW1hbmQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLnNodXRkb3duVW5leHBlY3RlZGx5KSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRHJpdmVyRXJyb3IoJ1RoZSBkcml2ZXIgd2FzIHVuZXhwZWN0ZWRseSBzaHV0IGRvd24hJyk7XG4gICAgICB9XG4gICAgICByZXMgPSBhd2FpdCB0aGlzW2NtZF0oLi4uYXJncyk7XG4gICAgfVxuXG4gICAgLy8gaWYgd2UgaGF2ZSBzZXQgYSBuZXcgY29tbWFuZCB0aW1lb3V0ICh3aGljaCBpcyB0aGUgZGVmYXVsdCksIHN0YXJ0IGFcbiAgICAvLyB0aW1lciBvbmNlIHdlJ3ZlIGZpbmlzaGVkIGV4ZWN1dGluZyB0aGlzIGNvbW1hbmQuIElmIHdlIGRvbid0IGNsZWFyXG4gICAgLy8gdGhlIHRpbWVyICh3aGljaCBpcyBkb25lIHdoZW4gYSBuZXcgY29tbWFuZCBjb21lcyBpbiksIHdlIHdpbGwgdHJpZ2dlclxuICAgIC8vIGF1dG9tYXRpYyBzZXNzaW9uIGRlbGV0aW9uIGluIHRoaXMub25Db21tYW5kVGltZW91dC4gT2YgY291cnNlIHdlIGRvbid0XG4gICAgLy8gd2FudCB0byB0cmlnZ2VyIHRoZSB0aW1lciB3aGVuIHRoZSB1c2VyIGlzIHNodXR0aW5nIGRvd24gdGhlIHNlc3Npb25cbiAgICAvLyBpbnRlbnRpb25hbGx5XG4gICAgaWYgKHRoaXMuaXNDb21tYW5kc1F1ZXVlRW5hYmxlZCAmJiBjbWQgIT09ICdkZWxldGVTZXNzaW9uJykge1xuICAgICAgLy8gcmVzZXRpbmcgZXhpc3RpbmcgdGltZW91dFxuICAgICAgdGhpcy5zdGFydE5ld0NvbW1hbmRUaW1lb3V0KCk7XG4gICAgfVxuXG4gICAgLy8gbG9nIHRpbWluZyBpbmZvcm1hdGlvbiBhYm91dCB0aGlzIGNvbW1hbmRcbiAgICBjb25zdCBlbmRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLl9ldmVudEhpc3RvcnkuY29tbWFuZHMucHVzaCh7Y21kLCBzdGFydFRpbWUsIGVuZFRpbWV9KTtcbiAgICBpZiAoY21kID09PSAnY3JlYXRlU2Vzc2lvbicpIHtcbiAgICAgIHRoaXMubG9nRXZlbnQoRVZFTlRfU0VTU0lPTl9TVEFSVCk7XG4gICAgfSBlbHNlIGlmIChjbWQgPT09ICdkZWxldGVTZXNzaW9uJykge1xuICAgICAgdGhpcy5sb2dFdmVudChFVkVOVF9TRVNTSU9OX1FVSVRfRE9ORSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0VW5leHBlY3RlZFNodXRkb3duIChlcnIgPSBuZXcgZXJyb3JzLk5vU3VjaERyaXZlckVycm9yKCdUaGUgZHJpdmVyIHdhcyB1bmV4cGVjdGVkbHkgc2h1dCBkb3duIScpKSB7XG4gICAgdGhpcy51bmV4cGVjdGVkU2h1dGRvd25EZWZlcnJlZC5yZWplY3QoZXJyKTsgLy8gYWxsb3cgb3RoZXJzIHRvIGxpc3RlbiBmb3IgdGhpc1xuICAgIHRoaXMuc2h1dGRvd25VbmV4cGVjdGVkbHkgPSB0cnVlO1xuICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbih0aGlzLnNlc3Npb25JZCk7XG4gICAgdGhpcy5zaHV0ZG93blVuZXhwZWN0ZWRseSA9IGZhbHNlO1xuICAgIHRoaXMuY3VyQ29tbWFuZENhbmNlbGxhYmxlLmNhbmNlbChlcnIpO1xuICB9XG5cbiAgdmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3kgKHN0cmF0ZWd5LCB3ZWJDb250ZXh0ID0gZmFsc2UpIHtcbiAgICBsZXQgdmFsaWRTdHJhdGVnaWVzID0gdGhpcy5sb2NhdG9yU3RyYXRlZ2llcztcbiAgICBsb2cuZGVidWcoYFZhbGlkIGxvY2F0b3Igc3RyYXRlZ2llcyBmb3IgdGhpcyByZXF1ZXN0OiAke3ZhbGlkU3RyYXRlZ2llcy5qb2luKCcsICcpfWApO1xuXG4gICAgaWYgKHdlYkNvbnRleHQpIHtcbiAgICAgIHZhbGlkU3RyYXRlZ2llcyA9IHZhbGlkU3RyYXRlZ2llcy5jb25jYXQodGhpcy53ZWJMb2NhdG9yU3RyYXRlZ2llcyk7XG4gICAgfVxuXG4gICAgaWYgKCFfLmluY2x1ZGVzKHZhbGlkU3RyYXRlZ2llcywgc3RyYXRlZ3kpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRTZWxlY3RvckVycm9yKGBMb2NhdG9yIFN0cmF0ZWd5ICcke3N0cmF0ZWd5fScgaXMgbm90IHN1cHBvcnRlZCBmb3IgdGhpcyBzZXNzaW9uYCk7XG4gICAgfVxuICB9XG5cbiAgLypcbiAgICogUmVzdGFydCB0aGUgc2Vzc2lvbiB3aXRoIHRoZSBvcmlnaW5hbCBjYXBzLFxuICAgKiBwcmVzZXJ2aW5nIHRoZSB0aW1lb3V0IGNvbmZpZy5cbiAgICovXG4gIGFzeW5jIHJlc2V0ICgpIHtcbiAgICBsb2cuZGVidWcoJ1Jlc2V0dGluZyBhcHAgbWlkLXNlc3Npb24nKTtcbiAgICBsb2cuZGVidWcoJ1J1bm5pbmcgZ2VuZXJpYyBmdWxsIHJlc2V0Jyk7XG5cbiAgICAvLyBwcmVzZXJ2aW5nIHN0YXRlXG4gICAgbGV0IGN1cnJlbnRDb25maWcgPSB7fTtcbiAgICBmb3IgKGxldCBwcm9wZXJ0eSBvZiBbJ2ltcGxpY2l0V2FpdE1zJywgJ25ld0NvbW1hbmRUaW1lb3V0TXMnLCAnc2Vzc2lvbklkJywgJ3Jlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24nXSkge1xuICAgICAgY3VycmVudENvbmZpZ1twcm9wZXJ0eV0gPSB0aGlzW3Byb3BlcnR5XTtcbiAgICB9XG5cbiAgICAvLyBXZSBhbHNvIG5lZWQgdG8gcHJlc2VydmUgdGhlIHVuZXhwZWN0ZWQgc2h1dGRvd24sIGFuZCBtYWtlIHN1cmUgaXQgaXMgbm90IGNhbmNlbGxlZCBkdXJpbmcgcmVzZXQuXG4gICAgdGhpcy5yZXNldE9uVW5leHBlY3RlZFNodXRkb3duID0gKCkgPT4ge307XG5cbiAgICAvLyBDb25zdHJ1Y3QgdGhlIGFyZ3VtZW50cyBmb3IgY3JlYXRlU2Vzc2lvbiBkZXBlbmRpbmcgb24gdGhlIHByb3RvY29sIHR5cGVcbiAgICBjb25zdCBhcmdzID0gdGhpcy5wcm90b2NvbCA9PT0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuVzNDID9cbiAgICAgIFt1bmRlZmluZWQsIHVuZGVmaW5lZCwge2Fsd2F5c01hdGNoOiB0aGlzLmNhcHMsIGZpcnN0TWF0Y2g6IFt7fV19XSA6XG4gICAgICBbdGhpcy5jYXBzXTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmRlbGV0ZVNlc3Npb24odGhpcy5zZXNzaW9uSWQpO1xuICAgICAgbG9nLmRlYnVnKCdSZXN0YXJ0aW5nIGFwcCcpO1xuICAgICAgYXdhaXQgdGhpcy5jcmVhdGVTZXNzaW9uKC4uLmFyZ3MpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICAvLyBhbHdheXMgcmVzdG9yZSBzdGF0ZS5cbiAgICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnMoY3VycmVudENvbmZpZykpIHtcbiAgICAgICAgdGhpc1trZXldID0gdmFsdWU7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuICB9XG5cbiAgYXN5bmMgZ2V0U3dpcGVPcHRpb25zIChnZXN0dXJlcywgdG91Y2hDb3VudCA9IDEpIHtcbiAgICBsZXQgc3RhcnRYID0gdGhpcy5oZWxwZXJzLmdldENvb3JkRGVmYXVsdChnZXN0dXJlc1swXS5vcHRpb25zLngpLFxuICAgICAgICBzdGFydFkgPSB0aGlzLmhlbHBlcnMuZ2V0Q29vcmREZWZhdWx0KGdlc3R1cmVzWzBdLm9wdGlvbnMueSksXG4gICAgICAgIGVuZFggPSB0aGlzLmhlbHBlcnMuZ2V0Q29vcmREZWZhdWx0KGdlc3R1cmVzWzJdLm9wdGlvbnMueCksXG4gICAgICAgIGVuZFkgPSB0aGlzLmhlbHBlcnMuZ2V0Q29vcmREZWZhdWx0KGdlc3R1cmVzWzJdLm9wdGlvbnMueSksXG4gICAgICAgIGR1cmF0aW9uID0gdGhpcy5oZWxwZXJzLmdldFN3aXBlVG91Y2hEdXJhdGlvbihnZXN0dXJlc1sxXSksXG4gICAgICAgIGVsZW1lbnQgPSBnZXN0dXJlc1swXS5vcHRpb25zLmVsZW1lbnQsXG4gICAgICAgIGRlc3RFbGVtZW50ID0gZ2VzdHVyZXNbMl0ub3B0aW9ucy5lbGVtZW50IHx8IGdlc3R1cmVzWzBdLm9wdGlvbnMuZWxlbWVudDtcblxuICAgIC8vIHRoZXJlJ3Mgbm8gZGVzdGluYXRpb24gZWxlbWVudCBoYW5kbGluZyBpbiBib290c3RyYXAgYW5kIHNpbmNlIGl0IGFwcGxpZXMgdG8gYWxsIHBsYXRmb3Jtcywgd2UgaGFuZGxlIGl0IGhlcmVcbiAgICBpZiAodXRpbC5oYXNWYWx1ZShkZXN0RWxlbWVudCkpIHtcbiAgICAgIGxldCBsb2NSZXN1bHQgPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KGRlc3RFbGVtZW50KTtcbiAgICAgIGxldCBzaXplUmVzdWx0ID0gYXdhaXQgdGhpcy5nZXRTaXplKGRlc3RFbGVtZW50KTtcbiAgICAgIGxldCBvZmZzZXRYID0gKE1hdGguYWJzKGVuZFgpIDwgMSAmJiBNYXRoLmFicyhlbmRYKSA+IDApID8gc2l6ZVJlc3VsdC53aWR0aCAqIGVuZFggOiBlbmRYO1xuICAgICAgbGV0IG9mZnNldFkgPSAoTWF0aC5hYnMoZW5kWSkgPCAxICYmIE1hdGguYWJzKGVuZFkpID4gMCkgPyBzaXplUmVzdWx0LmhlaWdodCAqIGVuZFkgOiBlbmRZO1xuICAgICAgZW5kWCA9IGxvY1Jlc3VsdC54ICsgb2Zmc2V0WDtcbiAgICAgIGVuZFkgPSBsb2NSZXN1bHQueSArIG9mZnNldFk7XG4gICAgICAvLyBpZiB0aGUgdGFyZ2V0IGVsZW1lbnQgd2FzIHByb3ZpZGVkLCB0aGUgY29vcmRpbmF0ZXMgZm9yIHRoZSBkZXN0aW5hdGlvbiBuZWVkIHRvIGJlIHJlbGF0aXZlIHRvIGl0LlxuICAgICAgaWYgKHV0aWwuaGFzVmFsdWUoZWxlbWVudCkpIHtcbiAgICAgICAgbGV0IGZpcnN0RWxMb2NhdGlvbiA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcoZWxlbWVudCk7XG4gICAgICAgIGVuZFggLT0gZmlyc3RFbExvY2F0aW9uLng7XG4gICAgICAgIGVuZFkgLT0gZmlyc3RFbExvY2F0aW9uLnk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIGNsaWVudHMgYXJlIHJlc3BvbnNpYmxlIHRvIHVzZSB0aGVzZSBvcHRpb25zIGNvcnJlY3RseVxuICAgIHJldHVybiB7c3RhcnRYLCBzdGFydFksIGVuZFgsIGVuZFksIGR1cmF0aW9uLCB0b3VjaENvdW50LCBlbGVtZW50fTtcbiAgfVxuXG4gIHByb3h5QWN0aXZlICgvKiBzZXNzaW9uSWQgKi8pIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBnZXRQcm94eUF2b2lkTGlzdCAoLyogc2Vzc2lvbklkICovKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgY2FuUHJveHkgKC8qIHNlc3Npb25JZCAqLykge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXaGV0aGVyIGEgZ2l2ZW4gY29tbWFuZCByb3V0ZSAoZXhwcmVzc2VkIGFzIG1ldGhvZCBhbmQgdXJsKSBzaG91bGQgbm90IGJlXG4gICAqIHByb3hpZWQgYWNjb3JkaW5nIHRvIHRoaXMgZHJpdmVyXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzZXNzaW9uSWQgLSB0aGUgY3VycmVudCBzZXNzaW9uSWQgKGluIGNhc2UgdGhlIGRyaXZlciBydW5zXG4gICAqIG11bHRpcGxlIHNlc3Npb24gaWRzIGFuZCByZXF1aXJlcyBpdCkuIFRoaXMgaXMgbm90IHVzZWQgaW4gdGhpcyBtZXRob2QgYnV0XG4gICAqIHNob3VsZCBiZSBtYWRlIGF2YWlsYWJsZSB0byBvdmVycmlkZGVuIG1ldGhvZHMuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2QgLSBIVFRQIG1ldGhvZCBvZiB0aGUgcm91dGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIHVybCBvZiB0aGUgcm91dGVcbiAgICpcbiAgICogQHJldHVybnMge2Jvb2xlYW59IC0gd2hldGhlciB0aGUgcm91dGUgc2hvdWxkIGJlIGF2b2lkZWRcbiAgICovXG4gIHByb3h5Um91dGVJc0F2b2lkZWQgKHNlc3Npb25JZCwgbWV0aG9kLCB1cmwpIHtcbiAgICBmb3IgKGxldCBhdm9pZFNjaGVtYSBvZiB0aGlzLmdldFByb3h5QXZvaWRMaXN0KHNlc3Npb25JZCkpIHtcbiAgICAgIGlmICghXy5pc0FycmF5KGF2b2lkU2NoZW1hKSB8fCBhdm9pZFNjaGVtYS5sZW5ndGggIT09IDIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm94eSBhdm9pZGFuY2UgbXVzdCBiZSBhIGxpc3Qgb2YgcGFpcnMnKTtcbiAgICAgIH1cbiAgICAgIGxldCBbYXZvaWRNZXRob2QsIGF2b2lkUGF0aFJlZ2V4XSA9IGF2b2lkU2NoZW1hO1xuICAgICAgaWYgKCFfLmluY2x1ZGVzKFsnR0VUJywgJ1BPU1QnLCAnREVMRVRFJ10sIGF2b2lkTWV0aG9kKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVucmVjb2duaXplZCBwcm94eSBhdm9pZGFuY2UgbWV0aG9kICcke2F2b2lkTWV0aG9kfSdgKTtcbiAgICAgIH1cbiAgICAgIGlmICghXy5pc1JlZ0V4cChhdm9pZFBhdGhSZWdleCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm94eSBhdm9pZGFuY2UgcGF0aCBtdXN0IGJlIGEgcmVndWxhciBleHByZXNzaW9uJyk7XG4gICAgICB9XG4gICAgICBsZXQgbm9ybWFsaXplZFVybCA9IHVybC5yZXBsYWNlKC9eXFwvd2RcXC9odWIvLCAnJyk7XG4gICAgICBpZiAoYXZvaWRNZXRob2QgPT09IG1ldGhvZCAmJiBhdm9pZFBhdGhSZWdleC50ZXN0KG5vcm1hbGl6ZWRVcmwpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBhZGRNYW5hZ2VkRHJpdmVyIChkcml2ZXIpIHtcbiAgICB0aGlzLm1hbmFnZWREcml2ZXJzLnB1c2goZHJpdmVyKTtcbiAgfVxuXG4gIGdldE1hbmFnZWREcml2ZXJzICgpIHtcbiAgICByZXR1cm4gdGhpcy5tYW5hZ2VkRHJpdmVycztcbiAgfVxuXG4gIHJlZ2lzdGVySW1hZ2VFbGVtZW50IChpbWdFbCkge1xuICAgIHRoaXMuX2ltZ0VsQ2FjaGUuc2V0KGltZ0VsLmlkLCBpbWdFbCk7XG4gICAgY29uc3QgcHJvdG9LZXkgPSB0aGlzLmlzVzNDUHJvdG9jb2woKSA/IFczQ19FTEVNRU5UX0tFWSA6IE1KU09OV1BfRUxFTUVOVF9LRVk7XG4gICAgcmV0dXJuIGltZ0VsLmFzRWxlbWVudChwcm90b0tleSk7XG4gIH1cbn1cblxuQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wgPSB7XG4gIFczQzogJ1czQycsXG4gIE1KU09OV1A6ICdNSlNPTldQJyxcbn07XG5cbmZvciAobGV0IFtjbWQsIGZuXSBvZiBfLnRvUGFpcnMoY29tbWFuZHMpKSB7XG4gIEJhc2VEcml2ZXIucHJvdG90eXBlW2NtZF0gPSBmbjtcbn1cblxuZXhwb3J0IHsgQmFzZURyaXZlciB9O1xuZXhwb3J0IGRlZmF1bHQgQmFzZURyaXZlcjtcbiJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvZHJpdmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
