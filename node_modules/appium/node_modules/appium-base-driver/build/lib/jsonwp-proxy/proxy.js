"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.JWProxy = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _status = require("../jsonwp-status/status");

var _errors = require("../protocol/errors");

var _driver = _interopRequireDefault(require("../basedriver/driver"));

var _routes = require("../protocol/routes");

var _protocolConverter = _interopRequireDefault(require("./protocol-converter"));

const log = _appiumSupport.logger.getLogger('WD Proxy');

const LOG_OBJ_LENGTH = 1024;
const DEFAULT_REQUEST_TIMEOUT = 240000;
const {
  MJSONWP,
  W3C
} = _driver.default.DRIVER_PROTOCOL;

class JWProxy {
  constructor(opts = {}) {
    Object.assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: '/wd/hub',
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT,
      keepAlive: false
    }, opts);
    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
    this._downstreamProtocol = null;
    this.protocolConverter = new _protocolConverter.default(this.proxy.bind(this));
  }

  async request(...args) {
    const currentRequest = (0, _requestPromise.default)(...args);

    this._activeRequests.push(currentRequest);

    return await currentRequest.finally(() => _lodash.default.pull(this._activeRequests, currentRequest));
  }

  getActiveRequestsCount() {
    return this._activeRequests.length;
  }

  cancelActiveRequests() {
    try {
      for (let r of this._activeRequests) {
        r.cancel();
      }
    } finally {
      this._activeRequests = [];
    }
  }

  endpointRequiresSessionId(endpoint) {
    return !_lodash.default.includes(['/session', '/sessions', '/status'], endpoint);
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
    this.protocolConverter.downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getUrlForProxy(url) {
    if (url === '') {
      url = '/';
    }

    const proxyBase = `${this.scheme}://${this.server}:${this.port}${this.base}`;
    const endpointRe = '(/(session|status))';
    let remainingUrl = '';

    if (/^http/.test(url)) {
      const first = new RegExp(`(https?://.+)${endpointRe}`).exec(url);

      if (!first) {
        throw new Error('Got a complete url but could not extract JWP endpoint');
      }

      remainingUrl = url.replace(first[1], '');
    } else if (new RegExp('^/').test(url)) {
      remainingUrl = url;
    } else {
      throw new Error(`Did not know what to do with url '${url}'`);
    }

    const stripPrefixRe = new RegExp('^.*?(/(session|status).*)$');

    if (stripPrefixRe.test(remainingUrl)) {
      remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
    }

    if (!new RegExp(endpointRe).test(remainingUrl)) {
      remainingUrl = `/session/${this.sessionId}${remainingUrl}`;
    }

    const requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

    if (requiresSessionId && this.sessionId === null) {
      throw new Error('Trying to proxy a session command without session id');
    }

    const sessionBaseRe = new RegExp('^/session/([^/]+)');

    if (sessionBaseRe.test(remainingUrl)) {
      const match = sessionBaseRe.exec(remainingUrl);
      remainingUrl = remainingUrl.replace(match[1], this.sessionId);
    } else if (requiresSessionId) {
      throw new Error(`Could not find :session section for url: ${remainingUrl}`);
    }

    remainingUrl = remainingUrl.replace(/\/$/, '');
    return proxyBase + remainingUrl;
  }

  async proxy(url, method, body = null) {
    method = method.toUpperCase();
    const newUrl = this.getUrlForProxy(url);
    const reqOpts = {
      agent: false,
      url: newUrl,
      method,
      headers: {
        'content-type': 'application/json; charset=utf-8',
        'user-agent': 'appium',
        accept: 'application/json, */*'
      },
      resolveWithFullResponse: true,
      timeout: this.timeout,
      forever: this.keepAlive
    };

    if (body !== null) {
      if (typeof body !== 'object') {
        body = JSON.parse(body);
      }

      reqOpts.json = body;
    }

    if (method === 'GET') {
      reqOpts.json = null;
    }

    log.debug(`Proxying [${method} ${url || '/'}] to [${method} ${newUrl}] ` + (body ? `with body: ${_lodash.default.truncate(JSON.stringify(body), {
      length: LOG_OBJ_LENGTH
    })}` : 'with no body'));
    let res, resBody;

    try {
      res = await this.request(reqOpts);
      resBody = res.body;
      log.debug(`Got response with status ${res.statusCode}: ${_lodash.default.truncate(JSON.stringify(resBody), {
        length: LOG_OBJ_LENGTH
      })}`);

      if (/\/session$/.test(url) && method === 'POST') {
        if (res.statusCode === 200) {
          this.sessionId = resBody.sessionId;
        } else if (res.statusCode === 303) {
          this.sessionId = /\/session\/([^/]+)/.exec(resBody)[1];
        }
      }

      const resBodyObj = _appiumSupport.util.safeJsonParse(resBody);

      if (!this.downstreamProtocol) {
        this.downstreamProtocol = this.getProtocolFromResBody(resBodyObj);
        log.debug(`Determined that the downstream protocol for proxy is ${this.downstreamProtocol}`);
      }

      if (res.statusCode < 400 && this.downstreamProtocol === MJSONWP && parseInt(resBodyObj.status, 10) !== 0) {
        const message = `The request to ${url} has failed`;
        const err = new Error(message);
        err.message = message;
        err.error = resBody;
        err.statusCode = 500;
        throw err;
      }
    } catch (e) {
      let responseError = e.error;

      try {
        responseError = JSON.parse(responseError);
      } catch (e1) {
        log.warn(`Got an unexpected response: ` + _lodash.default.truncate(_lodash.default.isString(responseError) ? responseError : JSON.stringify(responseError), {
          length: 300
        }));
      }

      throw new _errors.errors.ProxyRequestError(`Could not proxy command to remote server. ` + `Original error: ${e.message}`, responseError, e.statusCode);
    }

    return [res, resBody];
  }

  getProtocolFromResBody(resBody) {
    if (!_lodash.default.isPlainObject(resBody)) {
      try {
        resBody = JSON.parse(resBody);
      } catch (err) {
        return;
      }
    }

    if (_appiumSupport.util.hasValue(resBody.status)) {
      return MJSONWP;
    }

    if (_appiumSupport.util.hasValue(resBody.value)) {
      return W3C;
    }
  }

  requestToCommandName(url, method) {
    const extractCommandName = pattern => {
      const pathMatch = pattern.exec(url);
      return pathMatch ? (0, _routes.routeToCommandName)(pathMatch[1], method) : null;
    };

    let commandName = (0, _routes.routeToCommandName)(url, method);

    if (!commandName && _lodash.default.includes(url, '/wd/hub/session/')) {
      commandName = extractCommandName(/\/wd\/hub\/session\/[^/]+(.+)/);
    }

    if (!commandName && _lodash.default.includes(url, '/wd/hub/')) {
      commandName = extractCommandName(/\/wd\/hub(\/.+)/);
    }

    return commandName;
  }

  async proxyCommand(url, method, body = null) {
    const commandName = this.requestToCommandName(url, method);

    if (!commandName) {
      return await this.proxy(url, method, body);
    }

    log.debug(`Matched '${url}' to command name '${commandName}'`);
    return await this.protocolConverter.convertAndProxy(commandName, url, method, body);
  }

  async command(url, method, body = null) {
    let response;
    let resBody;

    try {
      [response, resBody] = await this.proxyCommand(url, method, body);
    } catch (err) {
      if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
        throw err.getActualError();
      }

      throw new _errors.errors.UnknownError(err.message);
    }

    resBody = _appiumSupport.util.safeJsonParse(resBody);
    const protocol = this.getProtocolFromResBody(resBody);

    if (protocol === MJSONWP) {
      if (response.statusCode === 200 && resBody.status === 0) {
        return resBody.value;
      }

      const status = parseInt(resBody.status, 10);

      if (!isNaN(status) && status !== 0) {
        let message = resBody.value;

        if (_lodash.default.has(message, 'message')) {
          message = message.message;
        }

        throw (0, _errors.errorFromMJSONWPStatusCode)(status, _lodash.default.isEmpty(message) ? (0, _status.getSummaryByCode)(status) : message);
      }
    } else if (protocol === W3C) {
      if (response.statusCode < 300) {
        return resBody.value;
      }

      if (_lodash.default.isPlainObject(resBody.value) && resBody.value.error) {
        throw (0, _errors.errorFromW3CJsonCode)(resBody.value.error, resBody.value.message, resBody.value.stacktrace);
      }
    } else if (response.statusCode === 200) {
      return resBody;
    }

    throw new _errors.errors.UnknownError(`Did not know what to do with response code '${response.statusCode}' ` + `and response body '${_lodash.default.truncate(JSON.stringify(resBody), {
      length: 300
    })}'`);
  }

  getSessionIdFromUrl(url) {
    const match = url.match(/\/session\/([^/]+)/);
    return match ? match[1] : null;
  }

  async proxyReqRes(req, res) {
    let [response, body] = await this.proxyCommand(req.originalUrl, req.method, req.body);
    res.headers = response.headers;
    res.set('content-type', response.headers['content-type']);
    body = _appiumSupport.util.safeJsonParse(body);

    if (body && body.sessionId) {
      const reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

      if (reqSessionId) {
        log.info(`Replacing sessionId ${body.sessionId} with ${reqSessionId}`);
        body.sessionId = reqSessionId;
      } else if (this.sessionId) {
        log.info(`Replacing sessionId ${body.sessionId} with ${this.sessionId}`);
        body.sessionId = this.sessionId;
      }
    }

    res.status(response.statusCode).send(JSON.stringify(body));
  }

}

exports.JWProxy = JWProxy;
var _default = JWProxy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwibmFtZXMiOlsibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiTE9HX09CSl9MRU5HVEgiLCJERUZBVUxUX1JFUVVFU1RfVElNRU9VVCIsIk1KU09OV1AiLCJXM0MiLCJCYXNlRHJpdmVyIiwiRFJJVkVSX1BST1RPQ09MIiwiSldQcm94eSIsImNvbnN0cnVjdG9yIiwib3B0cyIsIk9iamVjdCIsImFzc2lnbiIsInNjaGVtZSIsInNlcnZlciIsInBvcnQiLCJiYXNlIiwic2Vzc2lvbklkIiwidGltZW91dCIsImtlZXBBbGl2ZSIsInRvTG93ZXJDYXNlIiwiX2FjdGl2ZVJlcXVlc3RzIiwiX2Rvd25zdHJlYW1Qcm90b2NvbCIsInByb3RvY29sQ29udmVydGVyIiwiUHJvdG9jb2xDb252ZXJ0ZXIiLCJwcm94eSIsImJpbmQiLCJyZXF1ZXN0IiwiYXJncyIsImN1cnJlbnRSZXF1ZXN0IiwicHVzaCIsImZpbmFsbHkiLCJfIiwicHVsbCIsImdldEFjdGl2ZVJlcXVlc3RzQ291bnQiLCJsZW5ndGgiLCJjYW5jZWxBY3RpdmVSZXF1ZXN0cyIsInIiLCJjYW5jZWwiLCJlbmRwb2ludFJlcXVpcmVzU2Vzc2lvbklkIiwiZW5kcG9pbnQiLCJpbmNsdWRlcyIsImRvd25zdHJlYW1Qcm90b2NvbCIsInZhbHVlIiwiZ2V0VXJsRm9yUHJveHkiLCJ1cmwiLCJwcm94eUJhc2UiLCJlbmRwb2ludFJlIiwicmVtYWluaW5nVXJsIiwidGVzdCIsImZpcnN0IiwiUmVnRXhwIiwiZXhlYyIsIkVycm9yIiwicmVwbGFjZSIsInN0cmlwUHJlZml4UmUiLCJyZXF1aXJlc1Nlc3Npb25JZCIsInNlc3Npb25CYXNlUmUiLCJtYXRjaCIsIm1ldGhvZCIsImJvZHkiLCJ0b1VwcGVyQ2FzZSIsIm5ld1VybCIsInJlcU9wdHMiLCJhZ2VudCIsImhlYWRlcnMiLCJhY2NlcHQiLCJyZXNvbHZlV2l0aEZ1bGxSZXNwb25zZSIsImZvcmV2ZXIiLCJKU09OIiwicGFyc2UiLCJqc29uIiwiZGVidWciLCJ0cnVuY2F0ZSIsInN0cmluZ2lmeSIsInJlcyIsInJlc0JvZHkiLCJzdGF0dXNDb2RlIiwicmVzQm9keU9iaiIsInV0aWwiLCJzYWZlSnNvblBhcnNlIiwiZ2V0UHJvdG9jb2xGcm9tUmVzQm9keSIsInBhcnNlSW50Iiwic3RhdHVzIiwibWVzc2FnZSIsImVyciIsImVycm9yIiwiZSIsInJlc3BvbnNlRXJyb3IiLCJlMSIsIndhcm4iLCJpc1N0cmluZyIsImVycm9ycyIsIlByb3h5UmVxdWVzdEVycm9yIiwiaXNQbGFpbk9iamVjdCIsImhhc1ZhbHVlIiwicmVxdWVzdFRvQ29tbWFuZE5hbWUiLCJleHRyYWN0Q29tbWFuZE5hbWUiLCJwYXR0ZXJuIiwicGF0aE1hdGNoIiwiY29tbWFuZE5hbWUiLCJwcm94eUNvbW1hbmQiLCJjb252ZXJ0QW5kUHJveHkiLCJjb21tYW5kIiwicmVzcG9uc2UiLCJnZXRBY3R1YWxFcnJvciIsIlVua25vd25FcnJvciIsInByb3RvY29sIiwiaXNOYU4iLCJoYXMiLCJpc0VtcHR5Iiwic3RhY2t0cmFjZSIsImdldFNlc3Npb25JZEZyb21VcmwiLCJwcm94eVJlcVJlcyIsInJlcSIsIm9yaWdpbmFsVXJsIiwic2V0IiwicmVxU2Vzc2lvbklkIiwiaW5mbyIsInNlbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsR0FBRyxHQUFHQyxzQkFBT0MsU0FBUCxDQUFpQixVQUFqQixDQUFaOztBQUVBLE1BQU1DLGNBQWMsR0FBRyxJQUF2QjtBQUNBLE1BQU1DLHVCQUF1QixHQUFHLE1BQWhDO0FBRUEsTUFBTTtBQUFDQyxFQUFBQSxPQUFEO0FBQVVDLEVBQUFBO0FBQVYsSUFBaUJDLGdCQUFXQyxlQUFsQzs7QUFFQSxNQUFNQyxPQUFOLENBQWM7QUFDWkMsRUFBQUEsV0FBVyxDQUFFQyxJQUFJLEdBQUcsRUFBVCxFQUFhO0FB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QUcsQ0FBQ3lDLEdBQUosQ0FBUSxjQUFSLEVBQXdCWixRQUFRLENBQUN2QyxPQUFULENBQWlCLGNBQWpCLENBQXhCO0FBSUFMLElBQUFBLElBQUksR0FBR21CLG9CQUFLQyxhQUFMLENBQW1CcEIsSUFBbkIsQ0FBUDs7QUFDQSxRQUFJQSxJQUFJLElBQUlBLElBQUksQ0FBQzNDLFNBQWpCLEVBQTRCO0FBQzFCLFlBQU1vRyxZQUFZLEdBQUcsS0FBS0wsbUJBQUwsQ0FBeUJFLEdBQUcsQ0FBQ0MsV0FBN0IsQ0FBckI7O0FBQ0EsVUFBSUUsWUFBSixFQUFrQjtBQUNoQnRILFFBQUFBLEdBQUcsQ0FBQ3VILElBQUosQ0FBVSx1QkFBc0IxRCxJQUFJLENBQUMzQyxTQUFVLFNBQVFvRyxZQUFhLEVBQXBFO0FBQ0F6RCxRQUFBQSxJQUFJLENBQUMzQyxTQUFMLEdBQWlCb0csWUFBakI7QUFDRCxPQUhELE1BR08sSUFBSSxLQUFLcEcsU0FBVCxFQUFvQjtBQUN6QmxCLFFBQUFBLEdBQUcsQ0FBQ3VILElBQUosQ0FBVSx1QkFBc0IxRCxJQUFJLENBQUMzQyxTQUFVLFNBQVEsS0FBS0EsU0FBVSxFQUF0RTtBQUNBMkMsUUFBQUEsSUFBSSxDQUFDM0MsU0FBTCxHQUFpQixLQUFLQSxTQUF0QjtBQUNEO0FBQ0Y7O0FBQ0QwRCxJQUFBQSxHQUFHLENBQUNRLE1BQUosQ0FBV3FCLFFBQVEsQ0FBQzNCLFVBQXBCLEVBQWdDMEMsSUFBaEMsQ0FBcUNsRCxJQUFJLENBQUNLLFNBQUwsQ0FBZWQsSUFBZixDQUFyQztBQUNEOztBQXZSVzs7O2VBMlJDcEQsTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBsb2dnZXIsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHsgZ2V0U3VtbWFyeUJ5Q29kZSB9IGZyb20gJy4uL2pzb253cC1zdGF0dXMvc3RhdHVzJztcbmltcG9ydCB7IGVycm9ycywgaXNFcnJvclR5cGUsIGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlLCBlcnJvckZyb21XM0NKc29uQ29kZSB9IGZyb20gJy4uL3Byb3RvY29sL2Vycm9ycyc7XG5pbXBvcnQgQmFzZURyaXZlciBmcm9tICcuLi9iYXNlZHJpdmVyL2RyaXZlcic7XG5pbXBvcnQgeyByb3V0ZVRvQ29tbWFuZE5hbWUgfSBmcm9tICcuLi9wcm90b2NvbC9yb3V0ZXMnO1xuaW1wb3J0IFByb3RvY29sQ29udmVydGVyIGZyb20gJy4vcHJvdG9jb2wtY29udmVydGVyJztcblxuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdXRCBQcm94eScpO1xuLy8gVE9ETzogTWFrZSB0aGlzIHZhbHVlIGNvbmZpZ3VyYWJsZSBhcyBhIHNlcnZlciBzaWRlIGNhcGFiaWxpdHlcbmNvbnN0IExPR19PQkpfTEVOR1RIID0gMTAyNDsgLy8gTUFYIExFTkdUSCBMb2dnZWQgdG8gZmlsZSAvIGNvbnNvbGVcbmNvbnN0IERFRkFVTFRfUkVRVUVTVF9USU1FT1VUID0gMjQwMDAwO1xuXG5jb25zdCB7TUpTT05XUCwgVzNDfSA9IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MO1xuXG5jbGFzcyBKV1Byb3h5IHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIE9iamVjdC5hc3NpZ24odGhpcywge1xuICAgICAgc2NoZW1lOiAnaHR0cCcsXG4gICAgICBzZXJ2ZXI6ICdsb2NhbGhvc3QnLFxuICAgICAgcG9ydDogNDQ0NCxcbiAgICAgIGJhc2U6ICcvd2QvaHViJyxcbiAgICAgIHNlc3Npb25JZDogbnVsbCxcbiAgICAgIHRpbWVvdXQ6IERFRkFVTFRfUkVRVUVTVF9USU1FT1VULFxuICAgICAga2VlcEFsaXZlOiBmYWxzZSxcbiAgICB9LCBvcHRzKTtcbiAgICB0aGlzLnNjaGVtZSA9IHRoaXMuc2NoZW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgdGhpcy5fYWN0aXZlUmVxdWVzdHMgPSBbXTtcbiAgICB0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2wgPSBudWxsO1xuICAgIHRoaXMucHJvdG9jb2xDb252ZXJ0ZXIgPSBuZXcgUHJvdG9jb2xDb252ZXJ0ZXIodGhpcy5wcm94eS5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIC8vIGFic3RyYWN0IHRoZSBjYWxsIGJlaGluZCBhIG1lbWJlciBmdW5jdGlvblxuICAvLyBzbyB0aGF0IHdlIGNhbiBtb2NrIGl0IGluIHRlc3RzXG4gIGFzeW5jIHJlcXVlc3QgKC4uLmFyZ3MpIHtcbiAgICBjb25zdCBjdXJyZW50UmVxdWVzdCA9IHJlcXVlc3QoLi4uYXJncyk7XG4gICAgdGhpcy5fYWN0aXZlUmVxdWVzdHMucHVzaChjdXJyZW50UmVxdWVzdCk7XG4gICAgcmV0dXJuIGF3YWl0IGN1cnJlbnRSZXF1ZXN0LmZpbmFsbHkoKCkgPT4gXy5wdWxsKHRoaXMuX2FjdGl2ZVJlcXVlc3RzLCBjdXJyZW50UmVxdWVzdCkpO1xuICB9XG5cbiAgZ2V0QWN0aXZlUmVxdWVzdHNDb3VudCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FjdGl2ZVJlcXVlc3RzLmxlbmd0aDtcbiAgfVxuXG4gIGNhbmNlbEFjdGl2ZVJlcXVlc3RzICgpIHtcbiAgICB0cnkge1xuICAgICAgZm9yIChsZXQgciBvZiB0aGlzLl9hY3RpdmVSZXF1ZXN0cykge1xuICAgICAgICByLmNhbmNlbCgpO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICAgIH1cbiAgfVxuXG4gIGVuZHBvaW50UmVxdWlyZXNTZXNzaW9uSWQgKGVuZHBvaW50KSB7XG4gICAgcmV0dXJuICFfLmluY2x1ZGVzKFsnL3Nlc3Npb24nLCAnL3Nlc3Npb25zJywgJy9zdGF0dXMnXSwgZW5kcG9pbnQpO1xuICB9XG5cbiAgc2V0IGRvd25zdHJlYW1Qcm90b2NvbCAodmFsdWUpIHtcbiAgICB0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2wgPSB2YWx1ZTtcbiAgICB0aGlzLnByb3RvY29sQ29udmVydGVyLmRvd25zdHJlYW1Qcm90b2NvbCA9IHZhbHVlO1xuICB9XG5cbiAgZ2V0IGRvd25zdHJlYW1Qcm90b2NvbCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbDtcbiAgfVxuXG4gIGdldFVybEZvclByb3h5ICh1cmwpIHtcbiAgICBpZiAodXJsID09PSAnJykge1xuICAgICAgdXJsID0gJy8nO1xuICAgIH1cbiAgICBjb25zdCBwcm94eUJhc2UgPSBgJHt0aGlzLnNjaGVtZX06Ly8ke3RoaXMuc2VydmVyfToke3RoaXMucG9ydH0ke3RoaXMuYmFzZX1gO1xuICAgIGNvbnN0IGVuZHBvaW50UmUgPSAnKC8oc2Vzc2lvbnxzdGF0dXMpKSc7XG4gICAgbGV0IHJlbWFpbmluZ1VybCA9ICcnO1xuICAgIGlmICgvXmh0dHAvLnRlc3QodXJsKSkge1xuICAgICAgY29uc3QgZmlyc3QgPSAobmV3IFJlZ0V4cChgKGh0dHBzPzovLy4rKSR7ZW5kcG9pbnRSZX1gKSkuZXhlYyh1cmwpO1xuICAgICAgaWYgKCFmaXJzdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dvdCBhIGNvbXBsZXRlIHVybCBidXQgY291bGQgbm90IGV4dHJhY3QgSldQIGVuZHBvaW50Jyk7XG4gICAgICB9XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmwucmVwbGFjZShmaXJzdFsxXSwgJycpO1xuICAgIH0gZWxzZSBpZiAoKG5ldyBSZWdFeHAoJ14vJykpLnRlc3QodXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gdXJsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYERpZCBub3Qga25vdyB3aGF0IHRvIGRvIHdpdGggdXJsICcke3VybH0nYCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RyaXBQcmVmaXhSZSA9IG5ldyBSZWdFeHAoJ14uKj8oLyhzZXNzaW9ufHN0YXR1cykuKikkJyk7XG4gICAgaWYgKHN0cmlwUHJlZml4UmUudGVzdChyZW1haW5pbmdVcmwpKSB7XG4gICAgICByZW1haW5pbmdVcmwgPSBzdHJpcFByZWZpeFJlLmV4ZWMocmVtYWluaW5nVXJsKVsxXTtcbiAgICB9XG5cbiAgICBpZiAoIShuZXcgUmVnRXhwKGVuZHBvaW50UmUpKS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IGAvc2Vzc2lvbi8ke3RoaXMuc2Vzc2lvbklkfSR7cmVtYWluaW5nVXJsfWA7XG4gICAgfVxuXG4gICAgY29uc3QgcmVxdWlyZXNTZXNzaW9uSWQgPSB0aGlzLmVuZHBvaW50UmVxdWlyZXNTZXNzaW9uSWQocmVtYWluaW5nVXJsKTtcblxuICAgIGlmIChyZXF1aXJlc1Nlc3Npb25JZCAmJiB0aGlzLnNlc3Npb25JZCA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gcHJveHkgYSBzZXNzaW9uIGNvbW1hbmQgd2l0aG91dCBzZXNzaW9uIGlkJyk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2Vzc2lvbkJhc2VSZSA9IG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi8oW14vXSspJyk7XG4gICAgaWYgKHNlc3Npb25CYXNlUmUudGVzdChyZW1haW5pbmdVcmwpKSB7XG4gICAgICAvLyB3ZSBoYXZlIHNvbWV0aGluZyBsaWtlIC9zZXNzaW9uLzppZC9mb29iYXIsIHNvIHdlIG5lZWQgdG8gcmVwbGFjZVxuICAgICAgLy8gdGhlIHNlc3Npb24gaWRcbiAgICAgIGNvbnN0IG1hdGNoID0gc2Vzc2lvbkJhc2VSZS5leGVjKHJlbWFpbmluZ1VybCk7XG4gICAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZShtYXRjaFsxXSwgdGhpcy5zZXNzaW9uSWQpO1xuICAgIH0gZWxzZSBpZiAocmVxdWlyZXNTZXNzaW9uSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgOnNlc3Npb24gc2VjdGlvbiBmb3IgdXJsOiAke3JlbWFpbmluZ1VybH1gKTtcbiAgICB9XG4gICAgcmVtYWluaW5nVXJsID0gcmVtYWluaW5nVXJsLnJlcGxhY2UoL1xcLyQvLCAnJyk7IC8vIGNhbid0IGhhdmUgdHJhaWxpbmcgc2xhc2hlc1xuXG4gICAgcmV0dXJuIHByb3h5QmFzZSArIHJlbWFpbmluZ1VybDtcbiAgfVxuXG4gIGFzeW5jIHByb3h5ICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBtZXRob2QgPSBtZXRob2QudG9VcHBlckNhc2UoKTtcbiAgICBjb25zdCBuZXdVcmwgPSB0aGlzLmdldFVybEZvclByb3h5KHVybCk7XG4gICAgY29uc3QgcmVxT3B0cyA9IHtcbiAgICAgIGFnZW50OiBmYWxzZSxcbiAgICAgIHVybDogbmV3VXJsLFxuICAgICAgbWV0aG9kLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnLFxuICAgICAgICAndXNlci1hZ2VudCc6ICdhcHBpdW0nLFxuICAgICAgICBhY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uLCAqLyonLFxuICAgICAgfSxcbiAgICAgIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlLFxuICAgICAgdGltZW91dDogdGhpcy50aW1lb3V0LFxuICAgICAgZm9yZXZlcjogdGhpcy5rZWVwQWxpdmUsXG4gICAgfTtcbiAgICBpZiAoYm9keSAhPT0gbnVsbCkge1xuICAgICAgaWYgKHR5cGVvZiBib2R5ICE9PSAnb2JqZWN0Jykge1xuICAgICAgICBib2R5ID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgIH1cbiAgICAgIHJlcU9wdHMuanNvbiA9IGJvZHk7XG4gICAgfVxuXG4gICAgLy8gR0VUIG1ldGhvZHMgc2hvdWxkbid0IGhhdmUgYW55IGJvZHkuIE1vc3Qgc2VydmVycyBhcmUgT0sgd2l0aCB0aGlzLCBidXQgV2ViRHJpdmVyQWdlbnQgdGhyb3dzIDQwMCBlcnJvcnNcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcmVxT3B0cy5qc29uID0gbnVsbDtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFByb3h5aW5nIFske21ldGhvZH0gJHt1cmwgfHwgJy8nfV0gdG8gWyR7bWV0aG9kfSAke25ld1VybH1dIGAgK1xuICAgICAgICAgICAgIChib2R5ID8gYHdpdGggYm9keTogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KGJvZHkpLCB7bGVuZ3RoOiBMT0dfT0JKX0xFTkdUSH0pfWAgOiAnd2l0aCBubyBib2R5JykpO1xuXG4gICAgbGV0IHJlcywgcmVzQm9keTtcbiAgICB0cnkge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5yZXF1ZXN0KHJlcU9wdHMpO1xuICAgICAgcmVzQm9keSA9IHJlcy5ib2R5O1xuICAgICAgbG9nLmRlYnVnKGBHb3QgcmVzcG9uc2Ugd2l0aCBzdGF0dXMgJHtyZXMuc3RhdHVzQ29kZX06ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShyZXNCb2R5KSwge2xlbmd0aDogTE9HX09CSl9MRU5HVEh9KX1gKTtcbiAgICAgIGlmICgvXFwvc2Vzc2lvbiQvLnRlc3QodXJsKSAmJiBtZXRob2QgPT09ICdQT1NUJykge1xuICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gcmVzQm9keS5zZXNzaW9uSWQ7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDMwMykge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gL1xcL3Nlc3Npb25cXC8oW14vXSspLy5leGVjKHJlc0JvZHkpWzFdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCByZXNCb2R5T2JqID0gdXRpbC5zYWZlSnNvblBhcnNlKHJlc0JvZHkpO1xuICAgICAgaWYgKCF0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCkge1xuICAgICAgICB0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCA9IHRoaXMuZ2V0UHJvdG9jb2xGcm9tUmVzQm9keShyZXNCb2R5T2JqKTtcbiAgICAgICAgbG9nLmRlYnVnKGBEZXRlcm1pbmVkIHRoYXQgdGhlIGRvd25zdHJlYW0gcHJvdG9jb2wgZm9yIHByb3h5IGlzICR7dGhpcy5kb3duc3RyZWFtUHJvdG9jb2x9YCk7XG4gICAgICB9XG4gICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPCA0MDAgJiYgdGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPT09IE1KU09OV1AgJiYgcGFyc2VJbnQocmVzQm9keU9iai5zdGF0dXMsIDEwKSAhPT0gMCkge1xuICAgICAgICAvLyBTb21lIHNlcnZlcnMsIGxpa2UgY2hyb21lZHJpdmVyIG1heSByZXR1cm4gcmVzcG9uc2UgY29kZSAyMDAgZm9yIG5vbi16ZXJvIEpTT05XUCBzdGF0dXNlc1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gYFRoZSByZXF1ZXN0IHRvICR7dXJsfSBoYXMgZmFpbGVkYDtcbiAgICAgICAgY29uc3QgZXJyID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgICAgICBlcnIubWVzc2FnZSA9IG1lc3NhZ2U7XG4gICAgICAgIGVyci5lcnJvciA9IHJlc0JvZHk7XG4gICAgICAgIGVyci5zdGF0dXNDb2RlID0gNTAwO1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbGV0IHJlc3BvbnNlRXJyb3IgPSBlLmVycm9yO1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmVzcG9uc2VFcnJvciA9IEpTT04ucGFyc2UocmVzcG9uc2VFcnJvcik7XG4gICAgICB9IGNhdGNoIChlMSkge1xuICAgICAgICBsb2cud2FybihgR290IGFuIHVuZXhwZWN0ZWQgcmVzcG9uc2U6IGAgK1xuICAgICAgICAgIF8udHJ1bmNhdGUoXy5pc1N0cmluZyhyZXNwb25zZUVycm9yKSA/IHJlc3BvbnNlRXJyb3IgOiBKU09OLnN0cmluZ2lmeShyZXNwb25zZUVycm9yKSwge2xlbmd0aDogMzAwfSkpO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Qcm94eVJlcXVlc3RFcnJvcihgQ291bGQgbm90IHByb3h5IGNvbW1hbmQgdG8gcmVtb3RlIHNlcnZlci4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gLCByZXNwb25zZUVycm9yLCBlLnN0YXR1c0NvZGUpO1xuICAgIH1cbiAgICByZXR1cm4gW3JlcywgcmVzQm9keV07XG4gIH1cblxuICBnZXRQcm90b2NvbEZyb21SZXNCb2R5IChyZXNCb2R5KSB7XG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3QocmVzQm9keSkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlc0JvZHkgPSBKU09OLnBhcnNlKHJlc0JvZHkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUocmVzQm9keS5zdGF0dXMpKSB7XG4gICAgICByZXR1cm4gTUpTT05XUDtcbiAgICB9XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUocmVzQm9keS52YWx1ZSkpIHtcbiAgICAgIHJldHVybiBXM0M7XG4gICAgfVxuICB9XG5cbiAgcmVxdWVzdFRvQ29tbWFuZE5hbWUgKHVybCwgbWV0aG9kKSB7XG4gICAgY29uc3QgZXh0cmFjdENvbW1hbmROYW1lID0gKHBhdHRlcm4pID0+IHtcbiAgICAgIGNvbnN0IHBhdGhNYXRjaCA9IHBhdHRlcm4uZXhlYyh1cmwpO1xuICAgICAgcmV0dXJuIHBhdGhNYXRjaCA/IHJvdXRlVG9Db21tYW5kTmFtZShwYXRoTWF0Y2hbMV0sIG1ldGhvZCkgOiBudWxsO1xuICAgIH07XG4gICAgbGV0IGNvbW1hbmROYW1lID0gcm91dGVUb0NvbW1hbmROYW1lKHVybCwgbWV0aG9kKTtcbiAgICBpZiAoIWNvbW1hbmROYW1lICYmIF8uaW5jbHVkZXModXJsLCAnL3dkL2h1Yi9zZXNzaW9uLycpKSB7XG4gICAgICBjb21tYW5kTmFtZSA9IGV4dHJhY3RDb21tYW5kTmFtZSgvXFwvd2RcXC9odWJcXC9zZXNzaW9uXFwvW14vXSsoLispLyk7XG4gICAgfVxuICAgIGlmICghY29tbWFuZE5hbWUgJiYgXy5pbmNsdWRlcyh1cmwsICcvd2QvaHViLycpKSB7XG4gICAgICBjb21tYW5kTmFtZSA9IGV4dHJhY3RDb21tYW5kTmFtZSgvXFwvd2RcXC9odWIoXFwvLispLyk7XG4gICAgfVxuICAgIHJldHVybiBjb21tYW5kTmFtZTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5Q29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgY29uc3QgY29tbWFuZE5hbWUgPSB0aGlzLnJlcXVlc3RUb0NvbW1hbmROYW1lKHVybCwgbWV0aG9kKTtcbiAgICBpZiAoIWNvbW1hbmROYW1lKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eSh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgTWF0Y2hlZCAnJHt1cmx9JyB0byBjb21tYW5kIG5hbWUgJyR7Y29tbWFuZE5hbWV9J2ApO1xuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJvdG9jb2xDb252ZXJ0ZXIuY29udmVydEFuZFByb3h5KGNvbW1hbmROYW1lLCB1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICBhc3luYyBjb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBsZXQgcmVzcG9uc2U7XG4gICAgbGV0IHJlc0JvZHk7XG4gICAgdHJ5IHtcbiAgICAgIFtyZXNwb25zZSwgcmVzQm9keV0gPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoaXNFcnJvclR5cGUoZXJyLCBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IpKSB7XG4gICAgICAgIHRocm93IGVyci5nZXRBY3R1YWxFcnJvcigpO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoZXJyLm1lc3NhZ2UpO1xuICAgIH1cbiAgICByZXNCb2R5ID0gdXRpbC5zYWZlSnNvblBhcnNlKHJlc0JvZHkpO1xuICAgIGNvbnN0IHByb3RvY29sID0gdGhpcy5nZXRQcm90b2NvbEZyb21SZXNCb2R5KHJlc0JvZHkpO1xuICAgIGlmIChwcm90b2NvbCA9PT0gTUpTT05XUCkge1xuICAgICAgLy8gR290IHJlc3BvbnNlIGluIE1KU09OV1AgZm9ybWF0XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwICYmIHJlc0JvZHkuc3RhdHVzID09PSAwKSB7XG4gICAgICAgIHJldHVybiByZXNCb2R5LnZhbHVlO1xuICAgICAgfVxuICAgICAgY29uc3Qgc3RhdHVzID0gcGFyc2VJbnQocmVzQm9keS5zdGF0dXMsIDEwKTtcbiAgICAgIGlmICghaXNOYU4oc3RhdHVzKSAmJiBzdGF0dXMgIT09IDApIHtcbiAgICAgICAgbGV0IG1lc3NhZ2UgPSByZXNCb2R5LnZhbHVlO1xuICAgICAgICBpZiAoXy5oYXMobWVzc2FnZSwgJ21lc3NhZ2UnKSkge1xuICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlLm1lc3NhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUoc3RhdHVzLCBfLmlzRW1wdHkobWVzc2FnZSkgPyBnZXRTdW1tYXJ5QnlDb2RlKHN0YXR1cykgOiBtZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHByb3RvY29sID09PSBXM0MpIHtcbiAgICAgIC8vIEdvdCByZXNwb25zZSBpbiBXM0MgZm9ybWF0XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDMwMCkge1xuICAgICAgICByZXR1cm4gcmVzQm9keS52YWx1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QocmVzQm9keS52YWx1ZSkgJiYgcmVzQm9keS52YWx1ZS5lcnJvcikge1xuICAgICAgICB0aHJvdyBlcnJvckZyb21XM0NKc29uQ29kZShyZXNCb2R5LnZhbHVlLmVycm9yLCByZXNCb2R5LnZhbHVlLm1lc3NhZ2UsIHJlc0JvZHkudmFsdWUuc3RhY2t0cmFjZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgIC8vIFVua25vd24gcHJvdG9jb2wuIEtlZXBpbmcgaXQgYmVjYXVzZSBvZiB0aGUgYmFja3dhcmQgY29tcGF0aWJpbGl0eVxuICAgICAgcmV0dXJuIHJlc0JvZHk7XG4gICAgfVxuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGBEaWQgbm90IGtub3cgd2hhdCB0byBkbyB3aXRoIHJlc3BvbnNlIGNvZGUgJyR7cmVzcG9uc2Uuc3RhdHVzQ29kZX0nIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBhbmQgcmVzcG9uc2UgYm9keSAnJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHJlc0JvZHkpLCB7bGVuZ3RoOiAzMDB9KX0nYCk7XG4gIH1cblxuICBnZXRTZXNzaW9uSWRGcm9tVXJsICh1cmwpIHtcbiAgICBjb25zdCBtYXRjaCA9IHVybC5tYXRjaCgvXFwvc2Vzc2lvblxcLyhbXi9dKykvKTtcbiAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IG51bGw7XG4gIH1cblxuICBhc3luYyBwcm94eVJlcVJlcyAocmVxLCByZXMpIHtcbiAgICBsZXQgW3Jlc3BvbnNlLCBib2R5XSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKHJlcS5vcmlnaW5hbFVybCwgcmVxLm1ldGhvZCwgcmVxLmJvZHkpO1xuXG4gICAgcmVzLmhlYWRlcnMgPSByZXNwb25zZS5oZWFkZXJzO1xuICAgIHJlcy5zZXQoJ2NvbnRlbnQtdHlwZScsIHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKTtcbiAgICAvLyBpZiB0aGUgcHJveGllZCByZXNwb25zZSBjb250YWlucyBhIHNlc3Npb25JZCB0aGF0IHRoZSBkb3duc3RyZWFtXG4gICAgLy8gZHJpdmVyIGhhcyBnZW5lcmF0ZWQsIHdlIGRvbid0IHdhbnQgdG8gcmV0dXJuIHRoYXQgdG8gdGhlIGNsaWVudC5cbiAgICAvLyBJbnN0ZWFkLCByZXR1cm4gdGhlIGlkIGZyb20gdGhlIHJlcXVlc3Qgb3IgZnJvbSBjdXJyZW50IHNlc3Npb25cbiAgICBib2R5ID0gdXRpbC5zYWZlSnNvblBhcnNlKGJvZHkpO1xuICAgIGlmIChib2R5ICYmIGJvZHkuc2Vzc2lvbklkKSB7XG4gICAgICBjb25zdCByZXFTZXNzaW9uSWQgPSB0aGlzLmdldFNlc3Npb25JZEZyb21VcmwocmVxLm9yaWdpbmFsVXJsKTtcbiAgICAgIGlmIChyZXFTZXNzaW9uSWQpIHtcbiAgICAgICAgbG9nLmluZm8oYFJlcGxhY2luZyBzZXNzaW9uSWQgJHtib2R5LnNlc3Npb25JZH0gd2l0aCAke3JlcVNlc3Npb25JZH1gKTtcbiAgICAgICAgYm9keS5zZXNzaW9uSWQgPSByZXFTZXNzaW9uSWQ7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc2Vzc2lvbklkKSB7XG4gICAgICAgIGxvZy5pbmZvKGBSZXBsYWNpbmcgc2Vzc2lvbklkICR7Ym9keS5zZXNzaW9uSWR9IHdpdGggJHt0aGlzLnNlc3Npb25JZH1gKTtcbiAgICAgICAgYm9keS5zZXNzaW9uSWQgPSB0aGlzLnNlc3Npb25JZDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmVzLnN0YXR1cyhyZXNwb25zZS5zdGF0dXNDb2RlKS5zZW5kKEpTT04uc3RyaW5naWZ5KGJvZHkpKTtcbiAgfVxufVxuXG5leHBvcnQgeyBKV1Byb3h5IH07XG5leHBvcnQgZGVmYXVsdCBKV1Byb3h5O1xuIl0sImZpbGUiOiJsaWIvanNvbndwLXByb3h5L3Byb3h5LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
