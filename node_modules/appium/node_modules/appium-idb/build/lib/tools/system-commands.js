"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _lodash = _interopRequireDefault(require("lodash"));

var _shellQuote = require("shell-quote");

var _asyncbox = require("asyncbox");

var _helpers = require("../helpers");

var _logger = _interopRequireDefault(require("../logger.js"));

const PROCESS_INIT_TIMEOUT = 5000;

const COMPANION_PGREP_PATTERN = udid => `${_helpers.IDB_COMPANION_EXECUTABLE}.*--udid[[:space:]]+${udid}`;

function buildDaemonArgs(opts = {}) {
  const {
    port,
    grpcPort
  } = opts;
  const result = ['daemon', '--notifier-path', _helpers.IDB_COMPANION_EXECUTABLE];

  if (port) {
    result.push('--port', port);
  }

  if (grpcPort) {
    result.push('--grpc-port', grpcPort);
  }

  return result;
}

const systemCallMethods = {};

systemCallMethods.connect = async function connect() {
  _logger.default.debug(`Connecting ${_helpers.IDB_EXECUTABLE} service to '${this.udid}'`);

  const binaryPaths = {};

  for (const binary of [_helpers.IDB_EXECUTABLE, _helpers.IDB_COMPANION_EXECUTABLE]) {
    try {
      binaryPaths[binary] = await _appiumSupport.fs.which(binary);
    } catch (e) {
      throw new Error(`'${binary}' has not been found in PATH. ` + `Is it installed? Read https://www.fbidb.io for more details`);
    }
  }

  try {
    await (0, _asyncbox.retryInterval)(5, 1000, async () => {
      let isStartupMonitorEnabled = true;

      try {
        const daemon = new _teen_process.SubProcess(_helpers.IDB_EXECUTABLE, buildDaemonArgs(this.executable));
        let daemonOutput = '';
        daemon.on('output', (stdout, stderr) => {
          if (isStartupMonitorEnabled && _lodash.default.trim(stdout || stderr)) {
            daemonOutput += `[daemon] ${stdout || stderr}\n`;
          }
        });

        try {
          await daemon.start(null, PROCESS_INIT_TIMEOUT);
          await _bluebird.default.delay(300);
        } catch (ign) {}

        if (daemon.isRunning) {
          _logger.default.debug(`${_helpers.IDB_EXECUTABLE} daemon started on port ${this.executable.port || _helpers.DEFAULT_IDB_PORT}`);
        } else {
          if (!daemonOutput.includes('address already in use')) {
            const message = `${_helpers.IDB_EXECUTABLE} daemon has failed to start: ${daemonOutput}`;

            _logger.default.warn(message);

            throw new Error(message);
          }

          _logger.default.debug(`The port ${this.executable.port || _helpers.DEFAULT_IDB_PORT} is already in use. ` + `Assuming it is used by ${_helpers.IDB_EXECUTABLE} daemon`);
        }

        await (0, _teen_process.exec)(_helpers.IDB_EXECUTABLE, ['connect', this.udid]);
      } catch (e) {
        if (e.stderr || e.stdout) {
          _logger.default.debug(e.stderr || e.stdout);
        }

        await this.disconnect();

        try {
          await (0, _teen_process.exec)(_helpers.IDB_EXECUTABLE, ['kill']);
        } catch (ign) {}

        throw e;
      } finally {
        isStartupMonitorEnabled = false;
      }
    });
  } catch (e) {
    if (e.stderr) {
      _logger.default.debug(e.stderr);
    }

    throw new Error(`Cannot start ${_helpers.IDB_EXECUTABLE} service for '${this.udid}'. ` + `Check the server log for more details.`);
  }

  _logger.default.info(`Successfully established the connection to ${_helpers.IDB_EXECUTABLE} service for '${this.udid}'`);

  this.executable.path = binaryPaths[_helpers.IDB_EXECUTABLE];
  this.companion.path = binaryPaths[_helpers.IDB_COMPANION_EXECUTABLE];
};

systemCallMethods.disconnect = async function disconnect() {
  _logger.default.debug(`Disconnecting ${_helpers.IDB_EXECUTABLE} service from '${this.udid}'`);

  try {
    await (0, _teen_process.exec)(this.executable.path, ['disconnect', this.udid]);
  } catch (ign) {}

  const companionPids = await (0, _helpers.getPids)(COMPANION_PGREP_PATTERN(this.udid));

  if (_lodash.default.isEmpty(companionPids)) {
    return;
  }

  _logger.default.debug(`Cleaning up ${companionPids.length} obsolete ${_helpers.IDB_COMPANION_EXECUTABLE} ` + `process${companionPids.length === 1 ? '' : 'es'}`);

  await (0, _teen_process.exec)('kill', ['-2', ...companionPids]);
};

systemCallMethods.exec = async function exec(cmd, opts = {}) {
  if (!cmd) {
    throw new Error('You need to pass in a command to exec()');
  }

  cmd = _lodash.default.isArray(cmd) ? cmd : [cmd];
  opts = _lodash.default.cloneDeep(opts);
  opts.timeout = opts.timeout || this.execTimeout || _helpers.DEFAULT_IDB_EXEC_TIMEOUT;
  opts.timeoutCapName = opts.timeoutCapName || 'execTimeout';
  const args = [...cmd, ...this.executable.defaultArgs];

  _logger.default.debug(`Running '${this.executable.path} ${(0, _shellQuote.quote)(args)}'`);

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)(this.executable.path, args, opts);
    return stdout;
  } catch (e) {
    if (_appiumSupport.util.hasValue(e.code)) {
      e.message = `Error executing ${_helpers.IDB_EXECUTABLE}. Original error: '${e.message}'; ` + `Stdout: '${(e.stdout || '').trim()}'; ` + `Stderr: '${(e.stderr || '').trim()}'; ` + `Code: '${e.code}'`;
    } else {
      e.message = `Error executing ${_helpers.IDB_EXECUTABLE}. Original error: '${e.message}'. ` + `Try to increase the ${opts.timeout}ms ${_helpers.IDB_EXECUTABLE} execution timeout represented by '${opts.timeoutCapName}' capability`;
    }

    throw e;
  }
};

systemCallMethods.createSubProcess = function createSubProcess(args = []) {
  const idbArgs = [...args, ...this.executable.defaultArgs];

  _logger.default.debug(`Creating ${_helpers.IDB_EXECUTABLE} subprocess with args: ${(0, _shellQuote.quote)(args)}`);

  return new _teen_process.SubProcess(this.executable.path, idbArgs);
};

var _default = systemCallMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9zeXN0ZW0tY29tbWFuZHMuanMiXSwibmFtZXMiOlsiUFJPQ0VTU19JTklUX1RJTUVPVVQiLCJDT01QQU5JT05fUEdSRVBfUEFUVEVSTiIsInVkaWQiLCJJREJfQ09NUEFOSU9OX0VYRUNVVEFCTEUiLCJidWlsZERhZW1vbkFyZ3MiLCJvcHRzIiwicG9ydCIsImdycGNQb3J0IiwicmVzdWx0IiwicHVzaCIsInN5c3RlbUNhbGxNZXRob2RzIiwiY29ubmVjdCIsImxvZyIsImRlYnVnIiwiSURCX0VYRUNVVEFCTEUiLCJiaW5hcnlQYXRocyIsImJpbmFyeSIsImZzIiwid2hpY2giLCJlIiwiRXJyb3IiLCJpc1N0YXJ0dXBNb25pdG9yRW5hYmxlZCIsImRhZW1vbiIsIlN1YlByb2Nlc3MiLCJleGVjdXRhYmxlIiwiZGFlbW9uT3V0cHV0Iiwib24iLCJzdGRvdXQiLCJzdGRlcnIiLCJfIiwidHJpbSIsInN0YXJ0IiwiQiIsImRlbGF5IiwiaWduIiwiaXNSdW5uaW5nIiwiREVGQVVMVF9JREJfUE9SVCIsImluY2x1ZGVzIiwibWVzc2FnZSIsIndhcm4iLCJkaXNjb25uZWN0IiwiaW5mbyIsInBhdGgiLCJjb21wYW5pb24iLCJjb21wYW5pb25QaWRzIiwiaXNFbXB0eSIsImxlbmd0aCIsImV4ZWMiLCJjbWQiLCJpc0FycmF5IiwiY2xvbmVEZWVwIiwidGltZW91dCIsImV4ZWNUaW1lb3V0IiwiREVGQVVMVF9JREJfRVhFQ19USU1FT1VUIiwidGltZW91dENhcE5hbWUiLCJhcmdzIiwiZGVmYXVsdEFyZ3MiLCJ1dGlsIiwiaGFzVmFsdWUiLCJjb2RlIiwiY3JlYXRlU3ViUHJvY2VzcyIsImlkYkFyZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBR0EsTUFBTUEsb0JBQW9CLEdBQUcsSUFBN0I7O0FBQ0EsTUFBTUMsdUJBQXVCLEdBQUlDLElBQUQsSUFDN0Is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QTVCRDs7QUFxQ0FULGlCQUFpQixDQUFDa0QsZ0JBQWxCLEdBQXFDLFNBQVNBLGdCQUFULENBQTJCTCxJQUFJLEdBQUcsRUFBbEMsRUFBc0M7QUFDekUsUUFBTU0sT0FBTyxHQUFHLENBQUMsR0FBR04sSUFBSixFQUFVLEdBQUcsS0FBSy9CLFVBQUwsQ0FBZ0JnQyxXQUE3QixDQUFoQjs7QUFDQTVDLGtCQUFJQyxLQUFKLENBQVcsWUFBV0MsdUJBQWUsMEJBQXlCLHVCQUFNeUMsSUFBTixDQUFZLEVBQTFFOztBQUNBLFNBQU8sSUFBSWhDLHdCQUFKLENBQWUsS0FBS0MsVUFBTCxDQUFnQmtCLElBQS9CLEVBQXFDbUIsT0FBckMsQ0FBUDtBQUNELENBSkQ7O2VBTWVuRCxpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGZzLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXhlYyBhcyB0cEV4ZWMsIFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHF1b3RlIH0gZnJvbSAnc2hlbGwtcXVvdGUnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7XG4gIGdldFBpZHMsIERFRkFVTFRfSURCX0VYRUNfVElNRU9VVCwgSURCX0VYRUNVVEFCTEUsXG4gIElEQl9DT01QQU5JT05fRVhFQ1VUQUJMRSwgREVGQVVMVF9JREJfUE9SVCxcbn0gZnJvbSAnLi4vaGVscGVycyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlci5qcyc7XG5cblxuY29uc3QgUFJPQ0VTU19JTklUX1RJTUVPVVQgPSA1MDAwO1xuY29uc3QgQ09NUEFOSU9OX1BHUkVQX1BBVFRFUk4gPSAodWRpZCkgPT5cbiAgYCR7SURCX0NPTVBBTklPTl9FWEVDVVRBQkxFfS4qLS11ZGlkW1s6c3BhY2U6XV0rJHt1ZGlkfWA7XG5cbmZ1bmN0aW9uIGJ1aWxkRGFlbW9uQXJncyAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBwb3J0LFxuICAgIGdycGNQb3J0LFxuICB9ID0gb3B0cztcblxuICBjb25zdCByZXN1bHQgPSBbXG4gICAgJ2RhZW1vbicsXG4gICAgJy0tbm90aWZpZXItcGF0aCcsIElEQl9DT01QQU5JT05fRVhFQ1VUQUJMRSxcbiAgXTtcbiAgaWYgKHBvcnQpIHtcbiAgICByZXN1bHQucHVzaCgnLS1wb3J0JywgcG9ydCk7XG4gIH1cbiAgaWYgKGdycGNQb3J0KSB7XG4gICAgcmVzdWx0LnB1c2goJy0tZ3JwYy1wb3J0JywgZ3JwY1BvcnQpO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cblxuY29uc3Qgc3lzdGVtQ2FsbE1ldGhvZHMgPSB7fTtcblxuLyoqXG4gKiBJbml0aWFsaXplcyBpZGIgYW5kIGNvbXBhbmlvbiBwcm9jZXNzZXMgaWYgbmVjZXNzYXJ5IGFuZFxuICogYXNzaWducyBwYXRoIHByb3BlcnRpZXMuIEl0IGlzIG1hbmRhdG9yeSB0byBjYWxsIHRoaXMgbWV0aG9kIGJlZm9yZVxuICogb25lIGNhbiBzdGFydCB1c2luZyBJREIgaW5zdGFuY2UsXG4gKlxuICogQHRocm93cyB7RXJyb3J9IElmIG1hbmRhdG9yeSBpZGIgZXhlY3V0YWJsZXMgYXJlIG5vdCBwcmVzZW50IG9uIHRoZVxuICogbG9jYWxob3N0IG9yIHRoZXJlIHdhcyBhIGZhaWx1cmUgd2hpbGUgc3RhcnRpbmcvZGV0ZWN0aW5nIHRoZW1cbiAqL1xuc3lzdGVtQ2FsbE1ldGhvZHMuY29ubmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGNvbm5lY3QgKCkge1xuICBsb2cuZGVidWcoYENvbm5lY3RpbmcgJHtJREJfRVhFQ1VUQUJMRX0gc2VydmljZSB0byAnJHt0aGlzLnVkaWR9J2ApO1xuXG4gIGNvbnN0IGJpbmFyeVBhdGhzID0ge307XG4gIGZvciAoY29uc3QgYmluYXJ5IG9mIFtJREJfRVhFQ1VUQUJMRSwgSURCX0NPTVBBTklPTl9FWEVDVVRBQkxFXSkge1xuICAgIHRyeSB7XG4gICAgICBiaW5hcnlQYXRoc1tiaW5hcnldID0gYXdhaXQgZnMud2hpY2goYmluYXJ5KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCcke2JpbmFyeX0nIGhhcyBub3QgYmVlbiBmb3VuZCBpbiBQQVRILiBgICtcbiAgICAgICAgYElzIGl0IGluc3RhbGxlZD8gUmVhZCBodHRwczovL3d3dy5mYmlkYi5pbyBmb3IgbW9yZSBkZXRhaWxzYCk7XG4gICAgfVxuICB9XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDUsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBpc1N0YXJ0dXBNb25pdG9yRW5hYmxlZCA9IHRydWU7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBkYWVtb24gPSBuZXcgU3ViUHJvY2VzcyhJREJfRVhFQ1VUQUJMRSwgYnVpbGREYWVtb25BcmdzKHRoaXMuZXhlY3V0YWJsZSkpO1xuICAgICAgICBsZXQgZGFlbW9uT3V0cHV0ID0gJyc7XG4gICAgICAgIGRhZW1vbi5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICAgICAgaWYgKGlzU3RhcnR1cE1vbml0b3JFbmFibGVkICYmIF8udHJpbShzdGRvdXQgfHwgc3RkZXJyKSkge1xuICAgICAgICAgICAgZGFlbW9uT3V0cHV0ICs9IGBbZGFlbW9uXSAke3N0ZG91dCB8fCBzdGRlcnJ9XFxuYDtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IGRhZW1vbi5zdGFydChudWxsLCBQUk9DRVNTX0lOSVRfVElNRU9VVCk7XG4gICAgICAgICAgYXdhaXQgQi5kZWxheSgzMDApO1xuICAgICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICAgIGlmIChkYWVtb24uaXNSdW5uaW5nKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGAke0lEQl9FWEVDVVRBQkxFfSBkYWVtb24gc3RhcnRlZCBvbiBwb3J0ICR7dGhpcy5leGVjdXRhYmxlLnBvcnQgfHwgREVGQVVMVF9JREJfUE9SVH1gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoIWRhZW1vbk91dHB1dC5pbmNsdWRlcygnYWRkcmVzcyBhbHJlYWR5IGluIHVzZScpKSB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYCR7SURCX0VYRUNVVEFCTEV9IGRhZW1vbiBoYXMgZmFpbGVkIHRvIHN0YXJ0OiAke2RhZW1vbk91dHB1dH1gO1xuICAgICAgICAgICAgbG9nLndhcm4obWVzc2FnZSk7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxvZy5kZWJ1ZyhgVGhlIHBvcnQgJHt0aGlzLmV4ZWN1dGFibGUucG9ydCB8fCBERUZBVUxUX0lEQl9QT1JUfSBpcyBhbHJlYWR5IGluIHVzZS4gYCArXG4gICAgICAgICAgICBgQXNzdW1pbmcgaXQgaXMgdXNlZCBieSAke0lEQl9FWEVDVVRBQkxFfSBkYWVtb25gKTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCB0cEV4ZWMoSURCX0VYRUNVVEFCTEUsIFsnY29ubmVjdCcsIHRoaXMudWRpZF0pO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoZS5zdGRlcnIgfHwgZS5zdGRvdXQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoZS5zdGRlcnIgfHwgZS5zdGRvdXQpO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IHRoaXMuZGlzY29ubmVjdCgpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRwRXhlYyhJREJfRVhFQ1VUQUJMRSwgWydraWxsJ10pO1xuICAgICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICBpc1N0YXJ0dXBNb25pdG9yRW5hYmxlZCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGUuc3RkZXJyKSB7XG4gICAgICBsb2cuZGVidWcoZS5zdGRlcnIpO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBzdGFydCAke0lEQl9FWEVDVVRBQkxFfSBzZXJ2aWNlIGZvciAnJHt0aGlzLnVkaWR9Jy4gYCArXG4gICAgICBgQ2hlY2sgdGhlIHNlcnZlciBsb2cgZm9yIG1vcmUgZGV0YWlscy5gKTtcbiAgfVxuICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIHRoZSBjb25uZWN0aW9uIHRvICR7SURCX0VYRUNVVEFCTEV9IHNlcnZpY2UgZm9yICcke3RoaXMudWRpZH0nYCk7XG5cbiAgdGhpcy5leGVjdXRhYmxlLnBhdGggPSBiaW5hcnlQYXRoc1tJREJfRVhFQ1VUQUJMRV07XG4gIHRoaXMuY29tcGFuaW9uLnBhdGggPSBiaW5hcnlQYXRoc1tJREJfQ09NUEFOSU9OX0VYRUNVVEFCTEVdO1xufTtcblxuLyoqXG4gKiBQZXJmb3JtcyBjbGVhbnVwIG9mIG9ic29sZXRlIGNvbXBhbmlvbiBwcm9jZXNzZXNcbiAqIFRoZSBkYWVtb24gcHJvY2VzcyBpcyBsZWZ0IHVudG91Y2hlZCwgYmVjYXVzZSBraWxsaW5nIGl0IG1pZ2h0XG4gKiBwb3RlbnRpYWxseSBhZmZlY3Qgb3RoZXIgcGFyYWxsZWwgc2Vzc2lvbnMuIE5vdGhpbmdcbiAqIGlzIGRvbmUgaWYgbm8gb2Jzb2xldGUgcHJvY2Vzc2VzIGFyZSBmb3VuZC5cbiAqL1xuc3lzdGVtQ2FsbE1ldGhvZHMuZGlzY29ubmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGRpc2Nvbm5lY3QgKCkge1xuICBsb2cuZGVidWcoYERpc2Nvbm5lY3RpbmcgJHtJREJfRVhFQ1VUQUJMRX0gc2VydmljZSBmcm9tICcke3RoaXMudWRpZH0nYCk7XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCB0cEV4ZWModGhpcy5leGVjdXRhYmxlLnBhdGgsIFsnZGlzY29ubmVjdCcsIHRoaXMudWRpZF0pO1xuICB9IGNhdGNoIChpZ24pIHt9XG5cbiAgY29uc3QgY29tcGFuaW9uUGlkcyA9IGF3YWl0IGdldFBpZHMoQ09NUEFOSU9OX1BHUkVQX1BBVFRFUk4odGhpcy51ZGlkKSk7XG4gIGlmIChfLmlzRW1wdHkoY29tcGFuaW9uUGlkcykpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuZGVidWcoYENsZWFuaW5nIHVwICR7Y29tcGFuaW9uUGlkcy5sZW5ndGh9IG9ic29sZXRlICR7SURCX0NPTVBBTklPTl9FWEVDVVRBQkxFfSBgICtcbiAgICBgcHJvY2VzcyR7Y29tcGFuaW9uUGlkcy5sZW5ndGggPT09IDEgPyAnJyA6ICdlcyd9YCk7XG4gIGF3YWl0IHRwRXhlYygna2lsbCcsIFsnLTInLCAuLi5jb21wYW5pb25QaWRzXSk7XG59O1xuXG4vKipcbiAqIEV4ZWN1dGUgdGhlIGdpdmVuIGlkYiBjb21tYW5kLlxuICpcbiAqIEBwYXJhbSB7QXJyYXkuPHN0cmluZz59IGNtZCAtIFRoZSBhcnJheSBvZiByZXN0IGNvbW1hbmQgbGluZSBwYXJhbWV0ZXJzXG4gKiAgICAgICAgICAgICAgICAgICAgICBvciBhIHNpbmdsZSBzdHJpbmcgcGFyYW1ldGVyLlxuICogQHBhcmFtIHtPYmplY3R9IG9wdHMgLSBBZGRpdGlvbmFsIG9wdGlvbnMgbWFwcGluZy4gU2VlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL25vZGUtdGVlbl9wcm9jZXNzfVxuICogICAgICAgICAgICAgICAgICAgICAgICBmb3IgbW9yZSBkZXRhaWxzLlxuICogQHJldHVybiB7c3RyaW5nfSAtIENvbW1hbmQncyBzdGRvdXQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGNvbW1hbmQgcmV0dXJuZWQgbm9uLXplcm8gZXhpdCBjb2RlLlxuICovXG5zeXN0ZW1DYWxsTWV0aG9kcy5leGVjID0gYXN5bmMgZnVuY3Rpb24gZXhlYyAoY21kLCBvcHRzID0ge30pIHtcbiAgaWYgKCFjbWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBuZWVkIHRvIHBhc3MgaW4gYSBjb21tYW5kIHRvIGV4ZWMoKScpO1xuICB9XG4gIGNtZCA9IF8uaXNBcnJheShjbWQpID8gY21kIDogW2NtZF07XG5cbiAgb3B0cyA9IF8uY2xvbmVEZWVwKG9wdHMpO1xuICAvLyBzZXR0aW5nIGRlZmF1bHQgdGltZW91dCBmb3IgZWFjaCBjb21tYW5kIHRvIHByZXZlbnQgaW5maW5pdGUgd2FpdC5cbiAgb3B0cy50aW1lb3V0ID0gb3B0cy50aW1lb3V0IHx8IHRoaXMuZXhlY1RpbWVvdXQgfHwgREVGQVVMVF9JREJfRVhFQ19USU1FT1VUO1xuICBvcHRzLnRpbWVvdXRDYXBOYW1lID0gb3B0cy50aW1lb3V0Q2FwTmFtZSB8fCAnZXhlY1RpbWVvdXQnOyAvLyBGb3IgZXJyb3IgbWVzc2FnZVxuXG4gIGNvbnN0IGFyZ3MgPSBbLi4uY21kLCAuLi50aGlzLmV4ZWN1dGFibGUuZGVmYXVsdEFyZ3NdO1xuICBsb2cuZGVidWcoYFJ1bm5pbmcgJyR7dGhpcy5leGVjdXRhYmxlLnBhdGh9ICR7cXVvdGUoYXJncyl9J2ApO1xuICB0cnkge1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgdHBFeGVjKHRoaXMuZXhlY3V0YWJsZS5wYXRoLCBhcmdzLCBvcHRzKTtcbiAgICByZXR1cm4gc3Rkb3V0O1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUoZS5jb2RlKSkge1xuICAgICAgZS5tZXNzYWdlID0gYEVycm9yIGV4ZWN1dGluZyAke0lEQl9FWEVDVVRBQkxFfS4gT3JpZ2luYWwgZXJyb3I6ICcke2UubWVzc2FnZX0nOyBgICtcbiAgICAgICAgYFN0ZG91dDogJyR7KGUuc3Rkb3V0IHx8ICcnKS50cmltKCl9JzsgYCArXG4gICAgICAgIGBTdGRlcnI6ICckeyhlLnN0ZGVyciB8fCAnJykudHJpbSgpfSc7IGAgK1xuICAgICAgICBgQ29kZTogJyR7ZS5jb2RlfSdgO1xuICAgIH0gZWxzZSB7XG4gICAgICBlLm1lc3NhZ2UgPSBgRXJyb3IgZXhlY3V0aW5nICR7SURCX0VYRUNVVEFCTEV9LiBPcmlnaW5hbCBlcnJvcjogJyR7ZS5tZXNzYWdlfScuIGAgK1xuICAgICAgICBgVHJ5IHRvIGluY3JlYXNlIHRoZSAke29wdHMudGltZW91dH1tcyAke0lEQl9FWEVDVVRBQkxFfSBleGVjdXRpb24gdGltZW91dCByZXByZXNlbnRlZCBieSAnJHtvcHRzLnRpbWVvdXRDYXBOYW1lfScgY2FwYWJpbGl0eWA7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cbn07XG5cbi8qKlxuICogQ3JlYXRlcyBTdWJQcm9jZXNzIGluc3RhbmNlIG9mIGlkYiBmb3IgYmFja2dyb3VuZFxuICogZXhlY3V0aW9uLlxuICpcbiAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nPn0gYXJncyBhZGRpdGlvbmFsIGlkYiBhcmd1bWVudHNcbiAqIEByZXR1cm5zIHtTdWJQcm9jZXNzfVxuICovXG5zeXN0ZW1DYWxsTWV0aG9kcy5jcmVhdGVTdWJQcm9jZXNzID0gZnVuY3Rpb24gY3JlYXRlU3ViUHJvY2VzcyAoYXJncyA9IFtdKSB7XG4gIGNvbnN0IGlkYkFyZ3MgPSBbLi4uYXJncywgLi4udGhpcy5leGVjdXRhYmxlLmRlZmF1bHRBcmdzXTtcbiAgbG9nLmRlYnVnKGBDcmVhdGluZyAke0lEQl9FWEVDVVRBQkxFfSBzdWJwcm9jZXNzIHdpdGggYXJnczogJHtxdW90ZShhcmdzKX1gKTtcbiAgcmV0dXJuIG5ldyBTdWJQcm9jZXNzKHRoaXMuZXhlY3V0YWJsZS5wYXRoLCBpZGJBcmdzKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IHN5c3RlbUNhbGxNZXRob2RzO1xuIl0sImZpbGUiOiJsaWIvdG9vbHMvc3lzdGVtLWNvbW1hbmRzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
