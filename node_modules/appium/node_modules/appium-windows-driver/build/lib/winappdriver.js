"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.DEFAULT_WAD_PORT = exports.DEFAULT_WAD_HOST = exports.WinAppDriver = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _events = _interopRequireDefault(require("events"));

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("./logger"));

var _teen_process = require("teen_process");

var _installer = require("./installer");

var _asyncbox = require("asyncbox");

var _child_process = _interopRequireDefault(require("child_process"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const REQUIRED_PARAMS = [];
const DEFAULT_WAD_HOST = '127.0.0.1';
exports.DEFAULT_WAD_HOST = DEFAULT_WAD_HOST;
const DEFAULT_WAD_PORT = 4724;
exports.DEFAULT_WAD_PORT = DEFAULT_WAD_PORT;

class WinAppDriver extends _events.default.EventEmitter {
  constructor(opts = {}) {
    const host = opts.host,
          port = opts.port;
    super();

    for (var _i = 0; _i < REQUIRED_PARAMS.length; _i++) {
      let req = REQUIRED_PARAMS[_i];

      if (!opts || !opts[req]) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.proxyHost = host || DEFAULT_WAD_HOST;
    this.proxyPort = port || DEFAULT_WAD_PORT;
    this.proc = null;
    this.state = WinAppDriver.STATE_STOPPED;
    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.proxyHost,
      port: this.proxyPort
    });
  }

  start() {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (!(yield (0, _installer.verifyWAD)())) {
        throw new Error("Could not verify WinAppDriver install; re-run install");
      }

      _this.changeState(WinAppDriver.STATE_STARTING);

      let args = [_this.proxyPort + "/wd/hub"];

      const startDetector = stdout => {
        return stdout.indexOf("listening for requests") !== -1;
      };

      let processIsAlive = false;

      try {
        yield _this.killAll();
        _this.proc = new _teen_process.SubProcess(_installer.WAD_INSTALL_PATH, args, {
          encoding: 'ucs2'
        });
        processIsAlive = true;
        var _arr = ['STDOUT', 'STDERR'];

        for (var _i2 = 0; _i2 < _arr.length; _i2++) {
          let stream = _arr[_i2];

          _this.proc.on(`lines-${stream.toLowerCase()}`, lines => {
            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
              for (var _iterator = lines[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                let l = _step.value;

                _logger.default.info(`[${stream}] ${l.trim()}`);
              }
            } catch (err) {
              _didIteratorError = true;
              _iteratorError = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion && _iterator.return != null) {
                  _iterator.return();
                }
              } finally {
                if (_didIteratorError) {
                  throw _iteratorError;
                }
              }
            }
          });
        }

        _this.proc.on('exit', (code, signal) => {
          processIsAlive = false;

          if (_this.state !== WinAppDriver.STATE_STOPPED && _this.state !== WinAppDriver.STATE_STOPPING) {
            let msg = `WinAppDriver exited unexpectedly with code ${code}, ` + `signal ${signal}`;

            _logger.default.error(msg);

            _this.changeState(WinAppDriver.STATE_STOPPED);
          }
        });

        _logger.default.info(`Spawning winappdriver with: ${args.join(' ')}`);

        yield _this.proc.start(startDetector);
        yield _this.waitForOnline();
      } catch (e) {
        _this.emit(WinAppDriver.EVENT_ERROR, e);

        if (processIsAlive) {
          yield _this.proc.stop();
        }

        _logger.default.errorAndThrow(e);
      }
    })();
  }

  sessionId() {
    if (this.state !== WinAppDriver.STATE_ONLINE) {
      return null;
    }

    return this.jwproxy.sessionId;
  }

  waitForOnline() {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let winappdriverStopped = false;
      yield (0, _asyncbox.retryInterval)(20, 200, (0, _asyncToGenerator2.default)(function* () {
        if ([WinAppDriver.STATE_STOPPED, WinAppDriver.STATE_ONLINE].indexOf(_this2.state) >= 0) {
          winappdriverStopped = _this2.state === WinAppDriver.STATE_STOPPED;
          return;
        }

        if (yield _this2.getStatus()) {
          _this2.changeState(WinAppDriver.STATE_ONLINE);
        }
      }));

      if (winappdriverStopped) {
        throw new Error('WinAppDriver crashed during startup.');
      }
    })();
  }

  getStatus() {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const resBlock = yield _this3.jwproxy.proxy('/status', 'GET');

      if (resBlock[0].statusCode === 200) {
        _logger.default.info(`Status call returned 200. we're online and ready to run tests`);

        return true;
      }

      return false;
    })();
  }

  startSession(caps) {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _this4.proxyReqRes = _this4.jwproxy.proxyReqRes.bind(_this4.jwproxy);
      yield _this4.jwproxy.command('/session', 'POST', {
        desiredCapabilities: caps
      });
    })();
  }

  stop(emitStates = true) {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (emitStates) {
        _this5.changeState(WinAppDriver.STATE_STOPPING);
      }

      try {
        if (_this5.proc) {
          yield _this5.proc.stop();
        }

        if (emitStates) {
          _this5.changeState(WinAppDriver.STATE_STOPPED);
        }
      } catch (e) {
        _logger.default.error(e);
      }
    })();
  }

  changeState(state) {
    this.state = state;

    _logger.default.debug(`WinAppDriver changed state to '${state}'`);

    this.emit(WinAppDriver.EVENT_CHANGED, {
      state
    });
  }

  sendCommand(url, method, body) {
    var _this6 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      return yield _this6.jwproxy.command(url, method, body);
    })();
  }

  proxyReq(req, res) {
    var _this7 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      return yield _this7.jwproxy.proxyReqRes(req, res);
    })();
  }

  killAll() {
    var _this8 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let cmd;
      cmd = "FOR /F \"usebackq tokens=5\" %a in (`netstat -nao ^| " + "findstr /R /C:\"" + _this8.proxyPort + " \"`) do (" + "FOR /F \"usebackq\" %b in (`TASKLIST /FI \"PID eq %a\" ^| " + "findstr /I winappdriver.exe`) do (IF NOT %b==\"\" TASKKILL " + "/F /PID %a))";

      _logger.default.info(`Killing any old WinAppDrivers on same port, running: ${cmd}`);

      try {
        yield _bluebird.default.promisify(_child_process.default.exec)(cmd);

        _logger.default.info("Successfully cleaned up old WinAppDrivers");
      } catch (err) {
        _logger.default.info("No old WinAppDrivers seemed to exist");
      }
    })();
  }

  deleteSession() {
    var _this9 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.debug('Deleting WinAppDriver server session');

      try {
        yield _this9.jwproxy.command('/', 'DELETE');
      } catch (err) {
        _logger.default.warn(`Did not get confirmation WinAppDriver deleteSession worked; ` + `Error was: ${err}`);
      }
    })();
  }

}

exports.WinAppDriver = WinAppDriver;
WinAppDriver.EVENT_ERROR = 'winappdriver_error';
WinAppDriver.EVENT_CHANGED = 'stateChanged';
WinAppDriver.STATE_STOPPED = 'stopped';
WinAppDriver.STATE_STARTING = 'starting';
WinAppDriver.STATE_ONLINE = 'online';
WinAppDriver.STATE_STOPPING = 'stopping';
var _default = WinAppDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93aW5hcHBkcml2ZXIuanMiXSwibmFtZXMiOlsiUkVRVUlSRURfUEFSQU1TIiwiREVGQVVMVF9XQURfSE9TVCIsIkRFRkFVTFRfV0FEX1BPUlQiLCJXaW5BcHBEcml2ZXIiLCJldmVudHMiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJob3N0IiwicG9ydCIsInJlcSIsIkVycm9yIiwicHJveHlIb3N0IiwicHJveHlQb3J0IiwicHJvYyIsInN0YXRlIiwiU1RBVEVfU1RPUFBFRCIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwic3RhcnQiLCJjaGFuZ2VTdGF0ZSIsIlNUQVRFX1NUQVJUSU5HIiwiYXJncyIsInN0YXJ0RGV0ZWN0b3IiLCJzdGRvdXQiLCJpbmRleE9mIiwicHJvY2Vzc0lzQWxpdmUiLCJraWxsQWxsIiwiU3ViUHJvY2VzcyIsIldBRF9JTlNUQUxMX1BBVEgiLCJlbmNvZGluZyIsInN0cmVhbSIsIm9uIiwidG9Mb3dlckNhc2UiLCJsaW5lcyIsImwiLCJsb2ciLCJpbmZvIiwidHJpbSIsImNvZGUiLCJzaWduYWwiLCJTVEFURV9TVE9QUElORyIsIm1zZyIsImVycm9yIiwiam9pbiIsIndhaXRGb3JPbmxpbmUiLCJlIiwiZW1pdCIsIkVWRU5UX0VSUk9SIiwic3RvcCIsImVycm9yQW5kVGhyb3ciLCJzZXNzaW9uSWQiLCJTVEFURV9PTkxJTkUiLCJ3aW5hcHBkcml2ZXJTdG9wcGVkIiwiZ2V0U3RhdHVzIiwicmVzQmxvY2siLCJwcm94eSIsInN0YXR1c0NvZGUiLCJzdGFydFNlc3Npb24iLCJjYXBzIiwicHJveHlSZXFSZXMiLCJiaW5kIiwiY29tbWFuZCIsImRlc2lyZWRDYXBhYmlsaXRpZXMiLCJlbWl0U3RhdGVzIiwiZGVidWciLCJFVkVOVF9DSEFOR0VEIiwic2VuZENvbW1hbmQiLCJ1cmwiLCJtZXRob2QiLCJib2R5IiwicHJveHlSZXEiLCJyZXMiLCJjbWQiLCJCIiwicHJvbWlzaWZ5IiwiY3AiLCJl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WSxDQUFDa0QsWUFBYixHQUE0QixRQUE1QjtBQUNBbEQsWUFBWSxDQUFDdUMsY0FBYixHQUE4QixVQUE5QjtlQUdldkMsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBldmVudHMgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBTdWJQcm9jZXNzIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IFdBRF9JTlNUQUxMX1BBVEgsIHZlcmlmeVdBRCB9IGZyb20gJy4vaW5zdGFsbGVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgY3AgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cbmNvbnN0IFJFUVVJUkVEX1BBUkFNUyA9IFtdOyAvLyBYWFlEIDEtNS0yMDE4OiByZW1vdmVkIGFwcCBmcm9tIHJlcXVpcmVkIHBhcmFtcyBiZWNhdXNlIHlvdSBjYW4gYWx0ZXJuYXRpdmVseSB1c2UgYXBwVG9wTGV2ZWxXaW5kb3dcbmNvbnN0IERFRkFVTFRfV0FEX0hPU1QgPSAnMTI3LjAuMC4xJztcbmNvbnN0IERFRkFVTFRfV0FEX1BPUlQgPSA0NzI0OyAvLyAgc2hvdWxkIGJlIG5vbi00NzIzIHRvIGF2b2lkIGNvbmZsaWN0IG9uIHRoZSBzYW1lIGJveFxuXG5jbGFzcyBXaW5BcHBEcml2ZXIgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IHtob3N0LCBwb3J0fSA9IG9wdHM7XG4gICAgc3VwZXIoKTtcblxuICAgIGZvciAobGV0IHJlcSBvZiBSRVFVSVJFRF9QQVJBTVMpIHtcbiAgICAgIGlmICghb3B0cyB8fCAhb3B0c1tyZXFdKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgT3B0aW9uICcke3JlcX0nIGlzIHJlcXVpcmVkIWApO1xuICAgICAgfVxuICAgICAgdGhpc1tyZXFdID0gb3B0c1tyZXFdO1xuICAgIH1cblxuICAgIHRoaXMucHJveHlIb3N0ID0gaG9zdCB8fCBERUZBVUxUX1dBRF9IT1NUO1xuICAgIHRoaXMucHJveHlQb3J0ID0gcG9ydCB8fCBERUZBVUxUX1dBRF9QT1JUO1xuICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgdGhpcy5zdGF0ZSA9IFdpbkFwcERyaXZlci5TVEFURV9TVE9QUEVEO1xuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtzZXJ2ZXI6IHRoaXMucHJveHlIb3N0LCBwb3J0OiB0aGlzLnByb3h5UG9ydH0pO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIGlmICghYXdhaXQgdmVyaWZ5V0FEKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNvdWxkIG5vdCB2ZXJpZnkgV2luQXBwRHJpdmVyIGluc3RhbGw7IHJlLXJ1biBpbnN0YWxsXCIpO1xuICAgIH1cblxuICAgIHRoaXMuY2hhbmdlU3RhdGUoV2luQXBwRHJpdmVyLlNUQVRFX1NUQVJUSU5HKTtcblxuICAgIC8vIFhYWFlEIFRPRE86IHdvdWxkIGJlIGJldHRlciBpZiBXaW5BcHBEcml2ZXIgZGlkbid0IHJlcXVpcmUgcGFzc2luZyBpbiAvd2QvaHViIGFzIGEgcGFyYW1cbiAgICBsZXQgYXJncyA9IFt0aGlzLnByb3h5UG9ydCArIFwiL3dkL2h1YlwiXTtcblxuICAgIGNvbnN0IHN0YXJ0RGV0ZWN0b3IgPSAoc3Rkb3V0KSA9PiB7XG4gICAgICByZXR1cm4gc3Rkb3V0LmluZGV4T2YoXCJsaXN0ZW5pbmcgZm9yIHJlcXVlc3RzXCIpICE9PSAtMTtcbiAgICB9O1xuXG4gICAgbGV0IHByb2Nlc3NJc0FsaXZlID0gZmFsc2U7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMua2lsbEFsbCgpO1xuXG4gICAgICAvLyBzZXQgdXAgb3VyIHN1YnByb2Nlc3Mgb2JqZWN0XG4gICAgICB0aGlzLnByb2MgPSBuZXcgU3ViUHJvY2VzcyhXQURfSU5TVEFMTF9QQVRILCBhcmdzLCB7XG4gICAgICAgIGVuY29kaW5nOiAndWNzMidcbiAgICAgIH0pO1xuICAgICAgcHJvY2Vzc0lzQWxpdmUgPSB0cnVlO1xuXG4gICAgICAvLyBoYW5kbGUgbG9nIG91dHB1dFxuICAgICAgZm9yIChsZXQgc3RyZWFtIG9mIFsnU1RET1VUJywgJ1NUREVSUiddKSB7XG4gICAgICAgIHRoaXMucHJvYy5vbihgbGluZXMtJHtzdHJlYW0udG9Mb3dlckNhc2UoKX1gLCAobGluZXMpID0+IHtcbiAgICAgICAgICBmb3IgKGxldCBsIG9mIGxpbmVzKSB7XG4gICAgICAgICAgICBsb2cuaW5mbyhgWyR7c3RyZWFtfV0gJHtsLnRyaW0oKX1gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBoYW5kbGUgb3V0LW9mLWJvdW5kIGV4aXQgYnkgc2ltcGx5IGVtaXR0aW5nIGEgc3RvcHBlZCBzdGF0ZVxuICAgICAgdGhpcy5wcm9jLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgICBwcm9jZXNzSXNBbGl2ZSA9IGZhbHNlO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQgJiZcbiAgICAgICAgICAgIHRoaXMuc3RhdGUgIT09IFdpbkFwcERyaXZlci5TVEFURV9TVE9QUElORykge1xuICAgICAgICAgIGxldCBtc2cgPSBgV2luQXBwRHJpdmVyIGV4aXRlZCB1bmV4cGVjdGVkbHkgd2l0aCBjb2RlICR7Y29kZX0sIGAgK1xuICAgICAgICAgICAgICAgICAgICBgc2lnbmFsICR7c2lnbmFsfWA7XG4gICAgICAgICAgbG9nLmVycm9yKG1zZyk7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgbG9nLmluZm8oYFNwYXduaW5nIHdpbmFwcGRyaXZlciB3aXRoOiAke2FyZ3Muam9pbignICcpfWApO1xuXG4gICAgICAvLyBzdGFydCBzdWJwcm9jIGFuZCB3YWl0IGZvciBzdGFydERldGVjdG9yXG4gICAgICBhd2FpdCB0aGlzLnByb2Muc3RhcnQoc3RhcnREZXRlY3Rvcik7XG4gICAgICBhd2FpdCB0aGlzLndhaXRGb3JPbmxpbmUoKTtcblxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuZW1pdChXaW5BcHBEcml2ZXIuRVZFTlRfRVJST1IsIGUpO1xuICAgICAgLy8ganVzdCBiZWNhdXNlIHdlIGhhZCBhbiBlcnJvciBkb2Vzbid0IG1lYW4gdGhlIHdpbmFwcGRyaXZlciBwcm9jZXNzXG4gICAgICAvLyBmaW5pc2hlZDsgd2Ugc2hvdWxkIGNsZWFuIHVwIGlmIG5lY2Vzc2FyeVxuICAgICAgaWYgKHByb2Nlc3NJc0FsaXZlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCk7XG4gICAgICB9XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhlKTtcbiAgICB9XG4gIH1cblxuICBzZXNzaW9uSWQgKCkge1xuICAgIGlmICh0aGlzLnN0YXRlICE9PSBXaW5BcHBEcml2ZXIuU1RBVEVfT05MSU5FKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5qd3Byb3h5LnNlc3Npb25JZDtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JPbmxpbmUgKCkge1xuXG4gICAgLy8gd2UgbmVlZCB0byBtYWtlIHN1cmUgV0FEIGhhc24ndCBjcmFzaGVkXG4gICAgbGV0IHdpbmFwcGRyaXZlclN0b3BwZWQgPSBmYWxzZTtcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCAyMDAsIGFzeW5jICgpID0+IHtcbiAgICAgIGlmIChbV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQsIFdpbkFwcERyaXZlci5TVEFURV9PTkxJTkVdLmluZGV4T2YodGhpcy5zdGF0ZSkgPj0gMCkge1xuICAgICAgICAvLyB3ZSBhcmUgZWl0aGVyIHN0b3BwZWQsIHN0b3BwaW5nLCBvciB3ZSdyZSBvbmxpbmVcbiAgICAgICAgd2luYXBwZHJpdmVyU3RvcHBlZCA9IHRoaXMuc3RhdGUgPT09IFdpbkFwcERyaXZlci5TVEFURV9TVE9QUEVEO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChhd2FpdCB0aGlzLmdldFN0YXR1cygpKSB7XG4gICAgICAgIHRoaXMuY2hhbmdlU3RhdGUoV2luQXBwRHJpdmVyLlNUQVRFX09OTElORSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAod2luYXBwZHJpdmVyU3RvcHBlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdXaW5BcHBEcml2ZXIgY3Jhc2hlZCBkdXJpbmcgc3RhcnR1cC4nKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRTdGF0dXMgKCkge1xuICAgIGNvbnN0IHJlc0Jsb2NrID0gYXdhaXQgdGhpcy5qd3Byb3h5LnByb3h5KCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgIGlmIChyZXNCbG9ja1swXS5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgIGxvZy5pbmZvKGBTdGF0dXMgY2FsbCByZXR1cm5lZCAyMDAuIHdlJ3JlIG9ubGluZSBhbmQgcmVhZHkgdG8gcnVuIHRlc3RzYCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChjYXBzKSB7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG4gICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoZW1pdFN0YXRlcyA9IHRydWUpIHtcbiAgICBpZiAoZW1pdFN0YXRlcykge1xuICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBJTkcpO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgaWYgKHRoaXMucHJvYykge1xuICAgICAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgpO1xuICAgICAgfVxuICAgICAgaWYgKGVtaXRTdGF0ZXMpIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLmVycm9yKGUpO1xuICAgIH1cbiAgfVxuXG4gIGNoYW5nZVN0YXRlIChzdGF0ZSkge1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICBsb2cuZGVidWcoYFdpbkFwcERyaXZlciBjaGFuZ2VkIHN0YXRlIHRvICcke3N0YXRlfSdgKTtcbiAgICB0aGlzLmVtaXQoV2luQXBwRHJpdmVyLkVWRU5UX0NIQU5HRUQsIHtzdGF0ZX0pO1xuICB9XG5cbiAgYXN5bmMgc2VuZENvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5UmVxIChyZXEsIHJlcykge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMocmVxLCByZXMpO1xuICB9XG5cbiAgYXN5bmMga2lsbEFsbCAoKSB7XG4gICAgbGV0IGNtZDtcbiAgICAvLyBqcyBoaW50IGNhbm5vdCBoYW5kbGUgYmFja3RpY2tzLCBldmVuIGVzY2FwZWQsIHdpdGhpbiB0ZW1wbGF0ZSBsaXRlcmFsc1xuICAgIGNtZCA9IFwiRk9SIC9GIFxcXCJ1c2ViYWNrcSB0b2tlbnM9NVxcXCIgJWEgaW4gKGBuZXRzdGF0IC1uYW8gXnwgXCIgK1xuICAgICAgICAgIFwiZmluZHN0ciAvUiAvQzpcXFwiXCIgKyB0aGlzLnByb3h5UG9ydCArIFwiIFxcXCJgKSBkbyAoXCIgK1xuICAgICAgICAgIFwiRk9SIC9GIFxcXCJ1c2ViYWNrcVxcXCIgJWIgaW4gKGBUQVNLTElTVCAvRkkgXFxcIlBJRCBlcSAlYVxcXCIgXnwgXCIgK1xuICAgICAgICAgIFwiZmluZHN0ciAvSSB3aW5hcHBkcml2ZXIuZXhlYCkgZG8gKElGIE5PVCAlYj09XFxcIlxcXCIgVEFTS0tJTEwgXCIgK1xuICAgICAgICAgIFwiL0YgL1BJRCAlYSkpXCI7XG4gICAgbG9nLmluZm8oYEtpbGxpbmcgYW55IG9sZCBXaW5BcHBEcml2ZXJzIG9uIHNhbWUgcG9ydCwgcnVubmluZzogJHtjbWR9YCk7XG4gICAgdHJ5IHtcbiAgICAgIC8vIHVzZSBjcC5leGVjIGluc3RlYWQgb2YgdGVlbiBwcm9jZXNzIGJlY2F1c2Ugb2YgY3Jhenkgd2luZG93cyBxdW90aW5nXG4gICAgICBhd2FpdCAoQi5wcm9taXNpZnkoY3AuZXhlYykpKGNtZCk7XG4gICAgICBsb2cuaW5mbyhcIlN1Y2Nlc3NmdWxseSBjbGVhbmVkIHVwIG9sZCBXaW5BcHBEcml2ZXJzXCIpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmluZm8oXCJObyBvbGQgV2luQXBwRHJpdmVycyBzZWVtZWQgdG8gZXhpc3RcIik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nLmRlYnVnKCdEZWxldGluZyBXaW5BcHBEcml2ZXIgc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIFdpbkFwcERyaXZlciBkZWxldGVTZXNzaW9uIHdvcmtlZDsgYCArXG4gICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxufVxuXG5XaW5BcHBEcml2ZXIuRVZFTlRfRVJST1IgPSAnd2luYXBwZHJpdmVyX2Vycm9yJztcbldpbkFwcERyaXZlci5FVkVOVF9DSEFOR0VEID0gJ3N0YXRlQ2hhbmdlZCc7XG5XaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCA9ICdzdG9wcGVkJztcbldpbkFwcERyaXZlci5TVEFURV9TVEFSVElORyA9ICdzdGFydGluZyc7XG5XaW5BcHBEcml2ZXIuU1RBVEVfT05MSU5FID0gJ29ubGluZSc7XG5XaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBJTkcgPSAnc3RvcHBpbmcnO1xuXG5leHBvcnQgeyBXaW5BcHBEcml2ZXIsIERFRkFVTFRfV0FEX0hPU1QsIERFRkFVTFRfV0FEX1BPUlR9O1xuZXhwb3J0IGRlZmF1bHQgV2luQXBwRHJpdmVyO1xuIl0sImZpbGUiOiJsaWIvd2luYXBwZHJpdmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
