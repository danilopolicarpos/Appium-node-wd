"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.detectUdid = detectUdid;
exports.getAndCheckXcodeVersion = getAndCheckXcodeVersion;
exports.getAndCheckIosSdkVersion = getAndCheckIosSdkVersion;
exports.checkAppPresent = checkAppPresent;
exports.getDriverInfo = getDriverInfo;
exports.clearSystemFiles = clearSystemFiles;
exports.translateDeviceName = translateDeviceName;
exports.normalizeCommandTimeouts = normalizeCommandTimeouts;
exports.resetXCTestProcesses = resetXCTestProcesses;
exports.getPIDsUsingPattern = getPIDsUsingPattern;
exports.markSystemFilesForCleanup = markSystemFilesForCleanup;
exports.printUser = printUser;
exports.printLibimobiledeviceInfo = printLibimobiledeviceInfo;
exports.getPIDsListeningOnPort = getPIDsListeningOnPort;
exports.encodeBase64OrUpload = encodeBase64OrUpload;
exports.removeAllSessionWebSocketHandlers = removeAllSessionWebSocketHandlers;
exports.verifyApplicationPlatform = verifyApplicationPlatform;
exports.isTvOS = isTvOS;
exports.isLocalHost = isLocalHost;
exports.normalizePlatformVersion = normalizePlatformVersion;
exports.DEFAULT_TIMEOUT_KEY = void 0;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDriver = require("appium-ios-driver");

var _teen_process = require("teen_process");

var _appiumXcode = _interopRequireDefault(require("appium-xcode"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _fs2 = _interopRequireDefault(require("fs"));

var _url = _interopRequireDefault(require("url"));

var _v = _interopRequireDefault(require("v8"));

var _desiredCaps = require("./desired-caps");

var _semver = _interopRequireDefault(require("semver"));

const DEFAULT_TIMEOUT_KEY = 'default';
exports.DEFAULT_TIMEOUT_KEY = DEFAULT_TIMEOUT_KEY;

async function detectUdid() {
  _logger.default.debug('Auto-detecting real device udid...');

  let cmd,
      args = [];

  try {
    cmd = await _appiumSupport.fs.which('idevice_id');
    args.push('-l');

    _logger.default.debug('Using idevice_id');
  } catch (err) {
    _logger.default.debug('Using udidetect');

    cmd = require.resolve('udidetect');
  }

  let udid;

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)(cmd, args, {
      timeout: 3000
    });

    let udids = _lodash.default.uniq(_lodash.default.filter(stdout.split('\n'), Boolean));

    udid = _lodash.default.last(udids);

    if (udids.length > 1) {
      _logger.default.warn(`Multiple devices found: ${udids.join(', ')}`);

      _logger.default.warn(`Choosing '${udid}'. If this is wrong, manually set with 'udid' desired capability`);
    }
  } catch (err) {
    _logger.default.errorAndThrow(`Error detecting udid: ${err.message}`);
  }

  if (!udid || udid.length <= 2) {
    throw new Error('Could not detect udid.');
  }

  _logger.default.debug(`Detected real device udid: '${udid}'`);

  return udid;
}

async function getAndCheckXcodeVersion() {
  let version;

  try {
    version = await _appiumXcode.default.getVersion(true);
  } catch (err) {
    _logger.default.debug(err);

    _logger.default.errorAndThrow(`Could not determine Xcode version: ${err.message}`);
  }

  if (version.versionFloat < 7.3) {
    _logger.default.errorAndThrow(`Xcode version '${version.versionString}'. Support for ` + `Xcode ${version.versionString} is not supported. ` + `Please upgrade to version 7.3 or higher`);
  }

  return version;
}

async function getAndCheckIosSdkVersion() {
  try {
    return await _appiumXcode.default.getMaxIOSSDK();
  } catch (err) {
    _logger.default.errorAndThrow(`Could not determine iOS SDK version: ${err.message}`);
  }
}

function translateDeviceName(platformVersion, devName = '') {
  let deviceName = devName;

  switch (devName.toLowerCase().trim()) {
    case 'iphone simulator':
      deviceName = 'iPhone 6';
      break;

    case 'ipad simulator':
      deviceName = platformVersion && _appiumSupport.util.compareVersions(platformVersion, '<', '10.3') ? 'iPad Retina' : 'iPad Air';
      break;
  }

  if (deviceName !== devName) {
    _logger.default.debug(`Changing deviceName from '${devName}' to '${deviceName}'`);
  }

  return deviceName;
}

const derivedDataCleanupMarkers = new Map();

async function markSystemFilesForCleanup(wda) {
  if (!wda || !(await wda.retrieveDerivedDataPath())) {
    _logger.default.warn('No WebDriverAgent derived data available, so unable to mark system files for cleanup');

    return;
  }

  const logsRoot = _path.default.resolve((await wda.retrieveDerivedDataPath()), 'Logs');

  let markersCount = 0;

  if (derivedDataCleanupMarkers.has(logsRoot)) {
    markersCount = derivedDataCleanupMarkers.get(logsRoot);
  }

  derivedDataCleanupMarkers.set(logsRoot, ++markersCount);
}

async function clearSystemFiles(wda) {
  if (!wda || !(await wda.retrieveDerivedDataPath())) {
    _logger.default.warn('No WebDriverAgent derived data available, so unable to clear system files');

    return;
  }

  const logsRoot = _path.default.resolve((await wda.retrieveDerivedDataPath()), 'Logs');

  if (derivedDataCleanupMarkers.has(logsRoot)) {
    let markersCount = derivedDataCleanupMarkers.get(logsRoot);
    derivedDataCleanupMarkers.set(logsRoot, --markersCount);

    if (markersCount > 0) {
      _logger.default.info(`Not cleaning '${logsRoot}' folder, because the other session does not expect it to be cleaned`);

      return;
    }
  }

  derivedDataCleanupMarkers.set(logsRoot, 0);
  const cleanupCmd = `find -E /private/var/folders ` + `-regex '.*/Session-WebDriverAgentRunner.*\\.log$|.*/StandardOutputAndStandardError\\.txt$' ` + `-type f -exec sh -c 'echo "" > "{}"' \\;`;
  const cleanupTask = new _teen_process.SubProcess('bash', ['-c', cleanupCmd], {
    detached: true,
    stdio: ['ignore', 'pipe', 'pipe']
  });
  await cleanupTask.start(0, true);

  _logger.default.debug(`Started background XCTest logs cleanup: ${cleanupCmd}`);

  if (await _appiumSupport.fs.exists(logsRoot)) {
    _logger.default.info(`Cleaning test logs in '${logsRoot}' folder`);

    await _appiumIosDriver.utils.clearLogs([logsRoot]);
    return;
  }

  _logger.default.info(`There is no ${logsRoot} folder, so not cleaning files`);
}

async function checkAppPresent(app) {
  _logger.default.debug(`Checking whether app '${app}' is actually present on file system`);

  if (!(await _appiumSupport.fs.exists(app))) {
    _logger.default.errorAndThrow(`Could not find app at '${app}'`);
  }

  _logger.default.debug('App is present');
}

async function getDriverInfo() {
  const stat = await _appiumSupport.fs.stat(_path.default.resolve(__dirname, '..'));
  const built = stat.mtime.getTime();

  const pkg = require(__filename.includes('build/lib/utils') ? '../../package.json' : '../package.json');

  const version = pkg.version;
  return {
    built,
    version
  };
}

function normalizeCommandTimeouts(value) {
  if (typeof value !== 'string') {
    return value;
  }

  let result = {};

  if (!isNaN(value)) {
    result[DEFAULT_TIMEOUT_KEY] = _lodash.default.toInteger(value);
    return result;
  }

  try {
    result = JSON.parse(value);

    if (!_lodash.default.isPlainObject(result)) {
      throw new Error();
    }
  } catch (err) {
    _logger.default.errorAndThrow(`"commandTimeouts" capability should be a valid JSON object. "${value}" was given instead`);
  }

  for (let [cmd, timeout] of _lodash.default.toPairs(result)) {
    if (!_lodash.default.isInteger(timeout) || timeout <= 0) {
      _logger.default.errorAndThrow(`The timeout for "${cmd}" should be a valid natural number of milliseconds. "${timeout}" was given instead`);
    }
  }

  return result;
}

async function getPIDsUsingPattern(pattern, opts = {}) {
  const {
    multi = false,
    ignoreCase = true
  } = opts;
  const args = [`-${ignoreCase ? 'i' : ''}f${multi ? '' : 'n'}`, pattern];

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)('pgrep', args);

    if (multi) {
      const result = stdout.split('\n').filter(x => parseInt(x, 10)).map(x => `${parseInt(x, 10)}`);
      return _lodash.default.isEmpty(result) ? null : result;
    }

    const pid = parseInt(stdout, 10);
    return isNaN(pid) ? null : `${pid}`;
  } catch (err) {
    _logger.default.debug(`'pgrep ${args.join(' ')}' didn't detect any matching processes. Return code: ${err.code}`);

    return null;
  }
}

async function killAppUsingPattern(pgrepPattern) {
  for (const signal of [2, 15, 9]) {
    if (!(await getPIDsUsingPattern(pgrepPattern))) {
      return;
    }

    const args = [`-${signal}`, '-if', pgrepPattern];

    try {
      await (0, _teen_process.exec)('pkill', args);
    } catch (err) {
      _logger.default.debug(`pkill ${args.join(' ')} -> ${err.message}`);
    }

    await _bluebird.default.delay(100);
  }
}

async function resetXCTestProcesses(udid, isSimulator, opts = {}) {
  const processPatterns = [`xcodebuild.*${udid}`];

  if (opts.wdaLocalPort) {
    processPatterns.push(`iproxy ${opts.wdaLocalPort}`);
  } else if (!isSimulator) {
    processPatterns.push(`iproxy.*${udid}`);
  }

  if (isSimulator) {
    processPatterns.push(`${udid}.*XCTRunner`);
  }

  _logger.default.debug(`Killing running processes '${processPatterns.join(', ')}' for the device ${udid}...`);

  for (const pgrepPattern of processPatterns) {
    await killAppUsingPattern(pgrepPattern);
  }
}

async function printUser() {
  try {
    let {
      stdout
    } = await (0, _teen_process.exec)('whoami');

    _logger.default.debug(`Current user: '${stdout.trim()}'`);
  } catch (err) {
    _logger.default.debug(`Unable to get username running server: ${err.message}`);
  }
}

async function printLibimobiledeviceInfo() {
  try {
    let {
      stdout
    } = await (0, _teen_process.exec)('brew', ['info', 'libimobiledevice']);
    let match = /libimobiledevice:(.+)/.exec(stdout);

    if (match && match[1]) {
      _logger.default.debug(`Current version of libimobiledevice: ${match[1].trim()}`);
    }
  } catch (err) {
    _logger.default.debug(`Unable to get version of libimobiledevice: ${err.message}`);
  }
}

async function getPIDsListeningOnPort(port, filteringFunc = null) {
  const result = [];

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)('lsof', ['-ti', `tcp:${port}`]);
    result.push(...stdout.trim().split(/\n+/));
  } catch (e) {
    return result;
  }

  if (!_lodash.default.isFunction(filteringFunc)) {
    return result;
  }

  return await _bluebird.default.filter(result, async x => {
    const {
      stdout
    } = await (0, _teen_process.exec)('ps', ['-p', x, '-o', 'command']);
    return await filteringFunc(stdout);
  });
}

async function encodeBase64OrUpload(localFile, remotePath = null, uploadOptions = {}) {
  if (!(await _appiumSupport.fs.exists(localFile))) {
    _logger.default.errorAndThrow(`The file at '${localFile}' does not exist or is not accessible`);
  }

  const {
    size
  } = await _appiumSupport.fs.stat(localFile);

  _logger.default.debug(`The size of the file is ${_appiumSupport.util.toReadableSizeString(size)}`);

  if (_lodash.default.isEmpty(remotePath)) {
    const maxMemoryLimit = _v.default.getHeapStatistics().total_available_size / 2;

    if (size >= maxMemoryLimit) {
      _logger.default.info(`The file might be too large to fit into the process memory ` + `(${_appiumSupport.util.toReadableSizeString(size)} >= ${_appiumSupport.util.toReadableSizeString(maxMemoryLimit)}). ` + `Provide a link to a remote writable location for video upload ` + `(http(s) and ftp protocols are supported) if you experience Out Of Memory errors`);
    }

    const content = await _appiumSupport.fs.readFile(localFile);
    return content.toString('base64');
  }

  const remoteUrl = _url.default.parse(remotePath);

  let options = {};
  const {
    user,
    pass,
    method
  } = uploadOptions;

  if (remoteUrl.protocol.startsWith('http')) {
    options = {
      url: remoteUrl.href,
      method: method || 'PUT',
      multipart: [{
        body: _fs2.default.createReadStream(localFile)
      }]
    };

    if (user && pass) {
      options.auth = {
        user,
        pass
      };
    }
  } else if (remoteUrl.protocol === 'ftp:') {
    options = {
      host: remoteUrl.hostname,
      port: remoteUrl.port || 21
    };

    if (user && pass) {
      options.user = user;
      options.pass = pass;
    }
  }

  await _appiumSupport.net.uploadFile(localFile, remotePath, options);
  return '';
}

async function removeAllSessionWebSocketHandlers(server, sessionId) {
  if (!server || !_lodash.default.isFunction(server.getWebSocketHandlers)) {
    return;
  }

  const activeHandlers = await server.getWebSocketHandlers(sessionId);

  for (const pathname of _lodash.default.keys(activeHandlers)) {
    await server.removeWebSocketHandler(pathname);
  }
}

async function verifyApplicationPlatform(app, isSimulator) {
  _logger.default.debug('Verifying application platform');

  const infoPlist = _path.default.resolve(app, 'Info.plist');

  if (!(await _appiumSupport.fs.exists(infoPlist))) {
    _logger.default.debug(`'${infoPlist}' does not exist`);

    return null;
  }

  const {
    CFBundleSupportedPlatforms
  } = await _appiumSupport.plist.parsePlistFile(infoPlist);

  _logger.default.debug(`CFBundleSupportedPlatforms: ${JSON.stringify(CFBundleSupportedPlatforms)}`);

  if (!_lodash.default.isArray(CFBundleSupportedPlatforms)) {
    _logger.default.debug(`CFBundleSupportedPlatforms key does not exist in '${infoPlist}'`);

    return null;
  }

  const isAppSupported = isSimulator && CFBundleSupportedPlatforms.includes('iPhoneSimulator') || !isSimulator && CFBundleSupportedPlatforms.includes('iPhoneOS');

  if (isAppSupported) {
    return true;
  }

  throw new Error(`${isSimulator ? 'Simulator' : 'Real device'} architecture is unsupported by the '${app}' application. ` + `Make sure the correct deployment target has been selected for its compilation in Xcode.`);
}

function isTvOS(platformName) {
  return _lodash.default.toLower(platformName) === _lodash.default.toLower(_desiredCaps.PLATFORM_NAME_TVOS);
}

function isLocalHost(urlString) {
  try {
    const {
      hostname
    } = _url.default.parse(urlString);

    return ['localhost', '127.0.0.1', '::1', '::ffff:127.0.0.1'].includes(hostname);
  } catch (ign) {
    _logger.default.warn(`'${urlString}' cannot be parsed as a valid URL`);
  }

  return false;
}

function normalizePlatformVersion(originalVersion) {
  const normalizedVersion = _appiumSupport.util.coerceVersion(originalVersion, false);

  if (!normalizedVersion) {
    throw new Error(`The platform version '${originalVersion}' should be a valid version number`);
  }

  const {
    major,
    minor
  } = new _semver.default.SemVer(normalizedVersion);
  return `${major}.${minor}`;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1RJTUVPVVRfS0VZIiwiZGV0ZWN0VWRpZCIsImxvZyIsImRlYnVnIiwiY21kIiwiYXJncyIsImZzIiwid2hpY2giLCJwdXNoIiwiZXJyIiwicmVxdWlyZSIsInJlc29sdmUiLCJ1ZGlkIiwic3Rkb3V0IiwidGltZW91dCIsInVkaWRzIiwiXyIsInVuaXEiLCJmaWx0ZXIiLCJzcGxpdCIsIkJvb2xlYW4iLCJsYXN0IiwibGVuZ3RoIiwid2FybiIsImpvaW4iLCJlcnJvckFuZFRocm93IiwibWVzc2FnZSIsIkVycm9yIiwiZ2V0QW5kQ2hlY2tYY29kZVZlcnNpb24iLCJ2ZXJzaW9uIiwieGNvZGUiLCJnZXRWZXJzaW9uIiwidmVyc2lvbkZsb2F0IiwidmVyc2lvblN0cmluZyIsImdldEFuZENoZWNrSW9zU2RrVmVyc2lvbiIsImdldE1heElPU1NESyIsInRyYW5zbGF0ZURldmljZU5hbWUiLCJwbGF0Zm9ybVZlcnNpb24iLCJkZXZOYW1lIiwiZGV2aWNlTmFtZSIsInRvTG93ZXJDYXNlIiwidHJpbSIsInV0aWwiLCJjb21wYXJlVmVyc2lvbnMiLCJkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzIiwiTWFwIiwibWFya1N5c3RlbUZpbGVzRm9yQ2xlYW51cCIsIndkYSIsInJldHJpZXZlRGVyaXZlZERhdGFQYXRoIiwibG9nc1Jvb3QiLCJwYXRoIiwibWFya2Vyc0NvdW50IiwiaGFzIiwiZ2V0Iiwic2V0IiwiY2xlYXJTeXN0ZW1GaWxlcyIsImluZm8iLCJjbGVhbnVwQ21kIiwiY2xlYW51cFRhc2siLCJTdWJQcm9jZXNzIiwiZGV0YWNoZWQiLCJzdGRpbyIsInN0YXJ0IiwiZXhpc3RzIiwiaW9zVXRpbHMiLCJjbGVhckxvZ3MiLCJjaGVja0FwcFByZXNlbnQiLCJhcHAiLCJnZXREcml2ZXJJbmZvIiwic3RhdCIsIl9fZGlybmFtZSIsImJ1aWx0IiwibXRpbWUiLCJnZXRUaW1lIiwicGtnIiwiX19maWxlbmFtZSIsImluY2x1ZGVzIiwibm9ybWFsaXplQ29tbWFuZFRpbWVvdXRzIiwidmFsdWUiLCJyZXN1bHQiLCJpc05hTiIsInRvSW50ZWdlciIsIkpTT04iLCJwYXJzZSIsImlzUGxhaW5PYmplY3QiLCJ0b1BhaXJzIiwiaXNJbnRlZ2VyIiwiZ2V0UElEc1VzaW5nUGF0dGVybiIsInBhdHRlcm4iLCJvcHRzIiwibXVsdGkiLCJpZ25vcmVDYXNlIiwieCIsInBhcnNlSW50IiwibWFwIiwiaXNFbXB0eSIsInBpZCIsImNvZGUiLCJraWxsQXBwVXNpbmdQYXR0ZXJuIiwicGdyZXBQYXR0ZXJuIiwic2lnbmFsIiwiQiIsImRlbGF5IiwicmVzZXRYQ1Rlc3RQcm9jZXNzZXMiLCJpc1NpbXVsYXRvciIsInByb2Nlc3NQYXR0ZXJucyIsIndkYUxvY2FsUG9ydCIsInByaW50VXNlciIsInByaW50TGliaW1vYmlsZWRldmljZUluZm8iLCJtYXRjaCIsImV4ZWMiLCJnZXRQSURzTGlzdGVuaW5nT25Qb3J0IiwicG9ydCIsImZpbHRlcmluZ0Z1bmMiLCJlIiwiaXNGdW5jdGlvbiIsImVuY29kZUJhc2U2NE9yVXBsb2FkIiwibG9jYWxGaWxlIiwicmVtb3RlUGF0aCIsInVwbG9hZE9wdGlvbnMiLCJzaXplIiwidG9SZWFkYWJsZVNpemVTdHJpbmciLCJtYXhNZW1vcnlMaW1pdCIsInY4IiwiZ2V0SGVhcFN0YXRpc3RpY3MiLCJ0b3RhbF9hdmFpbGFibGVfc2l6ZSIsImNvbnRlbnQiLCJyZWFkRmlsZSIsInRvU3RyaW5nIiwicmVtb3RlVXJsIiwidXJsIiwib3B0aW9ucyIsInVzZXIiLCJwYXNzIiwibWV0aG9kIiwicHJvdG9jb2wiLCJzdGFydHNXaXRoIiwiaHJlZiIsIm11bHRpcGFydCIsImJvZHkiLCJfZnMiLCJjcmVhdGVSZWFkU3RyZWFtIiwiYXV0aCIsImhvc3QiLCJob3N0bmFtZSIsIm5ldCIsInVwbG9hZEZpbGUiLCJyZW1vdmVBbGxTZXNzaW9uV2ViU29ja2V0SGFuZGxlcnMiLCJzZXJ2ZXIiLCJzZXNzaW9uSWQiLCJnZXRXZWJTb2NrZXRIYW5kbGVycyIsImFjdGl2ZUhhbmRsZXJzIiwicGF0aG5hbWUiLCJrZXlzIiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciIsInZlcmlmeUFwcGxpY2F0aW9uUGxhdGZvcm0iLCJpbmZvUGxpc3QiLCJDRkJ1bmRsZVN1cHBvcnRlZFBsYXRmb3JtcyIsInBsaXN0IiwicGFyc2VQbGlzdEZpbGUiLCJzdHJpbmdpZnkiLCJpc0FycmF5IiwiaXNBcHBTdXBwb3J0ZWQiLCJpc1R2T1MiLCJwbGF0Zm9ybU5hbWUiLCJ0b0xvd2VyIiwiUExBVEZPUk1fTkFNRV9UVk9TIiwiaXNMb2NhbEhvc3QiLCJ1cmxTdHJpbmciLCJpZ24iLCJub3JtYWxpemVQbGF0Zm9ybVZlcnNpb24iLCJvcmlnaW5hbFZlcnNpb24iLCJub3JtYWxpemVkVmVyc2lvbiIsImNvZXJjZVZlcnNpb24iLCJtYWpvciIsIm1pbm9yIiwic2VtdmVyIiwiU2VtVmVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsbUJBQW1CLEdBQUcsU0FBNUI7OztBQUdBLGVBQWVDLFVBQWYsR0FBNkI7QUFDM0JDLGtCQUFJQyxLQUFKLENBQVUsb0NBQVY7O0FBQ0EsTUFBSUMsR0FBSjtBQUFBLE1BQVNDLElBQUksR0FBRyxFQUFoQjs7QUFDQSxNQUFJO0FBQ0ZELElBQUFBLEdBQUcsR0FBRyxNQUFNRSxrQkFBR0MsS0FBSCxDQUFTLFlBQVQsQ0FBWjtBQUNBRixJQUFBQSxJQUFJLENBQUNHLElBQUwsQ0FBVSxJQUFWOztBQUNBTixvQkFBSUMsS0FBSixDQUFVLGtCQUFWO0FBQ0QsR0FKRCxDQUlFLE9BQU9NLEdBQVAsRUFBWTtBQUNaUCxvQkFBSUMsS0FBSixDQUFVLGlCQUFWOztBQUNBQyxJQUFBQSxHQUFHLEdBQUdNLE9BQU8sQ0FBQ0Ms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QURYLENBQU47QUFFRDs7QUFPRCxTQUFTZ0csTUFBVCxDQUFpQkMsWUFBakIsRUFBK0I7QUFDN0IsU0FBT3BKLGdCQUFFcUosT0FBRixDQUFVRCxZQUFWLE1BQTRCcEosZ0JBQUVxSixPQUFGLENBQVVDLCtCQUFWLENBQW5DO0FBQ0Q7O0FBT0QsU0FBU0MsV0FBVCxDQUFzQkMsU0FBdEIsRUFBaUM7QUFDL0IsTUFBSTtBQUNGLFVBQU07QUFBQ3hCLE1BQUFBO0FBQUQsUUFBYWQsYUFBSS9DLEtBQUosQ0FBVXFGLFNBQVYsQ0FBbkI7O0FBQ0EsV0FBTyxDQUFDLFdBQUQsRUFBYyxXQUFkLEVBQTJCLEtBQTNCLEVBQWtDLGtCQUFsQyxFQUFzRDVGLFFBQXRELENBQStEb0UsUUFBL0QsQ0FBUDtBQUNELEdBSEQsQ0FHRSxPQUFPeUIsR0FBUCxFQUFZO0FBQ1p2SyxvQkFBSXFCLElBQUosQ0FBVSxJQUFHaUosU0FBVSxtQ0FBdkI7QUFDRDs7QUFDRCxTQUFPLEtBQVA7QUFDRDs7QUFTRCxTQUFTRSx3QkFBVCxDQUFtQ0MsZUFBbkMsRUFBb0Q7QUFDbEQsUUFBTUMsaUJBQWlCLEdBQUdsSSxvQkFBS21JLGFBQUwsQ0FBbUJGLGVBQW5CLEVBQW9DLEtBQXBDLENBQTFCOztBQUNBLE1BQUksQ0FBQ0MsaUJBQUwsRUFBd0I7QUFDdEIsVUFBTSxJQUFJakosS0FBSixDQUFXLHlCQUF3QmdKLGVBQWdCLG9DQUFuRCxDQUFOO0FBQ0Q7O0FBQ0QsUUFBTTtBQUFDRyxJQUFBQSxLQUFEO0FBQVFDLElBQUFBO0FBQVIsTUFBaUIsSUFBSUMsZ0JBQU9DLE1BQVgsQ0FBa0JMLGlCQUFsQixDQUF2QjtBQUNBLFNBQVEsR0FBRUUsS0FBTSxJQUFHQyxLQUFNLEVBQXpCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBmcywgdXRpbCwgbmV0LCBwbGlzdCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgdXRpbHMgYXMgaW9zVXRpbHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgeyBTdWJQcm9jZXNzLCBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB4Y29kZSBmcm9tICdhcHBpdW0teGNvZGUnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF9mcyBmcm9tICdmcyc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgdjggZnJvbSAndjgnO1xuaW1wb3J0IHsgUExBVEZPUk1fTkFNRV9UVk9TIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuXG5jb25zdCBERUZBVUxUX1RJTUVPVVRfS0VZID0gJ2RlZmF1bHQnO1xuXG5cbmFzeW5jIGZ1bmN0aW9uIGRldGVjdFVkaWQgKCkge1xuICBsb2cuZGVidWcoJ0F1dG8tZGV0ZWN0aW5nIHJlYWwgZGV2aWNlIHVkaWQuLi4nKTtcbiAgbGV0IGNtZCwgYXJncyA9IFtdO1xuICB0cnkge1xuICAgIGNtZCA9IGF3YWl0IGZzLndoaWNoKCdpZGV2aWNlX2lkJyk7XG4gICAgYXJncy5wdXNoKCctbCcpO1xuICAgIGxvZy5kZWJ1ZygnVXNpbmcgaWRldmljZV9pZCcpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoJ1VzaW5nIHVkaWRldGVjdCcpO1xuICAgIGNtZCA9IHJlcXVpcmUucmVzb2x2ZSgndWRpZGV0ZWN0Jyk7XG4gIH1cbiAgbGV0IHVkaWQ7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhjbWQsIGFyZ3MsIHt0aW1lb3V0OiAzMDAwfSk7XG4gICAgbGV0IHVkaWRzID0gXy51bmlxKF8uZmlsdGVyKHN0ZG91dC5zcGxpdCgnXFxuJyksIEJvb2xlYW4pKTtcbiAgICB1ZGlkID0gXy5sYXN0KHVkaWRzKTtcbiAgICBpZiAodWRpZHMubGVuZ3RoID4gMSkge1xuICAgICAgbG9nLndhcm4oYE11bHRpcGxlIGRldmljZXMgZm91bmQ6ICR7dWRpZHMuam9pbignLCAnKX1gKTtcbiAgICAgIGxvZy53YXJuKGBDaG9vc2luZyAnJHt1ZGlkfScuIElmIHRoaXMgaXMgd3JvbmcsIG1hbnVhbGx5IHNldCB3aXRoICd1ZGlkJyBkZXNpcmVkIGNhcGFiaWxpdHlgKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBFcnJvciBkZXRlY3RpbmcgdWRpZDogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICBpZiAoIXVkaWQgfHwgdWRpZC5sZW5ndGggPD0gMikge1xuICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGRldGVjdCB1ZGlkLicpO1xuICB9XG4gIGxvZy5kZWJ1ZyhgRGV0ZWN0ZWQgcmVhbCBkZXZpY2UgdWRpZDogJyR7dWRpZH0nYCk7XG4gIHJldHVybiB1ZGlkO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBbmRDaGVja1hjb2RlVmVyc2lvbiAoKSB7XG4gIGxldCB2ZXJzaW9uO1xuICB0cnkge1xuICAgIHZlcnNpb24gPSBhd2FpdCB4Y29kZS5nZXRWZXJzaW9uKHRydWUpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoZXJyKTtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IGRldGVybWluZSBYY29kZSB2ZXJzaW9uOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG5cbiAgLy8gd2UgZG8gbm90IHN1cHBvcnQgWGNvZGVzIDwgNy4zLFxuICBpZiAodmVyc2lvbi52ZXJzaW9uRmxvYXQgPCA3LjMpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgWGNvZGUgdmVyc2lvbiAnJHt2ZXJzaW9uLnZlcnNpb25TdHJpbmd9Jy4gU3VwcG9ydCBmb3IgYCArXG4gICAgICAgICAgICAgICAgICAgICAgYFhjb2RlICR7dmVyc2lvbi52ZXJzaW9uU3RyaW5nfSBpcyBub3Qgc3VwcG9ydGVkLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgUGxlYXNlIHVwZ3JhZGUgdG8gdmVyc2lvbiA3LjMgb3IgaGlnaGVyYCk7XG4gIH1cbiAgcmV0dXJuIHZlcnNpb247XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFuZENoZWNrSW9zU2RrVmVyc2lvbiAoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IHhjb2RlLmdldE1heElPU1NESygpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IGRldGVybWluZSBpT1MgU0RLIHZlcnNpb246ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gdHJhbnNsYXRlRGV2aWNlTmFtZSAocGxhdGZvcm1WZXJzaW9uLCBkZXZOYW1lID0gJycpIHtcbiAgbGV0IGRldmljZU5hbWUgPSBkZXZOYW1lO1xuICBzd2l0Y2ggKGRldk5hbWUudG9Mb3dlckNhc2UoKS50cmltKCkpIHtcbiAgICBjYXNlICdpcGhvbmUgc2ltdWxhdG9yJzpcbiAgICAgIGRldmljZU5hbWUgPSAnaVBob25lIDYnO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnaXBhZCBzaW11bGF0b3InOlxuICAgICAgLy8gaVBhZCBSZXRpbmEgaXMgbm8gbG9uZ2VyIGF2YWlsYWJsZSBmb3IgaW9zIDEwLjNcbiAgICAgIC8vICAgc28gd2UgcGljayBhbm90aGVyIGlQYWQgdG8gdXNlIGFzIGRlZmF1bHRcbiAgICAgIGRldmljZU5hbWUgPSBwbGF0Zm9ybVZlcnNpb24gJiYgdXRpbC5jb21wYXJlVmVyc2lvbnMocGxhdGZvcm1WZXJzaW9uLCAnPCcsICcxMC4zJykgPyAnaVBhZCBSZXRpbmEnIDogJ2lQYWQgQWlyJztcbiAgICAgIGJyZWFrO1xuICB9XG5cbiAgaWYgKGRldmljZU5hbWUgIT09IGRldk5hbWUpIHtcbiAgICBsb2cuZGVidWcoYENoYW5naW5nIGRldmljZU5hbWUgZnJvbSAnJHtkZXZOYW1lfScgdG8gJyR7ZGV2aWNlTmFtZX0nYCk7XG4gIH1cbiAgcmV0dXJuIGRldmljZU5hbWU7XG59XG5cbi8vIFRoaXMgbWFwIGNvbnRhaW5zIGRlcml2ZWQgZGF0YSBsb2dzIGZvbGRlcnMgYXMga2V5c1xuLy8gYW5kIHZhbHVlcyBhcmUgdGhlIGNvdW50IG9mIHRpbWVzIHRoZSBwYXJ0aWN1bGFyXG4vLyBmb2xkZXIgaGFzIGJlZW4gc2NoZWR1bGVkIGZvciByZW1vdmFsXG5jb25zdCBkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzID0gbmV3IE1hcCgpO1xuXG5hc3luYyBmdW5jdGlvbiBtYXJrU3lzdGVtRmlsZXNGb3JDbGVhbnVwICh3ZGEpIHtcbiAgaWYgKCF3ZGEgfHwgIWF3YWl0IHdkYS5yZXRyaWV2ZURlcml2ZWREYXRhUGF0aCgpKSB7XG4gICAgbG9nLndhcm4oJ05vIFdlYkRyaXZlckFnZW50IGRlcml2ZWQgZGF0YSBhdmFpbGFibGUsIHNvIHVuYWJsZSB0byBtYXJrIHN5c3RlbSBmaWxlcyBmb3IgY2xlYW51cCcpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGxvZ3NSb290ID0gcGF0aC5yZXNvbHZlKGF3YWl0IHdkYS5yZXRyaWV2ZURlcml2ZWREYXRhUGF0aCgpLCAnTG9ncycpO1xuICBsZXQgbWFya2Vyc0NvdW50ID0gMDtcbiAgaWYgKGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMuaGFzKGxvZ3NSb290KSkge1xuICAgIG1hcmtlcnNDb3VudCA9IGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMuZ2V0KGxvZ3NSb290KTtcbiAgfVxuICBkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzLnNldChsb2dzUm9vdCwgKyttYXJrZXJzQ291bnQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjbGVhclN5c3RlbUZpbGVzICh3ZGEpIHtcbiAgLy8gb25seSB3YW50IHRvIGNsZWFyIHRoZSBzeXN0ZW0gZmlsZXMgZm9yIHRoZSBwYXJ0aWN1bGFyIFdEQSB4Y29kZSBydW5cbiAgaWYgKCF3ZGEgfHwgIWF3YWl0IHdkYS5yZXRyaWV2ZURlcml2ZWREYXRhUGF0aCgpKSB7XG4gICAgbG9nLndhcm4oJ05vIFdlYkRyaXZlckFnZW50IGRlcml2ZWQgZGF0YSBhdmFpbGFibGUsIHNvIHVuYWJsZSB0byBjbGVhciBzeXN0ZW0gZmlsZXMnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBsb2dzUm9vdCA9IHBhdGgucmVzb2x2ZShhd2FpdCB3ZGEucmV0cmlldmVEZXJpdmVkRGF0YVBhdGgoKSwgJ0xvZ3MnKTtcbiAgaWYgKGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMuaGFzKGxvZ3NSb290KSkge1xuICAgIGxldCBtYXJrZXJzQ291bnQgPSBkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzLmdldChsb2dzUm9vdCk7XG4gICAgZGVyaXZlZERhdGFDbGVhbnVwTWFya2Vycy5zZXQobG9nc1Jvb3QsIC0tbWFya2Vyc0NvdW50KTtcbiAgICBpZiAobWFya2Vyc0NvdW50ID4gMCkge1xuICAgICAgbG9nLmluZm8oYE5vdCBjbGVhbmluZyAnJHtsb2dzUm9vdH0nIGZvbGRlciwgYmVjYXVzZSB0aGUgb3RoZXIgc2Vzc2lvbiBkb2VzIG5vdCBleHBlY3QgaXQgdG8gYmUgY2xlYW5lZGApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxuICBkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzLnNldChsb2dzUm9vdCwgMCk7XG5cbiAgLy8gQ2xlYW5pbmcgdXAgYmlnIHRlbXBvcmFyeSBmaWxlcyBjcmVhdGVkIGJ5IFhDVGVzdDogaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzk0MTBcbiAgY29uc3QgY2xlYW51cENtZCA9IGBmaW5kIC1FIC9wcml2YXRlL3Zhci9mb2xkZXJzIGAgK1xuICAgIGAtcmVnZXggJy4qL1Nlc3Npb24tV2ViRHJpdmVyQWdlbnRSdW5uZXIuKlxcXFwubG9nJHwuKi9TdGFuZGFyZE91dHB1dEFuZFN0YW5kYXJkRXJyb3JcXFxcLnR4dCQnIGAgK1xuICAgIGAtdHlwZSBmIC1leGVjIHNoIC1jICdlY2hvIFwiXCIgPiBcInt9XCInIFxcXFw7YDtcbiAgY29uc3QgY2xlYW51cFRhc2sgPSBuZXcgU3ViUHJvY2VzcygnYmFzaCcsIFsnLWMnLCBjbGVhbnVwQ21kXSwge1xuICAgIGRldGFjaGVkOiB0cnVlLFxuICAgIHN0ZGlvOiBbJ2lnbm9yZScsICdwaXBlJywgJ3BpcGUnXSxcbiAgfSk7XG4gIC8vIERvIG5vdCB3YWl0IGZvciB0aGUgdGFzayB0byBiZSBjb21wbGV0ZWQsIHNpbmNlIGl0IG1pZ2h0IHRha2UgYSBsb3Qgb2YgdGltZVxuICAvLyBXZSBrZWVwIGl0IHJ1bm5pbmcgYWZ0ZXIgQXBwaXVtIHByb2Nlc3MgaXMga2lsbGVkXG4gIGF3YWl0IGNsZWFudXBUYXNrLnN0YXJ0KDAsIHRydWUpO1xuICBsb2cuZGVidWcoYFN0YXJ0ZWQgYmFja2dyb3VuZCBYQ1Rlc3QgbG9ncyBjbGVhbnVwOiAke2NsZWFudXBDbWR9YCk7XG5cbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhsb2dzUm9vdCkpIHtcbiAgICBsb2cuaW5mbyhgQ2xlYW5pbmcgdGVzdCBsb2dzIGluICcke2xvZ3NSb290fScgZm9sZGVyYCk7XG4gICAgYXdhaXQgaW9zVXRpbHMuY2xlYXJMb2dzKFtsb2dzUm9vdF0pO1xuICAgIHJldHVybjtcbiAgfVxuICBsb2cuaW5mbyhgVGhlcmUgaXMgbm8gJHtsb2dzUm9vdH0gZm9sZGVyLCBzbyBub3QgY2xlYW5pbmcgZmlsZXNgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tBcHBQcmVzZW50IChhcHApIHtcbiAgbG9nLmRlYnVnKGBDaGVja2luZyB3aGV0aGVyIGFwcCAnJHthcHB9JyBpcyBhY3R1YWxseSBwcmVzZW50IG9uIGZpbGUgc3lzdGVtYCk7XG4gIGlmICghKGF3YWl0IGZzLmV4aXN0cyhhcHApKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgZmluZCBhcHAgYXQgJyR7YXBwfSdgKTtcbiAgfVxuICBsb2cuZGVidWcoJ0FwcCBpcyBwcmVzZW50Jyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldERyaXZlckluZm8gKCkge1xuICBjb25zdCBzdGF0ID0gYXdhaXQgZnMuc3RhdChwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nKSk7XG4gIGNvbnN0IGJ1aWx0ID0gc3RhdC5tdGltZS5nZXRUaW1lKCk7XG5cbiAgLy8gZ2V0IHRoZSBwYWNrYWdlLmpzb24gYW5kIHRoZSB2ZXJzaW9uIGZyb20gaXRcbiAgY29uc3QgcGtnID0gcmVxdWlyZShfX2ZpbGVuYW1lLmluY2x1ZGVzKCdidWlsZC9saWIvdXRpbHMnKSA/ICcuLi8uLi9wYWNrYWdlLmpzb24nIDogJy4uL3BhY2thZ2UuanNvbicpO1xuICBjb25zdCB2ZXJzaW9uID0gcGtnLnZlcnNpb247XG5cbiAgcmV0dXJuIHtcbiAgICBidWlsdCxcbiAgICB2ZXJzaW9uLFxuICB9O1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVDb21tYW5kVGltZW91dHMgKHZhbHVlKSB7XG4gIC8vIFRoZSB2YWx1ZSBpcyBub3JtYWxpemVkIGFscmVhZHlcbiAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICBsZXQgcmVzdWx0ID0ge307XG4gIC8vIFVzZSBhcyBkZWZhdWx0IHRpbWVvdXQgZm9yIGFsbCBjb21tYW5kcyBpZiBhIHNpbmdsZSBpbnRlZ2VyIHZhbHVlIGlzIHByb3ZpZGVkXG4gIGlmICghaXNOYU4odmFsdWUpKSB7XG4gICAgcmVzdWx0W0RFRkFVTFRfVElNRU9VVF9LRVldID0gXy50b0ludGVnZXIodmFsdWUpO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvLyBKU09OIG9iamVjdCBoYXMgYmVlbiBwcm92aWRlZC4gTGV0J3MgcGFyc2UgaXRcbiAgdHJ5IHtcbiAgICByZXN1bHQgPSBKU09OLnBhcnNlKHZhbHVlKTtcbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChyZXN1bHQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBcImNvbW1hbmRUaW1lb3V0c1wiIGNhcGFiaWxpdHkgc2hvdWxkIGJlIGEgdmFsaWQgSlNPTiBvYmplY3QuIFwiJHt2YWx1ZX1cIiB3YXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIGZvciAobGV0IFtjbWQsIHRpbWVvdXRdIG9mIF8udG9QYWlycyhyZXN1bHQpKSB7XG4gICAgaWYgKCFfLmlzSW50ZWdlcih0aW1lb3V0KSB8fCB0aW1lb3V0IDw9IDApIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgdGltZW91dCBmb3IgXCIke2NtZH1cIiBzaG91bGQgYmUgYSB2YWxpZCBuYXR1cmFsIG51bWJlciBvZiBtaWxsaXNlY29uZHMuIFwiJHt0aW1lb3V0fVwiIHdhcyBnaXZlbiBpbnN0ZWFkYCk7XG4gICAgfVxuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUGlkTG9va3VwT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IG11bHRpIFtmYWxzZV0gLSBTZXQgaXQgdG8gdHJ1ZSBpZiBtdWx0aXBsZSBtYXRjaGluZ1xuICogcGlkcyBhcmUgZXhwZWN0ZWQgdG8gYmUgZm91bmQuIE9ubHkgdGhlIG5ld2VzdCBwcm9jZXNzIGlkIGlzIGdvaW5nIHRvXG4gKiBiZSByZXR1cm5lZCBpbnN0ZWFkXG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBpZ25vcmVDYXNlIFt0cnVlXSAtIFNldCBpdCB0byBmYWxzZSB0byBtYWtlIHRoZSBzZWFyY2hcbiAqIGNhc2Utc2Vuc2l0aXZlXG4gKi9cblxuLyoqXG4gKiBHZXQgdGhlIHByb2Nlc3MgaWQgb2YgdGhlIG1vc3QgcmVjZW50IHJ1bm5pbmcgYXBwbGljYXRpb25cbiAqIGhhdmluZyB0aGUgcGFydGljdWxhciBjb21tYW5kIGxpbmUgcGF0dGVybi5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcGF0dGVybiAtIHBncmVwLWNvbXBhdGlibGUgc2VhcmNoIHBhdHRlcm4uXG4gKiBAcGFyYW0gez9QaWRMb29rdXBPcHRpb25zfSBvcHRzXG4gKiBAcmV0dXJuIHs/c3RyaW5nfEFycmF5PHN0cmluZz59IEVpdGhlciBhIHByb2Nlc3MgaWQgb3IgbnVsbCBpZiBubyBtYXRjaGVzIHdlcmUgZm91bmQuXG4gKiBBbiBhcnJheSBvZiBzdHJpbmdzIGlzIGdvaW5nIHRvIGJlIHJldHVybmVkIGlmIGBvcHRzLm11bHRpYCBpcyBzZXQgdG8gdHJ1ZVxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRQSURzVXNpbmdQYXR0ZXJuIChwYXR0ZXJuLCBvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIG11bHRpID0gZmFsc2UsXG4gICAgaWdub3JlQ2FzZSA9IHRydWUsXG4gIH0gPSBvcHRzO1xuICBjb25zdCBhcmdzID0gW2AtJHtpZ25vcmVDYXNlID8gJ2knIDogJyd9ZiR7bXVsdGkgPyAnJyA6ICduJ31gLCBwYXR0ZXJuXTtcbiAgdHJ5IHtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3BncmVwJywgYXJncyk7XG4gICAgaWYgKG11bHRpKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBzdGRvdXQuc3BsaXQoJ1xcbicpXG4gICAgICAgIC5maWx0ZXIoKHgpID0+IHBhcnNlSW50KHgsIDEwKSlcbiAgICAgICAgLm1hcCgoeCkgPT4gYCR7cGFyc2VJbnQoeCwgMTApfWApO1xuICAgICAgcmV0dXJuIF8uaXNFbXB0eShyZXN1bHQpID8gbnVsbCA6IHJlc3VsdDtcbiAgICB9XG4gICAgY29uc3QgcGlkID0gcGFyc2VJbnQoc3Rkb3V0LCAxMCk7XG4gICAgcmV0dXJuIGlzTmFOKHBpZCkgPyBudWxsIDogYCR7cGlkfWA7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5kZWJ1ZyhgJ3BncmVwICR7YXJncy5qb2luKCcgJyl9JyBkaWRuJ3QgZGV0ZWN0IGFueSBtYXRjaGluZyBwcm9jZXNzZXMuIFJldHVybiBjb2RlOiAke2Vyci5jb2RlfWApO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbi8qKlxuICogS2lsbCBhIHByb2Nlc3MgaGF2aW5nIHRoZSBwYXJ0aWN1bGFyIGNvbW1hbmQgbGluZSBwYXR0ZXJuLlxuICogVGhpcyBtZXRob2QgdHJpZXMgdG8gc2VuZCBTSUdJTlQsIFNJR1RFUk0gYW5kIFNJR0tJTEwgdG8gdGhlXG4gKiBtYXRjaGVkIHByb2Nlc3NlcyBpbiB0aGlzIG9yZGVyIGlmIHRoZSBwcm9jZXNzIGlzIHN0aWxsIHJ1bm5pbmcuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBncmVwUGF0dGVybiAtIHBncmVwLWNvbXBhdGlibGUgc2VhcmNoIHBhdHRlcm4uXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGtpbGxBcHBVc2luZ1BhdHRlcm4gKHBncmVwUGF0dGVybikge1xuICBmb3IgKGNvbnN0IHNpZ25hbCBvZiBbMiwgMTUsIDldKSB7XG4gICAgaWYgKCFhd2FpdCBnZXRQSURzVXNpbmdQYXR0ZXJuKHBncmVwUGF0dGVybikpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgYXJncyA9IFtgLSR7c2lnbmFsfWAsICctaWYnLCBwZ3JlcFBhdHRlcm5dO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKCdwa2lsbCcsIGFyZ3MpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmRlYnVnKGBwa2lsbCAke2FyZ3Muam9pbignICcpfSAtPiAke2Vyci5tZXNzYWdlfWApO1xuICAgIH1cbiAgICBhd2FpdCBCLmRlbGF5KDEwMCk7XG4gIH1cbn1cblxuLyoqXG4gKiBLaWxscyBydW5uaW5nIFhDVGVzdCBwcm9jZXNzZXMgZm9yIHRoZSBwYXJ0aWN1bGFyIGRldmljZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gdWRpZCAtIFRoZSBkZXZpY2UgVURJRC5cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNTaW11bGF0b3IgLSBFcXVhbHMgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBkZXZpY2UgaXMgYSBTaW11bGF0b3JcbiAqIEBwYXJhbSB7b2JqZWN0fSBvcHRzIC0gQWRkaXRpb25hbCBvcHRpb25zIG1hcHBpbmcuIFBvc3NpYmxlIGtleXMgYXJlOlxuICogICAtIHtzdHJpbmd8bnVtYmVyfSB3ZGFMb2NhbFBvcnQ6IFRoZSBudW1iZXIgb2YgbG9jYWwgcG9ydCBXREEgaXMgbGlzdGVuaW5nIG9uLlxuICovXG5hc3luYyBmdW5jdGlvbiByZXNldFhDVGVzdFByb2Nlc3NlcyAodWRpZCwgaXNTaW11bGF0b3IsIG9wdHMgPSB7fSkge1xuICBjb25zdCBwcm9jZXNzUGF0dGVybnMgPSBbYHhjb2RlYnVpbGQuKiR7dWRpZH1gXTtcbiAgaWYgKG9wdHMud2RhTG9jYWxQb3J0KSB7XG4gICAgcHJvY2Vzc1BhdHRlcm5zLnB1c2goYGlwcm94eSAke29wdHMud2RhTG9jYWxQb3J0fWApO1xuICB9IGVsc2UgaWYgKCFpc1NpbXVsYXRvcikge1xuICAgIHByb2Nlc3NQYXR0ZXJucy5wdXNoKGBpcHJveHkuKiR7dWRpZH1gKTtcbiAgfVxuICBpZiAoaXNTaW11bGF0b3IpIHtcbiAgICBwcm9jZXNzUGF0dGVybnMucHVzaChgJHt1ZGlkfS4qWENUUnVubmVyYCk7XG4gIH1cbiAgbG9nLmRlYnVnKGBLaWxsaW5nIHJ1bm5pbmcgcHJvY2Vzc2VzICcke3Byb2Nlc3NQYXR0ZXJucy5qb2luKCcsICcpfScgZm9yIHRoZSBkZXZpY2UgJHt1ZGlkfS4uLmApO1xuICBmb3IgKGNvbnN0IHBncmVwUGF0dGVybiBvZiBwcm9jZXNzUGF0dGVybnMpIHtcbiAgICBhd2FpdCBraWxsQXBwVXNpbmdQYXR0ZXJuKHBncmVwUGF0dGVybik7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJpbnRVc2VyICgpIHtcbiAgdHJ5IHtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKCd3aG9hbWknKTtcbiAgICBsb2cuZGVidWcoYEN1cnJlbnQgdXNlcjogJyR7c3Rkb3V0LnRyaW0oKX0nYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5kZWJ1ZyhgVW5hYmxlIHRvIGdldCB1c2VybmFtZSBydW5uaW5nIHNlcnZlcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwcmludExpYmltb2JpbGVkZXZpY2VJbmZvICgpIHtcbiAgdHJ5IHtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdicmV3JywgWydpbmZvJywgJ2xpYmltb2JpbGVkZXZpY2UnXSk7XG4gICAgbGV0IG1hdGNoID0gL2xpYmltb2JpbGVkZXZpY2U6KC4rKS8uZXhlYyhzdGRvdXQpO1xuICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSkge1xuICAgICAgbG9nLmRlYnVnKGBDdXJyZW50IHZlcnNpb24gb2YgbGliaW1vYmlsZWRldmljZTogJHttYXRjaFsxXS50cmltKCl9YCk7XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYFVuYWJsZSB0byBnZXQgdmVyc2lvbiBvZiBsaWJpbW9iaWxlZGV2aWNlOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG59XG5cbi8qKlxuICogR2V0IHRoZSBJRHMgb2YgcHJvY2Vzc2VzIGxpc3RlbmluZyBvbiB0aGUgcGFydGljdWxhciBzeXN0ZW0gcG9ydC5cbiAqIEl0IGlzIGFsc28gcG9zc2libGUgdG8gYXBwbHkgYWRkaXRpb25hbCBmaWx0ZXJpbmcgYmFzZWQgb24gdGhlXG4gKiBwcm9jZXNzIGNvbW1hbmQgbGluZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IHBvcnQgLSBUaGUgcG9ydCBudW1iZXIuXG4gKiBAcGFyYW0gez9GdW5jdGlvbn0gZmlsdGVyaW5nRnVuYyAtIE9wdGlvbmFsIGxhbWJkYSBmdW5jdGlvbiwgd2hpY2hcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjZWl2ZXMgY29tbWFuZCBsaW5lIHN0cmluZyBvZiB0aGUgcGFydGljdWxhciBwcm9jZXNzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmluZyBvbiBnaXZlbiBwb3J0LCBhbmQgaXMgZXhwZWN0ZWQgdG8gcmV0dXJuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVpdGhlciB0cnVlIG9yIGZhbHNlIHRvIGluY2x1ZGUvZXhjbHVkZSB0aGUgY29ycmVzcG9uZGluZyBQSURcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSB0aGUgcmVzdWx0aW5nIGFycmF5LlxuICogQHJldHVybnMge0FycmF5PHN0cmluZz59IC0gdGhlIGxpc3Qgb2YgbWF0Y2hlZCBwcm9jZXNzIGlkcy5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0UElEc0xpc3RlbmluZ09uUG9ydCAocG9ydCwgZmlsdGVyaW5nRnVuYyA9IG51bGwpIHtcbiAgY29uc3QgcmVzdWx0ID0gW107XG4gIHRyeSB7XG4gICAgLy8gVGhpcyBvbmx5IHdvcmtzIHNpbmNlIE1hYyBPUyBYIEVsIENhcGl0YW5cbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ2xzb2YnLCBbJy10aScsIGB0Y3A6JHtwb3J0fWBdKTtcbiAgICByZXN1bHQucHVzaCguLi4oc3Rkb3V0LnRyaW0oKS5zcGxpdCgvXFxuKy8pKSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgaWYgKCFfLmlzRnVuY3Rpb24oZmlsdGVyaW5nRnVuYykpIHtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIHJldHVybiBhd2FpdCBCLmZpbHRlcihyZXN1bHQsIGFzeW5jICh4KSA9PiB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdwcycsIFsnLXAnLCB4LCAnLW8nLCAnY29tbWFuZCddKTtcbiAgICByZXR1cm4gYXdhaXQgZmlsdGVyaW5nRnVuYyhzdGRvdXQpO1xuICB9KTtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBVcGxvYWRPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1c2VyIC0gVGhlIG5hbWUgb2YgdGhlIHVzZXIgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwYXNzIC0gVGhlIHBhc3N3b3JkIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWV0aG9kIC0gVGhlIGh0dHAgbXVsdGlwYXJ0IHVwbG9hZCBtZXRob2QgbmFtZS4gVGhlICdQVVQnIG9uZSBpcyB1c2VkIGJ5IGRlZmF1bHQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICovXG5cblxuLyoqXG4gKiBFbmNvZGVzIHRoZSBnaXZlbiBsb2NhbCBmaWxlIHRvIGJhc2U2NCBhbmQgcmV0dXJucyB0aGUgcmVzdWx0aW5nIHN0cmluZ1xuICogb3IgdXBsb2FkcyBpdCB0byBhIHJlbW90ZSBzZXJ2ZXIgdXNpbmcgaHR0cC9odHRwcyBvciBmdHAgcHJvdG9jb2xzXG4gKiBpZiBgcmVtb3RlUGF0aGAgaXMgc2V0XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGxvY2FsRmlsZSAtIFRoZSBwYXRoIHRvIGFuIGV4aXN0aW5nIGxvY2FsIGZpbGVcbiAqIEBwYXJhbSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzIGZpbGUgc2hvdWxkIGJlIHVwbG9hZGVkXG4gKiBAcGFyYW0gez9VcGxvYWRPcHRpb25zfSB1cGxvYWRPcHRpb25zIC0gU2V0IG9mIHVwbG9hZCBvcHRpb25zXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBFaXRoZXIgYW4gZW1wdHkgc3RyaW5nIGlmIHRoZSB1cGxvYWQgd2FzIHN1Y2Nlc3NmdWwgb3JcbiAqIGJhc2U2NC1lbmNvZGVkIGZpbGUgcmVwcmVzZW50YXRpb24gaWYgYHJlbW90ZVBhdGhgIGlzIGZhbHN5XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGVuY29kZUJhc2U2NE9yVXBsb2FkIChsb2NhbEZpbGUsIHJlbW90ZVBhdGggPSBudWxsLCB1cGxvYWRPcHRpb25zID0ge30pIHtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMobG9jYWxGaWxlKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgZmlsZSBhdCAnJHtsb2NhbEZpbGV9JyBkb2VzIG5vdCBleGlzdCBvciBpcyBub3QgYWNjZXNzaWJsZWApO1xuICB9XG5cbiAgY29uc3Qge3NpemV9ID0gYXdhaXQgZnMuc3RhdChsb2NhbEZpbGUpO1xuICBsb2cuZGVidWcoYFRoZSBzaXplIG9mIHRoZSBmaWxlIGlzICR7dXRpbC50b1JlYWRhYmxlU2l6ZVN0cmluZyhzaXplKX1gKTtcbiAgaWYgKF8uaXNFbXB0eShyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IG1heE1lbW9yeUxpbWl0ID0gdjguZ2V0SGVhcFN0YXRpc3RpY3MoKS50b3RhbF9hdmFpbGFibGVfc2l6ZSAvIDI7XG4gICAgaWYgKHNpemUgPj0gbWF4TWVtb3J5TGltaXQpIHtcbiAgICAgIGxvZy5pbmZvKGBUaGUgZmlsZSBtaWdodCBiZSB0b28gbGFyZ2UgdG8gZml0IGludG8gdGhlIHByb2Nlc3MgbWVtb3J5IGAgK1xuICAgICAgICBgKCR7dXRpbC50b1JlYWRhYmxlU2l6ZVN0cmluZyhzaXplKX0gPj0gJHt1dGlsLnRvUmVhZGFibGVTaXplU3RyaW5nKG1heE1lbW9yeUxpbWl0KX0pLiBgICtcbiAgICAgICAgYFByb3ZpZGUgYSBsaW5rIHRvIGEgcmVtb3RlIHdyaXRhYmxlIGxvY2F0aW9uIGZvciB2aWRlbyB1cGxvYWQgYCArXG4gICAgICAgIGAoaHR0cChzKSBhbmQgZnRwIHByb3RvY29scyBhcmUgc3VwcG9ydGVkKSBpZiB5b3UgZXhwZXJpZW5jZSBPdXQgT2YgTWVtb3J5IGVycm9yc2ApO1xuICAgIH1cbiAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUobG9jYWxGaWxlKTtcbiAgICByZXR1cm4gY29udGVudC50b1N0cmluZygnYmFzZTY0Jyk7XG4gIH1cblxuICBjb25zdCByZW1vdGVVcmwgPSB1cmwucGFyc2UocmVtb3RlUGF0aCk7XG4gIGxldCBvcHRpb25zID0ge307XG4gIGNvbnN0IHt1c2VyLCBwYXNzLCBtZXRob2R9ID0gdXBsb2FkT3B0aW9ucztcbiAgaWYgKHJlbW90ZVVybC5wcm90b2NvbC5zdGFydHNXaXRoKCdodHRwJykpIHtcbiAgICBvcHRpb25zID0ge1xuICAgICAgdXJsOiByZW1vdGVVcmwuaHJlZixcbiAgICAgIG1ldGhvZDogbWV0aG9kIHx8ICdQVVQnLFxuICAgICAgbXVsdGlwYXJ0OiBbeyBib2R5OiBfZnMuY3JlYXRlUmVhZFN0cmVhbShsb2NhbEZpbGUpIH1dLFxuICAgIH07XG4gICAgaWYgKHVzZXIgJiYgcGFzcykge1xuICAgICAgb3B0aW9ucy5hdXRoID0ge3VzZXIsIHBhc3N9O1xuICAgIH1cbiAgfSBlbHNlIGlmIChyZW1vdGVVcmwucHJvdG9jb2wgPT09ICdmdHA6Jykge1xuICAgIG9wdGlvbnMgPSB7XG4gICAgICBob3N0OiByZW1vdGVVcmwuaG9zdG5hbWUsXG4gICAgICBwb3J0OiByZW1vdGVVcmwucG9ydCB8fCAyMSxcbiAgICB9O1xuICAgIGlmICh1c2VyICYmIHBhc3MpIHtcbiAgICAgIG9wdGlvbnMudXNlciA9IHVzZXI7XG4gICAgICBvcHRpb25zLnBhc3MgPSBwYXNzO1xuICAgIH1cbiAgfVxuICBhd2FpdCBuZXQudXBsb2FkRmlsZShsb2NhbEZpbGUsIHJlbW90ZVBhdGgsIG9wdGlvbnMpO1xuICByZXR1cm4gJyc7XG59XG5cbi8qKlxuICogU3RvcHMgYW5kIHJlbW92ZXMgYWxsIHdlYiBzb2NrZXQgaGFuZGxlcnMgdGhhdCBhcmUgbGlzdGVuaW5nXG4gKiBpbiBzY29wZSBvZiB0aGUgY3VycmVjdCBzZXNzaW9uLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBzZXJ2ZXIgLSBUaGUgaW5zdGFuY2Ugb2YgTm9kZUpzIEhUVFAgc2VydmVyLFxuICogd2hpY2ggaG9zdHMgQXBwaXVtXG4gKiBAcGFyYW0ge3N0cmluZ30gc2Vzc2lvbklkIC0gVGhlIGlkIG9mIHRoZSBjdXJyZW50IHNlc3Npb25cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcmVtb3ZlQWxsU2Vzc2lvbldlYlNvY2tldEhhbmRsZXJzIChzZXJ2ZXIsIHNlc3Npb25JZCkge1xuICBpZiAoIXNlcnZlciB8fCAhXy5pc0Z1bmN0aW9uKHNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycykpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBhY3RpdmVIYW5kbGVycyA9IGF3YWl0IHNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyhzZXNzaW9uSWQpO1xuICBmb3IgKGNvbnN0IHBhdGhuYW1lIG9mIF8ua2V5cyhhY3RpdmVIYW5kbGVycykpIHtcbiAgICBhd2FpdCBzZXJ2ZXIucmVtb3ZlV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSk7XG4gIH1cbn1cblxuLyoqXG4gKiBWZXJpZnkgd2hldGhlciB0aGUgZ2l2ZW4gYXBwbGljYXRpb24gaXMgY29tcGF0aWJsZSB0byB0aGVcbiAqIHBsYXRmb3JtIHdoZXJlIGl0IGlzIGdvaW5nIHRvIGJlIGluc3RhbGxlZCBhbmQgdGVzdGVkLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHAgLSBUaGUgYWN0dWFsIHBhdGggdG8gdGhlIGFwcGxpY2F0aW9uIGJ1bmRsZVxuICogQHBhcmFtIHtib29sZWFufSBpc1NpbXVsYXRvciAtIFNob3VsZCBiZSBzZXQgdG8gYHRydWVgIGlmIHRoZSB0ZXN0IHdpbGwgYmUgZXhlY3V0ZWQgb24gU2ltdWxhdG9yXG4gKiBAcmV0dXJucyB7P2Jvb2xlYW59IFRoZSBmdW5jdGlvbiByZXR1cm5zIGBudWxsYCBpZiB0aGUgYXBwbGljYXRpb24gZG9lcyBub3QgZXhpc3Qgb3IgdGhlcmUgaXMgbm9cbiAqIGBDRkJ1bmRsZVN1cHBvcnRlZFBsYXRmb3Jtc2Aga2V5IGluIGl0cyBJbmZvLnBsaXN0IG1hbmlmZXN0LlxuICogYHRydWVgIGlzIHJldHVybmVkIGlmIHRoZSBidW5kbGUgYXJjaGl0ZWN0dXJlIG1hdGNoZXMgdGhlIGRldmljZSBhcmNoaXRlY3R1cmUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgYnVuZGxlIGFyY2hpdGVjdHVyZSBkb2VzIG5vdCBtYXRjaCB0aGUgZGV2aWNlIGFyY2hpdGVjdHVyZS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gdmVyaWZ5QXBwbGljYXRpb25QbGF0Zm9ybSAoYXBwLCBpc1NpbXVsYXRvcikge1xuICBsb2cuZGVidWcoJ1ZlcmlmeWluZyBhcHBsaWNhdGlvbiBwbGF0Zm9ybScpO1xuXG4gIGNvbnN0IGluZm9QbGlzdCA9IHBhdGgucmVzb2x2ZShhcHAsICdJbmZvLnBsaXN0Jyk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGluZm9QbGlzdCkpIHtcbiAgICBsb2cuZGVidWcoYCcke2luZm9QbGlzdH0nIGRvZXMgbm90IGV4aXN0YCk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCB7Q0ZCdW5kbGVTdXBwb3J0ZWRQbGF0Zm9ybXN9ID0gYXdhaXQgcGxpc3QucGFyc2VQbGlzdEZpbGUoaW5mb1BsaXN0KTtcbiAgbG9nLmRlYnVnKGBDRkJ1bmRsZVN1cHBvcnRlZFBsYXRmb3JtczogJHtKU09OLnN0cmluZ2lmeShDRkJ1bmRsZVN1cHBvcnRlZFBsYXRmb3Jtcyl9YCk7XG4gIGlmICghXy5pc0FycmF5KENGQnVuZGxlU3VwcG9ydGVkUGxhdGZvcm1zKSkge1xuICAgIGxvZy5kZWJ1ZyhgQ0ZCdW5kbGVTdXBwb3J0ZWRQbGF0Zm9ybXMga2V5IGRvZXMgbm90IGV4aXN0IGluICcke2luZm9QbGlzdH0nYCk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCBpc0FwcFN1cHBvcnRlZCA9IChpc1NpbXVsYXRvciAmJiBDRkJ1bmRsZVN1cHBvcnRlZFBsYXRmb3Jtcy5pbmNsdWRlcygnaVBob25lU2ltdWxhdG9yJykpXG4gICAgfHwgKCFpc1NpbXVsYXRvciAmJiBDRkJ1bmRsZVN1cHBvcnRlZFBsYXRmb3Jtcy5pbmNsdWRlcygnaVBob25lT1MnKSk7XG4gIGlmIChpc0FwcFN1cHBvcnRlZCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihgJHtpc1NpbXVsYXRvciA/ICdTaW11bGF0b3InIDogJ1JlYWwgZGV2aWNlJ30gYXJjaGl0ZWN0dXJlIGlzIHVuc3VwcG9ydGVkIGJ5IHRoZSAnJHthcHB9JyBhcHBsaWNhdGlvbi4gYCArXG4gICAgICAgICAgICAgICAgICBgTWFrZSBzdXJlIHRoZSBjb3JyZWN0IGRlcGxveW1lbnQgdGFyZ2V0IGhhcyBiZWVuIHNlbGVjdGVkIGZvciBpdHMgY29tcGlsYXRpb24gaW4gWGNvZGUuYCk7XG59XG5cbi8qKlxuICogUmV0dXJuIHRydWUgaWYgdGhlIHBsYXRmb3JtTmFtZSBpcyB0dk9TXG4gKiBAcGFyYW0ge3N0cmluZ30gcGxhdGZvcm1OYW1lIFRoZSBuYW1lIG9mIHRoZSBwbGF0b3JtXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJuIHRydWUgaWYgdGhlIHBsYXRmb3JtTmFtZSBpcyB0dk9TXG4gKi9cbmZ1bmN0aW9uIGlzVHZPUyAocGxhdGZvcm1OYW1lKSB7XG4gIHJldHVybiBfLnRvTG93ZXIocGxhdGZvcm1OYW1lKSA9PT0gXy50b0xvd2VyKFBMQVRGT1JNX05BTUVfVFZPUyk7XG59XG5cbi8qKlxuICogUmV0dXJucyB0cnVlIGlmIHRoZSB1cmxTdHJpbmcgaXMgbG9jYWxob3N0XG4gKiBAcGFyYW0gez9zdHJpbmd9IHVybFN0cmluZ1xuICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybiB0cnVlIGlmIHRoZSB1cmxTdHJpbmcgaXMgbG9jYWxob3N0XG4gKi9cbmZ1bmN0aW9uIGlzTG9jYWxIb3N0ICh1cmxTdHJpbmcpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7aG9zdG5hbWV9ID0gdXJsLnBhcnNlKHVybFN0cmluZyk7XG4gICAgcmV0dXJuIFsnbG9jYWxob3N0JywgJzEyNy4wLjAuMScsICc6OjEnLCAnOjpmZmZmOjEyNy4wLjAuMSddLmluY2x1ZGVzKGhvc3RuYW1lKTtcbiAgfSBjYXRjaCAoaWduKSB7XG4gICAgbG9nLndhcm4oYCcke3VybFN0cmluZ30nIGNhbm5vdCBiZSBwYXJzZWQgYXMgYSB2YWxpZCBVUkxgKTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbi8qKlxuICogTm9ybWFsaXplcyBwbGF0Zm9ybVZlcnNpb24gdG8gYSB2YWxpZCBpT1MgdmVyc2lvbiBzdHJpbmdcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gb3JpZ2luYWxWZXJzaW9uIC0gTG9vc2UgdmVyc2lvbiBudW1iZXIsIHRoYXQgY2FuIGJlIHBhcnNlZCBieSBzZW12ZXJcbiAqIEByZXR1cm4ge3N0cmluZ30gaU9TIHZlcnNpb24gbnVtYmVyIGluIDxtYWpvcj4uPG1pbm9yPiBmb3JtYXRcbiAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgdmVyc2lvbiBudW1iZXIgY2Fubm90IGJlIHBhcnNlZFxuICovXG5mdW5jdGlvbiBub3JtYWxpemVQbGF0Zm9ybVZlcnNpb24gKG9yaWdpbmFsVmVyc2lvbikge1xuICBjb25zdCBub3JtYWxpemVkVmVyc2lvbiA9IHV0aWwuY29lcmNlVmVyc2lvbihvcmlnaW5hbFZlcnNpb24sIGZhbHNlKTtcbiAgaWYgKCFub3JtYWxpemVkVmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHBsYXRmb3JtIHZlcnNpb24gJyR7b3JpZ2luYWxWZXJzaW9ufScgc2hvdWxkIGJlIGEgdmFsaWQgdmVyc2lvbiBudW1iZXJgKTtcbiAgfVxuICBjb25zdCB7bWFqb3IsIG1pbm9yfSA9IG5ldyBzZW12ZXIuU2VtVmVyKG5vcm1hbGl6ZWRWZXJzaW9uKTtcbiAgcmV0dXJuIGAke21ham9yfS4ke21pbm9yfWA7XG59XG5cbmV4cG9ydCB7IGRldGVjdFVkaWQsIGdldEFuZENoZWNrWGNvZGVWZXJzaW9uLCBnZXRBbmRDaGVja0lvc1Nka1ZlcnNpb24sXG4gIGNoZWNrQXBwUHJlc2VudCwgZ2V0RHJpdmVySW5mbyxcbiAgY2xlYXJTeXN0ZW1GaWxlcywgdHJhbnNsYXRlRGV2aWNlTmFtZSwgbm9ybWFsaXplQ29tbWFuZFRpbWVvdXRzLFxuICBERUZBVUxUX1RJTUVPVVRfS0VZLCByZXNldFhDVGVzdFByb2Nlc3NlcywgZ2V0UElEc1VzaW5nUGF0dGVybixcbiAgbWFya1N5c3RlbUZpbGVzRm9yQ2xlYW51cCwgcHJpbnRVc2VyLCBwcmludExpYmltb2JpbGVkZXZpY2VJbmZvLFxuICBnZXRQSURzTGlzdGVuaW5nT25Qb3J0LCBlbmNvZGVCYXNlNjRPclVwbG9hZCwgcmVtb3ZlQWxsU2Vzc2lvbldlYlNvY2tldEhhbmRsZXJzLFxuICB2ZXJpZnlBcHBsaWNhdGlvblBsYXRmb3JtLCBpc1R2T1MsIGlzTG9jYWxIb3N0LCBub3JtYWxpemVQbGF0Zm9ybVZlcnNpb24gfTtcbiJdLCJmaWxlIjoibGliL3V0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
