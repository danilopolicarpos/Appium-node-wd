"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumIosDriver = require("appium-ios-driver");

var _iosCrashLog = require("../device-log/ios-crash-log");

var _iosLog = require("../device-log/ios-log");

var _logger = _interopRequireDefault(require("../logger"));

var _ws = _interopRequireDefault(require("ws"));

var _safariConsoleLog = _interopRequireDefault(require("../device-log/safari-console-log"));

var _safariNetworkLog = _interopRequireDefault(require("../device-log/safari-network-log"));

let extensions = {};

const WEBSOCKET_ENDPOINT = sessionId => `${_appiumBaseDriver.DEFAULT_WS_PATHNAME_PREFIX}/session/${sessionId}/appium/device/syslog`;

Object.assign(extensions, _appiumIosDriver.iosCommands.logging);
extensions.supportedLogTypes.safariConsole = {
  description: 'Safari Console Logs - data written to the JS console in Safari',
  getter: async self => await self.extractLogs('safariConsole', self.logs)
};
extensions.supportedLogTypes.safariNetwork = {
  description: 'Safari Network Logs - information about network operations undertaken by Safari',
  getter: async self => await self.extractLogs('safariNetwork', self.logs)
};

extensions.startLogCapture = async function startLogCapture() {
  this.logs = this.logs || {};

  if (!_lodash.default.isUndefined(this.logs.syslog) && this.logs.syslog.isCapturing) {
    _logger.default.warn('Trying to start iOS log capture but it has already started!');

    return true;
  }

  if (_lodash.default.isUndefined(this.logs.syslog)) {
    this.logs.crashlog = new _iosCrashLog.IOSCrashLog({
      sim: this.opts.device,
      udid: this.isRealDevice() ? this.opts.udid : undefined
    });
    this.logs.syslog = new _iosLog.IOSLog({
      sim: this.opts.device,
      udid: this.isRealDevice() ? this.opts.udid : undefined,
      showLogs: this.opts.showIOSLog,
      realDeviceLogger: this.opts.realDeviceLogger,
      xcodeVersion: this.xcodeVersion
    });
    this.logs.safariConsole = new _safariConsoleLog.default(!!this.opts.showSafariConsoleLog);
    this.logs.safariNetwork = new _safariNetworkLog.default(!!this.opts.showSafariNetworkLog);
  }

  try {
    await this.logs.syslog.startCapture();
  } catch (err) {
    _logger.default.warn(`Continuing without capturing device logs: ${err.message}`);

    return false;
  }

  await this.logs.crashlog.startCapture();
  await this.logs.safariConsole.startCapture();
  await this.logs.safariNetwork.startCapture();
  return true;
};

extensions.mobileStartLogsBroadcast = async function mobileStartLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (!_lodash.default.isEmpty((await this.server.getWebSocketHandlers(pathname)))) {
    _logger.default.debug(`The system logs broadcasting web socket server is already listening at ${pathname}`);

    return;
  }

  _logger.default.info(`Assigning system logs broadcasting web socket server to ${pathname}`);

  const wss = new _ws.default.Server({
    noServer: true
  });
  wss.on('connection', (ws, req) => {
    if (req) {
      const remoteIp = _lodash.default.isEmpty(req.headers['x-forwarded-for']) ? req.connection.remoteAddress : req.headers['x-forwarded-for'];

      _logger.default.debug(`Established a new system logs listener web socket connection from ${remoteIp}`);
    } else {
      _logger.default.debug('Established a new system logs listener web socket connection');
    }

    if (_lodash.default.isEmpty(this._syslogWebsocketListener)) {
      this._syslogWebsocketListener = logRecord => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(logRecord.message);
        }
      };
    }

    this.logs.syslog.on('output', this._syslogWebsocketListener);
    ws.on('close', (code, reason) => {
      if (!_lodash.default.isEmpty(this._syslogWebsocketListener)) {
        this.logs.syslog.removeListener('output', this._syslogWebsocketListener);
        this._syslogWebsocketListener = null;
      }

      let closeMsg = 'System logs listener web socket is closed.';

      if (!_lodash.default.isEmpty(code)) {
        closeMsg += ` Code: ${code}.`;
      }

      if (!_lodash.default.isEmpty(reason)) {
        closeMsg += ` Reason: ${reason}.`;
      }

      _logger.default.debug(closeMsg);
    });
  });
  await this.server.addWebSocketHandler(pathname, wss);
};

extensions.mobileStopLogsBroadcast = async function mobileStopLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (_lodash.default.isEmpty((await this.server.getWebSocketHandlers(pathname)))) {
    return;
  }

  _logger.default.debug('Stopping the system logs broadcasting web socket server');

  await this.server.removeWebSocketHandler(pathname);
};

var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sb2cuanMiXSwibmFtZXMiOlsiZXh0ZW5zaW9ucyIsIldFQlNPQ0tFVF9FTkRQT0lOVCIsInNlc3Npb25JZCIsIkRFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIiwiT2JqZWN0IiwiYXNzaWduIiwiaW9zQ29tbWFuZHMiLCJsb2dnaW5nIiwic3VwcG9ydGVkTG9nVHlwZXMiLCJzYWZhcmlDb25zb2xlIiwiZGVzY3JpcHRpb24iLCJnZXR0ZXIiLCJzZWxmIiwiZXh0cmFjdExvZ3MiLCJsb2dzIiwic2FmYXJpTmV0d29yayIsInN0YXJ0TG9nQ2FwdHVyZSIsIl8iLCJpc1VuZGVmaW5lZCIsInN5c2xvZyIsImlzQ2FwdHVyaW5nIiwibG9nIiwid2FybiIsImNyYXNobG9nIiwiSU9TQ3Jhc2hMb2ciLCJzaW0iLCJvcHRzIiwiZGV2aWNlIiwidWRpZCIsImlzUmVhbERldmljZSIsInVuZGVmaW5lZCIsIklPU0xvZyIsInNob3dMb2dzIiwic2hvd0lPU0xvZyIsInJlYWxEZXZpY2VMb2dnZXIiLCJ4Y29kZVZlcnNpb24iLCJTYWZhcmlDb25zb2xlTG9nIiwic2hvd1NhZmFyaUNvbnNvbGVMb2ciLCJTYWZhcmlOZXR3b3JrTG9nIiwic2hvd1NhZmFyaU5ldHdvcmtMb2ciLCJzdGFydENhcHR1cmUiLCJlcnIiLCJtZXNzYWdlIiwibW9iaWxlU3RhcnRMb2dzQnJvYWRjYXN0IiwicGF0aG5hbWUiLCJpc0VtcHR5Iiwic2VydmVyIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJkZWJ1ZyIsImluZm8iLCJ3c3MiLCJXZWJTb2NrZXQiLCJTZXJ2ZXIiLCJub1NlcnZlciIsIm9uIiwid3MiLCJyZXEiLCJyZW1vdGVJcCIsImhlYWRlcnMiLCJjb25uZWN0aW9uIiwicmVtb3RlQWRkcmVzcyIsIl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lciIsImxvZ1JlY29yZCIsInJlYWR5U3RhdGUiLCJPUEVOIiwic2VuZCIsImNvZGUiLCJyZWFzb24iLCJyZW1vdmVMaXN0ZW5lciIsImNsb3NlTXNnIiwiYWRkV2ViU29ja2V0SGFuZGxlciIsIm1vYmlsZVN0b3BMb2dzQnJvYWRjYXN0IiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxJQUFJQSxVQUFVLEdBQUcsRUFBakI7O0FBRUEsTUFBTUMsa0JBQWtCLEdBQUlDLFNBQUQsSUFBZ0IsR0FBRUMsNENBQTJCLFlBQVdELFNBQVUsdUJBQTdGOztBQUVBRSxNQUFNLENBQUNDLE1BQVAsQ0FBY0wsVUFBZCxFQUEwQk0sNkJBQVlDLE9BQXRDO0FBRUFQLFVBQVUsQ0FBQ1EsaUJBQVgsQ0FBNkJDLGFBQTdCLEdBQTZDO0FBQzNDQyxFQUFBQSxXQUFXLEVBQUUsZ0VBRDhCO0FBRTNDQyxFQUFBQSxNQUFNLEVBQUUsTUFBT0MsSUFBUCxJQUFnQixNQUFNQSxJQUFJLENBQUNDLFdBQUwsQ0FBaUIsZUFBakIsRUFBa0NELElBQUksQ0FBQ0UsSUFBdkM7QUFGYSxDQUE3QztBQUtBZCxVQUFVLENBQUNRLGlCQUFYLENBQTZCTyxhQUE3QixHQUE2QztBQUMzQ0wsRUFBQUEsV0FBVyxFQUFFLGlGQUQ4QjtBQUUzQ0MsRUFBQUEsTUFBTSxFQUFFLE1BQU9DLElBQVAsSUFBZ0IsTUFBTUEsSUFBSSxDQUFDQyxXQUFMLENBQWlCLGVBQWpCLEVBQWtDRCxJQUFJLENBQUNFLElBQXZDO0FBRmEsQ0FBN0M7O0FBS0FkLFVBQVUsQ0FBQ2dCLGVBQVgsR0FBNkIsZUFBZUEsZUFBZixHQUFrQztBQUM3RCxPQUFLRixJQUFMLEdBQVksS0FBS0EsSUFBTCxJQUFhLEVBQXpCOztBQUNBLE1BQUksQ0FBQ0csZ0JBQUVDLFdBQUYsQ0FBYyxLQUFLSixJQUFMLENBQVVLLE1BQXhCLENBQUQsSUFBb0MsS0FBS0wsSUFBTCxDQUFVSyxNQUFWLENBQWlCQyxXQUF6RCxFQUFzRTtBQUNwRUMsb0JBQUlDLElBQUos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bUJBQVosQ0FBZ0MxQixRQUFoQyxFQUEwQ00sR0FBMUMsQ0FBTjtBQUNELENBaEREOztBQXNEQWxELFVBQVUsQ0FBQ3VFLHVCQUFYLEdBQXFDLGVBQWVBLHVCQUFmLEdBQTBDO0FBQzdFLFFBQU0zQixRQUFRLEdBQUczQyxrQkFBa0IsQ0FBQyxLQUFLQyxTQUFOLENBQW5DOztBQUNBLE1BQUllLGdCQUFFNEIsT0FBRixFQUFVLE1BQU0sS0FBS0MsTUFBTCxDQUFZQyxvQkFBWixDQUFpQ0gsUUFBakMsQ0FBaEIsRUFBSixFQUFpRTtBQUMvRDtBQUNEOztBQUVEdkIsa0JBQUkyQixLQUFKLENBQVUseURBQVY7O0FBQ0EsUUFBTSxLQUFLRixNQUFMLENBQVkwQixzQkFBWixDQUFtQzVCLFFBQW5DLENBQU47QUFDRCxDQVJEOztlQVdlNUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBpb3NDb21tYW5kcyB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IElPU0NyYXNoTG9nIH0gZnJvbSAnLi4vZGV2aWNlLWxvZy9pb3MtY3Jhc2gtbG9nJztcbmltcG9ydCB7IElPU0xvZyB9IGZyb20gJy4uL2RldmljZS1sb2cvaW9zLWxvZyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCBTYWZhcmlDb25zb2xlTG9nIGZyb20gJy4uL2RldmljZS1sb2cvc2FmYXJpLWNvbnNvbGUtbG9nJztcbmltcG9ydCBTYWZhcmlOZXR3b3JrTG9nIGZyb20gJy4uL2RldmljZS1sb2cvc2FmYXJpLW5ldHdvcmstbG9nJztcblxuXG5sZXQgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBXRUJTT0NLRVRfRU5EUE9JTlQgPSAoc2Vzc2lvbklkKSA9PiBgJHtERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWH0vc2Vzc2lvbi8ke3Nlc3Npb25JZH0vYXBwaXVtL2RldmljZS9zeXNsb2dgO1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGlvc0NvbW1hbmRzLmxvZ2dpbmcpO1xuXG5leHRlbnNpb25zLnN1cHBvcnRlZExvZ1R5cGVzLnNhZmFyaUNvbnNvbGUgPSB7XG4gIGRlc2NyaXB0aW9uOiAnU2FmYXJpIENvbnNvbGUgTG9ncyAtIGRhdGEgd3JpdHRlbiB0byB0aGUgSlMgY29uc29sZSBpbiBTYWZhcmknLFxuICBnZXR0ZXI6IGFzeW5jIChzZWxmKSA9PiBhd2FpdCBzZWxmLmV4dHJhY3RMb2dzKCdzYWZhcmlDb25zb2xlJywgc2VsZi5sb2dzKSxcbn07XG5cbmV4dGVuc2lvbnMuc3VwcG9ydGVkTG9nVHlwZXMuc2FmYXJpTmV0d29yayA9IHtcbiAgZGVzY3JpcHRpb246ICdTYWZhcmkgTmV0d29yayBMb2dzIC0gaW5mb3JtYXRpb24gYWJvdXQgbmV0d29yayBvcGVyYXRpb25zIHVuZGVydGFrZW4gYnkgU2FmYXJpJyxcbiAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4gYXdhaXQgc2VsZi5leHRyYWN0TG9ncygnc2FmYXJpTmV0d29yaycsIHNlbGYubG9ncyksXG59O1xuXG5leHRlbnNpb25zLnN0YXJ0TG9nQ2FwdHVyZSA9IGFzeW5jIGZ1bmN0aW9uIHN0YXJ0TG9nQ2FwdHVyZSAoKSB7XG4gIHRoaXMubG9ncyA9IHRoaXMubG9ncyB8fCB7fTtcbiAgaWYgKCFfLmlzVW5kZWZpbmVkKHRoaXMubG9ncy5zeXNsb2cpICYmIHRoaXMubG9ncy5zeXNsb2cuaXNDYXB0dXJpbmcpIHtcbiAgICBsb2cud2FybignVHJ5aW5nIHRvIHN0YXJ0IGlPUyBsb2cgY2FwdHVyZSBidXQgaXQgaGFzIGFscmVhZHkgc3RhcnRlZCEnKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBpZiAoXy5pc1VuZGVmaW5lZCh0aGlzLmxvZ3Muc3lzbG9nKSkge1xuICAgIHRoaXMubG9ncy5jcmFzaGxvZyA9IG5ldyBJT1NDcmFzaExvZyh7XG4gICAgICBzaW06IHRoaXMub3B0cy5kZXZpY2UsXG4gICAgICB1ZGlkOiB0aGlzLmlzUmVhbERldmljZSgpID8gdGhpcy5vcHRzLnVkaWQgOiB1bmRlZmluZWQsXG4gICAgfSk7XG4gICAgdGhpcy5sb2dzLnN5c2xvZyA9IG5ldyBJT1NMb2coe1xuICAgICAgc2ltOiB0aGlzLm9wdHMuZGV2aWNlLFxuICAgICAgdWRpZDogdGhpcy5pc1JlYWxEZXZpY2UoKSA/IHRoaXMub3B0cy51ZGlkIDogdW5kZWZpbmVkLFxuICAgICAgc2hvd0xvZ3M6IHRoaXMub3B0cy5zaG93SU9TTG9nLFxuICAgICAgcmVhbERldmljZUxvZ2dlcjogdGhpcy5vcHRzLnJlYWxEZXZpY2VMb2dnZXIsXG4gICAgICB4Y29kZVZlcnNpb246IHRoaXMueGNvZGVWZXJzaW9uLFxuICAgIH0pO1xuICAgIHRoaXMubG9ncy5zYWZhcmlDb25zb2xlID0gbmV3IFNhZmFyaUNvbnNvbGVMb2coISF0aGlzLm9wdHMuc2hvd1NhZmFyaUNvbnNvbGVMb2cpO1xuICAgIHRoaXMubG9ncy5zYWZhcmlOZXR3b3JrID0gbmV3IFNhZmFyaU5ldHdvcmtMb2coISF0aGlzLm9wdHMuc2hvd1NhZmFyaU5ldHdvcmtMb2cpO1xuICB9XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5sb2dzLnN5c2xvZy5zdGFydENhcHR1cmUoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYENvbnRpbnVpbmcgd2l0aG91dCBjYXB0dXJpbmcgZGV2aWNlIGxvZ3M6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGF3YWl0IHRoaXMubG9ncy5jcmFzaGxvZy5zdGFydENhcHR1cmUoKTtcbiAgYXdhaXQgdGhpcy5sb2dzLnNhZmFyaUNvbnNvbGUuc3RhcnRDYXB0dXJlKCk7XG4gIGF3YWl0IHRoaXMubG9ncy5zYWZhcmlOZXR3b3JrLnN0YXJ0Q2FwdHVyZSgpO1xuXG4gIHJldHVybiB0cnVlO1xufTtcblxuLyoqXG4gKiBTdGFydHMgaU9TIHN5c3RlbSBsb2dzIGJyb2FkY2FzdCB3ZWJzb2NrZXQgb24gdGhlIHNhbWUgaG9zdCBhbmQgcG9ydFxuICogd2hlcmUgQXBwaXVtIHNlcnZlciBpcyBydW5uaW5nIGF0IGAvd3Mvc2Vzc2lvbi86c2Vzc2lvbklkOi9hcHBpdW0vc3lzbG9nYCBlbmRwb2ludC4gVGhlIG1ldGhvZFxuICogd2lsbCByZXR1cm4gaW1tZWRpYXRlbHkgaWYgdGhlIHdlYiBzb2NrZXQgaXMgYWxyZWFkeSBsaXN0ZW5pbmcuXG4gKlxuICogRWFjaCBjb25uZWN0ZWQgd2ViY29rZXQgbGlzdGVuZXIgd2lsbCByZWNlaXZlIHN5c2xvZyBsaW5lc1xuICogYXMgc29vbiBhcyB0aGV5IGFyZSB2aXNpYmxlIHRvIEFwcGl1bS5cbiAqL1xuZXh0ZW5zaW9ucy5tb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QgKCkge1xuICBjb25zdCBwYXRobmFtZSA9IFdFQlNPQ0tFVF9FTkRQT0lOVCh0aGlzLnNlc3Npb25JZCk7XG4gIGlmICghXy5pc0VtcHR5KGF3YWl0IHRoaXMuc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHBhdGhuYW1lKSkpIHtcbiAgICBsb2cuZGVidWcoYFRoZSBzeXN0ZW0gbG9ncyBicm9hZGNhc3Rpbmcgd2ViIHNvY2tldCBzZXJ2ZXIgaXMgYWxyZWFkeSBsaXN0ZW5pbmcgYXQgJHtwYXRobmFtZX1gKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuaW5mbyhgQXNzaWduaW5nIHN5c3RlbSBsb2dzIGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlciB0byAke3BhdGhuYW1lfWApO1xuICAvLyBodHRwczovL2dpdGh1Yi5jb20vd2Vic29ja2V0cy93cy9ibG9iL21hc3Rlci9kb2Mvd3MubWRcbiAgY29uc3Qgd3NzID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoe1xuICAgIG5vU2VydmVyOiB0cnVlLFxuICB9KTtcbiAgd3NzLm9uKCdjb25uZWN0aW9uJywgKHdzLCByZXEpID0+IHtcbiAgICBpZiAocmVxKSB7XG4gICAgICBjb25zdCByZW1vdGVJcCA9IF8uaXNFbXB0eShyZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtZm9yJ10pXG4gICAgICAgID8gcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzc1xuICAgICAgICA6IHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXTtcbiAgICAgIGxvZy5kZWJ1ZyhgRXN0YWJsaXNoZWQgYSBuZXcgc3lzdGVtIGxvZ3MgbGlzdGVuZXIgd2ViIHNvY2tldCBjb25uZWN0aW9uIGZyb20gJHtyZW1vdGVJcH1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKCdFc3RhYmxpc2hlZCBhIG5ldyBzeXN0ZW0gbG9ncyBsaXN0ZW5lciB3ZWIgc29ja2V0IGNvbm5lY3Rpb24nKTtcbiAgICB9XG5cbiAgICBpZiAoXy5pc0VtcHR5KHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyKSkge1xuICAgICAgdGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIgPSAobG9nUmVjb3JkKSA9PiB7XG4gICAgICAgIGlmICh3cyAmJiB3cy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikge1xuICAgICAgICAgIHdzLnNlbmQobG9nUmVjb3JkLm1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cbiAgICB0aGlzLmxvZ3Muc3lzbG9nLm9uKCdvdXRwdXQnLCB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lcik7XG5cbiAgICB3cy5vbignY2xvc2UnLCAoY29kZSwgcmVhc29uKSA9PiB7XG4gICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lcikpIHtcbiAgICAgICAgdGhpcy5sb2dzLnN5c2xvZy5yZW1vdmVMaXN0ZW5lcignb3V0cHV0JywgdGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIpO1xuICAgICAgICB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lciA9IG51bGw7XG4gICAgICB9XG5cbiAgICAgIGxldCBjbG9zZU1zZyA9ICdTeXN0ZW0gbG9ncyBsaXN0ZW5lciB3ZWIgc29ja2V0IGlzIGNsb3NlZC4nO1xuICAgICAgaWYgKCFfLmlzRW1wdHkoY29kZSkpIHtcbiAgICAgICAgY2xvc2VNc2cgKz0gYCBDb2RlOiAke2NvZGV9LmA7XG4gICAgICB9XG4gICAgICBpZiAoIV8uaXNFbXB0eShyZWFzb24pKSB7XG4gICAgICAgIGNsb3NlTXNnICs9IGAgUmVhc29uOiAke3JlYXNvbn0uYDtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhjbG9zZU1zZyk7XG4gICAgfSk7XG4gIH0pO1xuICBhd2FpdCB0aGlzLnNlcnZlci5hZGRXZWJTb2NrZXRIYW5kbGVyKHBhdGhuYW1lLCB3c3MpO1xufTtcblxuLyoqXG4gKiBTdG9wcyB0aGUgcHJldmlvdXNseSBzdGFydGVkIHN5c2xvZyBicm9hZGNhc3Rpbmcgd2Vzb2NrZXQgc2VydmVyLlxuICogVGhpcyBtZXRob2Qgd2lsbCByZXR1cm4gaW1tZWRpYXRlbHkgaWYgbm8gc2VydmVyIGlzIHJ1bm5pbmcuXG4gKi9cbmV4dGVuc2lvbnMubW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVTdG9wTG9nc0Jyb2FkY2FzdCAoKSB7XG4gIGNvbnN0IHBhdGhuYW1lID0gV0VCU09DS0VUX0VORFBPSU5UKHRoaXMuc2Vzc2lvbklkKTtcbiAgaWYgKF8uaXNFbXB0eShhd2FpdCB0aGlzLnNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyhwYXRobmFtZSkpKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdTdG9wcGluZyB0aGUgc3lzdGVtIGxvZ3MgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyJyk7XG4gIGF3YWl0IHRoaXMuc2VydmVyLnJlbW92ZVdlYlNvY2tldEhhbmRsZXIocGF0aG5hbWUpO1xufTtcblxuXG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvbG9nLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
