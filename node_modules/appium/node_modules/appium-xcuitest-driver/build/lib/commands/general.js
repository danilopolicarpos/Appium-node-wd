"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.extensions = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumIosDriver = require("appium-ios-driver");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

let commands = {},
    helpers = {},
    extensions = {};
exports.extensions = extensions;
exports.helpers = helpers;
exports.commands = commands;

commands.active = async function active() {
  if (this.isWebContext()) {
    return await this.executeAtom('active_element', []);
  }

  return await this.proxyCommand(`/element/active`, 'GET');
};

commands.background = async function background(duration) {
  const homescreenEndpoint = '/wda/homescreen';
  const deactivateAppEndpoint = '/wda/deactivateApp';
  let endpoint;
  let params;

  if (_lodash.default.isUndefined(duration)) {
    _logger.default.warn('commands.background: Application under test will never be restored in the future if no duration is provided. ' + 'See https://github.com/appium/appium/issues/7741');

    endpoint = deactivateAppEndpoint;
    params = {};
  } else if (_lodash.default.isNumber(duration)) {
    _logger.default.warn('commands.background: Passing numbers to \'duration\' argument is deprecated. ' + 'See https://github.com/appium/appium/issues/7741');

    if (duration >= 0) {
      params = {
        duration
      };
      endpoint = deactivateAppEndpoint;
    } else {
      endpoint = homescreenEndpoint;
    }
  } else if (_lodash.default.isPlainObject(duration)) {
    if (_lodash.default.has(duration, 'timeout')) {
      if (duration.timeout === null) {
        endpoint = homescreenEndpoint;
      } else if (_lodash.default.isNumber(duration.timeout)) {
        if (duration.timeout >= 0) {
          params = {
            duration: duration.timeout / 1000.0
          };
          endpoint = deactivateAppEndpoint;
        } else {
          endpoint = homescreenEndpoint;
        }
      }
    }
  }

  if (_lodash.default.isUndefined(endpoint)) {
    _logger.default.errorAndThrow(`commands.background: Argument value is expected to be an object or 'undefined'. ` + `'${duration}' value has been provided instead. ` + `The 'timeout' attribute can be 'null' or any negative number to put the app under test ` + 'into background and never come back or a positive number of milliseconds to wait until the app is restored.');
  }

  return await this.proxyCommand(endpoint, 'POST', params, endpoint !== homescreenEndpoint);
};

commands.touchId = async function touchId(match = true) {
  await this.mobileSendBiometricMatch({
    match
  });
};

commands.toggleEnrollTouchId = async function toggleEnrollTouchId(isEnabled = true) {
  await this.mobileEnrollBiometric({
    isEnabled
  });
};

helpers.getWindowSizeWeb = async function getWindowSizeWeb() {
  return await this.executeAtom('get_window_size', []);
};

helpers.getWindowSizeNative = async function getWindowSizeNative() {
  return await this.proxyCommand(`/window/size`, 'GET');
};

commands.getWindowSize = async function getWindowSize(windowHandle = 'current') {
  if (windowHandle !== 'current') {
    throw new _appiumBaseDriver.errors.NotYetImplementedError('Currently only getting current window size is supported.');
  }

  if (!this.isWebContext()) {
    return await this.getWindowSizeNative();
  } else {
    return await this.getWindowSizeWeb();
  }
};

commands.getWindowRect = async function getWindowRect() {
  const {
    width,
    height
  } = await this.getWindowSize();
  return {
    width,
    height,
    x: 0,
    y: 0
  };
};

commands.hideKeyboard = async function hideKeyboard(strategy, ...possibleKeys) {
  if (!(this.opts.deviceName || '').includes('iPhone')) {
    try {
      await this.proxyCommand('/wda/keyboard/dismiss', 'POST');
      return;
    } catch (err) {
      _logger.default.debug('Cannot dismiss the keyboard using the native call. Trying to apply a workaround...');
    }
  }

  let keyboard;

  try {
    keyboard = await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);
  } catch (err) {
    _logger.default.debug('No keyboard found. Unable to hide.');

    return;
  }

  possibleKeys.pop();
  possibleKeys = possibleKeys.filter(element => !!element);

  if (possibleKeys.length) {
    for (let key of possibleKeys) {
      let el = _lodash.default.last((await this.findNativeElementOrElements('accessibility id', key, true, keyboard)));

      if (el) {
        _logger.default.debug(`Attempting to hide keyboard by pressing '${key}' key.`);

        await this.nativeClick(el);
        return;
      }
    }
  } else {
    _logger.default.debug('Finding keyboard and clicking final button to close');

    if ((await this.getNativeAttribute('visible', keyboard)) === 'false') {
      _logger.default.debug('No visible keyboard found. Returning');

      return;
    }

    let buttons = await this.findNativeElementOrElements('class name', 'XCUIElementTypeButton', true, keyboard);
    await this.nativeClick(_lodash.default.last(buttons));
  }
};

commands.getDeviceTime = _appiumIosDriver.iosCommands.general.getDeviceTime;
commands.getStrings = _appiumIosDriver.iosCommands.general.getStrings;

commands.removeApp = async function removeApp(bundleId) {
  return await this.mobileRemoveApp({
    bundleId
  });
};

commands.launchApp = _appiumIosDriver.iosCommands.general.launchApp;
commands.closeApp = _appiumIosDriver.iosCommands.general.closeApp;

commands.keys = async function keys(keys) {
  if (!this.isWebContext()) {
    throw new _appiumBaseDriver.errors.UnknownError('Command should be proxied to WDA');
  }

  let el = await this.active();

  if (_lodash.default.isUndefined(el.ELEMENT)) {
    throw new _appiumBaseDriver.errors.NoSuchElementError();
  }

  await this.setValue(keys, el.ELEMENT);
};

commands.setUrl = async function setUrl(url) {
  if (!this.isWebContext() && this.isRealDevice()) {
    return await this.proxyCommand('/url', 'POST', {
      url
    });
  }

  return await _appiumIosDriver.iosCommands.general.setUrl.call(this, url);
};

commands.getViewportRect = _appiumIosDriver.iosCommands.device.getViewportRect;

commands.getScreenInfo = async function getScreenInfo() {
  return await this.proxyCommand('/wda/screen', 'GET');
};

commands.getStatusBarHeight = async function getStatusBarHeight() {
  const {
    statusBarSize
  } = await this.getScreenInfo();
  return statusBarSize.height;
};

commands.getDevicePixelRatio = async function getDevicePixelRatio() {
  const {
    scale
  } = await this.getScreenInfo();
  return scale;
};

commands.mobilePressButton = async function mobilePressButton(opts = {}) {
  const {
    name
  } = opts;

  if (!name) {
    _logger.default.errorAndThrow('Button name is mandatory');
  }

  return await this.proxyCommand('/wda/pressButton', 'POST', {
    name
  });
};

commands.mobileSiriCommand = async function mobileSiriCommand(opts = {}) {
  const {
    text
  } = opts;

  if (!_appiumSupport.util.hasValue(text)) {
    _logger.default.errorAndThrow('"text" argument is mandatory');
  }

  return await this.proxyCommand('/wda/siri/activate', 'POST', {
    text
  });
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJhY3RpdmUiLCJpc1dlYkNvbnRleHQiLCJleGVjdXRlQXRvbSIsInByb3h5Q29tbWFuZCIsImJhY2tncm91bmQiLCJkdXJhdGlvbiIsImhvbWVzY3JlZW5FbmRwb2ludCIsImRlYWN0aXZhdGVBcHBFbmRwb2ludCIsImVuZHBvaW50IiwicGFyYW1zIiwiXyIsImlzVW5kZWZpbmVkIiwibG9nIiwid2FybiIsImlzTnVtYmVyIiwiaXNQbGFpbk9iamVjdCIsImhhcyIsInRpbWVvdXQiLCJlcnJvckFuZFRocm93IiwidG91Y2hJZCIsIm1hdGNoIiwibW9iaWxlU2VuZEJpb21ldHJpY01hdGNoIiwidG9nZ2xlRW5yb2xsVG91Y2hJZCIsImlzRW5hYmxlZCIsIm1vYmlsZUVucm9sbEJpb21ldHJpYyIsImdldFdpbmRvd1NpemVXZWIiLCJnZXRXaW5kb3dTaXplTmF0aXZlIiwiZ2V0V2luZG93U2l6ZSIsIndpbmRvd0hhbmRsZSIsImVycm9ycyIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJnZXRXaW5kb3dSZWN0Iiwid2lkdGgiLCJoZWlnaHQiLCJ4IiwieSIsImhpZGVLZXlib2FyZCIsInN0cmF0ZWd5IiwicG9zc2libGVLZXlzIiwib3B0cyIsImRldmljZU5hbWUiLCJpbmNsdWRlcyIsImVyciIsImRlYnVnIiwia2V5Ym9hcmQiLCJmaW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMiLCJwb3AiLCJmaWx0ZXIiLCJlbGVtZW50IiwibGVuZ3RoIiwia2V5IiwiZWwiLCJsYXN0IiwibmF0aXZlQ2xpY2siLCJnZXROYXRpdmVBdHRyaWJ1dGUiLCJidXR0b25zIiwiZ2V0RGV2aWNlVGltZSIsImlvc0NvbW1hbmRzIiwiZ2VuZXJhbCIsImdldFN0cmluZ3MiLCJyZW1vdmVBcHAiLCJidW5kbGVJZCIsIm1vYmlsZVJlbW92ZUFwcCIsImxhdW5jaEFwcCIsImNsb3NlQXBwIiwia2V5cyIsIlVua25vd25FcnJvciIsIkVMRU1FTlQiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJzZXRWYWx1ZSIsInNldFVybCIsInVybCIsImlzUmVhbERldmljZSIsImNhbGwiLCJnZXRWaWV3cG9ydFJlY3QiLCJkZXZpY2UiLCJnZXRTY3JlZW5JbmZvIiwiZ2V0U3RhdHVzQmFySGVpZ2h0Iiwic3RhdHVzQmFyU2l6ZSIsImdldERldmljZVBpeGVsUmF0aW8iLCJzY2FsZSIsIm1vYmlsZVByZXNzQnV0dG9uIiwibmFtZSIsIm1vYmlsZVNpcmlDb21tYW5kIiwidGV4dCIsInV0aWwiLCJoYXNWYWx1ZSIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7OztBQUVBRixRQUFRLENBQUNHLE1BQVQsR0FBa0IsZUFBZUEsTUFBZixHQUF5QjtBQUN6QyxNQUFJLEtBQUtDLFlBQUwsRUFBSixFQUF5QjtBQUN2QixXQUFPLE1BQU0sS0FBS0MsV0FBTCxDQUFpQixnQkFBakIsRUFBbUMsRUFBbkMsQ0FBYjtBQUNEOztBQUNELFNBQU8sTUFBTSxLQUFLQyxZQUFMLENBQW1CLGlCQUFuQixFQUFxQyxLQUFyQyxDQUFiO0FBQ0QsQ0FMRDs7QUFrQkFOLFFBQVEsQ0FBQ08sVUFBVCxHQUFzQixlQUFlQSxVQUFmLENBQTJCQyxRQUEzQixFQUFxQztBQUN6RCxRQUFNQyxrQkFBa0IsR0FBRyxpQkFBM0I7QUFDQSxRQUFNQyxxQkFBcUIsR0FBRyxvQkFBOUI7QUFDQSxNQUFJQyxRQUFKO0FBQ0EsTUFBSUMsTUFBSjs7QUFDQSxNQUFJQyxnQkFBRUMsV0FBRixDQUFjTixRQUFkLENBQUosRUFBNkI7QUFHM0JPLG9CQUFJQyxJQUFKLENBQVMsa0hBQ0Esa0RBRFQ7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QUFQLENBQWN6RixVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFHZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgaW9zQ29tbWFuZHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbW1hbmRzLmFjdGl2ZSA9IGFzeW5jIGZ1bmN0aW9uIGFjdGl2ZSAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2FjdGl2ZV9lbGVtZW50JywgW10pO1xuICB9XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL2VsZW1lbnQvYWN0aXZlYCwgJ0dFVCcpO1xufTtcblxuLyoqXG4gKiBDbG9zZSBhcHAgKHNpbXVsYXRlIGRldmljZSBob21lIGJ1dHRvbikuIEl0IGlzIHBvc3NpYmxlIHRvIHJlc3RvcmVcbiAqIHRoZSBhcHAgYWZ0ZXIgdGhlIHRpbWVvdXQgb3Iga2VlcCBpdCBtaW5pbWl6ZWQgYmFzZWQgb24gdGhlIHBhcmFtZXRlciB2YWx1ZS5cbiAqXG4gKiBQb3NzaWJsZSB2YWx1ZXMgZm9yIGBkdXJhdGlvbmA6XG4gKiAtIGFueSBwb3NpdGl2ZSBudW1iZXIgb2Ygc2Vjb25kczogY29tZSBiYWNrIGFmdGVyIFggc2Vjb25kcywgc2hvdyBkZXByZWNhdGlvbiB3YXJuaW5nXG4gKiAtIGFueSBuZWdhdGl2ZSBudW1iZXIgb2Ygc2Vjb25kczogbmV2ZXIgY29tZSBiYWNrLCBzaG93IGRlcHJlY2F0aW9uIHdhcm5pbmdcbiAqIC0gdW5kZWZpbmVkOiBjb21lIGJhY2sgYWZ0ZXIgdGhlIGRlZmF1bHQgdGltZW91dCAoZGVmaW5lZCBieSBXREEpLCBzaG93IGRlcHJlY2F0aW9uIHdhcm5pbmcuIEFmdGVyIGRlcHJlY2F0aW9uOiBuZXZlciBjb21lIGJhY2tcbiAqIC0ge3RpbWVvdXQ6IDUwMDB9OiBjb21lIGJhY2sgYWZ0ZXIgNSBzZWNvbmRzXG4gKiAtIHt0aW1lb3V0OiBudWxsfSwge3RpbWVvdXQ6IC0yfTogbmV2ZXIgY29tZSBiYWNrXG4gKi9cbmNvbW1hbmRzLmJhY2tncm91bmQgPSBhc3luYyBmdW5jdGlvbiBiYWNrZ3JvdW5kIChkdXJhdGlvbikge1xuICBjb25zdCBob21lc2NyZWVuRW5kcG9pbnQgPSAnL3dkYS9ob21lc2NyZWVuJztcbiAgY29uc3QgZGVhY3RpdmF0ZUFwcEVuZHBvaW50ID0gJy93ZGEvZGVhY3RpdmF0ZUFwcCc7XG4gIGxldCBlbmRwb2ludDtcbiAgbGV0IHBhcmFtcztcbiAgaWYgKF8uaXNVbmRlZmluZWQoZHVyYXRpb24pKSB7XG4gICAgLy8gVE9ETzogUmVwbGFjZSB0aGUgYmxvY2sgYWZ0ZXIgZGVwcmVjYXRlZCBzdHVmZiBpcyByZW1vdmVkXG4gICAgLy8gZW5kcG9pbnQgPSBob21lc2NyZWVuRW5kcG9pbnQ7XG4gICAgbG9nLndhcm4oJ2NvbW1hbmRzLmJhY2tncm91bmQ6IEFwcGxpY2F0aW9uIHVuZGVyIHRlc3Qgd2lsbCBuZXZlciBiZSByZXN0b3JlZCBpbiB0aGUgZnV0dXJlIGlmIG5vIGR1cmF0aW9uIGlzIHByb3ZpZGVkLiAnICtcbiAgICAgICAgICAgICAnU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy83NzQxJyk7XG4gICAgZW5kcG9pbnQgPSBkZWFjdGl2YXRlQXBwRW5kcG9pbnQ7XG4gICAgcGFyYW1zID0ge307XG4gIH0gZWxzZSBpZiAoXy5pc051bWJlcihkdXJhdGlvbikpIHtcbiAgICAvLyBUT0RPOiBkZXByZWNhdGUgdGhpcyBjYXNlXG4gICAgbG9nLndhcm4oJ2NvbW1hbmRzLmJhY2tncm91bmQ6IFBhc3NpbmcgbnVtYmVycyB0byBcXCdkdXJhdGlvblxcJyBhcmd1bWVudCBpcyBkZXByZWNhdGVkLiAnICtcbiAgICAgICAgICAgICAnU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy83NzQxJyk7XG4gICAgaWYgKGR1cmF0aW9uID49IDApIHtcbiAgICAgIHBhcmFtcyA9IHtkdXJhdGlvbn07XG4gICAgICBlbmRwb2ludCA9IGRlYWN0aXZhdGVBcHBFbmRwb2ludDtcbiAgICB9IGVsc2Uge1xuICAgICAgZW5kcG9pbnQgPSBob21lc2NyZWVuRW5kcG9pbnQ7XG4gICAgfVxuICB9IGVsc2UgaWYgKF8uaXNQbGFpbk9iamVjdChkdXJhdGlvbikpIHtcbiAgICBpZiAoXy5oYXMoZHVyYXRpb24sICd0aW1lb3V0JykpIHtcbiAgICAgIGlmIChkdXJhdGlvbi50aW1lb3V0ID09PSBudWxsKSB7XG4gICAgICAgIGVuZHBvaW50ID0gaG9tZXNjcmVlbkVuZHBvaW50O1xuICAgICAgfSBlbHNlIGlmIChfLmlzTnVtYmVyKGR1cmF0aW9uLnRpbWVvdXQpKSB7XG4gICAgICAgIGlmIChkdXJhdGlvbi50aW1lb3V0ID49IDApIHtcbiAgICAgICAgICBwYXJhbXMgPSB7ZHVyYXRpb246IGR1cmF0aW9uLnRpbWVvdXQgLyAxMDAwLjB9O1xuICAgICAgICAgIGVuZHBvaW50ID0gZGVhY3RpdmF0ZUFwcEVuZHBvaW50O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGVuZHBvaW50ID0gaG9tZXNjcmVlbkVuZHBvaW50O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGlmIChfLmlzVW5kZWZpbmVkKGVuZHBvaW50KSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBjb21tYW5kcy5iYWNrZ3JvdW5kOiBBcmd1bWVudCB2YWx1ZSBpcyBleHBlY3RlZCB0byBiZSBhbiBvYmplY3Qgb3IgJ3VuZGVmaW5lZCcuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtkdXJhdGlvbn0nIHZhbHVlIGhhcyBiZWVuIHByb3ZpZGVkIGluc3RlYWQuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGBUaGUgJ3RpbWVvdXQnIGF0dHJpYnV0ZSBjYW4gYmUgJ251bGwnIG9yIGFueSBuZWdhdGl2ZSBudW1iZXIgdG8gcHV0IHRoZSBhcHAgdW5kZXIgdGVzdCBgICtcbiAgICAgICAgICAgICAgICAgICAgICAnaW50byBiYWNrZ3JvdW5kIGFuZCBuZXZlciBjb21lIGJhY2sgb3IgYSBwb3NpdGl2ZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgdGhlIGFwcCBpcyByZXN0b3JlZC4nKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoZW5kcG9pbnQsICdQT1NUJywgcGFyYW1zLCBlbmRwb2ludCAhPT0gaG9tZXNjcmVlbkVuZHBvaW50KTtcbn07XG5cbmNvbW1hbmRzLnRvdWNoSWQgPSBhc3luYyBmdW5jdGlvbiB0b3VjaElkIChtYXRjaCA9IHRydWUpIHtcbiAgYXdhaXQgdGhpcy5tb2JpbGVTZW5kQmlvbWV0cmljTWF0Y2goe21hdGNofSk7XG59O1xuXG5jb21tYW5kcy50b2dnbGVFbnJvbGxUb3VjaElkID0gYXN5bmMgZnVuY3Rpb24gdG9nZ2xlRW5yb2xsVG91Y2hJZCAoaXNFbmFibGVkID0gdHJ1ZSkge1xuICBhd2FpdCB0aGlzLm1vYmlsZUVucm9sbEJpb21ldHJpYyh7aXNFbmFibGVkfSk7XG59O1xuXG5oZWxwZXJzLmdldFdpbmRvd1NpemVXZWIgPSBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dTaXplV2ViICgpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF93aW5kb3dfc2l6ZScsIFtdKTtcbn07XG5cbmhlbHBlcnMuZ2V0V2luZG93U2l6ZU5hdGl2ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1NpemVOYXRpdmUgKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC93aW5kb3cvc2l6ZWAsICdHRVQnKTtcbn07XG5cbmNvbW1hbmRzLmdldFdpbmRvd1NpemUgPSBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dTaXplICh3aW5kb3dIYW5kbGUgPSAnY3VycmVudCcpIHtcbiAgaWYgKHdpbmRvd0hhbmRsZSAhPT0gJ2N1cnJlbnQnKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCdDdXJyZW50bHkgb25seSBnZXR0aW5nIGN1cnJlbnQgd2luZG93IHNpemUgaXMgc3VwcG9ydGVkLicpO1xuICB9XG5cbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZU5hdGl2ZSgpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemVXZWIoKTtcbiAgfVxufTtcblxuLy8gRm9yIFczQ1xuY29tbWFuZHMuZ2V0V2luZG93UmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1JlY3QgKCkge1xuICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcbiAgcmV0dXJuIHtcbiAgICB3aWR0aCxcbiAgICBoZWlnaHQsXG4gICAgeDogMCxcbiAgICB5OiAwXG4gIH07XG59O1xuXG5jb21tYW5kcy5oaWRlS2V5Ym9hcmQgPSBhc3luYyBmdW5jdGlvbiBoaWRlS2V5Ym9hcmQgKHN0cmF0ZWd5LCAuLi5wb3NzaWJsZUtleXMpIHtcbiAgaWYgKCEodGhpcy5vcHRzLmRldmljZU5hbWUgfHwgJycpLmluY2x1ZGVzKCdpUGhvbmUnKSkge1xuICAgIC8vIFRPRE86IG9uY2UgV0RBIGNhbiBoYW5kbGUgZGlzbWlzc2luZyBrZXlib2FyZCBmb3IgaXBob25lLCB0YWtlIGF3YXkgY29uZGl0aW9uYWxcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEva2V5Ym9hcmQvZGlzbWlzcycsICdQT1NUJyk7XG4gICAgICByZXR1cm47XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZGVidWcoJ0Nhbm5vdCBkaXNtaXNzIHRoZSBrZXlib2FyZCB1c2luZyB0aGUgbmF0aXZlIGNhbGwuIFRyeWluZyB0byBhcHBseSBhIHdvcmthcm91bmQuLi4nKTtcbiAgICB9XG4gIH1cblxuICBsZXQga2V5Ym9hcmQ7XG4gIHRyeSB7XG4gICAga2V5Ym9hcmQgPSBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVLZXlib2FyZCcsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gbm8ga2V5Ym9hcmQgZm91bmRcbiAgICBsb2cuZGVidWcoJ05vIGtleWJvYXJkIGZvdW5kLiBVbmFibGUgdG8gaGlkZS4nKTtcbiAgICByZXR1cm47XG4gIH1cbiAgcG9zc2libGVLZXlzLnBvcCgpOyAvLyBsYXN0IHBhcmFtZXRlciBpcyB0aGUgc2Vzc2lvbiBpZFxuICBwb3NzaWJsZUtleXMgPSBwb3NzaWJsZUtleXMuZmlsdGVyKChlbGVtZW50KSA9PiAhIWVsZW1lbnQpOyAvLyBnZXQgcmlkIG9mIHVuZGVmaW5lZCBlbGVtZW50c1xuICBpZiAocG9zc2libGVLZXlzLmxlbmd0aCkge1xuICAgIGZvciAobGV0IGtleSBvZiBwb3NzaWJsZUtleXMpIHtcbiAgICAgIGxldCBlbCA9IF8ubGFzdChhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnYWNjZXNzaWJpbGl0eSBpZCcsIGtleSwgdHJ1ZSwga2V5Ym9hcmQpKTtcbiAgICAgIGlmIChlbCkge1xuICAgICAgICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gaGlkZSBrZXlib2FyZCBieSBwcmVzc2luZyAnJHtrZXl9JyBrZXkuYCk7XG4gICAgICAgIGF3YWl0IHRoaXMubmF0aXZlQ2xpY2soZWwpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIC8vIGZpbmQgdGhlIGtleWJvYXJkLCBhbmQgaGl0IHRoZSBsYXN0IEJ1dHRvblxuICAgIGxvZy5kZWJ1ZygnRmluZGluZyBrZXlib2FyZCBhbmQgY2xpY2tpbmcgZmluYWwgYnV0dG9uIHRvIGNsb3NlJyk7XG4gICAgaWYgKGF3YWl0IHRoaXMuZ2V0TmF0aXZlQXR0cmlidXRlKCd2aXNpYmxlJywga2V5Ym9hcmQpID09PSAnZmFsc2UnKSB7XG4gICAgICBsb2cuZGVidWcoJ05vIHZpc2libGUga2V5Ym9hcmQgZm91bmQuIFJldHVybmluZycpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgYnV0dG9ucyA9IGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZUJ1dHRvbicsIHRydWUsIGtleWJvYXJkKTtcbiAgICBhd2FpdCB0aGlzLm5hdGl2ZUNsaWNrKF8ubGFzdChidXR0b25zKSk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldERldmljZVRpbWUgPSBpb3NDb21tYW5kcy5nZW5lcmFsLmdldERldmljZVRpbWU7XG5cbmNvbW1hbmRzLmdldFN0cmluZ3MgPSBpb3NDb21tYW5kcy5nZW5lcmFsLmdldFN0cmluZ3M7XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIHJlbW92ZUFwcCAoYnVuZGxlSWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMubW9iaWxlUmVtb3ZlQXBwKHtidW5kbGVJZH0pO1xufTtcblxuY29tbWFuZHMubGF1bmNoQXBwID0gaW9zQ29tbWFuZHMuZ2VuZXJhbC5sYXVuY2hBcHA7XG5cbmNvbW1hbmRzLmNsb3NlQXBwID0gaW9zQ29tbWFuZHMuZ2VuZXJhbC5jbG9zZUFwcDtcblxuY29tbWFuZHMua2V5cyA9IGFzeW5jIGZ1bmN0aW9uIGtleXMgKGtleXMpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoJ0NvbW1hbmQgc2hvdWxkIGJlIHByb3hpZWQgdG8gV0RBJyk7XG4gIH1cbiAgbGV0IGVsID0gYXdhaXQgdGhpcy5hY3RpdmUoKTtcbiAgaWYgKF8uaXNVbmRlZmluZWQoZWwuRUxFTUVOVCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICB9XG4gIGF3YWl0IHRoaXMuc2V0VmFsdWUoa2V5cywgZWwuRUxFTUVOVCk7XG59O1xuXG5jb21tYW5kcy5zZXRVcmwgPSBhc3luYyBmdW5jdGlvbiBzZXRVcmwgKHVybCkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkgJiYgdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3VybCcsICdQT1NUJywge3VybH0pO1xuICB9XG4gIHJldHVybiBhd2FpdCBpb3NDb21tYW5kcy5nZW5lcmFsLnNldFVybC5jYWxsKHRoaXMsIHVybCk7XG59O1xuXG5jb21tYW5kcy5nZXRWaWV3cG9ydFJlY3QgPSBpb3NDb21tYW5kcy5kZXZpY2UuZ2V0Vmlld3BvcnRSZWN0O1xuXG4vLyBtZW1vaXplZCBpbiBjb25zdHJ1Y3RvclxuY29tbWFuZHMuZ2V0U2NyZWVuSW5mbyA9IGFzeW5jIGZ1bmN0aW9uIGdldFNjcmVlbkluZm8gKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvc2NyZWVuJywgJ0dFVCcpO1xufTtcblxuY29tbWFuZHMuZ2V0U3RhdHVzQmFySGVpZ2h0ID0gYXN5bmMgZnVuY3Rpb24gZ2V0U3RhdHVzQmFySGVpZ2h0ICgpIHtcbiAgY29uc3Qge3N0YXR1c0JhclNpemV9ID0gYXdhaXQgdGhpcy5nZXRTY3JlZW5JbmZvKCk7XG4gIHJldHVybiBzdGF0dXNCYXJTaXplLmhlaWdodDtcbn07XG5cbi8vIG1lbW9pemVkIGluIGNvbnN0cnVjdG9yXG5jb21tYW5kcy5nZXREZXZpY2VQaXhlbFJhdGlvID0gYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlUGl4ZWxSYXRpbyAoKSB7XG4gIGNvbnN0IHtzY2FsZX0gPSBhd2FpdCB0aGlzLmdldFNjcmVlbkluZm8oKTtcbiAgcmV0dXJuIHNjYWxlO1xufTtcblxuY29tbWFuZHMubW9iaWxlUHJlc3NCdXR0b24gPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVQcmVzc0J1dHRvbiAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtuYW1lfSA9IG9wdHM7XG4gIGlmICghbmFtZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdCdXR0b24gbmFtZSBpcyBtYW5kYXRvcnknKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvcHJlc3NCdXR0b24nLCAnUE9TVCcsIHtuYW1lfSk7XG59O1xuXG5jb21tYW5kcy5tb2JpbGVTaXJpQ29tbWFuZCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVNpcmlDb21tYW5kIChvcHRzID0ge30pIHtcbiAgY29uc3Qge3RleHR9ID0gb3B0cztcbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKHRleHQpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ1widGV4dFwiIGFyZ3VtZW50IGlzIG1hbmRhdG9yeScpO1xuICB9XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9zaXJpL2FjdGl2YXRlJywgJ1BPU1QnLCB7dGV4dH0pO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5cbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzLCBleHRlbnNpb25zIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZ2VuZXJhbC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
