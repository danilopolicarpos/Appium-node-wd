"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _iproxy = _interopRequireDefault(require("../wda/iproxy"));

var _webdriveragent = require("../wda/webdriveragent");

var _asyncbox = require("asyncbox");

var _url = _interopRequireDefault(require("url"));

let commands = {};
exports.commands = commands;
const MAX_RECORDING_TIME_SEC = 60 * 30;
const DEFAULT_RECORDING_TIME_SEC = 60 * 3;
const DEFAULT_MJPEG_SERVER_PORT = 9100;
const DEFAULT_FPS = 10;
const DEFAULT_QUALITY = 'medium';
const DEFAULT_VCODEC = 'mjpeg';
const MP4_EXT = '.mp4';
const FFMPEG_BINARY = 'ffmpeg';

const ffmpegLogger = _appiumSupport.logger.getLogger(FFMPEG_BINARY);

const QUALITY_MAPPING = {
  low: 10,
  medium: 25,
  high: 75,
  photo: 100
};

class ScreenRecorder {
  constructor(udid, videoPath, opts = {}) {
    this.videoPath = videoPath;
    this.opts = opts;
    this.udid = udid;
    this.mainProcess = null;
    this.iproxy = null;
    this.timeoutHandler = null;
  }

  async start(timeoutMs) {
    try {
      await _appiumSupport.fs.which(FFMPEG_BINARY);
    } catch (err) {
      throw new Error(`'${FFMPEG_BINARY}' binary is not found in PATH. Install it using 'brew install ffmpeg'. ` + `Check https://www.ffmpeg.org/download.html for more details.`);
    }

    const localPort = this.opts.remotePort;

    const {
      protocol,
      hostname
    } = _url.default.parse(this.opts.remoteUrl);

    if (this.opts.usePortForwarding) {
      await this.startIproxy(localPort);
    }

    const args = ['-f', 'mjpeg'];

    if (this.opts.videoFps && this.opts.videoType === 'libx264') {
      args.push('-r', this.opts.videoFps);
    }

    args.push('-i', `${protocol}//${hostname}:${localPort}`);

    if (this.opts.videoScale) {
      args.push('-vf', `scale=${this.opts.videoScale}`);
    }

    if (this.opts.pixelFormat) {
      args.push('-pix_fmt', this.opts.pixelFormat);
    }

    args.push('-vcodec', this.opts.videoType, '-y', this.videoPath);
    this.mainProcess = new _teen_process.SubProcess(FFMPEG_BINARY, args);
    let isCaptureStarted = false;
    this.mainProcess.on('output', (stdout, stderr) => {
      if (stderr) {
        if (stderr.trim().startsWith('frame=')) {
          if (!isCaptureStarted) {
            isCaptureStarted = true;
          }
        } else {
          ffmpegLogger.info(`${stderr}`);
        }
      }
    });
    await this.mainProcess.start(0);
    const startupTimeout = 5000;

    try {
      await (0, _asyncbox.waitForCondition)(() => isCaptureStarted, {
        waitMs: startupTimeout,
        intervalMs: 300
      });
    } catch (e) {
      _logger.default.warn(`Screen capture process did not start within ${startupTimeout}ms. Continuing anyway`);
    }

    if (!this.mainProcess.isRunning) {
      throw new Error(`The screen capture process '${FFMPEG_BINARY}' died unexpectedly. ` + `Check server logs for more details`);
    }

    _logger.default.info(`Starting screen capture on the device '${this.udid}' with command: '${FFMPEG_BINARY} ${args.join(' ')}'. ` + `Will timeout in ${timeoutMs}ms`);

    this.timeoutHandler = setTimeout(async () => {
      if (!(await this.interrupt())) {
        _logger.default.warn(`Cannot finish the active screen recording on the device '${this.udid}' after ${timeoutMs}ms timeout`);
      }
    }, timeoutMs);
  }

  async startIproxy(localPort) {
    this.iproxy = new _iproxy.default(this.udid, localPort, this.opts.remotePort, false);

    try {
      await this.iproxy.start();
    } catch (err) {
      _logger.default.warn(`Cannot start iproxy. Assuming it is already forwarding the remote port ${this.opts.remotePort} to ${localPort} ` + `for the device ${this.udid}. Set the custom value to 'mjpegServerPort' capability if this is an undesired behavior. ` + `Original error: ${err.message}`);

      this.iproxy = null;
    }
  }

  async stopIproxy() {
    if (!this.iproxy) {
      return;
    }

    const quitPromise = this.iproxy.quit();
    this.iproxy = null;

    try {
      await quitPromise;
    } catch (err) {
      _logger.default.warn(`Cannot stop iproxy. Original error: ${err.message}`);
    }
  }

  async interrupt(force = false) {
    let result = true;

    if (this.timeoutHandler) {
      clearTimeout(this.timeoutHandler);
      this.timeoutHandler = null;
    }

    if (this.mainProcess && this.mainProcess.isRunning) {
      const interruptPromise = this.mainProcess.stop(force ? 'SIGTERM' : 'SIGINT');
      this.mainProcess = null;

      try {
        await interruptPromise;
      } catch (e) {
        _logger.default.warn(`Cannot ${force ? 'terminate' : 'interrupt'} ${FFMPEG_BINARY}. ` + `Original error: ${e.message}`);

        result = false;
      }
    }

    if (this.opts.usePortForwarding) {
      await this.stopIproxy();
    }

    return result;
  }

  async finish() {
    await this.interrupt();
    return this.videoPath;
  }

  async cleanup() {
    if (await _appiumSupport.fs.exists(this.videoPath)) {
      await _appiumSupport.fs.rimraf(this.videoPath);
    }
  }

}

commands.startRecordingScreen = async function startRecordingScreen(options = {}) {
  const {
    videoType = DEFAULT_VCODEC,
    timeLimit = DEFAULT_RECORDING_TIME_SEC,
    videoQuality = DEFAULT_QUALITY,
    videoFps = DEFAULT_FPS,
    videoScale,
    forceRestart
  } = options;
  let result = '';

  if (!forceRestart) {
    _logger.default.info(`Checking if there is/was a previous screen recording. ` + `Set 'forceRestart' option to 'true' if you'd like to skip this step.`);

    result = await this.stopRecordingScreen(options);
  }

  const videoPath = await _appiumSupport.tempDir.path({
    prefix: `appium_${Math.random().toString(16).substring(2, 8)}`,
    suffix: MP4_EXT
  });
  const wdaBaseUrl = this.opts.wdaBaseUrl || _webdriveragent.WDA_BASE_URL;
  const screenRecorder = new ScreenRecorder(this.opts.device.udid, videoPath, {
    remotePort: this.opts.mjpegServerPort || DEFAULT_MJPEG_SERVER_PORT,
    remoteUrl: wdaBaseUrl,
    usePortForwarding: this.isRealDevice() && (0, _utils.isLocalHost)(wdaBaseUrl),
    videoType,
    videoScale,
    videoFps
  });

  if (!(await screenRecorder.interrupt(true))) {
    _logger.default.errorAndThrow('Unable to stop screen recording process');
  }

  if (this._recentScreenRecorder) {
    await this._recentScreenRecorder.cleanup();
    this._recentScreenRecorder = null;
  }

  const timeoutSeconds = parseFloat(timeLimit);

  if (isNaN(timeoutSeconds) || timeoutSeconds > MAX_RECORDING_TIME_SEC || timeoutSeconds <= 0) {
    _logger.default.errorAndThrow(`The timeLimit value must be in range [1, ${MAX_RECORDING_TIME_SEC}] seconds. ` + `The value of '${timeLimit}' has been passed instead.`);
  }

  let {
    mjpegServerScreenshotQuality,
    mjpegServerFramerate
  } = await this.proxyCommand('/appium/settings', 'GET');

  if (videoQuality) {
    const quality = _lodash.default.isInteger(videoQuality) ? videoQuality : QUALITY_MAPPING[_lodash.default.toLower(videoQuality)];

    if (!quality) {
      throw new Error(`videoQuality value should be one of ${JSON.stringify(_lodash.default.keys(QUALITY_MAPPING))} or a number in range 1..100. ` + `'${videoQuality}' is given instead`);
    }

    mjpegServerScreenshotQuality = mjpegServerScreenshotQuality !== quality ? quality : undefined;
  } else {
    mjpegServerScreenshotQuality = undefined;
  }

  if (videoFps) {
    const fps = parseInt(videoFps, 10);

    if (isNaN(fps)) {
      throw new Error(`videoFps value should be a valid number in range 1..60. ` + `'${videoFps}' is given instead`);
    }

    mjpegServerFramerate = mjpegServerFramerate !== fps ? fps : undefined;
  } else {
    mjpegServerFramerate = undefined;
  }

  if (_appiumSupport.util.hasValue(mjpegServerScreenshotQuality) || _appiumSupport.util.hasValue(mjpegServerFramerate)) {
    await this.proxyCommand('/appium/settings', 'POST', {
      settings: {
        mjpegServerScreenshotQuality,
        mjpegServerFramerate
      }
    });
  }

  try {
    await screenRecorder.start(timeoutSeconds * 1000);
  } catch (e) {
    await screenRecorder.interrupt(true);
    await screenRecorder.cleanup();
    throw e;
  }

  this._recentScreenRecorder = screenRecorder;
  return result;
};

commands.stopRecordingScreen = async function stopRecordingScreen(options = {}) {
  const {
    remotePath,
    user,
    pass,
    method
  } = options;

  if (!this._recentScreenRecorder) {
    _logger.default.info('Screen recording is not running. There is nothing to stop.');

    return '';
  }

  try {
    const videoPath = await this._recentScreenRecorder.finish();

    if (!(await _appiumSupport.fs.exists(videoPath))) {
      _logger.default.errorAndThrow(`The screen recorder utility has failed ` + `to store the actual screen recording at '${videoPath}'`);
    }

    return await (0, _utils.encodeBase64OrUpload)(videoPath, remotePath, {
      user,
      pass,
      method
    });
  } finally {
    await this._recentScreenRecorder.interrupt(true);
    await this._recentScreenRecorder.cleanup();
    this._recentScreenRecorder = null;
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmRzY3JlZW4uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJNQVhfUkVDT1JESU5HX1RJTUVfU0VDIiwiREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMiLCJERUZBVUxUX01KUEVHX1NFUlZFUl9QT1JUIiwiREVGQVVMVF9GUFMiLCJERUZBVUxUX1FVQUxJVFkiLCJERUZBVUxUX1ZDT0RFQyIsIk1QNF9FWFQiLCJGRk1QRUdfQklOQVJZIiwiZmZtcGVnTG9nZ2VyIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiUVVBTElUWV9NQVBQSU5HIiwibG93IiwibWVkaXVtIiwiaGlnaCIsInBob3RvIiwiU2NyZWVuUmVjb3JkZXIiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJ2aWRlb1BhdGgiLCJvcHRzIiwibWFpblByb2Nlc3MiLCJpcHJveHkiLCJ0aW1lb3V0SGFuZGxlciIsInN0YXJ0IiwidGltZW91dE1zIiwiZnMiLCJ3aGljaCIsImVyciIsIkVycm9yIiwibG9jYWxQb3J0IiwicmVtb3RlUG9ydCIsInByb3RvY29sIiwiaG9zdG5hbWUiLCJ1cmwiLCJwYXJzZSIsInJlbW90ZVVybCIsInVzZVBvcnRGb3J3YXJkaW5nIiwic3RhcnRJcHJveHkiLCJhcmdzIiwidmlkZW9GcHMiLCJ2aWRlb1R5cGUiLCJwdXNoIiwidmlkZW9TY2FsZSIsInBpeGVsRm9ybWF0IiwiU3ViUHJvY2VzcyIsImlzQ2FwdHVyZVN0YXJ0ZWQiLCJvbiIsInN0ZG91dCIsInN0ZGVyciIsInRyaW0iLCJzdGFydHNXaXRoIiwiaW5mbyIsInN0YXJ0dXBUaW1lb3V0Iiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImUiLCJsb2ciLCJ3YXJuIiwiaXNSdW5uaW5nIiwiam9pbiIsInNldFRpbWVvdXQiLCJpbnRlcnJ1cHQiLCJpUHJveHkiLCJtZXNzYWdlIiwic3RvcElwcm94eSIsInF1aXRQcm9taXNlIiwicXVpdCIsImZvcmNlIiwicmVzdWx0IiwiY2xlYXJUaW1lb3V0IiwiaW50ZXJydXB0UHJvbWlzZSIsInN0b3AiLCJmaW5pc2giLCJjbGVhbnVwIiwiZXhpc3RzIiwicmltcmFmIiwic3RhcnRSZWNvcmRpbmdTY3JlZW4iLCJvcHRpb25zIiwidGltZUxpbWl0IiwidmlkZW9RdWFsaXR5IiwiZm9yY2VSZXN0YXJ0Iiwic3RvcFJlY29yZGluZ1NjcmVlbiIsInRlbXBEaXIiLCJwYXRoIiwicHJlZml4IiwiTWF0aCIsInJhbmRvbSIsInRvU3RyaW5nIiwic3Vic3RyaW5nIiwic3VmZml4Iiwid2RhQmFzZVVybCIsIldEQV9CQVNFX1VSTCIsInNjcmVlblJlY29yZGVyIiwiZGV2aWNlIiwibWpwZWdTZXJ2ZXJQb3J0IiwiaXNSZWFsRGV2aWNlIiwiZXJyb3JBbmRUaHJvdyIsIl9yZWNlbnRTY3JlZW5SZWNvcmRlciIsInRpbWVvdXRTZWNvbmRzIiwicGFyc2VGbG9hdCIsImlzTmFOIiwibWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSIsIm1qcGVnU2VydmVyRnJhbWVyYXRlIiwicHJveHlDb21tYW5kIiwicXVhbGl0eSIsIl8iLCJpc0ludGVnZXIiLCJ0b0xvd2VyIiwiSlNPTiIsInN0cmluZ2lmeSIsImtleXMiLCJ1bmRlZmluZWQiLCJmcHMiLCJwYXJzZUludCIsInV0aWwiLCJoYXNWYWx1ZSIsInNldHRpbmdzIiwicmVtb3RlUGF0aCIsInVzZXIiLCJwYXNzIiwibWV0aG9kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmOztBQUVBLE1BQU1DLHNCQUFzQixHQUFHLEtBQUssRUFBcEM7QUFDQSxNQUFNQywwQkFBMEIsR0FBRyxLQUFLLENBQXhDO0FBQ0EsTUFBTUMseUJBQXlCLEdBQUcsSUFBbEM7QUFDQSxNQUFNQyxXQUFXLEdBQUcsRUFBcEI7QUFDQSxNQUFNQyxlQUFlLEdBQUcsUUFBeEI7QUFDQSxNQUFNQyxjQUFjLEdBQUcs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QSxXQUFPLEVBQVA7QUFDRDs7QUFFRCxNQUFJO0FBQ0YsVUFBTWpDLFNBQVMsR0FBRyxNQUFNLEtBQUsrRSxxQkFBTCxDQUEyQnpCLE1BQTNCLEVBQXhCOztBQUNBLFFBQUksRUFBQyxNQUFNL0Msa0JBQUdpRCxNQUFILENBQVV4RCxTQUFWLENBQVAsQ0FBSixFQUFpQztBQUMvQnNDLHNCQUFJd0MsYUFBSixDQUFtQix5Q0FBRCxHQUNmLDRDQUEyQzlFLFNBQVUsR0FEeEQ7QUFFRDs7QUFDRCxXQUFPLE1BQU0saUNBQXFCQSxTQUFyQixFQUFnQ21HLFVBQWhDLEVBQTRDO0FBQ3ZEQyxNQUFBQSxJQUR1RDtBQUV2REMsTUFBQUEsSUFGdUQ7QUFHdkRDLE1BQUFBO0FBSHVELEtBQTVDLENBQWI7QUFLRCxHQVhELFNBV1U7QUFDUixVQUFNLEtBQUt2QixxQkFBTCxDQUEyQnBDLFNBQTNCLENBQXFDLElBQXJDLENBQU47QUFDQSxVQUFNLEtBQUtvQyxxQkFBTCxDQUEyQnhCLE9BQTNCLEVBQU47QUFDQSxTQUFLd0IscUJBQUwsR0FBNkIsSUFBN0I7QUFDRDtBQUNGLENBN0JEOztlQWlDZW5HLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMsIHRlbXBEaXIsIGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZW5jb2RlQmFzZTY0T3JVcGxvYWQsIGlzTG9jYWxIb3N0IH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IGlQcm94eSBmcm9tICcuLi93ZGEvaXByb3h5JztcbmltcG9ydCB7IFdEQV9CQVNFX1VSTCB9IGZyb20gJy4uL3dkYS93ZWJkcml2ZXJhZ2VudCc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgTUFYX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogMzA7XG5jb25zdCBERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogMztcbmNvbnN0IERFRkFVTFRfTUpQRUdfU0VSVkVSX1BPUlQgPSA5MTAwO1xuY29uc3QgREVGQVVMVF9GUFMgPSAxMDtcbmNvbnN0IERFRkFVTFRfUVVBTElUWSA9ICdtZWRpdW0nO1xuY29uc3QgREVGQVVMVF9WQ09ERUMgPSAnbWpwZWcnO1xuY29uc3QgTVA0X0VYVCA9ICcubXA0JztcbmNvbnN0IEZGTVBFR19CSU5BUlkgPSAnZmZtcGVnJztcbmNvbnN0IGZmbXBlZ0xvZ2dlciA9IGxvZ2dlci5nZXRMb2dnZXIoRkZNUEVHX0JJTkFSWSk7XG5jb25zdCBRVUFMSVRZX01BUFBJTkcgPSB7XG4gIGxvdzogMTAsXG4gIG1lZGl1bTogMjUsXG4gIGhpZ2g6IDc1LFxuICBwaG90bzogMTAwLFxufTtcblxuXG5jbGFzcyBTY3JlZW5SZWNvcmRlciB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCB2aWRlb1BhdGgsIG9wdHMgPSB7fSkge1xuICAgIHRoaXMudmlkZW9QYXRoID0gdmlkZW9QYXRoO1xuICAgIHRoaXMub3B0cyA9IG9wdHM7XG4gICAgdGhpcy51ZGlkID0gdWRpZDtcbiAgICB0aGlzLm1haW5Qcm9jZXNzID0gbnVsbDtcbiAgICB0aGlzLmlwcm94eSA9IG51bGw7XG4gICAgdGhpcy50aW1lb3V0SGFuZGxlciA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzdGFydCAodGltZW91dE1zKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZzLndoaWNoKEZGTVBFR19CSU5BUlkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHtGRk1QRUdfQklOQVJZfScgYmluYXJ5IGlzIG5vdCBmb3VuZCBpbiBQQVRILiBJbnN0YWxsIGl0IHVzaW5nICdicmV3IGluc3RhbGwgZmZtcGVnJy4gYCArXG4gICAgICAgIGBDaGVjayBodHRwczovL3d3dy5mZm1wZWcub3JnL2Rvd25sb2FkLmh0bWwgZm9yIG1vcmUgZGV0YWlscy5gKTtcbiAgICB9XG5cbiAgICBjb25zdCBsb2NhbFBvcnQgPSB0aGlzLm9wdHMucmVtb3RlUG9ydDtcbiAgICBjb25zdCB7cHJvdG9jb2wsIGhvc3RuYW1lfSA9IHVybC5wYXJzZSh0aGlzLm9wdHMucmVtb3RlVXJsKTtcbiAgICBpZiAodGhpcy5vcHRzLnVzZVBvcnRGb3J3YXJkaW5nKSB7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0SXByb3h5KGxvY2FsUG9ydCk7XG4gICAgfVxuXG4gICAgY29uc3QgYXJncyA9IFtcbiAgICAgICctZicsICdtanBlZycsXG4gICAgXTtcbiAgICAvL1BhcmFtZXRlciBgLXJgIGlzIG9wdGlvbmFsLiBTZWUgZGV0YWlsczogaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzEyMDY3XG4gICAgaWYgKHRoaXMub3B0cy52aWRlb0ZwcyAmJiB0aGlzLm9wdHMudmlkZW9UeXBlID09PSAnbGlieDI2NCcpIHtcbiAgICAgIGFyZ3MucHVzaCgnLXInLCB0aGlzLm9wdHMudmlkZW9GcHMpO1xuICAgIH1cbiAgICBhcmdzLnB1c2goJy1pJywgYCR7cHJvdG9jb2x9Ly8ke2hvc3RuYW1lfToke2xvY2FsUG9ydH1gKTtcbiAgICBpZiAodGhpcy5vcHRzLnZpZGVvU2NhbGUpIHtcbiAgICAgIGFyZ3MucHVzaCgnLXZmJywgYHNjYWxlPSR7dGhpcy5vcHRzLnZpZGVvU2NhbGV9YCk7XG4gICAgfVxuICAgIC8vIFF1aWNrdGltZSBjb21wYXRpYmlsaXR5IHZpYSBwaXhlbEZvcm1hdDogJ3l1djQyMHAnXG4gICAgaWYgKHRoaXMub3B0cy5waXhlbEZvcm1hdCkge1xuICAgICAgYXJncy5wdXNoKCctcGl4X2ZtdCcsIHRoaXMub3B0cy5waXhlbEZvcm1hdCk7XG4gICAgfVxuICAgIGFyZ3MucHVzaChcbiAgICAgICctdmNvZGVjJywgdGhpcy5vcHRzLnZpZGVvVHlwZSxcbiAgICAgICcteScsIHRoaXMudmlkZW9QYXRoXG4gICAgKTtcblxuICAgIHRoaXMubWFpblByb2Nlc3MgPSBuZXcgU3ViUHJvY2VzcyhGRk1QRUdfQklOQVJZLCBhcmdzKTtcbiAgICBsZXQgaXNDYXB0dXJlU3RhcnRlZCA9IGZhbHNlO1xuICAgIHRoaXMubWFpblByb2Nlc3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKHN0ZGVycikge1xuICAgICAgICBpZiAoc3RkZXJyLnRyaW0oKS5zdGFydHNXaXRoKCdmcmFtZT0nKSkge1xuICAgICAgICAgIGlmICghaXNDYXB0dXJlU3RhcnRlZCkge1xuICAgICAgICAgICAgaXNDYXB0dXJlU3RhcnRlZCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZmbXBlZ0xvZ2dlci5pbmZvKGAke3N0ZGVycn1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMubWFpblByb2Nlc3Muc3RhcnQoMCk7XG4gICAgY29uc3Qgc3RhcnR1cFRpbWVvdXQgPSA1MDAwO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKCgpID0+IGlzQ2FwdHVyZVN0YXJ0ZWQsIHtcbiAgICAgICAgd2FpdE1zOiBzdGFydHVwVGltZW91dCxcbiAgICAgICAgaW50ZXJ2YWxNczogMzAwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLndhcm4oYFNjcmVlbiBjYXB0dXJlIHByb2Nlc3MgZGlkIG5vdCBzdGFydCB3aXRoaW4gJHtzdGFydHVwVGltZW91dH1tcy4gQ29udGludWluZyBhbnl3YXlgKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLm1haW5Qcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc2NyZWVuIGNhcHR1cmUgcHJvY2VzcyAnJHtGRk1QRUdfQklOQVJZfScgZGllZCB1bmV4cGVjdGVkbHkuIGAgK1xuICAgICAgICBgQ2hlY2sgc2VydmVyIGxvZ3MgZm9yIG1vcmUgZGV0YWlsc2ApO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgU3RhcnRpbmcgc2NyZWVuIGNhcHR1cmUgb24gdGhlIGRldmljZSAnJHt0aGlzLnVkaWR9JyB3aXRoIGNvbW1hbmQ6ICcke0ZGTVBFR19CSU5BUll9ICR7YXJncy5qb2luKCcgJyl9Jy4gYCArXG4gICAgICBgV2lsbCB0aW1lb3V0IGluICR7dGltZW91dE1zfW1zYCk7XG5cbiAgICB0aGlzLnRpbWVvdXRIYW5kbGVyID0gc2V0VGltZW91dChhc3luYyAoKSA9PiB7XG4gICAgICBpZiAoIWF3YWl0IHRoaXMuaW50ZXJydXB0KCkpIHtcbiAgICAgICAgbG9nLndhcm4oYENhbm5vdCBmaW5pc2ggdGhlIGFjdGl2ZSBzY3JlZW4gcmVjb3JkaW5nIG9uIHRoZSBkZXZpY2UgJyR7dGhpcy51ZGlkfScgYWZ0ZXIgJHt0aW1lb3V0TXN9bXMgdGltZW91dGApO1xuICAgICAgfVxuICAgIH0sIHRpbWVvdXRNcyk7XG4gIH1cblxuICBhc3luYyBzdGFydElwcm94eSAobG9jYWxQb3J0KSB7XG4gICAgdGhpcy5pcHJveHkgPSBuZXcgaVByb3h5KHRoaXMudWRpZCwgbG9jYWxQb3J0LCB0aGlzLm9wdHMucmVtb3RlUG9ydCwgZmFsc2UpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmlwcm94eS5zdGFydCgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCBzdGFydCBpcHJveHkuIEFzc3VtaW5nIGl0IGlzIGFscmVhZHkgZm9yd2FyZGluZyB0aGUgcmVtb3RlIHBvcnQgJHt0aGlzLm9wdHMucmVtb3RlUG9ydH0gdG8gJHtsb2NhbFBvcnR9IGAgK1xuICAgICAgICBgZm9yIHRoZSBkZXZpY2UgJHt0aGlzLnVkaWR9LiBTZXQgdGhlIGN1c3RvbSB2YWx1ZSB0byAnbWpwZWdTZXJ2ZXJQb3J0JyBjYXBhYmlsaXR5IGlmIHRoaXMgaXMgYW4gdW5kZXNpcmVkIGJlaGF2aW9yLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgdGhpcy5pcHJveHkgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3BJcHJveHkgKCkge1xuICAgIGlmICghdGhpcy5pcHJveHkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBxdWl0UHJvbWlzZSA9IHRoaXMuaXByb3h5LnF1aXQoKTtcbiAgICB0aGlzLmlwcm94eSA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHF1aXRQcm9taXNlO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCBzdG9wIGlwcm94eS4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW50ZXJydXB0IChmb3JjZSA9IGZhbHNlKSB7XG4gICAgbGV0IHJlc3VsdCA9IHRydWU7XG5cbiAgICBpZiAodGhpcy50aW1lb3V0SGFuZGxlcikge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dEhhbmRsZXIpO1xuICAgICAgdGhpcy50aW1lb3V0SGFuZGxlciA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubWFpblByb2Nlc3MgJiYgdGhpcy5tYWluUHJvY2Vzcy5pc1J1bm5pbmcpIHtcbiAgICAgIGNvbnN0IGludGVycnVwdFByb21pc2UgPSB0aGlzLm1haW5Qcm9jZXNzLnN0b3AoZm9yY2UgPyAnU0lHVEVSTScgOiAnU0lHSU5UJyk7XG4gICAgICB0aGlzLm1haW5Qcm9jZXNzID0gbnVsbDtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGludGVycnVwdFByb21pc2U7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgJHtmb3JjZSA/ICd0ZXJtaW5hdGUnIDogJ2ludGVycnVwdCd9ICR7RkZNUEVHX0JJTkFSWX0uIGAgK1xuICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICAgIHJlc3VsdCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLm9wdHMudXNlUG9ydEZvcndhcmRpbmcpIHtcbiAgICAgIGF3YWl0IHRoaXMuc3RvcElwcm94eSgpO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBhc3luYyBmaW5pc2ggKCkge1xuICAgIGF3YWl0IHRoaXMuaW50ZXJydXB0KCk7XG4gICAgcmV0dXJuIHRoaXMudmlkZW9QYXRoO1xuICB9XG5cbiAgYXN5bmMgY2xlYW51cCAoKSB7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyh0aGlzLnZpZGVvUGF0aCkpIHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZih0aGlzLnZpZGVvUGF0aCk7XG4gICAgfVxuICB9XG59XG5cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdGFydFJlY29yZGluZ09wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byB0aGUgcmVtb3RlIGxvY2F0aW9uLCB3aGVyZSB0aGUgcmVzdWx0aW5nIHZpZGVvIHNob3VsZCBiZSB1cGxvYWRlZC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBmb2xsb3dpbmcgcHJvdG9jb2xzIGFyZSBzdXBwb3J0ZWQ6IGh0dHAvaHR0cHMsIGZ0cC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE51bGwgb3IgZW1wdHkgc3RyaW5nIHZhbHVlICh0aGUgZGVmYXVsdCBzZXR0aW5nKSBtZWFucyB0aGUgY29udGVudCBvZiByZXN1bHRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUgc2hvdWxkIGJlIGVuY29kZWQgYXMgQmFzZTY0IGFuZCBwYXNzZWQgYXMgdGhlIGVuZHBvaW50IHJlc3BvbnNlIHZhbHVlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duIGlmIHRoZSBnZW5lcmF0ZWQgbWVkaWEgZmlsZSBpcyB0b28gYmlnIHRvXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXQgaW50byB0aGUgYXZhaWxhYmxlIHByb2Nlc3MgbWVtb3J5LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBvcHRpb24gb25seSBoYXMgYW4gZWZmZWN0IGlmIHRoZXJlIGlzIHNjcmVlbiByZWNvcmRpbmcgcHJvY2VzcyBpbiBwcm9ncmVzc1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5kIGBmb3JjZVJlc3RhcnRgIHBhcmFtZXRlciBpcyBub3Qgc2V0IHRvIGB0cnVlYC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdXNlciAtIFRoZSBuYW1lIG9mIHRoZSB1c2VyIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIFRoZSAnUFVUJyBvbmUgaXMgdXNlZCBieSBkZWZhdWx0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmlkZW9UeXBlIC0gVGhlIHZpZGVvIGNvZGVjIHR5cGUgdXNlZCBmb3IgZW5jb2Rpbmcgb2YgdGhlIGJlIHJlY29yZGVkIHNjcmVlbiBjYXB0dXJlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBFeGVjdXRlIGBmZm1wZWcgLWNvZGVjc2AgaW4gdGhlIHRlcm1pbmFsIHRvIHNlZSB0aGUgbGlzdCBvZiBzdXBwb3J0ZWQgdmlkZW8gY29kZWNzLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWpwZWcnIGJ5IGRlZmF1bHQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSB2aWRlb1F1YWxpdHkgLSBUaGUgdmlkZW8gZW5jb2RpbmcgcXVhbGl0eSAobG93LCBtZWRpdW0sIGhpZ2gsIHBob3RvIC0gZGVmYXVsdHMgdG8gbWVkaXVtKS5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ3xudW1iZXJ9IHZpZGVvRnBzIC0gVGhlIEZyYW1lcyBQZXIgU2Vjb25kIHJhdGUgb2YgdGhlIHJlY29yZGVkIHZpZGVvLiBDaGFuZ2UgdGhpcyB2YWx1ZSBpZiB0aGUgcmVzdWx0aW5nIHZpZGVvXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXMgdG9vIHNsb3cgb3IgdG9vIGZhc3QuIERlZmF1bHRzIHRvIDEwLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2aWRlb1NjYWxlIC0gVGhlIHNjYWxpbmcgdmFsdWUgdG8gYXBwbHkuIFJlYWQgaHR0cHM6Ly90cmFjLmZmbXBlZy5vcmcvd2lraS9TY2FsaW5nIGZvciBwb3NzaWJsZSB2YWx1ZXMuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBObyBzY2FsZSBpcyBhcHBsaWVkIGJ5IGRlZmF1bHQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBpeGVsRm9ybWF0IC0gT3V0cHV0IHBpeGVsIGZvcm1hdC4gUnVuIGBmZm1wZWcgLXBpeF9mbXRzYCB0byBsaXN0IHBvc3NpYmxlIHZhbHVlcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGb3IgUXVpY2t0aW1lIGNvbXBhdGliaWxpdHksIHNldCB0byBcInl1djQyMHBcIiBhbG9uZyB3aXRoIHZpZGVvVHlwZTogXCJsaWJ4MjY0XCIuXG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBmb3JjZVJlc3RhcnQgLSBXaGV0aGVyIHRvIHRyeSB0byBjYXRjaCBhbmQgdXBsb2FkL3JldHVybiB0aGUgY3VycmVudGx5IHJ1bm5pbmcgc2NyZWVuIHJlY29yZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGBmYWxzZWAsIHRoZSBkZWZhdWx0IHNldHRpbmcpIG9yIGlnbm9yZSB0aGUgcmVzdWx0IG9mIGl0IGFuZCBzdGFydCBhIG5ldyByZWNvcmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltbWVkaWF0ZWx5LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gdGltZUxpbWl0IC0gVGhlIG1heGltdW0gcmVjb3JkaW5nIHRpbWUsIGluIHNlY29uZHMuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAxODAsIHRoZSBtYXhpbXVtIHZhbHVlIGlzIDYwMCAoMTAgbWludXRlcykuXG4gKi9cblxuLyoqXG4gKiBSZWNvcmQgdGhlIGRpc3BsYXkgb2YgZGV2aWNlcyBydW5uaW5nIGlPUyBTaW11bGF0b3Igc2luY2UgWGNvZGUgOSBvciByZWFsIGRldmljZXMgc2luY2UgaU9TIDExXG4gKiAoZmZtcGVnIHV0aWxpdHkgaXMgcmVxdWlyZWQ6ICdicmV3IGluc3RhbGwgZmZtcGVnJykuXG4gKiBJdCByZWNvcmRzIHNjcmVlbiBhY3Rpdml0eSB0byBhIE1QRUctNCBmaWxlLiBBdWRpbyBpcyBub3QgcmVjb3JkZWQgd2l0aCB0aGUgdmlkZW8gZmlsZS5cbiAqIElmIHNjcmVlbiByZWNvcmRpbmcgaGFzIGJlZW4gYWxyZWFkeSBzdGFydGVkIHRoZW4gdGhlIGNvbW1hbmQgd2lsbCBzdG9wIGl0IGZvcmNlZnVsbHkgYW5kIHN0YXJ0IGEgbmV3IG9uZS5cbiAqIFRoZSBwcmV2aW91c2x5IHJlY29yZGVkIHZpZGVvIGZpbGUgd2lsbCBiZSBkZWxldGVkLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWZcbiAqICAgICAgICAgICAgICAgICAgIGFueSBzY3JlZW4gcmVjb3JkaW5nIGlzIGN1cnJlbnRseSBydW5uaW5nIG9yIGFuIGVtcHR5IHN0cmluZy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzY3JlZW4gcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gc3RhcnQuXG4gKi9cbmNvbW1hbmRzLnN0YXJ0UmVjb3JkaW5nU2NyZWVuID0gYXN5bmMgZnVuY3Rpb24gc3RhcnRSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdmlkZW9UeXBlID0gREVGQVVMVF9WQ09ERUMsXG4gICAgdGltZUxpbWl0ID0gREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMsXG4gICAgdmlkZW9RdWFsaXR5ID0gREVGQVVMVF9RVUFMSVRZLFxuICAgIHZpZGVvRnBzID0gREVGQVVMVF9GUFMsXG4gICAgdmlkZW9TY2FsZSxcbiAgICBmb3JjZVJlc3RhcnQsXG4gIH0gPSBvcHRpb25zO1xuXG4gIGxldCByZXN1bHQgPSAnJztcbiAgaWYgKCFmb3JjZVJlc3RhcnQpIHtcbiAgICBsb2cuaW5mbyhgQ2hlY2tpbmcgaWYgdGhlcmUgaXMvd2FzIGEgcHJldmlvdXMgc2NyZWVuIHJlY29yZGluZy4gYCArXG4gICAgICBgU2V0ICdmb3JjZVJlc3RhcnQnIG9wdGlvbiB0byAndHJ1ZScgaWYgeW91J2QgbGlrZSB0byBza2lwIHRoaXMgc3RlcC5gKTtcbiAgICByZXN1bHQgPSBhd2FpdCB0aGlzLnN0b3BSZWNvcmRpbmdTY3JlZW4ob3B0aW9ucyk7XG4gIH1cblxuICBjb25zdCB2aWRlb1BhdGggPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe1xuICAgIHByZWZpeDogYGFwcGl1bV8ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygyLCA4KX1gLFxuICAgIHN1ZmZpeDogTVA0X0VYVCxcbiAgfSk7XG5cbiAgY29uc3Qgd2RhQmFzZVVybCA9IHRoaXMub3B0cy53ZGFCYXNlVXJsIHx8IFdEQV9CQVNFX1VSTDtcbiAgY29uc3Qgc2NyZWVuUmVjb3JkZXIgPSBuZXcgU2NyZWVuUmVjb3JkZXIodGhpcy5vcHRzLmRldmljZS51ZGlkLCB2aWRlb1BhdGgsIHtcbiAgICByZW1vdGVQb3J0OiB0aGlzLm9wdHMubWpwZWdTZXJ2ZXJQb3J0IHx8IERFRkFVTFRfTUpQRUdfU0VSVkVSX1BPUlQsXG4gICAgcmVtb3RlVXJsOiB3ZGFCYXNlVXJsLFxuICAgIHVzZVBvcnRGb3J3YXJkaW5nOiB0aGlzLmlzUmVhbERldmljZSgpICYmIGlzTG9jYWxIb3N0KHdkYUJhc2VVcmwpLFxuICAgIHZpZGVvVHlwZSxcbiAgICB2aWRlb1NjYWxlLFxuICAgIHZpZGVvRnBzXG4gIH0pO1xuICBpZiAoIWF3YWl0IHNjcmVlblJlY29yZGVyLmludGVycnVwdCh0cnVlKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdVbmFibGUgdG8gc3RvcCBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MnKTtcbiAgfVxuICBpZiAodGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIpIHtcbiAgICBhd2FpdCB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuICB9XG5cbiAgY29uc3QgdGltZW91dFNlY29uZHMgPSBwYXJzZUZsb2F0KHRpbWVMaW1pdCk7XG4gIGlmIChpc05hTih0aW1lb3V0U2Vjb25kcykgfHwgdGltZW91dFNlY29uZHMgPiBNQVhfUkVDT1JESU5HX1RJTUVfU0VDIHx8IHRpbWVvdXRTZWNvbmRzIDw9IDApIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIHRpbWVMaW1pdCB2YWx1ZSBtdXN0IGJlIGluIHJhbmdlIFsxLCAke01BWF9SRUNPUkRJTkdfVElNRV9TRUN9XSBzZWNvbmRzLiBgICtcbiAgICAgIGBUaGUgdmFsdWUgb2YgJyR7dGltZUxpbWl0fScgaGFzIGJlZW4gcGFzc2VkIGluc3RlYWQuYCk7XG4gIH1cblxuICBsZXQge1xuICAgIG1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHksXG4gICAgbWpwZWdTZXJ2ZXJGcmFtZXJhdGUsXG4gIH0gPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL2FwcGl1bS9zZXR0aW5ncycsICdHRVQnKTtcbiAgaWYgKHZpZGVvUXVhbGl0eSkge1xuICAgIGNvbnN0IHF1YWxpdHkgPSBfLmlzSW50ZWdlcih2aWRlb1F1YWxpdHkpID8gdmlkZW9RdWFsaXR5IDogUVVBTElUWV9NQVBQSU5HW18udG9Mb3dlcih2aWRlb1F1YWxpdHkpXTtcbiAgICBpZiAoIXF1YWxpdHkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgdmlkZW9RdWFsaXR5IHZhbHVlIHNob3VsZCBiZSBvbmUgb2YgJHtKU09OLnN0cmluZ2lmeShfLmtleXMoUVVBTElUWV9NQVBQSU5HKSl9IG9yIGEgbnVtYmVyIGluIHJhbmdlIDEuLjEwMC4gYCArXG4gICAgICAgIGAnJHt2aWRlb1F1YWxpdHl9JyBpcyBnaXZlbiBpbnN0ZWFkYCk7XG4gICAgfVxuICAgIG1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHkgPSBtanBlZ1NlcnZlclNjcmVlbnNob3RRdWFsaXR5ICE9PSBxdWFsaXR5ID8gcXVhbGl0eSA6IHVuZGVmaW5lZDtcbiAgfSBlbHNlIHtcbiAgICBtanBlZ1NlcnZlclNjcmVlbnNob3RRdWFsaXR5ID0gdW5kZWZpbmVkO1xuICB9XG4gIGlmICh2aWRlb0Zwcykge1xuICAgIGNvbnN0IGZwcyA9IHBhcnNlSW50KHZpZGVvRnBzLCAxMCk7XG4gICAgaWYgKGlzTmFOKGZwcykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgdmlkZW9GcHMgdmFsdWUgc2hvdWxkIGJlIGEgdmFsaWQgbnVtYmVyIGluIHJhbmdlIDEuLjYwLiBgICtcbiAgICAgICAgYCcke3ZpZGVvRnBzfScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICAgIH1cbiAgICBtanBlZ1NlcnZlckZyYW1lcmF0ZSA9IG1qcGVnU2VydmVyRnJhbWVyYXRlICE9PSBmcHMgPyBmcHMgOiB1bmRlZmluZWQ7XG4gIH0gZWxzZSB7XG4gICAgbWpwZWdTZXJ2ZXJGcmFtZXJhdGUgPSB1bmRlZmluZWQ7XG4gIH1cbiAgaWYgKHV0aWwuaGFzVmFsdWUobWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSkgfHwgdXRpbC5oYXNWYWx1ZShtanBlZ1NlcnZlckZyYW1lcmF0ZSkpIHtcbiAgICBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL2FwcGl1bS9zZXR0aW5ncycsICdQT1NUJywge1xuICAgICAgc2V0dGluZ3M6IHtcbiAgICAgICAgbWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSxcbiAgICAgICAgbWpwZWdTZXJ2ZXJGcmFtZXJhdGUsXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICB0cnkge1xuICAgIGF3YWl0IHNjcmVlblJlY29yZGVyLnN0YXJ0KHRpbWVvdXRTZWNvbmRzICogMTAwMCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBhd2FpdCBzY3JlZW5SZWNvcmRlci5pbnRlcnJ1cHQodHJ1ZSk7XG4gICAgYXdhaXQgc2NyZWVuUmVjb3JkZXIuY2xlYW51cCgpO1xuICAgIHRocm93IGU7XG4gIH1cbiAgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIgPSBzY3JlZW5SZWNvcmRlcjtcblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdG9wUmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlIHRoZSByZXN1bHRpbmcgdmlkZW8gc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSBzaG91bGQgYmUgZW5jb2RlZCBhcyBCYXNlNjQgYW5kIHBhc3NlZCBhcyB0aGUgZW5kcG9pbnQgcmVzcG9uc2UgdmFsdWUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd24gaWYgdGhlIGdlbmVyYXRlZCBtZWRpYSBmaWxlIGlzIHRvbyBiaWcgdG9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpdCBpbnRvIHRoZSBhdmFpbGFibGUgcHJvY2VzcyBtZW1vcnkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhc3MgLSBUaGUgcGFzc3dvcmQgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBtZXRob2QgLSBUaGUgaHR0cCBtdWx0aXBhcnQgdXBsb2FkIG1ldGhvZCBuYW1lLiBUaGUgJ1BVVCcgb25lIGlzIHVzZWQgYnkgZGVmYXVsdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKi9cblxuLyoqXG4gKiBTdG9wIHJlY29yZGluZyB0aGUgc2NyZWVuLiBJZiBubyBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MgaXMgcnVubmluZyB0aGVuXG4gKiB0aGUgZW5kcG9pbnQgd2lsbCB0cnkgdG8gZ2V0IHRoZSByZWNlbnRseSByZWNvcmRlZCBmaWxlLlxuICogSWYgbm8gcHJldmlvdXNseSByZWNvcmRlZCBmaWxlIGlzIGZvdW5kIGFuZCBubyBhY3RpdmUgc2NyZWVuIHJlY29yZGluZ1xuICogcHJvY2Vzc2VzIGFyZSBydW5uaW5nIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IHN0cmluZy5cbiAqXG4gKiBAcGFyYW0gez9TdG9wUmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWYgJ3JlbW90ZVBhdGgnXG4gKiAgICAgICAgICAgICAgICAgICBwYXJhbWV0ZXIgaXMgZW1wdHkgb3IgbnVsbCBvciBhbiBlbXB0eSBzdHJpbmcuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIG5hbWUgb2YgYSBtZWRpYSBmaWxlXG4gKiAgICAgICAgICAgICAgICAgb3IgdGhlIGZpbGUgY29udGVudCBjYW5ub3QgYmUgdXBsb2FkZWQgdG8gdGhlIHJlbW90ZSBsb2NhdGlvbi5cbiAqL1xuY29tbWFuZHMuc3RvcFJlY29yZGluZ1NjcmVlbiA9IGFzeW5jIGZ1bmN0aW9uIHN0b3BSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgcmVtb3RlUGF0aCxcbiAgICB1c2VyLFxuICAgIHBhc3MsXG4gICAgbWV0aG9kLFxuICB9ID0gb3B0aW9ucztcblxuICBpZiAoIXRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyKSB7XG4gICAgbG9nLmluZm8oJ1NjcmVlbiByZWNvcmRpbmcgaXMgbm90IHJ1bm5pbmcuIFRoZXJlIGlzIG5vdGhpbmcgdG8gc3RvcC4nKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmZpbmlzaCgpO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHZpZGVvUGF0aCkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgc2NyZWVuIHJlY29yZGVyIHV0aWxpdHkgaGFzIGZhaWxlZCBgICtcbiAgICAgICAgYHRvIHN0b3JlIHRoZSBhY3R1YWwgc2NyZWVuIHJlY29yZGluZyBhdCAnJHt2aWRlb1BhdGh9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgZW5jb2RlQmFzZTY0T3JVcGxvYWQodmlkZW9QYXRoLCByZW1vdGVQYXRoLCB7XG4gICAgICB1c2VyLFxuICAgICAgcGFzcyxcbiAgICAgIG1ldGhvZFxuICAgIH0pO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICBhd2FpdCB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuICB9XG59O1xuXG5cbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3JlY29yZHNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
