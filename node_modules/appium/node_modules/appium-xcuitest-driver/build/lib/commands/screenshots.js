"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

var _nodeSimctl = require("node-simctl");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

let commands = {};

async function getScreenshotWithIdevicelib(udid, isLandscape) {
  const pathToScreenshotTiff = await _appiumSupport.tempDir.path({
    prefix: `screenshot-${udid}`,
    suffix: '.tiff'
  });
  await _appiumSupport.fs.rimraf(pathToScreenshotTiff);
  const pathToResultPng = await _appiumSupport.tempDir.path({
    prefix: `screenshot-${udid}`,
    suffix: '.png'
  });
  await _appiumSupport.fs.rimraf(pathToResultPng);

  try {
    try {
      await (0, _teen_process.exec)('idevicescreenshot', ['-u', udid, pathToScreenshotTiff]);
    } catch (e) {
      throw new Error(`Cannot take a screenshot from the device '${udid}' using ` + `idevicescreenshot. Original error: ${e.message}`);
    }

    let sipsArgs = ['-s', 'format', 'png', pathToScreenshotTiff, '--out', pathToResultPng];

    if (isLandscape) {
      sipsArgs = ['-r', '-90', ...sipsArgs];
    }

    try {
      await (0, _teen_process.exec)('sips', sipsArgs);
    } catch (e) {
      throw new Error(`Cannot convert a screenshot from TIFF to PNG using sips tool. ` + `Original error: ${e.message}`);
    }

    if (!(await _appiumSupport.fs.exists(pathToResultPng))) {
      throw new Error(`Cannot convert a screenshot from TIFF to PNG. The conversion ` + `result does not exist at '${pathToResultPng}'`);
    }

    return (await _appiumSupport.fs.readFile(pathToResultPng)).toString('base64');
  } finally {
    await _appiumSupport.fs.rimraf(pathToScreenshotTiff);
    await _appiumSupport.fs.rimraf(pathToResultPng);
  }
}

async function verifyIdeviceScreenshotAvailable() {
  try {
    await _appiumSupport.fs.which('idevicescreenshot');
  } catch (err) {
    throw new Error(`No 'idevicescreenshot' program found. To use, install ` + `using 'brew install --HEAD libimobiledevice'`);
  }
}

commands.getScreenshot = async function getScreenshot() {
  const getScreenshotFromIDS = async () => {
    _logger.default.debug(`Taking screenshot with 'idevicescreenshot'`);

    await verifyIdeviceScreenshotAvailable();
    const orientation = await this.proxyCommand('/orientation', 'GET');
    return await getScreenshotWithIdevicelib(this.opts.udid, orientation === 'LANDSCAPE');
  };

  const getScreenshotFromWDA = async () => {
    _logger.default.debug(`Taking screenshot with WDA`);

    const data = await this.proxyCommand('/screenshot', 'GET');

    if (!_lodash.default.isString(data)) {
      throw new Error(`Unable to take screenshot. WDA returned '${JSON.stringify(data)}'`);
    }

    return data;
  };

  if (this.opts.realDeviceScreenshotter && this.mjpegStream) {
    _logger.default.warn("You've specified screenshot retrieval via both MJpeg server " + 'and a real device screenshot utility. Please use one or the ' + 'other! Choosing MJPEG server');
  }

  if (this.mjpegStrem) {
    const data = await this.mjpegStream.lastChunkPNGBase64();

    if (data) {
      return data;
    }

    _logger.default.warn('Tried to get screenshot from active MJPEG stream, but there ' + 'was no data yet. Falling back to regular screenshot methods.');
  }

  const useIdeviceScreenshot = _lodash.default.lowerCase(this.opts.realDeviceScreenshotter) === 'idevicescreenshot';

  if (useIdeviceScreenshot) {
    return await getScreenshotFromIDS();
  }

  try {
    return await getScreenshotFromWDA();
  } catch (err) {
    _logger.default.warn(`Error getting screenshot: ${err.message}`);
  }

  if (this.isSimulator()) {
    if (this.xcodeVersion.versionFloat < 8.1) {
      _logger.default.errorAndThrow(`No command line screenshot ability with Xcode ` + `${this.xcodeVersion.versionFloat}. Please upgrade to ` + `at least Xcode 8.1`);
    }

    _logger.default.info(`Falling back to 'simctl io screenshot' API`);

    return await (0, _nodeSimctl.getScreenshot)(this.opts.udid);
  }

  try {
    return await getScreenshotFromIDS();
  } catch (err) {
    _logger.default.warn(`Error getting screenshot through 'idevicescreenshot': ${err.message}`);
  }

  return await (0, _asyncbox.retryInterval)(2, 1000, getScreenshotFromWDA);
};

commands.getElementScreenshot = async function getElementScreenshot(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    const atomsElement = this.useAtomsElement(el);
    return await this.executeAtom('getElementScreenshot', [atomsElement]);
  }

  if (this.xcodeVersion.major < 9) {
    _logger.default.errorAndThrow(`Element screenshots are only available since Xcode 9. ` + `The current Xcode version is ${this.xcodeVersion.major}.${this.xcodeVersion.minor}`);
  }

  const data = await this.proxyCommand(`/element/${el}/screenshot`, 'GET');

  if (!_lodash.default.isString(data)) {
    _logger.default.errorAndThrow(`Unable to take a screenshot of the element ${el}. WDA returned '${JSON.stringify(data)}'`);
  }

  return data;
};

commands.getViewportScreenshot = async function getViewportScreenshot() {
  let statusBarHeight = await this.getStatusBarHeight();
  const screenshot = await this.getScreenshot();

  if (statusBarHeight === 0) {
    return screenshot;
  }

  const scale = await this.getDevicePixelRatio();
  statusBarHeight = Math.round(statusBarHeight * scale);
  const windowSize = await this.getWindowSize();
  let rect = {
    left: 0,
    top: statusBarHeight,
    width: windowSize.width * scale,
    height: windowSize.height * scale - statusBarHeight
  };
  let newScreenshot = await _appiumSupport.imageUtil.cropBase64Image(screenshot, rect);
  return newScreenshot;
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9zY3JlZW5zaG90cy5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImdldFNjcmVlbnNob3RXaXRoSWRldmljZWxpYiIsInVkaWQiLCJpc0xhbmRzY2FwZSIsInBhdGhUb1NjcmVlbnNob3RUaWZmIiwidGVtcERpciIsInBhdGgiLCJwcmVmaXgiLCJzdWZmaXgiLCJmcyIsInJpbXJhZiIsInBhdGhUb1Jlc3VsdFBuZyIsImUiLCJFcnJvciIsIm1lc3NhZ2UiLCJzaXBzQXJncyIsImV4aXN0cyIsInJlYWRGaWxlIiwidG9TdHJpbmciLCJ2ZXJpZnlJZGV2aWNlU2NyZWVuc2hvdEF2YWlsYWJsZSIsIndoaWNoIiwiZXJyIiwiZ2V0U2NyZWVuc2hvdCIsImdldFNjcmVlbnNob3RGcm9tSURTIiwibG9nIiwiZGVidWciLCJvcmllbnRhdGlvbiIsInByb3h5Q29tbWFuZCIsIm9wdHMiLCJnZXRTY3JlZW5zaG90RnJvbVdEQSIsImRhdGEiLCJfIiwiaXNTdHJpbmciLCJKU09OIiwic3RyaW5naWZ5IiwicmVhbERldmljZVNjcmVlbnNob3R0ZXIiLCJtanBlZ1N0cmVhbSIsIndhcm4iLCJtanBlZ1N0cmVtIiwibGFzdENodW5rUE5HQmFzZTY0IiwidXNlSWRldmljZVNjcmVlbnNob3QiLCJsb3dlckNhc2UiLCJpc1NpbXVsYXRvciIsInhjb2RlVmVyc2lvbiIsInZlcnNpb25GbG9hdCIsImVycm9yQW5kVGhyb3ciLCJpbmZvIiwiZ2V0RWxlbWVudFNjcmVlbnNob3QiLCJlbCIsInV0aWwiLCJ1bndyYXBFbGVtZW50IiwiaXNXZWJDb250ZXh0IiwiYXRvbXNFbGVtZW50IiwidXNlQXRvbXNFbGVtZW50IiwiZXhlY3V0ZUF0b20iLCJtYWpvciIsIm1pbm9yIiwiZ2V0Vmlld3BvcnRTY3JlZW5zaG90Iiwic3RhdHVzQmFySGVpZ2h0IiwiZ2V0U3RhdHVzQmFySGVpZ2h0Iiwic2NyZWVuc2hvdCIsInNjYWxlIiwiZ2V0RGV2aWNlUGl4ZWxSYXRpbyIsIk1hdGgiLCJyb3VuZCIsIndpbmRvd1NpemUiLCJnZXRXaW5kb3dTaXplIiwicmVjdCIsImxlZnQiLCJ0b3AiLCJ3aWR0aCIsImhlaWdodCIsIm5ld1NjcmVlbnNob3QiLCJpbWFnZVV0aWwiLCJjcm9wQmFzZTY0SW1hZ2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7O0FBRUEsZUFBZUMsMkJBQWYsQ0FBNENDLElBQTVDLEVBQWtEQyxXQUFsRCxFQUErRDtBQUM3RCxRQUFNQyxvQkFBb0IsR0FBRyxNQUFNQyx1QkFBUUMsSUFBUixDQUFhO0FBQUNDLElBQUFBLE1BQU0sRUFBRyxjQUFhTCxJQUFLLEVBQTVCO0FBQStCTSxJQUFBQSxNQUFNLEVBQUU7QUFBdkMsR0FBYixDQUFuQztBQUNBLFFBQU1DLGtCQUFHQyxNQUFILENBQVVOLG9CQUFWLENBQU47QUFDQSxRQUFNTyxlQUFlLEdBQUcsTUFBTU4sdUJBQVFDLElBQVIsQ0FBYTtBQUFDQyxJQUFBQSxNQUFNLEVBQUcsY0FBYUwsSUFBSyxFQUE1QjtBQUErQk0sSUFBQUEsTUFBTSxFQUFFO0FBQXZDLEdBQWIsQ0FBOUI7QUFDQSxRQUFNQyxrQkFBR0MsTUFBSCxDQUFVQyxlQUFWLENBQU47O0FBQ0EsTUFBSTtBQUNGLFFBQUk7QUFDRixZQUFNLHdCQUFLLG1CQUFMLEVBQTBCLENBQUMsSUFBRCxFQUFPVCxJQUFQLEVBQWFFLG9CQUFiLENBQTFCLENBQU47QUFDRCxLQUZELENBRUUsT0FBT1EsQ0FBUCxFQUFVO0FBQ1YsWUFBTSxJQUFJQyxLQUFKLENBQVcsNkNBQTRDWCxJQUFLLFVBQWxELEdBQ2Isc0NBQXFDVSxDQUFDLENBQUNFLE9BQVEsRUFENUMsQ0FBTjtBQUVEOztBQUNELFFBQUlDLFFBQVEsR0FBRyxDQUFDLElBQUQsRUFBTyxRQUFQLEVBQWlCLEtBQWpCLEVBQXdCWCxvQkFBeEIsRUFBOEMsT0FBOUMsRUFBdURPLGVBQXZELENB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QVYsQ0FBMEJkLFVBQTFCLEVBQXNDTyxJQUF0QyxDQUExQjtBQUNBLFNBQU9LLGFBQVA7QUFDRCxDQXRCRDs7ZUF3QmV4RSxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBnZXRTY3JlZW5zaG90IGFzIHNpbWN0bEdldFNjcmVlbnNob3QgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCB1dGlsLCBpbWFnZVV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmxldCBjb21tYW5kcyA9IHt9O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRTY3JlZW5zaG90V2l0aElkZXZpY2VsaWIgKHVkaWQsIGlzTGFuZHNjYXBlKSB7XG4gIGNvbnN0IHBhdGhUb1NjcmVlbnNob3RUaWZmID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6IGBzY3JlZW5zaG90LSR7dWRpZH1gLCBzdWZmaXg6ICcudGlmZid9KTtcbiAgYXdhaXQgZnMucmltcmFmKHBhdGhUb1NjcmVlbnNob3RUaWZmKTtcbiAgY29uc3QgcGF0aFRvUmVzdWx0UG5nID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6IGBzY3JlZW5zaG90LSR7dWRpZH1gLCBzdWZmaXg6ICcucG5nJ30pO1xuICBhd2FpdCBmcy5yaW1yYWYocGF0aFRvUmVzdWx0UG5nKTtcbiAgdHJ5IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhlYygnaWRldmljZXNjcmVlbnNob3QnLCBbJy11JywgdWRpZCwgcGF0aFRvU2NyZWVuc2hvdFRpZmZdKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCB0YWtlIGEgc2NyZWVuc2hvdCBmcm9tIHRoZSBkZXZpY2UgJyR7dWRpZH0nIHVzaW5nIGAgK1xuICAgICAgICBgaWRldmljZXNjcmVlbnNob3QuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gICAgbGV0IHNpcHNBcmdzID0gWyctcycsICdmb3JtYXQnLCAncG5nJywgcGF0aFRvU2NyZWVuc2hvdFRpZmYsICctLW91dCcsIHBhdGhUb1Jlc3VsdFBuZ107XG4gICAgaWYgKGlzTGFuZHNjYXBlKSB7XG4gICAgICBzaXBzQXJncyA9IFsnLXInLCAnLTkwJywgLi4uc2lwc0FyZ3NdO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgLy8gVGhlIHNpcHMgdG9vbCBpcyBvbmx5IHByZXNlbnQgb24gTWFjIE9TXG4gICAgICBhd2FpdCBleGVjKCdzaXBzJywgc2lwc0FyZ3MpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGNvbnZlcnQgYSBzY3JlZW5zaG90IGZyb20gVElGRiB0byBQTkcgdXNpbmcgc2lwcyB0b29sLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMocGF0aFRvUmVzdWx0UG5nKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY29udmVydCBhIHNjcmVlbnNob3QgZnJvbSBUSUZGIHRvIFBORy4gVGhlIGNvbnZlcnNpb24gYCArXG4gICAgICAgIGByZXN1bHQgZG9lcyBub3QgZXhpc3QgYXQgJyR7cGF0aFRvUmVzdWx0UG5nfSdgKTtcbiAgICB9XG4gICAgcmV0dXJuIChhd2FpdCBmcy5yZWFkRmlsZShwYXRoVG9SZXN1bHRQbmcpKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKHBhdGhUb1NjcmVlbnNob3RUaWZmKTtcbiAgICBhd2FpdCBmcy5yaW1yYWYocGF0aFRvUmVzdWx0UG5nKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlJZGV2aWNlU2NyZWVuc2hvdEF2YWlsYWJsZSAoKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud2hpY2goJ2lkZXZpY2VzY3JlZW5zaG90Jyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgTm8gJ2lkZXZpY2VzY3JlZW5zaG90JyBwcm9ncmFtIGZvdW5kLiBUbyB1c2UsIGluc3RhbGwgYCArXG4gICAgICAgICAgICAgICAgICAgIGB1c2luZyAnYnJldyBpbnN0YWxsIC0tSEVBRCBsaWJpbW9iaWxlZGV2aWNlJ2ApO1xuICB9XG59XG5cbmNvbW1hbmRzLmdldFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiBnZXRTY3JlZW5zaG90ICgpIHtcbiAgY29uc3QgZ2V0U2NyZWVuc2hvdEZyb21JRFMgPSBhc3luYyAoKSA9PiB7XG4gICAgbG9nLmRlYnVnKGBUYWtpbmcgc2NyZWVuc2hvdCB3aXRoICdpZGV2aWNlc2NyZWVuc2hvdCdgKTtcbiAgICBhd2FpdCB2ZXJpZnlJZGV2aWNlU2NyZWVuc2hvdEF2YWlsYWJsZSgpO1xuICAgIGNvbnN0IG9yaWVudGF0aW9uID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9vcmllbnRhdGlvbicsICdHRVQnKTtcbiAgICByZXR1cm4gYXdhaXQgZ2V0U2NyZWVuc2hvdFdpdGhJZGV2aWNlbGliKHRoaXMub3B0cy51ZGlkLCBvcmllbnRhdGlvbiA9PT0gJ0xBTkRTQ0FQRScpO1xuICB9O1xuXG4gIGNvbnN0IGdldFNjcmVlbnNob3RGcm9tV0RBID0gYXN5bmMgKCkgPT4ge1xuICAgIGxvZy5kZWJ1ZyhgVGFraW5nIHNjcmVlbnNob3Qgd2l0aCBXREFgKTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9zY3JlZW5zaG90JywgJ0dFVCcpO1xuICAgIGlmICghXy5pc1N0cmluZyhkYXRhKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gdGFrZSBzY3JlZW5zaG90LiBXREEgcmV0dXJuZWQgJyR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICAvLyBlbnN1cmUgdGhlIHVzZXIgZG9lc24ndCB0cnkgdG8gdXNlIDIgc3BlY2lhbHR5IHNjcmVlbnNob3QgY2Fwc1xuICBpZiAodGhpcy5vcHRzLnJlYWxEZXZpY2VTY3JlZW5zaG90dGVyICYmIHRoaXMubWpwZWdTdHJlYW0pIHtcbiAgICBsb2cud2FybihcIllvdSd2ZSBzcGVjaWZpZWQgc2NyZWVuc2hvdCByZXRyaWV2YWwgdmlhIGJvdGggTUpwZWcgc2VydmVyIFwiICtcbiAgICAgICAgICAgICAnYW5kIGEgcmVhbCBkZXZpY2Ugc2NyZWVuc2hvdCB1dGlsaXR5LiBQbGVhc2UgdXNlIG9uZSBvciB0aGUgJyArXG4gICAgICAgICAgICAgJ290aGVyISBDaG9vc2luZyBNSlBFRyBzZXJ2ZXInKTtcbiAgfVxuXG4gIC8vIGlmIHdlJ3ZlIHNwZWNpZmllZCBhbiBtanBlZyBzZXJ2ZXIsIHVzZSB0aGF0XG4gIGlmICh0aGlzLm1qcGVnU3RyZW0pIHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5tanBlZ1N0cmVhbS5sYXN0Q2h1bmtQTkdCYXNlNjQoKTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICAgIGxvZy53YXJuKCdUcmllZCB0byBnZXQgc2NyZWVuc2hvdCBmcm9tIGFjdGl2ZSBNSlBFRyBzdHJlYW0sIGJ1dCB0aGVyZSAnICtcbiAgICAgICAgICAgICAnd2FzIG5vIGRhdGEgeWV0LiBGYWxsaW5nIGJhY2sgdG8gcmVndWxhciBzY3JlZW5zaG90IG1ldGhvZHMuJyk7XG4gIH1cblxuICAvLyBvdGhlcndpc2UgdXNlIHRoZSByZWFsIGRldmljZSBzY3JlZW5zaG90dGVyIGFzIHNwZWNpZmllZFxuICBjb25zdCB1c2VJZGV2aWNlU2NyZWVuc2hvdCA9IF8ubG93ZXJDYXNlKHRoaXMub3B0cy5yZWFsRGV2aWNlU2NyZWVuc2hvdHRlcikgPT09ICdpZGV2aWNlc2NyZWVuc2hvdCc7XG4gIGlmICh1c2VJZGV2aWNlU2NyZWVuc2hvdCkge1xuICAgIHJldHVybiBhd2FpdCBnZXRTY3JlZW5zaG90RnJvbUlEUygpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgZ2V0U2NyZWVuc2hvdEZyb21XREEoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYEVycm9yIGdldHRpbmcgc2NyZWVuc2hvdDogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIHNpbXVsYXRvciBhdHRlbXB0XG4gIGlmICh0aGlzLmlzU2ltdWxhdG9yKCkpIHtcbiAgICBpZiAodGhpcy54Y29kZVZlcnNpb24udmVyc2lvbkZsb2F0IDwgOC4xKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgTm8gY29tbWFuZCBsaW5lIHNjcmVlbnNob3QgYWJpbGl0eSB3aXRoIFhjb2RlIGAgK1xuICAgICAgICAgICAgICAgYCR7dGhpcy54Y29kZVZlcnNpb24udmVyc2lvbkZsb2F0fS4gUGxlYXNlIHVwZ3JhZGUgdG8gYCArXG4gICAgICAgICAgICAgICBgYXQgbGVhc3QgWGNvZGUgOC4xYCk7XG4gICAgfVxuICAgIGxvZy5pbmZvKGBGYWxsaW5nIGJhY2sgdG8gJ3NpbWN0bCBpbyBzY3JlZW5zaG90JyBBUElgKTtcbiAgICByZXR1cm4gYXdhaXQgc2ltY3RsR2V0U2NyZWVuc2hvdCh0aGlzLm9wdHMudWRpZCk7XG4gIH1cblxuICAvLyBhbGwgc2ltdWxhdG9yIHNjZW5hcmlvcyBhcmUgZmluaXNoZWRcbiAgLy8gcmVhbCBkZXZpY2UsIHNvIHRyeSBpZGV2aWNlc2NyZWVuc2hvdCBpZiBwb3NzaWJsZVxuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBnZXRTY3JlZW5zaG90RnJvbUlEUygpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgRXJyb3IgZ2V0dGluZyBzY3JlZW5zaG90IHRocm91Z2ggJ2lkZXZpY2VzY3JlZW5zaG90JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIFJldHJ5IGZvciByZWFsIGRldmljZXMgb25seS4gRmFpbCBmYXN0IG9uIFNpbXVsYXRvciBpZiBzaW1jdGwgZG9lcyBub3Qgd29yayBhcyBleHBlY3RlZFxuICByZXR1cm4gYXdhaXQgcmV0cnlJbnRlcnZhbCgyLCAxMDAwLCBnZXRTY3JlZW5zaG90RnJvbVdEQSk7XG59O1xuXG5jb21tYW5kcy5nZXRFbGVtZW50U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uIGdldEVsZW1lbnRTY3JlZW5zaG90IChlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgY29uc3QgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRFbGVtZW50U2NyZWVuc2hvdCcsIFthdG9tc0VsZW1lbnRdKTtcbiAgfVxuXG4gIGlmICh0aGlzLnhjb2RlVmVyc2lvbi5tYWpvciA8IDkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgRWxlbWVudCBzY3JlZW5zaG90cyBhcmUgb25seSBhdmFpbGFibGUgc2luY2UgWGNvZGUgOS4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYFRoZSBjdXJyZW50IFhjb2RlIHZlcnNpb24gaXMgJHt0aGlzLnhjb2RlVmVyc2lvbi5tYWpvcn0uJHt0aGlzLnhjb2RlVmVyc2lvbi5taW5vcn1gKTtcbiAgfVxuICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7ZWx9L3NjcmVlbnNob3RgLCAnR0VUJyk7XG4gIGlmICghXy5pc1N0cmluZyhkYXRhKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBVbmFibGUgdG8gdGFrZSBhIHNjcmVlbnNob3Qgb2YgdGhlIGVsZW1lbnQgJHtlbH0uIFdEQSByZXR1cm5lZCAnJHtKU09OLnN0cmluZ2lmeShkYXRhKX0nYCk7XG4gIH1cbiAgcmV0dXJuIGRhdGE7XG59O1xuXG5jb21tYW5kcy5nZXRWaWV3cG9ydFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiBnZXRWaWV3cG9ydFNjcmVlbnNob3QgKCkge1xuICBsZXQgc3RhdHVzQmFySGVpZ2h0ID0gYXdhaXQgdGhpcy5nZXRTdGF0dXNCYXJIZWlnaHQoKTtcbiAgY29uc3Qgc2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdCgpO1xuXG4gIC8vIGlmIHdlIGRvbid0IGhhdmUgYSBzdGF0dXMgYmFyLCB0aGVyZSdzIG5vdGhpbmcgdG8gY3JvcCwgc28gd2UgY2FuIGF2b2lkXG4gIC8vIGV4dHJhIGNhbGxzIGFuZCByZXR1cm4gc3RyYWlnaHRhd2F5XG4gIGlmIChzdGF0dXNCYXJIZWlnaHQgPT09IDApIHtcbiAgICByZXR1cm4gc2NyZWVuc2hvdDtcbiAgfVxuXG4gIGNvbnN0IHNjYWxlID0gYXdhaXQgdGhpcy5nZXREZXZpY2VQaXhlbFJhdGlvKCk7XG4gIC8vIHN0YXR1cyBiYXIgaGVpZ2h0IGNvbWVzIGluIHVuc2NhbGVkLCBzbyBzY2FsZSBpdFxuICBzdGF0dXNCYXJIZWlnaHQgPSBNYXRoLnJvdW5kKHN0YXR1c0JhckhlaWdodCAqIHNjYWxlKTtcbiAgY29uc3Qgd2luZG93U2l6ZSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuICBsZXQgcmVjdCA9IHtcbiAgICBsZWZ0OiAwLFxuICAgIHRvcDogc3RhdHVzQmFySGVpZ2h0LFxuICAgIHdpZHRoOiB3aW5kb3dTaXplLndpZHRoICogc2NhbGUsXG4gICAgaGVpZ2h0OiAoKHdpbmRvd1NpemUuaGVpZ2h0ICogc2NhbGUpIC0gc3RhdHVzQmFySGVpZ2h0KVxuICB9O1xuICBsZXQgbmV3U2NyZWVuc2hvdCA9IGF3YWl0IGltYWdlVXRpbC5jcm9wQmFzZTY0SW1hZ2Uoc2NyZWVuc2hvdCwgcmVjdCk7XG4gIHJldHVybiBuZXdTY3JlZW5zaG90O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9zY3JlZW5zaG90cy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
