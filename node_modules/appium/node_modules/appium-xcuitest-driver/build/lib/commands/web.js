"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumIosDriver = require("appium-ios-driver");

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const IPHONE_TOP_BAR_HEIGHT = 71;
const IPHONE_SCROLLED_TOP_BAR_HEIGHT = 41;
const IPHONE_X_NOTCH_OFFSET = 24;
const IPHONE_LANDSCAPE_TOP_BAR_HEIGHT = 51;
const IPHONE_BOTTOM_BAR_OFFSET = 49;
const TAB_BAR_OFFSET = 33;
const IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET = 84;
const IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET = 95;
const IPHONE_X_WIDTH = 375;
const IPHONE_X_HEIGHT = 812;
const IPHONE_XR_WIDTH = 414;
const IPHONE_XR_HEIGHT = 896;
const ATOM_WAIT_TIMEOUT = 5 * 60000;
let extensions = {};
Object.assign(extensions, _appiumIosDriver.iosCommands.web);
extensions.getSafariIsIphone = _lodash.default.memoize(async function getSafariIsIphone() {
  try {
    const userAgent = await this.execute('return navigator.userAgent');
    return userAgent.toLowerCase().includes('iphone');
  } catch (err) {
    _logger.default.warn(`Unable to find device type from useragent. Assuming iPhone`);

    _logger.default.debug(`Error: ${err.message}`);
  }

  return true;
});
extensions.getSafariIsIphoneX = _lodash.default.memoize(async function getSafariIsIphone() {
  try {
    const script = 'return {height: window.screen.availHeight, width: window.screen.availWidth};';
    const {
      height,
      width
    } = await this.execute(script);
    const [portraitHeight, portraitWidth] = height > width ? [height, width] : [width, height];
    return portraitHeight === IPHONE_X_HEIGHT && portraitWidth === IPHONE_X_WIDTH || portraitHeight === IPHONE_XR_HEIGHT && portraitWidth === IPHONE_XR_WIDTH;
  } catch (err) {
    _logger.default.warn(`Unable to find device type from dimensions. Assuming not iPhone X`);

    _logger.default.debug(`Error: ${err.message}`);
  }

  return false;
});

extensions.getExtraTranslateWebCoordsOffset = async function getExtraTranslateWebCoordsOffset(wvPos, realDims) {
  let topOffset = 0;
  let bottomOffset = 0;
  const implicitWaitMs = this.implicitWaitMs;
  const isIphone = await this.getSafariIsIphone();
  const isIphoneX = isIphone && (await this.getSafariIsIphoneX());
  const orientation = realDims.h > realDims.w ? 'PORTRAIT' : 'LANDSCAPE';

  try {
    this.setImplicitWait(0);
    await this.findNativeElementOrElements('accessibility id', 'ReloadButton', false);
    topOffset = IPHONE_TOP_BAR_HEIGHT + (isIphoneX ? IPHONE_X_NOTCH_OFFSET : 0);

    if (isIphone) {
      if (orientation === 'PORTRAIT') {
        bottomOffset = IPHONE_BOTTOM_BAR_OFFSET;
      } else {
        topOffset = IPHONE_LANDSCAPE_TOP_BAR_HEIGHT;
      }
    }

    if (orientation === 'LANDSCAPE' || !isIphone) {
      try {
        await this.findNativeElementOrElements('-ios predicate string', `name LIKE '*, Tab' AND visible = 1`, false);
        topOffset += TAB_BAR_OFFSET;
      } catch (ign) {}
    }
  } catch (err) {
    topOffset = IPHONE_SCROLLED_TOP_BAR_HEIGHT + (isIphoneX ? IPHONE_X_NOTCH_OFFSET : 0);

    if (orientation === 'LANDSCAPE' && isIphone) {
      topOffset = 0;
    }
  } finally {
    this.setImplicitWait(implicitWaitMs);
  }

  topOffset += await this.getExtraNativeWebTapOffset();
  wvPos.y += topOffset;
  realDims.h -= topOffset + bottomOffset;
};

extensions.getExtraNativeWebTapOffset = async function getExtraNativeWebTapOffset() {
  let offset = 0;
  const implicitWaitMs = this.implicitWaitMs;

  try {
    this.setImplicitWait(0);

    try {
      await this.findNativeElementOrElements('accessibility id', 'Close app download offer', false);
      offset += (await this.getSafariIsIphone()) ? IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET : IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET;
    } catch (ign) {}
  } finally {
    this.setImplicitWait(implicitWaitMs);
  }

  _logger.default.debug(`Additional native web tap offset computed: ${offset}`);

  return offset;
};

async function tapWebElementNatively(driver, atomsElement) {
  try {
    let text = await driver.executeAtom('get_text', [atomsElement]);

    if (!text) {
      text = await driver.executeAtom('get_attribute_value', [atomsElement, 'value']);
    }

    if (text) {
      const els = await driver.findNativeElementOrElements('accessibility id', text, true);

      if (els.length === 1 || els.length === 2) {
        const el = els[0];
        const rect = await driver.proxyCommand(`/element/${el.ELEMENT}/rect`, 'GET');

        if (els.length === 2) {
          const el2 = els[1];
          const rect2 = await driver.proxyCommand(`/element/${el2.ELEMENT}/rect`, 'GET');

          if (rect.x !== rect2.x || rect.y !== rect2.y || rect.width !== rect2.width || rect.height !== rect2.height) {
            return false;
          }
        }

        const coords = {
          x: Math.round(rect.x + rect.width / 2),
          y: Math.round(rect.y + rect.height / 2)
        };
        await driver.clickCoords(coords);
        return true;
      }
    }
  } catch (err) {
    _logger.default.warn(`Error attempting to click: ${err.message}`);
  }

  return false;
}

extensions.nativeWebTap = async function nativeWebTap(el) {
  const atomsElement = this.useAtomsElement(el);

  if (await tapWebElementNatively(this, atomsElement)) {
    return;
  }

  _logger.default.warn('Unable to do simple native web tap. Attempting to convert coordinates');

  await this.executeAtom('get_size', [atomsElement]);
  await this.executeAtom('get_top_left_coordinates', [atomsElement]);
  const {
    width,
    height
  } = await this.executeAtom('get_size', [atomsElement]);
  let {
    x,
    y
  } = await this.executeAtom('get_top_left_coordinates', [atomsElement]);
  x += width / 2;
  y += height / 2;
  this.curWebCoords = {
    x,
    y
  };
  await this.clickWebCoords();
};

extensions.clickCoords = async function clickCoords(coords) {
  await this.performTouch([{
    action: 'tap',
    options: coords
  }]);
};

extensions.translateWebCoords = async function translateWebCoords(coords) {
  _logger.default.debug(`Translating coordinates (${JSON.stringify(coords)}) to web coordinates`);

  const implicitWaitMs = this.implicitWaitMs;
  let webview;

  try {
    this.setImplicitWait(0);
    webview = await (0, _asyncbox.retryInterval)(5, 100, async () => {
      return await this.findNativeElementOrElements('-ios predicate string', `type = 'XCUIElementTypeWebView' AND visible = 1`, false);
    });
  } finally {
    this.setImplicitWait(implicitWaitMs);
  }

  webview = _appiumSupport.util.unwrapElement(webview);
  const rect = await this.proxyCommand(`/element/${webview}/rect`, 'GET');
  const wvPos = {
    x: rect.x,
    y: rect.y
  };
  const realDims = {
    w: rect.width,
    h: rect.height
  };
  const cmd = '(function () { return {w: window.innerWidth, h: window.innerHeight}; })()';
  const wvDims = await this.remote.execute(cmd);
  await this.getExtraTranslateWebCoordsOffset(wvPos, realDims);

  if (wvDims && realDims && wvPos) {
    let xRatio = realDims.w / wvDims.w;
    let yRatio = realDims.h / wvDims.h;
    let newCoords = {
      x: wvPos.x + Math.round(xRatio * coords.x),
      y: wvPos.y + Math.round(yRatio * coords.y)
    };

    _logger.default.debug(`Converted coordinates: ${JSON.stringify(newCoords)}`);

    _logger.default.debug(`    rect: ${JSON.stringify(rect)}`);

    _logger.default.debug(`    wvPos: ${JSON.stringify(wvPos)}`);

    _logger.default.debug(`    realDims: ${JSON.stringify(realDims)}`);

    _logger.default.debug(`    wvDims: ${JSON.stringify(wvDims)}`);

    _logger.default.debug(`    xRatio: ${JSON.stringify(xRatio)}`);

    _logger.default.debug(`    yRatio: ${JSON.stringify(yRatio)}`);

    _logger.default.debug(`Converted web coords ${JSON.stringify(coords)} ` + `into real coords ${JSON.stringify(newCoords)}`);

    return newCoords;
  }
};

extensions.checkForAlert = async function checkForAlert() {
  return false;
};

extensions.waitForAtom = async function waitForAtom(promise) {
  const started = process.hrtime();

  try {
    return this.parseExecuteResponse((await _bluebird.default.resolve(promise).timeout(ATOM_WAIT_TIMEOUT)));
  } catch (err) {
    if (err instanceof _bluebird.default.TimeoutError) {
      throw new Error(`Did not get any response after ${process.hrtime(started)[0]}s`);
    }

    throw err;
  }
};

var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy93ZWIuanMiXSwibmFtZXMiOlsiSVBIT05FX1RPUF9CQVJfSEVJR0hUIiwiSVBIT05FX1NDUk9MTEVEX1RPUF9CQVJfSEVJR0hUIiwiSVBIT05FX1hfTk9UQ0hfT0ZGU0VUIiwiSVBIT05FX0xBTkRTQ0FQRV9UT1BfQkFSX0hFSUdIVCIsIklQSE9ORV9CT1RUT01fQkFSX09GRlNFVCIsIlRBQl9CQVJfT0ZGU0VUIiwiSVBIT05FX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVCIsIklQQURfV0VCX0NPT1JEX1NNQVJUX0FQUF9CQU5ORVJfT0ZGU0VUIiwiSVBIT05FX1hfV0lEVEgiLCJJUEhPTkVfWF9IRUlHSFQiLCJJUEhPTkVfWFJfV0lEVEgiLCJJUEhPTkVfWFJfSEVJR0hUIiwiQVRPTV9XQUlUX1RJTUVPVVQiLCJleHRlbnNpb25zIiwiT2JqZWN0IiwiYXNzaWduIiwiaW9zQ29tbWFuZHMiLCJ3ZWIiLCJnZXRTYWZhcmlJc0lwaG9uZSIsIl8iLCJtZW1vaXplIiwidXNlckFnZW50IiwiZXhlY3V0ZSIsInRvTG93ZXJDYXNlIiwiaW5jbHVkZXMiLCJlcnIiLCJsb2ciLCJ3YXJuIiwiZGVidWciLCJtZXNzYWdlIiwiZ2V0U2FmYXJpSXNJcGhvbmVYIiwic2NyaXB0IiwiaGVpZ2h0Iiwid2lkdGgiLCJwb3J0cmFpdEhlaWdodCIsInBvcnRyYWl0V2lkdGgiLCJnZXRFeHRyYVRyYW5zbGF0ZVdlYkNvb3Jkc09mZnNldCIsInd2UG9zIiwicmVhbERpbXMiLCJ0b3BPZmZzZXQiLCJib3R0b21PZmZzZXQiLCJpbXBsaWNpdFdhaXRNcyIsImlzSXBob25lIiwiaXNJcGhvbmVYIiwib3JpZW50YXRpb24iLCJoIiwidyIsInNldEltcGxpY2l0V2FpdCIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsImlnbiIsImdldEV4dHJhTmF0aXZlV2ViVGFwT2Zmc2V0IiwieSIsIm9mZnNldCIsInRhcFdlYkVsZW1lbnROYXRpdmVseSIsImRyaXZlciIsImF0b21zRWxlbWVudCIsInRleHQiLCJleGVjdXRlQXRvbSIsImVscyIsImxlbmd0aCIsImVsIiwicmVjdCIsInByb3h5Q29tbWFuZCIsIkVMRU1FTlQiLCJlbDIiLCJyZWN0MiIsIngiLCJjb29yZHMiLCJNYXRoIiwicm91bmQiLCJjbGlja0Nvb3JkcyIsIm5hdGl2ZVdlYlRhcCIsInVzZUF0b21zRWxlbWVudCIsImN1cldlYkNvb3JkcyIsImNsaWNrV2ViQ29vcmRzIiwicGVyZm9ybVRvdWNoIiwiYWN0aW9uIiwib3B0aW9ucyIsInRyYW5zbGF0ZVdlYkNvb3JkcyIsIkpTT04iLCJzdHJpbmdpZnkiLCJ3ZWJ2aWV3IiwidXRpbCIsInVud3JhcEVsZW1lbnQiLCJjbWQiLCJ3dkRpbXMiLCJyZW1vdGUiLCJ4UmF0aW8iLCJ5UmF0aW8iLCJuZXdDb29yZHMiLCJjaGVja0ZvckFsZXJ0Iiwid2FpdEZvckF0b20iLCJwcm9taXNlIiwic3RhcnRlZCIsInByb2Nlc3MiLCJocnRpbWUiLCJwYXJzZUV4ZWN1dGVSZXNwb25zZSIsIkIiLCJyZXNvbHZlIiwidGltZW91dCIsIlRpbWVvdXRFcnJvciIsIkVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLHFCQUFxQixHQUFHLEVBQTlCO0FBQ0EsTUFBTUMsOEJBQThCLEdBQUcsRUFBdkM7QUFDQSxNQUFNQyxxQkFBcUIsR0FBRyxFQUE5QjtBQUNBLE1BQU1DLCtCQUErQixHQUFHLEVBQXhDO0FBQ0EsTUFBTUMsd0JBQXdCLEdBQUcsRUFBakM7QUFDQSxNQUFNQyxjQUFjLEdBQUcsRUFBdkI7QUFDQSxNQUFNQyx3Q0FBd0MsR0FBRyxFQUFqRDtBQUNBLE1BQU1DLHNDQUFzQyxHQUFHLEVBQS9DO0FBRUEsTUFBTUMsY0FBYyxHQUFHLEdBQXZCO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLEdBQXhCO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLEdBQXhCO0FBQ0EsTUFB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LFdBQVgsR0FBeUIsZUFBZUEsV0FBZixDQUE0QkMsT0FBNUIsRUFBcUM7QUFDNUQsUUFBTUMsT0FBTyxHQUFHQyxPQUFPLENBQUNDLE1BQVIsRUFBaEI7O0FBQ0EsTUFBSTtBQUNGLFdBQU8sS0FBS0Msb0JBQUwsRUFBMEIsTUFBTUMsa0JBQUVDLE9BQUYsQ0FBVU4sT0FBVixFQUNwQ08sT0FEb0MsQ0FDNUJ2RixpQkFENEIsQ0FBaEMsRUFBUDtBQUVELEdBSEQsQ0FHRSxPQUFPYSxHQUFQLEVBQVk7QUFDWixRQUFJQSxHQUFHLFlBQVl3RSxrQkFBRUcsWUFBckIsRUFBbUM7QUFDakMsWUFBTSxJQUFJQyxLQUFKLENBQVcsa0NBQWlDUCxPQUFPLENBQUNDLE1BQVIsQ0FBZUYsT0FBZixFQUF3QixDQUF4QixDQUEyQixHQUF2RSxDQUFOO0FBQ0Q7O0FBQ0QsVUFBTXBFLEdBQU47QUFDRDtBQUNGLENBWEQ7O2VBYWVaLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpb3NDb21tYW5kcyB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuY29uc3QgSVBIT05FX1RPUF9CQVJfSEVJR0hUID0gNzE7XG5jb25zdCBJUEhPTkVfU0NST0xMRURfVE9QX0JBUl9IRUlHSFQgPSA0MTtcbmNvbnN0IElQSE9ORV9YX05PVENIX09GRlNFVCA9IDI0O1xuY29uc3QgSVBIT05FX0xBTkRTQ0FQRV9UT1BfQkFSX0hFSUdIVCA9IDUxO1xuY29uc3QgSVBIT05FX0JPVFRPTV9CQVJfT0ZGU0VUID0gNDk7XG5jb25zdCBUQUJfQkFSX09GRlNFVCA9IDMzO1xuY29uc3QgSVBIT05FX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVCA9IDg0O1xuY29uc3QgSVBBRF9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQgPSA5NTtcblxuY29uc3QgSVBIT05FX1hfV0lEVEggPSAzNzU7XG5jb25zdCBJUEhPTkVfWF9IRUlHSFQgPSA4MTI7XG5jb25zdCBJUEhPTkVfWFJfV0lEVEggPSA0MTQ7XG5jb25zdCBJUEhPTkVfWFJfSEVJR0hUID0gODk2O1xuXG5jb25zdCBBVE9NX1dBSVRfVElNRU9VVCA9IDUgKiA2MDAwMDtcblxubGV0IGV4dGVuc2lvbnMgPSB7fTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBpb3NDb21tYW5kcy53ZWIpO1xuXG5cblxuZXh0ZW5zaW9ucy5nZXRTYWZhcmlJc0lwaG9uZSA9IF8ubWVtb2l6ZShhc3luYyBmdW5jdGlvbiBnZXRTYWZhcmlJc0lwaG9uZSAoKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlckFnZW50ID0gYXdhaXQgdGhpcy5leGVjdXRlKCdyZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudCcpO1xuICAgIHJldHVybiB1c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnaXBob25lJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBVbmFibGUgdG8gZmluZCBkZXZpY2UgdHlwZSBmcm9tIHVzZXJhZ2VudC4gQXNzdW1pbmcgaVBob25lYCk7XG4gICAgbG9nLmRlYnVnKGBFcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICByZXR1cm4gdHJ1ZTtcbn0pO1xuXG5leHRlbnNpb25zLmdldFNhZmFyaUlzSXBob25lWCA9IF8ubWVtb2l6ZShhc3luYyBmdW5jdGlvbiBnZXRTYWZhcmlJc0lwaG9uZSAoKSB7XG4gIHRyeSB7XG4gICAgY29uc3Qgc2NyaXB0ID0gJ3JldHVybiB7aGVpZ2h0OiB3aW5kb3cuc2NyZWVuLmF2YWlsSGVpZ2h0LCB3aWR0aDogd2luZG93LnNjcmVlbi5hdmFpbFdpZHRofTsnO1xuICAgIGNvbnN0IHtoZWlnaHQsIHdpZHRofSA9IGF3YWl0IHRoaXMuZXhlY3V0ZShzY3JpcHQpO1xuICAgIC8vIGNoZWNrIGZvciB0aGUgY29ycmVjdCBoZWlnaHQgYW5kIHdpZHRoXG4gICAgY29uc3QgW3BvcnRyYWl0SGVpZ2h0LCBwb3J0cmFpdFdpZHRoXSA9IGhlaWdodCA+IHdpZHRoID8gW2hlaWdodCwgd2lkdGhdIDogW3dpZHRoLCBoZWlnaHRdO1xuICAgIHJldHVybiAocG9ydHJhaXRIZWlnaHQgPT09IElQSE9ORV9YX0hFSUdIVCAmJiBwb3J0cmFpdFdpZHRoID09PSBJUEhPTkVfWF9XSURUSCkgfHxcbiAgICAgICAgICAgKHBvcnRyYWl0SGVpZ2h0ID09PSBJUEhPTkVfWFJfSEVJR0hUICYmIHBvcnRyYWl0V2lkdGggPT09IElQSE9ORV9YUl9XSURUSCk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byBmaW5kIGRldmljZSB0eXBlIGZyb20gZGltZW5zaW9ucy4gQXNzdW1pbmcgbm90IGlQaG9uZSBYYCk7XG4gICAgbG9nLmRlYnVnKGBFcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59KTtcblxuZXh0ZW5zaW9ucy5nZXRFeHRyYVRyYW5zbGF0ZVdlYkNvb3Jkc09mZnNldCA9IGFzeW5jIGZ1bmN0aW9uIGdldEV4dHJhVHJhbnNsYXRlV2ViQ29vcmRzT2Zmc2V0ICh3dlBvcywgcmVhbERpbXMpIHtcbiAgbGV0IHRvcE9mZnNldCA9IDA7XG4gIGxldCBib3R0b21PZmZzZXQgPSAwO1xuXG4gIC8vIGtlZXAgdHJhY2sgb2YgaW1wbGljaXQgd2FpdCwgYW5kIHNldCBsb2NhbGx5IHRvIDBcbiAgY29uc3QgaW1wbGljaXRXYWl0TXMgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuXG4gIGNvbnN0IGlzSXBob25lID0gYXdhaXQgdGhpcy5nZXRTYWZhcmlJc0lwaG9uZSgpO1xuICBjb25zdCBpc0lwaG9uZVggPSBpc0lwaG9uZSAmJiBhd2FpdCB0aGlzLmdldFNhZmFyaUlzSXBob25lWCgpO1xuXG4gIGNvbnN0IG9yaWVudGF0aW9uID0gcmVhbERpbXMuaCA+IHJlYWxEaW1zLncgPyAnUE9SVFJBSVQnIDogJ0xBTkRTQ0FQRSc7XG5cbiAgdHJ5IHtcbiAgICB0aGlzLnNldEltcGxpY2l0V2FpdCgwKTtcblxuICAgIC8vIGNoZWNrIGlmIHRoZSBmdWxsIHVybCBiYXIgaXMgdXBcbiAgICBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnYWNjZXNzaWJpbGl0eSBpZCcsICdSZWxvYWRCdXR0b24nLCBmYWxzZSk7XG5cbiAgICAvLyByZWxvYWQgYnV0dG9uIGZvdW5kLCB3aGljaCBtZWFucyBzY3JvbGxpbmcgaGFzIG5vdCBoYXBwZW5lZFxuICAgIHRvcE9mZnNldCA9IElQSE9ORV9UT1BfQkFSX0hFSUdIVCArIChpc0lwaG9uZVggPyBJUEhPTkVfWF9OT1RDSF9PRkZTRVQgOiAwKTtcbiAgICBpZiAoaXNJcGhvbmUpIHtcbiAgICAgIGlmIChvcmllbnRhdGlvbiA9PT0gJ1BPUlRSQUlUJykge1xuICAgICAgICAvLyBUaGUgYm90dG9tIGJhciBpcyBvbmx5IHZpc2libGUgd2hlbiBwb3J0cmFpdFxuICAgICAgICBib3R0b21PZmZzZXQgPSBJUEhPTkVfQk9UVE9NX0JBUl9PRkZTRVQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0b3BPZmZzZXQgPSBJUEhPTkVfTEFORFNDQVBFX1RPUF9CQVJfSEVJR0hUO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAob3JpZW50YXRpb24gPT09ICdMQU5EU0NBUEUnIHx8ICFpc0lwaG9uZSkge1xuICAgICAgLy8gVGFicyBvbmx5IGFwcGVhciBpZiB0aGUgZGV2aWNlIGlzIGxhbmRzY2FwZSBvciBpZiBpdCdzIGFuIGlQYWQgc28gd2Ugb25seSBjaGVjayB2aXNpYmlsaXR5IGluIHRoaXMgY2FzZVxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJy1pb3MgcHJlZGljYXRlIHN0cmluZycsIGBuYW1lIExJS0UgJyosIFRhYicgQU5EIHZpc2libGUgPSAxYCwgZmFsc2UpO1xuICAgICAgICB0b3BPZmZzZXQgKz0gVEFCX0JBUl9PRkZTRVQ7XG4gICAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgICAgLy8gbm8gZWxlbWVudCBmb3VuZCwgc28gbm8gdGFicyBhbmQgbm8gbmVlZCB0byBkZWFsIHdpdGggb2Zmc2V0XG4gICAgICB9XG4gICAgfVxuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIG5vIHJlbG9hZCBidXR0b24sIHdoaWNoIGluZGljYXRlcyBzY3JvbGxpbmcgaGFzIGhhcHBlbmVkXG4gICAgdG9wT2Zmc2V0ID0gSVBIT05FX1NDUk9MTEVEX1RPUF9CQVJfSEVJR0hUICsgKGlzSXBob25lWCA/IElQSE9ORV9YX05PVENIX09GRlNFVCA6IDApO1xuXG4gICAgLy8gSWYgdGhlIGlQaG9uZSBpcyBsYW5kc2NhcGUgdGhlbiB0aGVyZSBpcyBub3QgdG9wIGJhclxuICAgIGlmIChvcmllbnRhdGlvbiA9PT0gJ0xBTkRTQ0FQRScgJiYgaXNJcGhvbmUpIHtcbiAgICAgIHRvcE9mZnNldCA9IDA7XG4gICAgfVxuXG4gIH0gZmluYWxseSB7XG4gICAgLy8gcmV0dXJuIGltcGxpY2l0IHdhaXQgdG8gd2hhdCBpdCB3YXNcbiAgICB0aGlzLnNldEltcGxpY2l0V2FpdChpbXBsaWNpdFdhaXRNcyk7XG4gIH1cblxuICB0b3BPZmZzZXQgKz0gYXdhaXQgdGhpcy5nZXRFeHRyYU5hdGl2ZVdlYlRhcE9mZnNldCgpO1xuXG4gIHd2UG9zLnkgKz0gdG9wT2Zmc2V0O1xuICByZWFsRGltcy5oIC09ICh0b3BPZmZzZXQgKyBib3R0b21PZmZzZXQpO1xufTtcblxuZXh0ZW5zaW9ucy5nZXRFeHRyYU5hdGl2ZVdlYlRhcE9mZnNldCA9IGFzeW5jIGZ1bmN0aW9uIGdldEV4dHJhTmF0aXZlV2ViVGFwT2Zmc2V0ICgpIHtcbiAgbGV0IG9mZnNldCA9IDA7XG5cbiAgLy8ga2VlcCB0cmFjayBvZiBpbXBsaWNpdCB3YWl0LCBhbmQgc2V0IGxvY2FsbHkgdG8gMFxuICBjb25zdCBpbXBsaWNpdFdhaXRNcyA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG4gIHRyeSB7XG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoMCk7XG5cbiAgICAvLyB0cnkgdG8gc2VlIGlmIHRoZXJlIGlzIGFuIFNtYXJ0IEFwcCBCYW5uZXJcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2FjY2Vzc2liaWxpdHkgaWQnLCAnQ2xvc2UgYXBwIGRvd25sb2FkIG9mZmVyJywgZmFsc2UpO1xuICAgICAgb2Zmc2V0ICs9IGF3YWl0IHRoaXMuZ2V0U2FmYXJpSXNJcGhvbmUoKSA/XG4gICAgICAgIElQSE9ORV9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQgOlxuICAgICAgICBJUEFEX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVDtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIG5vIHNtYXJ0IGFwcCBiYW5uZXIgZm91bmQsIHNvIGNvbnRpbnVlXG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIC8vIHJldHVybiBpbXBsaWNpdCB3YWl0IHRvIHdoYXQgaXQgd2FzXG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoaW1wbGljaXRXYWl0TXMpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBBZGRpdGlvbmFsIG5hdGl2ZSB3ZWIgdGFwIG9mZnNldCBjb21wdXRlZDogJHtvZmZzZXR9YCk7XG4gIHJldHVybiBvZmZzZXQ7XG59O1xuXG5hc3luYyBmdW5jdGlvbiB0YXBXZWJFbGVtZW50TmF0aXZlbHkgKGRyaXZlciwgYXRvbXNFbGVtZW50KSB7XG4gIC8vIHRyeSB0byBnZXQgdGhlIHRleHQgb2YgdGhlIGVsZW1lbnQsIHdoaWNoIHdpbGwgYmUgYWNjZXNzaWJsZSBpbiB0aGVcbiAgLy8gbmF0aXZlIGNvbnRleHRcbiAgdHJ5IHtcbiAgICBsZXQgdGV4dCA9IGF3YWl0IGRyaXZlci5leGVjdXRlQXRvbSgnZ2V0X3RleHQnLCBbYXRvbXNFbGVtZW50XSk7XG4gICAgaWYgKCF0ZXh0KSB7XG4gICAgICB0ZXh0ID0gYXdhaXQgZHJpdmVyLmV4ZWN1dGVBdG9tKCdnZXRfYXR0cmlidXRlX3ZhbHVlJywgW2F0b21zRWxlbWVudCwgJ3ZhbHVlJ10pO1xuICAgIH1cblxuICAgIGlmICh0ZXh0KSB7XG4gICAgICBjb25zdCBlbHMgPSBhd2FpdCBkcml2ZXIuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdhY2Nlc3NpYmlsaXR5IGlkJywgdGV4dCwgdHJ1ZSk7XG4gICAgICBpZiAoZWxzLmxlbmd0aCA9PT0gMSB8fCBlbHMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgIGNvbnN0IGVsID0gZWxzWzBdO1xuICAgICAgICAvLyB1c2UgdGFwIGJlY2F1c2Ugb24gaU9TIDExLjIgYW5kIGJlbG93IGBuYXRpdmVDbGlja2AgY3Jhc2hlcyBXREFcbiAgICAgICAgY29uc3QgcmVjdCA9IGF3YWl0IGRyaXZlci5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7ZWwuRUxFTUVOVH0vcmVjdGAsICdHRVQnKTtcbiAgICAgICAgaWYgKGVscy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICBjb25zdCBlbDIgPSBlbHNbMV07XG4gICAgICAgICAgY29uc3QgcmVjdDIgPSBhd2FpdCBkcml2ZXIucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2VsMi5FTEVNRU5UfS9yZWN0YCwgJ0dFVCcpO1xuXG4gICAgICAgICAgaWYgKChyZWN0LnggIT09IHJlY3QyLnggfHwgcmVjdC55ICE9PSByZWN0Mi55KSB8fFxuICAgICAgICAgIChyZWN0LndpZHRoICE9PSByZWN0Mi53aWR0aCB8fCByZWN0LmhlaWdodCAhPT0gcmVjdDIuaGVpZ2h0KSkge1xuICAgICAgICAgICAgLy8gVGhlc2UgMiBuYXRpdmUgZWxlbWVudHMgYXJlIG5vdCByZWZlcnJpbmcgdG8gdGhlIHNhbWUgd2ViIGVsZW1lbnRcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY29vcmRzID0ge1xuICAgICAgICAgIHg6IE1hdGgucm91bmQocmVjdC54ICsgcmVjdC53aWR0aCAvIDIpLFxuICAgICAgICAgIHk6IE1hdGgucm91bmQocmVjdC55ICsgcmVjdC5oZWlnaHQgLyAyKSxcbiAgICAgICAgfTtcbiAgICAgICAgYXdhaXQgZHJpdmVyLmNsaWNrQ29vcmRzKGNvb3Jkcyk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gYW55IGZhaWx1cmUgc2hvdWxkIGZhbGwgdGhyb3VnaCBhbmQgdHJpZ2dlciB0aGUgbW9yZSBlbGFib3JhdGVcbiAgICAvLyBtZXRob2Qgb2YgY2xpY2tpbmdcbiAgICBsb2cud2FybihgRXJyb3IgYXR0ZW1wdGluZyB0byBjbGljazogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmV4dGVuc2lvbnMubmF0aXZlV2ViVGFwID0gYXN5bmMgZnVuY3Rpb24gbmF0aXZlV2ViVGFwIChlbCkge1xuICBjb25zdCBhdG9tc0VsZW1lbnQgPSB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG5cbiAgaWYgKGF3YWl0IHRhcFdlYkVsZW1lbnROYXRpdmVseSh0aGlzLCBhdG9tc0VsZW1lbnQpKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxvZy53YXJuKCdVbmFibGUgdG8gZG8gc2ltcGxlIG5hdGl2ZSB3ZWIgdGFwLiBBdHRlbXB0aW5nIHRvIGNvbnZlcnQgY29vcmRpbmF0ZXMnKTtcblxuICAvLyBgZ2V0X3RvcF9sZWZ0X2Nvb3JkaW5hdGVzYCByZXR1cm5zIHRoZSB3cm9uZyB2YWx1ZSBzb21ldGltZXMsXG4gIC8vIHVubGVzcyB3ZSBwcmUtY2FsbCBib3RoIG9mIHRoZXNlIGZ1bmN0aW9ucyBiZWZvcmUgdGhlIGFjdHVhbCBjYWxsc1xuICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfc2l6ZScsIFthdG9tc0VsZW1lbnRdKTtcbiAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3RvcF9sZWZ0X2Nvb3JkaW5hdGVzJywgW2F0b21zRWxlbWVudF0pO1xuXG4gIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF9zaXplJywgW2F0b21zRWxlbWVudF0pO1xuICBsZXQge3gsIHl9ID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3RvcF9sZWZ0X2Nvb3JkaW5hdGVzJywgW2F0b21zRWxlbWVudF0pO1xuICB4ICs9IHdpZHRoIC8gMjtcbiAgeSArPSBoZWlnaHQgLyAyO1xuXG4gIHRoaXMuY3VyV2ViQ29vcmRzID0ge3gsIHl9O1xuICBhd2FpdCB0aGlzLmNsaWNrV2ViQ29vcmRzKCk7XG59O1xuXG5leHRlbnNpb25zLmNsaWNrQ29vcmRzID0gYXN5bmMgZnVuY3Rpb24gY2xpY2tDb29yZHMgKGNvb3Jkcykge1xuICBhd2FpdCB0aGlzLnBlcmZvcm1Ub3VjaChbXG4gICAge1xuICAgICAgYWN0aW9uOiAndGFwJyxcbiAgICAgIG9wdGlvbnM6IGNvb3JkcyxcbiAgICB9LFxuICBdKTtcbn07XG5cbmV4dGVuc2lvbnMudHJhbnNsYXRlV2ViQ29vcmRzID0gYXN5bmMgZnVuY3Rpb24gdHJhbnNsYXRlV2ViQ29vcmRzIChjb29yZHMpIHtcbiAgbG9nLmRlYnVnKGBUcmFuc2xhdGluZyBjb29yZGluYXRlcyAoJHtKU09OLnN0cmluZ2lmeShjb29yZHMpfSkgdG8gd2ViIGNvb3JkaW5hdGVzYCk7XG5cbiAgLy8gYWJzb2x1dGl6ZSB3ZWIgY29vcmRzXG4gIGNvbnN0IGltcGxpY2l0V2FpdE1zID0gdGhpcy5pbXBsaWNpdFdhaXRNcztcbiAgbGV0IHdlYnZpZXc7XG4gIHRyeSB7XG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoMCk7XG4gICAgd2VidmlldyA9IGF3YWl0IHJldHJ5SW50ZXJ2YWwoNSwgMTAwLCBhc3luYyAoKSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJy1pb3MgcHJlZGljYXRlIHN0cmluZycsIGB0eXBlID0gJ1hDVUlFbGVtZW50VHlwZVdlYlZpZXcnIEFORCB2aXNpYmxlID0gMWAsIGZhbHNlKTtcbiAgICB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICB0aGlzLnNldEltcGxpY2l0V2FpdChpbXBsaWNpdFdhaXRNcyk7XG4gIH1cblxuICB3ZWJ2aWV3ID0gdXRpbC51bndyYXBFbGVtZW50KHdlYnZpZXcpO1xuICBjb25zdCByZWN0ID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7d2Vidmlld30vcmVjdGAsICdHRVQnKTtcbiAgY29uc3Qgd3ZQb3MgPSB7eDogcmVjdC54LCB5OiByZWN0Lnl9O1xuICBjb25zdCByZWFsRGltcyA9IHt3OiByZWN0LndpZHRoLCBoOiByZWN0LmhlaWdodH07XG5cbiAgY29uc3QgY21kID0gJyhmdW5jdGlvbiAoKSB7IHJldHVybiB7dzogd2luZG93LmlubmVyV2lkdGgsIGg6IHdpbmRvdy5pbm5lckhlaWdodH07IH0pKCknO1xuICBjb25zdCB3dkRpbXMgPSBhd2FpdCB0aGlzLnJlbW90ZS5leGVjdXRlKGNtZCk7XG5cbiAgYXdhaXQgdGhpcy5nZXRFeHRyYVRyYW5zbGF0ZVdlYkNvb3Jkc09mZnNldCh3dlBvcywgcmVhbERpbXMpO1xuXG4gIGlmICh3dkRpbXMgJiYgcmVhbERpbXMgJiYgd3ZQb3MpIHtcbiAgICBsZXQgeFJhdGlvID0gcmVhbERpbXMudyAvIHd2RGltcy53O1xuICAgIGxldCB5UmF0aW8gPSByZWFsRGltcy5oIC8gd3ZEaW1zLmg7XG4gICAgbGV0IG5ld0Nvb3JkcyA9IHtcbiAgICAgIHg6IHd2UG9zLnggKyBNYXRoLnJvdW5kKHhSYXRpbyAqIGNvb3Jkcy54KSxcbiAgICAgIHk6IHd2UG9zLnkgKyBNYXRoLnJvdW5kKHlSYXRpbyAqIGNvb3Jkcy55KSxcbiAgICB9O1xuXG4gICAgLy8gYWRkaXRpb25hbCBsb2dnaW5nIGZvciBjb29yZGluYXRlcywgc2luY2UgaXQgaXMgc29tZXRpbWVzIGJyb2tlblxuICAgIC8vICAgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy85MTU5XG4gICAgbG9nLmRlYnVnKGBDb252ZXJ0ZWQgY29vcmRpbmF0ZXM6ICR7SlNPTi5zdHJpbmdpZnkobmV3Q29vcmRzKX1gKTtcbiAgICBsb2cuZGVidWcoYCAgICByZWN0OiAke0pTT04uc3RyaW5naWZ5KHJlY3QpfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHd2UG9zOiAke0pTT04uc3RyaW5naWZ5KHd2UG9zKX1gKTtcbiAgICBsb2cuZGVidWcoYCAgICByZWFsRGltczogJHtKU09OLnN0cmluZ2lmeShyZWFsRGltcyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgd3ZEaW1zOiAke0pTT04uc3RyaW5naWZ5KHd2RGltcyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgeFJhdGlvOiAke0pTT04uc3RyaW5naWZ5KHhSYXRpbyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgeVJhdGlvOiAke0pTT04uc3RyaW5naWZ5KHlSYXRpbyl9YCk7XG5cbiAgICBsb2cuZGVidWcoYENvbnZlcnRlZCB3ZWIgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkoY29vcmRzKX0gYCArXG4gICAgICAgICAgICAgIGBpbnRvIHJlYWwgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkobmV3Q29vcmRzKX1gKTtcbiAgICByZXR1cm4gbmV3Q29vcmRzO1xuICB9XG59O1xuXG5leHRlbnNpb25zLmNoZWNrRm9yQWxlcnQgPSBhc3luYyBmdW5jdGlvbiBjaGVja0ZvckFsZXJ0ICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIHJldHVybiBmYWxzZTtcbn07XG5cbmV4dGVuc2lvbnMud2FpdEZvckF0b20gPSBhc3luYyBmdW5jdGlvbiB3YWl0Rm9yQXRvbSAocHJvbWlzZSkge1xuICBjb25zdCBzdGFydGVkID0gcHJvY2Vzcy5ocnRpbWUoKTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gdGhpcy5wYXJzZUV4ZWN1dGVSZXNwb25zZShhd2FpdCBCLnJlc29sdmUocHJvbWlzZSlcbiAgICAgIC50aW1lb3V0KEFUT01fV0FJVF9USU1FT1VUKSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIgaW5zdGFuY2VvZiBCLlRpbWVvdXRFcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBEaWQgbm90IGdldCBhbnkgcmVzcG9uc2UgYWZ0ZXIgJHtwcm9jZXNzLmhydGltZShzdGFydGVkKVswXX1zYCk7XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3dlYi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
