"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumSupport = require("appium-support");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("../logger"));

let commands = {},
    extensions = {};
exports.commands = commands;
Object.assign(extensions, _appiumIosDriver.iosCommands.element);

commands.getNativeAttribute = async function getNativeAttribute(attribute, el) {
  if (attribute === 'contentSize') {
    return await this.getContentSize(el);
  }

  let value = await this.proxyCommand(`/element/${el}/attribute/${attribute}`, 'GET');

  if ([0, 1].includes(value)) {
    value = !!value;
  }

  return _lodash.default.isNull(value) || _lodash.default.isString(value) ? value : JSON.stringify(value);
};

commands.getAttribute = async function getAttribute(attribute, el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (!this.isWebContext()) {
    return await this.getNativeAttribute(attribute, el);
  }

  const atomsElement = this.getAtomsElement(el);

  if (_lodash.default.isNull(atomsElement)) {
    throw new _appiumBaseDriver.errors.UnknownError(`Error converting element ID for using in WD atoms: '${el}`);
  }

  return await this.executeAtom('get_attribute_value', [atomsElement, attribute]);
};

commands.getText = async function getText(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (!this.isWebContext()) {
    return await this.proxyCommand(`/element/${el}/text`, 'GET');
  }

  let atomsElement = this.useAtomsElement(el);
  return await this.executeAtom('get_text', [atomsElement]);
};

commands.getElementRect = async function getElementRect(el) {
  if (this.isWebContext()) {
    const {
      x,
      y
    } = await this.getLocation(el);
    const {
      width,
      height
    } = await this.getSize(el);
    return {
      x,
      y,
      width,
      height
    };
  }

  el = _appiumSupport.util.unwrapElement(el);
  return await this.getNativeRect(el);
};

extensions.getNativeRect = async function getNativeRect(el) {
  return await this.proxyCommand(`/element/${el}/rect`, 'GET');
};

commands.getLocation = async function getLocation(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    const atomsElement = await this.useAtomsElement(el);
    let loc = await this.executeAtom('get_top_left_coordinates', [atomsElement]);

    if (this.opts.absoluteWebLocations) {
      const script = 'return [document.body.scrollLeft, document.body.scrollTop];';
      const [xOffset, yOffset] = await this.execute(script);
      loc.x += xOffset;
      loc.y += yOffset;
    }

    return loc;
  }

  const rect = await this.getElementRect(el);
  return {
    x: rect.x,
    y: rect.y
  };
};

commands.getLocationInView = async function getLocationInView(el) {
  return await this.getLocation(el);
};

commands.getSize = async function getSize(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    let atomsElement = this.getAtomsElement(el);

    if (atomsElement === null) {
      throw new _appiumBaseDriver.errors.UnknownError(`Error converting element ID for using in WD atoms: '${el}'`);
    }

    return await this.executeAtom('get_size', [atomsElement]);
  }

  const rect = await this.getElementRect(el);
  return {
    width: rect.width,
    height: rect.height
  };
};

function hasSpecialKeys(keys) {
  for (let char of keys) {
    if (isSpecialKey(char)) {
      return true;
    }
  }

  return false;
}

function isSpecialKey(k) {
  if (k === '\uE003' || k === '\ue017') {
    return true;
  } else if (k === '\uE006' || k === '\uE007') {
    return true;
  }

  return false;
}

function translateKey(k) {
  if (k === '\uE006' || k === '\uE007') {
    return '\n';
  } else if (k === '\uE003' || k === '\ue017') {
    return '\b';
  }

  return k;
}

extensions.bringUpKeyboard = async function bringUpKeyboard(element) {
  let implicitWaitMs = this.implicitWaitMs;
  await this.setImplicitWait(0);

  try {
    await (0, _asyncbox.retryInterval)(10, 10, async () => {
      try {
        await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);

        _logger.default.debug('Keyboard found. Continuing with text input.');
      } catch (err) {
        _logger.default.debug('No keyboard found. Clicking element to open it.');

        await this.nativeClick(element);
        await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);
      }
    });
  } finally {
    await this.setImplicitWait(implicitWaitMs);
  }
};

commands.setValueImmediate = async function setValueImmediate(value, el) {
  _logger.default.info('There is currently no way to bypass typing using XCUITest. Setting value through keyboard');

  await this.setValue(value, el);
};

commands.setValue = async function setValue(value, el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    let atomsElement = this.useAtomsElement(el);
    await this.executeAtom('click', [atomsElement]);
    await this.executeAtom('type', [atomsElement, value]);
  } else {
    const setFormattedValue = async (input, isKeyboardPresenceCheckEnabled) => {
      if (typeof input !== 'string' && !(input instanceof Array)) {
        input = input.toString().split('');
      }

      try {
        await this.proxyCommand(`/element/${el}/value`, 'POST', {
          value: input
        });
      } catch (err) {
        if (isKeyboardPresenceCheckEnabled && (await this.getAttribute('type', el)) === 'XCUIElementTypeTextField') {
          _logger.default.info(`Cannot type in the text field because of ${err}.\nTrying to apply a workaround...`);

          await this.bringUpKeyboard(el);
          await this.proxyCommand(`/element/${el}/value`, 'POST', {
            value: input
          });
        } else {
          throw err;
        }
      }
    };

    if (_lodash.default.isNull(value) || _lodash.default.isUndefined(value) || _lodash.default.isPlainObject(value)) {
      throw new Error(`Only strings and arrays of strings are supported as input arguments. Received: '${JSON.stringify(value)}'`);
    }

    if (_lodash.default.isArray(value)) {
      value = _lodash.default.flatMap(value, v => (_lodash.default.isString(v) ? v : JSON.stringify(v)).split(''));
    } else {
      value = (value || '').toString().split('');
    }

    if (!hasSpecialKeys(value)) {
      await setFormattedValue(value, true);
      return;
    }

    let buffer = [];
    let isFirstChar = true;

    for (let k of value) {
      let char = translateKey(k);

      if (char === k) {
        buffer.push(char);
        continue;
      }

      await setFormattedValue(buffer, isFirstChar);
      isFirstChar = false;
      buffer = [];
      await setFormattedValue([char], isFirstChar);
    }

    if (buffer.length) {
      await setFormattedValue(buffer, false);
    }
  }
};

commands.keys = async function keys(value) {
  if (_lodash.default.isArray(value)) {
    value = value.join('');
  }

  if (_lodash.default.isString(value)) {
    value = value.split('');
  }

  let buffer = [];

  for (let k of value) {
    let char = translateKey(k);
    buffer.push(char);
  }

  await this.proxyCommand('/wda/keys', 'POST', {
    value: buffer
  });
};

commands.clear = async function clear(el) {
  el = _appiumSupport.util.unwrapElement(el);

  if (this.isWebContext()) {
    let atomsElement = this.useAtomsElement(el);
    await this.executeAtom('clear', [atomsElement]);
    return;
  }

  await (0, _asyncbox.retry)(5, this.proxyCommand.bind(this), `/element/${el}/clear`, 'POST');
};

commands.getContentSize = async function getContentSize(el) {
  if (this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotYetImplementedError('Support for getContentSize for webcontext is not yet implemented. Please contact an Appium dev');
  }

  const type = await this.getAttribute('type', el);

  if (type !== 'XCUIElementTypeTable' && type !== 'XCUIElementTypeCollectionView') {
    throw new Error(`Can't get content size for type '${type}', only for ` + `tables and collection views`);
  }

  let locator = '*';

  if (type === 'XCUIElementTypeTable') {
    locator = 'XCUIElementTypeCell';
  }

  let contentHeight = 0;
  let children = await this.findElOrEls(`class chain`, locator, true, el);

  if (children.length === 1) {
    const rect = await this.getElementRect(_lodash.default.head(children));
    contentHeight = rect.height;
  } else if (children.length) {
    switch (type) {
      case 'XCUIElementTypeTable':
        {
          const firstRect = await this.getElementRect(_lodash.default.head(children));
          const lastRect = await this.getElementRect(_lodash.default.last(children));
          contentHeight = lastRect.y + lastRect.height - firstRect.y;
          break;
        }

      case 'XCUIElementTypeCollectionView':
        {
          let elsInRow = 1;
          let firstRect = await this.getElementRect(_lodash.default.head(children));
          let initialRects = [firstRect];

          for (let i = 1; i < children.length; i++) {
            const rect = await this.getElementRect(children[i]);
            initialRects.push(rect);

            if (rect.y !== firstRect.y) {
              elsInRow = i;
              break;
            }
          }

          const spaceBetweenEls = initialRects[elsInRow].y - initialRects[elsInRow - 1].y - initialRects[elsInRow - 1].height;
          const numRows = Math.ceil(children.length / elsInRow);
          contentHeight = numRows * firstRect.height + spaceBetweenEls * (numRows - 1);
          break;
        }

      default:
        throw new Error(`Programming error: type '${type}' was not ` + `valid but should have already been rejected`);
    }
  }

  const size = await this.getSize(el);
  const origin = await this.getLocationInView(el);
  return JSON.stringify({
    width: size.width,
    height: size.height,
    top: origin.y,
    left: origin.x,
    scrollableOffset: contentHeight
  });
};

commands.isKeyboardShown = async function isKeyboardShown() {
  try {
    await this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false);
    return true;
  } catch (ign) {
    return false;
  }
};

Object.assign(extensions, commands);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9lbGVtZW50LmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiZXh0ZW5zaW9ucyIsIk9iamVjdCIsImFzc2lnbiIsImlvc0NvbW1hbmRzIiwiZWxlbWVudCIsImdldE5hdGl2ZUF0dHJpYnV0ZSIsImF0dHJpYnV0ZSIsImVsIiwiZ2V0Q29udGVudFNpemUiLCJ2YWx1ZSIsInByb3h5Q29tbWFuZCIsImluY2x1ZGVzIiwiXyIsImlzTnVsbCIsImlzU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsImdldEF0dHJpYnV0ZSIsInV0aWwiLCJ1bndyYXBFbGVtZW50IiwiaXNXZWJDb250ZXh0IiwiYXRvbXNFbGVtZW50IiwiZ2V0QXRvbXNFbGVtZW50IiwiZXJyb3JzIiwiVW5rbm93bkVycm9yIiwiZXhlY3V0ZUF0b20iLCJnZXRUZXh0IiwidXNlQXRvbXNFbGVtZW50IiwiZ2V0RWxlbWVudFJlY3QiLCJ4IiwieSIsImdldExvY2F0aW9uIiwid2lkdGgiLCJoZWlnaHQiLCJnZXRTaXplIiwiZ2V0TmF0aXZlUmVjdCIsImxvYyIsIm9wdHMiLCJhYnNvbHV0ZVdlYkxvY2F0aW9ucyIsInNjcmlwdCIsInhPZmZzZXQiLCJ5T2Zmc2V0IiwiZXhlY3V0ZSIsInJlY3QiLCJnZXRMb2NhdGlvbkluVmlldyIsImhhc1NwZWNpYWxLZXlzIiwia2V5cyIsImNoYXIiLCJpc1NwZWNpYWxLZXkiLCJrIiwidHJhbnNsYXRlS2V5IiwiYnJpbmdVcEtleWJvYXJkIiwiaW1wbGljaXRXYWl0TXMiLCJzZXRJbXBsaWNpdFdhaXQiLCJmaW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMiLCJsb2ciLCJkZWJ1ZyIsImVyciIsIm5hdGl2ZUNsaWNrIiwic2V0VmFsdWVJbW1lZGlhdGUiLCJpbmZvIiwic2V0VmFsdWUiLCJzZXRGb3JtYXR0ZWRWYWx1ZSIsImlucHV0IiwiaXNLZXlib2FyZFByZXNlbmNlQ2hlY2tFbmFibGVkIiwiQXJyYXkiLCJ0b1N0cmluZyIsInNwbGl0IiwiaXNVbmRlZmluZWQiLCJpc1BsYWluT2JqZWN0IiwiRXJyb3IiLCJpc0FycmF5IiwiZmxhdE1hcCIsInYiLCJidWZmZXIiLCJpc0ZpcnN0Q2hhciIsInB1c2giLCJsZW5ndGgiLCJqb2luIiwiY2xlYXIiLCJiaW5kIiwiTm90WWV0SW1wbGVtZW50ZWRFcnJvciIsInR5cGUiLCJsb2NhdG9yIiwiY29udGVudEhlaWdodCIsImNoaWxkcmVuIiwiZmluZEVsT3JFbHMiLCJoZWFkIiwiZmlyc3RSZWN0IiwibGFzdFJlY3QiLCJsYXN0IiwiZWxzSW5Sb3ciLCJpbml0aWFsUmVjdHMiLCJpIiwic3BhY2VCZXR3ZWVuRWxzIiwibnVtUm93cyIsIk1hdGgiLCJjZWlsIiwic2l6ZSIsIm9yaWdpbiIsInRvcCIsImxlZnQiLCJzY3JvbGxhYmxlT2Zmc2V0IiwiaXNLZXlib2FyZFNob3duIiwiaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLFVBQVUsR0FBRyxFQUFoQzs7QUFJQUMsTUFBTSxDQUFDQyxNQUFQLENBQWNGLFVBQWQsRUFBMEJHLDZCQUFZQyxPQUF0Qzs7QUFFQUwsUUFBUSxDQUFDTSxrQkFBVCxHQUE4QixlQUFlQSxrQkFBZixDQUFtQ0MsU0FBbkMsRUFBOENDLEVBQTlDLEVBQWtEO0FBQzlFLE1BQUlELFNBQVMsS0FBSyxhQUFsQixFQUFpQztBQUUvQixXQUFPLE1BQU0sS0FBS0UsY0FBTCxDQUFvQkQsRUFBcEIsQ0FBYjtBQUNEOztBQUdELE1BQUlFLEtBQUssR0FBRyxNQUFNLEtBQUtDLFlBQUwsQ0FBbUIsWUFBV0gsRUFBRyxjQUFhRCxTQUFVLEVBQXhELEVBQTJELEtBQTNELENBQWxCOztBQUVBLE1BQUksQ0FBQyxDQUFELEVBQUksQ0FBSixFQUFPSyxRQUFQLENBQWdCRixLQUFoQixDQUFKLEVBQTRCO0FBQzFCQSxJQUFBQSxLQUFLLEdBQUcsQ0FBQyxDQUFDQSxLQUFWO0FBQ0Q7O0FBRUQsU0FBUUcsZ0JBQUVDLE1BQUYsQ0FBU0osS0FBVCxLQUFtQkcsZ0JBQUVFLFFBQUYsQ0FBV0wsS0FBWCxDQUFwQixHQUF5Q0EsS0FBekMsR0FBaURNLElBQUksQ0FBQ0MsU0FBTCxDQUFlUCxLQUFmLENBQXhEO0FBQ0QsQ0FkRDs7QUFnQkFWLFFBQVEsQ0FBQ2tCLFlBQVQsR0FBd0IsZUFBZUEsWUFBZixDQUE2QlgsU0FBN0IsRUFBd0NDLEVBQXhDLEVBQTRDO0FBQ2xFQSxFQUFBQSxFQUFFLEdBQUdXLG9CQUFLQyxhQUFMLENBQW1CWixFQUFuQixDQUFMOztBQUNBLE1BQUksQ0FBQyxLQUFLYSxZQUFMLEVBQUwsRUFBMEI7QUFDeEIsV0FBTyxNQUFNLEtBQUtmLGtCQUFMLENBQXdCQyxTQUF4QixFQUFtQ0MsRUFBbkMsQ0FBYjtBQUNEOztBQUNELFFBQU1jLFlBQVksR0FBRyxLQUFLQyxlQUFMLENBQXFCZixFQUFyQixDQUFyQjs7QUFDQSxNQUFJSyxnQkFBRUMsTUFBRixDQUFTUSxZQUFULENBQUosRUFBNEI7QUFDMUIsVUFBTSxJQUFJRSx5QkFBT0MsWUFBWCxDQUF5Qix1REFBc0RqQixFQUFHLEVBQWxGLENBQU47QUFDRDs7QUFDRCxTQUFPLE1BQU0sS0FBS2tCLFdBQUwsQ0FBaUIscUJBQWpCLEVBQXdDLENBQUNKLFlBQUQsRUFBZWYsU0FBZixDQUF4QyxDQUFiO0FBQ0QsQ0FWRDs7QUFZQVAsUUFBUSxDQUFDMkIsT0FBVCxHQUFtQixlQUFlQSxPQUFmLENBQXdCbkIsRUFBeEIsRUFBNEI7QUFDN0NBLEVBQUFBLEVBQUUsR0FBR1csb0JBQUtDLGFBQUwsQ0FBbUJaLEVBQW5CLENBQUw7O0FBQ0EsTUFBSSxDQUFDLEtBQUthLFlBQUwsRUFBTCxFQUEwQjtBQUN4QixXQUFPLE1BQU0sS0FBS1YsWUFBTCxDQUFtQixZQUFXSCxFQUFHLE9BQWpDLEVBQXlDLEtBQXpDLENBQWI7QUFDRDs7QUFDRCxNQUFJYyxZQUFZLEdBQUcsS0FBS00sZUFBTCxDQUFxQnBCLEVBQXJCLENBQW5CO0FBQ0EsU0FBTyxNQUFNLEtBQUtrQixXQUFMLENBQWlCLFVBQWpCLEVBQTZCLENBQUNKLFlBQUQsQ0FBN0IsQ0FBYjtBQUNELENBUEQ7O0FBU0F0QixRQUFRLENBQUM2QixjQUFULEdBQTBCLGVBQWVBLGNBQWYsQ0FBK0JyQixFQUEvQixFQUFtQztBQUMzRCxNQUFJLEtBQUthLFlBQUwsRUFBSixFQUF5QjtBQUV2QixVQUFNO0FBQUNTLE1BQUFBLENBQUQ7QUFBSUMsTUFBQUE7QUFBSixRQUFTLE1BQU0sS0FBS0MsV0FBTCxDQUFpQnhCLEVBQWpCLENBQXJCO0FBQ0EsVUFBTTtBQUFDeUIsTUFBQUEsS0FBRDtBQUFRQyxNQUFBQTtBQUFSLFFBQWtCLE1BQU0sS0FBS0MsT0FBTCxDQUFhM0IsRUFBYixDQUE5QjtBQUNBLFdBQU87QUFBQ3NCLE1BQUFBLENBQUQ7QUFBSUMsTUFBQUEsQ0FBSjtBQUFPRSxNQUFBQSxLQUFQO0FBQWNDLE1BQUFBO0FBQWQsS0FBUDtBQUNEOztBQUVEMUIsRUFBQUEsRUFBRSxHQUFHVyxvQkFBS0MsYUFBTCxDQUFtQlosRUFBbkIsQ0FBTDtBQUNBLFNBQU8sTUFBTSxLQUFLNEIsYUFBTCxDQUFtQjVCLEVBQW5CLENBQWI7QUFDRCxDQVZEOztBQVlBUCxVQUFVLENBQUNtQyxhQUFYLEdBQTJCLGVBQWVBLGFBQWYsQ0FBOEI1QixFQUE5QixFQUFrQztBQUMzRCxTQUFPLE1BQU0sS0FBS0csWUFBTCxDQUFtQixZQUFXSCxFQUFHLE9BQWpDLEVBQXlDLEtBQXpDLENBQWI7QUFDRCxDQUZEOztBQUlBUixRQUFRLENBQUNnQyxXQUFULEdBQXVCLGVBQWVBLFdBQWYsQ0FBNEJ4QixFQUE1QixFQUFnQztBQUNyREEsRUFBQUEsRUFBRSxHQUFHVyxvQkFBS0MsYUFBTCxDQUFtQlosRUFBbkIsQ0FBTDs7QUFDQSxNQUFJLEtBQUthLFlBQUwsRUFBSixFQUF5QjtBQUN2QixVQUFNQyxZQUFZLEdBQUcsTUFBTSxLQUFLTSxlQUFMLENBQXFCcEIsRUFBckIsQ0FBM0I7QUFDQSxRQUFJNkIsR0FBRyxHQUFHLE1BQU0sS0FBS1gsV0FBTCxDQUFpQiwwQkFBakIsRUFBNkMsQ0FBQ0osWUFBRCxDQUE3QyxDQUFoQjs7QUFDQSxRQUFJLEtBQUtnQixJQUFMLENBQVVDLG9CQUFkLEVBQW9DO0FBQ2xDLFlBQU1DLE1BQU0sR0FBRyw2REFBZjtBQUNBLFlBQU0sQ0FBQ0MsT0FBRCxFQUFVQyxPQUFWLElBQXFCLE1BQU0sS0FBS0MsT0FBTCxDQUFhSCxNQUFiLENBQWpDO0FBQ0FILE1BQUFBLEdBQUcsQ0FBQ1AsQ0FBSixJQUFTVyxPQUFUO0FBQ0FKLE1BQUFBLEdBQUcsQ0FBQ04sQ0FBSixJQUFTVyxPQUFUO0FBQ0Q7O0FBQ0QsV0FBT0wsR0FBUDtBQUNEOztBQUVELFFBQU1PLElBQUksR0FBRyxNQUFNLEtBQUtmLGNBQUwsQ0FBb0JyQixFQUFwQixDQUFuQjtBQUNBLFNBQU87QUFBQ3NCLElBQUFBLENBQUMsRUFBRWMsSUFBSSxDQUFDZCxDQUFUO0FBQVlDLElBQUFBLENBQUMsRUFBRWEsSUFBSSxDQUFDYjtBQUFwQixHQUFQO0FBQ0QsQ0FoQkQ7O0FBa0JBL0IsUUFBUSxDQUFDNkMsaUJBQVQsR0FBNkIsZUFBZUEsaUJBQWYsQ0FBa0NyQyxFQUFsQyxFQUFzQztBQUNqRSxTQUFPLE1BQU0sS0FBS3dCLFdBQUwsQ0FBaUJ4QixFQUFqQixDQUFiO0FBQ0QsQ0FGRDs7QUFJQVIsUUFBUSxDQUFDbUMsT0FBVCxHQUFtQixlQUFlQSxPQUFmLENBQXdCM0IsRUFBeEIsRUFBNEI7QUFDN0NBLEVBQUFBLEVBQUUsR0FBR1csb0JBQUtDLGFBQUwsQ0FBbUJaLEVBQW5CLENBQUw7O0FBQ0EsTUFBSSxLQUFLYSxZQUFMLEVBQUosRUFBeUI7QUFDdkIsUUFBSUMsWUFBWSxHQUFHLEtBQUtDLGVBQUwsQ0FBcUJmLEVBQXJCLENBQW5COztBQUNBLFFBQUljLFlBQVksS0FBSyxJQUFyQixFQUEyQjtBQUN6QixZQUFNLElBQUlFLHlCQUFPQyxZQUFYLENBQXlCLHVEQUFzRGpCLEVBQUcsR0FBbEYsQ0FBTjtBQUNEOztBQUNELFdBQU8sTUFBTSxLQUFLa0IsV0FBTCxDQUFpQixVQUFqQixFQUE2QixDQUFDSixZQUFELENBQTdCLENBQWI7QUFDRDs7QUFFRCxRQUFNc0IsSUFBSSxHQUFHLE1BQU0sS0FBS2YsY0FBTCxDQUFvQnJCLEVBQXBCLENBQW5CO0FBQ0EsU0FBTztBQUFDeUIsSUFBQUEsS0FBSyxFQUFFVyxJQUFJLENBQUNYLEtBQWI7QUFBb0JDLElBQUFBLE1BQU0sRUFBRVUsSUFBSSxDQUFDVjtBQUFqQyxHQUFQO0FBQ0QsQ0FaRDs7QUFjQSxTQUFTWSxjQUFULENBQXlCQyxJQUF6QixFQUErQjtBQUM3QixPQUFLLElBQUlDLElBQVQsSUFBaUJELElBQWpCLEVBQXVCO0FBQ3JCLFFBQUlFLFlBQVksQ0FBQ0QsSUFBRCxDQUFoQixFQUF3QjtBQUN0QixhQUFPLElBQVA7QUFDRDtBQUNGOztBQUNELFNBQU8sS0FBUDtBQUNEOztBQUVELFNBQVNDLFlBQVQsQ0FBdUJDLENBQXZCLEVBQTBCO0FBQ3hCLE1BQUlBLENBQUMsS0FBSyxRQUFOLElBQWtCQSxDQUFDLEtBQUssUUFBNUIsRUFBc0M7QUFDcEMsV0FBTyxJQUFQO0FBQ0QsR0FGRCxNQUVPLElBQUlBLENBQUMsS0FBSyxRQUFOLElBQWtCQSxDQUFDLEtBQUssUUFBNUIsRUFBc0M7QUFDM0MsV0FBTyxJQUFQO0FBQ0Q7O0FBQ0QsU0FBTyxLQUFQO0FBQ0Q7O0FBRUQsU0FBU0MsWUFBVCxDQUF1QkQsQ0FBdkIsRUFBMEI7QUFDeEIsTUFBSUEsQ0FBQyxLQUFLLFFBQU4sSUFBa0JBLENBQUMsS0FBSyxRQUE1QixFQUFzQztBQUNwQyxXQUFPLElBQVA7QUFDRCxHQUZELE1BRU8sSUFBSUEsQ0FBQyxLQUFLLFFBQU4sSUFBa0JBLENBQUMsS0FBSyxRQUE1QixFQUFzQztBQUMzQyxXQUFPLElBQVA7QUFDRDs7QUFDRCxTQUFPQSxDQUFQO0FBQ0Q7O0FBRURqRCxVQUFVLENBQUNtRCxlQUFYLEdBQTZCLGVBQWVBLGVBQWYsQ0FBZ0MvQyxPQUFoQyxFQUF5QztBQUdwRSxNQUFJZ0QsY0FBYyxHQUFHLEtBQUtBLGNBQTFCO0FBQ0EsUUFBTSxLQUFLQyxlQUFMLENBQXFCLENBQXJCLENBQU47O0FBQ0EsTUFBSTtBQUNGLFVBQU0sNkJBQWMsRUFBZCxFQUFrQixFQUFsQixFQUFzQixZQUFZO0FBQ3RDLFVBQUk7QUFDRixjQUFNLEtBQUtDLDJCQUFMLENBQWlDLFlBQWpDLEVBQStDLHlCQUEvQyxFQUEwRSxLQUExRSxDQUFOOztBQUNBQyx3QkFBSUMsS0FBSixDQUFVLDZDQUFWO0FBQ0QsT0FIRCxDQUdFLE9BQU9DLEdBQVAsRUFBWTtBQUVaRix3QkFBSUMsS0FBSixDQUFVLGlEQUFWOztBQUNBLGNBQU0sS0FBS0UsV0FBTCxDQUFpQnRELE9BQWpCLENBQU47QUFFQSxjQUFNLEtBQUtrRCwyQkFBTCxDQUFpQyxZQUFqQyxFQUErQyx5QkFBL0MsRUFBMEUsS0FBMUUsQ0FBTjtBQUNEO0FBQ0YsS0FYSyxDQUFOO0FBWUQsR0FiRCxTQWFVO0FBRVIsVUFBTSxLQUFLRCxlQUFMLENBQXFCRCxjQUFyQixDQUFOO0FBQ0Q7QUFDRixDQXRCRDs7QUF3QkFyRCxRQUFRLENBQUM0RCxpQkFBVCxHQUE2QixlQUFlQSxpQkFBZixDQUFrQ2xELEtBQWxDLEVBQXlDRixFQUF6QyxFQUE2QztBQUV4RWdELGtCQUFJSyxJQUFKLENBQVMsMkZBQVQ7O0FBQ0EsUUFBTSxLQUFLQyxRQUFMLENBQWNwRCxLQUFkLEVBQXFCRixFQUFyQixDQUFOO0FBQ0QsQ0FKRDs7QUFNQVIsUUFBUSxDQUFDOEQsUUFBVCxHQUFvQixlQUFlQSxRQUFmLENBQXlCcEQsS0FBekIsRUFBZ0NGLEVBQWhDLEVBQW9DO0FBQ3REQSxFQUFBQSxFQUFFLEdBQUdXLG9CQUFLQyxhQUFMLENBQW1CWixFQUFuQixDQUFMOztBQUNBLE1BQUksS0FBS2EsWUFBTCxFQUFKLEVBQXlCO0FBQ3ZCLFFBQUlDLFlBQVksR0FBRyxLQUFLTSxlQUFMLENBQXFCcEIsRUFBckIsQ0FBbkI7QUFDQSxVQUFNLEtBQUtrQixXQUFMLENBQWlCLE9BQWpCLEVBQTBCLENBQUNKLFlBQUQsQ0FBMUIsQ0FBTjtBQUNBLFVBQU0sS0FBS0ksV0FBTCxDQUFpQixNQUFqQixFQUF5QixDQUFDSixZQUFELEVBQWVaLEtBQWYsQ0FBekIsQ0FBTjtBQUNELEdBSkQsTUFJTztBQUNMLFVBQU1xRCxpQkFBaUIsR0FBRyxPQUFPQyxLQUFQLEVBQWNDLDhCQUFkLEtBQWlEO0FBQ3pFLFVBQUksT0FBT0QsS0FBUCxLQUFpQixRQUFqQixJQUE2QixFQUFFQSxLQUFLLFlBQVlFLEtBQW5CLENBQWpDLEVBQTREO0FBQzFERixRQUFBQSxLQUFLLEdBQUdBLEtBQUssQ0FBQ0csUUFBTixHQUFpQkMsS0FBakIsQ0FBdUIsRUFBdkIsQ0FBUjtBQUNEOztBQUNELFVBQUk7QUFDRixjQUFNLEtBQUt6RCxZQUFMLENBQW1CLFlBQVdILEVBQUcsUUFBakMsRUFBMEMsTUFBMUMsRUFBa0Q7QUFBQ0UsVUFBQUEsS0FBSyxFQUFFc0Q7QUFBUixTQUFsRCxDQUFOO0FBQ0QsT0FGRCxDQUVFLE9BQU9OLEdBQVAsRUFBWTtBQUVaLFlBQUlPLDhCQUE4QixJQUFJLE9BQU0sS0FBSy9DLFlBQUwsQ0FBa0IsTUFBbEIsRUFBMEJWLEVBQTFCLENBQU4sTUFBd0MsMEJBQTlFLEVBQTBHO0FBQ3hHZ0QsMEJBQUlLLElBQUosQ0FBVSw0Q0FBMkNILEdBQUksb0NBQXpEOztBQUNBLGdCQUFNLEtBQUtOLGVBQUwsQ0FBcUI1QyxFQUFyQixDQUFOO0FBQ0EsZ0JBQU0sS0FBS0csWUFBTCxDQUFtQixZQUFXSCxFQUFHLFFBQWpDLEVBQTBDLE1BQTFDLEVBQWtEO0FBQUNFLFlBQUFBLEtBQUssRUFBRXNEO0FBQVIsV0FBbEQsQ0FBTjtBQUNELFNBSkQsTUFJTztBQUNMLGdCQUFNTixHQUFOO0FBQ0Q7QUFDRjtBQUNGLEtBaEJEOztBQXNCQSxRQUFJN0MsZ0JBQUVDLE1BQUYsQ0FBU0osS0FBVCxLQUFtQkcsZ0JBQUV3RCxXQUFGLENBQWMzRCxLQUFkLENBQW5CLElBQTJDRyxnQkFBRXlELGFBQUYsQ0FBZ0I1RCxLQUFoQixDQUEvQyxFQUF1RTtBQUNyRSxZQUFNLElBQUk2RCxLQUFKLENBQVcsbUZBQWtGdkQsSUFBSSxDQUFDQyxTQUFMLENBQWVQLEtBQWYsQ0FBc0IsR0FBbkgsQ0FBTjtBQUNEOztBQUNELFFBQUlHLGdCQUFFMkQsT0FBRixDQUFVOUQsS0FBVixDQUFKLEVBQXNCO0FBRXBCQSxNQUFBQSxLQUFLLEdBQUdHLGdCQUFFNEQsT0FBRixDQUFVL0QsS0FBVixFQUFrQmdFLENBQUQsSUFBTyxDQUFDN0QsZ0JBQUVFLFFBQUYsQ0FBVzJELENBQVgsSUFBZ0JBLENBQWhCLEdBQW9CMUQsSUFBSSxDQUFDQyxTQUFMLENBQWV5RCxDQUFmLENBQXJCLEVBQXdDTixLQUF4QyxDQUE4QyxFQUE5QyxDQUF4QixDQUFSO0FBQ0QsS0FIRCxNQUdPO0FBRUwxRCxNQUFBQSxLQUFLLEdBQUcsQ0FBQ0EsS0FBSyxJQUFJLEVBQVYsRUFBY3lELFFBQWQsR0FBeUJDLEtBQXpCLENBQStCLEVBQS9CLENBQVI7QUFDRDs7QUFFRCxRQUFJLENBQUN0QixjQUFjLENBQUNwQyxLQUFELENBQW5CLEVBQTRCO0FBRTFCLFlBQU1xRCxpQkFBaUIsQ0FBQ3JELEtBQUQsRUFBUSxJQUFSLENBQXZCO0FBQ0E7QUFDRDs7QUFLRCxRQUFJaUUsTUFBTSxHQUFHLEVBQWI7QUFDQSxRQUFJQyxXQUFXLEdBQUcsSUFBbEI7O0FBQ0EsU0FBSyxJQUFJMUIsQ0FBVCxJQUFjeEMsS0FBZCxFQUFxQjtBQUNuQixVQUFJc0MsSUFBSSxHQUFHRyxZQUFZLENBQUNELENBQUQsQ0FBdkI7O0FBRUEsVUFBSUYsSUFBSSxLQUFLRSxDQUFiLEVBQWdCO0FBQ2R5QixRQUFBQSxNQUFNLENBQUNFLElBQVAsQ0FBWTdCLElBQVo7QUFDQTtBQUNEOztBQUdELFlBQU1lLGlCQUFpQixDQUFDWSxNQUFELEVBQVNDLFdBQVQsQ0FBdkI7QUFDQUEsTUFBQUEsV0FBVyxHQUFHLEtBQWQ7QUFDQUQsTUFBQUEsTUFBTSxHQUFHLEVBQVQ7QUFHQSxZQUFNWixpQkFBaUIsQ0FBQyxDQUFDZixJQUFELENBQUQsRUFBUzRCLFdBQVQsQ0FBdkI7QUFDRDs7QUFFRCxRQUFJRCxNQUFNLENBQUNHLE1BQVgsRUFBbUI7QUFDakIsWUFBTWYsaUJBQWlCLENBQUNZLE1BQUQsRUFBUyxLQUFULENBQXZCO0FBQ0Q7QUFDRjtBQUNGLENBeEVEOztBQTBFQTNFLFFBQVEsQ0FBQytDLElBQVQsR0FBZ0IsZUFBZUEsSUFBZixDQUFxQnJDLEtBQXJCLEVBQTRCO0FBQzFDLE1BQUlHLGdCQUFFMkQsT0FBRixDQUFVOUQsS0FBVixDQUFKLEVBQXNCO0FBRXBCQSxJQUFBQSxLQUFLLEdBQUdBLEtBQUssQ0FBQ3FFLElBQU4sQ0FBVyxFQUFYLENBQVI7QUFDRDs7QUFDRCxNQUFJbEUsZ0JBQUVFLFFBQUYsQ0FBV0wsS0FBWCxDQUFKLEVBQXVCO0FBRXJCQSxJQUFBQSxLQUFLLEdBQUdBLEtBQUssQ0FBQzBELEtBQU4sQ0FBWSxFQUFaLENBQVI7QUFDRDs7QUFFRCxNQUFJTyxNQUFNLEdBQUcsRUFBYjs7QUFDQSxPQUFLLElBQUl6QixDQUFULElBQWN4QyxLQUFkLEVBQXFCO0FBQ25CLFFBQUlzQyxJQUFJLEdBQUdHLFlBQVksQ0FBQ0QsQ0FBRCxDQUF2QjtBQUVBeUIsSUFBQUEsTUFBTSxDQUFDRSxJQUFQLENBQVk3QixJQUFaO0FBQ0Q7O0FBQ0QsUUFBTSxLQUFLckMsWUFBTCxDQUFrQixXQUFsQixFQUErQixNQUEvQixFQUF1QztBQUFDRCxJQUFBQSxLQUFLLEVBQUVpRTtBQUFSLEdBQXZDLENBQU47QUFDRCxDQWpCRDs7QUFtQkEzRSxRQUFRLENBQUNnRixLQUFULEdBQWlCLGVBQWVBLEtBQWYsQ0FBc0J4RSxFQUF0QixFQUEwQjtBQUN6Q0EsRUFBQUEsRUFBRSxHQUFHVyxvQkFBS0MsYUFBTCxDQUFtQlosRUFBbkIsQ0FBTDs7QUFDQSxNQUFJLEtBQUthLFlBQUwsRUFBSixFQUF5QjtBQUN2QixRQUFJQyxZQUFZLEdBQUcsS0FBS00sZUFBTCxDQUFxQnBCLEVBQXJCLENBQW5CO0FBQ0EsVUFBTSxLQUFLa0IsV0FBTCxDQUFpQixPQUFqQixFQUEwQixDQUFDSixZQUFELENBQTFCLENBQU47QUFDQTtBQUNEOztBQUNELFFBQU0scUJBQU0sQ0FBTixFQUFTLEtBQUtYLFlBQUwsQ0FBa0JzRSxJQUFsQixDQUF1QixJQUF2QixDQUFULEVBQXdDLFlBQVd6RSxFQUFHLFFBQXRELEVBQStELE1BQS9ELENBQU47QUFDRCxDQVJEOztBQVVBUixRQUFRLENBQUNTLGNBQVQsR0FBMEIsZUFBZUEsY0FBZixDQUErQkQsRUFBL0IsRUFBbUM7QUFDM0QsTUFBSSxLQUFLYSxZQUFMLEVBQUosRUFBeUI7QUFDdkIsVUFBTSxJQUFJRyx5QkFBTzBELHNCQUFYLENBQWtDLGdHQUFsQyxDQUFOO0FBQ0Q7O0FBRUQsUUFBTUMsSUFBSSxHQUFHLE1BQU0sS0FBS2pFLFlBQUwsQ0FBa0IsTUFBbEIsRUFBMEJWLEVBQTFCLENBQW5COztBQUVBLE1BQUkyRSxJQUFJLEtBQUssc0JBQVQsSUFDQUEsSUFBSSxLQUFLLCtCQURiLEVBQzhDO0FBQzVDLFVBQU0sSUFBSVosS0FBSixDQUFXLG9DQUFtQ1ksSUFBSyxjQUF6QyxHQUNDLDZCQURYLENBQU47QUFFRDs7QUFDRCxNQUFJQyxPQUFPLEdBQUcsR0FBZDs7QUFDQSxNQUFJRCxJQUFJLEtBQUssc0JBQWIsRUFBcUM7QUFFbkNDLElBQUFBLE9BQU8sR0FBRyxxQkFBVjtBQUNEOztBQUVELE1BQUlDLGFBQWEsR0FBRyxDQUFwQjtBQUNBLE1BQUlDLFFBQVEsR0FBRyxNQUFNLEtBQUtDLFdBQUwsQ0FBa0IsYUFBbEIsRUFBZ0NILE9BQWhDLEVBQXlDLElBQXpDLEVBQStDNUUsRUFBL0MsQ0FBckI7O0FBQ0EsTUFBSThFLFFBQVEsQ0FBQ1IsTUFBVCxLQUFvQixDQUF4QixFQUEyQjtBQUd6QixVQUFNbEMsSUFBSSxHQUFHLE1BQU0sS0FBS2YsY0FBTCxDQUFvQmhCLGdCQUFFMkUsSUFBRixDQUFPRixRQUFQLENBQXBCLENBQW5CO0FBQ0FELElBQUFBLGFBQWEsR0FBR3pDLElBQUksQ0FBQ1YsTUFBckI7QUFDRCxHQUxELE1BS08sSUFBSW9ELFFBQVEsQ0FBQ1IsTUFBYixFQUFxQjtBQUcxQixZQUFRSyxJQUFSO0FBQ0UsV0FBSyxzQkFBTDtBQUE2QjtBQUMzQixnQkFBTU0sU0FBUyxHQUFHLE1BQU0sS0FBSzVELGNBQUwsQ0FBb0JoQixnQkFBRTJFLElBQUYsQ0FBT0YsUUFBUCxDQUFwQixDQUF4QjtBQUNBLGdCQUFNSSxRQUFRLEdBQUcsTUFBTSxLQUFLN0QsY0FBTCxDQUFvQmhCLGdCQUFFOEUsSUFBRixDQUFPTCxRQUFQLENBQXBCLENBQXZCO0FBQ0FELFVBQUFBLGFBQWEsR0FBR0ssUUFBUSxDQUFDM0QsQ0FBVCxHQUFhMkQsUUFBUSxDQUFDeEQsTUFBdEIsR0FBK0J1RCxTQUFTLENBQUMxRCxDQUF6RDtBQUNBO0FBQ0Q7O0FBQ0QsV0FBSywrQkFBTDtBQUFzQztBQUNwQyxjQUFJNkQsUUFBUSxHQUFHLENBQWY7QUFDQSxjQUFJSCxTQUFTLEdBQUcsTUFBTSxLQUFLNUQsY0FBTCxDQUFvQmhCLGdCQUFFMkUsSUFBRixDQUFPRixRQUFQLENBQXBCLENBQXRCO0FBQ0EsY0FBSU8sWUFBWSxHQUFHLENBQUNKLFNBQUQsQ0FBbkI7O0FBQ0EsZUFBSyxJQUFJSyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHUixRQUFRLENBQUNSLE1BQTdCLEVBQXFDZ0IsQ0FBQyxFQUF0QyxFQUEwQztBQUN4QyxrQkFBTWxELElBQUksR0FBRyxNQUFNLEtBQUtmLGNBQUwsQ0FBb0J5RCxRQUFRLENBQUNRLENBQUQsQ0FBNUIsQ0FBbkI7QUFDQUQsWUFBQUEsWUFBWSxDQUFDaEIsSUFBYixDQUFrQmpDLElBQWxCOztBQUNBLGdCQUFJQSxJQUFJLENBQUNiLENBQUwsS0FBVzBELFNBQVMsQ0FBQzFELENBQXpCLEVBQTRCO0FBQzFCNkQsY0FBQUEsUUFBUSxHQUFHRSxDQUFYO0FBQ0E7QUFDRDtBQUNGOztBQUNELGdCQUFNQyxlQUFlLEdBQUdGLFlBQVksQ0FBQ0QsUUFBRCxDQUFaLENBQXVCN0QsQ0FBdkIsR0FBMkI4RCxZQUFZLENBQUNELFFBQVEsR0FBRyxDQUFaLENBQVosQ0FBMkI3RCxDQUF0RCxHQUEwRDhELFlBQVksQ0FBQ0QsUUFBUSxHQUFHLENBQVosQ0FBWixDQUEyQjFELE1BQTdHO0FBQ0EsZ0JBQU04RCxPQUFPLEdBQUdDLElBQUksQ0FBQ0MsSUFBTCxDQUFVWixRQUFRLENBQUNSLE1BQVQsR0FBa0JjLFFBQTVCLENBQWhCO0FBR0FQLFVBQUFBLGFBQWEsR0FBSVcsT0FBTyxHQUFHUCxTQUFTLENBQUN2RCxNQUFyQixHQUFnQzZELGVBQWUsSUFBSUMsT0FBTyxHQUFHLENBQWQsQ0FBL0Q7QUFDQTtBQUNEOztBQUNEO0FBQVMsY0FBTSxJQUFJekIsS0FBSixDQUFXLDRCQUEyQlksSUFBSyxZQUFqQyxHQUNDLDZDQURYLENBQU47QUExQlg7QUE2QkQ7O0FBQ0QsUUFBTWdCLElBQUksR0FBRyxNQUFNLEtBQUtoRSxPQUFMLENBQWEzQixFQUFiLENBQW5CO0FBQ0EsUUFBTTRGLE1BQU0sR0FBRyxNQUFNLEtBQUt2RCxpQkFBTCxDQUF1QnJDLEVBQXZCLENBQXJCO0FBRUEsU0FBT1EsSUFBSSxDQUFDQyxTQUFMLENBQWU7QUFDcEJnQixJQUFBQSxLQUFLLEVBQUVrRSxJQUFJLENBQUNsRSxLQURRO0FBRXBCQyxJQUFBQSxNQUFNLEVBQUVpRSxJQUFJLENBQUNqRSxNQUZPO0FBR3BCbUUsSUFBQUEsR0FBRyxFQUFFRCxNQUFNLENBQUNyRSxDQUhRO0FBSXBCdUUsSUFBQUEsSUFBSSxFQUFFRixNQUFNLENBQUN0RSxDQUpPO0FBS3BCeUUsSUFBQUEsZ0JBQWdCLEVBQUVsQjtBQUxFLEdBQWYsQ0FBUDtBQU9ELENBcEVEOztBQXNFQXJGLFFBQVEsQ0FBQ3dHLGVBQVQsR0FBMkIsZUFBZUEsZUFBZixHQUFrQztBQUMzRCxNQUFJO0FBQ0YsVUFBTSxLQUFLakQsMkJBQUwsQ0FBaUMsWUFBakMsRUFBK0MseUJBQS9DLEVBQTBFLEtBQTFFLENBQU47QUFDQSxXQUFPLElBQVA7QUFDRCxHQUhELENBR0UsT0FBT2tELEdBQVAsRUFBWTtBQUNaLFdBQU8sS0FBUDtBQUNEO0FBQ0YsQ0FQRDs7QUFTQXZHLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjRixVQUFkLEVBQTBCRCxRQUExQjtlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBpb3NDb21tYW5kcyB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsLCByZXRyeSB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcblxuXG5sZXQgY29tbWFuZHMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG4vLyBwdWxsIGluIGFsbCB0aGUgZWxlbWVudCBjb21tYW5kcyBhbmQgaGVscGVycyBmcm9tIGlvcy1kcml2ZXIsXG4vLyB0aGVuIG92ZXJyaWRlIGFueXRoaW5nIHdlIHdhbnQgYmVsb3dcbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgaW9zQ29tbWFuZHMuZWxlbWVudCk7XG5cbmNvbW1hbmRzLmdldE5hdGl2ZUF0dHJpYnV0ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldE5hdGl2ZUF0dHJpYnV0ZSAoYXR0cmlidXRlLCBlbCkge1xuICBpZiAoYXR0cmlidXRlID09PSAnY29udGVudFNpemUnKSB7XG4gICAgLy8gZG9uJ3QgcHJveHkgcmVxdWVzdHMgZm9yIHRoZSBjb250ZW50IHNpemUgb2YgYSBzY3JvbGxhYmxlIGVsZW1lbnRcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRDb250ZW50U2l6ZShlbCk7XG4gIH1cblxuICAvLyBvdGhlcndpc2UgbGV0IFdEQSBoYW5kbGUgYXR0cmlidXRlIHJlcXVlc3RzXG4gIGxldCB2YWx1ZSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2VsfS9hdHRyaWJ1dGUvJHthdHRyaWJ1dGV9YCwgJ0dFVCcpO1xuICAvLyBUcmFuc2Zvcm0gdGhlIHJlc3VsdCBmb3IgdGhlIGNhc2Ugd2hlbiBXREEgcmV0dXJucyBhbiBpbnRlZ2VyIHJlcHJlc2VudGF0aW9uIGZvciBhIGJvb2xlYW4gdmFsdWVcbiAgaWYgKFswLCAxXS5pbmNsdWRlcyh2YWx1ZSkpIHtcbiAgICB2YWx1ZSA9ICEhdmFsdWU7XG4gIH1cbiAgLy8gVGhlIHJldHVybmVkIHZhbHVlIG11c3QgYmUgb2YgdHlwZSBzdHJpbmcgYWNjb3JkaW5nIHRvIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93ZWJkcml2ZXIvI2dldC1lbGVtZW50LWF0dHJpYnV0ZVxuICByZXR1cm4gKF8uaXNOdWxsKHZhbHVlKSB8fCBfLmlzU3RyaW5nKHZhbHVlKSkgPyB2YWx1ZSA6IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcbn07XG5cbmNvbW1hbmRzLmdldEF0dHJpYnV0ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldEF0dHJpYnV0ZSAoYXR0cmlidXRlLCBlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldE5hdGl2ZUF0dHJpYnV0ZShhdHRyaWJ1dGUsIGVsKTtcbiAgfVxuICBjb25zdCBhdG9tc0VsZW1lbnQgPSB0aGlzLmdldEF0b21zRWxlbWVudChlbCk7XG4gIGlmIChfLmlzTnVsbChhdG9tc0VsZW1lbnQpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoYEVycm9yIGNvbnZlcnRpbmcgZWxlbWVudCBJRCBmb3IgdXNpbmcgaW4gV0QgYXRvbXM6ICcke2VsfWApO1xuICB9XG4gIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfYXR0cmlidXRlX3ZhbHVlJywgW2F0b21zRWxlbWVudCwgYXR0cmlidXRlXSk7XG59O1xuXG5jb21tYW5kcy5nZXRUZXh0ID0gYXN5bmMgZnVuY3Rpb24gZ2V0VGV4dCAoZWwpIHtcbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7ZWx9L3RleHRgLCAnR0VUJyk7XG4gIH1cbiAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF90ZXh0JywgW2F0b21zRWxlbWVudF0pO1xufTtcblxuY29tbWFuZHMuZ2V0RWxlbWVudFJlY3QgPSBhc3luYyBmdW5jdGlvbiBnZXRFbGVtZW50UmVjdCAoZWwpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAvLyBNb2JpbGUgc2FmYXJpIGRvZXNuJ3Qgc3VwcG9ydCByZWN0XG4gICAgY29uc3Qge3gsIHl9ID0gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbihlbCk7XG4gICAgY29uc3Qge3dpZHRoLCBoZWlnaHR9ID0gYXdhaXQgdGhpcy5nZXRTaXplKGVsKTtcbiAgICByZXR1cm4ge3gsIHksIHdpZHRoLCBoZWlnaHR9O1xuICB9XG5cbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuICByZXR1cm4gYXdhaXQgdGhpcy5nZXROYXRpdmVSZWN0KGVsKTtcbn07XG5cbmV4dGVuc2lvbnMuZ2V0TmF0aXZlUmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGdldE5hdGl2ZVJlY3QgKGVsKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL2VsZW1lbnQvJHtlbH0vcmVjdGAsICdHRVQnKTtcbn07XG5cbmNvbW1hbmRzLmdldExvY2F0aW9uID0gYXN5bmMgZnVuY3Rpb24gZ2V0TG9jYXRpb24gKGVsKSB7XG4gIGVsID0gdXRpbC51bndyYXBFbGVtZW50KGVsKTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBjb25zdCBhdG9tc0VsZW1lbnQgPSBhd2FpdCB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG4gICAgbGV0IGxvYyA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF90b3BfbGVmdF9jb29yZGluYXRlcycsIFthdG9tc0VsZW1lbnRdKTtcbiAgICBpZiAodGhpcy5vcHRzLmFic29sdXRlV2ViTG9jYXRpb25zKSB7XG4gICAgICBjb25zdCBzY3JpcHQgPSAncmV0dXJuIFtkb2N1bWVudC5ib2R5LnNjcm9sbExlZnQsIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wXTsnO1xuICAgICAgY29uc3QgW3hPZmZzZXQsIHlPZmZzZXRdID0gYXdhaXQgdGhpcy5leGVjdXRlKHNjcmlwdCk7XG4gICAgICBsb2MueCArPSB4T2Zmc2V0O1xuICAgICAgbG9jLnkgKz0geU9mZnNldDtcbiAgICB9XG4gICAgcmV0dXJuIGxvYztcbiAgfVxuXG4gIGNvbnN0IHJlY3QgPSBhd2FpdCB0aGlzLmdldEVsZW1lbnRSZWN0KGVsKTtcbiAgcmV0dXJuIHt4OiByZWN0LngsIHk6IHJlY3QueX07XG59O1xuXG5jb21tYW5kcy5nZXRMb2NhdGlvbkluVmlldyA9IGFzeW5jIGZ1bmN0aW9uIGdldExvY2F0aW9uSW5WaWV3IChlbCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbihlbCk7XG59O1xuXG5jb21tYW5kcy5nZXRTaXplID0gYXN5bmMgZnVuY3Rpb24gZ2V0U2l6ZSAoZWwpIHtcbiAgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoZWwpO1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBhdG9tc0VsZW1lbnQgPSB0aGlzLmdldEF0b21zRWxlbWVudChlbCk7XG4gICAgaWYgKGF0b21zRWxlbWVudCA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoYEVycm9yIGNvbnZlcnRpbmcgZWxlbWVudCBJRCBmb3IgdXNpbmcgaW4gV0QgYXRvbXM6ICcke2VsfSdgKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF9zaXplJywgW2F0b21zRWxlbWVudF0pO1xuICB9XG5cbiAgY29uc3QgcmVjdCA9IGF3YWl0IHRoaXMuZ2V0RWxlbWVudFJlY3QoZWwpO1xuICByZXR1cm4ge3dpZHRoOiByZWN0LndpZHRoLCBoZWlnaHQ6IHJlY3QuaGVpZ2h0fTtcbn07XG5cbmZ1bmN0aW9uIGhhc1NwZWNpYWxLZXlzIChrZXlzKSB7XG4gIGZvciAobGV0IGNoYXIgb2Yga2V5cykge1xuICAgIGlmIChpc1NwZWNpYWxLZXkoY2hhcikpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIGlzU3BlY2lhbEtleSAoaykge1xuICBpZiAoayA9PT0gJ1xcdUUwMDMnIHx8IGsgPT09ICdcXHVlMDE3JykgeyAvLyBCQUNLU1BBQ0Ugb3IgREVMRVRFXG4gICAgcmV0dXJuIHRydWU7XG4gIH0gZWxzZSBpZiAoayA9PT0gJ1xcdUUwMDYnIHx8IGsgPT09ICdcXHVFMDA3JykgeyAvLyBSRVRVUk4gb3IgRU5URVJcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIHRyYW5zbGF0ZUtleSAoaykge1xuICBpZiAoayA9PT0gJ1xcdUUwMDYnIHx8IGsgPT09ICdcXHVFMDA3JykgeyAvLyBSRVRVUk4gb3IgRU5URVJcbiAgICByZXR1cm4gJ1xcbic7XG4gIH0gZWxzZSBpZiAoayA9PT0gJ1xcdUUwMDMnIHx8IGsgPT09ICdcXHVlMDE3JykgeyAvLyBCQUNLU1BBQ0Ugb3IgREVMRVRFXG4gICAgcmV0dXJuICdcXGInO1xuICB9XG4gIHJldHVybiBrO1xufVxuXG5leHRlbnNpb25zLmJyaW5nVXBLZXlib2FyZCA9IGFzeW5jIGZ1bmN0aW9uIGJyaW5nVXBLZXlib2FyZCAoZWxlbWVudCkge1xuICAvLyBzb21ldGltZXMgaW5wdXQgaXMgYXR0ZW1wdGVkIGJlZm9yZSB3ZSBoYXZlIGEga2V5Ym9hcmQuIFRyeSB0byBicmluZyBvbmUgdXBcbiAgLy8gYnV0IHdlIHdhbnQgdG8gaGFuZGxlIHRoZSByZXRyaWVzIG9uIGZpbmRcbiAgbGV0IGltcGxpY2l0V2FpdE1zID0gdGhpcy5pbXBsaWNpdFdhaXRNcztcbiAgYXdhaXQgdGhpcy5zZXRJbXBsaWNpdFdhaXQoMCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgxMCwgMTAsIGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZUtleWJvYXJkJywgZmFsc2UpO1xuICAgICAgICBsb2cuZGVidWcoJ0tleWJvYXJkIGZvdW5kLiBDb250aW51aW5nIHdpdGggdGV4dCBpbnB1dC4nKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyBubyBrZXlib2FyZCBmb3VuZFxuICAgICAgICBsb2cuZGVidWcoJ05vIGtleWJvYXJkIGZvdW5kLiBDbGlja2luZyBlbGVtZW50IHRvIG9wZW4gaXQuJyk7XG4gICAgICAgIGF3YWl0IHRoaXMubmF0aXZlQ2xpY2soZWxlbWVudCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnWENVSUVsZW1lbnRUeXBlS2V5Ym9hcmQnLCBmYWxzZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0gZmluYWxseSB7XG4gICAgLy8gbm8gbWF0dGVyIHdoYXQgd2UgZG8sIG1ha2Ugc3VyZSB3ZSBoYXZlIHRoZSBpbXBsaWNpdCB3YWl0IHNldCB1cCBjb3JyZWN0bHlcbiAgICBhd2FpdCB0aGlzLnNldEltcGxpY2l0V2FpdChpbXBsaWNpdFdhaXRNcyk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnNldFZhbHVlSW1tZWRpYXRlID0gYXN5bmMgZnVuY3Rpb24gc2V0VmFsdWVJbW1lZGlhdGUgKHZhbHVlLCBlbCkge1xuICAvLyBXREEgZG9lcyBub3QgcHJvdmlkZSBubyB3YXkgdG8gc2V0IHRoZSB2YWx1ZSBkaXJlY3RseVxuICBsb2cuaW5mbygnVGhlcmUgaXMgY3VycmVudGx5IG5vIHdheSB0byBieXBhc3MgdHlwaW5nIHVzaW5nIFhDVUlUZXN0LiBTZXR0aW5nIHZhbHVlIHRocm91Z2gga2V5Ym9hcmQnKTtcbiAgYXdhaXQgdGhpcy5zZXRWYWx1ZSh2YWx1ZSwgZWwpO1xufTtcblxuY29tbWFuZHMuc2V0VmFsdWUgPSBhc3luYyBmdW5jdGlvbiBzZXRWYWx1ZSAodmFsdWUsIGVsKSB7XG4gIGVsID0gdXRpbC51bndyYXBFbGVtZW50KGVsKTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2NsaWNrJywgW2F0b21zRWxlbWVudF0pO1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ3R5cGUnLCBbYXRvbXNFbGVtZW50LCB2YWx1ZV0pO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHNldEZvcm1hdHRlZFZhbHVlID0gYXN5bmMgKGlucHV0LCBpc0tleWJvYXJkUHJlc2VuY2VDaGVja0VuYWJsZWQpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgaW5wdXQgIT09ICdzdHJpbmcnICYmICEoaW5wdXQgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICAgICAgaW5wdXQgPSBpbnB1dC50b1N0cmluZygpLnNwbGl0KCcnKTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2VsfS92YWx1ZWAsICdQT1NUJywge3ZhbHVlOiBpbnB1dH0pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0aGVyZSBpcyBhIGtleWJvYXJkIGlmIHRoaXMgaXMgYSB0ZXh0IGZpZWxkXG4gICAgICAgIGlmIChpc0tleWJvYXJkUHJlc2VuY2VDaGVja0VuYWJsZWQgJiYgYXdhaXQgdGhpcy5nZXRBdHRyaWJ1dGUoJ3R5cGUnLCBlbCkgPT09ICdYQ1VJRWxlbWVudFR5cGVUZXh0RmllbGQnKSB7XG4gICAgICAgICAgbG9nLmluZm8oYENhbm5vdCB0eXBlIGluIHRoZSB0ZXh0IGZpZWxkIGJlY2F1c2Ugb2YgJHtlcnJ9LlxcblRyeWluZyB0byBhcHBseSBhIHdvcmthcm91bmQuLi5gKTtcbiAgICAgICAgICBhd2FpdCB0aGlzLmJyaW5nVXBLZXlib2FyZChlbCk7XG4gICAgICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7ZWx9L3ZhbHVlYCwgJ1BPU1QnLCB7dmFsdWU6IGlucHV0fSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICAgIC8vIHBvc3NpYmxlIHZhbHVlcyBvZiBgdmFsdWVgOlxuICAgIC8vICAgWydzb21lIHRleHQnXVxuICAgIC8vICAgWydzJywgJ28nLCAnbScsICdlJywgJyAnLCAndCcsICdlJywgJ3gnLCAndCddXG4gICAgLy8gICAnc29tZSB0ZXh0J1xuICAgIGlmIChfLmlzTnVsbCh2YWx1ZSkgfHwgXy5pc1VuZGVmaW5lZCh2YWx1ZSkgfHwgXy5pc1BsYWluT2JqZWN0KHZhbHVlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBPbmx5IHN0cmluZ3MgYW5kIGFycmF5cyBvZiBzdHJpbmdzIGFyZSBzdXBwb3J0ZWQgYXMgaW5wdXQgYXJndW1lbnRzLiBSZWNlaXZlZDogJyR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfSdgKTtcbiAgICB9XG4gICAgaWYgKF8uaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IGFsbCB0aGUgc3RyaW5ncyBpbnNpZGUgYXJlIGEgc2luZ2xlIGNoYXJhY3RlciBsb25nXG4gICAgICB2YWx1ZSA9IF8uZmxhdE1hcCh2YWx1ZSwgKHYpID0+IChfLmlzU3RyaW5nKHYpID8gdiA6IEpTT04uc3RyaW5naWZ5KHYpKS5zcGxpdCgnJykpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBtYWtlIGl0IGludG8gYW4gYXJyYXkgb2YgY2hhcmFjdGVyc1xuICAgICAgdmFsdWUgPSAodmFsdWUgfHwgJycpLnRvU3RyaW5nKCkuc3BsaXQoJycpO1xuICAgIH1cblxuICAgIGlmICghaGFzU3BlY2lhbEtleXModmFsdWUpKSB7XG4gICAgICAvLyBub3RoaW5nIHNwZWNpYWwsIHNvIGp1c3Qgc2VuZCBpdCBpblxuICAgICAgYXdhaXQgc2V0Rm9ybWF0dGVkVmFsdWUodmFsdWUsIHRydWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGlmIHRoZXJlIGFyZSBzcGVjaWFsIGNoYXJhY3RlcnMsIGdvIHRocm91Z2ggdGhlIHZhbHVlIHVudGlsIHdlIGdldCB0byBvbmUsXG4gICAgLy8gYW5kIHRoZW4gcHJpbnQgaXQgaW5kaXZpZHVhbGx5XG4gICAgLy8gY3VycmVudGx5IG9ubHkgc3VwcG9ydGluZyByZXR1cm4sIGVudGVyLCBiYWNrc3BhY2UsIGFuZCBkZWxldGVcbiAgICBsZXQgYnVmZmVyID0gW107XG4gICAgbGV0IGlzRmlyc3RDaGFyID0gdHJ1ZTtcbiAgICBmb3IgKGxldCBrIG9mIHZhbHVlKSB7XG4gICAgICBsZXQgY2hhciA9IHRyYW5zbGF0ZUtleShrKTtcblxuICAgICAgaWYgKGNoYXIgPT09IGspIHtcbiAgICAgICAgYnVmZmVyLnB1c2goY2hhcik7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvLyB3cml0ZSBhbmQgY2xlYXIgdGhlIGJ1ZmZlclxuICAgICAgYXdhaXQgc2V0Rm9ybWF0dGVkVmFsdWUoYnVmZmVyLCBpc0ZpcnN0Q2hhcik7XG4gICAgICBpc0ZpcnN0Q2hhciA9IGZhbHNlO1xuICAgICAgYnVmZmVyID0gW107XG5cbiAgICAgIC8vIHdyaXRlIHRoZSBjaGFyYWN0ZXJcbiAgICAgIGF3YWl0IHNldEZvcm1hdHRlZFZhbHVlKFtjaGFyXSwgaXNGaXJzdENoYXIpO1xuICAgIH1cbiAgICAvLyBmaW5hbGx5LCBzZW5kIGFueXRoaW5nIHRoYXQgbWlnaHQgYmUgbGVmdFxuICAgIGlmIChidWZmZXIubGVuZ3RoKSB7XG4gICAgICBhd2FpdCBzZXRGb3JtYXR0ZWRWYWx1ZShidWZmZXIsIGZhbHNlKTtcbiAgICB9XG4gIH1cbn07XG5cbmNvbW1hbmRzLmtleXMgPSBhc3luYyBmdW5jdGlvbiBrZXlzICh2YWx1ZSkge1xuICBpZiAoXy5pc0FycmF5KHZhbHVlKSkge1xuICAgIC8vIGNvbmNhdGVuYXRlIGFueSBpbmRpdmlkdWFsIHN0cmluZ3NcbiAgICB2YWx1ZSA9IHZhbHVlLmpvaW4oJycpO1xuICB9XG4gIGlmIChfLmlzU3RyaW5nKHZhbHVlKSkge1xuICAgIC8vIHNwbGl0IGludG8gY29tcG9uZW50IGNoYXJhY3RlcnNcbiAgICB2YWx1ZSA9IHZhbHVlLnNwbGl0KCcnKTtcbiAgfVxuXG4gIGxldCBidWZmZXIgPSBbXTtcbiAgZm9yIChsZXQgayBvZiB2YWx1ZSkge1xuICAgIGxldCBjaGFyID0gdHJhbnNsYXRlS2V5KGspO1xuXG4gICAgYnVmZmVyLnB1c2goY2hhcik7XG4gIH1cbiAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEva2V5cycsICdQT1NUJywge3ZhbHVlOiBidWZmZXJ9KTtcbn07XG5cbmNvbW1hbmRzLmNsZWFyID0gYXN5bmMgZnVuY3Rpb24gY2xlYXIgKGVsKSB7XG4gIGVsID0gdXRpbC51bndyYXBFbGVtZW50KGVsKTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2NsZWFyJywgW2F0b21zRWxlbWVudF0pO1xuICAgIHJldHVybjtcbiAgfVxuICBhd2FpdCByZXRyeSg1LCB0aGlzLnByb3h5Q29tbWFuZC5iaW5kKHRoaXMpLCBgL2VsZW1lbnQvJHtlbH0vY2xlYXJgLCAnUE9TVCcpO1xufTtcblxuY29tbWFuZHMuZ2V0Q29udGVudFNpemUgPSBhc3luYyBmdW5jdGlvbiBnZXRDb250ZW50U2l6ZSAoZWwpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoJ1N1cHBvcnQgZm9yIGdldENvbnRlbnRTaXplIGZvciB3ZWJjb250ZXh0IGlzIG5vdCB5ZXQgaW1wbGVtZW50ZWQuIFBsZWFzZSBjb250YWN0IGFuIEFwcGl1bSBkZXYnKTtcbiAgfVxuXG4gIGNvbnN0IHR5cGUgPSBhd2FpdCB0aGlzLmdldEF0dHJpYnV0ZSgndHlwZScsIGVsKTtcblxuICBpZiAodHlwZSAhPT0gJ1hDVUlFbGVtZW50VHlwZVRhYmxlJyAmJlxuICAgICAgdHlwZSAhPT0gJ1hDVUlFbGVtZW50VHlwZUNvbGxlY3Rpb25WaWV3Jykge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2FuJ3QgZ2V0IGNvbnRlbnQgc2l6ZSBmb3IgdHlwZSAnJHt0eXBlfScsIG9ubHkgZm9yIGAgK1xuICAgICAgICAgICAgICAgICAgICBgdGFibGVzIGFuZCBjb2xsZWN0aW9uIHZpZXdzYCk7XG4gIH1cbiAgbGV0IGxvY2F0b3IgPSAnKic7XG4gIGlmICh0eXBlID09PSAnWENVSUVsZW1lbnRUeXBlVGFibGUnKSB7XG4gICAgLy8gb25seSBmaW5kIHRhYmxlIGNlbGxzLCBub3QganVzdCBhbnkgY2hpbGRyZW5cbiAgICBsb2NhdG9yID0gJ1hDVUlFbGVtZW50VHlwZUNlbGwnO1xuICB9XG5cbiAgbGV0IGNvbnRlbnRIZWlnaHQgPSAwO1xuICBsZXQgY2hpbGRyZW4gPSBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzKGBjbGFzcyBjaGFpbmAsIGxvY2F0b3IsIHRydWUsIGVsKTtcbiAgaWYgKGNoaWxkcmVuLmxlbmd0aCA9PT0gMSkge1xuICAgIC8vIGlmIHdlIGtub3cgdGhlcmUncyBvbmx5IG9uZSBlbGVtZW50LCB3ZSBjYW4gb3B0aW1pemUgdG8gbWFrZSBqdXN0IG9uZVxuICAgIC8vIGNhbGwgdG8gV0RBXG4gICAgY29uc3QgcmVjdCA9IGF3YWl0IHRoaXMuZ2V0RWxlbWVudFJlY3QoXy5oZWFkKGNoaWxkcmVuKSk7XG4gICAgY29udGVudEhlaWdodCA9IHJlY3QuaGVpZ2h0O1xuICB9IGVsc2UgaWYgKGNoaWxkcmVuLmxlbmd0aCkge1xuICAgIC8vIG90aGVyd2lzZSBpZiB3ZSBoYXZlIG11bHRpcGxlIGVsZW1lbnRzLCBsb2dpYyBkaWZmZXJzIGJhc2VkIG9uIGVsZW1lbnRcbiAgICAvLyB0eXBlXG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlICdYQ1VJRWxlbWVudFR5cGVUYWJsZSc6IHtcbiAgICAgICAgY29uc3QgZmlyc3RSZWN0ID0gYXdhaXQgdGhpcy5nZXRFbGVtZW50UmVjdChfLmhlYWQoY2hpbGRyZW4pKTtcbiAgICAgICAgY29uc3QgbGFzdFJlY3QgPSBhd2FpdCB0aGlzLmdldEVsZW1lbnRSZWN0KF8ubGFzdChjaGlsZHJlbikpO1xuICAgICAgICBjb250ZW50SGVpZ2h0ID0gbGFzdFJlY3QueSArIGxhc3RSZWN0LmhlaWdodCAtIGZpcnN0UmVjdC55O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgJ1hDVUlFbGVtZW50VHlwZUNvbGxlY3Rpb25WaWV3Jzoge1xuICAgICAgICBsZXQgZWxzSW5Sb3cgPSAxOyAvLyB3ZSBrbm93IHRoZXJlIG11c3QgYmUgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIHJvd1xuICAgICAgICBsZXQgZmlyc3RSZWN0ID0gYXdhaXQgdGhpcy5nZXRFbGVtZW50UmVjdChfLmhlYWQoY2hpbGRyZW4pKTtcbiAgICAgICAgbGV0IGluaXRpYWxSZWN0cyA9IFtmaXJzdFJlY3RdO1xuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgY29uc3QgcmVjdCA9IGF3YWl0IHRoaXMuZ2V0RWxlbWVudFJlY3QoY2hpbGRyZW5baV0pO1xuICAgICAgICAgIGluaXRpYWxSZWN0cy5wdXNoKHJlY3QpO1xuICAgICAgICAgIGlmIChyZWN0LnkgIT09IGZpcnN0UmVjdC55KSB7XG4gICAgICAgICAgICBlbHNJblJvdyA9IGk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3BhY2VCZXR3ZWVuRWxzID0gaW5pdGlhbFJlY3RzW2Vsc0luUm93XS55IC0gaW5pdGlhbFJlY3RzW2Vsc0luUm93IC0gMV0ueSAtIGluaXRpYWxSZWN0c1tlbHNJblJvdyAtIDFdLmhlaWdodDtcbiAgICAgICAgY29uc3QgbnVtUm93cyA9IE1hdGguY2VpbChjaGlsZHJlbi5sZW5ndGggLyBlbHNJblJvdyk7XG5cbiAgICAgICAgLy8gYXNzdW1lIGFsbCBjZWxscyBhcmUgdGhlIHNhbWUgaGVpZ2h0XG4gICAgICAgIGNvbnRlbnRIZWlnaHQgPSAobnVtUm93cyAqIGZpcnN0UmVjdC5oZWlnaHQpICsgKHNwYWNlQmV0d2VlbkVscyAqIChudW1Sb3dzIC0gMSkpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBFcnJvcihgUHJvZ3JhbW1pbmcgZXJyb3I6IHR5cGUgJyR7dHlwZX0nIHdhcyBub3QgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYHZhbGlkIGJ1dCBzaG91bGQgaGF2ZSBhbHJlYWR5IGJlZW4gcmVqZWN0ZWRgKTtcbiAgICB9XG4gIH1cbiAgY29uc3Qgc2l6ZSA9IGF3YWl0IHRoaXMuZ2V0U2l6ZShlbCk7XG4gIGNvbnN0IG9yaWdpbiA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcoZWwpO1xuICAvLyBhdHRyaWJ1dGVzIGhhdmUgdG8gYmUgc3RyaW5ncywgc28gc3RyaW5naWZ5IHRoaXMgdXBcbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHtcbiAgICB3aWR0aDogc2l6ZS53aWR0aCxcbiAgICBoZWlnaHQ6IHNpemUuaGVpZ2h0LFxuICAgIHRvcDogb3JpZ2luLnksXG4gICAgbGVmdDogb3JpZ2luLngsXG4gICAgc2Nyb2xsYWJsZU9mZnNldDogY29udGVudEhlaWdodFxuICB9KTtcbn07XG5cbmNvbW1hbmRzLmlzS2V5Ym9hcmRTaG93biA9IGFzeW5jIGZ1bmN0aW9uIGlzS2V5Ym9hcmRTaG93biAoKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnWENVSUVsZW1lbnRUeXBlS2V5Ym9hcmQnLCBmYWxzZSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGlnbikge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcyk7XG5leHBvcnQgeyBjb21tYW5kcyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2VsZW1lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
