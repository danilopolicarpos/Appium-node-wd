"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

let commands = {};

function extractMandatoryOptions(opts = {}, keys) {
  const result = {};

  for (const key of keys) {
    const value = opts[key];

    if (!_lodash.default.isString(value) || _lodash.default.isEmpty(value)) {
      _logger.default.errorAndThrow(`'${key}' is expected to be a valid string. '${value}' is given instead`);
    }

    result[key] = value;
  }

  return result;
}

commands.mobileInstallApp = async function mobileInstallApp(opts = {}) {
  const {
    app
  } = extractMandatoryOptions(opts, ['app']);
  const dstPath = await this.helpers.configureApp(app, '.app');

  _logger.default.info(`Installing '${dstPath}' to the ${this.isRealDevice() ? 'real device' : 'Simulator'} ` + `with UDID ${this.opts.device.udid}`);

  if (!(await _appiumSupport.fs.exists(dstPath))) {
    _logger.default.errorAndThrow(`The application at '${dstPath}' does not exist or is not accessible`);
  }

  try {
    await this.opts.device.installApp(dstPath);

    _logger.default.info(`Installation of '${dstPath}' succeeded`);
  } finally {
    if (dstPath !== app) {
      await _appiumSupport.fs.rimraf(dstPath);
    }
  }
};

commands.mobileIsAppInstalled = async function mobileIsAppInstalled(opts = {}) {
  const {
    bundleId
  } = extractMandatoryOptions(opts, ['bundleId']);
  const installed = await this.opts.device.isAppInstalled(bundleId);

  _logger.default.info(`App '${bundleId}' is${installed ? '' : ' not'} installed`);

  return installed;
};

commands.mobileRemoveApp = async function mobileRemoveApp(opts = {}) {
  const {
    bundleId
  } = extractMandatoryOptions(opts, ['bundleId']);

  _logger.default.info(`Uninstalling the application with bundle identifier '${bundleId}' ` + `from the ${this.isRealDevice() ? 'real device' : 'Simulator'} with UDID ${this.opts.device.udid}`);

  try {
    await this.opts.device.removeApp(bundleId);

    _logger.default.info(`Removal of '${bundleId}' succeeded`);

    return true;
  } catch (err) {
    _logger.default.warn(`Cannot remove '${bundleId}'. Original error: ${err.message}`);

    return false;
  }
};

commands.mobileLaunchApp = async function mobileLaunchApp(opts = {}) {
  const wdaOpts = extractMandatoryOptions(opts, ['bundleId']);

  if (opts.arguments) {
    wdaOpts.arguments = _lodash.default.isArray(opts.arguments) ? opts.arguments : [opts.arguments];
  }

  if (opts.environment) {
    wdaOpts.environment = opts.environment;
  }

  return await this.proxyCommand('/wda/apps/launch', 'POST', wdaOpts);
};

commands.mobileTerminateApp = async function mobileTerminateApp(opts = {}) {
  return await this.proxyCommand('/wda/apps/terminate', 'POST', extractMandatoryOptions(opts, ['bundleId']));
};

commands.mobileActivateApp = async function mobileActivateApp(opts = {}) {
  return await this.proxyCommand('/wda/apps/activate', 'POST', extractMandatoryOptions(opts, ['bundleId']));
};

commands.mobileQueryAppState = async function mobileQueryAppState(opts = {}) {
  return await this.proxyCommand('/wda/apps/state', 'POST', extractMandatoryOptions(opts, ['bundleId']));
};

commands.installApp = async function installApp(appPath) {
  await this.mobileInstallApp({
    app: appPath
  });
};

commands.activateApp = async function activateApp(bundleId, opts = {}) {
  return await this.mobileLaunchApp(Object.assign({}, opts, {
    bundleId
  }));
};

commands.isAppInstalled = async function isAppInstalled(bundleId) {
  return await this.mobileIsAppInstalled({
    bundleId
  });
};

commands.terminateApp = async function terminateApp(bundleId) {
  return await this.mobileTerminateApp({
    bundleId
  });
};

commands.queryAppState = async function queryAppState(bundleId) {
  return await this.mobileQueryAppState({
    bundleId
  });
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hcHAtbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImV4dHJhY3RNYW5kYXRvcnlPcHRpb25zIiwib3B0cyIsImtleXMiLCJyZXN1bHQiLCJrZXkiLCJ2YWx1ZSIsIl8iLCJpc1N0cmluZyIsImlzRW1wdHkiLCJsb2ciLCJlcnJvckFuZFRocm93IiwibW9iaWxlSW5zdGFsbEFwcCIsImFwcCIsImRzdFBhdGgiLCJoZWxwZXJzIiwiY29uZmlndXJlQXBwIiwiaW5mbyIsImlzUmVhbERldmljZSIsImRldmljZSIsInVkaWQiLCJmcyIsImV4aXN0cyIsImluc3RhbGxBcHAiLCJyaW1yYWYiLCJtb2JpbGVJc0FwcEluc3RhbGxlZCIsImJ1bmRsZUlkIiwiaW5zdGFsbGVkIiwiaXNBcHBJbnN0YWxsZWQiLCJtb2JpbGVSZW1vdmVBcHAiLCJyZW1vdmVBcHAiLCJlcnIiLCJ3YXJuIiwibWVzc2FnZSIsIm1vYmlsZUxhdW5jaEFwcCIsIndkYU9wdHMiLCJhcmd1bWVudHMiLCJpc0FycmF5IiwiZW52aXJvbm1lbnQiLCJwcm94eUNvbW1hbmQiLCJtb2JpbGVUZXJtaW5hdGVBcHAiLCJtb2JpbGVBY3RpdmF0ZUFwcCIsIm1vYmlsZVF1ZXJ5QXBwU3RhdGUiLCJhcHBQYXRoIiwiYWN0aXZhdGVBcHAiLCJPYmplY3QiLCJhc3NpZ24iLCJ0ZXJtaW5hdGVBcHAiLCJxdWVyeUFwcFN0YXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmOztBQUVBLFNBQVNDLHVCQUFULENBQWtDQyxJQUFJLEdBQUcsRUFBekMsRUFBNkNDLElBQTdDLEVBQW1EO0FBQ2pELFFBQU1DLE1BQU0sR0FBRyxFQUFmOztBQUNBLE9BQUssTUFBTUMsR0FBWCxJQUFrQkYsSUFBbEIsRUFBd0I7QUFDdEIsVUFBTUcsS0FBSyxHQUFHSixJQUFJLENBQUNHLEdBQUQsQ0FBbEI7O0FBQ0Es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QUE7QUFBRCxHQUF6QixDQUFiO0FBQ0QsQ0FGRDs7ZUFJZTFCLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5cbmxldCBjb21tYW5kcyA9IHt9O1xuXG5mdW5jdGlvbiBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyAob3B0cyA9IHt9LCBrZXlzKSB7XG4gIGNvbnN0IHJlc3VsdCA9IHt9O1xuICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgY29uc3QgdmFsdWUgPSBvcHRzW2tleV07XG4gICAgaWYgKCFfLmlzU3RyaW5nKHZhbHVlKSB8fCBfLmlzRW1wdHkodmFsdWUpKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgJyR7a2V5fScgaXMgZXhwZWN0ZWQgdG8gYmUgYSB2YWxpZCBzdHJpbmcuICcke3ZhbHVlfScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICAgIH1cbiAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmNvbW1hbmRzLm1vYmlsZUluc3RhbGxBcHAgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVJbnN0YWxsQXBwIChvcHRzID0ge30pIHtcbiAgY29uc3Qge2FwcH0gPSBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyhvcHRzLCBbJ2FwcCddKTtcbiAgY29uc3QgZHN0UGF0aCA9IGF3YWl0IHRoaXMuaGVscGVycy5jb25maWd1cmVBcHAoYXBwLCAnLmFwcCcpO1xuICBsb2cuaW5mbyhgSW5zdGFsbGluZyAnJHtkc3RQYXRofScgdG8gdGhlICR7dGhpcy5pc1JlYWxEZXZpY2UoKSA/ICdyZWFsIGRldmljZScgOiAnU2ltdWxhdG9yJ30gYCArXG4gICAgICAgICAgIGB3aXRoIFVESUQgJHt0aGlzLm9wdHMuZGV2aWNlLnVkaWR9YCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGRzdFBhdGgpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSBhcHBsaWNhdGlvbiBhdCAnJHtkc3RQYXRofScgZG9lcyBub3QgZXhpc3Qgb3IgaXMgbm90IGFjY2Vzc2libGVgKTtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMub3B0cy5kZXZpY2UuaW5zdGFsbEFwcChkc3RQYXRoKTtcbiAgICBsb2cuaW5mbyhgSW5zdGFsbGF0aW9uIG9mICcke2RzdFBhdGh9JyBzdWNjZWVkZWRgKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBpZiAoZHN0UGF0aCAhPT0gYXBwKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYoZHN0UGF0aCk7XG4gICAgfVxuICB9XG59O1xuXG5jb21tYW5kcy5tb2JpbGVJc0FwcEluc3RhbGxlZCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZUlzQXBwSW5zdGFsbGVkIChvcHRzID0ge30pIHtcbiAgY29uc3Qge2J1bmRsZUlkfSA9IGV4dHJhY3RNYW5kYXRvcnlPcHRpb25zKG9wdHMsIFsnYnVuZGxlSWQnXSk7XG4gIGNvbnN0IGluc3RhbGxlZCA9IGF3YWl0IHRoaXMub3B0cy5kZXZpY2UuaXNBcHBJbnN0YWxsZWQoYnVuZGxlSWQpO1xuICBsb2cuaW5mbyhgQXBwICcke2J1bmRsZUlkfScgaXMke2luc3RhbGxlZCA/ICcnIDogJyBub3QnfSBpbnN0YWxsZWRgKTtcbiAgcmV0dXJuIGluc3RhbGxlZDtcbn07XG5cbmNvbW1hbmRzLm1vYmlsZVJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVJlbW92ZUFwcCAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtidW5kbGVJZH0gPSBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyhvcHRzLCBbJ2J1bmRsZUlkJ10pO1xuICBsb2cuaW5mbyhgVW5pbnN0YWxsaW5nIHRoZSBhcHBsaWNhdGlvbiB3aXRoIGJ1bmRsZSBpZGVudGlmaWVyICcke2J1bmRsZUlkfScgYCArXG4gICAgYGZyb20gdGhlICR7dGhpcy5pc1JlYWxEZXZpY2UoKSA/ICdyZWFsIGRldmljZScgOiAnU2ltdWxhdG9yJ30gd2l0aCBVRElEICR7dGhpcy5vcHRzLmRldmljZS51ZGlkfWApO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMub3B0cy5kZXZpY2UucmVtb3ZlQXBwKGJ1bmRsZUlkKTtcbiAgICBsb2cuaW5mbyhgUmVtb3ZhbCBvZiAnJHtidW5kbGVJZH0nIHN1Y2NlZWRlZGApO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IHJlbW92ZSAnJHtidW5kbGVJZH0nLiBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn07XG5cbmNvbW1hbmRzLm1vYmlsZUxhdW5jaEFwcCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZUxhdW5jaEFwcCAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHdkYU9wdHMgPSBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyhvcHRzLCBbJ2J1bmRsZUlkJ10pO1xuICBpZiAob3B0cy5hcmd1bWVudHMpIHtcbiAgICB3ZGFPcHRzLmFyZ3VtZW50cyA9IF8uaXNBcnJheShvcHRzLmFyZ3VtZW50cykgPyBvcHRzLmFyZ3VtZW50cyA6IFtvcHRzLmFyZ3VtZW50c107XG4gIH1cbiAgaWYgKG9wdHMuZW52aXJvbm1lbnQpIHtcbiAgICB3ZGFPcHRzLmVudmlyb25tZW50ID0gb3B0cy5lbnZpcm9ubWVudDtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvYXBwcy9sYXVuY2gnLCAnUE9TVCcsIHdkYU9wdHMpO1xufTtcblxuY29tbWFuZHMubW9iaWxlVGVybWluYXRlQXBwID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlVGVybWluYXRlQXBwIChvcHRzID0ge30pIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2FwcHMvdGVybWluYXRlJywgJ1BPU1QnLCBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyhvcHRzLCBbJ2J1bmRsZUlkJ10pKTtcbn07XG5cbmNvbW1hbmRzLm1vYmlsZUFjdGl2YXRlQXBwID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlQWN0aXZhdGVBcHAgKG9wdHMgPSB7fSkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvYXBwcy9hY3RpdmF0ZScsICdQT1NUJywgZXh0cmFjdE1hbmRhdG9yeU9wdGlvbnMob3B0cywgWydidW5kbGVJZCddKSk7XG59O1xuXG4vKipcbiAqIFJldHVybnMgdGhlIGN1cnJlbnQgYXBwbGljYXRpb24gc3RhdGVcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cyAtIE9wdGlvbnMgc2V0LCB3aGljaCBtdXN0IGNvbnRhaW4gYGJ1bmRsZUlkYCBwcm9wZXJ0eVxuICogQHJldHVybnMge251bWJlcn0gVGhlIGFjdHVhbCBhcHBsaWNhdGlvbiBzdGF0ZSBjb2RlLiBTZWVcbiAqIGh0dHBzOi8vZGV2ZWxvcGVyLmFwcGxlLmNvbS9kb2N1bWVudGF0aW9uL3hjdGVzdC94Y3VpYXBwbGljYXRpb25zdGF0ZT9sYW5ndWFnZT1vYmpjXG4gKiB0byBnZXQgdGhlIGxpc3Qgb2YgcG9zc2libGUgdmFsdWVzLlxuICovXG5jb21tYW5kcy5tb2JpbGVRdWVyeUFwcFN0YXRlID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlUXVlcnlBcHBTdGF0ZSAob3B0cyA9IHt9KSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9hcHBzL3N0YXRlJywgJ1BPU1QnLCBleHRyYWN0TWFuZGF0b3J5T3B0aW9ucyhvcHRzLCBbJ2J1bmRsZUlkJ10pKTtcbn07XG5cbmNvbW1hbmRzLmluc3RhbGxBcHAgPSBhc3luYyBmdW5jdGlvbiBpbnN0YWxsQXBwIChhcHBQYXRoKSB7XG4gIGF3YWl0IHRoaXMubW9iaWxlSW5zdGFsbEFwcCh7YXBwOiBhcHBQYXRofSk7XG59O1xuXG5jb21tYW5kcy5hY3RpdmF0ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIGFjdGl2YXRlQXBwIChidW5kbGVJZCwgb3B0cyA9IHt9KSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLm1vYmlsZUxhdW5jaEFwcChPYmplY3QuYXNzaWduKHt9LCBvcHRzLCB7YnVuZGxlSWR9KSk7XG59O1xuXG5jb21tYW5kcy5pc0FwcEluc3RhbGxlZCA9IGFzeW5jIGZ1bmN0aW9uIGlzQXBwSW5zdGFsbGVkIChidW5kbGVJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5tb2JpbGVJc0FwcEluc3RhbGxlZCh7YnVuZGxlSWR9KTtcbn07XG5cbmNvbW1hbmRzLnRlcm1pbmF0ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIHRlcm1pbmF0ZUFwcCAoYnVuZGxlSWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMubW9iaWxlVGVybWluYXRlQXBwKHtidW5kbGVJZH0pO1xufTtcblxuY29tbWFuZHMucXVlcnlBcHBTdGF0ZSA9IGFzeW5jIGZ1bmN0aW9uIHF1ZXJ5QXBwU3RhdGUgKGJ1bmRsZUlkKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLm1vYmlsZVF1ZXJ5QXBwU3RhdGUoe2J1bmRsZUlkfSk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2FwcC1tYW5hZ2VtZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
