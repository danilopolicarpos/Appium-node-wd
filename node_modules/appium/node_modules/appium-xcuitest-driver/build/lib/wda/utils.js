"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.updateProjectFile = updateProjectFile;
exports.resetProjectFile = resetProjectFile;
exports.checkForDependencies = checkForDependencies;
exports.setRealDeviceSecurity = setRealDeviceSecurity;
exports.fixForXcode7 = fixForXcode7;
exports.fixForXcode9 = fixForXcode9;
exports.getAdditionalRunContent = getAdditionalRunContent;
exports.getXctestrunFileName = getXctestrunFileName;
exports.generateXcodeConfigFile = generateXcodeConfigFile;
exports.setXctestrunFile = setXctestrunFile;
exports.getXctestrunFilePath = getXctestrunFilePath;
exports.killProcess = killProcess;
exports.randomInt = randomInt;
exports.getWDAUpgradeTimestamp = getWDAUpgradeTimestamp;
exports.CARTHAGE_ROOT = exports.WDA_RUNNER_BUNDLE_ID = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _lodash = _interopRequireDefault(require("lodash"));

const WDA_RUNNER_BUNDLE_ID = 'com.facebook.WebDriverAgentRunner';
exports.WDA_RUNNER_BUNDLE_ID = WDA_RUNNER_BUNDLE_ID;
const PROJECT_FILE = 'project.pbxproj';
const XCUICOORDINATE_FILE = 'PrivateHeaders/XCTest/XCUICoordinate.h';
const FBMACROS_FILE = 'WebDriverAgentLib/Utilities/FBMacros.h';
const XCUIAPPLICATION_FILE = 'PrivateHeaders/XCTest/XCUIApplication.h';
const FBSESSION_FILE = 'WebDriverAgentLib/Routing/FBSession.m';
const CARTHAGE_ROOT = 'Carthage';
exports.CARTHAGE_ROOT = CARTHAGE_ROOT;

async function replaceInFile(file, find, replace) {
  let contents = await _appiumSupport.fs.readFile(file, 'utf8');
  let newContents = contents.replace(find, replace);

  if (newContents !== contents) {
    await _appiumSupport.fs.writeFile(file, newContents, 'utf8');
  }
}

async function updateProjectFile(agentPath, newBundleId) {
  let projectFilePath = `${agentPath}/${PROJECT_FILE}`;

  try {
    await _appiumSupport.fs.copyFile(projectFilePath, `${projectFilePath}.old`);
    await replaceInFile(projectFilePath, new RegExp(WDA_RUNNER_BUNDLE_ID.replace('.', '\.'), 'g'), newBundleId);

    _logger.default.debug(`Successfully updated '${projectFilePath}' with bundle id '${newBundleId}'`);
  } catch (err) {
    _logger.default.debug(`Error updating project file: ${err.message}`);

    _logger.default.warn(`Unable to update project file '${projectFilePath}' with ` + `bundle id '${newBundleId}'. WebDriverAgent may not start`);
  }
}

async function resetProjectFile(agentPath) {
  let projectFilePath = `${agentPath}/${PROJECT_FILE}`;

  try {
    if (!(await _appiumSupport.fs.exists(`${projectFilePath}.old`))) {
      return;
    }

    await _appiumSupport.fs.mv(`${projectFilePath}.old`, projectFilePath);

    _logger.default.debug(`Successfully reset '${projectFilePath}' with bundle id '${WDA_RUNNER_BUNDLE_ID}'`);
  } catch (err) {
    _logger.default.debug(`Error resetting project file: ${err.message}`);

    _logger.default.warn(`Unable to reset project file '${projectFilePath}' with ` + `bundle id '${WDA_RUNNER_BUNDLE_ID}'. WebDriverAgent has been ` + `modified and not returned to the original state.`);
  }
}

async function checkForDependencies(bootstrapPath, useSsl = false) {
  try {
    let carthagePath = await _appiumSupport.fs.which('carthage');

    _logger.default.debug(`Carthage found: '${carthagePath}'`);
  } catch (err) {
    _logger.default.errorAndThrow('Carthage binary is not found. Install using `brew install carthage` if it is not installed ' + 'and make sure the root folder, where carthage binary is installed, is present in PATH environment variable. ' + `The current PATH value: '${process.env.PATH ? process.env.PATH : '<not defined for the Appium process>'}'`);
  }

  const carthageRoot = _path.default.resolve(bootstrapPath, CARTHAGE_ROOT);

  let areDependenciesUpdated = false;

  if (!(await _appiumSupport.fs.hasAccess(carthageRoot))) {
    _logger.default.debug('Running WebDriverAgent bootstrap script to install dependencies');

    try {
      const args = useSsl ? ['-d', '-D'] : ['-d'];
      await (0, _teen_process.exec)('Scripts/bootstrap.sh', args, {
        cwd: bootstrapPath
      });
      areDependenciesUpdated = true;
    } catch (err) {
      for (const std of ['stdout', 'stderr']) {
        for (const line of (err[std] || '').split('\n')) {
          if (!line.length) {
            continue;
          }

          _logger.default.error(line);
        }
      }

      await _appiumSupport.fs.rimraf(carthageRoot);
      throw err;
    }
  }

  if (!(await _appiumSupport.fs.hasAccess(`${bootstrapPath}/Resources`))) {
    _logger.default.debug('Creating WebDriverAgent resources directory');

    await _appiumSupport.fs.mkdir(`${bootstrapPath}/Resources`);
    areDependenciesUpdated = true;
  }

  if (!(await _appiumSupport.fs.hasAccess(`${bootstrapPath}/Resources/WebDriverAgent.bundle`))) {
    _logger.default.debug('Creating WebDriverAgent resource bundle directory');

    await _appiumSupport.fs.mkdir(`${bootstrapPath}/Resources/WebDriverAgent.bundle`);
    areDependenciesUpdated = true;
  }

  return areDependenciesUpdated;
}

async function setRealDeviceSecurity(keychainPath, keychainPassword) {
  _logger.default.debug('Setting security for iOS device');

  await (0, _teen_process.exec)('security', ['-v', 'list-keychains', '-s', keychainPath]);
  await (0, _teen_process.exec)('security', ['-v', 'unlock-keychain', '-p', keychainPassword, keychainPath]);
  await (0, _teen_process.exec)('security', ['set-keychain-settings', '-t', '3600', '-l', keychainPath]);
}

async function fixXCUICoordinateFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, XCUICOORDINATE_FILE);

  let oldDef = '- (void)pressForDuration:(double)arg1 thenDragToCoordinate:(id)arg2;';
  let newDef = '- (void)pressForDuration:(NSTimeInterval)duration thenDragToCoordinate:(XCUICoordinate *)otherCoordinate;';

  if (!initial) {
    [oldDef, newDef] = [newDef, oldDef];
  }

  await replaceInFile(file, oldDef, newDef);
}

async function fixFBSessionFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, FBSESSION_FILE);

  let oldLine = 'return [FBApplication fb_activeApplication] ?: self.testedApplication;';
  let newLine = 'FBApplication *application = [FBApplication fb_activeApplication] ?: self.testedApplication;\n' + '  return application;';

  if (!initial) {
    [oldLine, newLine] = [newLine, oldLine];
  }

  await replaceInFile(file, oldLine, newLine);
}

async function fixForXcode7(bootstrapPath, initial = true, fixXcode9 = true) {
  if (fixXcode9) {
    await fixForXcode9(bootstrapPath, !initial, false);
  }

  await fixXCUICoordinateFile(bootstrapPath, initial);
  await fixFBSessionFile(bootstrapPath, initial);
}

async function fixFBMacrosFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, FBMACROS_FILE);

  let oldDef = '#define FBStringify(class, property) ({if(NO){[class.new property];} @#property;})';
  let newDef = '#define FBStringify(class, property) ({@#property;})';

  if (!initial) {
    [oldDef, newDef] = [newDef, oldDef];
  }

  await replaceInFile(file, oldDef, newDef);
}

async function fixXCUIApplicationFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, XCUIAPPLICATION_FILE);

  let oldDef = '@property(nonatomic, readonly) NSUInteger state; // @synthesize state=_state;';
  let newDef = '@property XCUIApplicationState state;';

  if (!initial) {
    [oldDef, newDef] = [newDef, oldDef];
  }

  await replaceInFile(file, oldDef, newDef);
}

async function fixForXcode9(bootstrapPath, initial = true, fixXcode7 = true) {
  if (fixXcode7) {
    await fixForXcode7(bootstrapPath, !initial, false);
  }

  await fixFBMacrosFile(bootstrapPath, initial);
  await fixXCUIApplicationFile(bootstrapPath, initial);
}

async function generateXcodeConfigFile(orgId, signingId) {
  _logger.default.debug(`Generating xcode config file for orgId '${orgId}' and signingId ` + `'${signingId}'`);

  let contents = `DEVELOPMENT_TEAM = ${orgId}
CODE_SIGN_IDENTITY = ${signingId}
`;
  let xcconfigPath = await _appiumSupport.tempDir.path('appium-temp.xcconfig');

  _logger.default.debug(`Writing xcode config file to ${xcconfigPath}`);

  await _appiumSupport.fs.writeFile(xcconfigPath, contents, 'utf8');
  return xcconfigPath;
}

async function setXctestrunFile(deviceInfo, sdkVersion, bootstrapPath, wdaRemotePort) {
  const xctestrunFilePath = await getXctestrunFilePath(deviceInfo, sdkVersion, bootstrapPath);
  const xctestRunContent = await _appiumSupport.plist.parsePlistFile(xctestrunFilePath);
  const updateWDAPort = getAdditionalRunContent(deviceInfo.platformName, wdaRemotePort);

  const newXctestRunContent = _lodash.default.merge(xctestRunContent, updateWDAPort);

  await _appiumSupport.plist.updatePlistFile(xctestrunFilePath, newXctestRunContent, true);
  return xctestrunFilePath;
}

function getAdditionalRunContent(platformName, wdaRemotePort) {
  const runner = `WebDriverAgentRunner${(0, _utils.isTvOS)(platformName) ? '_tvOS' : ''}`;
  return {
    [runner]: {
      EnvironmentVariables: {
        USE_PORT: wdaRemotePort
      }
    }
  };
}

async function getXctestrunFilePath(deviceInfo, sdkVersion, bootstrapPath) {
  const sdkBased = [_path.default.resolve(bootstrapPath, `${deviceInfo.udid}_${sdkVersion}.xctestrun`), sdkVersion];
  const platformBased = [_path.default.resolve(bootstrapPath, `${deviceInfo.udid}_${deviceInfo.platformVersion}.xctestrun`), deviceInfo.platformVersion];

  for (const [filePath, version] of [sdkBased, platformBased]) {
    if (await _appiumSupport.fs.exists(filePath)) {
      _logger.default.info(`Using '${filePath}' as xctestrun file`);

      return filePath;
    }

    const originalXctestrunFile = _path.default.resolve(bootstrapPath, getXctestrunFileName(deviceInfo, version));

    if (await _appiumSupport.fs.exists(originalXctestrunFile)) {
      await _appiumSupport.fs.copyFile(originalXctestrunFile, filePath);

      _logger.default.info(`Using '${filePath}' as xctestrun file copied by '${originalXctestrunFile}'`);

      return filePath;
    }
  }

  _logger.default.errorAndThrow(`If you are using 'useXctestrunFile' capability then you ` + `need to have a xctestrun file (expected: ` + `'${_path.default.resolve(bootstrapPath, getXctestrunFileName(deviceInfo, sdkVersion))}')`);
}

function getXctestrunFileName(deviceInfo, version) {
  return (0, _utils.isTvOS)(deviceInfo.platformName) ? `WebDriverAgentRunner_tvOS_appletv${deviceInfo.isRealDevice ? `os${version}-arm64` : `simulator${version}-x86_64`}.xctestrun` : `WebDriverAgentRunner_iphone${deviceInfo.isRealDevice ? `os${version}-arm64` : `simulator${version}-x86_64`}.xctestrun`;
}

async function killProcess(name, proc) {
  if (proc && proc.proc) {
    _logger.default.info(`Shutting down ${name} process (pid ${proc.proc.pid})`);

    try {
      await proc.stop('SIGTERM', 1000);
    } catch (err) {
      if (!err.message.includes(`Process didn't end after`)) {
        throw err;
      }

      _logger.default.debug(`${name} process did not end in a timely fashion: '${err.message}'. ` + `Sending 'SIGKILL'...`);

      try {
        await proc.stop('SIGKILL');
      } catch (err) {
        if (err.message.includes('not currently running')) {
          return;
        }

        throw err;
      }
    }
  }
}

function randomInt(low, high) {
  return Math.floor(Math.random() * (high - low) + low);
}

async function getWDAUpgradeTimestamp(bootstrapPath) {
  const carthageRootPath = _path.default.resolve(bootstrapPath, CARTHAGE_ROOT);

  if (await _appiumSupport.fs.exists(carthageRootPath)) {
    const {
      mtime
    } = await _appiumSupport.fs.stat(carthageRootPath);
    return mtime.getTime();
  }

  return null;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEvdXRpbHMuanMiXSwibmFtZXMiOlsiV0RBX1JVTk5FUl9CVU5ETEVfSUQiLCJQUk9KRUNUX0ZJTEUiLCJYQ1VJQ09PUkRJTkFURV9GSUxFIiwiRkJNQUNST1NfRklMRSIsIlhDVUlBUFBMSUNBVElPTl9GSUxFIiwiRkJTRVNTSU9OX0ZJTEUiLCJDQVJUSEFHRV9ST09UIiwicmVwbGFjZUluRmlsZSIsImZpbGUiLCJmaW5kIiwicmVwbGFjZSIsImNvbnRlbnRzIiwiZnMiLCJyZWFkRmlsZSIsIm5ld0NvbnRlbnRzIiwid3JpdGVGaWxlIiwidXBkYXRlUHJvamVjdEZpbGUiLCJhZ2VudFBhdGgiLCJuZXdCdW5kbGVJZCIsInByb2plY3RGaWxlUGF0aCIsImNvcHlGaWxlIiwiUmVnRXhwIiwibG9nIiwiZGVidWciLCJlcnIiLCJtZXNzYWdlIiwid2FybiIsInJlc2V0UHJvamVjdEZpbGUiLCJleGlzdHMiLCJtdiIsImNoZWNrRm9yRGVwZW5kZW5jaWVzIiwiYm9vdHN0cmFwUGF0aCIsInVzZVNzbCIsImNhcnRoYWdlUGF0aCIsIndoaWNoIiwiZXJyb3JBbmRUaHJvdyIsInByb2Nlc3MiLCJlbnYiLCJQQVRIIiwiY2FydGhhZ2VSb290IiwicGF0aCIsInJlc29sdmUiLCJhcmVEZXBlbmRlbmNpZXNVcGRhdGVkIiwiaGFzQWNjZXNzIiwiYXJncyIsImN3ZCIsInN0ZCIsImxpbmUiLCJzcGxpdCIsImxlbmd0aCIsImVycm9yIiwicmltcmFmIiwibWtkaXIiLCJzZXRSZWFsRGV2aWNlU2VjdXJpdHkiLCJrZXljaGFpblBhdGgiLCJrZXljaGFpblBhc3N3b3JkIiwiZml4WENVSUNvb3JkaW5hdGVGaWxlIiwiaW5pdGlhbCIsIm9sZERlZiIsIm5ld0RlZiIsImZpeEZCU2Vzc2lvbkZpbGUiLCJvbGRMaW5lIiwibmV3TGluZSIsImZpeEZvclhjb2RlNyIsImZpeFhjb2RlOSIsImZpeEZvclhjb2RlOSIsImZpeEZCTWFjcm9zRmlsZSIsImZpeFhDVUlBcHBsaWNhdGlvbkZpbGUiLCJmaXhYY29kZTciLCJnZW5lcmF0ZVhjb2RlQ29uZmlnRmlsZSIsIm9yZ0lkIiwic2lnbmluZ0lkIiwieGNjb25maWdQYXRoIiwidGVtcERpciIsInNldFhjdGVzdHJ1bkZpbGUiLCJkZXZpY2VJbmZvIiwic2RrVmVyc2lvbiIsIndkYVJlbW90ZVBvcnQiLCJ4Y3Rlc3RydW5GaWxlUGF0aCIsImdldFhjdGVzdHJ1bkZpbGVQYXRoIiwieGN0ZXN0UnVuQ29udGVudCIsInBsaXN0IiwicGFyc2VQbGlzdEZpbGUiLCJ1cGRhdGVXREFQb3J0IiwiZ2V0QWRkaXRpb25hbFJ1bkNvbnRlbnQiLCJwbGF0Zm9ybU5hbWUiLCJuZXdYY3Rlc3RSdW5Db250ZW50IiwiXyIsIm1lcmdlIiwidXBkYXRlUGxpc3RGaWxlIiwicnVubmVyIiwiRW52aXJvbm1lbnRWYXJpYWJsZXMiLCJVU0VfUE9SVCIsInNka0Jhc2VkIiwidWRpZCIsInBsYXRmb3JtQmFzZWQiLCJwbGF0Zm9ybVZlcnNpb24iLCJmaWxlUGF0aCIsInZlcnNpb24iLCJpbmZvIiwib3JpZ2luYWxYY3Rlc3RydW5GaWxlIiwiZ2V0WGN0ZXN0cnVuRmlsZU5hbWUiLCJpc1JlYWxEZXZpY2UiLCJraWxsUHJvY2VzcyIsIm5hbWUiLCJwcm9jIiwicGlkIiwic3RvcCIsImluY2x1ZGVzIiwicmFuZG9tSW50IiwibG93IiwiaGlnaCIsIk1hdGgiLCJmbG9vciIsInJhbmRvbSIsImdldFdEQVVwZ3JhZGVUaW1lc3RhbXAiLCJjYXJ0aGFnZVJvb3RQYXRoIiwibXRpbWUiLCJzdGF0IiwiZ2V0VGltZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLG9CQUFvQixHQUFHLG1DQUE3Qjs7QUFDQSxNQUFNQyxZQUFZLEdBQUcsaUJBQXJCO0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUcsd0NBQTVCO0FBQ0EsTUFBTUMsYUFBYSxHQUFHLHdDQUF0QjtB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O0FBQ0Y7QUFDRjs7QUFPRCxTQUFTcUYsU0FBVCxDQUFvQkMsR0FBcEIsRUFBeUJDLElBQXpCLEVBQStCO0FBQzdCLFNBQU9DLElBQUksQ0FBQ0MsS0FBTCxDQUFXRCxJQUFJLENBQUNFLE1BQUwsTUFBaUJILElBQUksR0FBR0QsR0FBeEIsSUFBK0JBLEdBQTFDLENBQVA7QUFDRDs7QUFTRCxlQUFlSyxzQkFBZixDQUF1Q3BGLGFBQXZDLEVBQXNEO0FBQ3BELFFBQU1xRixnQkFBZ0IsR0FBRzVFLGNBQUtDLE9BQUwsQ0FBYVYsYUFBYixFQUE0QnpCLGFBQTVCLENBQXpCOztBQUNBLE1BQUksTUFBTU0sa0JBQUdnQixNQUFILENBQVV3RixnQkFBVixDQUFWLEVBQXVDO0FBQ3JDLFVBQU07QUFBQ0MsTUFBQUE7QUFBRCxRQUFVLE1BQU16RyxrQkFBRzBHLElBQUgsQ0FBUUYsZ0JBQVIsQ0FBdEI7QUFDQSxXQUFPQyxLQUFLLENBQUNFLE9BQU4sRUFBUDtBQUNEOztBQUNELFNBQU8sSUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZnMsIHRlbXBEaXIsIHBsaXN0IH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGlzVHZPUyB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cbmNvbnN0IFdEQV9SVU5ORVJfQlVORExFX0lEID0gJ2NvbS5mYWNlYm9vay5XZWJEcml2ZXJBZ2VudFJ1bm5lcic7XG5jb25zdCBQUk9KRUNUX0ZJTEUgPSAncHJvamVjdC5wYnhwcm9qJztcbmNvbnN0IFhDVUlDT09SRElOQVRFX0ZJTEUgPSAnUHJpdmF0ZUhlYWRlcnMvWENUZXN0L1hDVUlDb29yZGluYXRlLmgnO1xuY29uc3QgRkJNQUNST1NfRklMRSA9ICdXZWJEcml2ZXJBZ2VudExpYi9VdGlsaXRpZXMvRkJNYWNyb3MuaCc7XG5jb25zdCBYQ1VJQVBQTElDQVRJT05fRklMRSA9ICdQcml2YXRlSGVhZGVycy9YQ1Rlc3QvWENVSUFwcGxpY2F0aW9uLmgnO1xuY29uc3QgRkJTRVNTSU9OX0ZJTEUgPSAnV2ViRHJpdmVyQWdlbnRMaWIvUm91dGluZy9GQlNlc3Npb24ubSc7XG5jb25zdCBDQVJUSEFHRV9ST09UID0gJ0NhcnRoYWdlJztcblxuYXN5bmMgZnVuY3Rpb24gcmVwbGFjZUluRmlsZSAoZmlsZSwgZmluZCwgcmVwbGFjZSkge1xuICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShmaWxlLCAndXRmOCcpO1xuXG4gIGxldCBuZXdDb250ZW50cyA9IGNvbnRlbnRzLnJlcGxhY2UoZmluZCwgcmVwbGFjZSk7XG4gIGlmIChuZXdDb250ZW50cyAhPT0gY29udGVudHMpIHtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZmlsZSwgbmV3Q29udGVudHMsICd1dGY4Jyk7XG4gIH1cbn1cblxuLyoqXG4gKiBVcGRhdGUgV2ViRHJpdmVyQWdlbnRSdW5uZXIgcHJvamVjdCBidW5kbGUgSUQgd2l0aCBuZXdCdW5kbGVJZC5cbiAqIFRoaXMgbWV0aG9kIGFzc3VtZXMgcHJvamVjdCBmaWxlIGlzIGluIHRoZSBjb3JyZWN0IHN0YXRlLlxuICogQHBhcmFtIHtzdHJpbmd9IGFnZW50UGF0aCAtIFBhdGggdG8gdGhlIC54Y29kZXByb2ogZGlyZWN0b3J5LlxuICogQHBhcmFtIHtzdHJpbmd9IG5ld0J1bmRsZUlkIHRoZSBuZXcgYnVuZGxlIElEIHVzZWQgdG8gdXBkYXRlLlxuICovXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVQcm9qZWN0RmlsZSAoYWdlbnRQYXRoLCBuZXdCdW5kbGVJZCkge1xuICBsZXQgcHJvamVjdEZpbGVQYXRoID0gYCR7YWdlbnRQYXRofS8ke1BST0pFQ1RfRklMRX1gO1xuICB0cnkge1xuICAgIC8vIEFzc3VtaW5nIHByb2plY3RGaWxlUGF0aCBpcyBpbiB0aGUgY29ycmVjdCBzdGF0ZSwgY3JlYXRlIC5vbGQgZnJvbSBwcm9qZWN0RmlsZVBhdGhcbiAgICBhd2FpdCBmcy5jb3B5RmlsZShwcm9qZWN0RmlsZVBhdGgsIGAke3Byb2plY3RGaWxlUGF0aH0ub2xkYCk7XG4gICAgYXdhaXQgcmVwbGFjZUluRmlsZShwcm9qZWN0RmlsZVBhdGgsIG5ldyBSZWdFeHAoV0RBX1JVTk5FUl9CVU5ETEVfSUQucmVwbGFjZSgnLicsICdcXC4nKSwgJ2cnKSwgbmV3QnVuZGxlSWQpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVzZWxlc3MtZXNjYXBlXG4gICAgbG9nLmRlYnVnKGBTdWNjZXNzZnVsbHkgdXBkYXRlZCAnJHtwcm9qZWN0RmlsZVBhdGh9JyB3aXRoIGJ1bmRsZSBpZCAnJHtuZXdCdW5kbGVJZH0nYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5kZWJ1ZyhgRXJyb3IgdXBkYXRpbmcgcHJvamVjdCBmaWxlOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIGxvZy53YXJuKGBVbmFibGUgdG8gdXBkYXRlIHByb2plY3QgZmlsZSAnJHtwcm9qZWN0RmlsZVBhdGh9JyB3aXRoIGAgK1xuICAgICAgICAgICAgIGBidW5kbGUgaWQgJyR7bmV3QnVuZGxlSWR9Jy4gV2ViRHJpdmVyQWdlbnQgbWF5IG5vdCBzdGFydGApO1xuICB9XG59XG5cbi8qKlxuICogUmVzZXQgV2ViRHJpdmVyQWdlbnRSdW5uZXIgcHJvamVjdCBidW5kbGUgSUQgdG8gY29ycmVjdCBzdGF0ZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBhZ2VudFBhdGggLSBQYXRoIHRvIHRoZSAueGNvZGVwcm9qIGRpcmVjdG9yeS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcmVzZXRQcm9qZWN0RmlsZSAoYWdlbnRQYXRoKSB7XG4gIGxldCBwcm9qZWN0RmlsZVBhdGggPSBgJHthZ2VudFBhdGh9LyR7UFJPSkVDVF9GSUxFfWA7XG4gIHRyeSB7XG4gICAgLy8gcmVzdG9yZSBwcm9qZWN0RmlsZVBhdGggZnJvbSAub2xkIGZpbGVcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhgJHtwcm9qZWN0RmlsZVBhdGh9Lm9sZGApKSB7XG4gICAgICByZXR1cm47IC8vIG5vIG5lZWQgdG8gcmVzZXRcbiAgICB9XG4gICAgYXdhaXQgZnMubXYoYCR7cHJvamVjdEZpbGVQYXRofS5vbGRgLCBwcm9qZWN0RmlsZVBhdGgpO1xuICAgIGxvZy5kZWJ1ZyhgU3VjY2Vzc2Z1bGx5IHJlc2V0ICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYnVuZGxlIGlkICcke1dEQV9SVU5ORVJfQlVORExFX0lEfSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGBFcnJvciByZXNldHRpbmcgcHJvamVjdCBmaWxlOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIGxvZy53YXJuKGBVbmFibGUgdG8gcmVzZXQgcHJvamVjdCBmaWxlICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYCArXG4gICAgICAgICAgICAgYGJ1bmRsZSBpZCAnJHtXREFfUlVOTkVSX0JVTkRMRV9JRH0nLiBXZWJEcml2ZXJBZ2VudCBoYXMgYmVlbiBgICtcbiAgICAgICAgICAgICBgbW9kaWZpZWQgYW5kIG5vdCByZXR1cm5lZCB0byB0aGUgb3JpZ2luYWwgc3RhdGUuYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tGb3JEZXBlbmRlbmNpZXMgKGJvb3RzdHJhcFBhdGgsIHVzZVNzbCA9IGZhbHNlKSB7XG4gIHRyeSB7XG4gICAgbGV0IGNhcnRoYWdlUGF0aCA9IGF3YWl0IGZzLndoaWNoKCdjYXJ0aGFnZScpO1xuICAgIGxvZy5kZWJ1ZyhgQ2FydGhhZ2UgZm91bmQ6ICcke2NhcnRoYWdlUGF0aH0nYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdDYXJ0aGFnZSBiaW5hcnkgaXMgbm90IGZvdW5kLiBJbnN0YWxsIHVzaW5nIGBicmV3IGluc3RhbGwgY2FydGhhZ2VgIGlmIGl0IGlzIG5vdCBpbnN0YWxsZWQgJyArXG4gICAgICAnYW5kIG1ha2Ugc3VyZSB0aGUgcm9vdCBmb2xkZXIsIHdoZXJlIGNhcnRoYWdlIGJpbmFyeSBpcyBpbnN0YWxsZWQsIGlzIHByZXNlbnQgaW4gUEFUSCBlbnZpcm9ubWVudCB2YXJpYWJsZS4gJyArXG4gICAgICBgVGhlIGN1cnJlbnQgUEFUSCB2YWx1ZTogJyR7cHJvY2Vzcy5lbnYuUEFUSCA/IHByb2Nlc3MuZW52LlBBVEggOiAnPG5vdCBkZWZpbmVkIGZvciB0aGUgQXBwaXVtIHByb2Nlc3M+J30nYCk7XG4gIH1cbiAgY29uc3QgY2FydGhhZ2VSb290ID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIENBUlRIQUdFX1JPT1QpO1xuICBsZXQgYXJlRGVwZW5kZW5jaWVzVXBkYXRlZCA9IGZhbHNlO1xuICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhjYXJ0aGFnZVJvb3QpKSB7XG4gICAgbG9nLmRlYnVnKCdSdW5uaW5nIFdlYkRyaXZlckFnZW50IGJvb3RzdHJhcCBzY3JpcHQgdG8gaW5zdGFsbCBkZXBlbmRlbmNpZXMnKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYXJncyA9IHVzZVNzbCA/IFsnLWQnLCAnLUQnXSA6IFsnLWQnXTtcbiAgICAgIGF3YWl0IGV4ZWMoJ1NjcmlwdHMvYm9vdHN0cmFwLnNoJywgYXJncywge2N3ZDogYm9vdHN0cmFwUGF0aH0pO1xuICAgICAgYXJlRGVwZW5kZW5jaWVzVXBkYXRlZCA9IHRydWU7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBwcmludCBvdXQgdGhlIHN0ZG91dCBhbmQgc3RkZXJyIHJlcG9ydHNcbiAgICAgIGZvciAoY29uc3Qgc3RkIG9mIFsnc3Rkb3V0JywgJ3N0ZGVyciddKSB7XG4gICAgICAgIGZvciAoY29uc3QgbGluZSBvZiAoZXJyW3N0ZF0gfHwgJycpLnNwbGl0KCdcXG4nKSkge1xuICAgICAgICAgIGlmICghbGluZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsb2cuZXJyb3IobGluZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIHJlbW92ZSB0aGUgY2FydGhhZ2UgZGlyZWN0b3J5LCBvciBlbHNlIHN1YnNlcXVlbnQgcnVucyB3aWxsIHNlZSBpdCBhbmRcbiAgICAgIC8vIGFzc3VtZSB0aGUgZGVwZW5kZW5jaWVzIGFyZSBhbHJlYWR5IGRvd25sb2FkZWRcbiAgICAgIGF3YWl0IGZzLnJpbXJhZihjYXJ0aGFnZVJvb3QpO1xuXG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG4gIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKGAke2Jvb3RzdHJhcFBhdGh9L1Jlc291cmNlc2ApKSB7XG4gICAgbG9nLmRlYnVnKCdDcmVhdGluZyBXZWJEcml2ZXJBZ2VudCByZXNvdXJjZXMgZGlyZWN0b3J5Jyk7XG4gICAgYXdhaXQgZnMubWtkaXIoYCR7Ym9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzYCk7XG4gICAgYXJlRGVwZW5kZW5jaWVzVXBkYXRlZCA9IHRydWU7XG4gIH1cbiAgaWYgKCFhd2FpdCBmcy5oYXNBY2Nlc3MoYCR7Ym9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzL1dlYkRyaXZlckFnZW50LmJ1bmRsZWApKSB7XG4gICAgbG9nLmRlYnVnKCdDcmVhdGluZyBXZWJEcml2ZXJBZ2VudCByZXNvdXJjZSBidW5kbGUgZGlyZWN0b3J5Jyk7XG4gICAgYXdhaXQgZnMubWtkaXIoYCR7Ym9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzL1dlYkRyaXZlckFnZW50LmJ1bmRsZWApO1xuICAgIGFyZURlcGVuZGVuY2llc1VwZGF0ZWQgPSB0cnVlO1xuICB9XG4gIHJldHVybiBhcmVEZXBlbmRlbmNpZXNVcGRhdGVkO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRSZWFsRGV2aWNlU2VjdXJpdHkgKGtleWNoYWluUGF0aCwga2V5Y2hhaW5QYXNzd29yZCkge1xuICBsb2cuZGVidWcoJ1NldHRpbmcgc2VjdXJpdHkgZm9yIGlPUyBkZXZpY2UnKTtcbiAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJy12JywgJ2xpc3Qta2V5Y2hhaW5zJywgJy1zJywga2V5Y2hhaW5QYXRoXSk7XG4gIGF3YWl0IGV4ZWMoJ3NlY3VyaXR5JywgWyctdicsICd1bmxvY2sta2V5Y2hhaW4nLCAnLXAnLCBrZXljaGFpblBhc3N3b3JkLCBrZXljaGFpblBhdGhdKTtcbiAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJ3NldC1rZXljaGFpbi1zZXR0aW5ncycsICctdCcsICczNjAwJywgJy1sJywga2V5Y2hhaW5QYXRoXSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeFhDVUlDb29yZGluYXRlRmlsZSAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUpIHtcbiAgLy8gdGhlIHdheSB0aGUgdXBkYXRlZCBYQ1Rlc3QgaGVhZGVycyBhcmUgaW4gdGhlIFdEQSBwcm9qZWN0LCBidWlsZGluZyBpblxuICAvLyBYY29kZSA4LjAgY2F1c2VzIGEgZHVwbGljYXRlIGRlY2xhcmF0aW9uIG9mIG1ldGhvZFxuICAvLyBzbyBmaXggdGhlIG9mZmVuZGluZyBsaW5lIGluIHRoZSBsb2NhbCBoZWFkZXJzXG4gIGNvbnN0IGZpbGUgPSBwYXRoLnJlc29sdmUoYm9vdHN0cmFwUGF0aCwgWENVSUNPT1JESU5BVEVfRklMRSk7XG5cbiAgbGV0IG9sZERlZiA9ICctICh2b2lkKXByZXNzRm9yRHVyYXRpb246KGRvdWJsZSlhcmcxIHRoZW5EcmFnVG9Db29yZGluYXRlOihpZClhcmcyOyc7XG4gIGxldCBuZXdEZWYgPSAnLSAodm9pZClwcmVzc0ZvckR1cmF0aW9uOihOU1RpbWVJbnRlcnZhbClkdXJhdGlvbiB0aGVuRHJhZ1RvQ29vcmRpbmF0ZTooWENVSUNvb3JkaW5hdGUgKilvdGhlckNvb3JkaW5hdGU7JztcbiAgaWYgKCFpbml0aWFsKSB7XG4gICAgW29sZERlZiwgbmV3RGVmXSA9IFtuZXdEZWYsIG9sZERlZl07XG4gIH1cbiAgYXdhaXQgcmVwbGFjZUluRmlsZShmaWxlLCBvbGREZWYsIG5ld0RlZik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeEZCU2Vzc2lvbkZpbGUgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlKSB7XG4gIGNvbnN0IGZpbGUgPSBwYXRoLnJlc29sdmUoYm9vdHN0cmFwUGF0aCwgRkJTRVNTSU9OX0ZJTEUpO1xuXG4gIGxldCBvbGRMaW5lID0gJ3JldHVybiBbRkJBcHBsaWNhdGlvbiBmYl9hY3RpdmVBcHBsaWNhdGlvbl0gPzogc2VsZi50ZXN0ZWRBcHBsaWNhdGlvbjsnO1xuICBsZXQgbmV3TGluZSA9ICdGQkFwcGxpY2F0aW9uICphcHBsaWNhdGlvbiA9IFtGQkFwcGxpY2F0aW9uIGZiX2FjdGl2ZUFwcGxpY2F0aW9uXSA/OiBzZWxmLnRlc3RlZEFwcGxpY2F0aW9uO1xcbicgK1xuICAgICAgICAgICAgICAgICcgIHJldHVybiBhcHBsaWNhdGlvbjsnO1xuICBpZiAoIWluaXRpYWwpIHtcbiAgICBbb2xkTGluZSwgbmV3TGluZV0gPSBbbmV3TGluZSwgb2xkTGluZV07XG4gIH1cbiAgYXdhaXQgcmVwbGFjZUluRmlsZShmaWxlLCBvbGRMaW5lLCBuZXdMaW5lKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4Rm9yWGNvZGU3IChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSwgZml4WGNvZGU5ID0gdHJ1ZSkge1xuICBpZiAoZml4WGNvZGU5KSB7XG4gICAgYXdhaXQgZml4Rm9yWGNvZGU5KGJvb3RzdHJhcFBhdGgsICFpbml0aWFsLCBmYWxzZSk7XG4gIH1cbiAgYXdhaXQgZml4WENVSUNvb3JkaW5hdGVGaWxlKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwpO1xuICBhd2FpdCBmaXhGQlNlc3Npb25GaWxlKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhGQk1hY3Jvc0ZpbGUgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlKSB7XG4gIGNvbnN0IGZpbGUgPSBwYXRoLnJlc29sdmUoYm9vdHN0cmFwUGF0aCwgRkJNQUNST1NfRklMRSk7XG5cbiAgbGV0IG9sZERlZiA9ICcjZGVmaW5lIEZCU3RyaW5naWZ5KGNsYXNzLCBwcm9wZXJ0eSkgKHtpZihOTyl7W2NsYXNzLm5ldyBwcm9wZXJ0eV07fSBAI3Byb3BlcnR5O30pJztcbiAgbGV0IG5ld0RlZiA9ICcjZGVmaW5lIEZCU3RyaW5naWZ5KGNsYXNzLCBwcm9wZXJ0eSkgKHtAI3Byb3BlcnR5O30pJztcbiAgaWYgKCFpbml0aWFsKSB7XG4gICAgW29sZERlZiwgbmV3RGVmXSA9IFtuZXdEZWYsIG9sZERlZl07XG4gIH1cbiAgYXdhaXQgcmVwbGFjZUluRmlsZShmaWxlLCBvbGREZWYsIG5ld0RlZik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeFhDVUlBcHBsaWNhdGlvbkZpbGUgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlKSB7XG4gIGNvbnN0IGZpbGUgPSBwYXRoLnJlc29sdmUoYm9vdHN0cmFwUGF0aCwgWENVSUFQUExJQ0FUSU9OX0ZJTEUpO1xuXG4gIGxldCBvbGREZWYgPSAnQHByb3BlcnR5KG5vbmF0b21pYywgcmVhZG9ubHkpIE5TVUludGVnZXIgc3RhdGU7IC8vIEBzeW50aGVzaXplIHN0YXRlPV9zdGF0ZTsnO1xuICBsZXQgbmV3RGVmID0gJ0Bwcm9wZXJ0eSBYQ1VJQXBwbGljYXRpb25TdGF0ZSBzdGF0ZTsnO1xuICBpZiAoIWluaXRpYWwpIHtcbiAgICBbb2xkRGVmLCBuZXdEZWZdID0gW25ld0RlZiwgb2xkRGVmXTtcbiAgfVxuICBhd2FpdCByZXBsYWNlSW5GaWxlKGZpbGUsIG9sZERlZiwgbmV3RGVmKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4Rm9yWGNvZGU5IChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSwgZml4WGNvZGU3ID0gdHJ1ZSkge1xuICBpZiAoZml4WGNvZGU3KSB7XG4gICAgYXdhaXQgZml4Rm9yWGNvZGU3KGJvb3RzdHJhcFBhdGgsICFpbml0aWFsLCBmYWxzZSk7XG4gIH1cbiAgYXdhaXQgZml4RkJNYWNyb3NGaWxlKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwpO1xuICBhd2FpdCBmaXhYQ1VJQXBwbGljYXRpb25GaWxlKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZVhjb2RlQ29uZmlnRmlsZSAob3JnSWQsIHNpZ25pbmdJZCkge1xuICBsb2cuZGVidWcoYEdlbmVyYXRpbmcgeGNvZGUgY29uZmlnIGZpbGUgZm9yIG9yZ0lkICcke29yZ0lkfScgYW5kIHNpZ25pbmdJZCBgICtcbiAgICAgICAgICAgIGAnJHtzaWduaW5nSWR9J2ApO1xuICBsZXQgY29udGVudHMgPSBgREVWRUxPUE1FTlRfVEVBTSA9ICR7b3JnSWR9XG5DT0RFX1NJR05fSURFTlRJVFkgPSAke3NpZ25pbmdJZH1cbmA7XG4gIGxldCB4Y2NvbmZpZ1BhdGggPSBhd2FpdCB0ZW1wRGlyLnBhdGgoJ2FwcGl1bS10ZW1wLnhjY29uZmlnJyk7XG4gIGxvZy5kZWJ1ZyhgV3JpdGluZyB4Y29kZSBjb25maWcgZmlsZSB0byAke3hjY29uZmlnUGF0aH1gKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKHhjY29uZmlnUGF0aCwgY29udGVudHMsICd1dGY4Jyk7XG4gIHJldHVybiB4Y2NvbmZpZ1BhdGg7XG59XG5cbi8qKlxuICogSW5mb3JtYXRpb24gb2YgdGhlIGRldmljZSB1bmRlciB0ZXN0XG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBEZXZpY2VJbmZvXG4gKiBAcHJvcGVydHkge3N0cmluZ30gaXNSZWFsRGV2aWNlIC0gRXF1YWxzIHRvIHRydWUgaWYgdGhlIGN1cnJlbnQgZGV2aWNlIGlzIGEgcmVhbCBkZXZpY2VcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB1ZGlkIC0gVGhlIGRldmljZSBVRElELlxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSBwbGF0Zm9ybSB2ZXJzaW9uIG9mIE9TLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBsYXRmb3JtTmFtZSAtIFRoZSBwbGF0Zm9ybSBuYW1lIG9mIGlPUywgdHZPU1xuKi9cbi8qKlxuICogQ3JlYXRlcyB4Y3Rlc3RydW4gZmlsZSBwZXIgZGV2aWNlICYgcGxhdGZvcm0gdmVyc2lvbi5cbiAqIFdlIGV4cGVjdHMgdG8gaGF2ZSBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVvcyR7c2RrVmVyc2lvbnxwbGF0Zm9ybVZlcnNpb259LWFybTY0LnhjdGVzdHJ1biBmb3IgcmVhbCBkZXZpY2VcbiAqIGFuZCBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVzaW11bGF0b3Ike3Nka1ZlcnNpb258cGxhdGZvcm1WZXJzaW9ufS14ODZfNjQueGN0ZXN0cnVuIGZvciBzaW11bGF0b3IgbG9jYXRlZCBAYm9vdHN0cmFwUGF0aFxuICogTmV3ZXIgWGNvZGUgKFhjb2RlIDEwLjAgYXQgbGVhc3QpIGdlbmVyYXRlIHhjdGVzdHJ1biBmaWxlIGZvbGxvd2luZyBzZGtWZXJzaW9uLlxuICogZS5nLiBYY29kZSB3aGljaCBoYXMgaU9TIFNESyBWZXJzaW9uIDEyLjIgZ2VuZXJhdGUgV2ViRHJpdmVyQWdlbnRSdW5uZXJfaXBob25lc2ltdWxhdG9yLjIteDg2XzY0LnhjdGVzdHJ1blxuICogICAgICBldmVuIGlmIHRoZSBjYXAgaGFzIHBsYXRmb3JtIHZlcnNpb24gMTEuNFxuICpcbiAqIEBwYXJhbSB7RGV2aWNlSW5mb30gZGV2aWNlSW5mb1xuICogQHBhcmFtIHtzdHJpbmd9IHNka1ZlcnNpb24gLSBUaGUgWGNvZGUgU0RLIHZlcnNpb24gb2YgT1MuXG4gKiBAcGFyYW0ge3N0cmluZ30gYm9vdHN0cmFwUGF0aCAtIFRoZSBmb2xkZXIgcGF0aCBjb250YWluaW5nIHhjdGVzdHJ1biBmaWxlLlxuICogQHBhcmFtIHtzdHJpbmd9IHdkYVJlbW90ZVBvcnQgLSBUaGUgcmVtb3RlIHBvcnQgV0RBIGlzIGxpc3RlbmluZyBvbi5cbiAqIEByZXR1cm4ge3N0cmluZ30gcmV0dXJucyB4Y3Rlc3RydW5GaWxlUGF0aCBmb3IgZ2l2ZW4gZGV2aWNlXG4gKiBAdGhyb3dzIGlmIFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZW9zJHtzZGtWZXJzaW9ufHBsYXRmb3JtVmVyc2lvbn0tYXJtNjQueGN0ZXN0cnVuIGZvciByZWFsIGRldmljZVxuICogb3IgV2ViRHJpdmVyQWdlbnRSdW5uZXJfaXBob25lc2ltdWxhdG9yJHtzZGtWZXJzaW9ufHBsYXRmb3JtVmVyc2lvbn0teDg2XzY0LnhjdGVzdHJ1biBmb3Igc2ltdWxhdG9yIGlzIG5vdCBmb3VuZCBAYm9vdHN0cmFwUGF0aCxcbiAqIHRoZW4gaXQgd2lsbCB0aHJvdyBmaWxlIG5vdCBmb3VuZCBleGNlcHRpb25cbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2V0WGN0ZXN0cnVuRmlsZSAoZGV2aWNlSW5mbywgc2RrVmVyc2lvbiwgYm9vdHN0cmFwUGF0aCwgd2RhUmVtb3RlUG9ydCkge1xuICBjb25zdCB4Y3Rlc3RydW5GaWxlUGF0aCA9IGF3YWl0IGdldFhjdGVzdHJ1bkZpbGVQYXRoKGRldmljZUluZm8sIHNka1ZlcnNpb24sIGJvb3RzdHJhcFBhdGgpO1xuICBjb25zdCB4Y3Rlc3RSdW5Db250ZW50ID0gYXdhaXQgcGxpc3QucGFyc2VQbGlzdEZpbGUoeGN0ZXN0cnVuRmlsZVBhdGgpO1xuICBjb25zdCB1cGRhdGVXREFQb3J0ID0gZ2V0QWRkaXRpb25hbFJ1bkNvbnRlbnQoZGV2aWNlSW5mby5wbGF0Zm9ybU5hbWUsIHdkYVJlbW90ZVBvcnQpO1xuICBjb25zdCBuZXdYY3Rlc3RSdW5Db250ZW50ID0gXy5tZXJnZSh4Y3Rlc3RSdW5Db250ZW50LCB1cGRhdGVXREFQb3J0KTtcbiAgYXdhaXQgcGxpc3QudXBkYXRlUGxpc3RGaWxlKHhjdGVzdHJ1bkZpbGVQYXRoLCBuZXdYY3Rlc3RSdW5Db250ZW50LCB0cnVlKTtcblxuICByZXR1cm4geGN0ZXN0cnVuRmlsZVBhdGg7XG59XG5cbi8qKlxuICogUmV0dXJuIHRoZSBXREEgb2JqZWN0IHdoaWNoIGFwcGVuZHMgZXhpc3RpbmcgeGN0ZXN0IHJ1bm5lciBjb250ZW50XG4gKiBAcGFyYW0ge3N0cmluZ30gcGxhdGZvcm1OYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHBsYXRmb3JtXG4gKiBAcGFyYW0ge3N0cmluZ30gdmVyc2lvbiAtIFRoZSBYY29kZSBTREsgdmVyc2lvbiBvZiBPUy5cbiAqIEByZXR1cm4ge29iamVjdH0gcmV0dXJucyBhIHJ1bm5lciBvYmplY3Qgd2hpY2ggaGFzIFVTRV9QT1JUXG4gKi9cbmZ1bmN0aW9uIGdldEFkZGl0aW9uYWxSdW5Db250ZW50IChwbGF0Zm9ybU5hbWUsIHdkYVJlbW90ZVBvcnQpIHtcbiAgY29uc3QgcnVubmVyID0gYFdlYkRyaXZlckFnZW50UnVubmVyJHtpc1R2T1MocGxhdGZvcm1OYW1lKSA/ICdfdHZPUycgOiAnJ31gO1xuXG4gIHJldHVybiB7XG4gICAgW3J1bm5lcl06IHtcbiAgICAgIEVudmlyb25tZW50VmFyaWFibGVzOiB7XG4gICAgICAgIFVTRV9QT1JUOiB3ZGFSZW1vdGVQb3J0XG4gICAgICB9XG4gICAgfVxuICB9O1xufVxuXG4vKipcbiAqIFJldHVybiB0aGUgcGF0aCBvZiB4Y3Rlc3RydW4gaWYgaXQgZXhpc3RzXG4gKiBAcGFyYW0ge0RldmljZUluZm99IGRldmljZUluZm9cbiAqIEBwYXJhbSB7c3RyaW5nfSBzZGtWZXJzaW9uIC0gVGhlIFhjb2RlIFNESyB2ZXJzaW9uIG9mIE9TLlxuICogQHBhcmFtIHtzdHJpbmd9IGJvb3RzdHJhcFBhdGggLSBUaGUgZm9sZGVyIHBhdGggY29udGFpbmluZyB4Y3Rlc3RydW4gZmlsZS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0WGN0ZXN0cnVuRmlsZVBhdGggKGRldmljZUluZm8sIHNka1ZlcnNpb24sIGJvb3RzdHJhcFBhdGgpIHtcbiAgLy8gRmlyc3QgdHJ5IHRoZSBTREsgcGF0aCwgZm9yIFhjb2RlIDEwIChhdCBsZWFzdClcbiAgY29uc3Qgc2RrQmFzZWQgPSBbXG4gICAgcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIGAke2RldmljZUluZm8udWRpZH1fJHtzZGtWZXJzaW9ufS54Y3Rlc3RydW5gKSxcbiAgICBzZGtWZXJzaW9uLFxuICBdO1xuICAvLyBOZXh0IHRyeSBQbGF0Zm9ybSBwYXRoLCBmb3IgZWFybGllciBYY29kZSB2ZXJzaW9uc1xuICBjb25zdCBwbGF0Zm9ybUJhc2VkID0gW1xuICAgIHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBgJHtkZXZpY2VJbmZvLnVkaWR9XyR7ZGV2aWNlSW5mby5wbGF0Zm9ybVZlcnNpb259LnhjdGVzdHJ1bmApLFxuICAgIGRldmljZUluZm8ucGxhdGZvcm1WZXJzaW9uLFxuICBdO1xuXG4gIGZvciAoY29uc3QgW2ZpbGVQYXRoLCB2ZXJzaW9uXSBvZiBbc2RrQmFzZWQsIHBsYXRmb3JtQmFzZWRdKSB7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhmaWxlUGF0aCkpIHtcbiAgICAgIGxvZy5pbmZvKGBVc2luZyAnJHtmaWxlUGF0aH0nIGFzIHhjdGVzdHJ1biBmaWxlYCk7XG4gICAgICByZXR1cm4gZmlsZVBhdGg7XG4gICAgfVxuICAgIGNvbnN0IG9yaWdpbmFsWGN0ZXN0cnVuRmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBnZXRYY3Rlc3RydW5GaWxlTmFtZShkZXZpY2VJbmZvLCB2ZXJzaW9uKSk7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhvcmlnaW5hbFhjdGVzdHJ1bkZpbGUpKSB7XG4gICAgICAvLyBJZiB0aGlzIGlzIGZpcnN0IHRpbWUgcnVuIGZvciBnaXZlbiBkZXZpY2UsIHRoZW4gZmlyc3QgZ2VuZXJhdGUgeGN0ZXN0cnVuIGZpbGUgZm9yIGRldmljZS5cbiAgICAgIC8vIFdlIG5lZWQgdG8gaGF2ZSBhIHhjdGVzdHJ1biBmaWxlICoqcGVyIGRldmljZSoqIGJlY2F1c2Ugd2UgY2FudCBub3QgaGF2ZSBzYW1lIHdkYSBwb3J0IGZvciBhbGwgZGV2aWNlcy5cbiAgICAgIGF3YWl0IGZzLmNvcHlGaWxlKG9yaWdpbmFsWGN0ZXN0cnVuRmlsZSwgZmlsZVBhdGgpO1xuICAgICAgbG9nLmluZm8oYFVzaW5nICcke2ZpbGVQYXRofScgYXMgeGN0ZXN0cnVuIGZpbGUgY29waWVkIGJ5ICcke29yaWdpbmFsWGN0ZXN0cnVuRmlsZX0nYCk7XG4gICAgICByZXR1cm4gZmlsZVBhdGg7XG4gICAgfVxuICB9XG5cbiAgbG9nLmVycm9yQW5kVGhyb3coYElmIHlvdSBhcmUgdXNpbmcgJ3VzZVhjdGVzdHJ1bkZpbGUnIGNhcGFiaWxpdHkgdGhlbiB5b3UgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYG5lZWQgdG8gaGF2ZSBhIHhjdGVzdHJ1biBmaWxlIChleHBlY3RlZDogYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCcke3BhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBnZXRYY3Rlc3RydW5GaWxlTmFtZShkZXZpY2VJbmZvLCBzZGtWZXJzaW9uKSl9JylgKTtcbn1cblxuXG4vKipcbiAqIFJldHVybiB0aGUgbmFtZSBvZiB4Y3Rlc3RydW4gZmlsZVxuICogQHBhcmFtIHtEZXZpY2VJbmZvfSBkZXZpY2VJbmZvXG4gKiBAcGFyYW0ge3N0cmluZ30gdmVyc2lvbiAtIFRoZSBYY29kZSBTREsgdmVyc2lvbiBvZiBPUy5cbiAqIEByZXR1cm4ge3N0cmluZ30gcmV0dXJucyB4Y3Rlc3RydW5GaWxlUGF0aCBmb3IgZ2l2ZW4gZGV2aWNlXG4gKi9cbmZ1bmN0aW9uIGdldFhjdGVzdHJ1bkZpbGVOYW1lIChkZXZpY2VJbmZvLCB2ZXJzaW9uKSB7XG4gIHJldHVybiBpc1R2T1MoZGV2aWNlSW5mby5wbGF0Zm9ybU5hbWUpXG4gICAgPyBgV2ViRHJpdmVyQWdlbnRSdW5uZXJfdHZPU19hcHBsZXR2JHtkZXZpY2VJbmZvLmlzUmVhbERldmljZSA/IGBvcyR7dmVyc2lvbn0tYXJtNjRgIDogYHNpbXVsYXRvciR7dmVyc2lvbn0teDg2XzY0YH0ueGN0ZXN0cnVuYFxuICAgIDogYFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZSR7ZGV2aWNlSW5mby5pc1JlYWxEZXZpY2UgPyBgb3Mke3ZlcnNpb259LWFybTY0YCA6IGBzaW11bGF0b3Ike3ZlcnNpb259LXg4Nl82NGB9LnhjdGVzdHJ1bmA7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGtpbGxQcm9jZXNzIChuYW1lLCBwcm9jKSB7XG4gIGlmIChwcm9jICYmIHByb2MucHJvYykge1xuICAgIGxvZy5pbmZvKGBTaHV0dGluZyBkb3duICR7bmFtZX0gcHJvY2VzcyAocGlkICR7cHJvYy5wcm9jLnBpZH0pYCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHByb2Muc3RvcCgnU0lHVEVSTScsIDEwMDApO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKCFlcnIubWVzc2FnZS5pbmNsdWRlcyhgUHJvY2VzcyBkaWRuJ3QgZW5kIGFmdGVyYCkpIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGAke25hbWV9IHByb2Nlc3MgZGlkIG5vdCBlbmQgaW4gYSB0aW1lbHkgZmFzaGlvbjogJyR7ZXJyLm1lc3NhZ2V9Jy4gYCArXG4gICAgICAgICAgICAgICAgYFNlbmRpbmcgJ1NJR0tJTEwnLi4uYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBwcm9jLnN0b3AoJ1NJR0tJTEwnKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5jbHVkZXMoJ25vdCBjdXJyZW50bHkgcnVubmluZycpKSB7XG4gICAgICAgICAgLy8gdGhlIHByb2Nlc3MgZW5kZWQgYnV0IGZvciBzb21lIHJlYXNvbiB3ZSB3ZXJlIG5vdCBpbmZvcm1lZFxuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogR2VuZXJhdGUgYSByYW5kb20gaW50ZWdlci5cbiAqXG4gKiBAcmV0dXJuIHtudW1iZXJ9IEEgcmFuZG9tIGludGVnZXIgbnVtYmVyIGluIHJhbmdlIFtsb3csIGhpZ2h0KS4gYGxvd2BgIGlzIGluY2x1c2l2ZSBhbmQgYGhpZ2hgIGlzIGV4Y2x1c2l2ZS5cbiAqL1xuZnVuY3Rpb24gcmFuZG9tSW50IChsb3csIGhpZ2gpIHtcbiAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChoaWdoIC0gbG93KSArIGxvdyk7XG59XG5cbi8qKlxuICogUmV0cmlldmVzIFdEQSB1cGdyYWRlIHRpbWVzdGFtcFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBib290c3RyYXBQYXRoIFRoZSBmdWxsIHBhdGggdG8gdGhlIGZvbGRlciB3aGVyZSBXREEgc291cmNlIGlzIGxvY2F0ZWRcbiAqIEByZXR1cm4gez9udW1iZXJ9IFRoZSBVTklYIHRpbWVzdGFtcCBvZiB0aGUgY2FydGhhZ2Ugcm9vdCBmb2xkZXIsIHdoZXJlIGRlcGVuZGVuY2llcyBhcmUgZG93bmxvYWRlZC5cbiAqIFRoaXMgZm9sZGVyIGlzIGNyZWF0ZWQgb25seSBvbmNlIG9uIG1vZHVsZSB1cGdyYWRlL2ZpcnN0IGluc3RhbGwuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldFdEQVVwZ3JhZGVUaW1lc3RhbXAgKGJvb3RzdHJhcFBhdGgpIHtcbiAgY29uc3QgY2FydGhhZ2VSb290UGF0aCA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBDQVJUSEFHRV9ST09UKTtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhjYXJ0aGFnZVJvb3RQYXRoKSkge1xuICAgIGNvbnN0IHttdGltZX0gPSBhd2FpdCBmcy5zdGF0KGNhcnRoYWdlUm9vdFBhdGgpO1xuICAgIHJldHVybiBtdGltZS5nZXRUaW1lKCk7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCB7IHVwZGF0ZVByb2plY3RGaWxlLCByZXNldFByb2plY3RGaWxlLCBjaGVja0ZvckRlcGVuZGVuY2llcyxcbiAgc2V0UmVhbERldmljZVNlY3VyaXR5LCBmaXhGb3JYY29kZTcsIGZpeEZvclhjb2RlOSwgZ2V0QWRkaXRpb25hbFJ1bkNvbnRlbnQsXG4gIGdldFhjdGVzdHJ1bkZpbGVOYW1lLCBnZW5lcmF0ZVhjb2RlQ29uZmlnRmlsZSwgc2V0WGN0ZXN0cnVuRmlsZSxcbiAgZ2V0WGN0ZXN0cnVuRmlsZVBhdGgsIGtpbGxQcm9jZXNzLCByYW5kb21JbnQsIFdEQV9SVU5ORVJfQlVORExFX0lELFxuICBnZXRXREFVcGdyYWRlVGltZXN0YW1wLCBDQVJUSEFHRV9ST09UIH07XG4iXSwiZmlsZSI6ImxpYi93ZGEvdXRpbHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
