"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createSim = createSim;
exports.getExistingSim = getExistingSim;
exports.runSimulatorReset = runSimulatorReset;
exports.installToSimulator = installToSimulator;
exports.shutdownSimulator = shutdownSimulator;
exports.shutdownOtherSimulators = shutdownOtherSimulators;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _appiumIosSimulator = require("appium-ios-simulator");

var _nodeSimctl = require("node-simctl");

var _utils = require("./utils");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _appiumSupport = require("appium-support");

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _desiredCaps = require("./desired-caps");

const INSTALL_DAEMON_CACHE = 'com.apple.mobile.installd.staging';

async function createSim(caps, platform = _desiredCaps.PLATFORM_NAME_IOS) {
  const appiumTestDeviceName = `appiumTest-${_uuidJs.default.create().toString().toUpperCase()}-${caps.deviceName}`;
  const udid = await (0, _nodeSimctl.createDevice)(appiumTestDeviceName, caps.deviceName, caps.platformVersion, {
    platform
  });
  return await (0, _appiumIosSimulator.getSimulator)(udid);
}

async function getExistingSim(opts) {
  const devices = await (0, _nodeSimctl.getDevices)(opts.platformVersion);
  const appiumTestDeviceName = `appiumTest-${opts.deviceName}`;
  let appiumTestDevice;

  for (const device of _lodash.default.values(devices)) {
    if (device.name === opts.deviceName) {
      return await (0, _appiumIosSimulator.getSimulator)(device.udid);
    }

    if (device.name === appiumTestDeviceName) {
      appiumTestDevice = device;
    }
  }

  if (appiumTestDevice) {
    _logger.default.warn(`Unable to find device '${opts.deviceName}'. Found '${appiumTestDevice.name}' (udid: '${appiumTestDevice.udid}') instead`);

    return await (0, _appiumIosSimulator.getSimulator)(appiumTestDevice.udid);
  }

  return null;
}

async function shutdownSimulator(device) {
  await (0, _utils.resetXCTestProcesses)(device.udid, true);
  await device.shutdown();
}

async function runSimulatorReset(device, opts) {
  if (opts.noReset && !opts.fullReset) {
    _logger.default.debug('Reset: noReset is on. Leaving simulator as is');

    return;
  }

  if (!device) {
    _logger.default.debug('Reset: no device available. Skipping');

    return;
  }

  if (opts.fullReset) {
    _logger.default.debug('Reset: fullReset is on. Cleaning simulator');

    await shutdownSimulator(device);
    let isKeychainsBackupSuccessful = false;

    if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      isKeychainsBackupSuccessful = await device.backupKeychains();
    }

    await device.clean();

    if (isKeychainsBackupSuccessful) {
      await device.restoreKeychains(opts.keychainsExcludePatterns || []);

      _logger.default.info(`Successfully restored keychains after full reset`);
    } else if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      _logger.default.warn('Cannot restore keychains after full reset, because ' + 'the backup operation did not succeed');
    }
  } else if (opts.bundleId) {
    if (await device.isRunning()) {
      if (opts.enforceSimulatorShutdown) {
        await shutdownSimulator(device);
      } else {
        try {
          await (0, _nodeSimctl.terminate)(device.udid, opts.bundleId);
        } catch (err) {
          _logger.default.warn(`Reset: failed to terminate Simulator application with id "${opts.bundleId}"`);
        }
      }
    }

    if (opts.app) {
      _logger.default.info('Not scrubbing third party app in anticipation of uninstall');

      return;
    }

    const isSafari = (opts.browserName || '').toLowerCase() === 'safari';

    try {
      if (isSafari) {
        await device.cleanSafari();
      } else {
        await device.scrubCustomApp(_path.default.basename(opts.app), opts.bundleId);
      }
    } catch (err) {
      _logger.default.warn(err.message);

      _logger.default.warn(`Reset: could not scrub ${isSafari ? 'Safari browser' : 'application with id "' + opts.bundleId + '"'}. Leaving as is.`);
    }
  }
}

async function installToSimulator(device, app, bundleId, noReset = true) {
  if (!app) {
    _logger.default.debug('No app path is given. Nothing to install.');

    return;
  }

  if (bundleId) {
    if (await device.isAppInstalled(bundleId)) {
      if (noReset) {
        _logger.default.debug(`App '${bundleId}' is already installed. No need to reinstall.`);

        return;
      }

      _logger.default.debug(`Reset requested. Removing app with id '${bundleId}' from the device`);

      await device.removeApp(bundleId);
    }
  }

  const installdCacheRoot = _path.default.resolve(device.getDir(), 'Library', 'Caches', INSTALL_DAEMON_CACHE);

  let tmpRoot = null;

  if (await _appiumSupport.fs.exists(installdCacheRoot)) {
    tmpRoot = await _appiumSupport.tempDir.openDir();

    _logger.default.debug('Cleaning installd cache to save the disk space');

    await _appiumSupport.fs.mv(installdCacheRoot, _path.default.resolve(tmpRoot, INSTALL_DAEMON_CACHE), {
      mkdirp: true
    });
    await (0, _appiumSupport.mkdirp)(installdCacheRoot);
  }

  _logger.default.debug(`Installing '${app}' on Simulator with UUID '${device.udid}'...`);

  try {
    try {
      await device.installApp(app);
    } catch (e) {
      _logger.default.info(`Got an error on '${app}' install: ${e.message}`);

      if (e.message.includes('MIInstallerErrorDomain') && tmpRoot) {
        _logger.default.info(`installd requires the cache to be available in order to install '${app}'. ` + `Restoring the cache`);

        await _appiumSupport.fs.rimraf(installdCacheRoot);
        await _appiumSupport.fs.mv(_path.default.resolve(tmpRoot, INSTALL_DAEMON_CACHE), installdCacheRoot, {
          mkdirp: true
        });
      }

      _logger.default.info('Retrying application install');

      await device.installApp(app);
    }

    _logger.default.debug('The app has been installed successfully.');
  } finally {
    if (tmpRoot && (await _appiumSupport.fs.exists(tmpRoot))) {
      await _appiumSupport.fs.rimraf(tmpRoot);
    }
  }
}

async function shutdownOtherSimulators(currentDevice) {
  const allDevices = _lodash.default.flatMap(_lodash.default.values((await (0, _nodeSimctl.getDevices)())));

  const otherBootedDevices = allDevices.filter(device => device.udid !== currentDevice.udid && device.state === 'Booted');

  if (_lodash.default.isEmpty(otherBootedDevices)) {
    _logger.default.info('No other running simulators have been detected');

    return;
  }

  _logger.default.info(`Detected ${otherBootedDevices.length} other running Simulator${otherBootedDevices.length === 1 ? '' : 's'}.` + `Shutting ${otherBootedDevices.length === 1 ? 'it' : 'them'} down...`);

  for (const {
    udid
  } of otherBootedDevices) {
    await (0, _utils.resetXCTestProcesses)(udid, true);
    await (0, _nodeSimctl.shutdown)(udid);
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3ItbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJJTlNUQUxMX0RBRU1PTl9DQUNIRSIsImNyZWF0ZVNpbSIsImNhcHMiLCJwbGF0Zm9ybSIsIlBMQVRGT1JNX05BTUVfSU9TIiwiYXBwaXVtVGVzdERldmljZU5hbWUiLCJVVUlEIiwiY3JlYXRlIiwidG9TdHJpbmciLCJ0b1VwcGVyQ2FzZSIsImRldmljZU5hbWUiLCJ1ZGlkIiwicGxhdGZvcm1WZXJzaW9uIiwiZ2V0RXhpc3RpbmdTaW0iLCJvcHRzIiwiZGV2aWNlcyIsImFwcGl1bVRlc3REZXZpY2UiLCJkZXZpY2UiLCJfIiwidmFsdWVzIiwibmFtZSIsImxvZyIsIndhcm4iLCJzaHV0ZG93blNpbXVsYXRvciIsInNodXRkb3duIiwicnVuU2ltdWxhdG9yUmVzZXQiLCJub1Jlc2V0IiwiZnVsbFJlc2V0IiwiZGVidWciLCJpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwiLCJrZXljaGFpbnNFeGNsdWRlUGF0dGVybnMiLCJrZWVwS2V5Q2hhaW5zIiwiYmFja3VwS2V5Y2hhaW5zIiwiY2xlYW4iLCJyZXN0b3JlS2V5Y2hhaW5zIiwiaW5mbyIsImJ1bmRsZUlkIiwiaXNSdW5uaW5nIiwiZW5mb3JjZVNpbXVsYXRvclNodXRkb3duIiwiZXJyIiwiYXBwIiwiaXNTYWZhcmkiLCJicm93c2VyTmFtZSIsInRvTG93ZXJDYXNlIiwiY2xlYW5TYWZhcmkiLCJzY3J1YkN1c3RvbUFwcCIsInBhdGgiLCJiYXNlbmFtZSIsIm1lc3NhZ2UiLCJpbnN0YWxsVG9TaW11bGF0b3IiLCJpc0FwcEluc3RhbGxlZCIsInJlbW92ZUFwcCIsImluc3RhbGxkQ2FjaGVSb290IiwicmVzb2x2ZSIsImdldERpciIsInRtcFJvb3QiLCJmcyIsImV4aXN0cyIsInRlbXBEaXIiLCJvcGVuRGlyIiwibXYiLCJta2RpcnAiLCJpbnN0YWxsQXBwIiwiZSIsImluY2x1ZGVzIiwicmltcmFmIiwic2h1dGRvd25PdGhlclNpbXVsYXRvcnMiLCJjdXJyZW50RGV2aWNlIiwiYWxsRGV2aWNlcyIsImZsYXRNYXAiLCJvdGhlckJvb3RlZERldmljZXMiLCJmaWx0ZXIiLCJzdGF0ZSIsImlzRW1wdHkiLCJsZW5ndGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxvQkFBb0IsR0FBRyxtQ0FBN0I7O0FBZ0JBLGVBQWVDLFNBQWYsQ0FBMEJDLElBQTFCLEVBQWdDQyxRQUFRLEdBQUdDLDhCQUEzQyxFQUE4RDtBQUM1RCxRQUFNQyxvQkFBb0IsR0FBSSxjQUFhQyxnQkFBS0MsTUFBTCxHQUFjQyxRQUFkLEdBQXlCQyxXQUF6QixFQUF1QyxJQUFHUCxJQUFJLENBQUNRLFVBQVcsRUFBckc7QUFDQSxRQUFNQyxJQUFJLEdBQUcsTUFBTSw4QkFDakJOLG9CQURpQixFQUVqQkgsSUFBSSxDQUFDUSxVQUZZLEVBR2pCUixJQUFJLENBQUNVLGVBSFksRUFJakI7QUFBRVQsSUFBQUE7QUFBRixHQUppQixDQUFuQjtBQU1BLFNBQU8sTUFBTSxzQ0FBYVEsSUFBYixDQUFiO0FBQ0Q7O0FBVUQsZUFBZUUsY0FBZixDQUErQkMsSUFBL0IsRUFBcUM7QUFDbkMsUUFBTUMsT0FBTyxHQUFHLE1BQU0sNEJBQVdELElBQUksQ0FBQ0YsZUFBaEIsQ0FBdEI7QUFDQSxRQUFNUCxvQkFBb0IsR0FBSSxjQUFhUyxJQUFJLENBQUNKLFVBQVcsRUFBM0Q7QUFFQSxNQUFJTSxnQkFBSjs7QUFFQSxPQUFLLE1BQU1DLE1BQVgsSUFBcUJDLGdCQUFFQyxNQUFGLENBQVNKLE9BQVQsQ0FBckIsRUFBd0M7QUFDdEMsUUFBSUUsTUFBTSxDQUFDRyxJQUFQLEtBQWdCTixJQUFJLENBQUNKLFVBQXpCLEVBQXFDO0FBQ25DLGFBQU8sTUFBTSxzQ0FBYU8sTUFBTSxDQUFDTixJQUFwQixDQUFiO0FBQ0Q7O0FBRUQsUUFBSU0sTUFBTSxDQUFDRyxJQUFQLEtBQWdCZixvQkFBcEIsRUFBMEM7QUFDeENXLE1BQUFBLGdCQUFnQixHQUFHQyxNQUFuQjtBQUNEO0FBQ0Y7O0FBRUQsTUFBSUQsZ0JBQUosRUFBc0I7QUFDcEJLLG9CQUFJQyxJQUFKLENBQVUsMEJBQXlCUixJQUFJLENBQUNKLFVBQVcsYUFBWU0sZ0JBQWdCLENBQUNJLElBQUssYUFBWUosZ0JBQWdCLENBQUNMLElBQUssWUFBdkg7O0FBQ0EsV0FBTyxNQUFNLHNDQUFhSyxnQkFBZ0IsQ0FBQ0wsSUFBOUIsQ0FBYjtBQUNEOztBQUNELFNBQU8sSUFBUDtBQUNEOztBQUVELGVBQWVZLGlCQUFmLENBQWtDTixNQUFsQyxFQUEwQztBQUV4QyxRQUFNLGlDQUFxQkEsTUFBTSxDQUFDTixJQUE1QixFQUFrQyxJQUFsQyxDQUFOO0FBQ0EsUUFBTU0sTUFBTSxDQUFDTyxRQUFQLEVBQU47QUFDRDs7QUFFRCxlQUFlQyxpQkFBZixDQUFrQ1IsTUFBbEMsRUFBMENILElBQTFDLEVBQWdEO0FBQzlDLE1BQUlBLElBQUksQ0FBQ1ksT0FBTCxJQUFnQixDQUFDWixJQUFJLENBQUNhLFNBQTFCLEVBQXFDO0FBRW5DTixvQkFBSU8sS0FBSixDQUFVLCtDQUFWOztBQUNBO0FBQ0Q7O0FBRUQsTUFBSSxDQUFDWCxNQUFMLEVBQWE7QUFDWEksb0JBQUlPLEtBQUosQ0FBVSxzQ0FBVjs7QUFDQTtBQUNEOztBQUVELE1BQUlkLElBQUksQ0FBQ2EsU0FBVCxFQUFvQjtBQUNsQk4sb0JBQUlPLEtBQUosQ0FBVSw0Q0FBVjs7QUFDQSxVQUFNTCxpQkFBaUIsQ0FBQ04sTUFBRCxDQUF2QjtBQUNBLFFBQUlZLDJCQUEyQixHQUFHLEtBQWxDOztBQUNBLFFBQUlmLElBQUksQ0FBQ2dCLHdCQUFMLElBQWlDaEIsSUFBSSxDQUFDaUIsYUFBMUMsRUFBeUQ7QUFDdkRGLE1BQUFBLDJCQUEyQixHQUFHLE1BQU1aLE1BQU0sQ0FBQ2UsZUFBUCxFQUFwQztBQUNEOztBQUNELFVBQU1mLE1BQU0sQ0FBQ2dCLEtBQVAsRUFBTjs7QUFDQSxRQUFJSiwyQkFBSixFQUFpQztBQUMvQixZQUFNWixNQUFNLENBQUNpQixnQkFBUCxDQUF3QnBCLElBQUksQ0FBQ2dCLHdCQUFMLElBQWlDLEVBQXpELENBQU47O0FBQ0FULHNCQUFJYyxJQUFKLENBQVUsa0RBQVY7QUFDRCxLQUhELE1BR08sSUFBSXJCLElBQUksQ0FBQ2dCLHdCQUFMLElBQWlDaEIsSUFBSSxDQUFDaUIsYUFBMUMsRUFBeUQ7QUFDOURWLHNCQUFJQyxJQUFKLENBQVMsd0RBQ0Esc0NBRFQ7QUFFRDtBQUNGLEdBZkQsTUFlTyxJQUFJUixJQUFJLENBQUNzQixRQUFULEVBQW1CO0FBR3hCLFFBQUksTUFBTW5CLE1BQU0sQ0FBQ29CLFNBQVAsRUFBVixFQUE4QjtBQUM1QixVQUFJdkIsSUFBSSxDQUFDd0Isd0JBQVQsRUFBbUM7QUFDakMsY0FBTWYsaUJBQWlCLENBQUNOLE1BQUQsQ0FBdkI7QUFDRCxPQUZELE1BRU87QUFDTCxZQUFJO0FBQ0YsZ0JBQU0sMkJBQVVBLE1BQU0sQ0FBQ04sSUFBakIsRUFBdUJHLElBQUksQ0FBQ3NCLFFBQTVCLENBQU47QUFDRCxTQUZELENBRUUsT0FBT0csR0FBUCxFQUFZO0FBQ1psQiwwQkFBSUMsSUFBSixDQUFVLDZEQUE0RFIsSUFBSSxDQUFDc0IsUUFBUyxHQUFwRjtBQUNEO0FBQ0Y7QUFDRjs7QUFDRCxRQUFJdEIsSUFBSSxDQUFDMEIsR0FBVCxFQUFjO0FBQ1puQixzQkFBSWMsSUFBSixDQUFTLDREQUFUOztBQUNBO0FBQ0Q7O0FBQ0QsVUFBTU0sUUFBUSxHQUFHLENBQUMzQixJQUFJLENBQUM0QixXQUFMLElBQW9CLEVBQXJCLEVBQXlCQyxXQUF6QixPQUEyQyxRQUE1RDs7QUFDQSxRQUFJO0FBQ0YsVUFBSUYsUUFBSixFQUFjO0FBQ1osY0FBTXhCLE1BQU0sQ0FBQzJCLFdBQVAsRUFBTjtBQUNELE9BRkQsTUFFTztBQUNMLGNBQU0zQixNQUFNLENBQUM0QixjQUFQLENBQXNCQyxjQUFLQyxRQUFMLENBQWNqQyxJQUFJLENBQUMwQixHQUFuQixDQUF0QixFQUErQzFCLElBQUksQ0FBQ3NCLFFBQXBELENBQU47QUFDRDtBQUNGLEtBTkQsQ0FNRSxPQUFPRyxHQUFQLEVBQVk7QUFDWmxCLHNCQUFJQyxJQUFKLENBQVNpQixHQUFHLENBQUNTLE9BQWI7O0FBQ0EzQixzQkFBSUMsSUFBSixDQUFVLDBCQUF5Qm1CLFFBQVEsR0FBRyxnQkFBSCxHQUFzQiwwQkFBMEIzQixJQUFJLENBQUNzQixRQUEvQixHQUEwQyxHQUFJLGtCQUEvRztBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxlQUFlYSxrQkFBZixDQUFtQ2hDLE1BQW5DLEVBQTJDdUIsR0FBM0MsRUFBZ0RKLFFBQWhELEVBQTBEVixPQUFPLEdBQUcsSUFBcEUsRUFBMEU7QUFDeEUsTUFBSSxDQUFDYyxHQUFMLEVBQVU7QUFDUm5CLG9CQUFJTyxLQUFKLENBQVUsMkNBQVY7O0FBQ0E7QUFDRDs7QUFFRCxNQUFJUSxRQUFKLEVBQWM7QUFDWixRQUFJLE1BQU1uQixNQUFNLENBQUNpQyxjQUFQLENBQXNCZCxRQUF0QixDQUFWLEVBQTJDO0FBQ3pDLFVBQUlWLE9BQUosRUFBYTtBQUNYTCx3QkFBSU8sS0FBSixDQUFXLFFBQU9RLFFBQVMsK0NBQTNCOztBQUNBO0FBQ0Q7O0FBQ0RmLHNCQUFJTyxLQUFKLENBQVcsMENBQXlDUSxRQUFTLG1CQUE3RDs7QUFDQSxZQUFNbkIsTUFBTSxDQUFDa0MsU0FBUCxDQUFpQmYsUUFBakIsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsUUFBTWdCLGlCQUFpQixHQUFHTixjQUFLTyxPQUFMLENBQWFwQyxNQUFNLENBQUNxQyxNQUFQLEVBQWIsRUFBOEIsU0FBOUIsRUFBeUMsUUFBekMsRUFBbUR0RCxvQkFBbkQsQ0FBMUI7O0FBQ0EsTUFBSXVELE9BQU8sR0FBRyxJQUFkOztBQUNBLE1BQUksTUFBTUMsa0JBQUdDLE1BQUgsQ0FBVUwsaUJBQVYsQ0FBVixFQUF3QztBQUd0Q0csSUFBQUEsT0FBTyxHQUFHLE1BQU1HLHVCQUFRQyxPQUFSLEVBQWhCOztBQUNBdEMsb0JBQUlPLEtBQUosQ0FBVSxnREFBVjs7QUFDQSxVQUFNNEIsa0JBQUdJLEVBQUgsQ0FBTVIsaUJBQU4sRUFBeUJOLGNBQUtPLE9BQUwsQ0FBYUUsT0FBYixFQUFzQnZELG9CQUF0QixDQUF6QixFQUFzRTtBQUFDNkQsTUFBQUEsTUFBTSxFQUFFO0FBQVQsS0FBdEUsQ0FBTjtBQUNBLFVBQU0sMkJBQU9ULGlCQUFQLENBQU47QUFDRDs7QUFFRC9CLGtCQUFJTyxLQUFKLENBQVcsZUFBY1ksR0FBSSw2QkFBNEJ2QixNQUFNLENBQUNOLElBQUssTUFBckU7O0FBQ0EsTUFBSTtBQUNGLFFBQUk7QUFDRixZQUFNTSxNQUFNLENBQUM2QyxVQUFQLENBQWtCdEIsR0FBbEIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPdUIsQ0FBUCxFQUFVO0FBRVYxQyxzQkFBSWMsSUFBSixDQUFVLG9CQUFtQkssR0FBSSxjQUFhdUIsQ0FBQyxDQUFDZixPQUFRLEVBQXhEOztBQUVBLFVBQUllLENBQUMsQ0FBQ2YsT0FBRixDQUFVZ0IsUUFBVixDQUFtQix3QkFBbkIsS0FBZ0RULE9BQXBELEVBQTZEO0FBQzNEbEMsd0JBQUljLElBQUosQ0FBVSxvRUFBbUVLLEdBQUksS0FBeEUsR0FDTixxQkFESDs7QUFFQSxjQUFNZ0Isa0JBQUdTLE1BQUgsQ0FBVWIsaUJBQVYsQ0FBTjtBQUNBLGNBQU1JLGtCQUFHSSxFQUFILENBQU1kLGNBQUtPLE9BQUwsQ0FBYUUsT0FBYixFQUFzQnZELG9CQUF0QixDQUFOLEVBQW1Eb0QsaUJBQW5ELEVBQXNFO0FBQzFFUyxVQUFBQSxNQUFNLEVBQUU7QUFEa0UsU0FBdEUsQ0FBTjtBQUdEOztBQUNEeEMsc0JBQUljLElBQUosQ0FBUyw4QkFBVDs7QUFDQSxZQUFNbEIsTUFBTSxDQUFDNkMsVUFBUCxDQUFrQnRCLEdBQWxCLENBQU47QUFDRDs7QUFDRG5CLG9CQUFJTyxLQUFKLENBQVUsMENBQVY7QUFDRCxHQW5CRCxTQW1CVTtBQUNSLFFBQUkyQixPQUFPLEtBQUksTUFBTUMsa0JBQUdDLE1BQUgsQ0FBVUYsT0FBVixDQUFWLENBQVgsRUFBeUM7QUFDdkMsWUFBTUMsa0JBQUdTLE1BQUgsQ0FBVVYsT0FBVixDQUFOO0FBQ0Q7QUFDRjtBQUNGOztBQUVELGVBQWVXLHVCQUFmLENBQXdDQyxhQUF4QyxFQUF1RDtBQUNyRCxRQUFNQyxVQUFVLEdBQUdsRCxnQkFBRW1ELE9BQUYsQ0FBVW5ELGdCQUFFQyxNQUFGLEVBQVMsTUFBTSw2QkFBZixFQUFWLENBQW5COztBQUNBLFFBQU1tRCxrQkFBa0IsR0FBR0YsVUFBVSxDQUFDRyxNQUFYLENBQW1CdEQsTUFBRCxJQUFZQSxNQUFNLENBQUNOLElBQVAsS0FBZ0J3RCxhQUFhLENBQUN4RCxJQUE5QixJQUFzQ00sTUFBTSxDQUFDdUQsS0FBUCxLQUFpQixRQUFyRixDQUEzQjs7QUFDQSxNQUFJdEQsZ0JBQUV1RCxPQUFGLENBQVVILGtCQUFWLENBQUosRUFBbUM7QUFDakNqRCxvQkFBSWMsSUFBSixDQUFTLGdEQUFUOztBQUNBO0FBQ0Q7O0FBQ0RkLGtCQUFJYyxJQUFKLENBQVUsWUFBV21DLGtCQUFrQixDQUFDSSxNQUFPLDJCQUEwQkosa0JBQWtCLENBQUNJLE1BQW5CLEtBQThCLENBQTlCLEdBQWtDLEVBQWxDLEdBQXVDLEdBQUksR0FBM0csR0FDQyxZQUFXSixrQkFBa0IsQ0FBQ0ksTUFBbkIsS0FBOEIsQ0FBOUIsR0FBa0MsSUFBbEMsR0FBeUMsTUFBTyxVQURyRTs7QUFFQSxPQUFLLE1BQU07QUFBQy9ELElBQUFBO0FBQUQsR0FBWCxJQUFxQjJELGtCQUFyQixFQUF5QztBQUd2QyxVQUFNLGlDQUFxQjNELElBQXJCLEVBQTJCLElBQTNCLENBQU47QUFDQSxVQUFNLDBCQUFTQSxJQUFULENBQU47QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBnZXRTaW11bGF0b3IgfSBmcm9tICdhcHBpdW0taW9zLXNpbXVsYXRvcic7XG5pbXBvcnQgeyBjcmVhdGVEZXZpY2UsIGdldERldmljZXMsIHRlcm1pbmF0ZSwgc2h1dGRvd24gfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyByZXNldFhDVGVzdFByb2Nlc3NlcyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgdGVtcERpciwgZnMsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBVVUlEIGZyb20gJ3V1aWQtanMnO1xuaW1wb3J0IHsgUExBVEZPUk1fTkFNRV9JT1MgfSBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5cblxuY29uc3QgSU5TVEFMTF9EQUVNT05fQ0FDSEUgPSAnY29tLmFwcGxlLm1vYmlsZS5pbnN0YWxsZC5zdGFnaW5nJztcblxuXG4vKipcbiAqIENhcGFiaWxpdHkgc2V0IGJ5IGEgdXNlclxuICpcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBkZXZpY2VOYW1lIC0gQSBuYW1lIGZvciB0aGUgZGV2aWNlXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGxhdGZvcm1WZXJzaW9uIC0gVGhlIHZlcnNpb24gb2YgaU9TIHRvIHVzZVxuICovXG4vKipcbiAqIENyZWF0ZSBhIG5ldyBzaW11bGF0b3Igd2l0aCBgYXBwaXVtVGVzdC1gIHByZWZpeCBhbmQgcmV0dXJuIHRoZSBvYmplY3QuXG4gKlxuICogQHBhcmFtIHtvYmplY3R9IFNpbUNyZWF0aW9uQ2FwcyAtIENhcGFiaWxpdHkgc2V0IGJ5IGEgdXNlci4gVGhlIG9wdGlvbnMgYXZhaWxhYmxlIGFyZTpcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBwbGF0Zm9ybSBbaU9TXSAtIFBsYXRmb3JtIG5hbWUgaW4gb3JkZXIgdG8gc3BlY2lmeSBydW50aW1lIHN1Y2ggYXMgJ2lPUycsICd0dk9TJywgJ3dhdGNoT1MnXG4gKiBAcmV0dXJucyB7b2JqZWN0fSBTaW11bGF0b3Igb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGUgdWRpZCBwYXNzZWQgaW4uXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVNpbSAoY2FwcywgcGxhdGZvcm0gPSBQTEFURk9STV9OQU1FX0lPUykge1xuICBjb25zdCBhcHBpdW1UZXN0RGV2aWNlTmFtZSA9IGBhcHBpdW1UZXN0LSR7VVVJRC5jcmVhdGUoKS50b1N0cmluZygpLnRvVXBwZXJDYXNlKCl9LSR7Y2Fwcy5kZXZpY2VOYW1lfWA7XG4gIGNvbnN0IHVkaWQgPSBhd2FpdCBjcmVhdGVEZXZpY2UoXG4gICAgYXBwaXVtVGVzdERldmljZU5hbWUsXG4gICAgY2Fwcy5kZXZpY2VOYW1lLFxuICAgIGNhcHMucGxhdGZvcm1WZXJzaW9uLFxuICAgIHsgcGxhdGZvcm0gfVxuICApO1xuICByZXR1cm4gYXdhaXQgZ2V0U2ltdWxhdG9yKHVkaWQpO1xufVxuXG4vKipcbiAqIEdldCBhIHNpbXVsYXRvciB3aGljaCBpcyBhbHJlYWR5IHJ1bm5pbmcuXG4gKlxuICogQHBhcmFtIHtvYmplY3R9IG9wdHMgLSBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXIuIFRoZSBvcHRpb25zIGF2YWlsYWJsZSBhcmU6XG4gKiAgIC0gYGRldmljZU5hbWVgIC0gYSBuYW1lIGZvciB0aGUgZGV2aWNlXG4gKiAgIC0gYHBsYXRmb3JtVmVyc2lvbmAgLSB0aGUgdmVyc2lvbiBvZiBpT1MgdG8gdXNlXG4gKiBAcmV0dXJucyB7P29iamVjdH0gU2ltdWxhdG9yIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhlIHVkaWQgcGFzc2VkIGluLiBPciBudWxsIGlmIG5vIGRldmljZSBpcyBydW5uaW5nLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRFeGlzdGluZ1NpbSAob3B0cykge1xuICBjb25zdCBkZXZpY2VzID0gYXdhaXQgZ2V0RGV2aWNlcyhvcHRzLnBsYXRmb3JtVmVyc2lvbik7XG4gIGNvbnN0IGFwcGl1bVRlc3REZXZpY2VOYW1lID0gYGFwcGl1bVRlc3QtJHtvcHRzLmRldmljZU5hbWV9YDtcblxuICBsZXQgYXBwaXVtVGVzdERldmljZTtcblxuICBmb3IgKGNvbnN0IGRldmljZSBvZiBfLnZhbHVlcyhkZXZpY2VzKSkge1xuICAgIGlmIChkZXZpY2UubmFtZSA9PT0gb3B0cy5kZXZpY2VOYW1lKSB7XG4gICAgICByZXR1cm4gYXdhaXQgZ2V0U2ltdWxhdG9yKGRldmljZS51ZGlkKTtcbiAgICB9XG5cbiAgICBpZiAoZGV2aWNlLm5hbWUgPT09IGFwcGl1bVRlc3REZXZpY2VOYW1lKSB7XG4gICAgICBhcHBpdW1UZXN0RGV2aWNlID0gZGV2aWNlO1xuICAgIH1cbiAgfVxuXG4gIGlmIChhcHBpdW1UZXN0RGV2aWNlKSB7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byBmaW5kIGRldmljZSAnJHtvcHRzLmRldmljZU5hbWV9Jy4gRm91bmQgJyR7YXBwaXVtVGVzdERldmljZS5uYW1lfScgKHVkaWQ6ICcke2FwcGl1bVRlc3REZXZpY2UudWRpZH0nKSBpbnN0ZWFkYCk7XG4gICAgcmV0dXJuIGF3YWl0IGdldFNpbXVsYXRvcihhcHBpdW1UZXN0RGV2aWNlLnVkaWQpO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaHV0ZG93blNpbXVsYXRvciAoZGV2aWNlKSB7XG4gIC8vIHN0b3AgWENUZXN0IHByb2Nlc3NlcyBpZiBydW5uaW5nIHRvIGF2b2lkIHVuZXhwZWN0ZWQgc2lkZSBlZmZlY3RzXG4gIGF3YWl0IHJlc2V0WENUZXN0UHJvY2Vzc2VzKGRldmljZS51ZGlkLCB0cnVlKTtcbiAgYXdhaXQgZGV2aWNlLnNodXRkb3duKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1blNpbXVsYXRvclJlc2V0IChkZXZpY2UsIG9wdHMpIHtcbiAgaWYgKG9wdHMubm9SZXNldCAmJiAhb3B0cy5mdWxsUmVzZXQpIHtcbiAgICAvLyBub1Jlc2V0ID09PSB0cnVlICYmIGZ1bGxSZXNldCA9PT0gZmFsc2VcbiAgICBsb2cuZGVidWcoJ1Jlc2V0OiBub1Jlc2V0IGlzIG9uLiBMZWF2aW5nIHNpbXVsYXRvciBhcyBpcycpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghZGV2aWNlKSB7XG4gICAgbG9nLmRlYnVnKCdSZXNldDogbm8gZGV2aWNlIGF2YWlsYWJsZS4gU2tpcHBpbmcnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAob3B0cy5mdWxsUmVzZXQpIHtcbiAgICBsb2cuZGVidWcoJ1Jlc2V0OiBmdWxsUmVzZXQgaXMgb24uIENsZWFuaW5nIHNpbXVsYXRvcicpO1xuICAgIGF3YWl0IHNodXRkb3duU2ltdWxhdG9yKGRldmljZSk7XG4gICAgbGV0IGlzS2V5Y2hhaW5zQmFja3VwU3VjY2Vzc2Z1bCA9IGZhbHNlO1xuICAgIGlmIChvcHRzLmtleWNoYWluc0V4Y2x1ZGVQYXR0ZXJucyB8fCBvcHRzLmtlZXBLZXlDaGFpbnMpIHtcbiAgICAgIGlzS2V5Y2hhaW5zQmFja3VwU3VjY2Vzc2Z1bCA9IGF3YWl0IGRldmljZS5iYWNrdXBLZXljaGFpbnMoKTtcbiAgICB9XG4gICAgYXdhaXQgZGV2aWNlLmNsZWFuKCk7XG4gICAgaWYgKGlzS2V5Y2hhaW5zQmFja3VwU3VjY2Vzc2Z1bCkge1xuICAgICAgYXdhaXQgZGV2aWNlLnJlc3RvcmVLZXljaGFpbnMob3B0cy5rZXljaGFpbnNFeGNsdWRlUGF0dGVybnMgfHwgW10pO1xuICAgICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSByZXN0b3JlZCBrZXljaGFpbnMgYWZ0ZXIgZnVsbCByZXNldGApO1xuICAgIH0gZWxzZSBpZiAob3B0cy5rZXljaGFpbnNFeGNsdWRlUGF0dGVybnMgfHwgb3B0cy5rZWVwS2V5Q2hhaW5zKSB7XG4gICAgICBsb2cud2FybignQ2Fubm90IHJlc3RvcmUga2V5Y2hhaW5zIGFmdGVyIGZ1bGwgcmVzZXQsIGJlY2F1c2UgJyArXG4gICAgICAgICAgICAgICAndGhlIGJhY2t1cCBvcGVyYXRpb24gZGlkIG5vdCBzdWNjZWVkJyk7XG4gICAgfVxuICB9IGVsc2UgaWYgKG9wdHMuYnVuZGxlSWQpIHtcbiAgICAvLyBUZXJtaW5hdGUgdGhlIGFwcCB1bmRlciB0ZXN0IGlmIGl0IGlzIHN0aWxsIHJ1bm5pbmcgb24gU2ltdWxhdG9yXG4gICAgLy8gVGVybWluYXRpb24gaXMgbm90IG5lZWRlZCBpZiBTaW11bGF0b3IgaXMgbm90IHJ1bm5pbmdcbiAgICBpZiAoYXdhaXQgZGV2aWNlLmlzUnVubmluZygpKSB7XG4gICAgICBpZiAob3B0cy5lbmZvcmNlU2ltdWxhdG9yU2h1dGRvd24pIHtcbiAgICAgICAgYXdhaXQgc2h1dGRvd25TaW11bGF0b3IoZGV2aWNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGVybWluYXRlKGRldmljZS51ZGlkLCBvcHRzLmJ1bmRsZUlkKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLndhcm4oYFJlc2V0OiBmYWlsZWQgdG8gdGVybWluYXRlIFNpbXVsYXRvciBhcHBsaWNhdGlvbiB3aXRoIGlkIFwiJHtvcHRzLmJ1bmRsZUlkfVwiYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG9wdHMuYXBwKSB7XG4gICAgICBsb2cuaW5mbygnTm90IHNjcnViYmluZyB0aGlyZCBwYXJ0eSBhcHAgaW4gYW50aWNpcGF0aW9uIG9mIHVuaW5zdGFsbCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpc1NhZmFyaSA9IChvcHRzLmJyb3dzZXJOYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpID09PSAnc2FmYXJpJztcbiAgICB0cnkge1xuICAgICAgaWYgKGlzU2FmYXJpKSB7XG4gICAgICAgIGF3YWl0IGRldmljZS5jbGVhblNhZmFyaSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgZGV2aWNlLnNjcnViQ3VzdG9tQXBwKHBhdGguYmFzZW5hbWUob3B0cy5hcHApLCBvcHRzLmJ1bmRsZUlkKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGVyci5tZXNzYWdlKTtcbiAgICAgIGxvZy53YXJuKGBSZXNldDogY291bGQgbm90IHNjcnViICR7aXNTYWZhcmkgPyAnU2FmYXJpIGJyb3dzZXInIDogJ2FwcGxpY2F0aW9uIHdpdGggaWQgXCInICsgb3B0cy5idW5kbGVJZCArICdcIid9LiBMZWF2aW5nIGFzIGlzLmApO1xuICAgIH1cbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsVG9TaW11bGF0b3IgKGRldmljZSwgYXBwLCBidW5kbGVJZCwgbm9SZXNldCA9IHRydWUpIHtcbiAgaWYgKCFhcHApIHtcbiAgICBsb2cuZGVidWcoJ05vIGFwcCBwYXRoIGlzIGdpdmVuLiBOb3RoaW5nIHRvIGluc3RhbGwuJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKGJ1bmRsZUlkKSB7XG4gICAgaWYgKGF3YWl0IGRldmljZS5pc0FwcEluc3RhbGxlZChidW5kbGVJZCkpIHtcbiAgICAgIGlmIChub1Jlc2V0KSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQXBwICcke2J1bmRsZUlkfScgaXMgYWxyZWFkeSBpbnN0YWxsZWQuIE5vIG5lZWQgdG8gcmVpbnN0YWxsLmApO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoYFJlc2V0IHJlcXVlc3RlZC4gUmVtb3ZpbmcgYXBwIHdpdGggaWQgJyR7YnVuZGxlSWR9JyBmcm9tIHRoZSBkZXZpY2VgKTtcbiAgICAgIGF3YWl0IGRldmljZS5yZW1vdmVBcHAoYnVuZGxlSWQpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGluc3RhbGxkQ2FjaGVSb290ID0gcGF0aC5yZXNvbHZlKGRldmljZS5nZXREaXIoKSwgJ0xpYnJhcnknLCAnQ2FjaGVzJywgSU5TVEFMTF9EQUVNT05fQ0FDSEUpO1xuICBsZXQgdG1wUm9vdCA9IG51bGw7XG4gIGlmIChhd2FpdCBmcy5leGlzdHMoaW5zdGFsbGRDYWNoZVJvb3QpKSB7XG4gICAgLy8gQ2xlYW51cCBvZiBpbnN0YWxsZCBjYWNoZSBoZWxwcyB0byBzYXZlIGRpc2sgc3BhY2Ugd2hpbGUgcnVubmluZyBtdWx0aXBsZSB0ZXN0c1xuICAgIC8vIHdpdGhvdXQgcmVzdGFydGluZyB0aGUgU2ltdWxhdG9yOiBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvOTQxMFxuICAgIHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgICBsb2cuZGVidWcoJ0NsZWFuaW5nIGluc3RhbGxkIGNhY2hlIHRvIHNhdmUgdGhlIGRpc2sgc3BhY2UnKTtcbiAgICBhd2FpdCBmcy5tdihpbnN0YWxsZENhY2hlUm9vdCwgcGF0aC5yZXNvbHZlKHRtcFJvb3QsIElOU1RBTExfREFFTU9OX0NBQ0hFKSwge21rZGlycDogdHJ1ZX0pO1xuICAgIGF3YWl0IG1rZGlycChpbnN0YWxsZENhY2hlUm9vdCk7XG4gIH1cblxuICBsb2cuZGVidWcoYEluc3RhbGxpbmcgJyR7YXBwfScgb24gU2ltdWxhdG9yIHdpdGggVVVJRCAnJHtkZXZpY2UudWRpZH0nLi4uYCk7XG4gIHRyeSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGRldmljZS5pbnN0YWxsQXBwKGFwcCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gaXQgc29tZXRpbWVzIGZhaWxzIG9uIFhjb2RlIDEwIGJlY2F1c2Ugb2YgYSByYWNlIGNvbmRpdGlvblxuICAgICAgbG9nLmluZm8oYEdvdCBhbiBlcnJvciBvbiAnJHthcHB9JyBpbnN0YWxsOiAke2UubWVzc2FnZX1gKTtcbiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xMTM1MFxuICAgICAgaWYgKGUubWVzc2FnZS5pbmNsdWRlcygnTUlJbnN0YWxsZXJFcnJvckRvbWFpbicpICYmIHRtcFJvb3QpIHtcbiAgICAgICAgbG9nLmluZm8oYGluc3RhbGxkIHJlcXVpcmVzIHRoZSBjYWNoZSB0byBiZSBhdmFpbGFibGUgaW4gb3JkZXIgdG8gaW5zdGFsbCAnJHthcHB9Jy4gYCArXG4gICAgICAgICAgYFJlc3RvcmluZyB0aGUgY2FjaGVgKTtcbiAgICAgICAgYXdhaXQgZnMucmltcmFmKGluc3RhbGxkQ2FjaGVSb290KTtcbiAgICAgICAgYXdhaXQgZnMubXYocGF0aC5yZXNvbHZlKHRtcFJvb3QsIElOU1RBTExfREFFTU9OX0NBQ0hFKSwgaW5zdGFsbGRDYWNoZVJvb3QsIHtcbiAgICAgICAgICBta2RpcnA6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBsb2cuaW5mbygnUmV0cnlpbmcgYXBwbGljYXRpb24gaW5zdGFsbCcpO1xuICAgICAgYXdhaXQgZGV2aWNlLmluc3RhbGxBcHAoYXBwKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKCdUaGUgYXBwIGhhcyBiZWVuIGluc3RhbGxlZCBzdWNjZXNzZnVsbHkuJyk7XG4gIH0gZmluYWxseSB7XG4gICAgaWYgKHRtcFJvb3QgJiYgYXdhaXQgZnMuZXhpc3RzKHRtcFJvb3QpKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodG1wUm9vdCk7XG4gICAgfVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNodXRkb3duT3RoZXJTaW11bGF0b3JzIChjdXJyZW50RGV2aWNlKSB7XG4gIGNvbnN0IGFsbERldmljZXMgPSBfLmZsYXRNYXAoXy52YWx1ZXMoYXdhaXQgZ2V0RGV2aWNlcygpKSk7XG4gIGNvbnN0IG90aGVyQm9vdGVkRGV2aWNlcyA9IGFsbERldmljZXMuZmlsdGVyKChkZXZpY2UpID0+IGRldmljZS51ZGlkICE9PSBjdXJyZW50RGV2aWNlLnVkaWQgJiYgZGV2aWNlLnN0YXRlID09PSAnQm9vdGVkJyk7XG4gIGlmIChfLmlzRW1wdHkob3RoZXJCb290ZWREZXZpY2VzKSkge1xuICAgIGxvZy5pbmZvKCdObyBvdGhlciBydW5uaW5nIHNpbXVsYXRvcnMgaGF2ZSBiZWVuIGRldGVjdGVkJyk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxvZy5pbmZvKGBEZXRlY3RlZCAke290aGVyQm9vdGVkRGV2aWNlcy5sZW5ndGh9IG90aGVyIHJ1bm5pbmcgU2ltdWxhdG9yJHtvdGhlckJvb3RlZERldmljZXMubGVuZ3RoID09PSAxID8gJycgOiAncyd9LmAgK1xuICAgICAgICAgICBgU2h1dHRpbmcgJHtvdGhlckJvb3RlZERldmljZXMubGVuZ3RoID09PSAxID8gJ2l0JyA6ICd0aGVtJ30gZG93bi4uLmApO1xuICBmb3IgKGNvbnN0IHt1ZGlkfSBvZiBvdGhlckJvb3RlZERldmljZXMpIHtcbiAgICAvLyBJdCBpcyBuZWNlc3NhcnkgdG8gc3RvcCB0aGUgY29ycmVzcG9uZGluZyB4Y29kZWJ1aWxkIHByb2Nlc3MgYmVmb3JlIGtpbGxpbmdcbiAgICAvLyB0aGUgc2ltdWxhdG9yLCBvdGhlcndpc2UgaXQgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IHJlc3RhcnRlZFxuICAgIGF3YWl0IHJlc2V0WENUZXN0UHJvY2Vzc2VzKHVkaWQsIHRydWUpO1xuICAgIGF3YWl0IHNodXRkb3duKHVkaWQpO1xuICB9XG59XG5cbmV4cG9ydCB7IGNyZWF0ZVNpbSwgZ2V0RXhpc3RpbmdTaW0sIHJ1blNpbXVsYXRvclJlc2V0LCBpbnN0YWxsVG9TaW11bGF0b3IsXG4gIHNodXRkb3duU2ltdWxhdG9yLCBzaHV0ZG93bk90aGVyU2ltdWxhdG9ycyB9O1xuIl0sImZpbGUiOiJsaWIvc2ltdWxhdG9yLW1hbmFnZW1lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
