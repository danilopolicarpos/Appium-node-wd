"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.CHROMIUM_WIN = exports.WEBVIEW_BASE = exports.WEBVIEW_WIN = exports.NATIVE_WIN = exports.helpers = exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

const NATIVE_WIN = 'NATIVE_APP';
exports.NATIVE_WIN = NATIVE_WIN;
const WEBVIEW_WIN = 'WEBVIEW';
exports.WEBVIEW_WIN = WEBVIEW_WIN;
const WEBVIEW_BASE = `${WEBVIEW_WIN}_`;
exports.WEBVIEW_BASE = WEBVIEW_BASE;
const WEBVIEW_REGEXP = new RegExp(`@?webview_devtools_remote_(\\d+)`);
const WEBVIEW_PID_REGEXP = new RegExp(`${WEBVIEW_BASE}(\\d+)`);
const CHROMIUM_WIN = 'CHROMIUM';
exports.CHROMIUM_WIN = CHROMIUM_WIN;
const CROSSWALK_SOCKET_SUFFIX = '_devtools_remote';
const CROSSWALK_REGEXP_STRING = `(\\S*)${CROSSWALK_SOCKET_SUFFIX}`;
const CROSSWALK_REGEXP = new RegExp(`@${CROSSWALK_REGEXP_STRING}`);
const CROSSWALK_PROCESS_REGEXP = new RegExp(WEBVIEW_BASE + CROSSWALK_REGEXP_STRING);
let helpers = {};
exports.helpers = helpers;

async function webviewsFromProcs(adb, deviceSocket) {
  let webviews = [];
  let out = await adb.shell(['cat', '/proc/net/unix']);

  for (let line of out.split('\n')) {
    line = line.trim();

    if (deviceSocket) {
      if (line.indexOf(`@${deviceSocket}`) === line.length - deviceSocket.length - 1) {
        if (deviceSocket === 'chrome_devtools_remote') {
          webviews.push(CHROMIUM_WIN);
          continue;
        }
      }
    }

    let webviewPid;
    let crosswalkWebviewSocket;

    if (webviewPid = line.match(WEBVIEW_REGEXP)) {
      webviews.push(`${WEBVIEW_BASE}${webviewPid[1]}`);
    } else if (crosswalkWebviewSocket = line.match(CROSSWALK_REGEXP)) {
      if (deviceSocket) {
        if (crosswalkWebviewSocket[0].slice(1) === deviceSocket) {
          webviews.push(`${WEBVIEW_BASE}${crosswalkWebviewSocket[1]}`);
        }
      } else {
        webviews.push(`${WEBVIEW_BASE}${crosswalkWebviewSocket[1]}${CROSSWALK_SOCKET_SUFFIX}`);
      }
    }
  }

  return _lodash.default.uniq(webviews);
}

helpers.procFromWebview = async function procFromWebview(adb, webview) {
  if (webview.match(WEBVIEW_PID_REGEXP) === null) {
    let processName = webview.match(CROSSWALK_PROCESS_REGEXP);

    if (processName === null) {
      throw new Error(`Could not find process name for webview ${webview}`);
    }

    return processName[1];
  }

  let pid = webview.match(/\d+$/);

  if (!pid) {
    throw new Error(`Could not find PID for webview ${webview}`);
  }

  pid = pid[0];

  _logger.default.debug(`${webview} mapped to pid ${pid}`);

  _logger.default.debug('Getting process name for webview');

  let out = await adb.shell('ps');
  let pkg = 'unknown';
  let lines = out.split(/\r?\n/);
  const fullHeader = lines[0].trim();
  const header = fullHeader.split(/\s+/);
  const pidColumn = header.indexOf('PID');

  for (let line of lines) {
    const entries = line.trim().split(/\s+/);
    const pidEntry = entries[pidColumn];

    if (pidEntry === pid) {
      pkg = _lodash.default.last(entries);

      _logger.default.debug(`Parsed pid: '${pidEntry}' pkg: '${pkg}' from`);

      _logger.default.debug(`    ${fullHeader}`);

      _logger.default.debug(`    ${line}`);

      break;
    }
  }

  _logger.default.debug(`Returning process name: '${pkg}'`);

  return pkg;
};

helpers.getWebviews = async function getWebviews(adb, deviceSocket) {
  _logger.default.debug('Getting a list of available webviews');

  let webviews = await webviewsFromProcs(adb, deviceSocket);

  if (deviceSocket) {
    return webviews;
  }

  webviews = await (0, _asyncbox.asyncmap)(webviews, async webviewName => {
    let pkg = await helpers.procFromWebview(adb, webviewName);
    return WEBVIEW_BASE + pkg;
  });

  _logger.default.debug(`Found webviews: ${JSON.stringify(webviews)}`);

  return webviews;
};

helpers.decorateChromeOptions = function decorateChromeOptions(caps, opts, deviceId) {
  if (opts.chromeOptions) {
    if (opts.chromeOptions.Arguments) {
      opts.chromeOptions.args = [...(opts.chromeOptions.args || []), ...opts.chromeOptions.Arguments];
      delete opts.chromeOptions.Arguments;
    }

    for (let [opt, val] of _lodash.default.toPairs(opts.chromeOptions)) {
      if (_lodash.default.isUndefined(caps.chromeOptions[opt])) {
        caps.chromeOptions[opt] = val;
      } else {
        _logger.default.warn(`Cannot pass option ${caps.chromeOptions[opt]} because ` + 'Appium needs it to make chromeDriver work');
      }
    }
  }

  caps.chromeOptions.androidDeviceSerial = deviceId;
  return caps;
};

var _default = helpers;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJ2aWV3LWhlbHBlcnMuanMiXSwibmFtZXMiOlsiTkFUSVZFX1dJTiIsIldFQlZJRVdfV0lOIiwiV0VCVklFV19CQVNFIiwiV0VCVklFV19SRUdFWFAiLCJSZWdFeHAiLCJXRUJWSUVXX1BJRF9SRUdFWFAiLCJDSFJPTUlVTV9XSU4iLCJDUk9TU1dBTEtfU09DS0VUX1NVRkZJWCIsIkNST1NTV0FMS19SRUdFWFBfU1RSSU5HIiwiQ1JPU1NXQUxLX1JFR0VYUCIsIkNST1NTV0FMS19QUk9DRVNTX1JFR0VYUCIsImhlbHBlcnMiLCJ3ZWJ2aWV3c0Zyb21Qcm9jcyIsImFkYiIsImRldmljZVNvY2tldCIsIndlYnZpZXdzIiwib3V0Iiwic2hlbGwiLCJsaW5lIiwic3BsaXQiLCJ0cmltIiwiaW5kZXhPZiIsImxlbmd0aCIsInB1c2giLCJ3ZWJ2aWV3UGlkIiwiY3Jvc3N3YWxrV2Vidmlld1NvY2tldCIsIm1hdGNoIiwic2xpY2UiLCJfIiwidW5pcSIsInByb2NGcm9tV2VidmlldyIsIndlYnZpZXciLCJwcm9jZXNzTmFtZSIsIkVycm9yIiwicGlkIiwibG9nZ2VyIiwiZGVidWciLCJwa2ciLCJsaW5lcyIsImZ1bGxIZWFkZXIiLCJoZWFkZXIiLCJwaWRDb2x1bW4iLCJlbnRyaWVzIiwicGlkRW50cnkiLCJsYXN0IiwiZ2V0V2Vidmlld3MiLCJ3ZWJ2aWV3TmFtZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJkZWNvcmF0ZUNocm9tZU9wdGlvbnMiLCJjYXBzIiwib3B0cyIsImRldmljZUlkIiwiY2hyb21lT3B0aW9ucyIsIkFyZ3VtZW50cyIsImFyZ3MiLCJvcHQiLCJ2YWwiLCJ0b1BhaXJzIiwiaXNVbmRlZmluZWQiLCJ3YXJuIiwiYW5kcm9pZERldmljZVNlcmlhbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxVQUFVLEdBQUcsWUFBbkI7O0FBQ0EsTUFBTUMsV0FBVyxHQUFHLFNBQXBCOztBQUNBLE1B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QTBCLENBQUMsSUFBSUosSUFBSSxDQUFDRSxhQUFMLENBQW1CRSxJQUFuQixJQUEyQixFQUEvQixDQUFELEVBQXFDLEdBQUdKLElBQUksQ0FBQ0UsYUFBTCxDQUFtQkMsU0FBM0QsQ0FBMUI7QUFDQSxhQUFPSCxJQUFJLENBQUNFLGFBQUwsQ0FBbUJDLFNBQTFCO0FBQ0Q7O0FBQ0QsU0FBSyxJQUFJLENBQUNFLEdBQUQsRUFBTUMsR0FBTixDQUFULElBQXVCN0IsZ0JBQUU4QixPQUFGLENBQVVQLElBQUksQ0FBQ0UsYUFBZixDQUF2QixFQUFzRDtBQUNwRCxVQUFJekIsZ0JBQUUrQixXQUFGLENBQWNULElBQUksQ0FBQ0csYUFBTCxDQUFtQkcsR0FBbkIsQ0FBZCxDQUFKLEVBQTRDO0FBQzFDTixRQUFBQSxJQUFJLENBQUNHLGFBQUwsQ0FBbUJHLEdBQW5CLElBQTBCQyxHQUExQjtBQUNELE9BRkQsTUFFTztBQUNMdEIsd0JBQU95QixJQUFQLENBQWEsc0JBQXFCVixJQUFJLENBQUNHLGFBQUwsQ0FBbUJHLEdBQW5CLENBQXdCLFdBQTlDLEdBQ0EsMkNBRFo7QUFFRDtBQUNGO0FBQ0Y7O0FBR0ROLEVBQUFBLElBQUksQ0FBQ0csYUFBTCxDQUFtQlEsbUJBQW5CLEdBQXlDVCxRQUF6QztBQUNBLFNBQU9GLElBQVA7QUFDRCxDQXJCRDs7ZUF1QmV2QyxPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgYXN5bmNtYXAgfSBmcm9tICdhc3luY2JveCc7XG5cbmNvbnN0IE5BVElWRV9XSU4gPSAnTkFUSVZFX0FQUCc7XG5jb25zdCBXRUJWSUVXX1dJTiA9ICdXRUJWSUVXJztcbmNvbnN0IFdFQlZJRVdfQkFTRSA9IGAke1dFQlZJRVdfV0lOfV9gO1xuY29uc3QgV0VCVklFV19SRUdFWFAgPSBuZXcgUmVnRXhwKGBAP3dlYnZpZXdfZGV2dG9vbHNfcmVtb3RlXyhcXFxcZCspYCk7XG5jb25zdCBXRUJWSUVXX1BJRF9SRUdFWFAgPSBuZXcgUmVnRXhwKGAke1dFQlZJRVdfQkFTRX0oXFxcXGQrKWApO1xuY29uc3QgQ0hST01JVU1fV0lOID0gJ0NIUk9NSVVNJztcbmNvbnN0IENST1NTV0FMS19TT0NLRVRfU1VGRklYID0gJ19kZXZ0b29sc19yZW1vdGUnO1xuY29uc3QgQ1JPU1NXQUxLX1JFR0VYUF9TVFJJTkcgPSBgKFxcXFxTKikke0NST1NTV0FMS19TT0NLRVRfU1VGRklYfWA7XG5jb25zdCBDUk9TU1dBTEtfUkVHRVhQID0gbmV3IFJlZ0V4cChgQCR7Q1JPU1NXQUxLX1JFR0VYUF9TVFJJTkd9YCk7XG5jb25zdCBDUk9TU1dBTEtfUFJPQ0VTU19SRUdFWFAgPSBuZXcgUmVnRXhwKFdFQlZJRVdfQkFTRSArIENST1NTV0FMS19SRUdFWFBfU1RSSU5HKTtcblxuXG5sZXQgaGVscGVycyA9IHt9O1xuXG4vLyBUaGlzIGZ1bmN0aW9uIGdldHMgYSBsaXN0IG9mIGFuZHJvaWQgc3lzdGVtIHByb2Nlc3NlcyBhbmQgcmV0dXJucyBvbmVzXG4vLyB0aGF0IGxvb2sgbGlrZSB3ZWJ2aWV3cywgd2l0aCB0aGUgYXBwcm9wcmlhdGUgd2VidmlldyBwcmVmaXggYW5kIHRoZWlyIFBJRC5cbi8vIElmIHdlIHBhc3MgaW4gYSBkZXZpY2VTb2NrZXQsIHdlIG9ubHkgYXR0ZW1wdCB0byBmaW5kIHdlYnZpZXdzIHdoaWNoIG1hdGNoXG4vLyB0aGF0IHNvY2tldCBuYW1lICh0aGlzIGlzIGZvciBhcHBzIHdoaWNoIGVtYmVkIENocm9taXVtLCB3aGljaCBpc24ndCB0aGVcbi8vIHNhbWUgYXMgY2hyb21lLWJhY2tlZCB3ZWJ2aWV3cylcbi8vIFRPRE86IHNvbWUgb2YgdGhpcyBmdW5jdGlvbiBiZWxvbmdzIGluIGFwcGl1bS1hZGJcbmFzeW5jIGZ1bmN0aW9uIHdlYnZpZXdzRnJvbVByb2NzIChhZGIsIGRldmljZVNvY2tldCkge1xuICBsZXQgd2Vidmlld3MgPSBbXTtcbiAgbGV0IG91dCA9IGF3YWl0IGFkYi5zaGVsbChbJ2NhdCcsICcvcHJvYy9uZXQvdW5peCddKTtcbiAgZm9yIChsZXQgbGluZSBvZiBvdXQuc3BsaXQoJ1xcbicpKSB7XG4gICAgbGluZSA9IGxpbmUudHJpbSgpO1xuXG4gICAgaWYgKGRldmljZVNvY2tldCkge1xuICAgICAgaWYgKGxpbmUuaW5kZXhPZihgQCR7ZGV2aWNlU29ja2V0fWApID09PSBsaW5lLmxlbmd0aCAtIGRldmljZVNvY2tldC5sZW5ndGggLSAxKSB7XG4gICAgICAgIGlmIChkZXZpY2VTb2NrZXQgPT09ICdjaHJvbWVfZGV2dG9vbHNfcmVtb3RlJykge1xuICAgICAgICAgIHdlYnZpZXdzLnB1c2goQ0hST01JVU1fV0lOKTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGxldCB3ZWJ2aWV3UGlkO1xuICAgIGxldCBjcm9zc3dhbGtXZWJ2aWV3U29ja2V0O1xuICAgIGlmICgod2Vidmlld1BpZCA9IGxpbmUubWF0Y2goV0VCVklFV19SRUdFWFApKSkge1xuICAgICAgLy8gZm9yIG11bHRpcGxlIHdlYnZpZXdzIGEgbGlzdCBvZiAnV0VCVklFV188aW5kZXg+JyB3aWxsIGJlIHJldHVybmVkXG4gICAgICAvLyB3aGVyZSA8aW5kZXg+IGlzIHplcm8gYmFzZWQgKHNhbWUgaXMgaW4gc2VsZW5kcm9pZClcbiAgICAgIHdlYnZpZXdzLnB1c2goYCR7V0VCVklFV19CQVNFfSR7d2Vidmlld1BpZFsxXX1gKTtcbiAgICB9IGVsc2UgaWYgKChjcm9zc3dhbGtXZWJ2aWV3U29ja2V0ID0gbGluZS5tYXRjaChDUk9TU1dBTEtfUkVHRVhQKSkpIHtcbiAgICAgIGlmIChkZXZpY2VTb2NrZXQpIHtcbiAgICAgICAgaWYgKGNyb3Nzd2Fsa1dlYnZpZXdTb2NrZXRbMF0uc2xpY2UoMSkgPT09IGRldmljZVNvY2tldCkge1xuICAgICAgICAgIHdlYnZpZXdzLnB1c2goYCR7V0VCVklFV19CQVNFfSR7Y3Jvc3N3YWxrV2Vidmlld1NvY2tldFsxXX1gKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd2Vidmlld3MucHVzaChgJHtXRUJWSUVXX0JBU0V9JHtjcm9zc3dhbGtXZWJ2aWV3U29ja2V0WzFdfSR7Q1JPU1NXQUxLX1NPQ0tFVF9TVUZGSVh9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBfLnVuaXEod2Vidmlld3MpO1xufVxuXG4vLyBUYWtlIGEgd2VidmlldyBuYW1lIGxpa2UgV0VCVklFV180Mjk2IGFuZCB1c2UgJ2FkYiBzaGVsbCBwcycgdG8gZmlndXJlIG91dFxuLy8gd2hpY2ggYXBwIHBhY2thZ2UgaXMgYXNzb2NpYXRlZCB3aXRoIHRoYXQgd2Vidmlldy4gT25lIG9mIHRoZSByZWFzb25zIHdlXG4vLyB3YW50IHRvIGRvIHRoaXMgaXMgdG8gbWFrZSBzdXJlIHdlJ3JlIGxpc3Rpbmcgd2Vidmlld3MgZm9yIHRoZSBhY3R1YWwgQVVULFxuLy8gbm90IHNvbWUgb3RoZXIgcnVubmluZyBhcHBcbi8vIFRPRE86IHRoaXMgc2hvdWxkIGJlIGNhbGxlZCBwcm9jRnJvbVBpZCBhbmQgZXhpc3QgaW4gYXBwaXVtLWFkYlxuaGVscGVycy5wcm9jRnJvbVdlYnZpZXcgPSBhc3luYyBmdW5jdGlvbiBwcm9jRnJvbVdlYnZpZXcgKGFkYiwgd2Vidmlldykge1xuICBpZiAod2Vidmlldy5tYXRjaChXRUJWSUVXX1BJRF9SRUdFWFApID09PSBudWxsKSB7XG4gICAgbGV0IHByb2Nlc3NOYW1lID0gd2Vidmlldy5tYXRjaChDUk9TU1dBTEtfUFJPQ0VTU19SRUdFWFApO1xuICAgIGlmIChwcm9jZXNzTmFtZSA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBwcm9jZXNzIG5hbWUgZm9yIHdlYnZpZXcgJHt3ZWJ2aWV3fWApO1xuICAgIH1cbiAgICByZXR1cm4gcHJvY2Vzc05hbWVbMV07XG4gIH1cblxuICAvLyB3ZWJ2aWV3X2RldnRvb2xzX3JlbW90ZV80Mjk2ID0+IDQyOTZcbiAgbGV0IHBpZCA9IHdlYnZpZXcubWF0Y2goL1xcZCskLyk7XG4gIGlmICghcGlkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBQSUQgZm9yIHdlYnZpZXcgJHt3ZWJ2aWV3fWApO1xuICB9XG4gIHBpZCA9IHBpZFswXTtcbiAgbG9nZ2VyLmRlYnVnKGAke3dlYnZpZXd9IG1hcHBlZCB0byBwaWQgJHtwaWR9YCk7XG4gIGxvZ2dlci5kZWJ1ZygnR2V0dGluZyBwcm9jZXNzIG5hbWUgZm9yIHdlYnZpZXcnKTtcbiAgbGV0IG91dCA9IGF3YWl0IGFkYi5zaGVsbCgncHMnKTtcbiAgbGV0IHBrZyA9ICd1bmtub3duJztcbiAgbGV0IGxpbmVzID0gb3V0LnNwbGl0KC9cXHI/XFxuLyk7XG5cbiAgLyogT3V0cHV0IG9mIHBzIGlzIGxpa2U6XG4gICBVU0VSICAgICAgIFBJRCAgUFBJRCAgVlNJWkUgIFJTUyAgIFdDSEFOICAgIFBDICAgICAgICAgTkFNRSAgX29yX1xuICAgVVNFUiAgICAgICBQSUQgIFBQSUQgIFZTWiAgICBSU1MgICBXQ0hBTiAgICBBRERSICAgICBTIE5BTUVcbiAgIHUwX2ExMzYgICA2MjQ4ICAxNzkgICA5NDYwMDAgNDgxNDQgZmZmZmZmZmYgNDAwNTkwM2UgUiBjb20uZXhhbXBsZS50ZXN0XG4gICB1MF9hMTM2ICAgNjI0OSAgMTc5ICAgOTQ2MDAwIDQ4MTQ0IGZmZmZmZmZmICAgICAgICAgIFIgY29tLmV4YW1wbGUudGVzdFxuICAqL1xuICBjb25zdCBmdWxsSGVhZGVyID0gbGluZXNbMF0udHJpbSgpO1xuICBjb25zdCBoZWFkZXIgPSBmdWxsSGVhZGVyLnNwbGl0KC9cXHMrLyk7XG4gIGNvbnN0IHBpZENvbHVtbiA9IGhlYWRlci5pbmRleE9mKCdQSUQnKTtcblxuICBmb3IgKGxldCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgY29uc3QgZW50cmllcyA9IGxpbmUudHJpbSgpLnNwbGl0KC9cXHMrLyk7XG4gICAgY29uc3QgcGlkRW50cnkgPSBlbnRyaWVzW3BpZENvbHVtbl07XG4gICAgaWYgKHBpZEVudHJ5ID09PSBwaWQpIHtcbiAgICAgIHBrZyA9IF8ubGFzdChlbnRyaWVzKTtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgUGFyc2VkIHBpZDogJyR7cGlkRW50cnl9JyBwa2c6ICcke3BrZ30nIGZyb21gKTtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgICAgICR7ZnVsbEhlYWRlcn1gKTtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgICAgICR7bGluZX1gKTtcblxuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKGBSZXR1cm5pbmcgcHJvY2VzcyBuYW1lOiAnJHtwa2d9J2ApO1xuICByZXR1cm4gcGtnO1xufTtcblxuLy8gR2V0IGEgbGlzdCBvZiBhdmFpbGFibGUgd2Vidmlld3MgYnkgaW50cm9zcGVjdGluZyBwcm9jZXNzZXMgd2l0aCBhZGIsIHdoZXJlXG4vLyB3ZWJ2aWV3cyBhcmUgbGlzdGVkLiBJdCdzIHBvc3NpYmxlIHRvIHBhc3MgaW4gYSAnZGV2aWNlU29ja2V0JyBhcmcsIHdoaWNoXG4vLyBsaW1pdHMgdGhlIHdlYnZpZXcgcG9zc2liaWxpdGllcyB0byB0aGUgb25lIHJ1bm5pbmcgb24gdGhlIENocm9taXVtIGRldnRvb2xzXG4vLyBzb2NrZXQgd2UncmUgaW50ZXJlc3RlZCBpbiAoc2VlIG5vdGUgb24gd2Vidmlld3NGcm9tUHJvY3MpXG5oZWxwZXJzLmdldFdlYnZpZXdzID0gYXN5bmMgZnVuY3Rpb24gZ2V0V2Vidmlld3MgKGFkYiwgZGV2aWNlU29ja2V0KSB7XG4gIGxvZ2dlci5kZWJ1ZygnR2V0dGluZyBhIGxpc3Qgb2YgYXZhaWxhYmxlIHdlYnZpZXdzJyk7XG4gIGxldCB3ZWJ2aWV3cyA9IGF3YWl0IHdlYnZpZXdzRnJvbVByb2NzKGFkYiwgZGV2aWNlU29ja2V0KTtcblxuICBpZiAoZGV2aWNlU29ja2V0KSB7XG4gICAgcmV0dXJuIHdlYnZpZXdzO1xuICB9XG5cbiAgd2Vidmlld3MgPSBhd2FpdCBhc3luY21hcCh3ZWJ2aWV3cywgYXN5bmMgKHdlYnZpZXdOYW1lKSA9PiB7XG4gICAgbGV0IHBrZyA9IGF3YWl0IGhlbHBlcnMucHJvY0Zyb21XZWJ2aWV3KGFkYiwgd2Vidmlld05hbWUpO1xuICAgIHJldHVybiBXRUJWSUVXX0JBU0UgKyBwa2c7XG4gIH0pO1xuICBsb2dnZXIuZGVidWcoYEZvdW5kIHdlYnZpZXdzOiAke0pTT04uc3RyaW5naWZ5KHdlYnZpZXdzKX1gKTtcbiAgcmV0dXJuIHdlYnZpZXdzO1xufTtcblxuaGVscGVycy5kZWNvcmF0ZUNocm9tZU9wdGlvbnMgPSBmdW5jdGlvbiBkZWNvcmF0ZUNocm9tZU9wdGlvbnMgKGNhcHMsIG9wdHMsIGRldmljZUlkKSB7XG4gIC8vIGFkZCBvcHRpb25zIGZyb20gYXBwaXVtIHNlc3Npb24gY2Fwc1xuICBpZiAob3B0cy5jaHJvbWVPcHRpb25zKSB7XG4gICAgaWYgKG9wdHMuY2hyb21lT3B0aW9ucy5Bcmd1bWVudHMpIHtcbiAgICAgIC8vIG1lcmdlIGBBcmd1bWVudHNgIGFuZCBgYXJnc2BcbiAgICAgIG9wdHMuY2hyb21lT3B0aW9ucy5hcmdzID0gWy4uLihvcHRzLmNocm9tZU9wdGlvbnMuYXJncyB8fCBbXSksIC4uLm9wdHMuY2hyb21lT3B0aW9ucy5Bcmd1bWVudHNdO1xuICAgICAgZGVsZXRlIG9wdHMuY2hyb21lT3B0aW9ucy5Bcmd1bWVudHM7XG4gICAgfVxuICAgIGZvciAobGV0IFtvcHQsIHZhbF0gb2YgXy50b1BhaXJzKG9wdHMuY2hyb21lT3B0aW9ucykpIHtcbiAgICAgIGlmIChfLmlzVW5kZWZpbmVkKGNhcHMuY2hyb21lT3B0aW9uc1tvcHRdKSkge1xuICAgICAgICBjYXBzLmNocm9tZU9wdGlvbnNbb3B0XSA9IHZhbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBDYW5ub3QgcGFzcyBvcHRpb24gJHtjYXBzLmNocm9tZU9wdGlvbnNbb3B0XX0gYmVjYXVzZSBgICtcbiAgICAgICAgICAgICAgICAgICAgJ0FwcGl1bSBuZWVkcyBpdCB0byBtYWtlIGNocm9tZURyaXZlciB3b3JrJyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gYWRkIGRldmljZSBpZCBmcm9tIGFkYlxuICBjYXBzLmNocm9tZU9wdGlvbnMuYW5kcm9pZERldmljZVNlcmlhbCA9IGRldmljZUlkO1xuICByZXR1cm4gY2Fwcztcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGhlbHBlcnM7XG5leHBvcnQgeyBoZWxwZXJzLCBOQVRJVkVfV0lOLCBXRUJWSUVXX1dJTiwgV0VCVklFV19CQVNFLCBDSFJPTUlVTV9XSU4gfTtcbiJdLCJmaWxlIjoibGliL3dlYnZpZXctaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
