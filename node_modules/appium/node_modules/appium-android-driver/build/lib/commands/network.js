"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _bluebird = _interopRequireDefault(require("bluebird"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const AIRPLANE_MODE_MASK = 0b001;
const WIFI_MASK = 0b010;
const DATA_MASK = 0b100;
const GEO_EPSILON = Number.MIN_VALUE;

commands.getNetworkConnection = async function getNetworkConnection() {
  _logger.default.info('Getting network connection');

  let airplaneModeOn = await this.adb.isAirplaneModeOn();
  let connection = airplaneModeOn ? AIRPLANE_MODE_MASK : 0;

  if (!airplaneModeOn) {
    let wifiOn = await this.isWifiOn();
    connection |= wifiOn ? WIFI_MASK : 0;
    let dataOn = await this.adb.isDataOn();
    connection |= dataOn ? DATA_MASK : 0;
  }

  return connection;
};

commands.isWifiOn = async function isWifiOn() {
  return await this.adb.isWifiOn();
};

commands.setNetworkConnection = async function setNetworkConnection(type) {
  _logger.default.info('Setting network connection');

  const shouldEnableAirplaneMode = (type & AIRPLANE_MODE_MASK) !== 0;
  const shouldEnableWifi = (type & WIFI_MASK) !== 0;
  const shouldEnableDataConnection = (type & DATA_MASK) !== 0;
  const currentState = await this.getNetworkConnection();
  const isAirplaneModeEnabled = (currentState & AIRPLANE_MODE_MASK) !== 0;
  const isWiFiEnabled = (currentState & WIFI_MASK) !== 0;
  const isDataEnabled = (currentState & DATA_MASK) !== 0;

  if (shouldEnableAirplaneMode !== isAirplaneModeEnabled) {
    await this.wrapBootstrapDisconnect(async () => {
      await this.adb.setAirplaneMode(shouldEnableAirplaneMode);
    });
    await this.wrapBootstrapDisconnect(async () => {
      await this.adb.broadcastAirplaneMode(shouldEnableAirplaneMode);
    });
  } else {
    _logger.default.info(`Not changing airplane mode, since it is already ` + `${shouldEnableAirplaneMode ? 'enabled' : 'disabled'}`);
  }

  if (shouldEnableWifi === isWiFiEnabled && shouldEnableDataConnection === isDataEnabled) {
    _logger.default.info('Not changing data connection/Wi-Fi states, since they are already set to expected values');

    if (await this.adb.isAirplaneModeOn()) {
      return AIRPLANE_MODE_MASK | currentState;
    }

    return ~AIRPLANE_MODE_MASK & currentState;
  }

  await this.wrapBootstrapDisconnect(async () => {
    if (shouldEnableWifi !== isWiFiEnabled) {
      await this.setWifiState(shouldEnableWifi);
    } else {
      _logger.default.info(`Not changing Wi-Fi state, since it is already ` + `${shouldEnableWifi ? 'enabled' : 'disabled'}`);
    }

    if (shouldEnableAirplaneMode) {
      _logger.default.info('Not changing data connection state, because airplane mode is enabled');
    } else if (shouldEnableDataConnection === isDataEnabled) {
      _logger.default.info(`Not changing data connection state, since it is already ` + `${shouldEnableDataConnection ? 'enabled' : 'disabled'}`);
    } else {
      await this.adb.setDataState(shouldEnableDataConnection, this.isEmulator());
    }
  });
  return await this.getNetworkConnection();
};

commands.setWifiState = async function setWifiState(wifi) {
  await this.adb.setWifiState(wifi, this.isEmulator());
};

commands.toggleData = async function toggleData() {
  let data = !(await this.adb.isDataOn());

  _logger.default.info(`Turning network data ${data ? 'on' : 'off'}`);

  await this.wrapBootstrapDisconnect(async () => {
    await this.adb.setWifiAndData({
      data
    }, this.isEmulator());
  });
};

commands.toggleWiFi = async function toggleWiFi() {
  let wifi = !(await this.adb.isWifiOn());

  _logger.default.info(`Turning WiFi ${wifi ? 'on' : 'off'}`);

  await this.wrapBootstrapDisconnect(async () => {
    await this.adb.setWifiAndData({
      wifi
    }, this.isEmulator());
  });
};

commands.toggleFlightMode = async function toggleFlightMode() {
  let flightMode = !(await this.adb.isAirplaneModeOn());

  _logger.default.info(`Turning flight mode ${flightMode ? 'on' : 'off'}`);

  await this.wrapBootstrapDisconnect(async () => {
    await this.adb.setAirplaneMode(flightMode);
  });
  await this.wrapBootstrapDisconnect(async () => {
    await this.adb.broadcastAirplaneMode(flightMode);
  });
};

commands.setGeoLocation = async function setGeoLocation(location) {
  await this.adb.setGeoLocation(location, this.isEmulator());

  try {
    return await this.getGeoLocation();
  } catch (e) {
    _logger.default.warn(`Could not get the current geolocation info: ${e.message}`);

    _logger.default.warn(`Returning the default zero'ed values`);

    return {
      latitude: GEO_EPSILON,
      longitude: GEO_EPSILON,
      altitude: GEO_EPSILON
    };
  }
};

commands.getGeoLocation = async function getGeoLocation() {
  const {
    latitude,
    longitude,
    altitude
  } = await this.adb.getGeoLocation();
  return {
    latitude: parseFloat(latitude) || GEO_EPSILON,
    longitude: parseFloat(longitude) || GEO_EPSILON,
    altitude: parseFloat(altitude) || GEO_EPSILON
  };
};

commands.toggleLocationServices = async function toggleLocationServices() {
  _logger.default.info('Toggling location services');

  let api = await this.adb.getApiLevel();

  if (this.isEmulator()) {
    let providers = await this.adb.getLocationProviders();
    let isGpsEnabled = providers.indexOf('gps') !== -1;
    await this.adb.toggleGPSLocationProvider(!isGpsEnabled);
    return;
  }

  if (api > 15) {
    let seq = [19, 19];

    if (api === 16) {
      seq.push(20);
    } else if (api >= 19) {
      seq = [22, 22, 19];
      await this.adb.keyevent(19);
    }

    await this.toggleSetting('LOCATION_SOURCE_SETTINGS', seq);
  } else {
    throw new _appiumBaseDriver.errors.NotYetImplementedError();
  }
};

helpers.toggleSetting = async function toggleSetting(setting, preKeySeq) {
  if (_lodash.default.isNull(preKeySeq)) {
    preKeySeq = [19, 19, 20];
  }

  await this.openSettingsActivity(setting);

  for (let key of preKeySeq) {
    await this.doKey(key);
  }

  let {
    appPackage,
    appActivity
  } = await this.adb.getFocusedPackageAndActivity();
  await this.wrapBootstrapDisconnect(async () => {
    await this.doKey(23);
  });

  try {
    await this.adb.waitForNotActivity(appPackage, appActivity, 5000);
    await this.doKey(22);
    await this.doKey(23);
    await this.adb.waitForNotActivity(appPackage, appActivity, 5000);
  } catch (ign) {}

  await this.adb.back();
};

helpers.doKey = async function doKey(key) {
  await _bluebird.default.delay(2000);
  await this.adb.keyevent(key);
};

helpers.wrapBootstrapDisconnect = async function wrapBootstrapDisconnect(wrapped) {
  if (!this.bootstrap) {
    return await wrapped();
  }

  this.bootstrap.ignoreUnexpectedShutdown = true;

  try {
    await wrapped();
    await this.adb.restart();
    await this.bootstrap.start(this.opts.appPackage, this.opts.disableAndroidWatchers, this.opts.acceptSslCerts);
  } finally {
    this.bootstrap.ignoreUnexpectedShutdown = false;
  }
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9uZXR3b3JrLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJBSVJQTEFORV9NT0RFX01BU0siLCJXSUZJX01BU0siLCJEQVRBX01BU0siLCJHRU9fRVBTSUxPTiIsIk51bWJlciIsIk1JTl9WQUxVRSIsImdldE5ldHdvcmtDb25uZWN0aW9uIiwibG9nIiwiaW5mbyIsImFpcnBsYW5lTW9kZU9uIiwiYWRiIiwiaXNBaXJwbGFuZU1vZGVPbiIsImNvbm5lY3Rpb24iLCJ3aWZpT24iLCJpc1dpZmlPbiIsImRhdGFPbiIsImlzRGF0YU9uIiwic2V0TmV0d29ya0Nvbm5lY3Rpb24iLCJ0eXBlIiwic2hvdWxkRW5hYmxlQWlycGxhbmVNb2RlIiwic2hvdWxkRW5hYmxlV2lmaSIsInNob3VsZEVuYWJsZURhdGFDb25uZWN0aW9uIiwiY3VycmVudFN0YXRlIiwiaXNBaXJwbGFuZU1vZGVFbmFibGVkIiwiaXNXaUZpRW5hYmxlZCIsImlzRGF0YUVuYWJsZWQiLCJ3cmFwQm9vdHN0cmFwRGlzY29ubmVjdCIsInNldEFpcnBsYW5lTW9kZSIsImJyb2FkY2FzdEFpcnBsYW5lTW9kZSIsInNldFdpZmlTdGF0ZSIsInNldERhdGFTdGF0ZSIsImlzRW11bGF0b3IiLCJ3aWZpIiwidG9nZ2xlRGF0YSIsImRhdGEiLCJzZXRXaWZpQW5kRGF0YSIsInRvZ2dsZVdpRmkiLCJ0b2dnbGVGbGlnaHRNb2RlIiwiZmxpZ2h0TW9kZSIsInNldEdlb0xvY2F0aW9uIiwibG9jYXRpb24iLCJnZXRHZW9Mb2NhdGlvbiIsImUiLCJ3YXJuIiwibWVzc2FnZSIsImxhdGl0dWRlIiwibG9uZ2l0dWRlIiwiYWx0aXR1ZGUiLCJwYXJzZUZsb2F0IiwidG9nZ2xlTG9jYXRpb25TZXJ2aWNlcyIsImFwaSIsImdldEFwaUxldmVsIiwicHJvdmlkZXJzIiwiZ2V0TG9jYXRpb25Qcm92aWRlcnMiLCJpc0dwc0VuYWJsZWQiLCJpbmRleE9mIiwidG9nZ2xlR1BTTG9jYXRpb25Qcm92aWRlciIsInNlcSIsInB1c2giLCJrZXlldmVudCIsInRvZ2dsZVNldHRpbmciLCJlcnJvcnMiLCJOb3RZZXRJbXBsZW1lbnRlZEVycm9yIiwic2V0dGluZyIsInByZUtleVNlcSIsIl8iLCJpc051bGwiLCJvcGVuU2V0dGluZ3NBY3Rpdml0eSIsImtleSIsImRvS2V5IiwiYXBwUGFja2FnZSIsImFwcEFjdGl2aXR5IiwiZ2V0Rm9jdXNlZFBhY2thZ2VBbmRBY3Rpdml0eSIsIndhaXRGb3JOb3RBY3Rpdml0eSIsImlnbiIsImJhY2siLCJCIiwiZGVsYXkiLCJ3cmFwcGVkIiwiYm9vdHN0cmFwIiwiaWdub3JlVW5leHBlY3RlZFNodXRkb3duIiwicmVzdGFydCIsInN0YXJ0Iiwib3B0cyIsImRpc2FibGVBbmRyb2lkV2F0Y2hlcnMiLCJhY2NlcHRTc2xDZXJ0cyIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7QUFFQSxNQUFNQyxrQkFBa0IsR0FBRyxLQUEzQjtBQUNBLE1BQU1DLFNBQVMsR0FBRyxLQUFsQjtBQUNBLE1BQU1DLFNBQVMsR0FBRyxLQUFsQjtBQU1BLE1BQU1DLFdBQVcsR0FBR0MsTUFBTSxDQUFDQyxTQUEzQjs7QUFFQVIsUUFBUSxDQUFDUyxvQkFBVCxHQUFnQyxlQUFlQSxvQkFBZixHQUF1QztBQUNyRUMsa0JBQUlDLElBQUosQ0FBUyw0QkFBVDs7QUFDQSxNQUFJQyxjQUFjLEdBQUcsTUFBTSxLQUFLQyxHQUFMLENBQVNDLGdCQUFULEVBQTNCO0FBQ0EsTUFBSUMsVUFBVSxHQUFHSCxjQUFjLEdBQUdULGtCQUFILEdBQXdCLENBQXZEOztBQUdBLE1BQUksQ0FBQ1MsY0FBTCxFQUFxQjtBQUNuQixRQUFJSSxNQUFNLEdBQUcs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LEdBQVAsRUFBWSxDQUFFOztBQUVoQixRQUFNLEtBQUtoRSxHQUFMLENBQVNpRSxJQUFULEVBQU47QUFDRCxDQTFDRDs7QUE0Q0E3RSxPQUFPLENBQUN1RSxLQUFSLEdBQWdCLGVBQWVBLEtBQWYsQ0FBc0JELEdBQXRCLEVBQTJCO0FBRXpDLFFBQU1RLGtCQUFFQyxLQUFGLENBQVEsSUFBUixDQUFOO0FBQ0EsUUFBTSxLQUFLbkUsR0FBTCxDQUFTaUQsUUFBVCxDQUFrQlMsR0FBbEIsQ0FBTjtBQUNELENBSkQ7O0FBTUF0RSxPQUFPLENBQUM0Qix1QkFBUixHQUFrQyxlQUFlQSx1QkFBZixDQUF3Q29ELE9BQXhDLEVBQWlEO0FBQ2pGLE1BQUksQ0FBQyxLQUFLQyxTQUFWLEVBQXFCO0FBQ25CLFdBQU8sTUFBTUQsT0FBTyxFQUFwQjtBQUNEOztBQUVELE9BQUtDLFNBQUwsQ0FBZUMsd0JBQWYsR0FBMEMsSUFBMUM7O0FBQ0EsTUFBSTtBQUNGLFVBQU1GLE9BQU8sRUFBYjtBQUNBLFVBQU0sS0FBS3BFLEdBQUwsQ0FBU3VFLE9BQVQsRUFBTjtBQUNBLFVBQU0sS0FBS0YsU0FBTCxDQUFlRyxLQUFmLENBQXFCLEtBQUtDLElBQUwsQ0FBVWIsVUFBL0IsRUFBMkMsS0FBS2EsSUFBTCxDQUFVQyxzQkFBckQsRUFBNkUsS0FBS0QsSUFBTCxDQUFVRSxjQUF2RixDQUFOO0FBQ0QsR0FKRCxTQUlVO0FBQ1IsU0FBS04sU0FBTCxDQUFlQyx3QkFBZixHQUEwQyxLQUExQztBQUNEO0FBQ0YsQ0FiRDs7QUFlQU0sTUFBTSxDQUFDQyxNQUFQLENBQWN4RixVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbnN0IEFJUlBMQU5FX01PREVfTUFTSyA9IDBiMDAxO1xuY29uc3QgV0lGSV9NQVNLID0gMGIwMTA7XG5jb25zdCBEQVRBX01BU0sgPSAwYjEwMDtcbi8vIFRoZSB2YWx1ZSBjbG9zZSB0byB6ZXJvLCBidXQgbm90IHplcm8sIGlzIG5lZWRlZFxuLy8gdG8gdHJpY2sgSlNPTiBnZW5lcmF0aW9uIGFuZCBzZW5kIGEgZmxvYXQgdmFsdWUgaW5zdGVhZCBvZiBhbiBpbnRlZ2VyLFxuLy8gVGhpcyBhbGxvd3Mgc3RyaWN0bHktdHlwZWQgY2xpZW50cywgbGlrZSBKYXZhLCB0byBwcm9wZXJseVxuLy8gcGFyc2UgaXQuIE90aGVyd2lzZSBmbG9hdCAwLjAgaXMgYWx3YXlzIHJlcHJlc2VudGVkIGFzIGludGVnZXIgMCBpbiBKUy5cbi8vIFRoZSB2YWx1ZSBtdXN0IG5vdCBiZSBncmVhdGVyIHRoYW4gREJMX0VQU0lMT04gKGh0dHBzOi8vb3BlbnNvdXJjZS5hcHBsZS5jb20vc291cmNlL0xpYmMvTGliYy00OTgvaW5jbHVkZS9mbG9hdC5oKVxuY29uc3QgR0VPX0VQU0lMT04gPSBOdW1iZXIuTUlOX1ZBTFVFO1xuXG5jb21tYW5kcy5nZXROZXR3b3JrQ29ubmVjdGlvbiA9IGFzeW5jIGZ1bmN0aW9uIGdldE5ldHdvcmtDb25uZWN0aW9uICgpIHtcbiAgbG9nLmluZm8oJ0dldHRpbmcgbmV0d29yayBjb25uZWN0aW9uJyk7XG4gIGxldCBhaXJwbGFuZU1vZGVPbiA9IGF3YWl0IHRoaXMuYWRiLmlzQWlycGxhbmVNb2RlT24oKTtcbiAgbGV0IGNvbm5lY3Rpb24gPSBhaXJwbGFuZU1vZGVPbiA/IEFJUlBMQU5FX01PREVfTUFTSyA6IDA7XG5cbiAgLy8gbm8gbmVlZCB0byBjaGVjayBhbnl0aGluZyBlbHNlIGlmIHdlIGFyZSBpbiBhaXJwbGFuZSBtb2RlXG4gIGlmICghYWlycGxhbmVNb2RlT24pIHtcbiAgICBsZXQgd2lmaU9uID0gYXdhaXQgdGhpcy5pc1dpZmlPbigpO1xuICAgIGNvbm5lY3Rpb24gfD0gKHdpZmlPbiA/IFdJRklfTUFTSyA6IDApO1xuICAgIGxldCBkYXRhT24gPSBhd2FpdCB0aGlzLmFkYi5pc0RhdGFPbigpO1xuICAgIGNvbm5lY3Rpb24gfD0gKGRhdGFPbiA/IERBVEFfTUFTSyA6IDApO1xuICB9XG5cbiAgcmV0dXJuIGNvbm5lY3Rpb247XG59O1xuXG4vKipcbiAqIGRlY291cGxpbmcgdG8gb3ZlcnJpZGUgdGhlIGJlaGF2aW91ciBpbiBvdGhlciBkcml2ZXJzIGxpa2UgVWlBdXRvbWF0b3IyLlxuICovXG5jb21tYW5kcy5pc1dpZmlPbiA9IGFzeW5jIGZ1bmN0aW9uIGlzV2lmaU9uICgpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuYWRiLmlzV2lmaU9uKCk7XG59O1xuXG5jb21tYW5kcy5zZXROZXR3b3JrQ29ubmVjdGlvbiA9IGFzeW5jIGZ1bmN0aW9uIHNldE5ldHdvcmtDb25uZWN0aW9uICh0eXBlKSB7XG4gIGxvZy5pbmZvKCdTZXR0aW5nIG5ldHdvcmsgY29ubmVjdGlvbicpO1xuICAvLyBkZWNvZGUgdGhlIGlucHV0XG4gIGNvbnN0IHNob3VsZEVuYWJsZUFpcnBsYW5lTW9kZSA9ICh0eXBlICYgQUlSUExBTkVfTU9ERV9NQVNLKSAhPT0gMDtcbiAgY29uc3Qgc2hvdWxkRW5hYmxlV2lmaSA9ICh0eXBlICYgV0lGSV9NQVNLKSAhPT0gMDtcbiAgY29uc3Qgc2hvdWxkRW5hYmxlRGF0YUNvbm5lY3Rpb24gPSAodHlwZSAmIERBVEFfTUFTSykgIT09IDA7XG5cbiAgY29uc3QgY3VycmVudFN0YXRlID0gYXdhaXQgdGhpcy5nZXROZXR3b3JrQ29ubmVjdGlvbigpO1xuICBjb25zdCBpc0FpcnBsYW5lTW9kZUVuYWJsZWQgPSAoY3VycmVudFN0YXRlICYgQUlSUExBTkVfTU9ERV9NQVNLKSAhPT0gMDtcbiAgY29uc3QgaXNXaUZpRW5hYmxlZCA9IChjdXJyZW50U3RhdGUgJiBXSUZJX01BU0spICE9PSAwO1xuICBjb25zdCBpc0RhdGFFbmFibGVkID0gKGN1cnJlbnRTdGF0ZSAmIERBVEFfTUFTSykgIT09IDA7XG5cbiAgaWYgKHNob3VsZEVuYWJsZUFpcnBsYW5lTW9kZSAhPT0gaXNBaXJwbGFuZU1vZGVFbmFibGVkKSB7XG4gICAgYXdhaXQgdGhpcy53cmFwQm9vdHN0cmFwRGlzY29ubmVjdChhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5zZXRBaXJwbGFuZU1vZGUoc2hvdWxkRW5hYmxlQWlycGxhbmVNb2RlKTtcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLndyYXBCb290c3RyYXBEaXNjb25uZWN0KGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLmJyb2FkY2FzdEFpcnBsYW5lTW9kZShzaG91bGRFbmFibGVBaXJwbGFuZU1vZGUpO1xuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIGxvZy5pbmZvKGBOb3QgY2hhbmdpbmcgYWlycGxhbmUgbW9kZSwgc2luY2UgaXQgaXMgYWxyZWFkeSBgICtcbiAgICAgICAgICAgICBgJHtzaG91bGRFbmFibGVBaXJwbGFuZU1vZGUgPyAnZW5hYmxlZCcgOiAnZGlzYWJsZWQnfWApO1xuICB9XG5cbiAgaWYgKHNob3VsZEVuYWJsZVdpZmkgPT09IGlzV2lGaUVuYWJsZWQgJiYgc2hvdWxkRW5hYmxlRGF0YUNvbm5lY3Rpb24gPT09IGlzRGF0YUVuYWJsZWQpIHtcbiAgICBsb2cuaW5mbygnTm90IGNoYW5naW5nIGRhdGEgY29ubmVjdGlvbi9XaS1GaSBzdGF0ZXMsIHNpbmNlIHRoZXkgYXJlIGFscmVhZHkgc2V0IHRvIGV4cGVjdGVkIHZhbHVlcycpO1xuICAgIGlmIChhd2FpdCB0aGlzLmFkYi5pc0FpcnBsYW5lTW9kZU9uKCkpIHtcbiAgICAgIHJldHVybiBBSVJQTEFORV9NT0RFX01BU0sgfCBjdXJyZW50U3RhdGU7XG4gICAgfVxuICAgIHJldHVybiB+QUlSUExBTkVfTU9ERV9NQVNLICYgY3VycmVudFN0YXRlO1xuICB9XG5cbiAgYXdhaXQgdGhpcy53cmFwQm9vdHN0cmFwRGlzY29ubmVjdChhc3luYyAoKSA9PiB7XG4gICAgaWYgKHNob3VsZEVuYWJsZVdpZmkgIT09IGlzV2lGaUVuYWJsZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0V2lmaVN0YXRlKHNob3VsZEVuYWJsZVdpZmkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuaW5mbyhgTm90IGNoYW5naW5nIFdpLUZpIHN0YXRlLCBzaW5jZSBpdCBpcyBhbHJlYWR5IGAgK1xuICAgICAgICAgICAgICAgYCR7c2hvdWxkRW5hYmxlV2lmaSA/ICdlbmFibGVkJyA6ICdkaXNhYmxlZCd9YCk7XG4gICAgfVxuXG4gICAgaWYgKHNob3VsZEVuYWJsZUFpcnBsYW5lTW9kZSkge1xuICAgICAgbG9nLmluZm8oJ05vdCBjaGFuZ2luZyBkYXRhIGNvbm5lY3Rpb24gc3RhdGUsIGJlY2F1c2UgYWlycGxhbmUgbW9kZSBpcyBlbmFibGVkJyk7XG4gICAgfSBlbHNlIGlmIChzaG91bGRFbmFibGVEYXRhQ29ubmVjdGlvbiA9PT0gaXNEYXRhRW5hYmxlZCkge1xuICAgICAgbG9nLmluZm8oYE5vdCBjaGFuZ2luZyBkYXRhIGNvbm5lY3Rpb24gc3RhdGUsIHNpbmNlIGl0IGlzIGFscmVhZHkgYCArXG4gICAgICAgICAgICAgICBgJHtzaG91bGRFbmFibGVEYXRhQ29ubmVjdGlvbiA/ICdlbmFibGVkJyA6ICdkaXNhYmxlZCd9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnNldERhdGFTdGF0ZShzaG91bGRFbmFibGVEYXRhQ29ubmVjdGlvbiwgdGhpcy5pc0VtdWxhdG9yKCkpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0TmV0d29ya0Nvbm5lY3Rpb24oKTtcbn07XG5cbi8qKlxuICogZGVjb3VwbGluZyB0byBvdmVycmlkZSBiZWhhdmlvdXIgaW4gb3RoZXIgZHJpdmVycyBsaWtlIFVpQXV0b21hdG9yMi5cbiAqL1xuY29tbWFuZHMuc2V0V2lmaVN0YXRlID0gYXN5bmMgZnVuY3Rpb24gc2V0V2lmaVN0YXRlICh3aWZpKSB7XG4gIGF3YWl0IHRoaXMuYWRiLnNldFdpZmlTdGF0ZSh3aWZpLCB0aGlzLmlzRW11bGF0b3IoKSk7XG59O1xuXG5jb21tYW5kcy50b2dnbGVEYXRhID0gYXN5bmMgZnVuY3Rpb24gdG9nZ2xlRGF0YSAoKSB7XG4gIGxldCBkYXRhID0gIShhd2FpdCB0aGlzLmFkYi5pc0RhdGFPbigpKTtcbiAgbG9nLmluZm8oYFR1cm5pbmcgbmV0d29yayBkYXRhICR7ZGF0YSA/ICdvbicgOiAnb2ZmJ31gKTtcbiAgYXdhaXQgdGhpcy53cmFwQm9vdHN0cmFwRGlzY29ubmVjdChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdGhpcy5hZGIuc2V0V2lmaUFuZERhdGEoe2RhdGF9LCB0aGlzLmlzRW11bGF0b3IoKSk7XG4gIH0pO1xufTtcblxuY29tbWFuZHMudG9nZ2xlV2lGaSA9IGFzeW5jIGZ1bmN0aW9uIHRvZ2dsZVdpRmkgKCkge1xuICBsZXQgd2lmaSA9ICEoYXdhaXQgdGhpcy5hZGIuaXNXaWZpT24oKSk7XG4gIGxvZy5pbmZvKGBUdXJuaW5nIFdpRmkgJHt3aWZpID8gJ29uJyA6ICdvZmYnfWApO1xuICBhd2FpdCB0aGlzLndyYXBCb290c3RyYXBEaXNjb25uZWN0KGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCB0aGlzLmFkYi5zZXRXaWZpQW5kRGF0YSh7d2lmaX0sIHRoaXMuaXNFbXVsYXRvcigpKTtcbiAgfSk7XG59O1xuXG5jb21tYW5kcy50b2dnbGVGbGlnaHRNb2RlID0gYXN5bmMgZnVuY3Rpb24gdG9nZ2xlRmxpZ2h0TW9kZSAoKSB7XG4gIC8qXG4gICAqIFRPRE86IEltcGxlbWVudCBpc1JlYWxEZXZpY2UoKS4gVGhpcyBtZXRob2QgZmFpbHMgb25cbiAgICogcmVhbCBkZXZpY2VzLCBpdCBzaG91bGQgdGhyb3cgYSBOb3RZZXRJbXBsZW1lbnRlZEVycm9yXG4gICAqL1xuICBsZXQgZmxpZ2h0TW9kZSA9ICEoYXdhaXQgdGhpcy5hZGIuaXNBaXJwbGFuZU1vZGVPbigpKTtcbiAgbG9nLmluZm8oYFR1cm5pbmcgZmxpZ2h0IG1vZGUgJHtmbGlnaHRNb2RlID8gJ29uJyA6ICdvZmYnfWApO1xuICBhd2FpdCB0aGlzLndyYXBCb290c3RyYXBEaXNjb25uZWN0KGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCB0aGlzLmFkYi5zZXRBaXJwbGFuZU1vZGUoZmxpZ2h0TW9kZSk7XG4gIH0pO1xuICBhd2FpdCB0aGlzLndyYXBCb290c3RyYXBEaXNjb25uZWN0KGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCB0aGlzLmFkYi5icm9hZGNhc3RBaXJwbGFuZU1vZGUoZmxpZ2h0TW9kZSk7XG4gIH0pO1xufTtcblxuY29tbWFuZHMuc2V0R2VvTG9jYXRpb24gPSBhc3luYyBmdW5jdGlvbiBzZXRHZW9Mb2NhdGlvbiAobG9jYXRpb24pIHtcbiAgYXdhaXQgdGhpcy5hZGIuc2V0R2VvTG9jYXRpb24obG9jYXRpb24sIHRoaXMuaXNFbXVsYXRvcigpKTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRHZW9Mb2NhdGlvbigpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLndhcm4oYENvdWxkIG5vdCBnZXQgdGhlIGN1cnJlbnQgZ2VvbG9jYXRpb24gaW5mbzogJHtlLm1lc3NhZ2V9YCk7XG4gICAgbG9nLndhcm4oYFJldHVybmluZyB0aGUgZGVmYXVsdCB6ZXJvJ2VkIHZhbHVlc2ApO1xuICAgIHJldHVybiB7XG4gICAgICBsYXRpdHVkZTogR0VPX0VQU0lMT04sXG4gICAgICBsb25naXR1ZGU6IEdFT19FUFNJTE9OLFxuICAgICAgYWx0aXR1ZGU6IEdFT19FUFNJTE9OLFxuICAgIH07XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldEdlb0xvY2F0aW9uID0gYXN5bmMgZnVuY3Rpb24gZ2V0R2VvTG9jYXRpb24gKCkge1xuICBjb25zdCB7bGF0aXR1ZGUsIGxvbmdpdHVkZSwgYWx0aXR1ZGV9ID0gYXdhaXQgdGhpcy5hZGIuZ2V0R2VvTG9jYXRpb24oKTtcbiAgcmV0dXJuIHtcbiAgICBsYXRpdHVkZTogcGFyc2VGbG9hdChsYXRpdHVkZSkgfHwgR0VPX0VQU0lMT04sXG4gICAgbG9uZ2l0dWRlOiBwYXJzZUZsb2F0KGxvbmdpdHVkZSkgfHwgR0VPX0VQU0lMT04sXG4gICAgYWx0aXR1ZGU6IHBhcnNlRmxvYXQoYWx0aXR1ZGUpIHx8IEdFT19FUFNJTE9OLFxuICB9O1xufTtcblxuY29tbWFuZHMudG9nZ2xlTG9jYXRpb25TZXJ2aWNlcyA9IGFzeW5jIGZ1bmN0aW9uIHRvZ2dsZUxvY2F0aW9uU2VydmljZXMgKCkge1xuICBsb2cuaW5mbygnVG9nZ2xpbmcgbG9jYXRpb24gc2VydmljZXMnKTtcbiAgbGV0IGFwaSA9IGF3YWl0IHRoaXMuYWRiLmdldEFwaUxldmVsKCk7XG4gIGlmICh0aGlzLmlzRW11bGF0b3IoKSkge1xuICAgIGxldCBwcm92aWRlcnMgPSBhd2FpdCB0aGlzLmFkYi5nZXRMb2NhdGlvblByb3ZpZGVycygpO1xuICAgIGxldCBpc0dwc0VuYWJsZWQgPSBwcm92aWRlcnMuaW5kZXhPZignZ3BzJykgIT09IC0xO1xuICAgIGF3YWl0IHRoaXMuYWRiLnRvZ2dsZUdQU0xvY2F0aW9uUHJvdmlkZXIoIWlzR3BzRW5hYmxlZCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKGFwaSA+IDE1KSB7XG4gICAgbGV0IHNlcSA9IFsxOSwgMTldOyAvLyB1cCwgdXBcbiAgICBpZiAoYXBpID09PSAxNikge1xuICAgICAgLy8gVGhpcyB2ZXJzaW9uIG9mIEFuZHJvaWQgaGFzIGEgXCJwYXJlbnRcIiBidXR0b24gaW4gaXRzIGFjdGlvbiBiYXJcbiAgICAgIHNlcS5wdXNoKDIwKTsgLy8gZG93blxuICAgIH0gZWxzZSBpZiAoYXBpID49IDE5KSB7XG4gICAgICAvLyBOZXdlciB2ZXJzaW9ucyBvZiBBbmRyb2lkIGhhdmUgdGhlIHRvZ2dsZSBpbiB0aGUgQWN0aW9uIGJhclxuICAgICAgc2VxID0gWzIyLCAyMiwgMTldOyAvLyByaWdodCwgcmlnaHQsIHVwXG4gICAgICAvKlxuICAgICAgICogT25jZSB0aGUgTG9jYXRpb24gc2VydmljZXMgc3dpdGNoIGlzIE9GRiwgaXQgd29uJ3QgcmVjZWl2ZSBmb2N1c1xuICAgICAgICogd2hlbiBnb2luZyBiYWNrIHRvIHRoZSBMb2NhdGlvbiBTZXJ2aWNlcyBzZXR0aW5ncyBzY3JlZW4gdW5sZXNzIHdlXG4gICAgICAgKiBzZW5kIGEgZHVtbXkga2V5ZXZlbnQgKFVQKSAqYmVmb3JlKiBvcGVuaW5nIHRoZSBzZXR0aW5ncyBzY3JlZW5cbiAgICAgICAqL1xuICAgICAgYXdhaXQgdGhpcy5hZGIua2V5ZXZlbnQoMTkpO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLnRvZ2dsZVNldHRpbmcoJ0xPQ0FUSU9OX1NPVVJDRV9TRVRUSU5HUycsIHNlcSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gVGhlcmUncyBubyBnbG9iYWwgbG9jYXRpb24gc2VydmljZXMgdG9nZ2xlIG9uIG9sZGVyIEFuZHJvaWQgdmVyc2lvbnNcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxufTtcblxuaGVscGVycy50b2dnbGVTZXR0aW5nID0gYXN5bmMgZnVuY3Rpb24gdG9nZ2xlU2V0dGluZyAoc2V0dGluZywgcHJlS2V5U2VxKSB7XG4gIC8qXG4gICAqIHByZUtleVNlcSBpcyB0aGUga2V5ZXZlbnQgc2VxdWVuY2UgdG8gc2VuZCBvdmVyIEFEQiBpbiBvcmRlclxuICAgKiB0byBwb3NpdGlvbiB0aGUgY3Vyc29yIG9uIHRoZSByaWdodCBvcHRpb24uXG4gICAqIEJ5IGRlZmF1bHQgaXQncyBbdXAsIHVwLCBkb3duXSBiZWNhdXNlIHdlIHVzdWFsbHkgdGFyZ2V0IHRoZSAxc3QgaXRlbSBpblxuICAgKiB0aGUgc2NyZWVuLCBhbmQgc29tZXRpbWVzIHdoZW4gb3BlbmluZyBzZXR0aW5ncyBhY3Rpdml0aWVzIHRoZSBjdXJzb3IgaXNcbiAgICogYWxyZWFkeSBwb3NpdGlvbm5lZCBvbiB0aGUgMXN0IGl0ZW0sIGJ1dCB3ZSBjYW4ndCBrbm93IGZvciBzdXJlXG4gICAqL1xuICBpZiAoXy5pc051bGwocHJlS2V5U2VxKSkge1xuICAgIHByZUtleVNlcSA9IFsxOSwgMTksIDIwXTsgLy8gdXAsIHVwLCBkb3duXG4gIH1cblxuICBhd2FpdCB0aGlzLm9wZW5TZXR0aW5nc0FjdGl2aXR5KHNldHRpbmcpO1xuXG4gIGZvciAobGV0IGtleSBvZiBwcmVLZXlTZXEpIHtcbiAgICBhd2FpdCB0aGlzLmRvS2V5KGtleSk7XG4gIH1cblxuICBsZXQge2FwcFBhY2thZ2UsIGFwcEFjdGl2aXR5fSA9IGF3YWl0IHRoaXMuYWRiLmdldEZvY3VzZWRQYWNrYWdlQW5kQWN0aXZpdHkoKTtcblxuICAvKlxuICAgKiBDbGljayBhbmQgaGFuZGxlIHBvdGVudGlhbCBBREIgZGlzY29ubmVjdCB0aGF0IG9jY3VycyBvbiBvZmZpY2lhbFxuICAgKiBlbXVsYXRvciB3aGVuIHRoZSBuZXR3b3JrIGNvbm5lY3Rpb24gaXMgZGlzYWJsZWRcbiAgICovXG4gIGF3YWl0IHRoaXMud3JhcEJvb3RzdHJhcERpc2Nvbm5lY3QoYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHRoaXMuZG9LZXkoMjMpO1xuICB9KTtcblxuICAvKlxuICAgKiBJbiBvbmUgcGFydGljdWxhciBjYXNlIChlbmFibGUgTG9jYXRpb24gU2VydmljZXMpLCBhIHBvcC11cCBpc1xuICAgKiBkaXNwbGF5ZWQgb24gc29tZSBwbGF0Zm9ybXMgc28gdGhlIHVzZXIgYWNjZXB0cyBvciByZWZ1c2VzIHRoYXQgR29vZ2xlXG4gICAqIGNvbGxlY3RzIGxvY2F0aW9uIGRhdGEuIFNvIHdlIHdhaXQgZm9yIHRoYXQgcG9wLXVwIHRvIG9wZW4sIGlmIGl0XG4gICAqIGRvZXNuJ3QgdGhlbiBwcm9jZWVkXG4gICAqL1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuYWRiLndhaXRGb3JOb3RBY3Rpdml0eShhcHBQYWNrYWdlLCBhcHBBY3Rpdml0eSwgNTAwMCk7XG4gICAgYXdhaXQgdGhpcy5kb0tleSgyMik7IC8vIHJpZ2h0XG4gICAgYXdhaXQgdGhpcy5kb0tleSgyMyk7IC8vIGNsaWNrXG4gICAgYXdhaXQgdGhpcy5hZGIud2FpdEZvck5vdEFjdGl2aXR5KGFwcFBhY2thZ2UsIGFwcEFjdGl2aXR5LCA1MDAwKTtcbiAgfSBjYXRjaCAoaWduKSB7fVxuXG4gIGF3YWl0IHRoaXMuYWRiLmJhY2soKTtcbn07XG5cbmhlbHBlcnMuZG9LZXkgPSBhc3luYyBmdW5jdGlvbiBkb0tleSAoa2V5KSB7XG4gIC8vIFRPRE86IENvbmZpcm0gd2UgbmVlZCB0aGlzIGRlbGF5LiBTZWVtcyB0byB3b3JrIHdpdGhvdXQgaXQuXG4gIGF3YWl0IEIuZGVsYXkoMjAwMCk7XG4gIGF3YWl0IHRoaXMuYWRiLmtleWV2ZW50KGtleSk7XG59O1xuXG5oZWxwZXJzLndyYXBCb290c3RyYXBEaXNjb25uZWN0ID0gYXN5bmMgZnVuY3Rpb24gd3JhcEJvb3RzdHJhcERpc2Nvbm5lY3QgKHdyYXBwZWQpIHtcbiAgaWYgKCF0aGlzLmJvb3RzdHJhcCkge1xuICAgIHJldHVybiBhd2FpdCB3cmFwcGVkKCk7XG4gIH1cblxuICB0aGlzLmJvb3RzdHJhcC5pZ25vcmVVbmV4cGVjdGVkU2h1dGRvd24gPSB0cnVlO1xuICB0cnkge1xuICAgIGF3YWl0IHdyYXBwZWQoKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5yZXN0YXJ0KCk7XG4gICAgYXdhaXQgdGhpcy5ib290c3RyYXAuc3RhcnQodGhpcy5vcHRzLmFwcFBhY2thZ2UsIHRoaXMub3B0cy5kaXNhYmxlQW5kcm9pZFdhdGNoZXJzLCB0aGlzLm9wdHMuYWNjZXB0U3NsQ2VydHMpO1xuICB9IGZpbmFsbHkge1xuICAgIHRoaXMuYm9vdHN0cmFwLmlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biA9IGZhbHNlO1xuICB9XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvbmV0d29yay5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
