"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _androidHelpers = _interopRequireDefault(require("../android-helpers"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.doTouchAction = async function doTouchAction(action, opts) {
  switch (action) {
    case 'tap':
      return await this.tap(opts.element, opts.x, opts.y, opts.count);

    case 'press':
      return await this.touchDown(opts.element, opts.x, opts.y);

    case 'release':
      return await this.touchUp(opts.element, opts.x, opts.y);

    case 'moveTo':
      return await this.touchMove(opts.element, opts.x, opts.y);

    case 'wait':
      return await _bluebird.default.delay(opts.ms);

    case 'longPress':
      if (typeof opts.duration === 'undefined' || !opts.duration) {
        opts.duration = 1000;
      }

      return await this.touchLongClick(opts.element, opts.x, opts.y, opts.duration);

    case 'cancel':
      _logger.default.warn('Cancel action currently has no effect');

      break;

    default:
      _logger.default.errorAndThrow(`unknown action ${action}`);

  }
};

helpers.doTouchDrag = async function doTouchDrag(gestures) {
  let longPress = gestures[0];
  let moveTo = gestures[1];
  let startX = longPress.options.x || 0,
      startY = longPress.options.y || 0,
      endX = moveTo.options.x || 0,
      endY = moveTo.options.y || 0;

  if (longPress.options.element) {
    let {
      x,
      y
    } = await this.getLocationInView(longPress.options.element);
    startX += x || 0;
    startY += y || 0;
  }

  if (moveTo.options.element) {
    let {
      x,
      y
    } = await this.getLocationInView(moveTo.options.element);
    endX += x || 0;
    endY += y || 0;
  }

  let apiLevel = await this.adb.getApiLevel();
  let duration = apiLevel >= 5 ? 2 : 1;

  if (longPress.options && longPress.options.duration) {
    duration = Math.max(longPress.options.duration / 1000, duration);
  }

  return await this.drag(startX, startY, endX, endY, duration, 1, longPress.options.element, moveTo.options.element);
};

helpers.fixRelease = async function fixRelease(gestures) {
  let release = _lodash.default.last(gestures);

  release.options = release.options || {};

  if (release.options.element || release.options.x && release.options.y) {
    return;
  }

  gestures = _lodash.default.clone(gestures);
  let ref = null;

  for (let gesture of gestures.reverse()) {
    let opts = gesture.options;

    if (opts.element || opts.x && opts.y) {
      ref = gesture;
      break;
    }
  }

  if (ref) {
    let opts = ref.options;

    if (opts.element) {
      let loc = await this.getLocationInView(opts.element);

      if (opts.x && opts.y) {
        release.options = {
          x: loc.x + opts.x,
          y: loc.y + opts.y
        };
      } else {
        let size = await this.getSize(opts.element);
        release.options = {
          x: loc.x + size.width / 2,
          y: loc.y + size.height / 2
        };
      }
    } else {
      release.options = _lodash.default.pick(opts, 'x', 'y');
    }
  }

  return release;
};

helpers.performGesture = async function performGesture(gesture) {
  try {
    return await this.doTouchAction(gesture.action, gesture.options || {});
  } catch (e) {
    if ((0, _appiumBaseDriver.isErrorType)(e, _appiumBaseDriver.errors.NoSuchElementError) && gesture.action === 'release' && gesture.options.element) {
      delete gesture.options.element;

      _logger.default.debug(`retrying release without element opts: ${gesture.options}.`);

      return await this.doTouchAction(gesture.action, gesture.options || {});
    }

    throw e;
  }
};

commands.performTouch = async function performTouch(gestures) {
  if (gestures.length === 4 && gestures[0].action === 'press' && gestures[1].action === 'wait' && gestures[2].action === 'moveTo' && gestures[3].action === 'release') {
    let swipeOpts = await this.getSwipeOptions(gestures);
    return await this.swipe(swipeOpts.startX, swipeOpts.startY, swipeOpts.endX, swipeOpts.endY, swipeOpts.duration, swipeOpts.touchCount, swipeOpts.element);
  }

  let actions = _lodash.default.map(gestures, 'action');

  if (actions[0] === 'longPress' && actions[1] === 'moveTo' && actions[2] === 'release') {
    return await this.doTouchDrag(gestures);
  } else {
    if (actions.length === 2) {
      if (_lodash.default.head(actions) === 'press' && _lodash.default.last(actions) === 'release') {
        actions[0] = 'tap';
        gestures[0].action = 'tap';
      }

      if ((_lodash.default.head(actions) === 'tap' || _lodash.default.head(actions) === 'longPress') && _lodash.default.last(actions) === 'release') {
        gestures.pop();
        actions.pop();
      }
    } else {
      if (actions[0] === 'longPress') {
        actions = ['press', 'wait', ...actions.slice(1)];
        let press = gestures.shift();
        press.action = 'press';
        let wait = {
          action: 'wait',
          options: {
            ms: press.options.duration || 1000
          }
        };
        delete press.options.duration;
        gestures = [press, wait, ...gestures];
      }
    }

    let fixedGestures = await this.parseTouch(gestures, false);

    if (actions[actions.length - 1] === 'release') {
      actions[actions.length - 1] = await this.fixRelease(gestures);
    }

    for (let g of fixedGestures) {
      await this.performGesture(g);
    }
  }
};

helpers.parseTouch = async function parseTouch(gestures, multi) {
  if (multi && _lodash.default.last(gestures).action === 'release') {
    gestures.pop();
  }

  let touchStateObjects = await (0, _asyncbox.asyncmap)(gestures, async gesture => {
    let options = gesture.options || {};

    if (_lodash.default.includes(['press', 'moveTo', 'tap', 'longPress'], gesture.action)) {
      options.offset = false;
      let elementId = gesture.options.element;

      if (elementId) {
        let pos = await this.getLocationInView(elementId);

        if (gesture.options.x || gesture.options.y) {
          options.x = pos.x + (gesture.options.x || 0);
          options.y = pos.y + (gesture.options.y || 0);
        } else {
          const {
            width,
            height
          } = await this.getSize(elementId);
          options.x = pos.x + width / 2;
          options.y = pos.y + height / 2;
        }

        let touchStateObject = {
          action: gesture.action,
          options,
          timeOffset: 0.005
        };
        return touchStateObject;
      } else {
        options.x = gesture.options.x || 0;
        options.y = gesture.options.y || 0;
        let touchStateObject = {
          action: gesture.action,
          options,
          timeOffset: 0.005
        };
        return touchStateObject;
      }
    } else {
      let offset = 0.005;

      if (gesture.action === 'wait') {
        options = gesture.options;
        offset = parseInt(gesture.options.ms, 10) / 1000;
      }

      let touchStateObject = {
        action: gesture.action,
        options,
        timeOffset: offset
      };
      return touchStateObject;
    }
  }, false);
  let prevPos = null,
      time = 0;

  for (let state of touchStateObjects) {
    if (_lodash.default.isUndefined(state.options.x) && _lodash.default.isUndefined(state.options.y) && prevPos !== null) {
      state.options.x = prevPos.x;
      state.options.y = prevPos.y;
    }

    if (state.options.offset && prevPos) {
      state.options.x += prevPos.x;
      state.options.y += prevPos.y;
    }

    delete state.options.offset;

    if (!_lodash.default.isUndefined(state.options.x) && !_lodash.default.isUndefined(state.options.y)) {
      prevPos = state.options;
    }

    if (multi) {
      let timeOffset = state.timeOffset;
      time += timeOffset;
      state.time = _androidHelpers.default.truncateDecimals(time, 3);

      if (!_lodash.default.isUndefined(state.options.x) && !_lodash.default.isUndefined(state.options.y)) {
        state.touch = {
          x: state.options.x,
          y: state.options.y
        };
      }

      delete state.options;
    }

    delete state.timeOffset;
  }

  return touchStateObjects;
};

commands.performMultiAction = async function performMultiAction(actions, elementId) {
  if (actions.length === 1) {
    throw new Error('Multi Pointer Gestures need at least two actions. ' + 'Use Touch Actions for a single action.');
  }

  let states = await (0, _asyncbox.asyncmap)(actions, async action => {
    return await this.parseTouch(action, true);
  }, false);
  return await this.doPerformMultiAction(elementId, states);
};

commands.doPerformMultiAction = async function doPerformMultiAction(elementId, states) {
  let opts;

  if (elementId) {
    opts = {
      elementId,
      actions: states
    };
    return await this.bootstrap.sendAction('element:performMultiPointerGesture', opts);
  } else {
    opts = {
      actions: states
    };
    return await this.bootstrap.sendAction('performMultiPointerGesture', opts);
  }
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy90b3VjaC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiZG9Ub3VjaEFjdGlvbiIsImFjdGlvbiIsIm9wdHMiLCJ0YXAiLCJlbGVtZW50IiwieCIsInkiLCJjb3VudCIsInRvdWNoRG93biIsInRvdWNoVXAiLCJ0b3VjaE1vdmUiLCJCIiwiZGVsYXkiLCJtcyIsImR1cmF0aW9uIiwidG91Y2hMb25nQ2xpY2siLCJsb2ciLCJ3YXJuIiwiZXJyb3JBbmRUaHJvdyIsImRvVG91Y2hEcmFnIiwiZ2VzdHVyZXMiLCJsb25nUHJlc3MiLCJtb3ZlVG8iLCJzdGFydFgiLCJvcHRpb25zIiwic3RhcnRZIiwiZW5kWCIsImVuZFkiLCJnZXRMb2NhdGlvbkluVmlldyIsImFwaUxldmVsIiwiYWRiIiwiZ2V0QXBpTGV2ZWwiLCJNYXRoIiwibWF4IiwiZHJhZyIsImZpeFJlbGVhc2UiLCJyZWxlYXNlIiwiXyIsImxhc3QiLCJjbG9uZSIsInJlZiIsImdlc3R1cmUiLCJyZXZlcnNlIiwibG9jIiwic2l6ZSIsImdldFNpemUiLCJ3aWR0aCIsImhlaWdodCIsInBpY2siLCJwZXJmb3JtR2VzdHVyZSIsImUiLCJlcnJvcnMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJkZWJ1ZyIsInBlcmZvcm1Ub3VjaCIsImxlbmd0aCIsInN3aXBlT3B0cyIsImdldFN3aXBlT3B0aW9ucyIsInN3aXBlIiwidG91Y2hDb3VudCIsImFjdGlvbnMiLCJtYXAiLCJoZWFkIiwicG9wIiwic2xpY2UiLCJwcmVzcyIsInNoaWZ0Iiwid2FpdCIsImZpeGVkR2VzdHVyZXMiLCJwYXJzZVRvdWNoIiwiZyIsIm11bHRpIiwidG91Y2hTdGF0ZU9iamVjdHMiLCJpbmNsdWRlcyIsIm9mZnNldCIsImVsZW1lbnRJZCIsInBvcyIsInRvdWNoU3RhdGVPYmplY3QiLCJ0aW1lT2Zmc2V0IiwicGFyc2VJbnQiLCJwcmV2UG9zIiwidGltZSIsInN0YXRlIiwiaXNVbmRlZmluZWQiLCJhbmRyb2lkSGVscGVycyIsInRydW5jYXRlRGVjaW1hbHMiLCJ0b3VjaCIsInBlcmZvcm1NdWx0aUFjdGlvbiIsIkVycm9yIiwic3RhdGVzIiwiZG9QZXJmb3JtTXVsdGlBY3Rpb24iLCJib290c3RyYXAiLCJzZW5kQWN0aW9uIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7Ozs7QUFFQUYsUUFBUSxDQUFDRyxhQUFULEdBQXlCLGVBQWVBLGFBQWYsQ0FBOEJDLE1BQTlCLEVBQXNDQyxJQUF0QyxFQUE0QztBQUNuRSxVQUFRRCxNQUFSO0FBQ0UsU0FBSyxLQUFMO0FBQ0UsYUFBTyxNQUFNLEtBQUtFLEdBQUwsQ0FBU0QsSUFBSSxDQUFDRSxPQUFkLEVBQXVCRixJQUFJLENBQUNHLENBQTVCLEVBQStCSCxJQUFJLENBQUNJLENBQXBDLEVBQXVDSixJQUFJLENBQUNLLEtBQTVDLENBQWI7O0FBQ0YsU0FBSyxPQUFMO0FBQ0UsYUFBTyxNQUFNLEtBQUtDLFNBQUwsQ0FBZU4sSUFBSSxDQUFDRSxPQUFwQixFQUE2QkYsSUFBSSxDQUFDRyxDQUFsQyxFQUFxQ0gsSUFBSSxDQUFDSSxDQUExQyxDQUFiOztBQUNGLFNBQUssU0FBTDtBQUNFLGFBQU8sTUFBTSxLQUFLRyxPQUFMLENBQWFQLElBQUksQ0FBQ0UsT0FBbEIsRUFBMkJGLElBQUksQ0FBQ0csQ0FBaEMsRUFBbUNILElBQUksQ0FBQ0ksQ0FBeEMsQ0FBYjs7QUFDRixTQUFLLFFBQUw7QUFDRSxhQUFPLE1BQU0sS0FBS0ksU0FBTCxDQUFlUixJQUFJLENBQUNFLE9BQXBCLEVBQTZCRixJQUFJLENBQUNHLENBQWxDLEVBQXFDSCxJQUFJLENBQUNJLENBQTFDLENBQWI7O0FBQ0YsU0FBSyxN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QUFDdEYsTUFBSXZGLElBQUo7O0FBQ0EsTUFBSXlFLFNBQUosRUFBZTtBQUNiekUsSUFBQUEsSUFBSSxHQUFHO0FBQ0x5RSxNQUFBQSxTQURLO0FBRUxmLE1BQUFBLE9BQU8sRUFBRTZCO0FBRkosS0FBUDtBQUlBLFdBQU8sTUFBTSxLQUFLRSxTQUFMLENBQWVDLFVBQWYsQ0FBMEIsb0NBQTFCLEVBQWdFMUYsSUFBaEUsQ0FBYjtBQUNELEdBTkQsTUFNTztBQUNMQSxJQUFBQSxJQUFJLEdBQUc7QUFDTDBELE1BQUFBLE9BQU8sRUFBRTZCO0FBREosS0FBUDtBQUdBLFdBQU8sTUFBTSxLQUFLRSxTQUFMLENBQWVDLFVBQWYsQ0FBMEIsNEJBQTFCLEVBQXdEMUYsSUFBeEQsQ0FBYjtBQUNEO0FBQ0YsQ0FkRDs7QUFnQkEyRixNQUFNLENBQUNDLE1BQVAsQ0FBYy9GLFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBhbmRyb2lkSGVscGVycyBmcm9tICcuLi9hbmRyb2lkLWhlbHBlcnMnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZXJyb3JzLCBpc0Vycm9yVHlwZSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBhc3luY21hcCB9IGZyb20gJ2FzeW5jYm94JztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5kb1RvdWNoQWN0aW9uID0gYXN5bmMgZnVuY3Rpb24gZG9Ub3VjaEFjdGlvbiAoYWN0aW9uLCBvcHRzKSB7XG4gIHN3aXRjaCAoYWN0aW9uKSB7XG4gICAgY2FzZSAndGFwJzpcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRhcChvcHRzLmVsZW1lbnQsIG9wdHMueCwgb3B0cy55LCBvcHRzLmNvdW50KTtcbiAgICBjYXNlICdwcmVzcyc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50b3VjaERvd24ob3B0cy5lbGVtZW50LCBvcHRzLngsIG9wdHMueSk7XG4gICAgY2FzZSAncmVsZWFzZSc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50b3VjaFVwKG9wdHMuZWxlbWVudCwgb3B0cy54LCBvcHRzLnkpO1xuICAgIGNhc2UgJ21vdmVUbyc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50b3VjaE1vdmUob3B0cy5lbGVtZW50LCBvcHRzLngsIG9wdHMueSk7XG4gICAgY2FzZSAnd2FpdCc6XG4gICAgICByZXR1cm4gYXdhaXQgQi5kZWxheShvcHRzLm1zKTtcbiAgICBjYXNlICdsb25nUHJlc3MnOlxuICAgICAgaWYgKHR5cGVvZiBvcHRzLmR1cmF0aW9uID09PSAndW5kZWZpbmVkJyB8fCAhb3B0cy5kdXJhdGlvbikge1xuICAgICAgICBvcHRzLmR1cmF0aW9uID0gMTAwMDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRvdWNoTG9uZ0NsaWNrKG9wdHMuZWxlbWVudCwgb3B0cy54LCBvcHRzLnksIG9wdHMuZHVyYXRpb24pO1xuICAgIGNhc2UgJ2NhbmNlbCc6XG4gICAgICAvLyBUT0RPOiBjbGFyaWZ5IGJlaGF2aW9yIG9mICdjYW5jZWwnIGFjdGlvbiBhbmQgZml4IHRoaXNcbiAgICAgIGxvZy53YXJuKCdDYW5jZWwgYWN0aW9uIGN1cnJlbnRseSBoYXMgbm8gZWZmZWN0Jyk7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYHVua25vd24gYWN0aW9uICR7YWN0aW9ufWApO1xuICB9XG59O1xuXG5cbi8vIGRyYWcgaXMgKm5vdCogcHJlc3MtbW92ZS1yZWxlYXNlLCBzbyB3ZSBuZWVkIHRvIHRyYW5zbGF0ZVxuLy8gZHJhZyB3b3JrcyBmaW5lIGZvciBzY3JvbGwsIGFzIHdlbGxcbmhlbHBlcnMuZG9Ub3VjaERyYWcgPSBhc3luYyBmdW5jdGlvbiBkb1RvdWNoRHJhZyAoZ2VzdHVyZXMpIHtcbiAgbGV0IGxvbmdQcmVzcyA9IGdlc3R1cmVzWzBdO1xuICBsZXQgbW92ZVRvID0gZ2VzdHVyZXNbMV07XG4gIGxldCBzdGFydFggPSBsb25nUHJlc3Mub3B0aW9ucy54IHx8IDAsXG4gICAgICBzdGFydFkgPSBsb25nUHJlc3Mub3B0aW9ucy55IHx8IDAsXG4gICAgICBlbmRYID0gbW92ZVRvLm9wdGlvbnMueCB8fCAwLFxuICAgICAgZW5kWSA9IG1vdmVUby5vcHRpb25zLnkgfHwgMDtcbiAgaWYgKGxvbmdQcmVzcy5vcHRpb25zLmVsZW1lbnQpIHtcbiAgICBsZXQge3gsIHl9ID0gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbkluVmlldyhsb25nUHJlc3Mub3B0aW9ucy5lbGVtZW50KTtcbiAgICBzdGFydFggKz0geCB8fCAwO1xuICAgIHN0YXJ0WSArPSB5IHx8IDA7XG4gIH1cbiAgaWYgKG1vdmVUby5vcHRpb25zLmVsZW1lbnQpIHtcbiAgICBsZXQge3gsIHl9ID0gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbkluVmlldyhtb3ZlVG8ub3B0aW9ucy5lbGVtZW50KTtcbiAgICBlbmRYICs9IHggfHwgMDtcbiAgICBlbmRZICs9IHkgfHwgMDtcbiAgfVxuXG4gIGxldCBhcGlMZXZlbCA9IGF3YWl0IHRoaXMuYWRiLmdldEFwaUxldmVsKCk7XG4gIC8vIGxvbGxpcG9wIHRha2VzIGEgbGl0dGxlIGxvbmdlciB0byBnZXQgdGhpbmdzIHJvbGxpbmdcbiAgbGV0IGR1cmF0aW9uID0gYXBpTGV2ZWwgPj0gNSA/IDIgOiAxO1xuICAvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbG9uZyBwcmVzcyBoYXMgYSBkdXJhdGlvbiwgd2UgdXNlIGl0LlxuICBpZiAobG9uZ1ByZXNzLm9wdGlvbnMgJiYgbG9uZ1ByZXNzLm9wdGlvbnMuZHVyYXRpb24pIHtcbiAgICBkdXJhdGlvbiA9IE1hdGgubWF4KGxvbmdQcmVzcy5vcHRpb25zLmR1cmF0aW9uIC8gMTAwMCwgZHVyYXRpb24pO1xuICB9XG5cbiAgLy8gYGRyYWdgIHdpbGwgdGFrZSBjYXJlIG9mIHdoZXRoZXIgdGhlcmUgaXMgYW4gZWxlbWVudCBvciBub3QgYXQgdGhhdCBsZXZlbFxuICByZXR1cm4gYXdhaXQgdGhpcy5kcmFnKHN0YXJ0WCwgc3RhcnRZLCBlbmRYLCBlbmRZLCBkdXJhdGlvbiwgMSwgbG9uZ1ByZXNzLm9wdGlvbnMuZWxlbWVudCwgbW92ZVRvLm9wdGlvbnMuZWxlbWVudCk7XG59O1xuXG4vLyBSZWxlYXNlIGdlc3R1cmUgbmVlZHMgZWxlbWVudCBvciBjby1vcmRpbmF0ZXMgdG8gcmVsZWFzZSBpdCBmcm9tIHRoYXQgcG9zaXRpb25cbi8vIG9yIGVsc2UgcmVsZWFzZSBnZXN0dXJlIGlzIHBlcmZvcm1lZCBmcm9tIGNlbnRlciBvZiB0aGUgc2NyZWVuLCBzbyB0byBmaXggaXRcbi8vIFRoaXMgbWV0aG9kIHNldHMgY28tb3JkaW5hdGVzL2VsZW1lbnQgdG8gcmVsZWFzZSBnZXN0dXJlIGlmIGl0IGhhcyBubyBvcHRpb25zIHNldCBhbHJlYWR5LlxuaGVscGVycy5maXhSZWxlYXNlID0gYXN5bmMgZnVuY3Rpb24gZml4UmVsZWFzZSAoZ2VzdHVyZXMpIHtcbiAgbGV0IHJlbGVhc2UgPSBfLmxhc3QoZ2VzdHVyZXMpO1xuICAvLyBzb21ldGltZXMgdGhlcmUgYXJlIG5vIG9wdGlvbnNcbiAgcmVsZWFzZS5vcHRpb25zID0gcmVsZWFzZS5vcHRpb25zIHx8IHt9O1xuICAvLyBub3RoaW5nIHRvIGRvIGlmIHJlbGVhc2Ugb3B0aW9ucyBhcmUgYWxyZWFkeSBzZXRcbiAgaWYgKHJlbGVhc2Uub3B0aW9ucy5lbGVtZW50IHx8IChyZWxlYXNlLm9wdGlvbnMueCAmJiByZWxlYXNlLm9wdGlvbnMueSkpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgLy8gd2l0aG91dCBjb29yZGluYXRlcywgYHJlbGVhc2VgIHVzZXMgdGhlIGNlbnRlciBvZiB0aGUgc2NyZWVuLCB3aGljaCxcbiAgLy8gZ2VuZXJhbGx5IHNwZWFraW5nLCBpcyBub3Qgd2hhdCB3ZSB3YW50XG4gIC8vIHRoZXJlZm9yZTogbG9vcCBiYWNrd2FyZHMgYW5kIHVzZSB0aGUgbGFzdCBjb21tYW5kIHdpdGggYW4gZWxlbWVudCBhbmQvb3JcbiAgLy8gb2Zmc2V0IGNvb3JkaW5hdGVzXG4gIGdlc3R1cmVzID0gXy5jbG9uZShnZXN0dXJlcyk7XG4gIGxldCByZWYgPSBudWxsO1xuICBmb3IgKGxldCBnZXN0dXJlIG9mIGdlc3R1cmVzLnJldmVyc2UoKSkge1xuICAgIGxldCBvcHRzID0gZ2VzdHVyZS5vcHRpb25zO1xuICAgIGlmIChvcHRzLmVsZW1lbnQgfHwgKG9wdHMueCAmJiBvcHRzLnkpKSB7XG4gICAgICByZWYgPSBnZXN0dXJlO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIGlmIChyZWYpIHtcbiAgICBsZXQgb3B0cyA9IHJlZi5vcHRpb25zO1xuICAgIGlmIChvcHRzLmVsZW1lbnQpIHtcbiAgICAgIGxldCBsb2MgPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KG9wdHMuZWxlbWVudCk7XG4gICAgICBpZiAob3B0cy54ICYmIG9wdHMueSkge1xuICAgICAgICAvLyB0aGlzIGlzIGFuIG9mZnNldCBmcm9tIHRoZSBlbGVtZW50XG4gICAgICAgIHJlbGVhc2Uub3B0aW9ucyA9IHtcbiAgICAgICAgICB4OiBsb2MueCArIG9wdHMueCxcbiAgICAgICAgICB5OiBsb2MueSArIG9wdHMueVxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdGhpcyBpcyB0aGUgY2VudGVyIG9mIHRoZSBlbGVtZW50XG4gICAgICAgIGxldCBzaXplID0gYXdhaXQgdGhpcy5nZXRTaXplKG9wdHMuZWxlbWVudCk7XG4gICAgICAgIHJlbGVhc2Uub3B0aW9ucyA9IHtcbiAgICAgICAgICB4OiBsb2MueCArIHNpemUud2lkdGggLyAyLFxuICAgICAgICAgIHk6IGxvYy55ICsgc2l6ZS5oZWlnaHQgLyAyXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlbGVhc2Uub3B0aW9ucyA9IF8ucGljayhvcHRzLCAneCcsICd5Jyk7XG4gICAgfVxuICB9XG4gIHJldHVybiByZWxlYXNlO1xufTtcblxuLy8gUGVyZm9ybSBvbmUgZ2VzdHVyZVxuaGVscGVycy5wZXJmb3JtR2VzdHVyZSA9IGFzeW5jIGZ1bmN0aW9uIHBlcmZvcm1HZXN0dXJlIChnZXN0dXJlKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZG9Ub3VjaEFjdGlvbihnZXN0dXJlLmFjdGlvbiwgZ2VzdHVyZS5vcHRpb25zIHx8IHt9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIHNvbWV0aW1lIHRoZSBlbGVtZW50IGlzIG5vdCBhdmFpbGFibGUgd2hlbiByZWxlYXNpbmcsIHJldHJ5IHdpdGhvdXQgaXRcbiAgICBpZiAoaXNFcnJvclR5cGUoZSwgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcikgJiYgZ2VzdHVyZS5hY3Rpb24gPT09ICdyZWxlYXNlJyAmJlxuICAgICAgICBnZXN0dXJlLm9wdGlvbnMuZWxlbWVudCkge1xuICAgICAgZGVsZXRlIGdlc3R1cmUub3B0aW9ucy5lbGVtZW50O1xuICAgICAgbG9nLmRlYnVnKGByZXRyeWluZyByZWxlYXNlIHdpdGhvdXQgZWxlbWVudCBvcHRzOiAke2dlc3R1cmUub3B0aW9uc30uYCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5kb1RvdWNoQWN0aW9uKGdlc3R1cmUuYWN0aW9uLCBnZXN0dXJlLm9wdGlvbnMgfHwge30pO1xuICAgIH1cbiAgICB0aHJvdyBlO1xuICB9XG59O1xuXG5jb21tYW5kcy5wZXJmb3JtVG91Y2ggPSBhc3luYyBmdW5jdGlvbiBwZXJmb3JtVG91Y2ggKGdlc3R1cmVzKSB7XG4gIC8vIHByZXNzLXdhaXQtbW92ZVRvLXJlbGVhc2UgaXMgYHN3aXBlYCwgc28gdXNlIG5hdGl2ZSBtZXRob2RcbiAgaWYgKGdlc3R1cmVzLmxlbmd0aCA9PT0gNCAmJlxuICAgICAgZ2VzdHVyZXNbMF0uYWN0aW9uID09PSAncHJlc3MnICYmXG4gICAgICBnZXN0dXJlc1sxXS5hY3Rpb24gPT09ICd3YWl0JyAmJlxuICAgICAgZ2VzdHVyZXNbMl0uYWN0aW9uID09PSAnbW92ZVRvJyAmJlxuICAgICAgZ2VzdHVyZXNbM10uYWN0aW9uID09PSAncmVsZWFzZScpIHtcblxuICAgIGxldCBzd2lwZU9wdHMgPSBhd2FpdCB0aGlzLmdldFN3aXBlT3B0aW9ucyhnZXN0dXJlcyk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc3dpcGUoc3dpcGVPcHRzLnN0YXJ0WCwgc3dpcGVPcHRzLnN0YXJ0WSwgc3dpcGVPcHRzLmVuZFgsXG4gICAgICAgIHN3aXBlT3B0cy5lbmRZLCBzd2lwZU9wdHMuZHVyYXRpb24sIHN3aXBlT3B0cy50b3VjaENvdW50LFxuICAgICAgICBzd2lwZU9wdHMuZWxlbWVudCk7XG4gIH1cbiAgbGV0IGFjdGlvbnMgPSBfLm1hcChnZXN0dXJlcywgJ2FjdGlvbicpO1xuXG4gIGlmIChhY3Rpb25zWzBdID09PSAnbG9uZ1ByZXNzJyAmJiBhY3Rpb25zWzFdID09PSAnbW92ZVRvJyAmJiBhY3Rpb25zWzJdID09PSAncmVsZWFzZScpIHtcbiAgICAvLyBzb21lIHRoaW5ncyBhcmUgc3BlY2lhbFxuICAgIHJldHVybiBhd2FpdCB0aGlzLmRvVG91Y2hEcmFnKGdlc3R1cmVzKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoYWN0aW9ucy5sZW5ndGggPT09IDIpIHtcbiAgICAgIC8vIGBwcmVzc2Agd2l0aG91dCBhIHdhaXQgaXMgdG9vIHNsb3cgYW5kIGdldHMgaW50ZXJwcmV0dGVkIGFzIGEgYGxvbmdQcmVzc2BcbiAgICAgIGlmIChfLmhlYWQoYWN0aW9ucykgPT09ICdwcmVzcycgJiYgXy5sYXN0KGFjdGlvbnMpID09PSAncmVsZWFzZScpIHtcbiAgICAgICAgYWN0aW9uc1swXSA9ICd0YXAnO1xuICAgICAgICBnZXN0dXJlc1swXS5hY3Rpb24gPSAndGFwJztcbiAgICAgIH1cblxuICAgICAgLy8gdGhlIGBsb25nUHJlc3NgIGFuZCBgdGFwYCBtZXRob2RzIHJlbGVhc2Ugb24gdGhlaXIgb3duXG4gICAgICBpZiAoKF8uaGVhZChhY3Rpb25zKSA9PT0gJ3RhcCcgfHwgXy5oZWFkKGFjdGlvbnMpID09PSAnbG9uZ1ByZXNzJykgJiYgXy5sYXN0KGFjdGlvbnMpID09PSAncmVsZWFzZScpIHtcbiAgICAgICAgZ2VzdHVyZXMucG9wKCk7XG4gICAgICAgIGFjdGlvbnMucG9wKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGxvbmdwcmVzcyBmb2xsb3dlZCBieSBhbnl0aGluZyBvdGhlciB0aGFuIHJlbGVhc2Ugc2hvdWxkIGJlY29tZSBhIHByZXNzIGFuZCB3YWl0XG4gICAgICBpZiAoYWN0aW9uc1swXSA9PT0gJ2xvbmdQcmVzcycpIHtcbiAgICAgICAgYWN0aW9ucyA9IFsncHJlc3MnLCAnd2FpdCcsIC4uLmFjdGlvbnMuc2xpY2UoMSldO1xuXG4gICAgICAgIGxldCBwcmVzcyA9IGdlc3R1cmVzLnNoaWZ0KCk7XG4gICAgICAgIHByZXNzLmFjdGlvbiA9ICdwcmVzcyc7XG4gICAgICAgIGxldCB3YWl0ID0ge1xuICAgICAgICAgIGFjdGlvbjogJ3dhaXQnLFxuICAgICAgICAgIG9wdGlvbnM6IHttczogcHJlc3Mub3B0aW9ucy5kdXJhdGlvbiB8fCAxMDAwfVxuICAgICAgICB9O1xuICAgICAgICBkZWxldGUgcHJlc3Mub3B0aW9ucy5kdXJhdGlvbjtcbiAgICAgICAgZ2VzdHVyZXMgPSBbcHJlc3MsIHdhaXQsIC4uLmdlc3R1cmVzXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgZml4ZWRHZXN0dXJlcyA9IGF3YWl0IHRoaXMucGFyc2VUb3VjaChnZXN0dXJlcywgZmFsc2UpO1xuICAgIC8vIGZpeCByZWxlYXNlIGFjdGlvbiB0aGVuIHBlcmZvcm0gYWxsIGFjdGlvbnNcbiAgICBpZiAoYWN0aW9uc1thY3Rpb25zLmxlbmd0aCAtIDFdID09PSAncmVsZWFzZScpIHtcbiAgICAgIGFjdGlvbnNbYWN0aW9ucy5sZW5ndGggLSAxXSA9IGF3YWl0IHRoaXMuZml4UmVsZWFzZShnZXN0dXJlcyk7XG4gICAgfVxuICAgIGZvciAobGV0IGcgb2YgZml4ZWRHZXN0dXJlcykge1xuICAgICAgYXdhaXQgdGhpcy5wZXJmb3JtR2VzdHVyZShnKTtcbiAgICB9XG4gIH1cbn07XG5cbmhlbHBlcnMucGFyc2VUb3VjaCA9IGFzeW5jIGZ1bmN0aW9uIHBhcnNlVG91Y2ggKGdlc3R1cmVzLCBtdWx0aSkge1xuICAvLyBiZWNhdXNlIG11bHRpLXRvdWNoIHJlbGVhc2VzIGF0IHRoZSBlbmQgYnkgZGVmYXVsdFxuICBpZiAobXVsdGkgJiYgXy5sYXN0KGdlc3R1cmVzKS5hY3Rpb24gPT09ICdyZWxlYXNlJykge1xuICAgIGdlc3R1cmVzLnBvcCgpO1xuICB9XG5cbiAgbGV0IHRvdWNoU3RhdGVPYmplY3RzID0gYXdhaXQgYXN5bmNtYXAoZ2VzdHVyZXMsIGFzeW5jIChnZXN0dXJlKSA9PiB7XG4gICAgbGV0IG9wdGlvbnMgPSBnZXN0dXJlLm9wdGlvbnMgfHwge307XG4gICAgaWYgKF8uaW5jbHVkZXMoWydwcmVzcycsICdtb3ZlVG8nLCAndGFwJywgJ2xvbmdQcmVzcyddLCBnZXN0dXJlLmFjdGlvbikpIHtcbiAgICAgIG9wdGlvbnMub2Zmc2V0ID0gZmFsc2U7XG4gICAgICBsZXQgZWxlbWVudElkID0gZ2VzdHVyZS5vcHRpb25zLmVsZW1lbnQ7XG4gICAgICBpZiAoZWxlbWVudElkKSB7XG4gICAgICAgIGxldCBwb3MgPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uSW5WaWV3KGVsZW1lbnRJZCk7XG4gICAgICAgIGlmIChnZXN0dXJlLm9wdGlvbnMueCB8fCBnZXN0dXJlLm9wdGlvbnMueSkge1xuICAgICAgICAgIG9wdGlvbnMueCA9IHBvcy54ICsgKGdlc3R1cmUub3B0aW9ucy54IHx8IDApO1xuICAgICAgICAgIG9wdGlvbnMueSA9IHBvcy55ICsgKGdlc3R1cmUub3B0aW9ucy55IHx8IDApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0U2l6ZShlbGVtZW50SWQpO1xuICAgICAgICAgIG9wdGlvbnMueCA9IHBvcy54ICsgKHdpZHRoIC8gMik7XG4gICAgICAgICAgb3B0aW9ucy55ID0gcG9zLnkgKyAoaGVpZ2h0IC8gMik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHRvdWNoU3RhdGVPYmplY3QgPSB7XG4gICAgICAgICAgYWN0aW9uOiBnZXN0dXJlLmFjdGlvbixcbiAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgIHRpbWVPZmZzZXQ6IDAuMDA1LFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gdG91Y2hTdGF0ZU9iamVjdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9wdGlvbnMueCA9IChnZXN0dXJlLm9wdGlvbnMueCB8fCAwKTtcbiAgICAgICAgb3B0aW9ucy55ID0gKGdlc3R1cmUub3B0aW9ucy55IHx8IDApO1xuXG4gICAgICAgIGxldCB0b3VjaFN0YXRlT2JqZWN0ID0ge1xuICAgICAgICAgIGFjdGlvbjogZ2VzdHVyZS5hY3Rpb24sXG4gICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICB0aW1lT2Zmc2V0OiAwLjAwNSxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHRvdWNoU3RhdGVPYmplY3Q7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBvZmZzZXQgPSAwLjAwNTtcbiAgICAgIGlmIChnZXN0dXJlLmFjdGlvbiA9PT0gJ3dhaXQnKSB7XG4gICAgICAgIG9wdGlvbnMgPSBnZXN0dXJlLm9wdGlvbnM7XG4gICAgICAgIG9mZnNldCA9IChwYXJzZUludChnZXN0dXJlLm9wdGlvbnMubXMsIDEwKSAvIDEwMDApO1xuICAgICAgfVxuICAgICAgbGV0IHRvdWNoU3RhdGVPYmplY3QgPSB7XG4gICAgICAgIGFjdGlvbjogZ2VzdHVyZS5hY3Rpb24sXG4gICAgICAgIG9wdGlvbnMsXG4gICAgICAgIHRpbWVPZmZzZXQ6IG9mZnNldCxcbiAgICAgIH07XG4gICAgICByZXR1cm4gdG91Y2hTdGF0ZU9iamVjdDtcbiAgICB9XG4gIH0sIGZhbHNlKTtcbiAgLy8gd2UgbmVlZCB0byBjaGFuZ2UgdGhlIHRpbWUgKHdoaWNoIGlzIG5vdyBhbiBvZmZzZXQpXG4gIC8vIGFuZCB0aGUgcG9zaXRpb24gKHdoaWNoIG1heSBiZSBhbiBvZmZzZXQpXG4gIGxldCBwcmV2UG9zID0gbnVsbCxcbiAgICAgIHRpbWUgPSAwO1xuICBmb3IgKGxldCBzdGF0ZSBvZiB0b3VjaFN0YXRlT2JqZWN0cykge1xuICAgIGlmIChfLmlzVW5kZWZpbmVkKHN0YXRlLm9wdGlvbnMueCkgJiYgXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLnkpICYmIHByZXZQb3MgIT09IG51bGwpIHtcbiAgICAgIC8vIHRoaXMgaGFwcGVucyB3aXRoIHdhaXRcbiAgICAgIHN0YXRlLm9wdGlvbnMueCA9IHByZXZQb3MueDtcbiAgICAgIHN0YXRlLm9wdGlvbnMueSA9IHByZXZQb3MueTtcbiAgICB9XG4gICAgaWYgKHN0YXRlLm9wdGlvbnMub2Zmc2V0ICYmIHByZXZQb3MpIHtcbiAgICAgIC8vIHRoZSBjdXJyZW50IHBvc2l0aW9uIGlzIGFuIG9mZnNldFxuICAgICAgc3RhdGUub3B0aW9ucy54ICs9IHByZXZQb3MueDtcbiAgICAgIHN0YXRlLm9wdGlvbnMueSArPSBwcmV2UG9zLnk7XG4gICAgfVxuICAgIGRlbGV0ZSBzdGF0ZS5vcHRpb25zLm9mZnNldDtcbiAgICBpZiAoIV8uaXNVbmRlZmluZWQoc3RhdGUub3B0aW9ucy54KSAmJiAhXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLnkpKSB7XG4gICAgICBwcmV2UG9zID0gc3RhdGUub3B0aW9ucztcbiAgICB9XG5cbiAgICBpZiAobXVsdGkpIHtcbiAgICAgIGxldCB0aW1lT2Zmc2V0ID0gc3RhdGUudGltZU9mZnNldDtcbiAgICAgIHRpbWUgKz0gdGltZU9mZnNldDtcbiAgICAgIHN0YXRlLnRpbWUgPSBhbmRyb2lkSGVscGVycy50cnVuY2F0ZURlY2ltYWxzKHRpbWUsIDMpO1xuXG4gICAgICAvLyBtdWx0aSBnZXN0dXJlcyByZXF1aXJlICd0b3VjaCcgcmF0aGVyIHRoYW4gJ29wdGlvbnMnXG4gICAgICBpZiAoIV8uaXNVbmRlZmluZWQoc3RhdGUub3B0aW9ucy54KSAmJiAhXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLnkpKSB7XG4gICAgICAgIHN0YXRlLnRvdWNoID0ge1xuICAgICAgICAgIHg6IHN0YXRlLm9wdGlvbnMueCxcbiAgICAgICAgICB5OiBzdGF0ZS5vcHRpb25zLnlcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGRlbGV0ZSBzdGF0ZS5vcHRpb25zO1xuICAgIH1cbiAgICBkZWxldGUgc3RhdGUudGltZU9mZnNldDtcbiAgfVxuICByZXR1cm4gdG91Y2hTdGF0ZU9iamVjdHM7XG59O1xuXG5cbmNvbW1hbmRzLnBlcmZvcm1NdWx0aUFjdGlvbiA9IGFzeW5jIGZ1bmN0aW9uIHBlcmZvcm1NdWx0aUFjdGlvbiAoYWN0aW9ucywgZWxlbWVudElkKSB7XG4gIC8vIEFuZHJvaWQgbmVlZHMgYXQgbGVhc3QgdHdvIGFjdGlvbnMgdG8gYmUgYWJsZSB0byBwZXJmb3JtIGEgbXVsdGkgcG9pbnRlciBnZXN0dXJlXG4gIGlmIChhY3Rpb25zLmxlbmd0aCA9PT0gMSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTXVsdGkgUG9pbnRlciBHZXN0dXJlcyBuZWVkIGF0IGxlYXN0IHR3byBhY3Rpb25zLiAnICtcbiAgICAgICAgJ1VzZSBUb3VjaCBBY3Rpb25zIGZvciBhIHNpbmdsZSBhY3Rpb24uJyk7XG4gIH1cblxuICBsZXQgc3RhdGVzID0gYXdhaXQgYXN5bmNtYXAoYWN0aW9ucywgYXN5bmMgKGFjdGlvbikgPT4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnBhcnNlVG91Y2goYWN0aW9uLCB0cnVlKTtcbiAgfSwgZmFsc2UpO1xuXG4gIHJldHVybiBhd2FpdCB0aGlzLmRvUGVyZm9ybU11bHRpQWN0aW9uKGVsZW1lbnRJZCwgc3RhdGVzKTtcbn07XG5cbi8qKlxuICogUmVhc29uIGZvciBpc29sYXRpbmcgZG9QZXJmb3JtTXVsdGlBY3Rpb24gZnJvbSBwZXJmb3JtTXVsdGlBY3Rpb24gaXMgZm9yIHJldXNpbmcgcGVyZm9ybU11bHRpQWN0aW9uXG4gKiBhY3Jvc3MgYW5kcm9pZC1kcml2ZXJzIChsaWtlIGFwcGl1bS11aWF1dG9tYXRvcjItZHJpdmVyKSBhbmQgdG8gYXZvaWQgY29kZSBkdXBsaWNhdGlvbi5cbiAqIE90aGVyIGFuZHJvaWQtZHJpdmVycyAobGlrZSBhcHBpdW0tdWlhdXRvbWF0b3IyLWRyaXZlcikgbmVlZCB0byBvdmVycmlkZSBkb1BlcmZvcm1NdWx0aUFjdGlvblxuICogdG8gZmFjaWxpdGF0ZSBwZXJmb3JtTXVsdGlBY3Rpb24uXG4gKi9cbmNvbW1hbmRzLmRvUGVyZm9ybU11bHRpQWN0aW9uID0gYXN5bmMgZnVuY3Rpb24gZG9QZXJmb3JtTXVsdGlBY3Rpb24gKGVsZW1lbnRJZCwgc3RhdGVzKSB7XG4gIGxldCBvcHRzO1xuICBpZiAoZWxlbWVudElkKSB7XG4gICAgb3B0cyA9IHtcbiAgICAgIGVsZW1lbnRJZCxcbiAgICAgIGFjdGlvbnM6IHN0YXRlc1xuICAgIH07XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuYm9vdHN0cmFwLnNlbmRBY3Rpb24oJ2VsZW1lbnQ6cGVyZm9ybU11bHRpUG9pbnRlckdlc3R1cmUnLCBvcHRzKTtcbiAgfSBlbHNlIHtcbiAgICBvcHRzID0ge1xuICAgICAgYWN0aW9uczogc3RhdGVzXG4gICAgfTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ib290c3RyYXAuc2VuZEFjdGlvbigncGVyZm9ybU11bHRpUG9pbnRlckdlc3R1cmUnLCBvcHRzKTtcbiAgfVxufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3RvdWNoLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
