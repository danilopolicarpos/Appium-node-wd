"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.FINGERPRINT_UNLOCK = exports.PATTERN_UNLOCK = exports.PASSWORD_UNLOCK = exports.PIN_UNLOCK = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

const PIN_UNLOCK = 'pin';
exports.PIN_UNLOCK = PIN_UNLOCK;
const PASSWORD_UNLOCK = 'password';
exports.PASSWORD_UNLOCK = PASSWORD_UNLOCK;
const PATTERN_UNLOCK = 'pattern';
exports.PATTERN_UNLOCK = PATTERN_UNLOCK;
const FINGERPRINT_UNLOCK = 'fingerprint';
exports.FINGERPRINT_UNLOCK = FINGERPRINT_UNLOCK;
const UNLOCK_TYPES = [PIN_UNLOCK, PASSWORD_UNLOCK, PATTERN_UNLOCK, FINGERPRINT_UNLOCK];
const KEYCODE_NUMPAD_ENTER = 66;
const KEYCODE_POWER = 26;
const KEYCODE_WAKEUP = 224;
const UNLOCK_WAIT_TIME = 100;
const HIDE_KEYBOARD_WAIT_TIME = 100;
const INPUT_KEYS_WAIT_TIME = 100;
let helpers = {};
exports.helpers = helpers;

helpers.isValidUnlockType = function isValidUnlockType(type) {
  return UNLOCK_TYPES.indexOf(type) !== -1;
};

helpers.isValidKey = function isValidKey(type, key) {
  if (_lodash.default.isUndefined(key)) {
    return false;
  }

  if (type === PIN_UNLOCK || type === FINGERPRINT_UNLOCK) {
    return /^[0-9]+$/.test(key.trim());
  }

  if (type === PATTERN_UNLOCK) {
    if (!/^[1-9]{2,9}$/.test(key.trim())) {
      return false;
    }

    return !/([1-9]).*?\1/.test(key.trim());
  }

  if (type === PASSWORD_UNLOCK) {
    return /.{4,}/g.test(key);
  }

  throw new Error(`Invalid unlock type ${type}`);
};

helpers.dismissKeyguard = async function dismissKeyguard(driver, adb) {
  _logger.default.info('Waking up the device to unlock it');

  await driver.pressKeyCode(KEYCODE_POWER);
  await driver.pressKeyCode(KEYCODE_WAKEUP);
  let isKeyboardShown = await driver.isKeyboardShown();

  if (isKeyboardShown) {
    await driver.hideKeyboard();
    await (0, _asyncbox.sleep)(HIDE_KEYBOARD_WAIT_TIME);
  }

  _logger.default.info('Dismiss notifications from unlock view');

  await adb.shell(['service', 'call', 'notification', '1']);
  await adb.back();

  if ((await adb.getApiLevel()) > 21) {
    _logger.default.info('Trying to dismiss keyguard');

    await adb.shell(['wm', 'dismiss-keyguard']);
    return;
  }

  _logger.default.info('Swiping up to dismiss keyguard');

  await helpers.swipeUp(driver);
};

helpers.swipeUp = async function swipeUp(driver) {
  let windowSize = await driver.getWindowSize();
  let x0 = parseInt(windowSize.x / 2, 10);
  let y0 = windowSize.y - 10;
  let yP = 100;
  let actions = [{
    action: 'press',
    options: {
      element: null,
      x: x0,
      y: y0
    }
  }, {
    action: 'moveTo',
    options: {
      element: null,
      x: x0,
      y: yP
    }
  }, {
    action: 'release'
  }];
  await driver.performTouch(actions);
};

helpers.encodePassword = function encodePassword(key) {
  return key.replace(/\s/ig, '%s');
};

helpers.stringKeyToArr = function stringKeyToArr(key) {
  return key.trim().replace(/\s+/g, '').split(/\s*/);
};

helpers.fingerprintUnlock = async function fingerprintUnlock(adb, driver, capabilities) {
  if ((await adb.getApiLevel()) < 23) {
    throw new Error('Fingerprint unlock only works for Android 6+ emulators');
  }

  await adb.fingerprint(capabilities.unlockKey);
  await (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
};

helpers.pinUnlock = async function pinUnlock(adb, driver, capabilities) {
  _logger.default.info(`Trying to unlock device using pin ${capabilities.unlockKey}`);

  await helpers.dismissKeyguard(driver, adb);
  let keys = helpers.stringKeyToArr(capabilities.unlockKey);

  if ((await adb.getApiLevel()) >= 21) {
    let els = await driver.findElOrEls('id', 'com.android.systemui:id/digit_text', true);

    if (_lodash.default.isEmpty(els)) {
      throw new Error('Error finding unlock pin buttons!');
    }

    let pins = {};

    for (let el of els) {
      let text = await driver.getAttribute('text', _appiumSupport.util.unwrapElement(el));
      pins[text] = el;
    }

    for (let pin of keys) {
      let el = pins[pin];
      await driver.click(_appiumSupport.util.unwrapElement(el));
    }
  } else {
    for (let pin of keys) {
      let el = await driver.findElOrEls('id', `com.android.keyguard:id/key${pin}`, false);

      if (el === null) {
        throw new Error(`Error finding unlock pin '${pin}' button!`);
      }

      await driver.click(_appiumSupport.util.unwrapElement(el));
    }
  }

  await (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);

  if (await adb.isScreenLocked()) {
    await driver.pressKeyCode(KEYCODE_NUMPAD_ENTER);
    await (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
  }
};

helpers.passwordUnlock = async function passwordUnlock(adb, driver, capabilities) {
  _logger.default.info(`Trying to unlock device using password ${capabilities.unlockKey}`);

  await helpers.dismissKeyguard(driver, adb);
  let key = capabilities.unlockKey;
  key = helpers.encodePassword(key);
  await adb.shell(['input', 'text', key]);
  await (0, _asyncbox.sleep)(INPUT_KEYS_WAIT_TIME);
  await adb.shell(['input', 'keyevent', KEYCODE_NUMPAD_ENTER]);
  await (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
};

helpers.getPatternKeyPosition = function getPatternKeyPosition(key, initPos, piece) {
  const cols = 3;
  const pins = 9;

  let xPos = (key, x, piece) => {
    return Math.round(x + (key % cols || cols) * piece - piece / 2);
  };

  let yPos = (key, y, piece) => {
    return Math.round(y + (Math.ceil((key % pins || pins) / cols) * piece - piece / 2));
  };

  return {
    x: xPos(key, initPos.x, piece),
    y: yPos(key, initPos.y, piece)
  };
};

helpers.getPatternActions = function getPatternActions(keys, initPos, piece) {
  let actions = [];
  let lastPos;

  for (let key of keys) {
    let keyPos = helpers.getPatternKeyPosition(key, initPos, piece);

    if (key === keys[0]) {
      actions.push({
        action: 'press',
        options: {
          element: null,
          x: keyPos.x,
          y: keyPos.y
        }
      });
      lastPos = keyPos;
      continue;
    }

    let moveTo = {
      x: 0,
      y: 0
    };
    let diffX = keyPos.x - lastPos.x;

    if (diffX > 0) {
      moveTo.x = piece;

      if (Math.abs(diffX) > piece) {
        moveTo.x += piece;
      }
    } else if (diffX < 0) {
      moveTo.x = -1 * piece;

      if (Math.abs(diffX) > piece) {
        moveTo.x -= piece;
      }
    }

    let diffY = keyPos.y - lastPos.y;

    if (diffY > 0) {
      moveTo.y = piece;

      if (Math.abs(diffY) > piece) {
        moveTo.y += piece;
      }
    } else if (diffY < 0) {
      moveTo.y = -1 * piece;

      if (Math.abs(diffY) > piece) {
        moveTo.y -= piece;
      }
    }

    actions.push({
      action: 'moveTo',
      options: {
        element: null,
        x: moveTo.x + lastPos.x,
        y: moveTo.y + lastPos.y
      }
    });
    lastPos = keyPos;
  }

  actions.push({
    action: 'release'
  });
  return actions;
};

helpers.patternUnlock = async function patternUnlock(adb, driver, capabilities) {
  _logger.default.info(`Trying to unlock device using pattern ${capabilities.unlockKey}`);

  await helpers.dismissKeyguard(driver, adb);
  let keys = helpers.stringKeyToArr(capabilities.unlockKey);
  let apiLevel = await adb.getApiLevel();
  let el = await driver.findElOrEls('id', `com.android.${apiLevel >= 21 ? 'systemui' : 'keyguard'}:id/lockPatternView`, false);
  let initPos = await driver.getLocation(_appiumSupport.util.unwrapElement(el));
  let size = await driver.getSize(_appiumSupport.util.unwrapElement(el));
  let actions = helpers.getPatternActions(keys, initPos, size.width / 3);
  await driver.performTouch(actions);
  await (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
};

helpers.PIN_UNLOCK = PIN_UNLOCK;
helpers.PASSWORD_UNLOCK = PASSWORD_UNLOCK;
helpers.PATTERN_UNLOCK = PATTERN_UNLOCK;
helpers.FINGERPRINT_UNLOCK = FINGERPRINT_UNLOCK;
var _default = helpers;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91bmxvY2staGVscGVycy5qcyJdLCJuYW1lcyI6WyJQSU5fVU5MT0NLIiwiUEFTU1dPUkRfVU5MT0NLIiwiUEFUVEVSTl9VTkxPQ0siLCJGSU5HRVJQUklOVF9VTkxPQ0siLCJVTkxPQ0tfVFlQRVMiLCJLRVlDT0RFX05VTVBBRF9FTlRFUiIsIktFWUNPREVfUE9XRVIiLCJLRVlDT0RFX1dBS0VVUCIsIlVOTE9DS19XQUlUX1RJTUUiLCJISURFX0tFWUJPQVJEX1dBSVRfVElNRSIsIklOUFVUX0tFWVNfV0FJVF9USU1FIiwiaGVscGVycyIsImlzVmFsaWRVbmxvY2tUeXBlIiwidHlwZSIsImluZGV4T2YiLCJpc1ZhbGlkS2V5Iiwia2V5IiwiXyIsImlzVW5kZWZpbmVkIiwidGVzdCIsInRyaW0iLCJFcnJvciIsImRpc21pc3NLZXlndWFyZCIsImRyaXZlciIsImFkYiIsImxvZ2dlciIsImluZm8iLCJwcmVzc0tleUNvZGUiLCJpc0tleWJvYXJkU2hvd24iLCJoaWRlS2V5Ym9hcmQiLCJzaGVsbCIsImJhY2siLCJnZXRBcGlMZXZlbCIsInN3aXBlVXAiLCJ3aW5kb3dTaXplIiwiZ2V0V2luZG93U2l6ZSIsIngwIiwicGFyc2VJbnQiLCJ4IiwieTAiLCJ5IiwieVAiLCJhY3Rpb25zIiwiYWN0aW9uIiwib3B0aW9ucyIsImVsZW1lbnQiLCJwZXJmb3JtVG91Y2giLCJlbmNvZGVQYXNzd29yZCIsInJlcGxhY2UiLCJzdHJpbmdLZXlUb0FyciIsInNwbGl0IiwiZmluZ2VycHJpbnRVbmxvY2siLCJjYXBhYmlsaXRpZXMiLCJmaW5nZXJwcmludCIsInVubG9ja0tleSIsInBpblVubG9jayIsImtleXMiLCJlbHMiLCJmaW5kRWxPckVscyIsImlzRW1wdHkiLCJwaW5zIiwiZWwiLCJ0ZXh0IiwiZ2V0QXR0cmlidXRlIiwidXRpbCIsInVud3JhcEVsZW1lbnQiLCJwaW4iLCJjbGljayIsImlzU2NyZWVuTG9ja2VkIiwicGFzc3dvcmRVbmxvY2siLCJnZXRQYXR0ZXJuS2V5UG9zaXRpb24iLCJpbml0UG9zIiwicGllY2UiLCJjb2xzIiwieFBvcyIsIk1hdGgiLCJyb3VuZCIsInlQb3MiLCJjZWlsIiwiZ2V0UGF0dGVybkFjdGlvbnMiLCJsYXN0UG9zIiwia2V5UG9zIiwicHVzaCIsIm1vdmVUbyIsImRpZmZYIiwiYWJzIiwiZGlmZlkiLCJwYXR0ZXJuVW5sb2NrIiwiYXBpTGV2ZWwiLCJnZXRMb2NhdGlvbiIsInNpemUiLCJnZXRTaXplIiwid2lkdGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsVUFBVSxHQUFHLEtBQW5COztBQUNBLE1BQU1DLGVBQWUsR0FBRyxVQUF4Qjs7QUFDQSxNQUFNQyxjQUFjLEdBQUcsU0FBdkI7O0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsYUFBM0I7O0FBQ0EsTUFBTUMsWUFBWSxHQUFHLENBQUNKLFVBQUQsRUFBYUMsZUFBYixFQUE4QkMsY0FBOUIsRUFBOENDLGtCQUE5QyxDQUFyQjtBQUNBLE1BQU1FLG9CQUFvQixHQUFHLEVBQTdCO0FBQ0EsTUFBTUMsYUFBYSxHQUFHLEVBQXRCO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLEdBQXZCO0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsR0FBekI7QUFDQSxNQUFNQyx1QkFBdUIsR0FBRyxHQUFoQztBQUNBLE1BQU1DLG9CQUFvQixHQUFHLEdBQTdCO0FBRUEsSUFBSUMsT0FBTyxHQUFHLEVBQWQ7OztBQUNBQSxPQUFPLENBQUNDLGlCQUFSLEdBQTRCLFNBQVNBLGlCQUFULENBQTRCQyxJQUE1QixFQUFrQztBQUM1RCxTQUFPVCxZQUFZLENBQUNVLE9BQWIsQ0FBcUJELElBQXJCLE1BQStCLENBQUMsQ0FBdkM7QUFDRCxDQUZEOztBQUlBRixPQUFPLENBQUNJLFVBQVIsR0FBcUIsU0FBU0EsVUFBVCxDQUFxQkYsSUFBckIsRUFBMkJHLEdBQTNCLEVBQWdDO0FBQ25ELE1BQUlDLGdCQUFFQyxXQUFGLENBQWNGLEdBQWQsQ0FBSixFQUF3QjtBQUN0QixXQUFPLEtBQVA7QUFDRDs7QUFDRCxNQUFJSCxJQUFJLEtBQUtiLFVBQVQsSUFBdUJhLElBQUksS0FBS1Ysa0JBQXBDLEVBQXdEO0FBQ3RELFdBQU8sV0FBV2dCLElBQVgsQ0FBZ0JILEdBQUcsQ0FBQ0ksSUFBSixFQUFoQixDQUFQO0FBQ0Q7O0FBQ0QsTUFBSVAsSUFBSSxLQUFLWCxjQUFiLEVBQTZCO0FBQzNCLFFBQUksQ0FBQyxlQUFlaUIsSUFBZixDQUFvQkgsR0FBRyxDQUFDSSxJQUFKLEVBQXBCLENBQUwsRUFBc0M7QUFDcEMsYUFBTyxLQUFQO0FBQ0Q7O0FBQ0QsV0FBTyxDQUFFLGVBQWVELElBQWYsQ0FBb0JILEdBQUcsQ0FBQ0ksSUFBSixFQUFwQixDQUFUO0FBQ0Q7O0FBR0QsTUFBSVAsSUFBSSxLQUFLWixlQUFiLEVBQThCO0FBQzVCLFdBQU8sU0FBU2tCLElBQVQsQ0FBY0gsR0FBZCxDQUFQO0FBQ0Q7O0FBQ0QsUUFBTSxJQUFJSyxLQUFKLENBQVcsdUJBQXNCUixJQUFLLEVBQXRDLENBQU47QUFDRCxDQW5CRDs7QUFxQkFGLE9BQU8sQ0FBQ1csZUFBUixHQUEwQixlQUFlQSxlQUFmLENBQWdDQyxNQUFoQyxFQUF3Q0MsR0FBeEMsRUFBNkM7QUFDckVDLGtCQUFPQyxJQUFQLENBQVksbUNBQVo7O0FBR0EsUUFBTUgsTUFBTSxDQUFDSSxZQUFQLENBQW9CckIsYUFBcEIsQ0FBTjtBQUNBLFFBQU1pQixNQUFNLENBQUNJLFlBQVAsQ0FBb0JwQixjQUFwQixDQUFOO0FBQ0EsTUFBSXFCLGVBQWUsR0FBRyxNQUFNTCxNQUFNLENBQUNLLGVBQVAsRUFBNUI7O0FBQ0EsTUFBSUEsZUFBSixFQUFxQjtBQUNuQixVQUFNTCxNQUFNLENBQUNNLFlBQVAsRUFBTjtBQUVBLFVBQU0scUJBQU1wQix1QkFBTixDQUFOO0FBQ0Q7O0FBRURnQixrQkFBT0MsSUFBUCxDQUFZLHdDQUFaOztBQUNBLFFBQU1GLEdBQUcsQ0FBQ00sS0FBSixDQUFVLENBQUMsU0FBRCxFQUFZLE1BQVosRUFBb0IsY0FBcEIsRUFBb0MsR0FBcEMsQ0FBVixDQUFOO0FBQ0EsUUFBTU4sR0FBRyxDQUFDTyxJQUFKLEVBQU47O0FBQ0EsTUFBSSxPQUFNUCxHQUFHLENBQUNRLFdBQUosRUFBTixJQUEwQixFQUE5QixFQUFrQztBQUNoQ1Asb0JBQU9DLElBQVAsQ0FBWSw0QkFBWjs7QUFDQSxVQUFNRixHQUFHLENBQUNNLEtBQUosQ0FBVSxDQUFDLElBQUQsRUFBTyxrQkFBUCxDQUFWLENBQU47QUFDQTtBQUNEOztBQUNETCxrQkFBT0MsSUFBUCxDQUFZLGdDQUFaOztBQUNBLFFBQU1mLE9BQU8sQ0FBQ3NCLE9BQVIsQ0FBZ0JWLE1BQWhCLENBQU47QUFDRCxDQXZCRDs7QUF5QkFaLE9BQU8sQ0FBQ3NCLE9BQVIsR0FBa0IsZUFBZUEsT0FBZixDQUF3QlYsTUFBeEIsRUFBZ0M7QUFDaEQsTUFBSVcsVUFBVSxHQUFHLE1BQU1YLE1BQU0sQ0FBQ1ksYUFBUCxFQUF2QjtBQUNBLE1BQUlDLEVBQUUsR0FBR0MsUUFBUSxDQUFDSCxVQUFVLENBQUNJLENBQVgsR0FBZSxDQUFoQixFQUFtQixFQUFuQixDQUFqQjtBQUNBLE1BQUlDLEVBQUUsR0FBR0wsVUFBVSxDQUFDTSxDQUFYLEdBQWUsRUFBeEI7QUFDQSxNQUFJQyxFQUFFLEdBQUcsR0FBVDtBQUNBLE1BQUlDLE9BQU8sR0FBRyxDQUNaO0FBQUNDLElBQUFBLE1BQU0sRUFBRSxPQUFUO0FBQWtCQyxJQUFBQSxPQUFPLEVBQUU7QUFBQ0MsTUFBQUEsT0FBTyxFQUFFLElBQVY7QUFBZ0JQLE1BQUFBLENBQUMsRUFBRUYsRUFBbkI7QUFBdUJJLE1BQUFBLENBQUMsRUFBRUQ7QUFBMUI7QUFBM0IsR0FEWSxFQUVaO0FBQUNJLElBQUFBLE1BQU0sRUFBRSxRQUFUO0FBQW1CQyxJQUFBQSxPQUFPLEVBQUU7QUFBQ0MsTUFBQUEsT0FBTyxFQUFFLElBQVY7QUFBZ0JQLE1BQUFBLENBQUMsRUFBRUYsRUFBbkI7QUFBdUJJLE1BQUFBLENBQUMsRUFBRUM7QUFBMUI7QUFBNUIsR0FGWSxFQUdaO0FBQUNFLElBQUFBLE1BQU0sRUFBRTtBQUFULEdBSFksQ0FBZDtBQUtBLFFBQU1wQixNQUFNLENBQUN1QixZQUFQLENBQW9CSixPQUFwQixDQUFOO0FBQ0QsQ0FYRDs7QUFhQS9CLE9BQU8sQ0FBQ29DLGNBQVIsR0FBeUIsU0FBU0EsY0FBVCxDQUF5Qi9CLEdBQXpCLEVBQThCO0FBQ3JELFNBQU9BLEdBQUcsQ0FBQ2dDLE9BQUosQ0FBWSxNQUFaLEVBQW9CLElBQXBCLENBQVA7QUFDRCxDQUZEOztBQUlBckMsT0FBTyxDQUFDc0MsY0FBUixHQUF5QixTQUFTQSxjQUFULENBQXlCakMsR0FBekIsRUFBOEI7QUFDckQsU0FBT0EsR0FBRyxDQUFDSSxJQUFKLEdBQVc0QixPQUFYLENBQW1CLE1BQW5CLEVBQTJCLEVBQTNCLEVBQStCRSxLQUEvQixDQUFxQyxLQUFyQyxDQUFQO0FBQ0QsQ0FGRDs7QUFJQXZDLE9BQU8sQ0FBQ3dDLGlCQUFSLEdBQTRCLGVBQWVBLGlCQUFmLENBQWtDM0IsR0FBbEMsRUFBdUNELE1BQXZDLEVBQStDNkIsWUFBL0MsRUFBNkQ7QUFDdkYsTUFBSSxPQUFNNUIsR0FBRyxDQUFDUSxXQUFKLEVBQU4sSUFBMEIsRUFBOUIsRUFBa0M7QUFDaEMsVUFBTSxJQUFJWCxLQUFKLENBQVUsd0RBQVYsQ0FBTjtBQUNEOztBQUNELFFBQU1HLEdBQUcsQ0FBQzZCLFdBQUosQ0FBZ0JELFlBQVksQ0FBQ0UsU0FBN0IsQ0FBTjtBQUNBLFFBQU0scUJBQU05QyxnQkFBTixDQUFOO0FBQ0QsQ0FORDs7QUFRQUcsT0FBTyxDQUFDNEMsU0FBUixHQUFvQixlQUFlQSxTQUFmLENBQTBCL0IsR0FBMUIsRUFBK0JELE1BQS9CLEVBQXVDNkIsWUFBdkMsRUFBcUQ7QUFDdkUzQixrQkFBT0MsSUFBUCxDQUFhLHFDQUFvQzBCLFlBQVksQ0FBQ0UsU0FBVSxFQUF4RTs7QUFDQSxRQUFNM0MsT0FBTyxDQUFDVyxlQUFSLENBQXdCQyxNQUF4QixFQUFnQ0MsR0FBaEMsQ0FBTjtBQUNBLE1BQUlnQyxJQUFJLEdBQUc3QyxPQUFPLENBQUNzQyxjQUFSLENBQXVCRyxZQUFZLENBQUNFLFNBQXBDLENBQVg7O0FBQ0EsTUFBSSxPQUFNOUIsR0FBRyxDQUFDUSxXQUFKLEVBQU4sS0FBMkIsRUFBL0IsRUFBbUM7QUFDakMsUUFBSXlCLEdBQUcsR0FBRyxNQUFNbEMsTUFBTSxDQUFDbUMsV0FBUCxDQUFtQixJQUFuQixFQUF5QixvQ0FBekIsRUFBK0QsSUFBL0QsQ0FBaEI7O0FBQ0EsUUFBSXpDLGdCQUFFMEMsT0FBRixDQUFVRixHQUFWLENBQUosRUFBb0I7QUFDbEIsWUFBTSxJQUFJcEMsS0FBSixDQUFVLG1DQUFWLENBQU47QUFDRDs7QUFDRCxRQUFJdUMsSUFBSSxHQUFHLEVBQVg7O0FBQ0EsU0FBSyxJQUFJQyxFQUFULElBQWVKLEdBQWYsRUFBb0I7QUFDbEIsVUFBSUssSUFBSSxHQUFHLE1BQU12QyxNQUFNLENBQUN3QyxZQUFQLENBQW9CLE1BQXBCLEVBQTRCQyxvQkFBS0MsYUFBTCxDQUFtQkosRUFBbkIsQ0FBNUIsQ0FBakI7QUFDQUQsTUFBQUEsSUFBSSxDQUFDRSxJQUFELENBQUosR0FBYUQsRUFBYjtBQUNEOztBQUNELFNBQUssSUFBSUssR0FBVCxJQUFnQlYsSUFBaEIsRUFBc0I7QUFDcEIsVUFBSUssRUFBRSxHQUFHRCxJQUFJLENBQUNNLEdBQUQsQ0FBYjtBQUNBLFlBQU0zQyxNQUFNLENBQUM0QyxLQUFQLENBQWFILG9CQUFLQyxhQUFMLENBQW1CSixFQUFuQixDQUFiLENBQU47QUFDRDtBQUNGLEdBZEQsTUFjTztBQUNMLFNBQUssSUFBSUssR0FBVCxJQUFnQlYsSUFBaEIsRUFBc0I7QUFDcEIsVUFBSUssRUFBRSxHQUFHLE1BQU10QyxNQUFNLENBQUNtQyxXQUFQLENBQW1CLElBQW5CLEVBQTBCLDhCQUE2QlEsR0FBSSxFQUEzRCxFQUE4RCxLQUE5RCxDQUFmOztBQUNBLFVBQUlMLEVBQUUsS0FBSyxJQUFYLEVBQWlCO0FBQ2YsY0FBTSxJQUFJeEMsS0FBSixDQUFXLDZCQUE0QjZDLEdBQUksV0FBM0MsQ0FBTjtBQUNEOztBQUNELFlBQU0zQyxNQUFNLENBQUM0QyxLQUFQLENBQWFILG9CQUFLQyxhQUFMLENBQW1CSixFQUFuQixDQUFiLENBQU47QUFDRDtBQUNGOztBQUdELFFBQU0scUJBQU1yRCxnQkFBTixDQUFOOztBQUNBLE1BQUksTUFBTWdCLEdBQUcsQ0FBQzRDLGNBQUosRUFBVixFQUFnQztBQUM5QixVQUFNN0MsTUFBTSxDQUFDSSxZQUFQLENBQW9CdEIsb0JBQXBCLENBQU47QUFDQSxVQUFNLHFCQUFNRyxnQkFBTixDQUFOO0FBQ0Q7QUFDRixDQWxDRDs7QUFvQ0FHLE9BQU8sQ0FBQzBELGNBQVIsR0FBeUIsZUFBZUEsY0FBZixDQUErQjdDLEdBQS9CLEVBQW9DRCxNQUFwQyxFQUE0QzZCLFlBQTVDLEVBQTBEO0FBQ2pGM0Isa0JBQU9DLElBQVAsQ0FBYSwwQ0FBeUMwQixZQUFZLENBQUNFLFNBQVUsRUFBN0U7O0FBQ0EsUUFBTTNDLE9BQU8sQ0FBQ1csZUFBUixDQUF3QkMsTUFBeEIsRUFBZ0NDLEdBQWhDLENBQU47QUFDQSxNQUFJUixHQUFHLEdBQUdvQyxZQUFZLENBQUNFLFNBQXZCO0FBRUF0QyxFQUFBQSxHQUFHLEdBQUdMLE9BQU8sQ0FBQ29DLGNBQVIsQ0FBdUIvQixHQUF2QixDQUFOO0FBRUEsUUFBTVEsR0FBRyxDQUFDTSxLQUFKLENBQVUsQ0FBQyxPQUFELEVBQVUsTUFBVixFQUFrQmQsR0FBbEIsQ0FBVixDQUFOO0FBRUEsUUFBTSxxQkFBTU4sb0JBQU4sQ0FBTjtBQUNBLFFBQU1jLEdBQUcsQ0FBQ00sS0FBSixDQUFVLENBQUMsT0FBRCxFQUFVLFVBQVYsRUFBc0J6QixvQkFBdEIsQ0FBVixDQUFOO0FBRUEsUUFBTSxxQkFBTUcsZ0JBQU4sQ0FBTjtBQUNELENBYkQ7O0FBZUFHLE9BQU8sQ0FBQzJELHFCQUFSLEdBQWdDLFNBQVNBLHFCQUFULENBQWdDdEQsR0FBaEMsRUFBcUN1RCxPQUFyQyxFQUE4Q0MsS0FBOUMsRUFBcUQ7QUFPbkYsUUFBTUMsSUFBSSxHQUFHLENBQWI7QUFDQSxRQUFNYixJQUFJLEdBQUcsQ0FBYjs7QUFDQSxNQUFJYyxJQUFJLEdBQUcsQ0FBQzFELEdBQUQsRUFBTXNCLENBQU4sRUFBU2tDLEtBQVQsS0FBbUI7QUFDNUIsV0FBT0csSUFBSSxDQUFDQyxLQUFMLENBQVd0QyxDQUFDLEdBQUcsQ0FBRXRCLEdBQUcsR0FBR3lELElBQVAsSUFBZ0JBLElBQWpCLElBQXlCRCxLQUE3QixHQUFxQ0EsS0FBSyxHQUFHLENBQXhELENBQVA7QUFDRCxHQUZEOztBQUdBLE1BQUlLLElBQUksR0FBRyxDQUFDN0QsR0FBRCxFQUFNd0IsQ0FBTixFQUFTZ0MsS0FBVCxLQUFtQjtBQUM1QixXQUFPRyxJQUFJLENBQUNDLEtBQUwsQ0FBV3BDLENBQUMsSUFBSW1DLElBQUksQ0FBQ0csSUFBTCxDQUFVLENBQUU5RCxHQUFHLEdBQUc0QyxJQUFQLElBQWdCQSxJQUFqQixJQUF5QmEsSUFBbkMsSUFBMkNELEtBQTNDLEdBQW1EQSxLQUFLLEdBQUcsQ0FBL0QsQ0FBWixDQUFQO0FBQ0QsR0FGRDs7QUFHQSxTQUFPO0FBQUNsQyxJQUFBQSxDQUFDLEVBQUVvQyxJQUFJLENBQUMxRCxHQUFELEVBQU11RCxPQUFPLENBQUNqQyxDQUFkLEVBQWlCa0MsS0FBakIsQ0FBUjtBQUFpQ2hDLElBQUFBLENBQUMsRUFBRXFDLElBQUksQ0FBQzdELEdBQUQsRUFBTXVELE9BQU8sQ0FBQy9CLENBQWQsRUFBaUJnQyxLQUFqQjtBQUF4QyxHQUFQO0FBQ0QsQ0FoQkQ7O0FBa0JBN0QsT0FBTyxDQUFDb0UsaUJBQVIsR0FBNEIsU0FBU0EsaUJBQVQsQ0FBNEJ2QixJQUE1QixFQUFrQ2UsT0FBbEMsRUFBMkNDLEtBQTNDLEVBQWtEO0FBQzVFLE1BQUk5QixPQUFPLEdBQUcsRUFBZDtBQUNBLE1BQUlzQyxPQUFKOztBQUNBLE9BQUssSUFBSWhFLEdBQVQsSUFBZ0J3QyxJQUFoQixFQUFzQjtBQUNwQixRQUFJeUIsTUFBTSxHQUFHdEUsT0FBTyxDQUFDMkQscUJBQVIsQ0FBOEJ0RCxHQUE5QixFQUFtQ3VELE9BQW5DLEVBQTRDQyxLQUE1QyxDQUFiOztBQUNBLFFBQUl4RCxHQUFHLEtBQUt3QyxJQUFJLENBQUMsQ0FBRCxDQUFoQixFQUFxQjtBQUNuQmQsTUFBQUEsT0FBTyxDQUFDd0MsSUFBUixDQUFhO0FBQUN2QyxRQUFBQSxNQUFNLEVBQUUsT0FBVDtBQUFrQkMsUUFBQUEsT0FBTyxFQUFFO0FBQUNDLFVBQUFBLE9BQU8sRUFBRSxJQUFWO0FBQWdCUCxVQUFBQSxDQUFDLEVBQUUyQyxNQUFNLENBQUMzQyxDQUExQjtBQUE2QkUsVUFBQUEsQ0FBQyxFQUFFeUMsTUFBTSxDQUFDekM7QUFBdkM7QUFBM0IsT0FBYjtBQUNBd0MsTUFBQUEsT0FBTyxHQUFHQyxNQUFWO0FBQ0E7QUFDRDs7QUFDRCxRQUFJRSxNQUFNLEdBQUc7QUFBQzdDLE1BQUFBLENBQUMsRUFBRSxDQUFKO0FBQU9FLE1BQUFBLENBQUMsRUFBRTtBQUFWLEtBQWI7QUFDQSxRQUFJNEMsS0FBSyxHQUFHSCxNQUFNLENBQUMzQyxDQUFQLEdBQVcwQyxPQUFPLENBQUMxQyxDQUEvQjs7QUFDQSxRQUFJOEMsS0FBSyxHQUFHLENBQVosRUFBZTtBQUNiRCxNQUFBQSxNQUFNLENBQUM3QyxDQUFQLEdBQVdrQyxLQUFYOztBQUNBLFVBQUlHLElBQUksQ0FBQ1UsR0FBTCxDQUFTRCxLQUFULElBQWtCWixLQUF0QixFQUE2QjtBQUMzQlcsUUFBQUEsTUFBTSxDQUFDN0MsQ0FBUCxJQUFZa0MsS0FBWjtBQUNEO0FBQ0YsS0FMRCxNQUtPLElBQUlZLEtBQUssR0FBRyxDQUFaLEVBQWU7QUFDcEJELE1BQUFBLE1BQU0sQ0FBQzdDLENBQVAsR0FBVyxDQUFDLENBQUQsR0FBS2tDLEtBQWhCOztBQUNBLFVBQUlHLElBQUksQ0FBQ1UsR0FBTCxDQUFTRCxLQUFULElBQWtCWixLQUF0QixFQUE2QjtBQUMzQlcsUUFBQUEsTUFBTSxDQUFDN0MsQ0FBUCxJQUFZa0MsS0FBWjtBQUNEO0FBQ0Y7O0FBQ0QsUUFBSWMsS0FBSyxHQUFHTCxNQUFNLENBQUN6QyxDQUFQLEdBQVd3QyxPQUFPLENBQUN4QyxDQUEvQjs7QUFDQSxRQUFJOEMsS0FBSyxHQUFHLENBQVosRUFBZTtBQUNiSCxNQUFBQSxNQUFNLENBQUMzQyxDQUFQLEdBQVdnQyxLQUFYOztBQUNBLFVBQUlHLElBQUksQ0FBQ1UsR0FBTCxDQUFTQyxLQUFULElBQWtCZCxLQUF0QixFQUE2QjtBQUMzQlcsUUFBQUEsTUFBTSxDQUFDM0MsQ0FBUCxJQUFZZ0MsS0FBWjtBQUNEO0FBQ0YsS0FMRCxNQUtPLElBQUljLEtBQUssR0FBRyxDQUFaLEVBQWU7QUFDcEJILE1BQUFBLE1BQU0sQ0FBQzNDLENBQVAsR0FBVyxDQUFDLENBQUQsR0FBS2dDLEtBQWhCOztBQUNBLFVBQUlHLElBQUksQ0FBQ1UsR0FBTCxDQUFTQyxLQUFULElBQWtCZCxLQUF0QixFQUE2QjtBQUMzQlcsUUFBQUEsTUFBTSxDQUFDM0MsQ0FBUCxJQUFZZ0MsS0FBWjtBQUNEO0FBQ0Y7O0FBQ0Q5QixJQUFBQSxPQUFPLENBQUN3QyxJQUFSLENBQWE7QUFBQ3ZDLE1BQUFBLE1BQU0sRUFBRSxRQUFUO0FBQW1CQyxNQUFBQSxPQUFPLEVBQUU7QUFBQ0MsUUFBQUEsT0FBTyxFQUFFLElBQVY7QUFBZ0JQLFFBQUFBLENBQUMsRUFBRTZDLE1BQU0sQ0FBQzdDLENBQVAsR0FBVzBDLE9BQU8sQ0FBQzFDLENBQXRDO0FBQXlDRSxRQUFBQSxDQUFDLEVBQUUyQyxNQUFNLENBQUMzQyxDQUFQLEdBQVd3QyxPQUFPLENBQUN4QztBQUEvRDtBQUE1QixLQUFiO0FBQ0F3QyxJQUFBQSxPQUFPLEdBQUdDLE1BQVY7QUFDRDs7QUFDRHZDLEVBQUFBLE9BQU8sQ0FBQ3dDLElBQVIsQ0FBYTtBQUFDdkMsSUFBQUEsTUFBTSxFQUFFO0FBQVQsR0FBYjtBQUNBLFNBQU9ELE9BQVA7QUFDRCxDQXhDRDs7QUEwQ0EvQixPQUFPLENBQUM0RSxhQUFSLEdBQXdCLGVBQWVBLGFBQWYsQ0FBOEIvRCxHQUE5QixFQUFtQ0QsTUFBbkMsRUFBMkM2QixZQUEzQyxFQUF5RDtBQUMvRTNCLGtCQUFPQyxJQUFQLENBQWEseUNBQXdDMEIsWUFBWSxDQUFDRSxTQUFVLEVBQTVFOztBQUNBLFFBQU0zQyxPQUFPLENBQUNXLGVBQVIsQ0FBd0JDLE1BQXhCLEVBQWdDQyxHQUFoQyxDQUFOO0FBQ0EsTUFBSWdDLElBQUksR0FBRzdDLE9BQU8sQ0FBQ3NDLGNBQVIsQ0FBdUJHLFlBQVksQ0FBQ0UsU0FBcEMsQ0FBWDtBQVVBLE1BQUlrQyxRQUFRLEdBQUcsTUFBTWhFLEdBQUcsQ0FBQ1EsV0FBSixFQUFyQjtBQUNBLE1BQUk2QixFQUFFLEdBQUcsTUFBTXRDLE1BQU0sQ0FBQ21DLFdBQVAsQ0FBbUIsSUFBbkIsRUFDWixlQUFjOEIsUUFBUSxJQUFJLEVBQVosR0FBaUIsVUFBakIsR0FBOEIsVUFBVyxxQkFEM0MsRUFFYixLQUZhLENBQWY7QUFJQSxNQUFJakIsT0FBTyxHQUFHLE1BQU1oRCxNQUFNLENBQUNrRSxXQUFQLENBQW1CekIsb0JBQUtDLGFBQUwsQ0FBbUJKLEVBQW5CLENBQW5CLENBQXBCO0FBQ0EsTUFBSTZCLElBQUksR0FBRyxNQUFNbkUsTUFBTSxDQUFDb0UsT0FBUCxDQUFlM0Isb0JBQUtDLGFBQUwsQ0FBbUJKLEVBQW5CLENBQWYsQ0FBakI7QUFFQSxNQUFJbkIsT0FBTyxHQUFHL0IsT0FBTyxDQUFDb0UsaUJBQVIsQ0FBMEJ2QixJQUExQixFQUFnQ2UsT0FBaEMsRUFBeUNtQixJQUFJLENBQUNFLEtBQUwsR0FBYSxDQUF0RCxDQUFkO0FBRUEsUUFBTXJFLE1BQU0sQ0FBQ3VCLFlBQVAsQ0FBb0JKLE9BQXBCLENBQU47QUFFQSxRQUFNLHFCQUFNbEMsZ0JBQU4sQ0FBTjtBQUNELENBMUJEOztBQTRCQUcsT0FBTyxDQUFDWCxVQUFSLEdBQXFCQSxVQUFyQjtBQUNBVyxPQUFPLENBQUNWLGVBQVIsR0FBMEJBLGVBQTFCO0FBQ0FVLE9BQU8sQ0FBQ1QsY0FBUixHQUF5QkEsY0FBekI7QUFDQVMsT0FBTyxDQUFDUixrQkFBUixHQUE2QkEsa0JBQTdCO2VBR2VRLE8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHNsZWVwIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmNvbnN0IFBJTl9VTkxPQ0sgPSAncGluJztcbmNvbnN0IFBBU1NXT1JEX1VOTE9DSyA9ICdwYXNzd29yZCc7XG5jb25zdCBQQVRURVJOX1VOTE9DSyA9ICdwYXR0ZXJuJztcbmNvbnN0IEZJTkdFUlBSSU5UX1VOTE9DSyA9ICdmaW5nZXJwcmludCc7XG5jb25zdCBVTkxPQ0tfVFlQRVMgPSBbUElOX1VOTE9DSywgUEFTU1dPUkRfVU5MT0NLLCBQQVRURVJOX1VOTE9DSywgRklOR0VSUFJJTlRfVU5MT0NLXTtcbmNvbnN0IEtFWUNPREVfTlVNUEFEX0VOVEVSID0gNjY7XG5jb25zdCBLRVlDT0RFX1BPV0VSID0gMjY7XG5jb25zdCBLRVlDT0RFX1dBS0VVUCA9IDIyNDsgLy8gQ2FuIHdvcmsgb3ZlciBBUEkgTGV2ZWwgMjBcbmNvbnN0IFVOTE9DS19XQUlUX1RJTUUgPSAxMDA7XG5jb25zdCBISURFX0tFWUJPQVJEX1dBSVRfVElNRSA9IDEwMDtcbmNvbnN0IElOUFVUX0tFWVNfV0FJVF9USU1FID0gMTAwO1xuXG5sZXQgaGVscGVycyA9IHt9O1xuaGVscGVycy5pc1ZhbGlkVW5sb2NrVHlwZSA9IGZ1bmN0aW9uIGlzVmFsaWRVbmxvY2tUeXBlICh0eXBlKSB7XG4gIHJldHVybiBVTkxPQ0tfVFlQRVMuaW5kZXhPZih0eXBlKSAhPT0gLTE7XG59O1xuXG5oZWxwZXJzLmlzVmFsaWRLZXkgPSBmdW5jdGlvbiBpc1ZhbGlkS2V5ICh0eXBlLCBrZXkpIHtcbiAgaWYgKF8uaXNVbmRlZmluZWQoa2V5KSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICBpZiAodHlwZSA9PT0gUElOX1VOTE9DSyB8fCB0eXBlID09PSBGSU5HRVJQUklOVF9VTkxPQ0spIHtcbiAgICByZXR1cm4gL15bMC05XSskLy50ZXN0KGtleS50cmltKCkpO1xuICB9XG4gIGlmICh0eXBlID09PSBQQVRURVJOX1VOTE9DSykge1xuICAgIGlmICghL15bMS05XXsyLDl9JC8udGVzdChrZXkudHJpbSgpKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gISgvKFsxLTldKS4qP1xcMS8udGVzdChrZXkudHJpbSgpKSk7XG4gIH1cbiAgLy8gRG9udCB0cmltIHBhc3N3b3JkIGtleSwgeW91IGNhbiB1c2UgYmxhbmsgc3BhY2VzIGluIHlvdXIgYW5kcm9pZCBwYXNzd29yZFxuICAvLyDCr1xcXyjjg4QpXy/Cr1xuICBpZiAodHlwZSA9PT0gUEFTU1dPUkRfVU5MT0NLKSB7XG4gICAgcmV0dXJuIC8uezQsfS9nLnRlc3Qoa2V5KTtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgdW5sb2NrIHR5cGUgJHt0eXBlfWApO1xufTtcblxuaGVscGVycy5kaXNtaXNzS2V5Z3VhcmQgPSBhc3luYyBmdW5jdGlvbiBkaXNtaXNzS2V5Z3VhcmQgKGRyaXZlciwgYWRiKSB7XG4gIGxvZ2dlci5pbmZvKCdXYWtpbmcgdXAgdGhlIGRldmljZSB0byB1bmxvY2sgaXQnKTtcbiAgLy8gU2NyZWVuIG9mZiBvbmNlIHRvIGZvcmNlIHByZS1pbnB1dHRlZCB0ZXh0IGZpZWxkIGNsZWFuIGFmdGVyIHdha2UtdXBcbiAgLy8gSnVzdCBzY3JlZW4gb24gaWYgdGhlIHNjcmVlbiBkZWZhdWx0cyBvZmZcbiAgYXdhaXQgZHJpdmVyLnByZXNzS2V5Q29kZShLRVlDT0RFX1BPV0VSKTtcbiAgYXdhaXQgZHJpdmVyLnByZXNzS2V5Q29kZShLRVlDT0RFX1dBS0VVUCk7XG4gIGxldCBpc0tleWJvYXJkU2hvd24gPSBhd2FpdCBkcml2ZXIuaXNLZXlib2FyZFNob3duKCk7XG4gIGlmIChpc0tleWJvYXJkU2hvd24pIHtcbiAgICBhd2FpdCBkcml2ZXIuaGlkZUtleWJvYXJkKCk7XG4gICAgLy8gV2FpdHMgYSBiaXQgZm9yIHRoZSBrZXlib2FyZCB0byBoaWRlXG4gICAgYXdhaXQgc2xlZXAoSElERV9LRVlCT0FSRF9XQUlUX1RJTUUpO1xuICB9XG4gIC8vIGRpc21pc3Mgbm90aWZpY2F0aW9uc1xuICBsb2dnZXIuaW5mbygnRGlzbWlzcyBub3RpZmljYXRpb25zIGZyb20gdW5sb2NrIHZpZXcnKTtcbiAgYXdhaXQgYWRiLnNoZWxsKFsnc2VydmljZScsICdjYWxsJywgJ25vdGlmaWNhdGlvbicsICcxJ10pO1xuICBhd2FpdCBhZGIuYmFjaygpO1xuICBpZiAoYXdhaXQgYWRiLmdldEFwaUxldmVsKCkgPiAyMSkge1xuICAgIGxvZ2dlci5pbmZvKCdUcnlpbmcgdG8gZGlzbWlzcyBrZXlndWFyZCcpO1xuICAgIGF3YWl0IGFkYi5zaGVsbChbJ3dtJywgJ2Rpc21pc3Mta2V5Z3VhcmQnXSk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxvZ2dlci5pbmZvKCdTd2lwaW5nIHVwIHRvIGRpc21pc3Mga2V5Z3VhcmQnKTtcbiAgYXdhaXQgaGVscGVycy5zd2lwZVVwKGRyaXZlcik7XG59O1xuXG5oZWxwZXJzLnN3aXBlVXAgPSBhc3luYyBmdW5jdGlvbiBzd2lwZVVwIChkcml2ZXIpIHtcbiAgbGV0IHdpbmRvd1NpemUgPSBhd2FpdCBkcml2ZXIuZ2V0V2luZG93U2l6ZSgpO1xuICBsZXQgeDAgPSBwYXJzZUludCh3aW5kb3dTaXplLnggLyAyLCAxMCk7XG4gIGxldCB5MCA9IHdpbmRvd1NpemUueSAtIDEwO1xuICBsZXQgeVAgPSAxMDA7XG4gIGxldCBhY3Rpb25zID0gW1xuICAgIHthY3Rpb246ICdwcmVzcycsIG9wdGlvbnM6IHtlbGVtZW50OiBudWxsLCB4OiB4MCwgeTogeTB9fSxcbiAgICB7YWN0aW9uOiAnbW92ZVRvJywgb3B0aW9uczoge2VsZW1lbnQ6IG51bGwsIHg6IHgwLCB5OiB5UH19LFxuICAgIHthY3Rpb246ICdyZWxlYXNlJ31cbiAgXTtcbiAgYXdhaXQgZHJpdmVyLnBlcmZvcm1Ub3VjaChhY3Rpb25zKTtcbn07XG5cbmhlbHBlcnMuZW5jb2RlUGFzc3dvcmQgPSBmdW5jdGlvbiBlbmNvZGVQYXNzd29yZCAoa2V5KSB7XG4gIHJldHVybiBrZXkucmVwbGFjZSgvXFxzL2lnLCAnJXMnKTtcbn07XG5cbmhlbHBlcnMuc3RyaW5nS2V5VG9BcnIgPSBmdW5jdGlvbiBzdHJpbmdLZXlUb0FyciAoa2V5KSB7XG4gIHJldHVybiBrZXkudHJpbSgpLnJlcGxhY2UoL1xccysvZywgJycpLnNwbGl0KC9cXHMqLyk7XG59O1xuXG5oZWxwZXJzLmZpbmdlcnByaW50VW5sb2NrID0gYXN5bmMgZnVuY3Rpb24gZmluZ2VycHJpbnRVbmxvY2sgKGFkYiwgZHJpdmVyLCBjYXBhYmlsaXRpZXMpIHtcbiAgaWYgKGF3YWl0IGFkYi5nZXRBcGlMZXZlbCgpIDwgMjMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZpbmdlcnByaW50IHVubG9jayBvbmx5IHdvcmtzIGZvciBBbmRyb2lkIDYrIGVtdWxhdG9ycycpO1xuICB9XG4gIGF3YWl0IGFkYi5maW5nZXJwcmludChjYXBhYmlsaXRpZXMudW5sb2NrS2V5KTtcbiAgYXdhaXQgc2xlZXAoVU5MT0NLX1dBSVRfVElNRSk7XG59O1xuXG5oZWxwZXJzLnBpblVubG9jayA9IGFzeW5jIGZ1bmN0aW9uIHBpblVubG9jayAoYWRiLCBkcml2ZXIsIGNhcGFiaWxpdGllcykge1xuICBsb2dnZXIuaW5mbyhgVHJ5aW5nIHRvIHVubG9jayBkZXZpY2UgdXNpbmcgcGluICR7Y2FwYWJpbGl0aWVzLnVubG9ja0tleX1gKTtcbiAgYXdhaXQgaGVscGVycy5kaXNtaXNzS2V5Z3VhcmQoZHJpdmVyLCBhZGIpO1xuICBsZXQga2V5cyA9IGhlbHBlcnMuc3RyaW5nS2V5VG9BcnIoY2FwYWJpbGl0aWVzLnVubG9ja0tleSk7XG4gIGlmIChhd2FpdCBhZGIuZ2V0QXBpTGV2ZWwoKSA+PSAyMSkge1xuICAgIGxldCBlbHMgPSBhd2FpdCBkcml2ZXIuZmluZEVsT3JFbHMoJ2lkJywgJ2NvbS5hbmRyb2lkLnN5c3RlbXVpOmlkL2RpZ2l0X3RleHQnLCB0cnVlKTtcbiAgICBpZiAoXy5pc0VtcHR5KGVscykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRXJyb3IgZmluZGluZyB1bmxvY2sgcGluIGJ1dHRvbnMhJyk7XG4gICAgfVxuICAgIGxldCBwaW5zID0ge307XG4gICAgZm9yIChsZXQgZWwgb2YgZWxzKSB7XG4gICAgICBsZXQgdGV4dCA9IGF3YWl0IGRyaXZlci5nZXRBdHRyaWJ1dGUoJ3RleHQnLCB1dGlsLnVud3JhcEVsZW1lbnQoZWwpKTtcbiAgICAgIHBpbnNbdGV4dF0gPSBlbDtcbiAgICB9XG4gICAgZm9yIChsZXQgcGluIG9mIGtleXMpIHtcbiAgICAgIGxldCBlbCA9IHBpbnNbcGluXTtcbiAgICAgIGF3YWl0IGRyaXZlci5jbGljayh1dGlsLnVud3JhcEVsZW1lbnQoZWwpKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgZm9yIChsZXQgcGluIG9mIGtleXMpIHtcbiAgICAgIGxldCBlbCA9IGF3YWl0IGRyaXZlci5maW5kRWxPckVscygnaWQnLCBgY29tLmFuZHJvaWQua2V5Z3VhcmQ6aWQva2V5JHtwaW59YCwgZmFsc2UpO1xuICAgICAgaWYgKGVsID09PSBudWxsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRXJyb3IgZmluZGluZyB1bmxvY2sgcGluICcke3Bpbn0nIGJ1dHRvbiFgKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IGRyaXZlci5jbGljayh1dGlsLnVud3JhcEVsZW1lbnQoZWwpKTtcbiAgICB9XG4gIH1cbiAgLy8gU29tZSBkZXZpY2VzIGFjY2VwdCBlbnRlcmluZyB0aGUgY29kZSB3aXRob3V0IHByZXNzaW5nIHRoZSBFbnRlciBrZXlcbiAgLy8gV2hlbiBJIHJ1c2hlZCBjb21tYW5kcyB3aXRob3V0IHRoaXMgd2FpdCBiZWZvcmUgcHJlc3NLZXlDb2RlLCByYXJlbHkgVUkyIHNldmVyIGNyYXNoZWRcbiAgYXdhaXQgc2xlZXAoVU5MT0NLX1dBSVRfVElNRSk7XG4gIGlmIChhd2FpdCBhZGIuaXNTY3JlZW5Mb2NrZWQoKSkge1xuICAgIGF3YWl0IGRyaXZlci5wcmVzc0tleUNvZGUoS0VZQ09ERV9OVU1QQURfRU5URVIpO1xuICAgIGF3YWl0IHNsZWVwKFVOTE9DS19XQUlUX1RJTUUpO1xuICB9XG59O1xuXG5oZWxwZXJzLnBhc3N3b3JkVW5sb2NrID0gYXN5bmMgZnVuY3Rpb24gcGFzc3dvcmRVbmxvY2sgKGFkYiwgZHJpdmVyLCBjYXBhYmlsaXRpZXMpIHtcbiAgbG9nZ2VyLmluZm8oYFRyeWluZyB0byB1bmxvY2sgZGV2aWNlIHVzaW5nIHBhc3N3b3JkICR7Y2FwYWJpbGl0aWVzLnVubG9ja0tleX1gKTtcbiAgYXdhaXQgaGVscGVycy5kaXNtaXNzS2V5Z3VhcmQoZHJpdmVyLCBhZGIpO1xuICBsZXQga2V5ID0gY2FwYWJpbGl0aWVzLnVubG9ja0tleTtcbiAgLy8gUmVwbGFjZSBibGFuayBzcGFjZXMgd2l0aCAlc1xuICBrZXkgPSBoZWxwZXJzLmVuY29kZVBhc3N3b3JkKGtleSk7XG4gIC8vIFdoeSBhZGIgPyBJdCB3YXMgbGVzcyBmbGFreVxuICBhd2FpdCBhZGIuc2hlbGwoWydpbnB1dCcsICd0ZXh0Jywga2V5XSk7XG4gIC8vIFdoeSBzbGVlcHMgPyBBdm9pZCBzb21lIGZsYWt5bmVzcyB3YWl0aW5nIGZvciB0aGUgaW5wdXQgdG8gcmVjZWl2ZSB0aGUga2V5c1xuICBhd2FpdCBzbGVlcChJTlBVVF9LRVlTX1dBSVRfVElNRSk7XG4gIGF3YWl0IGFkYi5zaGVsbChbJ2lucHV0JywgJ2tleWV2ZW50JywgS0VZQ09ERV9OVU1QQURfRU5URVJdKTtcbiAgLy8gV2FpdHMgYSBiaXQgZm9yIHRoZSBkZXZpY2UgdG8gYmUgdW5sb2NrZWRcbiAgYXdhaXQgc2xlZXAoVU5MT0NLX1dBSVRfVElNRSk7XG59O1xuXG5oZWxwZXJzLmdldFBhdHRlcm5LZXlQb3NpdGlvbiA9IGZ1bmN0aW9uIGdldFBhdHRlcm5LZXlQb3NpdGlvbiAoa2V5LCBpbml0UG9zLCBwaWVjZSkge1xuICAvKlxuICBIb3cgdGhlIG1hdGggd29ya3M6XG4gIFdlIGhhdmUgOSBidXR0b25zIGRpdmlkZWQgaW4gMyBjb2x1bW5zIGFuZCAzIHJvd3MgaW5zaWRlIHRoZSBsb2NrUGF0dGVyblZpZXcsXG4gIGV2ZXJ5IGJ1dHRvbiBoYXMgYSBwb3NpdGlvbiBvbiB0aGUgc2NyZWVuIGNvcnJlc3BvbmRpbmcgdG8gdGhlIGxvY2tQYXR0ZXJuVmlldyBzaW5jZVxuICBpdCBpcyB0aGUgcGFyZW50IHZpZXcgcmlnaHQgYXQgdGhlIG1pZGRsZSBvZiBlYWNoIGNvbHVtbiBvciByb3cuXG4gICovXG4gIGNvbnN0IGNvbHMgPSAzO1xuICBjb25zdCBwaW5zID0gOTtcbiAgbGV0IHhQb3MgPSAoa2V5LCB4LCBwaWVjZSkgPT4ge1xuICAgIHJldHVybiBNYXRoLnJvdW5kKHggKyAoKGtleSAlIGNvbHMpIHx8IGNvbHMpICogcGllY2UgLSBwaWVjZSAvIDIpO1xuICB9O1xuICBsZXQgeVBvcyA9IChrZXksIHksIHBpZWNlKSA9PiB7XG4gICAgcmV0dXJuIE1hdGgucm91bmQoeSArIChNYXRoLmNlaWwoKChrZXkgJSBwaW5zKSB8fCBwaW5zKSAvIGNvbHMpICogcGllY2UgLSBwaWVjZSAvIDIpKTtcbiAgfTtcbiAgcmV0dXJuIHt4OiB4UG9zKGtleSwgaW5pdFBvcy54LCBwaWVjZSksIHk6IHlQb3Moa2V5LCBpbml0UG9zLnksIHBpZWNlKX07XG59O1xuXG5oZWxwZXJzLmdldFBhdHRlcm5BY3Rpb25zID0gZnVuY3Rpb24gZ2V0UGF0dGVybkFjdGlvbnMgKGtleXMsIGluaXRQb3MsIHBpZWNlKSB7XG4gIGxldCBhY3Rpb25zID0gW107XG4gIGxldCBsYXN0UG9zO1xuICBmb3IgKGxldCBrZXkgb2Yga2V5cykge1xuICAgIGxldCBrZXlQb3MgPSBoZWxwZXJzLmdldFBhdHRlcm5LZXlQb3NpdGlvbihrZXksIGluaXRQb3MsIHBpZWNlKTtcbiAgICBpZiAoa2V5ID09PSBrZXlzWzBdKSB7XG4gICAgICBhY3Rpb25zLnB1c2goe2FjdGlvbjogJ3ByZXNzJywgb3B0aW9uczoge2VsZW1lbnQ6IG51bGwsIHg6IGtleVBvcy54LCB5OiBrZXlQb3MueX19KTtcbiAgICAgIGxhc3RQb3MgPSBrZXlQb3M7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgbGV0IG1vdmVUbyA9IHt4OiAwLCB5OiAwfTtcbiAgICBsZXQgZGlmZlggPSBrZXlQb3MueCAtIGxhc3RQb3MueDtcbiAgICBpZiAoZGlmZlggPiAwKSB7XG4gICAgICBtb3ZlVG8ueCA9IHBpZWNlO1xuICAgICAgaWYgKE1hdGguYWJzKGRpZmZYKSA+IHBpZWNlKSB7XG4gICAgICAgIG1vdmVUby54ICs9IHBpZWNlO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZGlmZlggPCAwKSB7XG4gICAgICBtb3ZlVG8ueCA9IC0xICogcGllY2U7XG4gICAgICBpZiAoTWF0aC5hYnMoZGlmZlgpID4gcGllY2UpIHtcbiAgICAgICAgbW92ZVRvLnggLT0gcGllY2U7XG4gICAgICB9XG4gICAgfVxuICAgIGxldCBkaWZmWSA9IGtleVBvcy55IC0gbGFzdFBvcy55O1xuICAgIGlmIChkaWZmWSA+IDApIHtcbiAgICAgIG1vdmVUby55ID0gcGllY2U7XG4gICAgICBpZiAoTWF0aC5hYnMoZGlmZlkpID4gcGllY2UpIHtcbiAgICAgICAgbW92ZVRvLnkgKz0gcGllY2U7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChkaWZmWSA8IDApIHtcbiAgICAgIG1vdmVUby55ID0gLTEgKiBwaWVjZTtcbiAgICAgIGlmIChNYXRoLmFicyhkaWZmWSkgPiBwaWVjZSkge1xuICAgICAgICBtb3ZlVG8ueSAtPSBwaWVjZTtcbiAgICAgIH1cbiAgICB9XG4gICAgYWN0aW9ucy5wdXNoKHthY3Rpb246ICdtb3ZlVG8nLCBvcHRpb25zOiB7ZWxlbWVudDogbnVsbCwgeDogbW92ZVRvLnggKyBsYXN0UG9zLngsIHk6IG1vdmVUby55ICsgbGFzdFBvcy55fX0pO1xuICAgIGxhc3RQb3MgPSBrZXlQb3M7XG4gIH1cbiAgYWN0aW9ucy5wdXNoKHthY3Rpb246ICdyZWxlYXNlJ30pO1xuICByZXR1cm4gYWN0aW9ucztcbn07XG5cbmhlbHBlcnMucGF0dGVyblVubG9jayA9IGFzeW5jIGZ1bmN0aW9uIHBhdHRlcm5VbmxvY2sgKGFkYiwgZHJpdmVyLCBjYXBhYmlsaXRpZXMpIHtcbiAgbG9nZ2VyLmluZm8oYFRyeWluZyB0byB1bmxvY2sgZGV2aWNlIHVzaW5nIHBhdHRlcm4gJHtjYXBhYmlsaXRpZXMudW5sb2NrS2V5fWApO1xuICBhd2FpdCBoZWxwZXJzLmRpc21pc3NLZXlndWFyZChkcml2ZXIsIGFkYik7XG4gIGxldCBrZXlzID0gaGVscGVycy5zdHJpbmdLZXlUb0FycihjYXBhYmlsaXRpZXMudW5sb2NrS2V5KTtcbiAgLyogV2Ugc2V0IHRoZSBkZXZpY2UgcGF0dGVybiBidXR0b25zIGFzIG51bWJlciBvZiBhIHJlZ3VsYXIgcGhvbmVcbiAgICogIHwg4oCiIOKAoiDigKIgfCAgICAgfCAxIDIgMyB8XG4gICAqICB8IOKAoiDigKIg4oCiIHwgLS0+IHwgNCA1IDYgfFxuICAgKiAgfCDigKIg4oCiIOKAoiB8ICAgICB8IDcgOCA5IHxcblxuICBUaGUgcGF0dGVybiB2aWV3IGJ1dHRvbnMgYXJlIG5vdCBzZWVpbmcgYnkgdGhlIHVpYXV0b21hdG9yIHNpbmNlIHRoZXkgYXJlXG4gIGluY2x1ZGVkIGluc2lkZSBhIEZyYW1lTGF5b3V0LCBzbyB3ZSBhcmUgZ29pbmcgdG8gdHJ5IGNsaWNraW5nIG9uIHRoZSBidXR0b25zXG4gIHVzaW5nIHRoZSBwYXJlbnQgdmlldyBib3VuZHMgYW5kIG1hdGguXG4gICovXG4gIGxldCBhcGlMZXZlbCA9IGF3YWl0IGFkYi5nZXRBcGlMZXZlbCgpO1xuICBsZXQgZWwgPSBhd2FpdCBkcml2ZXIuZmluZEVsT3JFbHMoJ2lkJyxcbiAgICBgY29tLmFuZHJvaWQuJHthcGlMZXZlbCA+PSAyMSA/ICdzeXN0ZW11aScgOiAna2V5Z3VhcmQnfTppZC9sb2NrUGF0dGVyblZpZXdgLFxuICAgIGZhbHNlXG4gICk7XG4gIGxldCBpbml0UG9zID0gYXdhaXQgZHJpdmVyLmdldExvY2F0aW9uKHV0aWwudW53cmFwRWxlbWVudChlbCkpO1xuICBsZXQgc2l6ZSA9IGF3YWl0IGRyaXZlci5nZXRTaXplKHV0aWwudW53cmFwRWxlbWVudChlbCkpO1xuICAvLyBHZXQgYWN0aW9ucyB0byBwZXJmb3JtXG4gIGxldCBhY3Rpb25zID0gaGVscGVycy5nZXRQYXR0ZXJuQWN0aW9ucyhrZXlzLCBpbml0UG9zLCBzaXplLndpZHRoIC8gMyk7XG4gIC8vIFBlcmZvcm0gZ2VzdHVyZVxuICBhd2FpdCBkcml2ZXIucGVyZm9ybVRvdWNoKGFjdGlvbnMpO1xuICAvLyBXYWl0cyBhIGJpdCBmb3IgdGhlIGRldmljZSB0byBiZSB1bmxvY2tlZFxuICBhd2FpdCBzbGVlcChVTkxPQ0tfV0FJVF9USU1FKTtcbn07XG5cbmhlbHBlcnMuUElOX1VOTE9DSyA9IFBJTl9VTkxPQ0s7XG5oZWxwZXJzLlBBU1NXT1JEX1VOTE9DSyA9IFBBU1NXT1JEX1VOTE9DSztcbmhlbHBlcnMuUEFUVEVSTl9VTkxPQ0sgPSBQQVRURVJOX1VOTE9DSztcbmhlbHBlcnMuRklOR0VSUFJJTlRfVU5MT0NLID0gRklOR0VSUFJJTlRfVU5MT0NLO1xuXG5leHBvcnQgeyBQSU5fVU5MT0NLLCBQQVNTV09SRF9VTkxPQ0ssIFBBVFRFUk5fVU5MT0NLLCBGSU5HRVJQUklOVF9VTkxPQ0ssIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGhlbHBlcnM7XG4iXSwiZmlsZSI6ImxpYi91bmxvY2staGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
