"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.TizenDriver = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _desiredCaps = _interopRequireDefault(require("./desired-caps"));

var _index = _interopRequireDefault(require("./commands/index"));

var _tizenHelpers = _interopRequireDefault(require("./tizen-helpers"));

var _tizenBootstrap = _interopRequireDefault(require("./tizen-bootstrap.js"));

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSdb = require("appium-sdb");

var _appiumSupport = require("appium-support");

const BOOTSTRAP_PORT = 8888;
const NO_PROXY = [['POST', new RegExp('^/session/[^/]+/appium')], ['GET', new RegExp('^/session/[^/]+/appium')]];

class TizenDriver extends _appiumBaseDriver.BaseDriver {
  constructor(opts = {}, shouldValidateCaps = true) {
    super(opts, shouldValidateCaps);
    this.locatorStrategies = ['id', 'accessibility id', 'class name', 'name'];
    this.desiredCapConstraints = _desiredCaps.default;
    this.jwpProxyActive = false;
    this.jwpProxyAvoid = _lodash.default.clone(NO_PROXY);
    this.settings = new _appiumBaseDriver.DeviceSettings({
      ignoreUnimportantViews: false
    });
    this.bootstrapPort = BOOTSTRAP_PORT;

    for (let [cmd, fn] of _lodash.default.toPairs(_index.default)) {
      TizenDriver.prototype[cmd] = fn;
    }
  }

  async createSession(caps) {
    try {
      let sessionId;
      [sessionId] = await super.createSession(caps);
      let serverDetails = {
        platform: 'LINUX',
        webStorageEnabled: false,
        takesScreenshot: false,
        javascriptEnabled: true,
        databaseEnabled: false,
        networkConnectionEnabled: false,
        locationContextEnabled: false,
        warnings: {},
        desired: this.caps
      };
      this.caps = Object.assign(serverDetails, this.caps);
      let defaultOpts = {
        tmpDir: await _appiumSupport.tempDir.staticDir(),
        fullReset: false,
        sdbPort: _appiumSdb.DEFAULT_SDB_PORT,
        tizenInstallTimeout: 50000
      };

      _lodash.default.defaults(this.opts, defaultOpts);

      if (this.opts.noReset === true) {
        this.opts.fullReset = false;
      }

      if (this.opts.fullReset === true) {
        this.opts.noReset = false;
      }

      this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
      this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;
      let {
        udid,
        emPort
      } = await _tizenHelpers.default.getDeviceInfoFromCaps(this.opts);
      this.opts.udid = udid;
      this.opts.emPort = emPort;
      this.sdb = await _tizenHelpers.default.createSDB(this.opts.udid, this.opts.emPort, this.opts.sdbPort, this.opts.suppressKillServer);
      await this.startTizenSession(this.opts);
      return [sessionId, this.caps];
    } catch (e) {
      try {
        await this.deleteSession();
      } catch (ign) {}

      throw e;
    }
  }

  get appOnDevice() {
    return this.helpers.isPackageOrBundle(this.opts.appPackage);
  }

  async startTizenSession() {
    if (this.opts.app) {
      await this.installApp(this.opts.app);
    }

    let isAppInstalled = await this.isAppInstalled(this.opts.appPackage);

    if (!isAppInstalled) {
      _logger.default.errorAndThrow('Could not find to App in device.');
    }

    if (this.opts.appPackage) {
      let isStartedApp = await this.isStartedApp();

      if (isStartedApp) {
        await this.closeApp();
      }

      await this.startApp({
        timeout: 20000
      });
    }

    this.bootstrap = new _tizenBootstrap.default(this.sdb, this.bootstrapPort, this.opts);
    await this.bootstrap.start(this.opts.appPackage);

    if (this.opts.ignoreUnimportantViews) {
      await this.settings.update({
        ignoreUnimportantViews: this.opts.ignoreUnimportantViews
      });
    }
  }

  async checkPackagePresent() {
    _logger.default.debug("Checking whether package is present on the device");

    if (!(await this.sdb.shell([`app_launcher --list | grep ${this.opts.appPackage}`]))) {
      _logger.default.errorAndThrow(`Could not find package ${this.opts.appPackage} on the device`);
    }
  }

  async deleteSession() {
    _logger.default.debug("Shutting down Tizen driver");

    await super.deleteSession();

    if (this.bootstrap) {
      await this.sdb.forceStop(this.opts.appPackage);

      if (this.opts.fullReset && !this.opts.skipUninstall && !this.appOnDevice) {
        await this.sdb.uninstall(this.opts.appPackage);
      }

      await this.bootstrap.shutdown();
      this.bootstrap = null;
    } else {
      _logger.default.debug("Called deleteSession but bootstrap wasn't active");
    }
  }

  validateDesiredCaps(caps) {
    let res = super.validateDesiredCaps(caps);

    if (!res) {
      return res;
    }

    if (!caps.appPackage) {
      let msg = 'The desired capabilities must include an appPackage';

      _logger.default.errorAndThrow(msg);
    }
  }

  proxyActive(sessionId) {
    super.proxyActive(sessionId);
    return this.jwpProxyActive;
  }

  getProxyAvoidList(sessionId) {
    super.getProxyAvoidList(sessionId);
    return this.jwpProxyAvoid;
  }

  canProxy(sessionId) {
    super.canProxy(sessionId);
    return false;
  }

}

exports.TizenDriver = TizenDriver;
var _default = TizenDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOlsiQk9PVFNUUkFQX1BPUlQiLCJOT19QUk9YWSIsIlJlZ0V4cCIsIlRpemVuRHJpdmVyIiwiQmFzZURyaXZlciIsImNvbnN0cnVjdG9yIiwib3B0cyIsInNob3VsZFZhbGlkYXRlQ2FwcyIsImxvY2F0b3JTdHJhdGVnaWVzIiwiZGVzaXJlZENhcENvbnN0cmFpbnRzIiwiZGVzaXJlZENvbnN0cmFpbnRzIiwiandwUHJveHlBY3RpdmUiLCJqd3BQcm94eUF2b2lkIiwiXyIsImNsb25lIiwic2V0dGluZ3MiLCJEZXZpY2VTZXR0aW5ncyIsImlnbm9yZVVuaW1wb3J0YW50Vmlld3MiLCJib290c3RyYXBQb3J0IiwiY21kIiwiZm4iLCJ0b1BhaXJzIiwiY29tbWFuZHMiLCJwcm90b3R5cGUiLCJjcmVhdGVTZXNzaW9uIiwiY2FwcyIsInNlc3Npb25JZCIsInNlcnZlckRldGFpbHMiLCJwbGF0Zm9ybSIsIndlYlN0b3JhZ2VFbmFibGVkIiwidGFrZXNTY3JlZW5zaG90IiwiamF2YXNjcmlwdEVuYWJsZWQiLCJkYXRhYmFzZUVuYWJsZWQiLCJuZXR3b3JrQ29ubmVjdGlvbkVuYWJsZWQiLCJsb2NhdGlvbkNvbnRleHRFbmFibGVkIiwid2FybmluZ3MiLCJkZXNpcmVkIiwiT2JqZWN0IiwiYXNzaWduIiwiZGVmYXVsdE9wdHMiLCJ0bXBEaXIiLCJ0ZW1wRGlyIiwic3RhdGljRGlyIiwiZnVsbFJlc2V0Iiwic2RiUG9ydCIsIkRFRkFVTFRfU0RCX1BPUlQiLCJ0aXplbkluc3RhbGxUaW1lb3V0IiwiZGVmYXVsdHMiLCJub1Jlc2V0IiwiZmFzdFJlc2V0Iiwic2tpcFVuaW5zdGFsbCIsInVkaWQiLCJlbVBvcnQiLCJoZWxwZXJzIiwiZ2V0RGV2aWNlSW5mb0Zyb21DYXBzIiwic2RiIiwiY3JlYXRlU0RCIiwic3VwcHJlc3NLaWxsU2VydmVyIiwic3RhcnRUaXplblNlc3Npb24iLCJlIiwiZGVsZXRlU2Vzc2lvbiIsImlnbiIsImFwcE9uRGV2aWNlIiwiaXNQYWNrYWdlT3JCdW5kbGUiLCJhcHBQYWNrYWdlIiwiYXBwIiwiaW5zdGFsbEFwcCIsImlzQXBwSW5zdGFsbGVkIiwibG9nIiwiZXJyb3JBbmRUaHJvdyIsImlzU3RhcnRlZEFwcCIsImNsb3NlQXBwIiwic3RhcnRBcHAiLCJ0aW1lb3V0IiwiYm9vdHN0cmFwIiwiQm9vdHN0cmFwIiwic3RhcnQiLCJ1cGRhdGUiLCJjaGVja1BhY2thZ2VQcmVzZW50IiwiZGVidWciLCJzaGVsbCIsImZvcmNlU3RvcCIsInVuaW5zdGFsbCIsInNodXRkb3duIiwidmFsaWRhdGVEZXNpcmVkQ2FwcyIsInJlcyIsIm1zZyIsInByb3h5QWN0aXZlIiwiZ2V0UHJveHlBdm9pZExpc3QiLCJjYW5Qcm94eSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxjQUFjLEdBQUcsSUFBdkI7QUFDQSxNQUFNQyxRQUFRLEdBQUcsQ0FDZixDQUFDLE1BQUQsRUFBUyxJQUFJQyxNQUFKLENBQVcsd0JBQVgsQ0FBVCxDQURlLEVBRWYsQ0FBQyxLQUFELEVBQVEsSUFBSUEsTUFBSixDQUFXLHdCQUFYLENBQVIsQ0FGZSxDQUFqQjs7QUFLQSxNQUFNQyxXQUFOLFNBQTBCQyw0QkFBMUIsQ0FBcUM7QUFDbkNDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFBYUMsa0JBQWtCLEdBQUcsSUFBbEMsRUFBd0M7QUFDakQsVUFBTUQsSUFBTixFQUFZQyxrQkFBWjtBQUVBLFNBQUtDLGlCQUFMLEdBQXlCLENBQ3ZCLElBRHVCLEVBRXZCLGtCQUZ1QixFQUd2QixZQUh1QixFQUl2QixNQUp1QixDQUF6QjtBQU9BLFNBQUtDLHFCQUFMLEdBQTZCQyxvQkFBN0I7QUFDQSxTQUFLQyxjQUFMLEdBQXNCLEtBQXRCO0FBQ0EsU0FBS0MsYUFBTCxHQUFxQkMsZ0JBQUVDLEtBQUYsQ0FBUWIsUUFBUixD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QkFBTixDQUEwQjNELElBQTFCLENBQVY7O0FBQ0EsUUFBSSxDQUFDNEQsR0FBTCxFQUFVO0FBQUUsYUFBT0EsR0FBUDtBQUFhOztBQUV6QixRQUFJLENBQUM1RCxJQUFJLENBQUN1QyxVQUFWLEVBQXNCO0FBQ3BCLFVBQUlzQixHQUFHLEdBQUcscURBQVY7O0FBQ0FsQixzQkFBSUMsYUFBSixDQUFrQmlCLEdBQWxCO0FBQ0Q7QUFDRjs7QUFFREMsRUFBQUEsV0FBVyxDQUFFN0QsU0FBRixFQUFhO0FBQ3RCLFVBQU02RCxXQUFOLENBQWtCN0QsU0FBbEI7QUFFQSxXQUFPLEtBQUtmLGNBQVo7QUFDRDs7QUFFRDZFLEVBQUFBLGlCQUFpQixDQUFFOUQsU0FBRixFQUFhO0FBQzVCLFVBQU04RCxpQkFBTixDQUF3QjlELFNBQXhCO0FBRUEsV0FBTyxLQUFLZCxhQUFaO0FBQ0Q7O0FBRUQ2RSxFQUFBQSxRQUFRLENBQUUvRCxTQUFGLEVBQWE7QUFDbkIsVUFBTStELFFBQU4sQ0FBZS9ELFNBQWY7QUFFQSxXQUFPLEtBQVA7QUFDRDs7QUF0SmtDOzs7ZUEwSnRCdkIsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VEcml2ZXIsIERldmljZVNldHRpbmdzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBkZXNpcmVkQ29uc3RyYWludHMgZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuaW1wb3J0IGNvbW1hbmRzIGZyb20gJy4vY29tbWFuZHMvaW5kZXgnO1xuaW1wb3J0IGhlbHBlcnMgZnJvbSAnLi90aXplbi1oZWxwZXJzJztcbmltcG9ydCBCb290c3RyYXAgZnJvbSAnLi90aXplbi1ib290c3RyYXAuanMnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgREVGQVVMVF9TREJfUE9SVCB9IGZyb20gJ2FwcGl1bS1zZGInO1xuaW1wb3J0IHsgdGVtcERpciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuY29uc3QgQk9PVFNUUkFQX1BPUlQgPSA4ODg4O1xuY29uc3QgTk9fUFJPWFkgPSBbXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9hcHBpdW0nKV0sXG4gIFsnR0VUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL2FwcGl1bScpXSxcbl07XG5cbmNsYXNzIFRpemVuRHJpdmVyIGV4dGVuZHMgQmFzZURyaXZlciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30sIHNob3VsZFZhbGlkYXRlQ2FwcyA9IHRydWUpIHtcbiAgICBzdXBlcihvcHRzLCBzaG91bGRWYWxpZGF0ZUNhcHMpO1xuXG4gICAgdGhpcy5sb2NhdG9yU3RyYXRlZ2llcyA9IFtcbiAgICAgICdpZCcsXG4gICAgICAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgICAnY2xhc3MgbmFtZScsXG4gICAgICAnbmFtZSdcbiAgICBdO1xuXG4gICAgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMgPSBkZXNpcmVkQ29uc3RyYWludHM7XG4gICAgdGhpcy5qd3BQcm94eUFjdGl2ZSA9IGZhbHNlO1xuICAgIHRoaXMuandwUHJveHlBdm9pZCA9IF8uY2xvbmUoTk9fUFJPWFkpO1xuICAgIHRoaXMuc2V0dGluZ3MgPSBuZXcgRGV2aWNlU2V0dGluZ3Moe2lnbm9yZVVuaW1wb3J0YW50Vmlld3M6IGZhbHNlfSk7XG4gICAgdGhpcy5ib290c3RyYXBQb3J0ID0gQk9PVFNUUkFQX1BPUlQ7XG5cbiAgICBmb3IgKGxldCBbY21kLCBmbl0gb2YgXy50b1BhaXJzKGNvbW1hbmRzKSkge1xuICAgICAgVGl6ZW5Ecml2ZXIucHJvdG90eXBlW2NtZF0gPSBmbjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjcmVhdGVTZXNzaW9uIChjYXBzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBzZXNzaW9uSWQ7XG4gICAgICBbc2Vzc2lvbklkXSA9IGF3YWl0IHN1cGVyLmNyZWF0ZVNlc3Npb24oY2Fwcyk7XG5cbiAgICAgIGxldCBzZXJ2ZXJEZXRhaWxzID0ge3BsYXRmb3JtOiAnTElOVVgnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgd2ViU3RvcmFnZUVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFrZXNTY3JlZW5zaG90OiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGphdmFzY3JpcHRFbmFibGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YWJhc2VFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldHdvcmtDb25uZWN0aW9uRW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbkNvbnRleHRFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhcm5pbmdzOiB7fSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2lyZWQ6IHRoaXMuY2Fwc307XG4gICAgICB0aGlzLmNhcHMgPSBPYmplY3QuYXNzaWduKHNlcnZlckRldGFpbHMsIHRoaXMuY2Fwcyk7XG5cbiAgICAgIGxldCBkZWZhdWx0T3B0cyA9IHtcbiAgICAgICAgdG1wRGlyOiBhd2FpdCB0ZW1wRGlyLnN0YXRpY0RpcigpLFxuICAgICAgICBmdWxsUmVzZXQ6IGZhbHNlLFxuICAgICAgICBzZGJQb3J0OiBERUZBVUxUX1NEQl9QT1JULFxuICAgICAgICB0aXplbkluc3RhbGxUaW1lb3V0OiA1MDAwMFxuICAgICAgfTtcbiAgICAgIF8uZGVmYXVsdHModGhpcy5vcHRzLCBkZWZhdWx0T3B0cyk7XG5cbiAgICAgIGlmICh0aGlzLm9wdHMubm9SZXNldCA9PT0gdHJ1ZSkge1xuICAgICAgICB0aGlzLm9wdHMuZnVsbFJlc2V0ID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5vcHRzLmZ1bGxSZXNldCA9PT0gdHJ1ZSkge1xuICAgICAgICB0aGlzLm9wdHMubm9SZXNldCA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhpcy5vcHRzLmZhc3RSZXNldCA9ICF0aGlzLm9wdHMuZnVsbFJlc2V0ICYmICF0aGlzLm9wdHMubm9SZXNldDtcbiAgICAgIHRoaXMub3B0cy5za2lwVW5pbnN0YWxsID0gdGhpcy5vcHRzLmZhc3RSZXNldCB8fCB0aGlzLm9wdHMubm9SZXNldDtcblxuICAgICAgbGV0IHt1ZGlkLCBlbVBvcnR9ID0gYXdhaXQgaGVscGVycy5nZXREZXZpY2VJbmZvRnJvbUNhcHModGhpcy5vcHRzKTtcbiAgICAgIHRoaXMub3B0cy51ZGlkID0gdWRpZDtcbiAgICAgIHRoaXMub3B0cy5lbVBvcnQgPSBlbVBvcnQ7XG5cbiAgICAgIHRoaXMuc2RiID0gYXdhaXQgaGVscGVycy5jcmVhdGVTREIodGhpcy5vcHRzLnVkaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbVBvcnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5zZGJQb3J0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdHMuc3VwcHJlc3NLaWxsU2VydmVyKTtcblxuICAgICAgYXdhaXQgdGhpcy5zdGFydFRpemVuU2Vzc2lvbih0aGlzLm9wdHMpO1xuICAgICAgcmV0dXJuIFtzZXNzaW9uSWQsIHRoaXMuY2Fwc107XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5kZWxldGVTZXNzaW9uKCk7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIGdldCBhcHBPbkRldmljZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuaGVscGVycy5pc1BhY2thZ2VPckJ1bmRsZSh0aGlzLm9wdHMuYXBwUGFja2FnZSk7XG4gIH1cblxuICBhc3luYyBzdGFydFRpemVuU2Vzc2lvbiAoKSB7XG4gICAgaWYgKHRoaXMub3B0cy5hcHApIHtcbiAgICAgIGF3YWl0IHRoaXMuaW5zdGFsbEFwcCh0aGlzLm9wdHMuYXBwKTtcbiAgICB9XG4gICAgbGV0IGlzQXBwSW5zdGFsbGVkID0gYXdhaXQgdGhpcy5pc0FwcEluc3RhbGxlZCh0aGlzLm9wdHMuYXBwUGFja2FnZSk7XG4gICAgaWYgKCFpc0FwcEluc3RhbGxlZCkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ0NvdWxkIG5vdCBmaW5kIHRvIEFwcCBpbiBkZXZpY2UuJyk7XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdHMuYXBwUGFja2FnZSkge1xuICAgICAgbGV0IGlzU3RhcnRlZEFwcCA9IGF3YWl0IHRoaXMuaXNTdGFydGVkQXBwKCk7XG4gICAgICBpZiAoaXNTdGFydGVkQXBwKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY2xvc2VBcHAoKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IHRoaXMuc3RhcnRBcHAoeyB0aW1lb3V0OiAyMDAwMCB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmJvb3RzdHJhcCA9IG5ldyBCb290c3RyYXAodGhpcy5zZGIsIHRoaXMuYm9vdHN0cmFwUG9ydCwgdGhpcy5vcHRzKTtcbiAgICBhd2FpdCB0aGlzLmJvb3RzdHJhcC5zdGFydCh0aGlzLm9wdHMuYXBwUGFja2FnZSk7XG5cbiAgICBpZiAodGhpcy5vcHRzLmlnbm9yZVVuaW1wb3J0YW50Vmlld3MpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0dGluZ3MudXBkYXRlKHtpZ25vcmVVbmltcG9ydGFudFZpZXdzOiB0aGlzLm9wdHMuaWdub3JlVW5pbXBvcnRhbnRWaWV3c30pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNoZWNrUGFja2FnZVByZXNlbnQgKCkge1xuICAgIGxvZy5kZWJ1ZyhcIkNoZWNraW5nIHdoZXRoZXIgcGFja2FnZSBpcyBwcmVzZW50IG9uIHRoZSBkZXZpY2VcIik7XG4gICAgaWYgKCEoYXdhaXQgdGhpcy5zZGIuc2hlbGwoW2BhcHBfbGF1bmNoZXIgLS1saXN0IHwgZ3JlcCAke3RoaXMub3B0cy5hcHBQYWNrYWdlfWBdKSkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgZmluZCBwYWNrYWdlICR7dGhpcy5vcHRzLmFwcFBhY2thZ2V9IG9uIHRoZSBkZXZpY2VgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2cuZGVidWcoXCJTaHV0dGluZyBkb3duIFRpemVuIGRyaXZlclwiKTtcbiAgICBhd2FpdCBzdXBlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgaWYgKHRoaXMuYm9vdHN0cmFwKSB7XG4gICAgICBhd2FpdCB0aGlzLnNkYi5mb3JjZVN0b3AodGhpcy5vcHRzLmFwcFBhY2thZ2UpO1xuICAgICAgaWYgKHRoaXMub3B0cy5mdWxsUmVzZXQgJiYgIXRoaXMub3B0cy5za2lwVW5pbnN0YWxsICYmICF0aGlzLmFwcE9uRGV2aWNlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuc2RiLnVuaW5zdGFsbCh0aGlzLm9wdHMuYXBwUGFja2FnZSk7XG4gICAgICB9XG4gICAgICBhd2FpdCB0aGlzLmJvb3RzdHJhcC5zaHV0ZG93bigpO1xuICAgICAgdGhpcy5ib290c3RyYXAgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoXCJDYWxsZWQgZGVsZXRlU2Vzc2lvbiBidXQgYm9vdHN0cmFwIHdhc24ndCBhY3RpdmVcIik7XG4gICAgfVxuICB9XG5cbiAgdmFsaWRhdGVEZXNpcmVkQ2FwcyAoY2Fwcykge1xuICAgIGxldCByZXMgPSBzdXBlci52YWxpZGF0ZURlc2lyZWRDYXBzKGNhcHMpO1xuICAgIGlmICghcmVzKSB7IHJldHVybiByZXM7IH1cblxuICAgIGlmICghY2Fwcy5hcHBQYWNrYWdlKSB7XG4gICAgICBsZXQgbXNnID0gJ1RoZSBkZXNpcmVkIGNhcGFiaWxpdGllcyBtdXN0IGluY2x1ZGUgYW4gYXBwUGFja2FnZSc7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgIH1cbiAgfVxuXG4gIHByb3h5QWN0aXZlIChzZXNzaW9uSWQpIHtcbiAgICBzdXBlci5wcm94eUFjdGl2ZShzZXNzaW9uSWQpO1xuXG4gICAgcmV0dXJuIHRoaXMuandwUHJveHlBY3RpdmU7XG4gIH1cblxuICBnZXRQcm94eUF2b2lkTGlzdCAoc2Vzc2lvbklkKSB7XG4gICAgc3VwZXIuZ2V0UHJveHlBdm9pZExpc3Qoc2Vzc2lvbklkKTtcblxuICAgIHJldHVybiB0aGlzLmp3cFByb3h5QXZvaWQ7XG4gIH1cblxuICBjYW5Qcm94eSAoc2Vzc2lvbklkKSB7XG4gICAgc3VwZXIuY2FuUHJveHkoc2Vzc2lvbklkKTtcblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5leHBvcnQgeyBUaXplbkRyaXZlciB9O1xuZXhwb3J0IGRlZmF1bHQgVGl6ZW5Ecml2ZXI7XG4iXSwiZmlsZSI6ImxpYi9kcml2ZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
