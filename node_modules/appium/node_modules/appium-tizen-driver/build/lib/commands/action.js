"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _path = _interopRequireDefault(require("path"));

var _jimp = _interopRequireDefault(require("jimp"));

var _logger = _interopRequireDefault(require("../logger"));

const swipeStepsPerSec = 28;
let commands = {},
    extensions = {};
exports.commands = commands;

commands.flick = async function (element, xSpeed, ySpeed, xOffset, yOffset, speed) {
  if (element) {
    return await this.fakeFlickElement(element, xOffset, yOffset, speed);
  } else {
    return await this.fakeFlick(xSpeed, ySpeed);
  }
};

commands.fakeFlick = async function (xSpeed, ySpeed) {
  return await this.bootstrap.sendAction('element:flick', {
    xSpeed,
    ySpeed
  });
};

commands.fakeFlickElement = async function (elementId, xoffset, yoffset, speed) {
  let steps = 1250.0 / speed + 1;
  let xStart = 1;
  let yStart = 1;

  if (elementId === this.sessionId) {
    elementId = null;
  }

  if (elementId) {
    let location = await this.getLocationValueByElementId(elementId);
    xStart = location[0];
    yStart = location[1];
  }

  let xEnd = xStart + xoffset;
  let yEnd = yStart + yoffset;
  let params = [xStart, yStart, xEnd, yEnd, steps];
  return await this.doSwipe(params);
};

commands.swipe = async function (startX, startY, endX, endY, duration) {
  if (startX === 'null') {
    startX = 1;
  }

  if (startY === 'null') {
    startY = 1;
  }

  let swipeOpts = [startX, startY, endX, endY, Math.round(duration * swipeStepsPerSec)];
  return await this.doSwipe(swipeOpts);
};

commands.doSwipe = async function (swipeOpts) {
  return await this.bootstrap.sendAction("element:drag", swipeOpts);
};

commands.pullFile = async function (remotePath) {
  const rootDir = _path.default.resolve(__dirname, '..', '..');

  const filePath = _path.default.resolve(rootDir, 'file');

  let localFile = filePath + '/appiumfile.tmp';
  await this.sdb.pull(remotePath, localFile);
  let data = await _appiumSupport.fs.readFile(localFile);
  let b64data = new Buffer(data).toString('base64');

  if (await _appiumSupport.fs.exists(localFile)) {
    await _appiumSupport.fs.unlink(localFile);
  }

  return b64data;
};

commands.pushFile = async function (file, base64Data) {
  const rootDir = _path.default.resolve(__dirname, '..', '..', '..');

  const fileDir = _path.default.resolve(rootDir, 'app');

  const localFile = _path.default.resolve(fileDir, file);

  if (file.indexOf('/') > -1) {
    _logger.default.errorAndThrow(`It is expected that file point to a file and not to a folder. ` + `'${file}' is given instead`);
  }

  if (_lodash.default.isArray(base64Data)) {
    base64Data = Buffer.from(base64Data).toString('utf8');
  }

  const content = Buffer.from(base64Data, 'base64');
  let isFileDir = await _appiumSupport.fs.exists(fileDir);

  if (!isFileDir) {
    await _appiumSupport.fs.mkdir(fileDir);
  }

  await _appiumSupport.fs.writeFile(localFile, content.toString('binary'), 'binary');
  return true;
};

async function takeScreenShot(sdb) {
  return await sdb.takeScreenShot();
}

async function getScreenshotData(sdb) {
  const rootDir = _path.default.resolve(__dirname, '..', '..');

  const filePath = _path.default.resolve(rootDir, 'file');

  let localFile = filePath + '/screenShot.tmp';

  if (await _appiumSupport.fs.exists(localFile)) {
    await _appiumSupport.fs.unlink(localFile);
  }

  try {
    const pngDir = '/tmp/';

    const png = _path.default.posix.resolve(pngDir, 'dump_screen.png');

    await sdb.pull(png, localFile);
    return await _jimp.default.read(localFile);
  } finally {
    if (await _appiumSupport.fs.exists(localFile)) {
      await _appiumSupport.fs.unlink(localFile);
    }
  }
}

commands.getScreenshot = async function () {
  let result = await takeScreenShot(this.sdb);

  if (result) {
    let image = await getScreenshotData(this.sdb);

    const getBuffer = _bluebird.default.promisify(image.getBuffer, {
      context: image
    });

    const imgBuffer = await getBuffer(_jimp.default.MIME_PNG);
    return imgBuffer.toString('base64');
  } else {
    return null;
  }
};

Object.assign(extensions, commands);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hY3Rpb24uanMiXSwibmFtZXMiOlsic3dpcGVTdGVwc1BlclNlYyIsImNvbW1hbmRzIiwiZXh0ZW5zaW9ucyIsImZsaWNrIiwiZWxlbWVudCIsInhTcGVlZCIsInlTcGVlZCIsInhPZmZzZXQiLCJ5T2Zmc2V0Iiwic3BlZWQiLCJmYWtlRmxpY2tFbGVtZW50IiwiZmFrZUZsaWNrIiwiYm9vdHN0cmFwIiwic2VuZEFjdGlvbiIsImVsZW1lbnRJZCIsInhvZmZzZXQiLCJ5b2Zmc2V0Iiwic3RlcHMiLCJ4U3RhcnQiLCJ5U3RhcnQiLCJzZXNzaW9uSWQiLCJsb2NhdGlvbiIsImdldExvY2F0aW9uVmFsdWVCeUVsZW1lbnRJZCIsInhFbmQiLCJ5RW5kIiwicGFyYW1zIiwiZG9Td2lwZSIsInN3aXBlIiwic3RhcnRYIiwic3RhcnRZIiwiZW5kWCIsImVuZFkiLCJkdXJhdGlvbiIsInN3aXBlT3B0cyIsIk1hdGgiLCJyb3VuZCIsInB1bGxGaWxlIiwicmVtb3RlUGF0aCIsInJvb3REaXIiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsImZpbGVQYXRoIiwibG9jYWxGaWxlIiwic2RiIiwicHVsbCIsImRhdGEiLCJmcyIsInJlYWRGaWxlIiwiYjY0ZGF0YSIsIkJ1ZmZlciIsInRvU3RyaW5nIiwiZXhpc3RzIiwidW5saW5rIiwicHVzaEZpbGUiLCJmaWxlIiwiYmFzZTY0RGF0YSIsImZpbGVEaXIiLCJpbmRleE9mIiwibG9nIiwiZXJyb3JBbmRUaHJvdyIsIl8iLCJpc0FycmF5IiwiZnJvbSIsImNvbnRlbnQiLCJpc0ZpbGVEaXIiLCJta2RpciIsIndyaXRlRmlsZSIsInRha2VTY3JlZW5TaG90IiwiZ2V0U2NyZWVuc2hvdERhdGEiLCJwbmdEaXIiLCJwbmciLCJwb3NpeCIsImppbXAiLCJyZWFkIiwiZ2V0U2NyZWVuc2hvdCIsInJlc3VsdCIsImltYWdlIiwiZ2V0QnVmZmVyIiwiQiIsInByb21pc2lmeSIsImNvbnRleHQiLCJpbWdC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fSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgamltcCBmcm9tICdqaW1wJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcblxuY29uc3Qgc3dpcGVTdGVwc1BlclNlYyA9IDI4O1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5mbGljayA9IGFzeW5jIGZ1bmN0aW9uIChlbGVtZW50LCB4U3BlZWQsIHlTcGVlZCwgeE9mZnNldCwgeU9mZnNldCwgc3BlZWQpIHtcbiAgaWYgKGVsZW1lbnQpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5mYWtlRmxpY2tFbGVtZW50KGVsZW1lbnQsIHhPZmZzZXQsIHlPZmZzZXQsIHNwZWVkKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5mYWtlRmxpY2soeFNwZWVkLCB5U3BlZWQpO1xuICB9XG59O1xuXG5jb21tYW5kcy5mYWtlRmxpY2sgPSBhc3luYyBmdW5jdGlvbiAoeFNwZWVkLCB5U3BlZWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuYm9vdHN0cmFwLnNlbmRBY3Rpb24oJ2VsZW1lbnQ6ZmxpY2snLCB7IHhTcGVlZCwgeVNwZWVkIH0pO1xufTtcblxuY29tbWFuZHMuZmFrZUZsaWNrRWxlbWVudCA9IGFzeW5jIGZ1bmN0aW9uIChlbGVtZW50SWQsIHhvZmZzZXQsIHlvZmZzZXQsIHNwZWVkKSB7XG4gIGxldCBzdGVwcyA9IDEyNTAuMCAvIHNwZWVkICsgMTtcblxuICBsZXQgeFN0YXJ0ID0gMTtcbiAgbGV0IHlTdGFydCA9IDE7XG5cbiAgaWYgKGVsZW1lbnRJZCA9PT0gdGhpcy5zZXNzaW9uSWQpIHtcbiAgICBlbGVtZW50SWQgPSBudWxsO1xuICB9XG4gIGlmIChlbGVtZW50SWQpIHtcbiAgICBsZXQgbG9jYXRpb24gPSBhd2FpdCB0aGlzLmdldExvY2F0aW9uVmFsdWVCeUVsZW1lbnRJZChlbGVtZW50SWQpO1xuICAgIHhTdGFydCA9IGxvY2F0aW9uWzBdO1xuICAgIHlTdGFydCA9IGxvY2F0aW9uWzFdO1xuICB9XG5cbiAgbGV0IHhFbmQgPSB4U3RhcnQgKyB4b2Zmc2V0O1xuICBsZXQgeUVuZCA9IHlTdGFydCArIHlvZmZzZXQ7XG5cbiAgbGV0IHBhcmFtcyA9IFt4U3RhcnQsIHlTdGFydCwgeEVuZCwgeUVuZCwgc3RlcHNdO1xuXG4gIHJldHVybiBhd2FpdCB0aGlzLmRvU3dpcGUocGFyYW1zKTtcbn07XG5cbmNvbW1hbmRzLnN3aXBlID0gYXN5bmMgZnVuY3Rpb24gKHN0YXJ0WCwgc3RhcnRZLCBlbmRYLCBlbmRZLCBkdXJhdGlvbikge1xuICBpZiAoc3RhcnRYID09PSAnbnVsbCcpIHtcbiAgICBzdGFydFggPSAxO1xuICB9XG4gIGlmIChzdGFydFkgPT09ICdudWxsJykge1xuICAgIHN0YXJ0WSA9IDE7XG4gIH1cbiAgbGV0IHN3aXBlT3B0cyA9IFtcbiAgICBzdGFydFgsIHN0YXJ0WSwgZW5kWCwgZW5kWSxcbiAgICBNYXRoLnJvdW5kKGR1cmF0aW9uICogc3dpcGVTdGVwc1BlclNlYylcbiAgXTtcblxuICByZXR1cm4gYXdhaXQgdGhpcy5kb1N3aXBlKHN3aXBlT3B0cyk7XG59O1xuXG5jb21tYW5kcy5kb1N3aXBlID0gYXN5bmMgZnVuY3Rpb24gKHN3aXBlT3B0cykge1xuICByZXR1cm4gYXdhaXQgdGhpcy5ib290c3RyYXAuc2VuZEFjdGlvbihcImVsZW1lbnQ6ZHJhZ1wiLCBzd2lwZU9wdHMpO1xufTtcblxuY29tbWFuZHMucHVsbEZpbGUgPSBhc3luYyBmdW5jdGlvbiAocmVtb3RlUGF0aCkge1xuICBjb25zdCByb290RGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJyk7XG4gIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHJvb3REaXIsICdmaWxlJyk7XG4gIGxldCBsb2NhbEZpbGUgPSBmaWxlUGF0aCArICcvYXBwaXVtZmlsZS50bXAnO1xuICBhd2FpdCB0aGlzLnNkYi5wdWxsKHJlbW90ZVBhdGgsIGxvY2FsRmlsZSk7XG4gIGxldCBkYXRhID0gYXdhaXQgZnMucmVhZEZpbGUobG9jYWxGaWxlKTtcbiAgbGV0IGI2NGRhdGEgPSBuZXcgQnVmZmVyKGRhdGEpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhsb2NhbEZpbGUpKSB7XG4gICAgYXdhaXQgZnMudW5saW5rKGxvY2FsRmlsZSk7XG4gIH1cbiAgcmV0dXJuIGI2NGRhdGE7XG59O1xuXG5jb21tYW5kcy5wdXNoRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIChmaWxlLCBiYXNlNjREYXRhKSB7XG4gIGNvbnN0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLi4nKTtcbiAgY29uc3QgZmlsZURpciA9IHBhdGgucmVzb2x2ZShyb290RGlyLCAnYXBwJyk7XG4gIGNvbnN0IGxvY2FsRmlsZSA9IHBhdGgucmVzb2x2ZShmaWxlRGlyLCBmaWxlKTtcbiAgaWYgKGZpbGUuaW5kZXhPZignLycpID4gLTEpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgSXQgaXMgZXhwZWN0ZWQgdGhhdCBmaWxlIHBvaW50IHRvIGEgZmlsZSBhbmQgbm90IHRvIGEgZm9sZGVyLiBgICsgYCcke2ZpbGV9JyBpcyBnaXZlbiBpbnN0ZWFkYCk7XG4gIH1cblxuICBpZiAoXy5pc0FycmF5KGJhc2U2NERhdGEpKSB7XG4gICAgYmFzZTY0RGF0YSA9IEJ1ZmZlci5mcm9tKGJhc2U2NERhdGEpLnRvU3RyaW5nKCd1dGY4Jyk7XG4gIH1cblxuICBjb25zdCBjb250ZW50ID0gQnVmZmVyLmZyb20oYmFzZTY0RGF0YSwgJ2Jhc2U2NCcpO1xuICBsZXQgaXNGaWxlRGlyID0gYXdhaXQgZnMuZXhpc3RzKGZpbGVEaXIpO1xuICBpZiAoIWlzRmlsZURpcikge1xuICAgIGF3YWl0IGZzLm1rZGlyKGZpbGVEaXIpO1xuICB9XG5cbiAgYXdhaXQgZnMud3JpdGVGaWxlKGxvY2FsRmlsZSwgY29udGVudC50b1N0cmluZygnYmluYXJ5JyksICdiaW5hcnknKTtcblxuICByZXR1cm4gdHJ1ZTtcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIHRha2VTY3JlZW5TaG90IChzZGIpIHtcbiAgcmV0dXJuIGF3YWl0IHNkYi50YWtlU2NyZWVuU2hvdCgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTY3JlZW5zaG90RGF0YSAoc2RiKSB7XG4gIGNvbnN0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nKTtcbiAgY29uc3QgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUocm9vdERpciwgJ2ZpbGUnKTtcbiAgbGV0IGxvY2FsRmlsZSA9IGZpbGVQYXRoICsgJy9zY3JlZW5TaG90LnRtcCc7XG4gIGlmIChhd2FpdCBmcy5leGlzdHMobG9jYWxGaWxlKSkge1xuICAgIGF3YWl0IGZzLnVubGluayhsb2NhbEZpbGUpO1xuICB9XG4gIHRyeSB7XG4gICAgY29uc3QgcG5nRGlyID0gJy90bXAvJztcbiAgICBjb25zdCBwbmcgPSBwYXRoLnBvc2l4LnJlc29sdmUocG5nRGlyLCAnZHVtcF9zY3JlZW4ucG5nJyk7XG4gICAgYXdhaXQgc2RiLnB1bGwocG5nLCBsb2NhbEZpbGUpO1xuICAgIHJldHVybiBhd2FpdCBqaW1wLnJlYWQobG9jYWxGaWxlKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKGxvY2FsRmlsZSkpIHtcbiAgICAgIGF3YWl0IGZzLnVubGluayhsb2NhbEZpbGUpO1xuICAgIH1cbiAgfVxufVxuXG5jb21tYW5kcy5nZXRTY3JlZW5zaG90ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgcmVzdWx0ID0gYXdhaXQgdGFrZVNjcmVlblNob3QodGhpcy5zZGIpO1xuXG4gIGlmIChyZXN1bHQpIHtcbiAgICBsZXQgaW1hZ2UgPSBhd2FpdCBnZXRTY3JlZW5zaG90RGF0YSh0aGlzLnNkYik7XG4gICAgY29uc3QgZ2V0QnVmZmVyID0gQi5wcm9taXNpZnkoaW1hZ2UuZ2V0QnVmZmVyLCB7IGNvbnRleHQ6IGltYWdlIH0pO1xuICAgIGNvbnN0IGltZ0J1ZmZlciA9IGF3YWl0IGdldEJ1ZmZlcihqaW1wLk1JTUVfUE5HKTtcbiAgICByZXR1cm4gaW1nQnVmZmVyLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcyk7XG5leHBvcnQgeyBjb21tYW5kcyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2FjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
