"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.COMMAND_TYPES = exports.TizenBootstrap = void 0;

require("source-map-support/register");

var _net = _interopRequireDefault(require("net"));

var _lodash = _interopRequireDefault(require("lodash"));

var _index = _interopRequireDefault(require("./commands/index"));

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("./logger"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const COMMAND_TYPES = {
  ACTION: 'action',
  SHUTDOWN: 'shutdown'
};
exports.COMMAND_TYPES = COMMAND_TYPES;

class TizenBootstrap {
  constructor(sdb, systemPort = 8888, opts = {}) {
    this.appPackage;
    this.sdb = sdb;
    this.systemPort = systemPort;
    this.opts = opts;
    this.webSocket = opts.webSocket;
    this.ignoreUnexpectedShutdown = false;
    this.uiautomator = 'org.tizen.uiautomator';
    this.uiautomatorVersion = '1.0.0';
    this.isRestart = false;

    for (let [cmd, fn] of _lodash.default.toPairs(_index.default)) {
      TizenBootstrap.prototype[cmd] = fn;
    }
  }

  async start(appPackage) {
    this.appPackage = appPackage;
    await this.init();
    await this.sdb.forwardPort(this.systemPort, 8888);
    await (0, _asyncbox.sleep)(6000);
    return await this.connectSocket();
  }

  async connectSocket() {
    try {
      return await new _bluebird.default((resolve, reject) => {
        try {
          if (!this.socketClient) {
            this.socketClient = _net.default.connect(this.systemPort);
            this.socketClient.setEncoding('utf8');
            this.socketClient.on('error', err => {
              if (!this.ignoreUnexpectedShutdown) {
                throw new Error(`Tizen bootstrap socket crashed: ${err}`);
              }
            });
            this.socketClient.once('connect', () => {
              _logger.default.info("Tizen bootstrap socket is now connected");

              resolve();
            });
          } else {
            _logger.default.info("SocketClient already Created");

            resolve();
          }
        } catch (err) {
          reject(err);
        }
      });
    } catch (err) {
      _logger.default.errorAndThrow(`Error occured while reconnection TizenBootstrap. Original error: ${err}`);
    }
  }

  async sendCommand(type, extra = {}) {
    if (this.appPackage && type !== COMMAND_TYPES.SHUTDOWN) {
      if (this.isRestart) {
        await (0, _asyncbox.sleep)(5000);
        await this.restartUIAutomator();
        this.isRestart = false;
      }

      let isStartedApp = await this.sdb.isStartedApp(this.appPackage);

      if (!isStartedApp) {
        await this.sdb.startApp(this.appPackage);
        await (0, _asyncbox.sleep)(10000);
        this.isRestart = false;
      }
    }

    if (!this.socketClient) {
      await this.connectSocket();
    }

    return await new _bluebird.default((resolve, reject) => {
      let cmd = Object.assign({
        cmd: type
      }, extra);
      let cmdJson = `${JSON.stringify(cmd)} \n`;

      _logger.default.debug(`Sending command to tizen: ${_lodash.default.truncate(cmdJson, {
        length: 1000
      }).trim()}`);

      try {
        this.socketClient.removeAllListeners('timeout');
        this.socketClient.removeAllListeners('end');
        this.socketClient.write(cmdJson);
        this.socketClient.on('data', data => {
          let streamData = '';

          _logger.default.debug(`Received command result from bootstrap : ${data}`);

          try {
            streamData = JSON.parse(streamData + data);
            this.socketClient.removeAllListeners('data');

            if (streamData.status === 0) {
              resolve(streamData.value);
            } else if (streamData.status === 44) {
              this.restartUIAutomator();
              resolve(false);
            }

            reject((0, _appiumBaseDriver.errorFromCode)(streamData.status));
          } catch (ign) {
            _logger.default.debug("Stream still not complete, waiting");

            streamData += data;
          }
        });
        this.socketClient.setTimeout(15000);
        this.socketClient.on('timeout', () => {
          this.socketClient.destroy();
          this.socketClient = null;
          this.isRestart = true;
          reject((0, _appiumBaseDriver.errorFromCode)(-1, "No response from Server"));
        });
        this.socketClient.on('end', () => {
          this.socketClient.destroy();
          this.socketClient = null;
          this.isRestart = true;
          reject((0, _appiumBaseDriver.errorFromCode)(-1, "Socket ended by Server"));
        });
      } catch (err) {
        reject((0, _appiumBaseDriver.errorFromCode)(-1, err));
      }
    });
  }

  async sendAction(action, params = {}) {
    let extra = {
      action,
      params
    };
    return await this.sendCommand(COMMAND_TYPES.ACTION, extra);
  }

  async shutdown() {
    if (this.socketClient) {
      this.socketClient.end();
      this.socketClient.destroy();
      this.socketClient = null;
    }

    await this.stopUIAutomator();
    await this.uninstallUIAutomator();
    await this.sdb.removePortForward(this.systemPort);
  }

  async init() {
    let isUIAutomatorInstalled = await this.isAppInstalled(this.uiautomator);

    if (!isUIAutomatorInstalled) {
      await this.installUIAutomator();
    }

    let uiautomatorStatus = await this.isStartedUIAutomator();

    if (!uiautomatorStatus) {
      await this.startUIAutomator();
    } else {
      await this.stopUIAutomator();
      await (0, _asyncbox.sleep)(2000);
      await this.startUIAutomator();
    }
  }

  async installUIAutomator() {
    let arch = await this.sdb.shell('uname -a');

    let rootDir = _path.default.resolve(__dirname, '..', '..');

    let tpkPath = _path.default.resolve(rootDir, 'uiautomator', `${this.uiautomator}-${this.uiautomatorVersion}`);

    if (arch.includes('i686')) {
      tpkPath += '-x86';
    } else {
      tpkPath += '-arm';
    }

    tpkPath += '.tpk';
    return await this.sdb.install(tpkPath);
  }

  async uninstallUIAutomator() {
    return await this.removeApp(this.uiautomator);
  }

  async startUIAutomator() {
    await this.sdb.startApp(this.uiautomator);
  }

  async stopUIAutomator() {
    await this.sdb.shell(`app_launcher -t ${this.uiautomator}`);
  }

  async restartUIAutomator() {
    await this.stopUIAutomator();
    await this.startUIAutomator();
  }

  async isStartedUIAutomator() {
    return await this.sdb.isStartedApp(this.uiautomator);
  }

  set ignoreUnexpectedShutdown(ignore) {
    _logger.default.debug(`${ignore ? 'Ignoring' : 'Watching for'} bootstrap disconnect`);

    this._ignoreUnexpectedShutdown = ignore;
  }

  get ignoreUnexpectedShutdown() {
    return this._ignoreUnexpectedShutdown;
  }

}

exports.TizenBootstrap = TizenBootstrap;
var _default = TizenBootstrap;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90aXplbi1ib290c3RyYXAuanMiXSwibmFtZXMiOlsiQ09NTUFORF9UWVBFUyIsIkFDVElPTiIsIlNIVVRET1dOIiwiVGl6ZW5Cb290c3RyYXAiLCJjb25zdHJ1Y3RvciIsInNkYiIsInN5c3RlbVBvcnQiLCJvcHRzIiwiYXBwUGFja2FnZSIsIndlYlNvY2tldCIsImlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biIsInVpYXV0b21hdG9yIiwidWlhdXRvbWF0b3JWZXJzaW9uIiwiaXNSZXN0YXJ0IiwiY21kIiwiZm4iLCJfIiwidG9QYWlycyIsImNvbW1hbmRzIiwicHJvdG90eXBlIiwic3RhcnQiLCJpbml0IiwiZm9yd2FyZFBvcnQiLCJjb25uZWN0U29ja2V0IiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJzb2NrZXRDbGllbnQiLCJuZXQiLCJjb25uZWN0Iiwic2V0RW5jb2RpbmciLCJvbiIsImVyciIsIkVycm9yIiwib25jZSIsImxvZyIsImluZm8iLCJlcnJvckFuZFRocm93Iiwic2VuZENvbW1hbmQiLCJ0eXBlIiwiZXh0cmEiLCJyZXN0YXJ0VUlBdXRvbWF0b3IiLCJpc1N0YXJ0ZWRBcHAiLCJzdGFydEFwcCIsIk9iamVjdCIsImFzc2lnbiIsImNtZEpzb24iLCJKU09OIiwic3RyaW5naWZ5IiwiZGVidWciLCJ0cnVuY2F0ZSIsImxlbmd0aCIsInRyaW0iLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJ3cml0ZSIsImRhdGEiLCJzdHJlYW1EYXRhIiwicGFyc2UiLCJzdGF0dXMiLCJ2YWx1ZSIsImlnbiIsInNldFRpbWVvdXQiLCJkZXN0cm95Iiwic2VuZEFjdGlvbiIsImFjdGlvbiIsInBhcmFtcyIsInNodXRkb3duIiwiZW5kIiwic3RvcFVJQXV0b21hdG9yIiwidW5pbnN0YWxsVUlBdXRvbWF0b3IiLCJyZW1vdmVQb3J0Rm9yd2FyZCIsImlzVUlBdXRvbWF0b3JJbnN0YWxsZWQiLCJpc0FwcEluc3RhbGxlZCIsImluc3RhbGxVSUF1dG9tYXRvciIsInVpYXV0b21hdG9yU3RhdHVzIiwiaXNTdGFydGVkVUlBdXRvbWF0b3IiLCJzdGFydFVJQXV0b21hdG9yIiwiYXJjaCIsInNoZWxsIiwicm9vdERpciIsInBhdGgiLCJfX2Rpcm5hbWUiLCJ0cGtQYXRoIiwiaW5jbHVkZXMiLCJpbnN0YWxsIiwicmVtb3ZlQXBwIiwiaWdub3JlIiwiX2lnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxhQUFhLEdBQUc7QUFDcEJDLEVBQUFBLE1BQU0sRUFBRSxRQURZO0FBRXBCQyxFQUFBQSxRQUFRLEVBQUU7QUFGVSxDQUF0Qjs7O0FBS0EsTUFBTUMsY0FBTixDQUFxQjtBQUNuQkMsRUFBQUEsV0FBVyxDQUFFQyxHQUFGLEVBQU9DLFVBQVUsR0FBRyxJQUFwQixFQUEwQkMsSUFBSSxHQUFHLEVBQWpDLEVBQXFDO0FBQzlDLFNBQUtDLFVBQUw7QUFDQSxTQUFLSCxHQUFMLEdBQVdBLEdBQVg7QUFDQSxTQUFLQyxVQUFMLEdBQWtCQSxVQUFsQjtBQUNBLFNBQUtDLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtFLFNBQUwsR0FBaUJGLElBQUksQ0FBQ0UsU0FBdEI7QUFDQSxTQUFLQyx3QkFBTCxHQUFnQyxLQUFoQztBQUNBLFNBQUtDLFdBQUwsR0FBbUIsdUJBQW5CO0FBQ0EsU0FBS0Msa0JBQUwsR0FBMEIsT0FBMUI7QUFDQSxTQUFLQyxTQUFMLEdBQWlCLEtBQWpCOztBQUVBLFNBQUssSUFBSSxDQUFDQyxHQUFELEVBQU1DLEVBQU4sQ0FBVCxJQUFzQkMsZ0JBQUVDLE9BQUYsQ0FBVUMsY0FBVixDQUF0QixFQUEyQztBQUN6Q2YsTUFBQUEsY0FBYyxDQUFDZ0IsU0FBZixDQUF5QkwsR0FBekIsSUFBZ0NDLEVBQWhDO0FBQ0Q7QUFDRjs7QUFFRCxRQUFNSyxLQUFOLENBQWFaLFVBQWIsRUFBeUI7QUFDdkIsU0FBS0EsVUFB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b0JBQU4sR0FBOEI7QUFDNUIsV0FBTyxNQUFNLEtBQUtnQixTQUFMLENBQWUsS0FBSzFFLFdBQXBCLENBQWI7QUFDRDs7QUFFRCxRQUFNaUUsZ0JBQU4sR0FBMEI7QUFDeEIsVUFBTSxLQUFLdkUsR0FBTCxDQUFTc0MsUUFBVCxDQUFrQixLQUFLaEMsV0FBdkIsQ0FBTjtBQUNEOztBQUVELFFBQU15RCxlQUFOLEdBQXlCO0FBQ3ZCLFVBQU0sS0FBSy9ELEdBQUwsQ0FBU3lFLEtBQVQsQ0FBZ0IsbUJBQWtCLEtBQUtuRSxXQUFZLEVBQW5ELENBQU47QUFDRDs7QUFFRCxRQUFNOEIsa0JBQU4sR0FBNEI7QUFDMUIsVUFBTSxLQUFLMkIsZUFBTCxFQUFOO0FBQ0EsVUFBTSxLQUFLUSxnQkFBTCxFQUFOO0FBQ0Q7O0FBRUQsUUFBTUQsb0JBQU4sR0FBOEI7QUFDNUIsV0FBTyxNQUFNLEtBQUt0RSxHQUFMLENBQVNxQyxZQUFULENBQXNCLEtBQUsvQixXQUEzQixDQUFiO0FBQ0Q7O0FBRUQsTUFBSUQsd0JBQUosQ0FBOEI0RSxNQUE5QixFQUFzQztBQUNwQ25ELG9CQUFJYyxLQUFKLENBQVcsR0FBRXFDLE1BQU0sR0FBRyxVQUFILEdBQWdCLGNBQWUsdUJBQWxEOztBQUNBLFNBQUtDLHlCQUFMLEdBQWlDRCxNQUFqQztBQUNEOztBQUVELE1BQUk1RSx3QkFBSixHQUFnQztBQUM5QixXQUFPLEtBQUs2RSx5QkFBWjtBQUNEOztBQXRNa0I7OztlQTBNTnBGLGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGNvbW1hbmRzIGZyb20gJy4vY29tbWFuZHMvaW5kZXgnO1xuaW1wb3J0IHsgZXJyb3JGcm9tQ29kZSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBzbGVlcCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cblxuY29uc3QgQ09NTUFORF9UWVBFUyA9IHtcbiAgQUNUSU9OOiAnYWN0aW9uJyxcbiAgU0hVVERPV046ICdzaHV0ZG93bidcbn07XG5cbmNsYXNzIFRpemVuQm9vdHN0cmFwIHtcbiAgY29uc3RydWN0b3IgKHNkYiwgc3lzdGVtUG9ydCA9IDg4ODgsIG9wdHMgPSB7fSkge1xuICAgIHRoaXMuYXBwUGFja2FnZTtcbiAgICB0aGlzLnNkYiA9IHNkYjtcbiAgICB0aGlzLnN5c3RlbVBvcnQgPSBzeXN0ZW1Qb3J0O1xuICAgIHRoaXMub3B0cyA9IG9wdHM7XG4gICAgdGhpcy53ZWJTb2NrZXQgPSBvcHRzLndlYlNvY2tldDtcbiAgICB0aGlzLmlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biA9IGZhbHNlO1xuICAgIHRoaXMudWlhdXRvbWF0b3IgPSAnb3JnLnRpemVuLnVpYXV0b21hdG9yJztcbiAgICB0aGlzLnVpYXV0b21hdG9yVmVyc2lvbiA9ICcxLjAuMCc7XG4gICAgdGhpcy5pc1Jlc3RhcnQgPSBmYWxzZTtcblxuICAgIGZvciAobGV0IFtjbWQsIGZuXSBvZiBfLnRvUGFpcnMoY29tbWFuZHMpKSB7XG4gICAgICBUaXplbkJvb3RzdHJhcC5wcm90b3R5cGVbY21kXSA9IGZuO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0YXJ0IChhcHBQYWNrYWdlKSB7XG4gICAgdGhpcy5hcHBQYWNrYWdlID0gYXBwUGFja2FnZTtcbiAgICBhd2FpdCB0aGlzLmluaXQoKTtcbiAgICBhd2FpdCB0aGlzLnNkYi5mb3J3YXJkUG9ydCh0aGlzLnN5c3RlbVBvcnQsIDg4ODgpO1xuICAgIGF3YWl0IHNsZWVwKDYwMDApO1xuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuY29ubmVjdFNvY2tldCgpO1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdFNvY2tldCAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgaWYgKCF0aGlzLnNvY2tldENsaWVudCkge1xuICAgICAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQgPSBuZXQuY29ubmVjdCh0aGlzLnN5c3RlbVBvcnQpO1xuICAgICAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50Lm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgaWYgKCF0aGlzLmlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93bikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVGl6ZW4gYm9vdHN0cmFwIHNvY2tldCBjcmFzaGVkOiAke2Vycn1gKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5vbmNlKCdjb25uZWN0JywgKCkgPT4ge1xuICAgICAgICAgICAgICBsb2cuaW5mbyhcIlRpemVuIGJvb3RzdHJhcCBzb2NrZXQgaXMgbm93IGNvbm5lY3RlZFwiKTtcbiAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKFwiU29ja2V0Q2xpZW50IGFscmVhZHkgQ3JlYXRlZFwiKTtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBFcnJvciBvY2N1cmVkIHdoaWxlIHJlY29ubmVjdGlvbiBUaXplbkJvb3RzdHJhcC4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNlbmRDb21tYW5kICh0eXBlLCBleHRyYSA9IHt9KSB7XG4gICAgaWYgKHRoaXMuYXBwUGFja2FnZSAmJiB0eXBlICE9PSBDT01NQU5EX1RZUEVTLlNIVVRET1dOKSB7XG4gICAgICBpZiAodGhpcy5pc1Jlc3RhcnQpIHtcbiAgICAgICAgYXdhaXQgc2xlZXAoNTAwMCk7XG4gICAgICAgIGF3YWl0IHRoaXMucmVzdGFydFVJQXV0b21hdG9yKCk7XG4gICAgICAgIHRoaXMuaXNSZXN0YXJ0ID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBsZXQgaXNTdGFydGVkQXBwID0gYXdhaXQgdGhpcy5zZGIuaXNTdGFydGVkQXBwKHRoaXMuYXBwUGFja2FnZSk7XG4gICAgICBpZiAoIWlzU3RhcnRlZEFwcCkge1xuICAgICAgICBhd2FpdCB0aGlzLnNkYi5zdGFydEFwcCh0aGlzLmFwcFBhY2thZ2UpO1xuICAgICAgICBhd2FpdCBzbGVlcCgxMDAwMCk7XG4gICAgICAgIHRoaXMuaXNSZXN0YXJ0ID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnNvY2tldENsaWVudCkge1xuICAgICAgYXdhaXQgdGhpcy5jb25uZWN0U29ja2V0KCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxldCBjbWQgPSBPYmplY3QuYXNzaWduKHsgY21kOiB0eXBlIH0sIGV4dHJhKTtcbiAgICAgIGxldCBjbWRKc29uID0gYCR7SlNPTi5zdHJpbmdpZnkoY21kKX0gXFxuYDtcbiAgICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyBjb21tYW5kIHRvIHRpemVuOiAke18udHJ1bmNhdGUoY21kSnNvbiwgeyBsZW5ndGg6IDEwMDAgfSkudHJpbSgpfWApO1xuXG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLnNvY2tldENsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3RpbWVvdXQnKTtcbiAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQucmVtb3ZlQWxsTGlzdGVuZXJzKCdlbmQnKTtcbiAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQud3JpdGUoY21kSnNvbik7XG4gICAgICAgIHRoaXMuc29ja2V0Q2xpZW50Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgICBsZXQgc3RyZWFtRGF0YSA9ICcnO1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgY29tbWFuZCByZXN1bHQgZnJvbSBib290c3RyYXAgOiAke2RhdGF9YCk7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHN0cmVhbURhdGEgPSBKU09OLnBhcnNlKHN0cmVhbURhdGEgKyBkYXRhKTtcbiAgICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygnZGF0YScpO1xuICAgICAgICAgICAgaWYgKHN0cmVhbURhdGEuc3RhdHVzID09PSAwKSB7XG4gICAgICAgICAgICAgIHJlc29sdmUoc3RyZWFtRGF0YS52YWx1ZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbURhdGEuc3RhdHVzID09PSA0NCkge1xuICAgICAgICAgICAgICB0aGlzLnJlc3RhcnRVSUF1dG9tYXRvcigpO1xuICAgICAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlamVjdChlcnJvckZyb21Db2RlKHN0cmVhbURhdGEuc3RhdHVzKSk7XG4gICAgICAgICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoXCJTdHJlYW0gc3RpbGwgbm90IGNvbXBsZXRlLCB3YWl0aW5nXCIpO1xuICAgICAgICAgICAgc3RyZWFtRGF0YSArPSBkYXRhO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc29ja2V0Q2xpZW50LnNldFRpbWVvdXQoMTUwMDApO1xuICAgICAgICB0aGlzLnNvY2tldENsaWVudC5vbigndGltZW91dCcsICgpID0+IHtcbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5kZXN0cm95KCk7XG4gICAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQgPSBudWxsO1xuICAgICAgICAgIHRoaXMuaXNSZXN0YXJ0ID0gdHJ1ZTtcbiAgICAgICAgICByZWplY3QoZXJyb3JGcm9tQ29kZSgtMSwgXCJObyByZXNwb25zZSBmcm9tIFNlcnZlclwiKSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNvY2tldENsaWVudC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50LmRlc3Ryb3koKTtcbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudCA9IG51bGw7XG4gICAgICAgICAgdGhpcy5pc1Jlc3RhcnQgPSB0cnVlO1xuICAgICAgICAgIHJlamVjdChlcnJvckZyb21Db2RlKC0xLCBcIlNvY2tldCBlbmRlZCBieSBTZXJ2ZXJcIikpO1xuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZWplY3QoZXJyb3JGcm9tQ29kZSgtMSwgZXJyKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBzZW5kQWN0aW9uIChhY3Rpb24sIHBhcmFtcyA9IHt9KSB7XG4gICAgbGV0IGV4dHJhID0geyBhY3Rpb24sIHBhcmFtcyB9O1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRDb21tYW5kKENPTU1BTkRfVFlQRVMuQUNUSU9OLCBleHRyYSk7XG4gIH1cblxuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgaWYgKHRoaXMuc29ja2V0Q2xpZW50KSB7XG4gICAgICB0aGlzLnNvY2tldENsaWVudC5lbmQoKTtcbiAgICAgIHRoaXMuc29ja2V0Q2xpZW50LmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuc29ja2V0Q2xpZW50ID0gbnVsbDtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnN0b3BVSUF1dG9tYXRvcigpO1xuICAgIGF3YWl0IHRoaXMudW5pbnN0YWxsVUlBdXRvbWF0b3IoKTtcblxuICAgIGF3YWl0IHRoaXMuc2RiLnJlbW92ZVBvcnRGb3J3YXJkKHRoaXMuc3lzdGVtUG9ydCk7XG4gIH1cblxuICBhc3luYyBpbml0ICgpIHtcblxuICAgIGxldCBpc1VJQXV0b21hdG9ySW5zdGFsbGVkID0gYXdhaXQgdGhpcy5pc0FwcEluc3RhbGxlZCh0aGlzLnVpYXV0b21hdG9yKTtcbiAgICBpZiAoIWlzVUlBdXRvbWF0b3JJbnN0YWxsZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuaW5zdGFsbFVJQXV0b21hdG9yKCk7XG4gICAgfVxuXG4gICAgbGV0IHVpYXV0b21hdG9yU3RhdHVzID0gYXdhaXQgdGhpcy5pc1N0YXJ0ZWRVSUF1dG9tYXRvcigpO1xuICAgIGlmICghdWlhdXRvbWF0b3JTdGF0dXMpIHtcbiAgICAgIGF3YWl0IHRoaXMuc3RhcnRVSUF1dG9tYXRvcigpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB0aGlzLnN0b3BVSUF1dG9tYXRvcigpO1xuICAgICAgYXdhaXQgc2xlZXAoMjAwMCk7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0VUlBdXRvbWF0b3IoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnN0YWxsVUlBdXRvbWF0b3IgKCkge1xuICAgIGxldCBhcmNoID0gYXdhaXQgdGhpcy5zZGIuc2hlbGwoJ3VuYW1lIC1hJyk7XG4gICAgbGV0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nKTtcbiAgICBsZXQgdHBrUGF0aCA9IHBhdGgucmVzb2x2ZShyb290RGlyLCAndWlhdXRvbWF0b3InLCBgJHt0aGlzLnVpYXV0b21hdG9yfS0ke3RoaXMudWlhdXRvbWF0b3JWZXJzaW9ufWApO1xuXG4gICAgaWYgKGFyY2guaW5jbHVkZXMoJ2k2ODYnKSkge1xuICAgICAgdHBrUGF0aCArPSAnLXg4Nic7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRwa1BhdGggKz0gJy1hcm0nO1xuICAgIH1cbiAgICB0cGtQYXRoICs9ICcudHBrJztcblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnNkYi5pbnN0YWxsKHRwa1BhdGgpO1xuICB9XG5cbiAgYXN5bmMgdW5pbnN0YWxsVUlBdXRvbWF0b3IgKCkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnJlbW92ZUFwcCh0aGlzLnVpYXV0b21hdG9yKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0VUlBdXRvbWF0b3IgKCkge1xuICAgIGF3YWl0IHRoaXMuc2RiLnN0YXJ0QXBwKHRoaXMudWlhdXRvbWF0b3IpO1xuICB9XG5cbiAgYXN5bmMgc3RvcFVJQXV0b21hdG9yICgpIHtcbiAgICBhd2FpdCB0aGlzLnNkYi5zaGVsbChgYXBwX2xhdW5jaGVyIC10ICR7dGhpcy51aWF1dG9tYXRvcn1gKTtcbiAgfVxuXG4gIGFzeW5jIHJlc3RhcnRVSUF1dG9tYXRvciAoKSB7XG4gICAgYXdhaXQgdGhpcy5zdG9wVUlBdXRvbWF0b3IoKTtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0VUlBdXRvbWF0b3IoKTtcbiAgfVxuXG4gIGFzeW5jIGlzU3RhcnRlZFVJQXV0b21hdG9yICgpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZGIuaXNTdGFydGVkQXBwKHRoaXMudWlhdXRvbWF0b3IpO1xuICB9XG5cbiAgc2V0IGlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biAoaWdub3JlKSB7XG4gICAgbG9nLmRlYnVnKGAke2lnbm9yZSA/ICdJZ25vcmluZycgOiAnV2F0Y2hpbmcgZm9yJ30gYm9vdHN0cmFwIGRpc2Nvbm5lY3RgKTtcbiAgICB0aGlzLl9pZ25vcmVVbmV4cGVjdGVkU2h1dGRvd24gPSBpZ25vcmU7XG4gIH1cblxuICBnZXQgaWdub3JlVW5leHBlY3RlZFNodXRkb3duICgpIHtcbiAgICByZXR1cm4gdGhpcy5faWdub3JlVW5leHBlY3RlZFNodXRkb3duO1xuICB9XG59XG5cbmV4cG9ydCB7IFRpemVuQm9vdHN0cmFwLCBDT01NQU5EX1RZUEVTIH07XG5leHBvcnQgZGVmYXVsdCBUaXplbkJvb3RzdHJhcDtcbiJdLCJmaWxlIjoibGliL3RpemVuLWJvb3RzdHJhcC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
