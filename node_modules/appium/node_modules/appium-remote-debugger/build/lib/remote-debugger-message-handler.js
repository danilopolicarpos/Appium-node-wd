"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

const IGNORED_EVENTS = ['Page.domContentEventFired', 'Page.frameStartedLoading', 'Page.frameStoppedLoading', 'Page.frameScheduledNavigation', 'Page.frameClearedScheduledNavigation', 'Console.messagesCleared'];

class RpcMessageHandler {
  constructor(specialHandlers, isTargetBased = false) {
    this.setHandlers();
    this.errorHandlers = {};
    this.specialHandlers = _lodash.default.clone(specialHandlers);
    this.dataHandlers = {};
    this.willNavigateWithoutReload = false;
    this.isTargetBased = isTargetBased;
  }

  setCommunicationProtocol(isTargetBased) {
    this.isTargetBased = isTargetBased;
  }

  setDataMessageHandler(key, errorHandler, handler) {
    this.errorHandlers[key] = errorHandler;
    this.dataHandlers[key] = handler;
  }

  setSpecialMessageHandler(key, errorHandler, handler) {
    this.errorHandlers[key] = errorHandler;
    this.specialHandlers[key] = handler;
  }

  getSpecialMessageHandler(key) {
    return this.specialHandlers[key];
  }

  setTimelineEventHandler(timelineEventHandler) {
    this.timelineEventHandler = timelineEventHandler;
  }

  setConsoleLogEventHandler(consoleLogEventHandler) {
    this.consoleLogEventHandler = consoleLogEventHandler;
  }

  setNetworkEventHandler(networkLogEventHandler) {
    this.networkLogEventHandler = networkLogEventHandler;
  }

  hasErrorHandler(key) {
    return _lodash.default.has(this.errorHandlers, key);
  }

  hasSpecialMessageHandler(key) {
    return _lodash.default.has(this.specialHandlers, key);
  }

  allowNavigationWithoutReload(allow = true) {
    this.willNavigateWithoutReload = allow;
  }

  async handleMessage(plist) {
    const selector = plist.__selector;

    if (!selector) {
      _logger.default.debug('Got an invalid plist');

      return;
    }

    if (_lodash.default.has(this.handlers, selector)) {
      await this.handlers[selector](plist);
    } else {
      _logger.default.debug(`Debugger got a message for '${selector}' and have no ` + `handler, doing nothing.`);
    }
  }

  async handleSpecialMessage(handler, ...args) {
    const fn = this.specialHandlers[handler];

    if (fn) {
      if (handler !== '_rpc_forwardGetListing:' && handler !== '_rpc_applicationDisconnected:' && handler !== '_rpc_applicationConnected:' && handler !== '_rpc_applicationUpdated:' && handler !== '_rpc_reportConnectedDriverList:') {
        this.specialHandlers[handler] = null;
      }

      await fn(...args);
    } else {
      _logger.default.warn(`Tried to access special message handler '${handler}' ` + `but none was found`);
    }
  }

  parseDataKey(plist) {
    try {
      return JSON.parse(plist.__argument.WIRMessageDataKey.toString('utf8'));
    } catch (err) {
      _logger.default.error(`Unparseable message data: ${_lodash.default.truncate(JSON.stringify(plist), {
        length: 100
      })}`);

      throw new Error(`Unable to parse message data: ${err.message}`);
    }
  }

  async dispatchDataMessage(msgId, method, params, result, error) {
    if (method === 'Profiler.resetProfiles') {
      _logger.default.debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
    } else if (method === 'Page.frameNavigated') {
      if (!this.willNavigateWithoutReload && !this.pageLoading) {
        _logger.default.debug('Frame navigated, unloading page');

        if (_lodash.default.isFunction(this.specialHandlers['Page.frameNavigated'])) {
          await this.specialHandlers['Page.frameNavigated']('remote-debugger');
          this.specialHandlers['Page.frameNavigated'] = null;
        }
      } else {
        _logger.default.debug('Frame navigated but we were warned about it, not ' + 'considering page state unloaded');

        this.willNavigateWithoutReload = false;
      }
    } else if (IGNORED_EVENTS.includes(method)) {} else if (method === 'Page.loadEventFired' && _lodash.default.isFunction(this.specialHandlers.pageLoad)) {
      await this.specialHandlers.pageLoad();
    } else if (method === 'Page.frameDetached' && _lodash.default.isFunction(this.specialHandlers.frameDetached)) {
      await this.specialHandlers.frameDetached();
    } else if (method === 'Timeline.eventRecorded' && _lodash.default.isFunction(this.timelineEventHandler)) {
      this.timelineEventHandler(params || params.record);
    } else if (method === 'Console.messageAdded' && _lodash.default.isFunction(this.consoleLogEventHandler)) {
      this.consoleLogEventHandler(params.message);
    } else if (method && method.startsWith('Network.') && _lodash.default.isFunction(this.networkLogEventHandler)) {
      this.networkLogEventHandler(method, params);
    } else if (_lodash.default.isFunction(this.dataHandlers[msgId])) {
      _logger.default.debug('Found data handler for response');

      if (result.result && result.result.value) {
        result = result.result.value;
      }

      this.dataHandlers[msgId](result);
      this.dataHandlers[msgId] = null;
    } else if (this.dataHandlers[msgId] === null) {
      _logger.default.error(`Debugger returned data for message ${msgId} ` + `but we already ran that callback! WTF??`);
    } else {
      if (msgId || result || error) {
        _logger.default.error(`Debugger returned data for message '${msgId}' ` + `but we were not waiting for that message! ` + `result: '${JSON.stringify(result)}'; ` + `error: '${error}'`);
      }
    }
  }

  logFullMessage(plist) {
    const bufferToJSON = Buffer.prototype.toJSON;
    delete Buffer.prototype.toJSON;

    try {
      (0, _logger.default)(JSON.stringify(plist, (k, v) => Buffer.isBuffer(v) ? v.toString('utf8') : v, 2));
    } finally {
      Buffer.prototype.toJSON = bufferToJSON;
    }
  }

  async handleDataMessage(plist) {
    const dataKey = this.parseDataKey(plist);
    let msgId = (dataKey.id || '').toString();
    let result = dataKey.result;
    let error = dataKey.error || null;

    if (result && result.wasThrown) {
      let message = result.result && (result.result.value || result.result.description) ? result.result.value || result.result.description : 'Error occurred in handling data message';
      error = new Error(message);
    }

    if (error) {
      if (this.hasErrorHandler(msgId)) {
        this.errorHandlers[msgId](error);
      } else {
        _logger.default.error(`Error occurred in handling data message: ${error}`);

        _logger.default.error('No error handler present, ignoring');
      }

      return;
    }

    let method = dataKey.method;
    let params;

    if (this.isTargetBased) {
      if (method === 'Target.targetCreated') {
        const app = plist.__argument.WIRApplicationIdentifierKey;
        const targetInfo = dataKey.params.targetInfo;
        await this.specialHandlers.targetCreated(app, targetInfo);
        return;
      }

      if (method === 'Target.targetDestroyed') {
        const app = plist.__argument.WIRApplicationIdentifierKey;
        const targetInfo = dataKey.params.targetInfo;
        await this.specialHandlers.targetDestroyed(app, targetInfo);
        return;
      } else if (dataKey.method !== 'Target.dispatchMessageFromTarget') {
        if (!_lodash.default.isEmpty(msgId)) {
          _logger.default.debug(`Received receipt for message '${msgId}'`);
        }

        return;
      }

      let message;

      try {
        message = JSON.parse(dataKey.params.message);
        msgId = message.id;
        method = message.method;
        result = message.result || message;
        params = result.params;
      } catch (err) {
        _logger.default.error(`Unexpected message format from Web Inspector:`);

        this.logFullMessage(plist);
        throw err;
      }
    } else {
      params = dataKey.params;
    }

    if (!_lodash.default.isEmpty(msgId)) {
      _logger.default.debug(`Received response for message '${msgId}'`);
    }

    await this.dispatchDataMessage(msgId, method, params, result, error);
  }

  setHandlers() {
    this.handlers = {
      '_rpc_reportSetup:': async plist => {
        await this.handleSpecialMessage('_rpc_reportIdentifier:', plist.__argument.WIRSimulatorNameKey, plist.__argument.WIRSimulatorBuildKey, plist.__argument.WIRSimulatorProductVersionKey);
      },
      '_rpc_reportConnectedApplicationList:': async plist => {
        await this.handleSpecialMessage('_rpc_reportConnectedApplicationList:', plist.__argument.WIRApplicationDictionaryKey);
      },
      '_rpc_applicationSentListing:': async plist => {
        await this.handleSpecialMessage('_rpc_forwardGetListing:', plist.__argument.WIRApplicationIdentifierKey, plist.__argument.WIRListingKey);
      },
      '_rpc_applicationConnected:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationConnected:', plist.__argument);
      },
      '_rpc_applicationDisconnected:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationDisconnected:', plist.__argument);
      },
      '_rpc_applicationUpdated:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationUpdated:', plist.__argument);
      },
      '_rpc_reportConnectedDriverList:': async plist => {
        await this.handleSpecialMessage('_rpc_reportConnectedDriverList:', plist.__argument);
      },
      '_rpc_applicationSentData:': this.handleDataMessage.bind(this)
    };
  }

}

exports.default = RpcMessageHandler;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXItbWVzc2FnZS1oYW5kbGVyLmpzIl0sIm5hbWVzIjpbIklHTk9SRURfRVZFTlRTIiwiUnBjTWVzc2FnZUhhbmRsZXIiLCJjb25zdHJ1Y3RvciIsInNwZWNpYWxIYW5kbGVycyIsImlzVGFyZ2V0QmFzZWQiLCJzZXRIYW5kbGVycyIsImVycm9ySGFuZGxlcnMiLCJfIiwiY2xvbmUiLCJkYXRhSGFuZGxlcnMiLCJ3aWxsTmF2aWdhdGVXaXRob3V0UmVsb2FkIiwic2V0Q29tbXVuaWNhdGlvblByb3RvY29sIiwic2V0RGF0YU1lc3NhZ2VIYW5kbGVyIiwia2V5IiwiZXJyb3JIYW5kbGVyIiwiaGFuZGxlciIsInNldFNwZWNpYWxNZXNzYWdlSGFuZGxlciIsImdldFNwZWNpYWxNZXNzYWdlSGFuZGxlciIsInNldFRpbWVsaW5lRXZlbnRIYW5kbGVyIiwidGltZWxpbmVFdmVudEhhbmRsZXIiLCJzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIiwiY29uc29sZUxvZ0V2ZW50SGFuZGxlciIsInNldE5ldHdvcmtFdmVudEhhbmRsZXIiLCJuZXR3b3JrTG9nRXZlbnRIYW5kbGVyIiwiaGFzRXJyb3JIYW5kbGVyIiwiaGFzIiwiaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyIiwiYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCIsImFsbG93IiwiaGFuZGxlTWVzc2FnZSIsInBsaXN0Iiwic2VsZWN0b3IiLCJfX3NlbGVjdG9yIiwibG9nIiwiZGVidWciLCJoYW5kbGVycyIsImhhbmRsZVNwZWNpYWxNZXNzYWdlIiwiYXJncyIsImZuIiwid2FybiIsInBhcnNlRGF0YUtleSIsIkpTT04iLCJwYXJzZSIsIl9fYXJndW1lbnQiLCJXSVJNZXNzYWdlRGF0YUtleSIsInRvU3RyaW5nIiwiZXJyIiwiZXJyb3IiLCJ0cnVuY2F0ZSIsInN0cmluZ2lmeSIsImxlbmd0aCIsIkVycm9yIiwibWVzc2FnZSIsImRpc3BhdGNoRGF0YU1lc3NhZ2UiLCJtc2dJZCIsIm1ldGhvZCIsInBhcmFtcyIsInJlc3VsdCIsInBhZ2VMb2FkaW5nIiwiaXNGdW5jdGlvbiIsImluY2x1ZGVzIiwicGFnZUxvYWQiLCJmcmFtZURldGFjaGVkIiwicmVjb3JkIiwic3RhcnRzV2l0aCIsInZhbHVlIiwibG9nRnVsbE1lc3NhZ2UiLCJidWZmZXJUb0pTT04iLCJCdWZmZXIiLCJwcm90b3R5cGUiLCJ0b0pTT04iLCJrIiwidiIsImlzQnVmZmVyIiwiaGFuZGxlRGF0YU1lc3NhZ2UiLCJkYXRhS2V5IiwiaWQiLCJ3YXNUaHJvd24iLCJkZXNjcmlwdGlvbiIsImFwcCIsIldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsInRhcmdldEluZm8iLCJ0YXJnZXRDcmVhdGVkIiwidGFyZ2V0RGVzdHJveWVkIiwiaXNFbXB0eSIsIldJUlNpbXVsYXRvck5hbWVLZXkiLCJXSVJTaW11bGF0b3JCdWlsZEtleSIsIldJUlNpbXVsYXRvclByb2R1Y3RWZXJzaW9uS2V5IiwiV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5IiwiV0lSTGlzdGluZ0tleSIsImJpbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBS0EsTUFBTUEsY0FBYyxHQUFHLENBQ3JCLDJCQURxQixFQUVyQiwwQkFGcUIsRUFHckIsMEJBSHFCLEVBSXJCLCtCQUpxQixFQUtyQixzQ0FMcUIsRUFNckIseUJBTnFCLENBQXZCOztBQVNlLE1BQU1DLGlCQUFOLENBQXdCO0FBQ3JDQyxFQUFBQSxXQUFXLENBQUVDLGVBQUYsRUFBbUJDLGFBQWEsR0FBRyxLQUFuQyxFQUEwQztBQUNuRCxTQUFLQyxXQUFMO0FBQ0EsU0FBS0MsYUFBTCxHQUFxQixFQUFyQjtBQUNBLFNBQUtILGVBQUwsR0FBdUJJLGdCQUFFQyxLQUFGLENBQVFMLGVBQVIsQ0FBdkI7QUFDQSxTQUFLTSxZQUFMLEdBQW9CLEVBQXBCO0FBQ0EsU0FBS0MseUJBQUwsR0FBaUMsS0FBakM7QUFFQSxTQUFLTixhQUFMLEdBQXFCQSxhQUFyQjtB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Q0pOLEtBQUssQ0FBQ2EsVUFERixDQUFOO0FBRUQsT0FuQmE7QUFvQmQsdUNBQWlDLE1BQU9iLEtBQVAsSUFBaUI7QUFDaEQsY0FBTSxLQUFLTSxvQkFBTCxDQUEwQiwrQkFBMUIsRUFDSk4sS0FBSyxDQUFDYSxVQURGLENBQU47QUFFRCxPQXZCYTtBQXdCZCxrQ0FBNEIsTUFBT2IsS0FBUCxJQUFpQjtBQUMzQyxjQUFNLEtBQUtNLG9CQUFMLENBQTBCLDBCQUExQixFQUNKTixLQUFLLENBQUNhLFVBREYsQ0FBTjtBQUVELE9BM0JhO0FBNEJkLHlDQUFtQyxNQUFPYixLQUFQLElBQWlCO0FBQ2xELGNBQU0sS0FBS00sb0JBQUwsQ0FBMEIsaUNBQTFCLEVBQ0pOLEtBQUssQ0FBQ2EsVUFERixDQUFOO0FBRUQsT0EvQmE7QUFnQ2QsbUNBQTZCLEtBQUsrQixpQkFBTCxDQUF1QmdCLElBQXZCLENBQTRCLElBQTVCO0FBaENmLEtBQWhCO0FBa0NEOztBQWpSb0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cblxuLy8gd2Ugd2lsbCByZWNlaXZlIGV2ZW50cyB0aGF0IHdlIGRvIG5vdCBsaXN0ZW4gdG8uXG4vLyBpZiB3ZSBzdGFydCB0byBsaXN0ZW4gdG8gb25lIG9mIHRoZXNlLCByZW1vdmUgaXQgZnJvbSB0aGUgbGlzdFxuY29uc3QgSUdOT1JFRF9FVkVOVFMgPSBbXG4gICdQYWdlLmRvbUNvbnRlbnRFdmVudEZpcmVkJyxcbiAgJ1BhZ2UuZnJhbWVTdGFydGVkTG9hZGluZycsXG4gICdQYWdlLmZyYW1lU3RvcHBlZExvYWRpbmcnLFxuICAnUGFnZS5mcmFtZVNjaGVkdWxlZE5hdmlnYXRpb24nLFxuICAnUGFnZS5mcmFtZUNsZWFyZWRTY2hlZHVsZWROYXZpZ2F0aW9uJyxcbiAgJ0NvbnNvbGUubWVzc2FnZXNDbGVhcmVkJyxcbl07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJwY01lc3NhZ2VIYW5kbGVyIHtcbiAgY29uc3RydWN0b3IgKHNwZWNpYWxIYW5kbGVycywgaXNUYXJnZXRCYXNlZCA9IGZhbHNlKSB7XG4gICAgdGhpcy5zZXRIYW5kbGVycygpO1xuICAgIHRoaXMuZXJyb3JIYW5kbGVycyA9IHt9O1xuICAgIHRoaXMuc3BlY2lhbEhhbmRsZXJzID0gXy5jbG9uZShzcGVjaWFsSGFuZGxlcnMpO1xuICAgIHRoaXMuZGF0YUhhbmRsZXJzID0ge307XG4gICAgdGhpcy53aWxsTmF2aWdhdGVXaXRob3V0UmVsb2FkID0gZmFsc2U7XG5cbiAgICB0aGlzLmlzVGFyZ2V0QmFzZWQgPSBpc1RhcmdldEJhc2VkO1xuICB9XG5cbiAgc2V0Q29tbXVuaWNhdGlvblByb3RvY29sIChpc1RhcmdldEJhc2VkKSB7XG4gICAgdGhpcy5pc1RhcmdldEJhc2VkID0gaXNUYXJnZXRCYXNlZDtcbiAgfVxuXG4gIHNldERhdGFNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLmVycm9ySGFuZGxlcnNba2V5XSA9IGVycm9ySGFuZGxlcjtcbiAgICB0aGlzLmRhdGFIYW5kbGVyc1trZXldID0gaGFuZGxlcjtcbiAgfVxuXG4gIHNldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLmVycm9ySGFuZGxlcnNba2V5XSA9IGVycm9ySGFuZGxlcjtcbiAgICB0aGlzLnNwZWNpYWxIYW5kbGVyc1trZXldID0gaGFuZGxlcjtcbiAgfVxuXG4gIGdldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5KSB7XG4gICAgcmV0dXJuIHRoaXMuc3BlY2lhbEhhbmRsZXJzW2tleV07XG4gIH1cblxuICBzZXRUaW1lbGluZUV2ZW50SGFuZGxlciAodGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyID0gdGltZWxpbmVFdmVudEhhbmRsZXI7XG4gIH1cblxuICBzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIChjb25zb2xlTG9nRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy5jb25zb2xlTG9nRXZlbnRIYW5kbGVyID0gY29uc29sZUxvZ0V2ZW50SGFuZGxlcjtcbiAgfVxuXG4gIHNldE5ldHdvcmtFdmVudEhhbmRsZXIgKG5ldHdvcmtMb2dFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLm5ldHdvcmtMb2dFdmVudEhhbmRsZXIgPSBuZXR3b3JrTG9nRXZlbnRIYW5kbGVyO1xuICB9XG5cbiAgaGFzRXJyb3JIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gXy5oYXModGhpcy5lcnJvckhhbmRsZXJzLCBrZXkpO1xuICB9XG5cbiAgaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gXy5oYXModGhpcy5zcGVjaWFsSGFuZGxlcnMsIGtleSk7XG4gIH1cblxuICBhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIChhbGxvdyA9IHRydWUpIHtcbiAgICB0aGlzLndpbGxOYXZpZ2F0ZVdpdGhvdXRSZWxvYWQgPSBhbGxvdztcbiAgfVxuXG4gIGFzeW5jIGhhbmRsZU1lc3NhZ2UgKHBsaXN0KSB7XG4gICAgY29uc3Qgc2VsZWN0b3IgPSBwbGlzdC5fX3NlbGVjdG9yO1xuICAgIGlmICghc2VsZWN0b3IpIHtcbiAgICAgIGxvZy5kZWJ1ZygnR290IGFuIGludmFsaWQgcGxpc3QnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoXy5oYXModGhpcy5oYW5kbGVycywgc2VsZWN0b3IpKSB7XG4gICAgICBhd2FpdCB0aGlzLmhhbmRsZXJzW3NlbGVjdG9yXShwbGlzdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgRGVidWdnZXIgZ290IGEgbWVzc2FnZSBmb3IgJyR7c2VsZWN0b3J9JyBhbmQgaGF2ZSBubyBgICtcbiAgICAgICAgICAgICAgICBgaGFuZGxlciwgZG9pbmcgbm90aGluZy5gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBoYW5kbGVTcGVjaWFsTWVzc2FnZSAoaGFuZGxlciwgLi4uYXJncykge1xuICAgIGNvbnN0IGZuID0gdGhpcy5zcGVjaWFsSGFuZGxlcnNbaGFuZGxlcl07XG5cbiAgICBpZiAoZm4pIHtcbiAgICAgIC8vIG1vc3QgcmVzcG9uc2VzIGFyZSBvbmx5IHRvIGJlIGNhbGxlZCBvbmNlLCB0aGVuXG4gICAgICAvLyByZW1vdmVkLiBCdXQgbm90IHRoZSBvbmVzIGJlbG93LCB3aGljaCBoYW5kbGVcbiAgICAgIC8vIHBhZ2UgY2hhbmdlIGFuZCBhcHAgY29ubmVjdC9kaXNjb25uZWN0XG4gICAgICBpZiAoaGFuZGxlciAhPT0gJ19ycGNfZm9yd2FyZEdldExpc3Rpbmc6JyAmJlxuICAgICAgICAgIGhhbmRsZXIgIT09ICdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOicgJiZcbiAgICAgICAgICBoYW5kbGVyICE9PSAnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonICYmXG4gICAgICAgICAgaGFuZGxlciAhPT0gJ19ycGNfYXBwbGljYXRpb25VcGRhdGVkOicgJiZcbiAgICAgICAgICBoYW5kbGVyICE9PSAnX3JwY19yZXBvcnRDb25uZWN0ZWREcml2ZXJMaXN0OicpIHtcbiAgICAgICAgdGhpcy5zcGVjaWFsSGFuZGxlcnNbaGFuZGxlcl0gPSBudWxsO1xuICAgICAgfVxuICAgICAgYXdhaXQgZm4oLi4uYXJncyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy53YXJuKGBUcmllZCB0byBhY2Nlc3Mgc3BlY2lhbCBtZXNzYWdlIGhhbmRsZXIgJyR7aGFuZGxlcn0nIGAgK1xuICAgICAgICAgICAgICAgYGJ1dCBub25lIHdhcyBmb3VuZGApO1xuICAgIH1cbiAgfVxuXG4gIHBhcnNlRGF0YUtleSAocGxpc3QpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIEpTT04ucGFyc2UocGxpc3QuX19hcmd1bWVudC5XSVJNZXNzYWdlRGF0YUtleS50b1N0cmluZygndXRmOCcpKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvcihgVW5wYXJzZWFibGUgbWVzc2FnZSBkYXRhOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkocGxpc3QpLCB7bGVuZ3RoOiAxMDB9KX1gKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIHBhcnNlIG1lc3NhZ2UgZGF0YTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkaXNwYXRjaERhdGFNZXNzYWdlIChtc2dJZCwgbWV0aG9kLCBwYXJhbXMsIHJlc3VsdCwgZXJyb3IpIHtcbiAgICBpZiAobWV0aG9kID09PSAnUHJvZmlsZXIucmVzZXRQcm9maWxlcycpIHtcbiAgICAgIGxvZy5kZWJ1ZygnRGV2aWNlIGlzIHRlbGxpbmcgdXMgdG8gcmVzZXQgcHJvZmlsZXMuIFNob3VsZCBwcm9iYWJseSAnICtcbiAgICAgICAgICAgICAgICAnZG8gc29tZSBraW5kIG9mIGNhbGxiYWNrIGhlcmUnKTtcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnKSB7XG4gICAgICBpZiAoIXRoaXMud2lsbE5hdmlnYXRlV2l0aG91dFJlbG9hZCAmJiAhdGhpcy5wYWdlTG9hZGluZykge1xuICAgICAgICBsb2cuZGVidWcoJ0ZyYW1lIG5hdmlnYXRlZCwgdW5sb2FkaW5nIHBhZ2UnKTtcbiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLnNwZWNpYWxIYW5kbGVyc1snUGFnZS5mcmFtZU5hdmlnYXRlZCddKSkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuc3BlY2lhbEhhbmRsZXJzWydQYWdlLmZyYW1lTmF2aWdhdGVkJ10oJ3JlbW90ZS1kZWJ1Z2dlcicpO1xuICAgICAgICAgIHRoaXMuc3BlY2lhbEhhbmRsZXJzWydQYWdlLmZyYW1lTmF2aWdhdGVkJ10gPSBudWxsO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoJ0ZyYW1lIG5hdmlnYXRlZCBidXQgd2Ugd2VyZSB3YXJuZWQgYWJvdXQgaXQsIG5vdCAnICtcbiAgICAgICAgICAgICAgICAgICdjb25zaWRlcmluZyBwYWdlIHN0YXRlIHVubG9hZGVkJyk7XG4gICAgICAgIHRoaXMud2lsbE5hdmlnYXRlV2l0aG91dFJlbG9hZCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoSUdOT1JFRF9FVkVOVFMuaW5jbHVkZXMobWV0aG9kKSkge1xuICAgICAgLy8gcGFzc1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnUGFnZS5sb2FkRXZlbnRGaXJlZCcgJiYgXy5pc0Z1bmN0aW9uKHRoaXMuc3BlY2lhbEhhbmRsZXJzLnBhZ2VMb2FkKSkge1xuICAgICAgYXdhaXQgdGhpcy5zcGVjaWFsSGFuZGxlcnMucGFnZUxvYWQoKTtcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ1BhZ2UuZnJhbWVEZXRhY2hlZCcgJiYgXy5pc0Z1bmN0aW9uKHRoaXMuc3BlY2lhbEhhbmRsZXJzLmZyYW1lRGV0YWNoZWQpKSB7XG4gICAgICBhd2FpdCB0aGlzLnNwZWNpYWxIYW5kbGVycy5mcmFtZURldGFjaGVkKCk7XG4gICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdUaW1lbGluZS5ldmVudFJlY29yZGVkJyAmJiBfLmlzRnVuY3Rpb24odGhpcy50aW1lbGluZUV2ZW50SGFuZGxlcikpIHtcbiAgICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIocGFyYW1zIHx8IHBhcmFtcy5yZWNvcmQpO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnQ29uc29sZS5tZXNzYWdlQWRkZWQnICYmIF8uaXNGdW5jdGlvbih0aGlzLmNvbnNvbGVMb2dFdmVudEhhbmRsZXIpKSB7XG4gICAgICB0aGlzLmNvbnNvbGVMb2dFdmVudEhhbmRsZXIocGFyYW1zLm1lc3NhZ2UpO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kICYmIG1ldGhvZC5zdGFydHNXaXRoKCdOZXR3b3JrLicpICYmIF8uaXNGdW5jdGlvbih0aGlzLm5ldHdvcmtMb2dFdmVudEhhbmRsZXIpKSB7XG4gICAgICB0aGlzLm5ldHdvcmtMb2dFdmVudEhhbmRsZXIobWV0aG9kLCBwYXJhbXMpO1xuICAgIH0gZWxzZSBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXSkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnRm91bmQgZGF0YSBoYW5kbGVyIGZvciByZXNwb25zZScpO1xuXG4gICAgICAvLyB3ZSB3aWxsIGVpdGhlciBnZXQgYmFjayBhIHJlc3VsdCBvYmplY3QgdGhhdCBoYXMgYSByZXN1bHQudmFsdWVcbiAgICAgIC8vIGluIHdoaWNoIGNhc2UgdGhhdCBpcyB3aGF0IHdlIHdhbnQsXG4gICAgICAvLyBvciBlbHNlIHdlIHJldHVybiB0aGUgd2hvbGUgdGhpbmdcbiAgICAgIGlmIChyZXN1bHQucmVzdWx0ICYmIHJlc3VsdC5yZXN1bHQudmFsdWUpIHtcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LnJlc3VsdC52YWx1ZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXShyZXN1bHQpO1xuICAgICAgdGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdID0gbnVsbDtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXSA9PT0gbnVsbCkge1xuICAgICAgbG9nLmVycm9yKGBEZWJ1Z2dlciByZXR1cm5lZCBkYXRhIGZvciBtZXNzYWdlICR7bXNnSWR9IGAgK1xuICAgICAgICAgICAgICAgIGBidXQgd2UgYWxyZWFkeSByYW4gdGhhdCBjYWxsYmFjayEgV1RGPz9gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKG1zZ0lkIHx8IHJlc3VsdCB8fCBlcnJvcikge1xuICAgICAgICBsb2cuZXJyb3IoYERlYnVnZ2VyIHJldHVybmVkIGRhdGEgZm9yIG1lc3NhZ2UgJyR7bXNnSWR9JyBgICtcbiAgICAgICAgICAgICAgICAgIGBidXQgd2Ugd2VyZSBub3Qgd2FpdGluZyBmb3IgdGhhdCBtZXNzYWdlISBgICtcbiAgICAgICAgICAgICAgICAgIGByZXN1bHQ6ICcke0pTT04uc3RyaW5naWZ5KHJlc3VsdCl9JzsgYCArXG4gICAgICAgICAgICAgICAgICBgZXJyb3I6ICcke2Vycm9yfSdgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsb2dGdWxsTWVzc2FnZSAocGxpc3QpIHtcbiAgICAvLyBCdWZmZXJzIGNhbm5vdCBiZSBzZXJpYWxpemVkIGluIGEgcmVhZGFibGUgd2F5XG4gICAgY29uc3QgYnVmZmVyVG9KU09OID0gQnVmZmVyLnByb3RvdHlwZS50b0pTT047XG4gICAgZGVsZXRlIEJ1ZmZlci5wcm90b3R5cGUudG9KU09OO1xuICAgIHRyeSB7XG4gICAgICBsb2coSlNPTi5zdHJpbmdpZnkocGxpc3QsIChrLCB2KSA9PiBCdWZmZXIuaXNCdWZmZXIodikgPyB2LnRvU3RyaW5nKCd1dGY4JykgOiB2LCAyKSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIC8vIHJlc3RvcmUgdGhlIGZ1bmN0aW9uLCBzbyBhcyB0byBub3QgYnJlYWsgZnVydGhlciBzZXJpYWxpemF0aW9uXG4gICAgICBCdWZmZXIucHJvdG90eXBlLnRvSlNPTiA9IGJ1ZmZlclRvSlNPTjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBoYW5kbGVEYXRhTWVzc2FnZSAocGxpc3QpIHtcbiAgICBjb25zdCBkYXRhS2V5ID0gdGhpcy5wYXJzZURhdGFLZXkocGxpc3QpO1xuICAgIGxldCBtc2dJZCA9IChkYXRhS2V5LmlkIHx8ICcnKS50b1N0cmluZygpO1xuICAgIGxldCByZXN1bHQgPSBkYXRhS2V5LnJlc3VsdDtcblxuICAgIC8vIHdlIGNhbiBnZXQgYW4gZXJyb3IsIG9yIHdlIGNhbiBnZXQgYSByZXNwb25zZSB0aGF0IGlzIGFuIGVycm9yXG4gICAgbGV0IGVycm9yID0gZGF0YUtleS5lcnJvciB8fCBudWxsO1xuICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0Lndhc1Rocm93bikge1xuICAgICAgbGV0IG1lc3NhZ2UgPSAocmVzdWx0LnJlc3VsdCAmJiAocmVzdWx0LnJlc3VsdC52YWx1ZSB8fCByZXN1bHQucmVzdWx0LmRlc2NyaXB0aW9uKSlcbiAgICAgICAgPyAocmVzdWx0LnJlc3VsdC52YWx1ZSB8fCByZXN1bHQucmVzdWx0LmRlc2NyaXB0aW9uKVxuICAgICAgICA6ICdFcnJvciBvY2N1cnJlZCBpbiBoYW5kbGluZyBkYXRhIG1lc3NhZ2UnO1xuICAgICAgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgfVxuXG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBpZiAodGhpcy5oYXNFcnJvckhhbmRsZXIobXNnSWQpKSB7XG4gICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyc1ttc2dJZF0oZXJyb3IpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmVycm9yKGBFcnJvciBvY2N1cnJlZCBpbiBoYW5kbGluZyBkYXRhIG1lc3NhZ2U6ICR7ZXJyb3J9YCk7XG4gICAgICAgIGxvZy5lcnJvcignTm8gZXJyb3IgaGFuZGxlciBwcmVzZW50LCBpZ25vcmluZycpO1xuICAgICAgfVxuXG4gICAgICAvLyBzaG9ydCBjaXJjdWl0XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IG1ldGhvZCA9IGRhdGFLZXkubWV0aG9kO1xuICAgIGxldCBwYXJhbXM7XG4gICAgaWYgKHRoaXMuaXNUYXJnZXRCYXNlZCkge1xuICAgICAgaWYgKG1ldGhvZCA9PT0gJ1RhcmdldC50YXJnZXRDcmVhdGVkJykge1xuICAgICAgICAvLyB0aGlzIGlzIGluIHJlc3BvbnNlIHRvIGEgYF9ycGNfZm9yd2FyZFNvY2tldFNldHVwOmAgY2FsbFxuICAgICAgICAvLyB0YXJnZXRJbmZvOiB7IHRhcmdldElkOiAncGFnZS0xJywgdHlwZTogJ3BhZ2UnIH1cbiAgICAgICAgY29uc3QgYXBwID0gcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gICAgICAgIGNvbnN0IHRhcmdldEluZm8gPSBkYXRhS2V5LnBhcmFtcy50YXJnZXRJbmZvO1xuICAgICAgICBhd2FpdCB0aGlzLnNwZWNpYWxIYW5kbGVycy50YXJnZXRDcmVhdGVkKGFwcCwgdGFyZ2V0SW5mbyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH0gaWYgKG1ldGhvZCA9PT0gJ1RhcmdldC50YXJnZXREZXN0cm95ZWQnKSB7XG4gICAgICAgIGNvbnN0IGFwcCA9IHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICAgICAgICBjb25zdCB0YXJnZXRJbmZvID0gZGF0YUtleS5wYXJhbXMudGFyZ2V0SW5mbztcbiAgICAgICAgYXdhaXQgdGhpcy5zcGVjaWFsSGFuZGxlcnMudGFyZ2V0RGVzdHJveWVkKGFwcCwgdGFyZ2V0SW5mbyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH0gZWxzZSBpZiAoZGF0YUtleS5tZXRob2QgIT09ICdUYXJnZXQuZGlzcGF0Y2hNZXNzYWdlRnJvbVRhcmdldCcpIHtcbiAgICAgICAgLy8gdGhpcyBzb3J0IG9mIG1lc3NhZ2UsIGF0IHRoaXMgcG9pbnQsIGlzIGp1c3QgYW4gYWNrbm93bGVkZ2VtZW50XG4gICAgICAgIC8vIHRoYXQgdGhlIG9yaWdpbmFsIG1lc3NhZ2Ugd2FzIHJlY2VpdmVkXG4gICAgICAgIGlmICghXy5pc0VtcHR5KG1zZ0lkKSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcmVjZWlwdCBmb3IgbWVzc2FnZSAnJHttc2dJZH0nYCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBhdCB0aGlzIHBvaW50LCB3ZSBoYXZlIGEgVGFyZ2V0LWJhc2VkIG1lc3NhZ2Ugd3JhcHBpbmcgYSBwcm90b2NvbCBtZXNzYWdlXG4gICAgICBsZXQgbWVzc2FnZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIG1lc3NhZ2UgPSBKU09OLnBhcnNlKGRhdGFLZXkucGFyYW1zLm1lc3NhZ2UpO1xuICAgICAgICBtc2dJZCA9IG1lc3NhZ2UuaWQ7XG4gICAgICAgIG1ldGhvZCA9IG1lc3NhZ2UubWV0aG9kO1xuICAgICAgICByZXN1bHQgPSBtZXNzYWdlLnJlc3VsdCB8fCBtZXNzYWdlO1xuICAgICAgICBwYXJhbXMgPSByZXN1bHQucGFyYW1zO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIGlmIHRoaXMgaGFwcGVucyB0aGVuIHNvbWUgYXNwZWN0IG9mIHRoZSBwcm90b2NvbCBpcyBtaXNzaW5nIHRvIHVzXG4gICAgICAgIC8vIHNvIHByaW50IHRoZSBlbnRpcmUgbWVzc2FnZSB0byBnZXQgdmlzaWJpaXR5IGludG8gd2hhdCBpcyBnb2luZyBvblxuICAgICAgICBsb2cuZXJyb3IoYFVuZXhwZWN0ZWQgbWVzc2FnZSBmb3JtYXQgZnJvbSBXZWIgSW5zcGVjdG9yOmApO1xuICAgICAgICB0aGlzLmxvZ0Z1bGxNZXNzYWdlKHBsaXN0KTtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBwYXJhbXMgPSBkYXRhS2V5LnBhcmFtcztcbiAgICB9XG5cbiAgICBpZiAoIV8uaXNFbXB0eShtc2dJZCkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcmVzcG9uc2UgZm9yIG1lc3NhZ2UgJyR7bXNnSWR9J2ApO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hEYXRhTWVzc2FnZShtc2dJZCwgbWV0aG9kLCBwYXJhbXMsIHJlc3VsdCwgZXJyb3IpO1xuICB9XG5cbiAgc2V0SGFuZGxlcnMgKCkge1xuICAgIHRoaXMuaGFuZGxlcnMgPSB7XG4gICAgICAnX3JwY19yZXBvcnRTZXR1cDonOiBhc3luYyAocGxpc3QpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVTcGVjaWFsTWVzc2FnZSgnX3JwY19yZXBvcnRJZGVudGlmaWVyOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJTaW11bGF0b3JOYW1lS2V5LFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQuV0lSU2ltdWxhdG9yQnVpbGRLZXksXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJTaW11bGF0b3JQcm9kdWN0VmVyc2lvbktleSk7XG4gICAgICB9LFxuICAgICAgJ19ycGNfcmVwb3J0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0Oic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX3JlcG9ydENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19hcHBsaWNhdGlvblNlbnRMaXN0aW5nOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXksXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJMaXN0aW5nS2V5KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonOiBhc3luYyAocGxpc3QpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVTcGVjaWFsTWVzc2FnZSgnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudCk7XG4gICAgICB9LFxuICAgICAgJ19ycGNfYXBwbGljYXRpb25VcGRhdGVkOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2FwcGxpY2F0aW9uVXBkYXRlZDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX3JlcG9ydENvbm5lY3RlZERyaXZlckxpc3Q6JzogYXN5bmMgKHBsaXN0KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlU3BlY2lhbE1lc3NhZ2UoJ19ycGNfcmVwb3J0Q29ubmVjdGVkRHJpdmVyTGlzdDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uU2VudERhdGE6JzogdGhpcy5oYW5kbGVEYXRhTWVzc2FnZS5iaW5kKHRoaXMpLFxuICAgIH07XG4gIH1cbn1cbiJdLCJmaWxlIjoibGliL3JlbW90ZS1kZWJ1Z2dlci1tZXNzYWdlLWhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
