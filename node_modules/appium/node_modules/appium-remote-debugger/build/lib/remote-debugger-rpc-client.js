"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _bufferpack = _interopRequireDefault(require("bufferpack"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _remoteDebugger = require("./remote-debugger");

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _net = _interopRequireDefault(require("net"));

var _remoteDebuggerMessageHandler = _interopRequireDefault(require("./remote-debugger-message-handler"));

var _helpers = require("./helpers");

var _rpcClient = _interopRequireDefault(require("./rpc-client"));

const DATA_LOG_LENGTH = {
  length: 200
};

class RemoteDebuggerRpcClient extends _rpcClient.default {
  constructor(opts = {}) {
    super({
      shouldCheckForTarget: false
    });
    const {
      platformVersion = {},
      isSafari = true,
      host = '::1',
      port = _remoteDebugger.REMOTE_DEBUGGER_PORT,
      socketPath,
      specialMessageHandlers = {},
      messageProxy,
      logFullResponse = false
    } = opts;
    this.host = host;
    this.port = port;
    this.socketPath = socketPath;
    this.messageProxy = messageProxy;
    this.socket = null;
    this.connected = false;
    this.connId = _uuidJs.default.create().toString();
    this.senderId = _uuidJs.default.create().toString();
    this.msgId = 0;
    this.received = Buffer.alloc(0);
    this.readPos = 0;
    this.logFullResponse = logFullResponse;
    this.specialMessageHandlers = specialMessageHandlers;
    this.setCommunicationProtocol((0, _helpers.isTargetBased)(isSafari, platformVersion));
  }

  setCommunicationProtocol(isTargetBased = false) {
    super.setCommunicationProtocol(isTargetBased);

    if (!this.messageHandler) {
      this.messageHandler = new _remoteDebuggerMessageHandler.default(this.specialMessageHandlers, isTargetBased);
    } else {
      this.messageHandler.setCommunicationProtocol(isTargetBased);
    }
  }

  async connect() {
    if (this.socketPath) {
      if (this.messageProxy) {
        _logger.default.debug(`Connecting to remote debugger via proxy through unix domain socket: '${this.messageProxy}'`);

        this.socket = _net.default.connect(this.messageProxy);
        this.socket.once('connect', () => {
          _logger.default.debug(`Forwarding the actual web inspector socket to the proxy: '${this.socketPath}'`);

          this.socket.write(JSON.stringify({
            socketPath: this.socketPath
          }));
        });
      } else {
        _logger.default.debug(`Connecting to remote debugger through unix domain socket: '${this.socketPath}'`);

        this.socket = _net.default.connect(this.socketPath);
      }
    } else {
      if (this.messageProxy) {
        this.port = this.messageProxy;
      }

      _logger.default.debug(`Connecting to remote debugger ${this.messageProxy ? 'via proxy ' : ''}through TCP: ${this.host}:${this.port}`);

      this.socket = new _net.default.Socket({
        type: 'tcp6'
      });
      this.socket.connect(this.port, this.host);
    }

    this.socket.setNoDelay(true);
    this.socket.on('close', () => {
      if (this.connected) {
        _logger.default.debug('Debugger socket disconnected');
      }

      this.connected = false;
      this.socket = null;
    });
    this.socket.on('end', () => {
      this.connected = false;
    });
    this.socket.on('data', this.receive.bind(this));
    return await new _bluebird.default((resolve, reject) => {
      this.socket.on('connect', () => {
        _logger.default.debug(`Debugger socket connected`);

        this.connected = true;
        resolve();
      });
      this.socket.on('error', err => {
        if (this.connected) {
          _logger.default.error(`Socket error: ${err.message}`);

          this.connected = false;
        }

        reject(err);
      });
    });
  }

  async disconnect() {
    if (this.isConnected()) {
      _logger.default.debug('Disconnecting from remote debugger');

      this.socket.destroy();
    }

    this.connected = false;
  }

  isConnected() {
    return this.connected;
  }

  setSpecialMessageHandler(key, errorHandler, handler) {
    this.messageHandler.setSpecialMessageHandler(key, errorHandler, handler);
  }

  getSpecialMessageHandler(key) {
    return this.messageHandler.getSpecialMessageHandler(key);
  }

  setDataMessageHandler(key, errorHandler, handler) {
    this.messageHandler.setDataMessageHandler(key, errorHandler, handler);
  }

  allowNavigationWithoutReload(allow = true) {
    this.messageHandler.allowNavigationWithoutReload(allow);
  }

  async selectApp(appIdKey, applicationConnectedHandler) {
    return await new _bluebird.default((resolve, reject) => {
      let onAppChange = dict => {
        let oldAppIdKey = dict.WIRHostApplicationIdentifierKey;
        let correctAppIdKey = dict.WIRApplicationIdentifierKey;

        if (oldAppIdKey && correctAppIdKey !== oldAppIdKey) {
          _logger.default.debug(`We were notified we might have connected to the wrong app. ` + `Using id ${correctAppIdKey} instead of ${oldAppIdKey}`);
        }

        applicationConnectedHandler(dict);
        reject(new Error('New application has connected'));
      };

      this.setSpecialMessageHandler('_rpc_applicationConnected:', reject, onAppChange);
      return (async () => {
        let [connectedAppIdKey, pageDict] = await this.send('connectToApp', {
          appIdKey
        });

        if (_lodash.default.isEmpty(pageDict)) {
          let msg = 'Empty page dictionary received';

          _logger.default.debug(msg);

          reject(new Error(msg));
        } else {
          resolve([connectedAppIdKey, pageDict]);
        }
      })();
    }).finally(() => {
      this.setSpecialMessageHandler('_rpc_applicationConnected:', null, applicationConnectedHandler);
    });
  }

  async sendMessage(command, opts = {}) {
    let onSocketError;
    return await new _bluebird.default((resolve, reject) => {
      const msgId = this.msgId++;

      const sendOpts = _lodash.default.defaults({
        connId: this.connId,
        senderId: this.senderId
      }, opts);

      const cmd = this.remoteMessages.getRemoteCommand(command, sendOpts);
      let socketCb = _lodash.default.noop;

      onSocketError = exception => {
        if (this.connected) {
          _logger.default.error(`Socket error: ${exception.message}`);
        }

        reject(exception);
      };

      this.socket.on('error', onSocketError);

      if (this.messageHandler.hasSpecialMessageHandler(cmd.__selector)) {
        const specialMessageHandler = this.getSpecialMessageHandler(cmd.__selector);
        this.setSpecialMessageHandler(cmd.__selector, reject, (...args) => {
          const response = this.logFullResponse ? JSON.stringify(args, null, 2) : _lodash.default.truncate(JSON.stringify(args), DATA_LOG_LENGTH);

          _logger.default.debug(`Received response from socket send: '${response}'`);

          specialMessageHandler(...args);

          if (this.messageHandler.hasSpecialMessageHandler(cmd.__selector)) {
            this.setSpecialMessageHandler(cmd.__selector, null, specialMessageHandler);
          }

          resolve(args);
        });
      } else if (cmd.__argument && cmd.__argument.WIRSocketDataKey) {
        const errorHandler = function (err) {
          const msg = `Remote debugger error with code '${err.code}': ${err.message}`;
          reject(new Error(msg));
        };

        this.setDataMessageHandler(msgId.toString(), errorHandler, function dataMessageHandler(value) {
          const msg = _lodash.default.truncate(_lodash.default.isString(value) ? value : JSON.stringify(value), {
            length: 50
          });

          _logger.default.debug(`Received data response from socket send: '${msg}'`);

          _logger.default.debug(`Original command: ${command}`);

          resolve(value);
        });

        if (cmd.__argument.WIRSocketDataKey.params) {
          cmd.__argument.WIRSocketDataKey.params.id = msgId;

          if (!cmd.__argument.WIRSocketDataKey.params.targetId) {
            cmd.__argument.WIRSocketDataKey.params.targetId = `page-${sendOpts.pageIdKey}`;
          }

          if (cmd.__argument.WIRSocketDataKey.params.message) {
            cmd.__argument.WIRSocketDataKey.params.message.id = msgId;
            cmd.__argument.WIRSocketDataKey.params.message = JSON.stringify(cmd.__argument.WIRSocketDataKey.params.message);
          }
        }

        cmd.__argument.WIRSocketDataKey.id = msgId;
        cmd.__argument.WIRSocketDataKey = Buffer.from(JSON.stringify(cmd.__argument.WIRSocketDataKey));
      } else {
        socketCb = resolve;
      }

      _logger.default.debug(`Sending '${cmd.__selector}' message to remote debugger (id: ${msgId})`);

      let plist;

      try {
        plist = _appiumSupport.plist.createBinaryPlist(cmd);
      } catch (e) {
        let msg = `Could not create binary plist from data: ${e.message}`;

        _logger.default.error(msg);

        return reject(new Error(msg));
      }

      if (this.socket && this.connected) {
        this.socket.cork();

        try {
          this.socket.write(_bufferpack.default.pack('L', [plist.length]));
          this.socket.write(plist, socketCb);
        } finally {
          this.socket.uncork();
        }
      } else {
        let msg = 'Attempted to write data to socket after it was closed!';

        _logger.default.error(msg);

        reject(new Error(msg));
      }
    }).finally(() => {
      if (_lodash.default.isFunction(onSocketError)) {
        this.socket.removeListener('error', onSocketError);
      }
    });
  }

  async receive(data) {
    this.received = Buffer.concat([this.received, data]);
    let dataLeftOver = true;

    while (dataLeftOver) {
      const oldReadPos = this.readPos;
      const prefix = this.received.slice(this.readPos, this.readPos + 4);

      if (_lodash.default.isEmpty(prefix)) {
        return;
      }

      let msgLength;

      try {
        msgLength = _bufferpack.default.unpack('L', prefix)[0];
      } catch (err) {
        _logger.default.error(`Buffer could not unpack: ${err}`);

        return;
      }

      this.readPos += 4;

      if (this.received.length < msgLength + this.readPos) {
        this.readPos = oldReadPos;
        break;
      }

      const body = this.received.slice(this.readPos, msgLength + this.readPos);
      let plist;

      try {
        plist = _appiumSupport.plist.parseBinaryPlist(body);
      } catch (e) {
        _logger.default.error(`Error parsing binary plist: ${e}`);

        return;
      }

      if (plist.length === 1) {
        plist = plist[0];
      }

      for (const key of ['WIRMessageDataKey', 'WIRDestinationKey', 'WIRSocketDataKey']) {
        if (!_lodash.default.isUndefined(plist[key])) {
          plist[key] = plist[key].toString('utf8');
        }
      }

      this.readPos += msgLength;
      let leftOver = this.received.length - this.readPos;

      if (leftOver !== 0) {
        let chunk = Buffer.alloc(leftOver);
        this.received.copy(chunk, 0, this.readPos);
        this.received = chunk;
      } else {
        this.received = Buffer.alloc(0);
        dataLeftOver = false;
      }

      this.readPos = 0;

      if (plist) {
        await this.messageHandler.handleMessage(plist);
      }
    }
  }

  setTimelineEventHandler(timelineEventHandler) {
    this.timelineEventHandler = timelineEventHandler;
    this.messageHandler.setTimelineEventHandler(timelineEventHandler);
  }

  setConsoleLogEventHandler(consoleEventHandler) {
    this.consoleEventHandler = consoleEventHandler;
    this.messageHandler.setConsoleLogEventHandler(consoleEventHandler);
  }

  setNetworkLogEventHandler(networkEventHandler) {
    this.networkEventHandler = networkEventHandler;
    this.messageHandler.setNetworkEventHandler(networkEventHandler);
  }

}

exports.default = RemoteDebuggerRpcClient;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXItcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6WyJEQVRBX0xPR19MRU5HVEgiLCJsZW5ndGgiLCJSZW1vdGVEZWJ1Z2dlclJwY0NsaWVudCIsIlJwY0NsaWVudCIsImNvbnN0cnVjdG9yIiwib3B0cyIsInNob3VsZENoZWNrRm9yVGFyZ2V0IiwicGxhdGZvcm1WZXJzaW9uIiwiaXNTYWZhcmkiLCJob3N0IiwicG9ydCIsIlJFTU9URV9ERUJVR0dFUl9QT1JUIiwic29ja2V0UGF0aCIsInNwZWNpYWxNZXNzYWdlSGFuZGxlcnMiLCJtZXNzYWdlUHJveHkiLCJsb2dGdWxsUmVzcG9uc2UiLCJzb2NrZXQiLCJjb25uZWN0ZWQiLCJjb25uSWQiLCJVVUlEIiwiY3JlYXRlIiwidG9TdHJpbmciLCJzZW5kZXJJZCIsIm1zZ0lkIiwicmVjZWl2ZWQiLCJCdWZmZXIiLCJhbGxvYyIsInJlYWRQb3MiLCJzZXRDb21tdW5pY2F0aW9uUHJvdG9jb2wiLCJpc1RhcmdldEJhc2VkIiwibWVzc2FnZUhhbmRsZXIiLCJScGNNZXNzYWdlSGFuZGxlciIsImNvbm5lY3QiLCJsb2ciLCJkZWJ1ZyIsIm5ldCIsIm9uY2UiLCJ3cml0ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJTb2NrZXQiLCJ0eXBlIiwic2V0Tm9EZWxheSIsIm9uIiwicmVjZWl2ZSIsImJpbmQiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsImVyciIsImVycm9yIiwibWVzc2FnZSIsImRpc2Nvbm5lY3QiLCJpc0Nvbm5lY3RlZCIsImRlc3Ryb3kiLCJzZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIiLCJrZXkiLCJlcnJvckhhbmRsZXIiLCJoYW5kbGVyIiwiZ2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyIiwic2V0RGF0YU1lc3NhZ2VIYW5kbGVyIiwiYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCIsImFsbG93Iiwic2VsZWN0QXBwIiwiYXBwSWRLZXkiLCJhcHBsaWNhdGlvbkNvbm5lY3RlZEhhbmRsZXIiLCJvbkFwcENoYW5nZSIsImRpY3QiLCJvbGRBcHBJZEtleSIsIldJUkhvc3RBcHBsaWNhdGlvbklkZW50aWZpZXJLZXkiLCJjb3JyZWN0QXBwSWRLZXkiLCJXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXkiLCJFcnJvciIsImNvbm5lY3RlZEFwcElkS2V5IiwicGFnZURpY3QiLCJzZW5kIiwiXyIsImlzRW1wdHkiLCJtc2ciLCJmaW5hbGx5Iiwic2VuZE1lc3NhZ2UiLCJjb21tYW5kIiwib25Tb2NrZXRFcnJvciIsInNlbmRPcHRzIiwiZGVmYXVsdHMiLCJjbWQiLCJyZW1vdGVNZXNzYWdlcyIsImdldFJlbW90ZUNvbW1hbmQiLCJzb2NrZXRDYiIsIm5vb3AiLCJleGNlcHRpb24iLCJoYXNTcGVjaWFsTWVzc2FnZUhhbmRsZXIiLCJfX3NlbGVjdG9yIiwic3BlY2lhbE1lc3NhZ2VIYW5kbGVyIiwiYXJncyIsInJlc3BvbnNlIiwidHJ1bmNhdGUiLCJfX2FyZ3VtZW50IiwiV0lSU29ja2V0RGF0YUtleSIsImNvZGUiLCJkYXRhTWVzc2FnZUhhbmRsZXIiLCJ2YWx1ZSIsImlzU3RyaW5nIiwicGFyYW1zIiwiaWQiLCJ0YXJnZXRJZCIsInBhZ2VJZEtleSIsImZyb20iLCJwbGlzdCIsInBsaXN0VXRpbHMiLCJjcmVhdGVCaW5hcnlQbGlzdCIsImUiLCJjb3JrIiwiYnVmZmVycGFjayIsInBhY2siLCJ1bmNvcmsiLCJpc0Z1bmN0aW9uIiwicmVtb3ZlTGlzdGVuZXIiLCJkYXRhIiwiY29uY2F0IiwiZGF0YUxlZnRPdmVyIiwib2xkUmVhZFBvcyIsInByZWZpeCIsInNsaWNlIiwibXNnTGVuZ3RoIiwidW5wYWNrIiwiYm9keSIsInBhcnNlQmluYXJ5UGxpc3QiLCJpc1VuZGVmaW5lZCIsImxlZnRPdmVyIiwiY2h1bmsiLCJjb3B5IiwiaGFuZGxlTWVzc2FnZSIsInNldFRpbWVsaW5lRXZlbnRIYW5kbGVyIiwidGltZWxpbmVFdmVudEhhbmRsZXIiLCJzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIiwiY29uc29sZUV2ZW50SGFuZGxlciIsInNldE5ldHdvcmtMb2dFdmVudEhhbmRsZXIiLCJuZXR3b3JrRXZlbnRIYW5kbGVyIiwic2V0TmV0d29ya0V2ZW50SGFuZGxlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxlQUFlLEdBQUc7QUFBQ0MsRUFBQUEsTUFBTSxFQUFFO0FBQVQsQ0FBeEI7O0FBRWUsTUFBTUMsdUJBQU4sU0FBc0NDLGtCQUF0QyxDQUFnRDtBQUM3REMsRUFBQUEsV0FBVyxDQUFFQyxJQUFJLEdBQUcsRUFBVCxFQUFhO0FBQ3RCLFVBQU07QUFDSkMsTUFBQUEsb0JBQW9CLEVBQUU7QUFEbEIsS0FBTjtBQUlBLFVBQU07QUFDSkMsTUFBQUEsZUFBZSxHQUFHLEVBRGQ7QUFFSkMsTUFBQUEsUUFBUSxHQUFHLElBRlA7QUFHSkMsTUFBQUEsSUFBSSxHQUFHLEtBSEg7QUFJSkMsTUFBQUEsSUFBSSxHQUFHQyxvQ0FKSDtBQUtKQyxNQUFBQSxVQUxJO0FBTUpDLE1BQUFBLHNCQUFzQixHQUFHLEVBTnJCO0FBT0pDLE1BQUFBLFlBUEk7QUFRSkMsTUFBQUEsZUFBZSxHQUFHO0FBUmQsUUFTRlYsSUFUSjtBQVlBLFNBQUtJLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtDLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtFLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0UsWUFBTCxHQUFvQkEsWUFBcEI7QUFFQSxTQUFLRSxNQUFMLEdBQWMsSUFBZDtBQUNBLFNBQUtDLFNBQUwsR0FBaUIsS0FBakI7QUFDQSxTQUFLQyxNQUFMLEdBQWNDLGdCQUFLQyxNQUFMLEdBQWNDLFFBQWQsRUFBZDtBQUNBLFNBQUtDLFFBQUwsR0FBZ0JILGdCQUFLQyxNQUFMLEdBQWNDLFFBQWQsRUFBaEI7QUFDQSxTQUFLRSxLQUFMLEdBQWEsQ0FBYjtBQUNBLFNBQUtD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Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgcGxpc3QgYXMgcGxpc3RVdGlscyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBidWZmZXJwYWNrIGZyb20gJ2J1ZmZlcnBhY2snO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgUkVNT1RFX0RFQlVHR0VSX1BPUlQgfSBmcm9tICcuL3JlbW90ZS1kZWJ1Z2dlcic7XG5pbXBvcnQgVVVJRCBmcm9tICd1dWlkLWpzJztcbmltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCBScGNNZXNzYWdlSGFuZGxlciBmcm9tICcuL3JlbW90ZS1kZWJ1Z2dlci1tZXNzYWdlLWhhbmRsZXInO1xuaW1wb3J0IHsgaXNUYXJnZXRCYXNlZCB9IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgUnBjQ2xpZW50IGZyb20gJy4vcnBjLWNsaWVudCc7XG5cblxuY29uc3QgREFUQV9MT0dfTEVOR1RIID0ge2xlbmd0aDogMjAwfTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVtb3RlRGVidWdnZXJScGNDbGllbnQgZXh0ZW5kcyBScGNDbGllbnQge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgc3VwZXIoe1xuICAgICAgc2hvdWxkQ2hlY2tGb3JUYXJnZXQ6IGZhbHNlLFxuICAgIH0pO1xuXG4gICAgY29uc3Qge1xuICAgICAgcGxhdGZvcm1WZXJzaW9uID0ge30sXG4gICAgICBpc1NhZmFyaSA9IHRydWUsXG4gICAgICBob3N0ID0gJzo6MScsXG4gICAgICBwb3J0ID0gUkVNT1RFX0RFQlVHR0VSX1BPUlQsXG4gICAgICBzb2NrZXRQYXRoLFxuICAgICAgc3BlY2lhbE1lc3NhZ2VIYW5kbGVycyA9IHt9LFxuICAgICAgbWVzc2FnZVByb3h5LFxuICAgICAgbG9nRnVsbFJlc3BvbnNlID0gZmFsc2UsXG4gICAgfSA9IG9wdHM7XG5cbiAgICAvLyBob3N0L3BvcnQgY29uZmlnIGZvciBUQ1AgY29tbXVuaWNhdGlvbiwgc29ja2V0UGF0aCBmb3IgdW5peCBkb21haW4gc29ja2V0c1xuICAgIHRoaXMuaG9zdCA9IGhvc3Q7XG4gICAgdGhpcy5wb3J0ID0gcG9ydDtcbiAgICB0aGlzLnNvY2tldFBhdGggPSBzb2NrZXRQYXRoO1xuICAgIHRoaXMubWVzc2FnZVByb3h5ID0gbWVzc2FnZVByb3h5O1xuXG4gICAgdGhpcy5zb2NrZXQgPSBudWxsO1xuICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgdGhpcy5jb25uSWQgPSBVVUlELmNyZWF0ZSgpLnRvU3RyaW5nKCk7XG4gICAgdGhpcy5zZW5kZXJJZCA9IFVVSUQuY3JlYXRlKCkudG9TdHJpbmcoKTtcbiAgICB0aGlzLm1zZ0lkID0gMDtcbiAgICB0aGlzLnJlY2VpdmVkID0gQnVmZmVyLmFsbG9jKDApO1xuICAgIHRoaXMucmVhZFBvcyA9IDA7XG4gICAgdGhpcy5sb2dGdWxsUmVzcG9uc2UgPSBsb2dGdWxsUmVzcG9uc2U7XG5cbiAgICAvLyBtZXNzYWdlIGhhbmRsZXJzXG4gICAgdGhpcy5zcGVjaWFsTWVzc2FnZUhhbmRsZXJzID0gc3BlY2lhbE1lc3NhZ2VIYW5kbGVycztcblxuICAgIC8vIHN0YXJ0IHdpdGggYSBiZXN0IGd1ZXNzIGZvciB0aGUgcHJvdG9jb2xcbiAgICB0aGlzLnNldENvbW11bmljYXRpb25Qcm90b2NvbChpc1RhcmdldEJhc2VkKGlzU2FmYXJpLCBwbGF0Zm9ybVZlcnNpb24pKTtcbiAgfVxuXG4gIHNldENvbW11bmljYXRpb25Qcm90b2NvbCAoaXNUYXJnZXRCYXNlZCA9IGZhbHNlKSB7XG4gICAgc3VwZXIuc2V0Q29tbXVuaWNhdGlvblByb3RvY29sKGlzVGFyZ2V0QmFzZWQpO1xuXG4gICAgaWYgKCF0aGlzLm1lc3NhZ2VIYW5kbGVyKSB7XG4gICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyID0gbmV3IFJwY01lc3NhZ2VIYW5kbGVyKHRoaXMuc3BlY2lhbE1lc3NhZ2VIYW5kbGVycywgaXNUYXJnZXRCYXNlZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0Q29tbXVuaWNhdGlvblByb3RvY29sKGlzVGFyZ2V0QmFzZWQpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QgKCkge1xuICAgIC8vIGNyZWF0ZSBzb2NrZXQgYW5kIGhhbmRsZSBpdHMgbWVzc2FnZXNcbiAgICBpZiAodGhpcy5zb2NrZXRQYXRoKSB7XG4gICAgICBpZiAodGhpcy5tZXNzYWdlUHJveHkpIHtcbiAgICAgICAgLy8gdW5peCBkb21haW4gc29ja2V0IHZpYSBwcm94eVxuICAgICAgICBsb2cuZGVidWcoYENvbm5lY3RpbmcgdG8gcmVtb3RlIGRlYnVnZ2VyIHZpYSBwcm94eSB0aHJvdWdoIHVuaXggZG9tYWluIHNvY2tldDogJyR7dGhpcy5tZXNzYWdlUHJveHl9J2ApO1xuICAgICAgICB0aGlzLnNvY2tldCA9IG5ldC5jb25uZWN0KHRoaXMubWVzc2FnZVByb3h5KTtcblxuICAgICAgICAvLyBGb3J3YXJkIHRoZSBhY3R1YWwgc29ja2V0UGF0aCB0byB0aGUgcHJveHlcbiAgICAgICAgdGhpcy5zb2NrZXQub25jZSgnY29ubmVjdCcsICgpID0+IHtcbiAgICAgICAgICBsb2cuZGVidWcoYEZvcndhcmRpbmcgdGhlIGFjdHVhbCB3ZWIgaW5zcGVjdG9yIHNvY2tldCB0byB0aGUgcHJveHk6ICcke3RoaXMuc29ja2V0UGF0aH0nYCk7XG4gICAgICAgICAgdGhpcy5zb2NrZXQud3JpdGUoSlNPTi5zdHJpbmdpZnkoe3NvY2tldFBhdGg6IHRoaXMuc29ja2V0UGF0aH0pKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHVuaXggZG9tYWluIHNvY2tldFxuICAgICAgICBsb2cuZGVidWcoYENvbm5lY3RpbmcgdG8gcmVtb3RlIGRlYnVnZ2VyIHRocm91Z2ggdW5peCBkb21haW4gc29ja2V0OiAnJHt0aGlzLnNvY2tldFBhdGh9J2ApO1xuICAgICAgICB0aGlzLnNvY2tldCA9IG5ldC5jb25uZWN0KHRoaXMuc29ja2V0UGF0aCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLm1lc3NhZ2VQcm94eSkge1xuICAgICAgICAvLyBjb25uZWN0IHRvIHRoZSBwcm94eSBpbnN0ZWFkIG9mIHRoZSByZW1vdGUgZGVidWdnZXIgZGlyZWN0bHlcbiAgICAgICAgdGhpcy5wb3J0ID0gdGhpcy5tZXNzYWdlUHJveHk7XG4gICAgICB9XG5cbiAgICAgIC8vIHRjcCBzb2NrZXRcbiAgICAgIGxvZy5kZWJ1ZyhgQ29ubmVjdGluZyB0byByZW1vdGUgZGVidWdnZXIgJHt0aGlzLm1lc3NhZ2VQcm94eSA/ICd2aWEgcHJveHkgJyA6ICcnfXRocm91Z2ggVENQOiAke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9YCk7XG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBuZXQuU29ja2V0KHt0eXBlOiAndGNwNid9KTtcbiAgICAgIHRoaXMuc29ja2V0LmNvbm5lY3QodGhpcy5wb3J0LCB0aGlzLmhvc3QpO1xuICAgIH1cblxuICAgIHRoaXMuc29ja2V0LnNldE5vRGVsYXkodHJ1ZSk7XG4gICAgdGhpcy5zb2NrZXQub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRGVidWdnZXIgc29ja2V0IGRpc2Nvbm5lY3RlZCcpO1xuICAgICAgfVxuICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuc29ja2V0ID0gbnVsbDtcbiAgICB9KTtcbiAgICB0aGlzLnNvY2tldC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICB9KTtcbiAgICB0aGlzLnNvY2tldC5vbignZGF0YScsIHRoaXMucmVjZWl2ZS5iaW5kKHRoaXMpKTtcblxuICAgIC8vIGNvbm5lY3QgdGhlIHNvY2tldFxuICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBvbmx5IHJlc29sdmUgdGhpcyBmdW5jdGlvbiB3aGVuIHdlIGFyZSBhY3R1YWxseSBjb25uZWN0ZWRcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdjb25uZWN0JywgKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoYERlYnVnZ2VyIHNvY2tldCBjb25uZWN0ZWRgKTtcbiAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSB0cnVlO1xuXG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHtcbiAgICAgICAgICBsb2cuZXJyb3IoYFNvY2tldCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gdGhlIGNvbm5lY3Rpb24gd2FzIHJlZnVzZWQsIHNvIHJlamVjdCB0aGUgY29ubmVjdCBwcm9taXNlXG4gICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkaXNjb25uZWN0ICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgaWYgKHRoaXMuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgbG9nLmRlYnVnKCdEaXNjb25uZWN0aW5nIGZyb20gcmVtb3RlIGRlYnVnZ2VyJyk7XG4gICAgICB0aGlzLnNvY2tldC5kZXN0cm95KCk7XG4gICAgfVxuICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gIH1cblxuICBpc0Nvbm5lY3RlZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdGVkO1xuICB9XG5cbiAgc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyIChrZXksIGVycm9ySGFuZGxlciwgaGFuZGxlcikge1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGtleSwgZXJyb3JIYW5kbGVyLCBoYW5kbGVyKTtcbiAgfVxuXG4gIGdldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5KSB7XG4gICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuZ2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGtleSk7XG4gIH1cblxuICBzZXREYXRhTWVzc2FnZUhhbmRsZXIgKGtleSwgZXJyb3JIYW5kbGVyLCBoYW5kbGVyKSB7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlci5zZXREYXRhTWVzc2FnZUhhbmRsZXIoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpO1xuICB9XG5cbiAgYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCAoYWxsb3cgPSB0cnVlKSB7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlci5hbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkKGFsbG93KTtcbiAgfVxuXG4gIGFzeW5jIHNlbGVjdEFwcCAoYXBwSWRLZXksIGFwcGxpY2F0aW9uQ29ubmVjdGVkSGFuZGxlcikge1xuICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBsb2NhbCBjYWxsYmFjaywgdGVtcG9yYXJpbHkgYWRkZWQgYXMgY2FsbGJhY2sgdG9cbiAgICAgIC8vIGBfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOmAgcmVtb3RlIGRlYnVnZ2VyIHJlc3BvbnNlXG4gICAgICAvLyB0byBoYW5kbGUgdGhlIGluaXRpYWwgY29ubmVjdGlvblxuICAgICAgbGV0IG9uQXBwQ2hhbmdlID0gKGRpY3QpID0+IHtcbiAgICAgICAgLy8gZnJvbSB0aGUgZGljdGlvbmFyeSByZXR1cm5lZCwgZ2V0IHRoZSBpZHNcbiAgICAgICAgbGV0IG9sZEFwcElkS2V5ID0gZGljdC5XSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICAgICAgICBsZXQgY29ycmVjdEFwcElkS2V5ID0gZGljdC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG5cbiAgICAgICAgLy8gaWYgdGhpcyBpcyBhIHJlcG9ydCBvZiBhIHByb3h5IHJlZGlyZWN0IGZyb20gdGhlIHJlbW90ZSBkZWJ1Z2dlclxuICAgICAgICAvLyB3ZSB3YW50IHRvIHVwZGF0ZSBvdXIgZGljdGlvbmFyeSBhbmQgZ2V0IGEgbmV3IGFwcCBpZFxuICAgICAgICBpZiAob2xkQXBwSWRLZXkgJiYgY29ycmVjdEFwcElkS2V5ICE9PSBvbGRBcHBJZEtleSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2Ugd2VyZSBub3RpZmllZCB3ZSBtaWdodCBoYXZlIGNvbm5lY3RlZCB0byB0aGUgd3JvbmcgYXBwLiBgICtcbiAgICAgICAgICAgICAgICAgICAgYFVzaW5nIGlkICR7Y29ycmVjdEFwcElkS2V5fSBpbnN0ZWFkIG9mICR7b2xkQXBwSWRLZXl9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBhcHBsaWNhdGlvbkNvbm5lY3RlZEhhbmRsZXIoZGljdCk7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ05ldyBhcHBsaWNhdGlvbiBoYXMgY29ubmVjdGVkJykpO1xuICAgICAgfTtcbiAgICAgIHRoaXMuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKCdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOicsIHJlamVjdCwgb25BcHBDaGFuZ2UpO1xuXG4gICAgICAvLyBkbyB0aGUgYWN0dWFsIGNvbm5lY3RpbmcgdG8gdGhlIGFwcFxuICAgICAgcmV0dXJuIChhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCBbY29ubmVjdGVkQXBwSWRLZXksIHBhZ2VEaWN0XSA9IGF3YWl0IHRoaXMuc2VuZCgnY29ubmVjdFRvQXBwJywge1xuICAgICAgICAgIGFwcElkS2V5XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIHNvbWV0aW1lcyB0aGUgY29ubmVjdCBsb2dpYyBoYXBwZW5zLCBidXQgd2l0aCBhbiBlbXB0eSBkaWN0aW9uYXJ5XG4gICAgICAgIC8vIHdoaWNoIGxlYWRzIHRvIHRoZSByZW1vdGUgZGVidWdnZXIgZ2V0dGluZyBkaXNjb25uZWN0ZWQsIGFuZCBpbnRvIGEgbG9vcFxuICAgICAgICBpZiAoXy5pc0VtcHR5KHBhZ2VEaWN0KSkge1xuICAgICAgICAgIGxldCBtc2cgPSAnRW1wdHkgcGFnZSBkaWN0aW9uYXJ5IHJlY2VpdmVkJztcbiAgICAgICAgICBsb2cuZGVidWcobXNnKTtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKG1zZykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc29sdmUoW2Nvbm5lY3RlZEFwcElkS2V5LCBwYWdlRGljdF0pO1xuICAgICAgICB9XG4gICAgICB9KSgpO1xuICAgIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgLy8gbm8gbWF0dGVyIHdoYXQsIHdlIHdhbnQgdG8gcmVzdG9yZSB0aGUgaGFuZGxlciB0aGF0IHdhcyBjaGFuZ2VkLlxuICAgICAgdGhpcy5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JywgbnVsbCwgYXBwbGljYXRpb25Db25uZWN0ZWRIYW5kbGVyKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRNZXNzYWdlIChjb21tYW5kLCBvcHRzID0ge30pIHtcbiAgICAvLyBlcnJvciBsaXN0ZW5lciwgd2hpY2ggbmVlZHMgdG8gYmUgcmVtb3ZlZCBhZnRlciB0aGUgcHJvbWlzZSBpcyByZXNvbHZlZFxuICAgIGxldCBvblNvY2tldEVycm9yO1xuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIHByb21pc2UgdG8gYmUgcmVzb2x2ZWQgd2hlbmV2ZXIgcmVtb3RlIGRlYnVnZ2VyXG4gICAgICAvLyByZXBsaWVzIHRvIG91ciByZXF1ZXN0XG5cbiAgICAgIC8vIGtlZXAgdHJhY2sgb2YgdGhlIG1lc3NhZ2VzIGNvbWluZyBhbmQgZ29pbmcgdXNpbmcgYSBzaW1wbGUgc2VxdWVudGlhbCBpZFxuICAgICAgY29uc3QgbXNnSWQgPSB0aGlzLm1zZ0lkKys7XG5cbiAgICAgIC8vIHJldHJpZXZlIHRoZSBjb3JyZWN0IGNvbW1hbmQgdG8gc2VuZFxuICAgICAgY29uc3Qgc2VuZE9wdHMgPSBfLmRlZmF1bHRzKHtjb25uSWQ6IHRoaXMuY29ubklkLCBzZW5kZXJJZDogdGhpcy5zZW5kZXJJZH0sIG9wdHMpO1xuICAgICAgY29uc3QgY21kID0gdGhpcy5yZW1vdGVNZXNzYWdlcy5nZXRSZW1vdGVDb21tYW5kKGNvbW1hbmQsIHNlbmRPcHRzKTtcblxuICAgICAgLy8gbW9zdCBvZiB0aGUgdGltZSB3ZSBkb24ndCBjYXJlIHdoZW4gc29ja2V0LndyaXRlIGRvZXNcbiAgICAgIC8vIHNvIGdpdmUgaXQgYW4gZW1wdHkgZnVuY3Rpb25cbiAgICAgIGxldCBzb2NrZXRDYiA9IF8ubm9vcDtcblxuICAgICAgLy8gaGFuZGxlIHNvY2tldCBwcm9ibGVtc1xuICAgICAgb25Tb2NrZXRFcnJvciA9IChleGNlcHRpb24pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBTb2NrZXQgZXJyb3I6ICR7ZXhjZXB0aW9uLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB0aGUgY29ubmVjdGlvbiB3YXMgcmVmdXNlZCwgc28gcmVqZWN0IHRoZSBjb25uZWN0IHByb21pc2VcbiAgICAgICAgcmVqZWN0KGV4Y2VwdGlvbik7XG4gICAgICB9O1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgb25Tb2NrZXRFcnJvcik7XG5cbiAgICAgIGlmICh0aGlzLm1lc3NhZ2VIYW5kbGVyLmhhc1NwZWNpYWxNZXNzYWdlSGFuZGxlcihjbWQuX19zZWxlY3RvcikpIHtcbiAgICAgICAgLy8gc3BlY2lhbCByZXBsaWVzIHdpbGwgcmV0dXJuIGFueSBudW1iZXIgb2YgYXJndW1lbnRzXG4gICAgICAgIC8vIHRlbXBvcmFyaWx5IHdyYXAgd2l0aCBwcm9taXNlIGhhbmRsaW5nXG4gICAgICAgIGNvbnN0IHNwZWNpYWxNZXNzYWdlSGFuZGxlciA9IHRoaXMuZ2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGNtZC5fX3NlbGVjdG9yKTtcbiAgICAgICAgdGhpcy5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoY21kLl9fc2VsZWN0b3IsIHJlamVjdCwgKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHRoaXMubG9nRnVsbFJlc3BvbnNlXG4gICAgICAgICAgICA/IEpTT04uc3RyaW5naWZ5KGFyZ3MsIG51bGwsIDIpXG4gICAgICAgICAgICA6IF8udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoYXJncyksIERBVEFfTE9HX0xFTkdUSCk7XG4gICAgICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCByZXNwb25zZSBmcm9tIHNvY2tldCBzZW5kOiAnJHtyZXNwb25zZX0nYCk7XG5cbiAgICAgICAgICAvLyBjYWxsIHRoZSBvcmlnaW5hbCBsaXN0ZW5lciwgYW5kIHB1dCBpdCBiYWNrLCBpZiBuZWNlc3NhcnlcbiAgICAgICAgICBzcGVjaWFsTWVzc2FnZUhhbmRsZXIoLi4uYXJncyk7XG4gICAgICAgICAgaWYgKHRoaXMubWVzc2FnZUhhbmRsZXIuaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGNtZC5fX3NlbGVjdG9yKSkge1xuICAgICAgICAgICAgLy8gdGhpcyBtZWFucyB0aGF0IHRoZSBzeXN0ZW0gaGFzIG5vdCByZW1vdmVkIHRoaXMgbGlzdGVuZXJcbiAgICAgICAgICAgIHRoaXMuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKGNtZC5fX3NlbGVjdG9yLCBudWxsLCBzcGVjaWFsTWVzc2FnZUhhbmRsZXIpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJlc29sdmUoYXJncyk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChjbWQuX19hcmd1bWVudCAmJiBjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5KSB7XG4gICAgICAgIGNvbnN0IGVycm9ySGFuZGxlciA9IGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICBjb25zdCBtc2cgPSBgUmVtb3RlIGRlYnVnZ2VyIGVycm9yIHdpdGggY29kZSAnJHtlcnIuY29kZX0nOiAke2Vyci5tZXNzYWdlfWA7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihtc2cpKTtcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnNldERhdGFNZXNzYWdlSGFuZGxlcihtc2dJZC50b1N0cmluZygpLCBlcnJvckhhbmRsZXIsIGZ1bmN0aW9uIGRhdGFNZXNzYWdlSGFuZGxlciAodmFsdWUpIHtcbiAgICAgICAgICBjb25zdCBtc2cgPSBfLnRydW5jYXRlKF8uaXNTdHJpbmcodmFsdWUpID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSksIHtsZW5ndGg6IDUwfSk7XG4gICAgICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBkYXRhIHJlc3BvbnNlIGZyb20gc29ja2V0IHNlbmQ6ICcke21zZ30nYCk7XG4gICAgICAgICAgbG9nLmRlYnVnKGBPcmlnaW5hbCBjb21tYW5kOiAke2NvbW1hbmR9YCk7XG4gICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0aGUgbWVzc2FnZSBiZWluZyBzZW50IGhhcyBhbGwgdGhlIGluZm9ybWF0aW9uIHRoYXQgaXMgbmVlZGVkXG4gICAgICAgIGlmIChjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcykge1xuICAgICAgICAgIGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zLmlkID0gbXNnSWQ7XG4gICAgICAgICAgaWYgKCFjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcy50YXJnZXRJZCkge1xuICAgICAgICAgICAgY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMudGFyZ2V0SWQgPSBgcGFnZS0ke3NlbmRPcHRzLnBhZ2VJZEtleX1gO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMubWVzc2FnZSkge1xuICAgICAgICAgICAgY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMubWVzc2FnZS5pZCA9IG1zZ0lkO1xuICAgICAgICAgICAgY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMubWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zLm1lc3NhZ2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LmlkID0gbXNnSWQ7XG4gICAgICAgIGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkgPVxuICAgICAgICAgIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHdlIHdhbnQgdG8gaW1tZWRpYXRlbHkgcmVzb2x2ZSB0aGlzIHNvY2tldC53cml0ZVxuICAgICAgICAvLyBhbnkgbG9uZyB0ZXJtIGNhbGxiYWNrcyB3aWxsIGRvIHRoZWlyIGJ1c2luZXNzIGluIHRoZSBiYWNrZ3JvdW5kXG4gICAgICAgIHNvY2tldENiID0gcmVzb2x2ZTtcbiAgICAgIH1cblxuICAgICAgbG9nLmRlYnVnKGBTZW5kaW5nICcke2NtZC5fX3NlbGVjdG9yfScgbWVzc2FnZSB0byByZW1vdGUgZGVidWdnZXIgKGlkOiAke21zZ0lkfSlgKTtcblxuICAgICAgLy8gcmVtb3RlIGRlYnVnZ2VyIGV4cGVjdHMgYSBiaW5hcnkgcGxpc3QgYXMgZGF0YVxuICAgICAgbGV0IHBsaXN0O1xuICAgICAgdHJ5IHtcbiAgICAgICAgcGxpc3QgPSBwbGlzdFV0aWxzLmNyZWF0ZUJpbmFyeVBsaXN0KGNtZCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxldCBtc2cgPSBgQ291bGQgbm90IGNyZWF0ZSBiaW5hcnkgcGxpc3QgZnJvbSBkYXRhOiAke2UubWVzc2FnZX1gO1xuICAgICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgICAgcmV0dXJuIHJlamVjdChuZXcgRXJyb3IobXNnKSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLnNvY2tldCAmJiB0aGlzLmNvbm5lY3RlZCkge1xuICAgICAgICAvLyBjb3JrIGFuZCB1bmNvcmsgaW4gb3JkZXIgdG8gbm90IGJ1ZmZlciB0aGUgd3JpdGVcbiAgICAgICAgLy8gb24gc29tZSBzeXN0ZW1zIHRoaXMgaXMgbmVjZXNzYXJ5IG9yIHRoZSBzZXJ2ZXJcbiAgICAgICAgLy8gZ2V0cyBjb25mdXNlZC5cbiAgICAgICAgdGhpcy5zb2NrZXQuY29yaygpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHRoaXMuc29ja2V0LndyaXRlKGJ1ZmZlcnBhY2sucGFjaygnTCcsIFtwbGlzdC5sZW5ndGhdKSk7XG4gICAgICAgICAgdGhpcy5zb2NrZXQud3JpdGUocGxpc3QsIHNvY2tldENiKTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICB0aGlzLnNvY2tldC51bmNvcmsoKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IG1zZyA9ICdBdHRlbXB0ZWQgdG8gd3JpdGUgZGF0YSB0byBzb2NrZXQgYWZ0ZXIgaXQgd2FzIGNsb3NlZCEnO1xuICAgICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihtc2cpKTtcbiAgICAgIH1cbiAgICB9KVxuICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgIC8vIHJlbW92ZSB0aGlzIGxpc3RlbmVyLCBzbyB3ZSBkb24ndCBleGhhdXN0IHRoZSBzeXN0ZW1cbiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob25Tb2NrZXRFcnJvcikpIHtcbiAgICAgICAgdGhpcy5zb2NrZXQucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25Tb2NrZXRFcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyByZWNlaXZlIChkYXRhKSB7XG4gICAgLy8gQXBwZW5kIHRoaXMgbmV3IGRhdGEgdG8gdGhlIGV4aXN0aW5nIEJ1ZmZlclxuICAgIHRoaXMucmVjZWl2ZWQgPSBCdWZmZXIuY29uY2F0KFt0aGlzLnJlY2VpdmVkLCBkYXRhXSk7XG4gICAgbGV0IGRhdGFMZWZ0T3ZlciA9IHRydWU7XG5cbiAgICAvLyBQYXJzZSBtdWx0aXBsZSBtZXNzYWdlcyBpbiB0aGUgc2FtZSBwYWNrZXRcbiAgICB3aGlsZSAoZGF0YUxlZnRPdmVyKSB7XG4gICAgICAvLyBTdG9yZSBhIHJlZmVyZW5jZSB0byB3aGVyZSB3ZSB3ZXJlXG4gICAgICBjb25zdCBvbGRSZWFkUG9zID0gdGhpcy5yZWFkUG9zO1xuXG4gICAgICAvLyBSZWFkIHRoZSBwcmVmaXggKHBsaXN0IGxlbmd0aCkgdG8gc2VlIGhvdyBmYXIgdG8gcmVhZCBuZXh0XG4gICAgICAvLyBJdCdzIGFsd2F5cyA0IGJ5dGVzIGxvbmdcbiAgICAgIGNvbnN0IHByZWZpeCA9IHRoaXMucmVjZWl2ZWQuc2xpY2UodGhpcy5yZWFkUG9zLCB0aGlzLnJlYWRQb3MgKyA0KTtcbiAgICAgIGlmIChfLmlzRW1wdHkocHJlZml4KSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxldCBtc2dMZW5ndGg7XG4gICAgICB0cnkge1xuICAgICAgICBtc2dMZW5ndGggPSBidWZmZXJwYWNrLnVucGFjaygnTCcsIHByZWZpeClbMF07XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLmVycm9yKGBCdWZmZXIgY291bGQgbm90IHVucGFjazogJHtlcnJ9YCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gSnVtcCBmb3J3YXJkIDQgYnl0ZXNcbiAgICAgIHRoaXMucmVhZFBvcyArPSA0O1xuXG4gICAgICAvLyBJcyB0aGVyZSBlbm91Z2ggZGF0YSBoZXJlP1xuICAgICAgLy8gSWYgbm90LCBqdW1wIGJhY2sgdG8gb3VyIG9yaWdpbmFsIHBvc2l0aW9uIGFuZCBndGZvXG4gICAgICBpZiAodGhpcy5yZWNlaXZlZC5sZW5ndGggPCBtc2dMZW5ndGggKyB0aGlzLnJlYWRQb3MpIHtcbiAgICAgICAgdGhpcy5yZWFkUG9zID0gb2xkUmVhZFBvcztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIC8vIEV4dHJhY3QgdGhlIG1haW4gYm9keSBvZiB0aGUgbWVzc2FnZSAod2hlcmUgdGhlIHBsaXN0IHNob3VsZCBiZSlcbiAgICAgIGNvbnN0IGJvZHkgPSB0aGlzLnJlY2VpdmVkLnNsaWNlKHRoaXMucmVhZFBvcywgbXNnTGVuZ3RoICsgdGhpcy5yZWFkUG9zKTtcblxuICAgICAgLy8gRXh0cmFjdCB0aGUgcGxpc3RcbiAgICAgIGxldCBwbGlzdDtcbiAgICAgIHRyeSB7XG4gICAgICAgIHBsaXN0ID0gcGxpc3RVdGlscy5wYXJzZUJpbmFyeVBsaXN0KGJvZHkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cuZXJyb3IoYEVycm9yIHBhcnNpbmcgYmluYXJ5IHBsaXN0OiAke2V9YCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gcGxpc3RVdGlscy5wYXJzZUJpbmFyeVBsaXN0IHJldHVybnMgYW4gYXJyYXlcbiAgICAgIGlmIChwbGlzdC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgcGxpc3QgPSBwbGlzdFswXTtcbiAgICAgIH1cblxuICAgICAgZm9yIChjb25zdCBrZXkgb2YgWydXSVJNZXNzYWdlRGF0YUtleScsICdXSVJEZXN0aW5hdGlvbktleScsICdXSVJTb2NrZXREYXRhS2V5J10pIHtcbiAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHBsaXN0W2tleV0pKSB7XG4gICAgICAgICAgcGxpc3Rba2V5XSA9IHBsaXN0W2tleV0udG9TdHJpbmcoJ3V0ZjgnKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBKdW1wIGZvcndhcmQgdGhlIGxlbmd0aCBvZiB0aGUgcGxpc3RcbiAgICAgIHRoaXMucmVhZFBvcyArPSBtc2dMZW5ndGg7XG5cbiAgICAgIC8vIENhbGN1bGF0ZSBob3cgbXVjaCBidWZmZXIgaXMgbGVmdFxuICAgICAgbGV0IGxlZnRPdmVyID0gdGhpcy5yZWNlaXZlZC5sZW5ndGggLSB0aGlzLnJlYWRQb3M7XG5cbiAgICAgIC8vIElzIHRoZXJlIHNvbWUgbGVmdCBvdmVyP1xuICAgICAgaWYgKGxlZnRPdmVyICE9PSAwKSB7XG4gICAgICAgIC8vIENvcHkgd2hhdCdzIGxlZnQgb3ZlciBpbnRvIGEgbmV3IGJ1ZmZlciwgYW5kIHNhdmUgaXQgZm9yIG5leHQgdGltZVxuICAgICAgICBsZXQgY2h1bmsgPSBCdWZmZXIuYWxsb2MobGVmdE92ZXIpO1xuICAgICAgICB0aGlzLnJlY2VpdmVkLmNvcHkoY2h1bmssIDAsIHRoaXMucmVhZFBvcyk7XG4gICAgICAgIHRoaXMucmVjZWl2ZWQgPSBjaHVuaztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE90aGVyd2lzZSwgZW1wdHkgdGhlIGJ1ZmZlciBhbmQgZ2V0IG91dCBvZiB0aGUgbG9vcFxuICAgICAgICB0aGlzLnJlY2VpdmVkID0gQnVmZmVyLmFsbG9jKDApO1xuICAgICAgICBkYXRhTGVmdE92ZXIgPSBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgLy8gUmVzZXQgdGhlIHJlYWQgcG9zaXRpb25cbiAgICAgIHRoaXMucmVhZFBvcyA9IDA7XG5cbiAgICAgIC8vIE5vdyBkbyBzb21ldGhpbmcgd2l0aCB0aGUgcGxpc3RcbiAgICAgIGlmIChwbGlzdCkge1xuICAgICAgICBhd2FpdCB0aGlzLm1lc3NhZ2VIYW5kbGVyLmhhbmRsZU1lc3NhZ2UocGxpc3QpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNldFRpbWVsaW5lRXZlbnRIYW5kbGVyICh0aW1lbGluZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIgPSB0aW1lbGluZUV2ZW50SGFuZGxlcjtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNldFRpbWVsaW5lRXZlbnRIYW5kbGVyKHRpbWVsaW5lRXZlbnRIYW5kbGVyKTtcbiAgfVxuXG4gIHNldENvbnNvbGVMb2dFdmVudEhhbmRsZXIgKGNvbnNvbGVFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLmNvbnNvbGVFdmVudEhhbmRsZXIgPSBjb25zb2xlRXZlbnRIYW5kbGVyO1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0Q29uc29sZUxvZ0V2ZW50SGFuZGxlcihjb25zb2xlRXZlbnRIYW5kbGVyKTtcbiAgfVxuXG4gIHNldE5ldHdvcmtMb2dFdmVudEhhbmRsZXIgKG5ldHdvcmtFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLm5ldHdvcmtFdmVudEhhbmRsZXIgPSBuZXR3b3JrRXZlbnRIYW5kbGVyO1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0TmV0d29ya0V2ZW50SGFuZGxlcihuZXR3b3JrRXZlbnRIYW5kbGVyKTtcbiAgfVxufVxuIl0sImZpbGUiOiJsaWIvcmVtb3RlLWRlYnVnZ2VyLXJwYy1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
