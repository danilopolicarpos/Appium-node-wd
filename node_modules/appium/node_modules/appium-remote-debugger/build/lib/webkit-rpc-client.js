"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _remoteDebugger = require("./remote-debugger");

var _ws = _interopRequireDefault(require("ws"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _helpers = require("./helpers");

var _es6Error = _interopRequireDefault(require("es6-error"));

var _appiumSupport = require("appium-support");

var _rpcClient = _interopRequireDefault(require("./rpc-client"));

const DATA_LOG_LENGTH = {
  length: 200
};

class WebKitRpcClient extends _rpcClient.default {
  constructor(opts = {}) {
    super({
      shouldCheckForTarget: true
    });
    const {
      host,
      port = _remoteDebugger.REMOTE_DEBUGGER_PORT,
      responseTimeout = _remoteDebugger.RPC_RESPONSE_TIMEOUT_MS,
      platformVersion = {},
      isSafari = true
    } = opts;
    this.host = host || 'localhost';
    this.port = port;
    this.responseTimeout = responseTimeout;
    this.platformVersion = platformVersion;
    this.isSafari = isSafari;
    this.curMsgId = 0;
    this.dataHandlers = {};
    this.dataMethods = {};
    this.errorHandlers = {};
    this.setCommunicationProtocol((0, _helpers.isTargetBased)(isSafari, platformVersion));
  }

  async connect(pageId) {
    return await new _bluebird.default((resolve, reject) => {
      const url = `ws://${this.host}:${this.port}/devtools/page/${pageId}`;
      this.pageIdKey = pageId;

      _logger.default.debug(`Connecting to WebKit socket: '${url}'`);

      this.socket = new _ws.default(url);
      this.socket.on('open', () => {
        _logger.default.debug(`WebKit debugger web socket connected to url: ${url}`);

        this.connected = true;
        resolve();
      });
      this.socket.on('close', () => {
        _logger.default.debug('WebKit remote debugger socket disconnected');

        this.connected = false;
      });
      this.socket.on('error', exception => {
        if (this.connected) {
          _logger.default.debug(`WebKit debugger web socket error: ${exception.message}`);

          this.connected = false;
        }

        reject(exception);
      });
      this.socket.on('message', this.receive.bind(this));
    });
  }

  disconnect() {
    _logger.default.debug('Disconnecting from WebKit remote debugger');

    if (this.isConnected()) {
      this.socket.close(1001);
    }

    this.connected = false;
  }

  isConnected() {
    return this.socket !== null && this.connected;
  }

  async sendMessage(command, opts) {
    let data = this.remoteMessages.getRemoteCommand(command, _lodash.default.defaults({
      connId: this.connId,
      senderId: this.senderId
    }, opts));

    _logger.default.debug(`Sending WebKit data: ${_lodash.default.truncate(JSON.stringify(data), DATA_LOG_LENGTH)}`);

    _logger.default.debug(`Webkit response timeout: ${this.responseTimeout}`);

    const msgId = this.curMsgId++;
    data.id = msgId;
    let method = data.method;

    if (this.isTargetBased) {
      method = data.params.message.method;
      data.params.id = msgId;
      data.params.message.id = msgId;
      data.params.message = JSON.stringify(data.params.message);
      data.params.targetId = this.target;
    }

    const id = msgId.toString();
    return await new _bluebird.default((resolve, reject) => {
      this.dataHandlers[id] = resolve;
      this.dataMethods[id] = method;
      this.errorHandlers[id] = reject;
      this.socket.send(JSON.stringify(data), function socketReceipt(error) {
        if (_appiumSupport.util.hasValue(error)) {
          _logger.default.debug(`WebKit socket error occurred: ${error}`);

          reject(new Error(error));
        }
      });
    }).catch(e => {
      if (e.constructor.name !== WebKitRPCWarning.name) {
        throw e;
      }

      _logger.default.warn(e.message);

      return _bluebird.default.resolve();
    }).finally(res => {
      delete this.dataHandlers[id];
      delete this.dataMethods[id];
      delete this.errorHandlers[id];
      return res;
    }).timeout(this.responseTimeout);
  }

  receive(data) {
    const response = this.logFullResponse ? JSON.stringify(data, null, 2) : _lodash.default.truncate(data, DATA_LOG_LENGTH);

    _logger.default.debug(`Received WebKit data: '${response}'`);

    data = _appiumSupport.util.safeJsonParse(data);

    const rejectCall = error => {
      if (data && this.errorHandlers[data.id]) {
        return this.errorHandlers[data.id](error);
      }

      if (error.constructor.name === WebKitRPCWarning.name) {
        _logger.default.warn(error.message);
      } else {
        _logger.default.errorAndThrow(error);
      }
    };

    if (!_lodash.default.isPlainObject(data)) {
      return rejectCall(new WebKitRPCWarning(`No parseable data found`));
    }

    if (data.wasThrown || data.result && data.result.wasThrown) {
      const message = data.wasThrown ? data.result.value || data.result.description : data.result.result.value || data.result.result.description;
      return rejectCall(new Error(message));
    }

    let {
      id: msgId,
      result,
      params,
      error
    } = data;
    let method = this.dataMethods[msgId] || data.method;

    if (this.isTargetBased) {
      if (!_lodash.default.startsWith(data.method, 'Target')) {
        _logger.default.debug(`Received receipt for message '${msgId}'`);

        return;
      }

      if (data.params.message) {
        let message;

        try {
          message = JSON.parse(data.params.message);
        } catch (err) {
          _logger.default.error(`Unable to parse message: ${err.message}`);

          _logger.default.error(`Data:`);

          _logger.default.error(`${JSON.stringify(data, null, 2)}`);
        }

        params = message.params || params;

        if (message.result) {
          result = message.result;

          if (message.result.result) {
            result = message.result.result;

            if (message.result.result.value) {
              result = message.result.result.value;

              if (_lodash.default.isString(result)) {
                try {
                  result = JSON.parse(result);
                } catch (ign) {}
              }
            }
          }
        }

        msgId = message.id;
        method = message.method || method;
      }
    }

    if (!method) {
      return rejectCall(new WebKitRPCWarning(`Did not find any handlers for ${msgId ? `'${msgId}'` : 'recent'} message`));
    }

    _logger.default.debug(`Found method '${method}' ${msgId ? `for message '${msgId}'` : ''}`);

    let isEventHandled = false;

    switch (method) {
      case 'Profiler.resetProfiles':
        _logger.default.debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');

        isEventHandled = true;
        break;

      case 'Timeline.eventRecorded':
        if (this.timelineEventHandler) {
          this.timelineEventHandler(result);
          isEventHandled = true;
        }

        break;

      case 'Console.messagesCleared':
        isEventHandled = true;
        break;

      case 'Console.messageAdded':
        if (this.consoleEventHandler) {
          this.consoleEventHandler(params.message);
          isEventHandled = true;
        }

        break;

      case 'Page.navigate':
        _logger.default.debug(`Received page navigated message: ${(0, _helpers.simpleStringify)(data)}`);

        isEventHandled = true;
        break;

      case 'Network.dataReceived':
      case 'Network.requestWillBeSent':
      case 'Network.responseReceived':
      case 'Network.loadingFinished':
      case 'Network.loadingFailed':
        if (_lodash.default.isFunction(this.networkEventHandler)) {
          this.networkEventHandler(method, params);
          return;
        }

        break;

      case 'Target.targetCreated':
        this.addTarget(params.targetInfo);
        isEventHandled = true;
        break;

      case 'Target.targetDestroyed':
        this.removeTarget(params);
        isEventHandled = true;
        break;
    }

    if (!data.error && _lodash.default.has(this.dataHandlers, msgId)) {
      return this.dataHandlers[msgId](result);
    }

    if (data.error && _lodash.default.has(this.errorHandlers, msgId)) {
      return this.errorHandlers[msgId](error);
    }

    if (!isEventHandled) {
      _logger.default.debug(`There is no handler scheduled for method '${method}' in ${msgId ? `message '${msgId}'` : 'recent messages'}`);
    }
  }

  setTimelineEventHandler(timelineEventHandler) {
    this.timelineEventHandler = timelineEventHandler;
  }

  setConsoleLogEventHandler(consoleEventHandler) {
    this.consoleEventHandler = consoleEventHandler;
  }

  setNetworkLogEventHandler(networkEventHandler) {
    this.networkEventHandler = networkEventHandler;
  }

}

exports.default = WebKitRpcClient;

class WebKitRPCWarning extends _es6Error.default {}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6WyJEQVRBX0xPR19MRU5HVEgiLCJsZW5ndGgiLCJXZWJLaXRScGNDbGllbnQiLCJScGNDbGllbnQiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJzaG91bGRDaGVja0ZvclRhcmdldCIsImhvc3QiLCJwb3J0IiwiUkVNT1RFX0RFQlVHR0VSX1BPUlQiLCJyZXNwb25zZVRpbWVvdXQiLCJSUENfUkVTUE9OU0VfVElNRU9VVF9NUyIsInBsYXRmb3JtVmVyc2lvbiIsImlzU2FmYXJpIiwiY3VyTXNnSWQiLCJkYXRhSGFuZGxlcnMiLCJkYXRhTWV0aG9kcyIsImVycm9ySGFuZGxlcnMiLCJzZXRDb21tdW5pY2F0aW9uUHJvdG9jb2wiLCJjb25uZWN0IiwicGFnZUlkIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJ1cmwiLCJwYWdlSWRLZXkiLCJsb2ciLCJkZWJ1ZyIsInNvY2tldCIsIldlYlNvY2tldCIsIm9uIiwiY29ubmVjdGVkIiwiZXhjZXB0aW9uIiwibWVzc2FnZSIsInJlY2VpdmUiLCJiaW5kIiwiZGlzY29ubmVjdCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJzZW5kTWVzc2FnZSIsImNvbW1hbmQiLCJkYXRhIiwicmVtb3RlTWVzc2FnZXMiLCJnZXRSZW1vdGVDb21tYW5kIiwiXyIsImRlZmF1bHRzIiwiY29ubklkIiwic2VuZGVySWQiLCJ0cnVuY2F0ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJtc2dJZCIsImlkIiwibWV0aG9kIiwiaXNUYXJnZXRCYXNlZCIsInBhcmFtcyIsInRhcmdldElkIiwidGFyZ2V0IiwidG9TdHJpbmciLCJzZW5kIiwic29ja2V0UmVjZWlwdCIsImVycm9yIiwidXRpbCIsImhhc1ZhbHVlIiwiRXJyb3IiLCJjYXRjaCIsImUiLCJuYW1lIiwiV2ViS2l0UlBDV2FybmluZyIsIndhcm4iLCJmaW5hbGx5IiwicmVzIiwidGltZW91dCIsInJlc3BvbnNlIiwibG9nRnVsbFJlc3BvbnNlIiwic2FmZUpzb25QYXJzZSIsInJlamVjdENhbGwiLCJlcnJvckFuZFRocm93IiwiaXNQbGFpbk9iamVjdCIsIndhc1Rocm93biIsInJlc3VsdCIsInZhbHVlIiwiZGVzY3JpcHRpb24iLCJzdGFydHNXaXRoIiwicGFyc2UiLCJlcnIiLCJpc1N0cmluZyIsImlnbiIsImlzRXZlbnRIYW5kbGVkIiwidGltZWxpbmVFdmVudEhhbmRsZXIiLCJjb25zb2xlRXZlbnRIYW5kbGVyIiwiaXNGdW5jdGlvbiIsIm5ldHdvcmtFdmVudEhhbmRsZXIiLCJhZGRUYXJnZXQiLCJ0YXJnZXRJbmZvIiwicmVtb3ZlVGFyZ2V0IiwiaGFzIiwic2V0VGltZWxpbmVFdmVudEhhbmRsZXIiLCJzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIiwic2V0TmV0d29ya0xvZ0V2ZW50SGFuZGxlciIsIkVTNkVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLGVBQWUsR0FBRztBQUFDQyxFQUFBQSxNQUFNLEVBQUU7QUFBVCxDQUF4Qjs7QUFFZSxNQUFNQyxlQUFOLFNBQThCQyxrQkFBOUIsQ0FBd0M7QUFDckRDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFBYTtBQUN0QixVQUFNO0FBQ0pDLE1BQUFBLG9CQUFvQixFQUFFO0FBRGxCLEtBQU47QUFJQSxVQUFNO0FBQ0pDLE1BQUFBLElBREk7QUFFSkMsTUFBQUEsSUFBSSxHQUFHQyxvQ0FGSDtBQUdKQyxNQUFBQSxlQUFlLEdBQUdDLHVDQUhkO0FBSUpDLE1BQUFBLGVBQWUsR0FBRyxFQUpkO0FBS0pDLE1BQUFBLFFBQVEsR0FBRztBQUxQLFFBTUZSLElBTko7QUFRQSxTQUFLRSxJQUFMLEdBQVlBLElBQUksSUFBSSxXQUFwQjtBQUNBLFNBQUtDLElBQUwsR0FBWUEsSUFBWjtBQUVBLFNBQUtFLGVBQUwsR0FBdUJBLGVBQXZCO0FBRUEs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WUFBV0EsS0FBTSxHQUFyQixHQUEwQixpQkFBa0IsRUFBdEg7QUFDRDtBQUNGOztBQUVEOEMsRUFBQUEsdUJBQXVCLENBQUVSLG9CQUFGLEVBQXdCO0FBQzdDLFNBQUtBLG9CQUFMLEdBQTRCQSxvQkFBNUI7QUFDRDs7QUFFRFMsRUFBQUEseUJBQXlCLENBQUVSLG1CQUFGLEVBQXVCO0FBQzlDLFNBQUtBLG1CQUFMLEdBQTJCQSxtQkFBM0I7QUFDRDs7QUFFRFMsRUFBQUEseUJBQXlCLENBQUVQLG1CQUFGLEVBQXVCO0FBQzlDLFNBQUtBLG1CQUFMLEdBQTJCQSxtQkFBM0I7QUFDRDs7QUEzUm9EOzs7O0FBK1J2RCxNQUFNeEIsZ0JBQU4sU0FBK0JnQyxpQkFBL0IsQ0FBd0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IFJFTU9URV9ERUJVR0dFUl9QT1JULCBSUENfUkVTUE9OU0VfVElNRU9VVF9NUyB9IGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHNpbXBsZVN0cmluZ2lmeSwgaXNUYXJnZXRCYXNlZCB9IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgRVM2RXJyb3IgZnJvbSAnZXM2LWVycm9yJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgUnBjQ2xpZW50IGZyb20gJy4vcnBjLWNsaWVudCc7XG5cblxuY29uc3QgREFUQV9MT0dfTEVOR1RIID0ge2xlbmd0aDogMjAwfTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2ViS2l0UnBjQ2xpZW50IGV4dGVuZHMgUnBjQ2xpZW50IHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIHN1cGVyKHtcbiAgICAgIHNob3VsZENoZWNrRm9yVGFyZ2V0OiB0cnVlLFxuICAgIH0pO1xuXG4gICAgY29uc3Qge1xuICAgICAgaG9zdCxcbiAgICAgIHBvcnQgPSBSRU1PVEVfREVCVUdHRVJfUE9SVCxcbiAgICAgIHJlc3BvbnNlVGltZW91dCA9IFJQQ19SRVNQT05TRV9USU1FT1VUX01TLFxuICAgICAgcGxhdGZvcm1WZXJzaW9uID0ge30sXG4gICAgICBpc1NhZmFyaSA9IHRydWUsXG4gICAgfSA9IG9wdHM7XG5cbiAgICB0aGlzLmhvc3QgPSBob3N0IHx8ICdsb2NhbGhvc3QnO1xuICAgIHRoaXMucG9ydCA9IHBvcnQ7XG5cbiAgICB0aGlzLnJlc3BvbnNlVGltZW91dCA9IHJlc3BvbnNlVGltZW91dDtcblxuICAgIHRoaXMucGxhdGZvcm1WZXJzaW9uID0gcGxhdGZvcm1WZXJzaW9uO1xuICAgIHRoaXMuaXNTYWZhcmkgPSBpc1NhZmFyaTtcblxuICAgIHRoaXMuY3VyTXNnSWQgPSAwO1xuXG4gICAgdGhpcy5kYXRhSGFuZGxlcnMgPSB7fTtcbiAgICB0aGlzLmRhdGFNZXRob2RzID0ge307XG4gICAgdGhpcy5lcnJvckhhbmRsZXJzID0ge307XG5cbiAgICAvLyBzdGFydCB3aXRoIGEgYmVzdCBndWVzcyBmb3IgdGhlIHByb3RvY29sXG4gICAgdGhpcy5zZXRDb21tdW5pY2F0aW9uUHJvdG9jb2woaXNUYXJnZXRCYXNlZChpc1NhZmFyaSwgcGxhdGZvcm1WZXJzaW9uKSk7XG4gIH1cblxuICBhc3luYyBjb25uZWN0IChwYWdlSWQpIHtcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gd2Ugd2lsbCBvbmx5IHJlc29sdmUgdGhpcyBjYWxsIHdoZW4gdGhlIHNvY2tldCBpcyBvcGVuXG4gICAgICAvLyBXZWJLaXQgdXJsXG4gICAgICBjb25zdCB1cmwgPSBgd3M6Ly8ke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9L2RldnRvb2xzL3BhZ2UvJHtwYWdlSWR9YDtcbiAgICAgIHRoaXMucGFnZUlkS2V5ID0gcGFnZUlkO1xuXG4gICAgICAvLyBjcmVhdGUgYW5kIHNldCB1cCBzb2NrZXQgd2l0aCBhcHByb3ByaWF0ZSBldmVudCBoYW5kbGVyc1xuICAgICAgbG9nLmRlYnVnKGBDb25uZWN0aW5nIHRvIFdlYktpdCBzb2NrZXQ6ICcke3VybH0nYCk7XG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBXZWJTb2NrZXQodXJsKTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdvcGVuJywgKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoYFdlYktpdCBkZWJ1Z2dlciB3ZWIgc29ja2V0IGNvbm5lY3RlZCB0byB1cmw6ICR7dXJsfWApO1xuICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWU7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoJ1dlYktpdCByZW1vdGUgZGVidWdnZXIgc29ja2V0IGRpc2Nvbm5lY3RlZCcpO1xuICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignZXJyb3InLCAoZXhjZXB0aW9uKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmNvbm5lY3RlZCkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2ViS2l0IGRlYnVnZ2VyIHdlYiBzb2NrZXQgZXJyb3I6ICR7ZXhjZXB0aW9uLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlamVjdChleGNlcHRpb24pO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignbWVzc2FnZScsIHRoaXMucmVjZWl2ZS5iaW5kKHRoaXMpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGRpc2Nvbm5lY3QgKCkge1xuICAgIGxvZy5kZWJ1ZygnRGlzY29ubmVjdGluZyBmcm9tIFdlYktpdCByZW1vdGUgZGVidWdnZXInKTtcbiAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICB0aGlzLnNvY2tldC5jbG9zZSgxMDAxKTtcbiAgICB9XG4gICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGlzQ29ubmVjdGVkICgpIHtcbiAgICByZXR1cm4gKHRoaXMuc29ja2V0ICE9PSBudWxsICYmIHRoaXMuY29ubmVjdGVkKTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRNZXNzYWdlIChjb21tYW5kLCBvcHRzKSB7XG4gICAgbGV0IGRhdGEgPSB0aGlzLnJlbW90ZU1lc3NhZ2VzLmdldFJlbW90ZUNvbW1hbmQoY29tbWFuZCwgXy5kZWZhdWx0cyh7Y29ubklkOiB0aGlzLmNvbm5JZCwgc2VuZGVySWQ6IHRoaXMuc2VuZGVySWR9LCBvcHRzKSk7XG5cbiAgICBsb2cuZGVidWcoYFNlbmRpbmcgV2ViS2l0IGRhdGE6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShkYXRhKSwgREFUQV9MT0dfTEVOR1RIKX1gKTtcbiAgICBsb2cuZGVidWcoYFdlYmtpdCByZXNwb25zZSB0aW1lb3V0OiAke3RoaXMucmVzcG9uc2VUaW1lb3V0fWApO1xuXG4gICAgY29uc3QgbXNnSWQgPSB0aGlzLmN1ck1zZ0lkKys7XG4gICAgZGF0YS5pZCA9IG1zZ0lkO1xuXG4gICAgbGV0IG1ldGhvZCA9IGRhdGEubWV0aG9kO1xuICAgIGlmICh0aGlzLmlzVGFyZ2V0QmFzZWQpIHtcbiAgICAgIG1ldGhvZCA9IGRhdGEucGFyYW1zLm1lc3NhZ2UubWV0aG9kO1xuXG4gICAgICBkYXRhLnBhcmFtcy5pZCA9IG1zZ0lkO1xuICAgICAgZGF0YS5wYXJhbXMubWVzc2FnZS5pZCA9IG1zZ0lkO1xuICAgICAgZGF0YS5wYXJhbXMubWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KGRhdGEucGFyYW1zLm1lc3NhZ2UpO1xuICAgICAgZGF0YS5wYXJhbXMudGFyZ2V0SWQgPSB0aGlzLnRhcmdldDtcbiAgICB9XG5cbiAgICBjb25zdCBpZCA9IG1zZ0lkLnRvU3RyaW5nKCk7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIG9ubHkgcmVzb2x2ZSB0aGUgc2VuZCBjb21tYW5kIHdoZW4gV2ViS2l0IHJldHVybnMgYSByZXNwb25zZVxuICAgICAgLy8gc3RvcmUgdGhlIGhhbmRsZXIgYW5kIHRoZSBkYXRhIHNlbnRcbiAgICAgIHRoaXMuZGF0YUhhbmRsZXJzW2lkXSA9IHJlc29sdmU7XG4gICAgICB0aGlzLmRhdGFNZXRob2RzW2lkXSA9IG1ldGhvZDtcbiAgICAgIHRoaXMuZXJyb3JIYW5kbGVyc1tpZF0gPSByZWplY3Q7XG5cbiAgICAgIC8vIHNlbmQgdGhlIGRhdGFcbiAgICAgIHRoaXMuc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoZGF0YSksIGZ1bmN0aW9uIHNvY2tldFJlY2VpcHQgKGVycm9yKSB7XG4gICAgICAgIGlmICh1dGlsLmhhc1ZhbHVlKGVycm9yKSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2ViS2l0IHNvY2tldCBlcnJvciBvY2N1cnJlZDogJHtlcnJvcn1gKTtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGVycm9yKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pLmNhdGNoKChlKSA9PiB7XG4gICAgICBpZiAoZS5jb25zdHJ1Y3Rvci5uYW1lICE9PSBXZWJLaXRSUENXYXJuaW5nLm5hbWUpIHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICAgIGxvZy53YXJuKGUubWVzc2FnZSk7XG4gICAgICByZXR1cm4gQi5yZXNvbHZlKCk7XG4gICAgfSkuZmluYWxseSgocmVzKSA9PiB7XG4gICAgICAvLyBubyBuZWVkIHRvIGhvbGQgb250byBhbnl0aGluZ1xuICAgICAgZGVsZXRlIHRoaXMuZGF0YUhhbmRsZXJzW2lkXTtcbiAgICAgIGRlbGV0ZSB0aGlzLmRhdGFNZXRob2RzW2lkXTtcbiAgICAgIGRlbGV0ZSB0aGlzLmVycm9ySGFuZGxlcnNbaWRdO1xuXG4gICAgICAvLyBhbmQgcGFzcyBhbG9uZyB0aGUgcmVzdWx0XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH0pLnRpbWVvdXQodGhpcy5yZXNwb25zZVRpbWVvdXQpO1xuICB9XG5cbiAgcmVjZWl2ZSAoZGF0YSkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gdGhpcy5sb2dGdWxsUmVzcG9uc2VcbiAgICAgID8gSlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgMilcbiAgICAgIDogXy50cnVuY2F0ZShkYXRhLCBEQVRBX0xPR19MRU5HVEgpO1xuICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgV2ViS2l0IGRhdGE6ICcke3Jlc3BvbnNlfSdgKTtcbiAgICBkYXRhID0gdXRpbC5zYWZlSnNvblBhcnNlKGRhdGEpO1xuXG4gICAgY29uc3QgcmVqZWN0Q2FsbCA9IChlcnJvcikgPT4ge1xuICAgICAgaWYgKGRhdGEgJiYgdGhpcy5lcnJvckhhbmRsZXJzW2RhdGEuaWRdKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmVycm9ySGFuZGxlcnNbZGF0YS5pZF0oZXJyb3IpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZXJyb3IuY29uc3RydWN0b3IubmFtZSA9PT0gV2ViS2l0UlBDV2FybmluZy5uYW1lKSB7XG4gICAgICAgIGxvZy53YXJuKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coZXJyb3IpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChkYXRhKSkge1xuICAgICAgcmV0dXJuIHJlamVjdENhbGwobmV3IFdlYktpdFJQQ1dhcm5pbmcoYE5vIHBhcnNlYWJsZSBkYXRhIGZvdW5kYCkpO1xuICAgIH1cblxuICAgIC8vIHdlIGNhbiBnZXQgYW4gZXJyb3IsIG9yIHdlIGNhbiBnZXQgYSByZXNwb25zZSB0aGF0IGlzIGFuIGVycm9yXG4gICAgaWYgKGRhdGEud2FzVGhyb3duIHx8IChkYXRhLnJlc3VsdCAmJiBkYXRhLnJlc3VsdC53YXNUaHJvd24pKSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gZGF0YS53YXNUaHJvd25cbiAgICAgICAgPyBkYXRhLnJlc3VsdC52YWx1ZSB8fCBkYXRhLnJlc3VsdC5kZXNjcmlwdGlvblxuICAgICAgICA6IGRhdGEucmVzdWx0LnJlc3VsdC52YWx1ZSB8fCBkYXRhLnJlc3VsdC5yZXN1bHQuZGVzY3JpcHRpb247XG4gICAgICByZXR1cm4gcmVqZWN0Q2FsbChuZXcgRXJyb3IobWVzc2FnZSkpO1xuICAgIH1cblxuICAgIGxldCB7XG4gICAgICBpZDogbXNnSWQsXG4gICAgICByZXN1bHQsXG4gICAgICBwYXJhbXMsXG4gICAgICBlcnJvcixcbiAgICB9ID0gZGF0YTtcblxuICAgIGxldCBtZXRob2QgPSB0aGlzLmRhdGFNZXRob2RzW21zZ0lkXSB8fCBkYXRhLm1ldGhvZDtcbiAgICBpZiAodGhpcy5pc1RhcmdldEJhc2VkKSB7XG4gICAgICBpZiAoIV8uc3RhcnRzV2l0aChkYXRhLm1ldGhvZCwgJ1RhcmdldCcpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcmVjZWlwdCBmb3IgbWVzc2FnZSAnJHttc2dJZH0nYCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChkYXRhLnBhcmFtcy5tZXNzYWdlKSB7XG4gICAgICAgIGxldCBtZXNzYWdlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIG1lc3NhZ2UgPSBKU09OLnBhcnNlKGRhdGEucGFyYW1zLm1lc3NhZ2UpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAvLyB0aGlzIHNob3VsZCBuZXZlciBoYXBwZW4sIHNvIGxvZyBhcyBtdWNoIGluZm9ybWF0aW9uIGFzIHBvc3NpYmxlXG4gICAgICAgICAgLy8gc2luY2Ugd2UgbmVlZCB0byBhY2NvbW9kYXRlIHNvbWV0aGluZyB3ZSBoYXZlIG5vdCBzZWVuXG4gICAgICAgICAgbG9nLmVycm9yKGBVbmFibGUgdG8gcGFyc2UgbWVzc2FnZTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgICBsb2cuZXJyb3IoYERhdGE6YCk7XG4gICAgICAgICAgbG9nLmVycm9yKGAke0pTT04uc3RyaW5naWZ5KGRhdGEsIG51bGwsIDIpfWApO1xuICAgICAgICAgIC8vIGNvbnRpbnVlLiBtYXliZSBzb21ldGhpbmcgY2FuIGJlIHNhbHZhZ2VkP1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gZ2V0IG5lc3RlZCBwYXJhbXMgaWYgbmVjZXNzYXJ5XG4gICAgICAgIHBhcmFtcyA9IG1lc3NhZ2UucGFyYW1zIHx8IHBhcmFtcztcblxuICAgICAgICAvLyB0aGUgbWVzc2FnZSBpcyBhZ2dyYXZhdGluZ2x5IG5lc3RlZFxuICAgICAgICBpZiAobWVzc2FnZS5yZXN1bHQpIHtcbiAgICAgICAgICByZXN1bHQgPSBtZXNzYWdlLnJlc3VsdDtcbiAgICAgICAgICBpZiAobWVzc2FnZS5yZXN1bHQucmVzdWx0KSB7XG4gICAgICAgICAgICByZXN1bHQgPSBtZXNzYWdlLnJlc3VsdC5yZXN1bHQ7XG4gICAgICAgICAgICBpZiAobWVzc2FnZS5yZXN1bHQucmVzdWx0LnZhbHVlKSB7XG4gICAgICAgICAgICAgIHJlc3VsdCA9IG1lc3NhZ2UucmVzdWx0LnJlc3VsdC52YWx1ZTtcbiAgICAgICAgICAgICAgLy8gb25seSBhdCB0aGlzIGxldmVsIGlzIHBhcnNpbmcgdGhlIHJlc3VsdCBuZWNlc3NhcnlcbiAgICAgICAgICAgICAgaWYgKF8uaXNTdHJpbmcocmVzdWx0KSkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQgPSBKU09OLnBhcnNlKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbXNnSWQgPSBtZXNzYWdlLmlkO1xuICAgICAgICBtZXRob2QgPSBtZXNzYWdlLm1ldGhvZCB8fCBtZXRob2Q7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gd2hlbiBzZW5kaW5nIHdlIHNldCBhIGRhdGEgbWV0aG9kIGFuZCBhc3NvY2lhdGVkIGNhbGxiYWNrLlxuICAgIC8vIGdldCB0aGF0LCBvciB0aGUgZ2VuZXJpYyAoYXV0b21hdGljYWxseSBzZW50LCBub3QgYXNzb2NpYXRlZFxuICAgIC8vIHdpdGggYSBwYXJ0aWN1bGFyIHJlcXVlc3QpIG1ldGhvZFxuICAgIGlmICghbWV0aG9kKSB7XG4gICAgICByZXR1cm4gcmVqZWN0Q2FsbChcbiAgICAgICAgbmV3IFdlYktpdFJQQ1dhcm5pbmcoYERpZCBub3QgZmluZCBhbnkgaGFuZGxlcnMgZm9yICR7bXNnSWQgPyBgJyR7bXNnSWR9J2AgOiAncmVjZW50J30gbWVzc2FnZWApKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBGb3VuZCBtZXRob2QgJyR7bWV0aG9kfScgJHttc2dJZCA/IGBmb3IgbWVzc2FnZSAnJHttc2dJZH0nYCA6ICcnfWApO1xuICAgIGxldCBpc0V2ZW50SGFuZGxlZCA9IGZhbHNlO1xuICAgIHN3aXRjaCAobWV0aG9kKSB7XG4gICAgICBjYXNlICdQcm9maWxlci5yZXNldFByb2ZpbGVzJzpcbiAgICAgICAgbG9nLmRlYnVnKCdEZXZpY2UgaXMgdGVsbGluZyB1cyB0byByZXNldCBwcm9maWxlcy4gU2hvdWxkIHByb2JhYmx5ICcgK1xuICAgICAgICAgICAgICAgICAgJ2RvIHNvbWUga2luZCBvZiBjYWxsYmFjayBoZXJlJyk7XG4gICAgICAgIGlzRXZlbnRIYW5kbGVkID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdUaW1lbGluZS5ldmVudFJlY29yZGVkJzpcbiAgICAgICAgaWYgKHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICAgICAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyKHJlc3VsdCk7XG4gICAgICAgICAgaXNFdmVudEhhbmRsZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnQ29uc29sZS5tZXNzYWdlc0NsZWFyZWQnOlxuICAgICAgICAvLyBwYXNzXG4gICAgICAgIGlzRXZlbnRIYW5kbGVkID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdDb25zb2xlLm1lc3NhZ2VBZGRlZCc6XG4gICAgICAgIGlmICh0aGlzLmNvbnNvbGVFdmVudEhhbmRsZXIpIHtcbiAgICAgICAgICB0aGlzLmNvbnNvbGVFdmVudEhhbmRsZXIocGFyYW1zLm1lc3NhZ2UpO1xuICAgICAgICAgIGlzRXZlbnRIYW5kbGVkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1BhZ2UubmF2aWdhdGUnOlxuICAgICAgICBsb2cuZGVidWcoYFJlY2VpdmVkIHBhZ2UgbmF2aWdhdGVkIG1lc3NhZ2U6ICR7c2ltcGxlU3RyaW5naWZ5KGRhdGEpfWApO1xuICAgICAgICBpc0V2ZW50SGFuZGxlZCA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnTmV0d29yay5kYXRhUmVjZWl2ZWQnOlxuICAgICAgY2FzZSAnTmV0d29yay5yZXF1ZXN0V2lsbEJlU2VudCc6XG4gICAgICBjYXNlICdOZXR3b3JrLnJlc3BvbnNlUmVjZWl2ZWQnOlxuICAgICAgY2FzZSAnTmV0d29yay5sb2FkaW5nRmluaXNoZWQnOlxuICAgICAgY2FzZSAnTmV0d29yay5sb2FkaW5nRmFpbGVkJzpcbiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLm5ldHdvcmtFdmVudEhhbmRsZXIpKSB7XG4gICAgICAgICAgdGhpcy5uZXR3b3JrRXZlbnRIYW5kbGVyKG1ldGhvZCwgcGFyYW1zKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdUYXJnZXQudGFyZ2V0Q3JlYXRlZCc6XG4gICAgICAgIHRoaXMuYWRkVGFyZ2V0KHBhcmFtcy50YXJnZXRJbmZvKTtcbiAgICAgICAgaXNFdmVudEhhbmRsZWQgPSB0cnVlO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1RhcmdldC50YXJnZXREZXN0cm95ZWQnOlxuICAgICAgICB0aGlzLnJlbW92ZVRhcmdldChwYXJhbXMpO1xuICAgICAgICBpc0V2ZW50SGFuZGxlZCA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAoIWRhdGEuZXJyb3IgJiYgXy5oYXModGhpcy5kYXRhSGFuZGxlcnMsIG1zZ0lkKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXShyZXN1bHQpO1xuICAgIH1cbiAgICBpZiAoZGF0YS5lcnJvciAmJiBfLmhhcyh0aGlzLmVycm9ySGFuZGxlcnMsIG1zZ0lkKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZXJyb3JIYW5kbGVyc1ttc2dJZF0oZXJyb3IpO1xuICAgIH1cbiAgICBpZiAoIWlzRXZlbnRIYW5kbGVkKSB7XG4gICAgICBsb2cuZGVidWcoYFRoZXJlIGlzIG5vIGhhbmRsZXIgc2NoZWR1bGVkIGZvciBtZXRob2QgJyR7bWV0aG9kfScgaW4gJHttc2dJZCA/IGBtZXNzYWdlICcke21zZ0lkfSdgIDogJ3JlY2VudCBtZXNzYWdlcyd9YCk7XG4gICAgfVxuICB9XG5cbiAgc2V0VGltZWxpbmVFdmVudEhhbmRsZXIgKHRpbWVsaW5lRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy50aW1lbGluZUV2ZW50SGFuZGxlciA9IHRpbWVsaW5lRXZlbnRIYW5kbGVyO1xuICB9XG5cbiAgc2V0Q29uc29sZUxvZ0V2ZW50SGFuZGxlciAoY29uc29sZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMuY29uc29sZUV2ZW50SGFuZGxlciA9IGNvbnNvbGVFdmVudEhhbmRsZXI7XG4gIH1cblxuICBzZXROZXR3b3JrTG9nRXZlbnRIYW5kbGVyIChuZXR3b3JrRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy5uZXR3b3JrRXZlbnRIYW5kbGVyID0gbmV0d29ya0V2ZW50SGFuZGxlcjtcbiAgfVxufVxuXG5cbmNsYXNzIFdlYktpdFJQQ1dhcm5pbmcgZXh0ZW5kcyBFUzZFcnJvciB7fVxuIl0sImZpbGUiOiJsaWIvd2Via2l0LXJwYy1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
