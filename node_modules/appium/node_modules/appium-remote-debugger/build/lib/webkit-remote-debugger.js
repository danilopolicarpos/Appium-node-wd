"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WebKitRemoteDebugger = exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _appiumBaseDriver = require("appium-base-driver");

var _remoteDebugger = require("./remote-debugger");

var _webkitRpcClient = _interopRequireDefault(require("./webkit-rpc-client"));

var _lodash = _interopRequireDefault(require("lodash"));

var _url = _interopRequireDefault(require("url"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _helpers = require("./helpers");

class WebKitRemoteDebugger extends _remoteDebugger.RemoteDebugger {
  constructor(opts = {}) {
    opts = Object.assign({
      host: 'localhost'
    }, opts);
    super(_lodash.default.defaults({
      debuggerType: _remoteDebugger.DEBUGGER_TYPES.webkit
    }, opts));
    this.webkitResponseTimeout = opts.webkitResponseTimeout || _remoteDebugger.RPC_RESPONSE_TIMEOUT_MS;
    this.platformVersion = opts.platformVersion;
    this.isSafari = opts.isSafari;
    this.dataMethods = {};
  }

  async connect(pageId) {
    this.rpcClient = new _webkitRpcClient.default({
      host: this.host,
      port: this.port,
      responseTimeout: this.webkitResponseTimeout,
      platformVersion: this.platformVersion,
      isSafari: this.isSafari
    });
    await this.rpcClient.connect(pageId);
  }

  disconnect() {
    if (this.rpcClient && this.rpcClient.isConnected()) {
      this.rpcClient.disconnect();
    }
  }

  isConnected() {
    return !!(this.rpcClient && this.rpcClient.isConnected());
  }

  async pageArrayFromJson(ignoreAboutBlankUrl = false) {
    _logger.default.debug(`Getting WebKitRemoteDebugger pageArray. Host: '${this.host}', port: '${this.port}'`);

    let pageElementJSON = await this.getJsonFromUrl(this.host, this.port, '/json');

    if (pageElementJSON[0] && pageElementJSON[0].deviceId) {
      _logger.default.debug(`Device JSON: ${(0, _helpers.simpleStringify)(pageElementJSON)}`);

      const devices = pageElementJSON.filter(device => device.deviceId !== 'SIMULATOR');

      if (devices.length > 1) {
        _logger.default.debug(`Connected to ${devices.length} devices. ` + `Choosing the first, with udid '${devices[0].deviceId}'.`);
      }

      this.port = devices[0].url.split(':')[1];

      _logger.default.debug(`Received notification that ios-webkit-debug-proxy is listening on port '${this.port}'`);

      pageElementJSON = await this.getJsonFromUrl(this.host, this.port, '/json');
    }

    _logger.default.debug(`Page element JSON: ${(0, _helpers.simpleStringify)(pageElementJSON)}`);

    const newPageArray = pageElementJSON.filter(pageObject => {
      return pageObject.url && (!ignoreAboutBlankUrl || pageObject.url !== 'about:blank');
    }).map(pageObject => {
      const urlArray = pageObject.webSocketDebuggerUrl.split('/').reverse();
      const id = urlArray[0];
      return {
        id,
        title: pageObject.title,
        url: pageObject.url,
        isKey: !!id
      };
    });
    return newPageArray;
  }

  async getJsonFromUrl(hostname, port, pathname) {
    const uri = _url.default.format({
      protocol: 'http',
      hostname,
      port,
      pathname,
      json: true
    });

    _logger.default.debug(`Sending request to: ${uri}`);

    return JSON.parse((await (0, _requestPromise.default)({
      uri,
      method: 'GET'
    })));
  }

  convertResult(res) {
    if (res && res.wasThrown) {
      let message = res.result.value || res.result;
      throw new _appiumBaseDriver.errors.JavaScriptError(message);
    }

    if (res && res.result && res.result.type === 'undefined') {
      res.result.value = {};
    }

    return super.convertResult(res && res.result ? res.result.value : res);
  }

}

exports.WebKitRemoteDebugger = exports.default = WebKitRemoteDebugger;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcmVtb3RlLWRlYnVnZ2VyLmpzIl0sIm5hbWVzIjpbIldlYktpdFJlbW90ZURlYnVnZ2VyIiwiUmVtb3RlRGVidWdnZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJob3N0IiwiXyIsImRlZmF1bHRzIiwiZGVidWdnZXJUeXBlIiwiREVCVUdHRVJfVFlQRVMiLCJ3ZWJraXQiLCJ3ZWJraXRSZXNwb25zZVRpbWVvdXQiLCJSUENfUkVTUE9OU0VfVElNRU9VVF9NUyIsInBsYXRmb3JtVmVyc2lvbiIsImlzU2FmYXJpIiwiZGF0YU1ldGhvZHMiLCJjb25uZWN0IiwicGFnZUlkIiwicnBjQ2xpZW50IiwiV2ViS2l0UnBjQ2xpZW50IiwicG9ydCIsInJlc3BvbnNlVGltZW91dCIsImRpc2Nvbm5lY3QiLCJpc0Nvbm5lY3RlZCIsInBhZ2VBcnJheUZyb21Kc29uIiwiaWdub3JlQWJvdXRCbGFua1VybCIsImxvZyIsImRlYnVnIiwicGFnZUVsZW1lbnRKU09OIiwiZ2V0SnNvbkZyb21VcmwiLCJkZXZpY2VJZCIsImRldmljZXMiLCJmaWx0ZXIiLCJkZXZpY2UiLCJsZW5ndGgiLCJ1cmwiLCJzcGxpdCIsIm5ld1BhZ2VBcnJheSIsInBhZ2VPYmplY3QiLCJtYXAiLCJ1cmxBcnJheSIsIndlYlNvY2tldERlYnVnZ2VyVXJsIiwicmV2ZXJzZSIsImlkIiwidGl0bGUiLCJpc0tleSIsImhvc3RuYW1lIiwicGF0aG5hbWUiLCJ1cmkiLCJmb3JtYXQiLCJwcm90b2NvbCIsImpzb24iLCJKU09OIiwicGFyc2UiLCJtZXRob2QiLCJjb252ZXJ0UmVzdWx0IiwicmVzIiwid2FzVGhyb3duIiwibWVzc2FnZSIsInJlc3VsdCIsInZhbHVlIiwiZXJyb3JzIiwiSmF2YVNjcmlwdEVycm9yIiwidHlwZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHZSxNQUFNQSxvQkFBTixTQUFtQ0MsOEJBQW5DLENBQWtEO0FBQy9EQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFFdEJBLElBQUFBLElBQUksR0FBR0MsTUFBTSxDQUFDQyxNQUFQLENBQWM7QUFDbkJDLE1BQUFBLElBQUksRUFBRTtBQURhLEtBQWQsRUFFSkgsSUFGSSxDQUFQO0FBR0EsVUFBTUksZ0JBQUVDLFFBQUYsQ0FBVztBQUFDQyxNQUFBQSxZQUFZLEVBQUVDLCtCQUFlQztBQUE5QixLQUFYLEVBQWtEUixJQUFsRCxDQUFOO0FBRUEsU0FBS1MscUJBQUwsR0FBNkJULElBQUksQ0FBQ1MscUJBQUwsSUFBOEJDLHVDQUEzRDtBQUVBLFNBQUtDLGVBQUwsR0FBdUJYLElBQUksQ0FBQ1csZUFBNUI7QUFDQSxTQUFLQyxRQUFMLEdBQWdCWixJQUFJLENBQUNZLFFBQXJCO0FBR0EsU0FBS0MsV0FBTCxHQUFtQixFQUFuQjtBQUNEOztBQUVELFFBQU1DLE9BQU4sQ0FBZUMsTUFBZixFQUF1QjtBQUNyQixTQUFLQyxTQUFMLEdBQWlCLElBQUlDLHdCQUFKLENBQW9CO0FBQ25DZCxNQUFBQSxJQUFJLEVBQUUsS0FBS0EsSUFEd0I7QUFFbkNlLE1BQUFBLElBQUksRUFBRSxLQUFLQSxJQUZ3QjtBQUduQ0MsTUFBQUEsZUFBZSxFQUFFLEtBQUtWLHFCQUhhO0FBSW5DRSxNQUFBQSxlQUFlLEVBQUUsS0FBS0EsZUFKYTtBQUtuQ0MsTUFBQUEsUUFBUSxFQUFFLEtBQUtBO0FBTG9CLEtBQXBCLENBQWpCO0FBT0EsVUFBTSxLQUFLSSxTQUFMLENBQWVGLE9BQWYsQ0FBdUJDLE1BQXZCLENBQU47QUFDRDs7QUFFREssRUFBQUEsVUFBVSxHQUFJO0FBQ1osUUFBSSxLQUFLSixTQUFMLElBQWtCLEtBQUtBLFNBQUwsQ0FBZUssV0FBZixFQUF0QixFQUFvRDtBQUNsRCxXQUFLTCxTQUFMLENBQWVJLFVBQWY7QUFDRDtBQUNGOztBQUVEQyxFQUFBQSxXQUFXLEdBQUk7QUFDYixXQUFPLENBQUMsRUFBRSxLQUFLTCxTQUFMLElBQWtCLEtBQUtBLFNBQUwsQ0FBZUssV0FBZixFQUFwQixDQUFSO0FBQ0Q7O0FBRUQsUUFBTUMsaUJBQU4sQ0FBeUJDLG1CQUFtQixHQUFHLEtBQS9DLEVBQXNEO0FBQ3BEQyxvQkFBSUMsS0FBSixDQUFXLGtEQUFpRCxLQUFLdEIsSUFBSyxhQUFZLEtBQUtlLElBQUssR0FBNUY7O0FBQ0EsUUFBSVEsZUFBZSxHQUFHLE1BQU0sS0FBS0MsY0FBTCxDQUFvQixLQUFLeEIsSUFBekIsRUFBK0IsS0FBS2UsSUFBcEMsRUFBMEMsT0FBMUMsQ0FBNUI7O0FBQ0EsUUFBSVEsZUFBZSxDQUFDLENBQUQsQ0FBZixJQUFzQkEsZUFBZSxDQUFDLENBQUQsQ0FBZixDQUFtQkUsUUFBN0MsRUFBdUQ7QUFDckRKLHNCQUFJQyxLQUFKLENBQVcsZ0JBQWUsOEJBQWdCQyxlQUFoQixDQUFpQyxFQUEzRDs7QUFFQSxZQUFNRyxPQUFPLEdBQUdILGVBQWUsQ0FBQ0ksTUFBaEIsQ0FBd0JDLE1BQUQsSUFBWUEsTUFBTSxDQUFDSCxRQUFQLEtBQW9CLFdBQXZELENBQWhCOztBQUNBLFVBQUlDLE9BQU8sQ0FBQ0csTUFBUixHQUFpQixDQUFyQixFQUF3QjtBQUN0QlIsd0JBQUlDLEtBQUosQ0FBVyxnQkFBZUksT0FBTyxDQUFDRyxNQUFPLFlBQS9CLEdBQ0Msa0NBQWlDSCxPQUFPLENBQUMsQ0FBRCxDQUFQLENBQVdELFFBQVMsSUFEaEU7QUFFRDs7QUFDRCxXQUFLVixJQUFMLEdBQVlXLE9BQU8sQ0FBQyxDQUFELENBQVAsQ0FBV0ksR0FBWCxDQUFlQyxLQUFmLENBQXFCLEdBQXJCLEVBQTBCLENBQTFCLENBQVo7O0FBQ0FWLHNCQUFJQyxLQUFKLENBQVcsMkVBQTBFLEtBQUtQLElBQUssR0FBL0Y7O0FBRUFRLE1BQUFBLGVBQWUsR0FBRyxNQUFNLEtBQUtDLGNBQUwsQ0FBb0IsS0FBS3hCLElBQXpCLEVBQStCLEtBQUtlLElBQXBDLEVBQTBDLE9BQTFDLENBQXhCO0FBQ0Q7O0FBQ0RNLG9CQUFJQyxLQUFKLENBQVcsc0JBQXFCLDhCQUFnQkMsZUFBaEIsQ0FBaUMsRUFBakU7O0FBR0EsVUFBTVMsWUFBWSxHQUFHVCxlQUFlLENBQUNJLE1BQWhCLENBQXdCTSxVQUFELElBQWdCO0FBQzFELGFBQU9BLFVBQVUsQ0FBQ0gsR0FBWCxLQUFtQixDQUFDVixtQkFBRCxJQUF3QmEsVUFBVSxDQUFDSCxHQUFYLEtBQW1CLGFBQTlELENBQVA7QUFDRCxLQUZvQixFQUVsQkksR0FGa0IsQ0FFYkQsVUFBRCxJQUFnQjtBQUNyQixZQUFNRSxRQUFRLEdBQUdGLFVBQVUsQ0FBQ0csb0JBQVgsQ0FBZ0NMLEtBQWhDLENBQXNDLEdBQXRDLEVBQTJDTSxPQUEzQyxFQUFqQjtBQUNBLFlBQU1DLEVBQUUsR0FBR0gsUUFBUSxDQUFDLENBQUQsQ0FBbkI7QUFDQSxhQUFPO0FBQ0xHLFFBQUFBLEVBREs7QUFFTEMsUUFBQUEsS0FBSyxFQUFFTixVQUFVLENBQUNNLEtBRmI7QUFHTFQsUUFBQUEsR0FBRyxFQUFFRyxVQUFVLENBQUNILEdBSFg7QUFJTFUsUUFBQUEsS0FBSyxFQUFFLENBQUMsQ0FBQ0Y7QUFKSixPQUFQO0FBTUQsS0FYb0IsQ0FBckI7QUFhQSxXQUFPTixZQUFQO0FBQ0Q7O0FBRUQsUUFBTVIsY0FBTixDQUFzQmlCLFFBQXRCLEVBQWdDMUIsSUFBaEMsRUFBc0MyQixRQUF0QyxFQUFnRDtBQUM5QyxVQUFNQyxHQUFHLEdBQUdiLGFBQUljLE1BQUosQ0FBVztBQUNyQkMsTUFBQUEsUUFBUSxFQUFFLE1BRFc7QUFFckJKLE1BQUFBLFFBRnFCO0FBR3JCMUIsTUFBQUEsSUFIcUI7QUFJckIyQixNQUFBQSxRQUpxQjtBQUtyQkksTUFBQUEsSUFBSSxFQUFFO0FBTGUsS0FBWCxDQUFaOztBQU9BekIsb0JBQUlDLEtBQUosQ0FBVyx1QkFBc0JxQixHQUFJLEVBQXJDOztBQUNBLFdBQU9JLElBQUksQ0FBQ0MsS0FBTCxFQUFXLE1BQU0sNkJBQVE7QUFBQ0wsTUFBQUEsR0FBRDtBQUFNTSxNQUFBQSxNQUFNLEVBQUU7QUFBZCxLQUFSLENBQWpCLEVBQVA7QUFDRDs7QUFFREMsRUFBQUEsYUFBYSxDQUFFQyxHQUFGLEVBQU87QUFnQmxCLFFBQUlBLEdBQUcsSUFBSUEsR0FBRyxDQUFDQyxTQUFmLEVBQTBCO0FBRXhCLFVBQUlDLE9BQU8sR0FBR0YsR0FBRyxDQUFDRyxNQUFKLENBQVdDLEtBQVgsSUFBb0JKLEdBQUcsQ0FBQ0csTUFBdEM7QUFDQSxZQUFNLElBQUlFLHlCQUFPQyxlQUFYLENBQTJCSixPQUEzQixDQUFOO0FBQ0Q7O0FBRUQsUUFBSUYsR0FBRyxJQUFJQSxHQUFHLENBQUNHLE1BQVgsSUFBcUJILEdBQUcsQ0FBQ0csTUFBSixDQUFXSSxJQUFYLEtBQW9CLFdBQTdDLEVBQTBEO0FBR3hEUCxNQUFBQSxHQUFHLENBQUNHLE1BQUosQ0FBV0MsS0FBWCxHQUFtQixFQUFuQjtBQUNEOztBQUdELFdBQU8sTUFBTUwsYUFBTixDQUFvQkMsR0FBRyxJQUFJQSxHQUFHLENBQUNHLE1BQVgsR0FBb0JILEdBQUcsQ0FBQ0csTUFBSixDQUFXQyxLQUEvQixHQUF1Q0osR0FBM0QsQ0FBUDtBQUNEOztBQW5IOEQiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bWFpblxuXG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBSZW1vdGVEZWJ1Z2dlciwgREVCVUdHRVJfVFlQRVMsIFJQQ19SRVNQT05TRV9USU1FT1VUX01TIH0gZnJvbSAnLi9yZW1vdGUtZGVidWdnZXInO1xuaW1wb3J0IFdlYktpdFJwY0NsaWVudCBmcm9tICcuL3dlYmtpdC1ycGMtY2xpZW50JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHsgc2ltcGxlU3RyaW5naWZ5IH0gZnJvbSAnLi9oZWxwZXJzJztcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXZWJLaXRSZW1vdGVEZWJ1Z2dlciBleHRlbmRzIFJlbW90ZURlYnVnZ2VyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIC8vIG1ha2Ugc3VyZSB0aGVyZSBpcyBhIGhvc3RcbiAgICBvcHRzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICBob3N0OiAnbG9jYWxob3N0JyxcbiAgICB9LCBvcHRzKTtcbiAgICBzdXBlcihfLmRlZmF1bHRzKHtkZWJ1Z2dlclR5cGU6IERFQlVHR0VSX1RZUEVTLndlYmtpdH0sIG9wdHMpKTtcblxuICAgIHRoaXMud2Via2l0UmVzcG9uc2VUaW1lb3V0ID0gb3B0cy53ZWJraXRSZXNwb25zZVRpbWVvdXQgfHwgUlBDX1JFU1BPTlNFX1RJTUVPVVRfTVM7XG5cbiAgICB0aGlzLnBsYXRmb3JtVmVyc2lvbiA9IG9wdHMucGxhdGZvcm1WZXJzaW9uO1xuICAgIHRoaXMuaXNTYWZhcmkgPSBvcHRzLmlzU2FmYXJpO1xuXG4gICAgLy8gdXNlZCB0byBzdG9yZSBjYWxsYmFjayB0eXBlcyB3aGVuIHNlbmRpbmcgcmVxdWVzdHNcbiAgICB0aGlzLmRhdGFNZXRob2RzID0ge307XG4gIH1cblxuICBhc3luYyBjb25uZWN0IChwYWdlSWQpIHtcbiAgICB0aGlzLnJwY0NsaWVudCA9IG5ldyBXZWJLaXRScGNDbGllbnQoe1xuICAgICAgaG9zdDogdGhpcy5ob3N0LFxuICAgICAgcG9ydDogdGhpcy5wb3J0LFxuICAgICAgcmVzcG9uc2VUaW1lb3V0OiB0aGlzLndlYmtpdFJlc3BvbnNlVGltZW91dCxcbiAgICAgIHBsYXRmb3JtVmVyc2lvbjogdGhpcy5wbGF0Zm9ybVZlcnNpb24sXG4gICAgICBpc1NhZmFyaTogdGhpcy5pc1NhZmFyaSxcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5jb25uZWN0KHBhZ2VJZCk7XG4gIH1cblxuICBkaXNjb25uZWN0ICgpIHtcbiAgICBpZiAodGhpcy5ycGNDbGllbnQgJiYgdGhpcy5ycGNDbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgdGhpcy5ycGNDbGllbnQuZGlzY29ubmVjdCgpO1xuICAgIH1cbiAgfVxuXG4gIGlzQ29ubmVjdGVkICgpIHtcbiAgICByZXR1cm4gISEodGhpcy5ycGNDbGllbnQgJiYgdGhpcy5ycGNDbGllbnQuaXNDb25uZWN0ZWQoKSk7XG4gIH1cblxuICBhc3luYyBwYWdlQXJyYXlGcm9tSnNvbiAoaWdub3JlQWJvdXRCbGFua1VybCA9IGZhbHNlKSB7XG4gICAgbG9nLmRlYnVnKGBHZXR0aW5nIFdlYktpdFJlbW90ZURlYnVnZ2VyIHBhZ2VBcnJheS4gSG9zdDogJyR7dGhpcy5ob3N0fScsIHBvcnQ6ICcke3RoaXMucG9ydH0nYCk7XG4gICAgbGV0IHBhZ2VFbGVtZW50SlNPTiA9IGF3YWl0IHRoaXMuZ2V0SnNvbkZyb21VcmwodGhpcy5ob3N0LCB0aGlzLnBvcnQsICcvanNvbicpO1xuICAgIGlmIChwYWdlRWxlbWVudEpTT05bMF0gJiYgcGFnZUVsZW1lbnRKU09OWzBdLmRldmljZUlkKSB7XG4gICAgICBsb2cuZGVidWcoYERldmljZSBKU09OOiAke3NpbXBsZVN0cmluZ2lmeShwYWdlRWxlbWVudEpTT04pfWApO1xuXG4gICAgICBjb25zdCBkZXZpY2VzID0gcGFnZUVsZW1lbnRKU09OLmZpbHRlcigoZGV2aWNlKSA9PiBkZXZpY2UuZGV2aWNlSWQgIT09ICdTSU1VTEFUT1InKTtcbiAgICAgIGlmIChkZXZpY2VzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBDb25uZWN0ZWQgdG8gJHtkZXZpY2VzLmxlbmd0aH0gZGV2aWNlcy4gYCArXG4gICAgICAgICAgICAgICAgICBgQ2hvb3NpbmcgdGhlIGZpcnN0LCB3aXRoIHVkaWQgJyR7ZGV2aWNlc1swXS5kZXZpY2VJZH0nLmApO1xuICAgICAgfVxuICAgICAgdGhpcy5wb3J0ID0gZGV2aWNlc1swXS51cmwuc3BsaXQoJzonKVsxXTtcbiAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgbm90aWZpY2F0aW9uIHRoYXQgaW9zLXdlYmtpdC1kZWJ1Zy1wcm94eSBpcyBsaXN0ZW5pbmcgb24gcG9ydCAnJHt0aGlzLnBvcnR9J2ApO1xuXG4gICAgICBwYWdlRWxlbWVudEpTT04gPSBhd2FpdCB0aGlzLmdldEpzb25Gcm9tVXJsKHRoaXMuaG9zdCwgdGhpcy5wb3J0LCAnL2pzb24nKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBQYWdlIGVsZW1lbnQgSlNPTjogJHtzaW1wbGVTdHJpbmdpZnkocGFnZUVsZW1lbnRKU09OKX1gKTtcblxuICAgIC8vIEFkZCBlbGVtZW50cyB0byBhbiBhcnJheVxuICAgIGNvbnN0IG5ld1BhZ2VBcnJheSA9IHBhZ2VFbGVtZW50SlNPTi5maWx0ZXIoKHBhZ2VPYmplY3QpID0+IHtcbiAgICAgIHJldHVybiBwYWdlT2JqZWN0LnVybCAmJiAoIWlnbm9yZUFib3V0QmxhbmtVcmwgfHwgcGFnZU9iamVjdC51cmwgIT09ICdhYm91dDpibGFuaycpO1xuICAgIH0pLm1hcCgocGFnZU9iamVjdCkgPT4ge1xuICAgICAgY29uc3QgdXJsQXJyYXkgPSBwYWdlT2JqZWN0LndlYlNvY2tldERlYnVnZ2VyVXJsLnNwbGl0KCcvJykucmV2ZXJzZSgpO1xuICAgICAgY29uc3QgaWQgPSB1cmxBcnJheVswXTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkLFxuICAgICAgICB0aXRsZTogcGFnZU9iamVjdC50aXRsZSxcbiAgICAgICAgdXJsOiBwYWdlT2JqZWN0LnVybCxcbiAgICAgICAgaXNLZXk6ICEhaWQsXG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIG5ld1BhZ2VBcnJheTtcbiAgfVxuXG4gIGFzeW5jIGdldEpzb25Gcm9tVXJsIChob3N0bmFtZSwgcG9ydCwgcGF0aG5hbWUpIHtcbiAgICBjb25zdCB1cmkgPSB1cmwuZm9ybWF0KHtcbiAgICAgIHByb3RvY29sOiAnaHR0cCcsXG4gICAgICBob3N0bmFtZSxcbiAgICAgIHBvcnQsXG4gICAgICBwYXRobmFtZSxcbiAgICAgIGpzb246IHRydWUsXG4gICAgfSk7XG4gICAgbG9nLmRlYnVnKGBTZW5kaW5nIHJlcXVlc3QgdG86ICR7dXJpfWApO1xuICAgIHJldHVybiBKU09OLnBhcnNlKGF3YWl0IHJlcXVlc3Qoe3VyaSwgbWV0aG9kOiAnR0VUJ30pKTtcbiAgfVxuXG4gIGNvbnZlcnRSZXN1bHQgKHJlcykge1xuICAgIC8vIFdlYktpdCByZXR1cm5zIGEgcmVzdWx0IHdyYXBwZWQgZGVlcGVyIHRoYW4gdGhlIFJlbW90ZSBEZWJ1Z2dlcjpcbiAgICAvLyAgIHtcbiAgICAvLyAgICAgcmVzdWx0OiB7XG4gICAgLy8gICAgICAgdHlwZTogXCJzdHJpbmdcIixcbiAgICAvLyAgICAgICB2YWx1ZToge1xuICAgIC8vICAgICAgICAgc3RhdHVzOiAwLFxuICAgIC8vICAgICAgICAgdmFsdWU6IHtcbiAgICAvLyAgICAgICAgICAgRUxFTUVOVDogXCI6d2RjOjE0NDE4MTk3NDAwNjBcIlxuICAgIC8vICAgICAgICAgfVxuICAgIC8vICAgICAgIH1cbiAgICAvLyAgICAgfSxcbiAgICAvLyAgICAgd2FzVGhyb3duOiBmYWxzZVxuICAgIC8vICAgfVxuXG4gICAgLy8gY2hlY2sgZm9yIGVycm9yc1xuICAgIGlmIChyZXMgJiYgcmVzLndhc1Rocm93bikge1xuICAgICAgLy8gd2UgZ290IHNvbWUgZm9ybSBvZiBlcnJvci5cbiAgICAgIGxldCBtZXNzYWdlID0gcmVzLnJlc3VsdC52YWx1ZSB8fCByZXMucmVzdWx0O1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5KYXZhU2NyaXB0RXJyb3IobWVzc2FnZSk7XG4gICAgfVxuXG4gICAgaWYgKHJlcyAmJiByZXMucmVzdWx0ICYmIHJlcy5yZXN1bHQudHlwZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIC8vIGlmIGl0IGRvZXNuJ3QgdGhyb3cgYW4gZXJyb3IsIHdlIGp1c3Qgd2FudCB0byBwdXQgaW4gYVxuICAgICAgLy8gcGxhY2UgaG9sZGVyLiB0aGlzIGhhcHBlbnMgd2hlbiB3ZSBoYXZlIGFuIGFzeW5jIGV4ZWN1dGUgcmVxdWVzdFxuICAgICAgcmVzLnJlc3VsdC52YWx1ZSA9IHt9O1xuICAgIH1cblxuICAgIC8vIHNlbmQgdGhlIGFjdHVhbCByZXN1bHQgdG8gdGhlIFJlbW90ZSBEZWJ1Z2dlciBjb252ZXJ0ZXJcbiAgICByZXR1cm4gc3VwZXIuY29udmVydFJlc3VsdChyZXMgJiYgcmVzLnJlc3VsdCA/IHJlcy5yZXN1bHQudmFsdWUgOiByZXMpO1xuICB9XG59XG5cbmV4cG9ydCB7IFdlYktpdFJlbW90ZURlYnVnZ2VyIH07XG4iXSwiZmlsZSI6ImxpYi93ZWJraXQtcmVtb3RlLWRlYnVnZ2VyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
