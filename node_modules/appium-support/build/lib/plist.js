"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parsePlistFile = parsePlistFile;
exports.parsePlist = parsePlist;
exports.createPlist = createPlist;
exports.updatePlistFile = updatePlistFile;
exports.createBinaryPlist = createBinaryPlist;
exports.parseBinaryPlist = parseBinaryPlist;

require("source-map-support/register");

var _plist = _interopRequireDefault(require("plist"));

var _bplistCreator = _interopRequireDefault(require("bplist-creator"));

var _bplistParser = _interopRequireDefault(require("bplist-parser"));

var _fs = _interopRequireDefault(require("./fs"));

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const BPLIST_IDENTIFIER = {
  BUFFER: Buffer.from('bplist00'),
  TEXT: 'bplist00'
};
const PLIST_IDENTIFIER = {
  BUFFER: Buffer.from('<'),
  TEXT: '<'
};

let parseFile = _bluebird.default.promisify(_bplistParser.default.parseFile);

async function parseXmlPlistFile(plistFilename) {
  let xmlContent = await _fs.default.readFile(plistFilename, 'utf8');
  return _plist.default.parse(xmlContent);
}

async function parsePlistFile(plist, mustExist = true, quiet = true) {
  if (!(await _fs.default.exists(plist))) {
    if (mustExist) {
      _logger.default.errorAndThrow(`Plist file doesn't exist: '${plist}'`);
    } else {
      _logger.default.debug(`Plist file '${plist}' does not exist. Returning an empty plist.`);

      return {};
    }
  }

  let obj = {};
  let type = 'binary';

  try {
    obj = await parseFile(plist);

    if (obj.length) {
      obj = obj[0];
    } else {
      throw new Error(`Binary file '${plist}'' appears to be empty`);
    }
  } catch (ign) {
    try {
      obj = await parseXmlPlistFile(plist);
      type = 'xml';
    } catch (err) {
      _logger.default.errorAndThrow(`Could not parse plist file '${plist}' as XML: ${err.message}`);
    }
  }

  if (!quiet) {
    _logger.default.debug(`Parsed plist file '${plist}' as ${type}`);
  }

  return obj;
}

async function updatePlistFile(plist, updatedFields, binary = true, mustExist = true, quiet = true) {
  let obj;

  try {
    obj = await parsePlistFile(plist, mustExist);
  } catch (err) {
    _logger.default.errorAndThrow(`Could not update plist: ${err.message}`);
  }

  _lodash.default.extend(obj, updatedFields);

  let newPlist = binary ? (0, _bplistCreator.default)(obj) : _plist.default.build(obj);

  try {
    await _fs.default.writeFile(plist, newPlist);
  } catch (err) {
    _logger.default.errorAndThrow(`Could not save plist: ${err.message}`);
  }

  if (!quiet) {
    _logger.default.debug(`Wrote plist file '${plist}'`);
  }
}

function createBinaryPlist(data) {
  return (0, _bplistCreator.default)(data);
}

function parseBinaryPlist(data) {
  return _bplistParser.default.parseBuffer(data);
}

function getXmlPlist(data) {
  if (_lodash.default.isString(data) && data.startsWith(PLIST_IDENTIFIER.TEXT)) {
    return data;
  }

  if (_lodash.default.isBuffer(data) && PLIST_IDENTIFIER.BUFFER.compare(data, 0, PLIST_IDENTIFIER.BUFFER.length) === 0) {
    return data.toString();
  }

  return null;
}

function getBinaryPlist(data) {
  if (_lodash.default.isString(data) && data.startsWith(BPLIST_IDENTIFIER.TEXT)) {
    return Buffer.from(data);
  }

  if (_lodash.default.isBuffer(data) && BPLIST_IDENTIFIER.BUFFER.compare(data, 0, BPLIST_IDENTIFIER.BUFFER.length) === 0) {
    return data;
  }

  return null;
}

function createPlist(object, binary = false) {
  if (binary) {
    return createBinaryPlist(object);
  } else {
    return _plist.default.build(object);
  }
}

function parsePlist(data) {
  let textPlist = getXmlPlist(data);

  if (textPlist) {
    return _plist.default.parse(textPlist);
  }

  let binaryPlist = getBinaryPlist(data);

  if (binaryPlist) {
    return parseBinaryPlist(binaryPlist)[0];
  }

  throw new Error(`Unknown type of plist, data: ${data.toString()}`);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9wbGlzdC5qcyJdLCJuYW1lcyI6WyJCUExJU1RfSURFTlRJRklFUiIsIkJVRkZFUiIsIkJ1ZmZlciIsImZyb20iLCJURVhUIiwiUExJU1RfSURFTlRJRklFUiIsInBhcnNlRmlsZSIsIkIiLCJwcm9taXNpZnkiLCJicGxpc3RQYXJzZSIsInBhcnNlWG1sUGxpc3RGaWxlIiwicGxpc3RGaWxlbmFtZSIsInhtbENvbnRlbnQiLCJmcyIsInJlYWRGaWxlIiwieG1scGxpc3QiLCJwYXJzZSIsInBhcnNlUGxpc3RGaWxlIiwicGxpc3QiLCJtdXN0RXhpc3QiLCJxdWlldCIsImV4aXN0cyIsImxvZyIsImVycm9yQW5kVGhyb3ciLCJkZWJ1ZyIsIm9iaiIsInR5cGUiLCJsZW5ndGgiLCJFcnJvciIsImlnbiIsImVyciIsIm1lc3NhZ2UiLCJ1cGRhdGVQbGlzdEZpbGUiLCJ1cGRhdGVkRmllbGRzIiwiYmluYXJ5IiwiXyIsImV4dGVuZCIsIm5ld1BsaXN0IiwiYnVpbGQiLCJ3cml0ZUZpbGUiLCJjcmVhdGVCaW5hcnlQbGlzdCIsImRhdGEiLCJwYXJzZUJpbmFyeVBsaXN0IiwicGFyc2VCdWZmZXIiLCJnZXRYbWxQbGlzdCIsImlzU3RyaW5nIiwic3RhcnRzV2l0aCIsImlzQnVmZmVyIiwiY29tcGFyZSIsInRvU3RyaW5nIiwiZ2V0QmluYXJ5UGxpc3QiLCJjcmVhdGVQbGlzdCIsIm9iamVjdCIsInBhcnNlUGxpc3QiLCJ0ZXh0UGxpc3QiLCJiaW5hcnlQbGlzdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGlCQUFpQixHQUFHO0FBQ3hCQyxFQUFBQSxNQUFNLEVBQUVDLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZLFVBQVosQ0FEZ0I7QUFFeEJDLEVBQUFBLElBQUksRUFBRTtBQUZrQixDQUExQjtBQUlBLE1BQU1DLGdCQUFnQixHQUFHO0FBQ3ZCSixFQUFBQSxN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O0FBQ3hHLFdBQU9jLElBQVA7QUFDRDs7QUFDRCxTQUFPLElBQVA7QUFDRDs7QUFRRCxTQUFTVSxXQUFULENBQXNCQyxNQUF0QixFQUE4QmxCLE1BQU0sR0FBRyxLQUF2QyxFQUE4QztBQUM1QyxNQUFJQSxNQUFKLEVBQVk7QUFDVixXQUFPTSxpQkFBaUIsQ0FBQ1ksTUFBRCxDQUF4QjtBQUNELEdBRkQsTUFFTztBQUNMLFdBQU9yQyxlQUFTdUIsS0FBVCxDQUFlYyxNQUFmLENBQVA7QUFDRDtBQUNGOztBQVFELFNBQVNDLFVBQVQsQ0FBcUJaLElBQXJCLEVBQTJCO0FBQ3pCLE1BQUlhLFNBQVMsR0FBR1YsV0FBVyxDQUFDSCxJQUFELENBQTNCOztBQUNBLE1BQUlhLFNBQUosRUFBZTtBQUNiLFdBQU92QyxlQUFTQyxLQUFULENBQWVzQyxTQUFmLENBQVA7QUFDRDs7QUFFRCxNQUFJQyxXQUFXLEdBQUdMLGNBQWMsQ0FBQ1QsSUFBRCxDQUFoQzs7QUFDQSxNQUFJYyxXQUFKLEVBQWlCO0FBQ2YsV0FBT2IsZ0JBQWdCLENBQUNhLFdBQUQsQ0FBaEIsQ0FBOEIsQ0FBOUIsQ0FBUDtBQUNEOztBQUVELFFBQU0sSUFBSTNCLEtBQUosQ0FBVyxnQ0FBK0JhLElBQUksQ0FBQ1EsUUFBTCxFQUFnQixFQUExRCxDQUFOO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeG1scGxpc3QgZnJvbSAncGxpc3QnO1xuaW1wb3J0IGJwbGlzdENyZWF0ZSBmcm9tICdicGxpc3QtY3JlYXRvcic7XG5pbXBvcnQgYnBsaXN0UGFyc2UgZnJvbSAnYnBsaXN0LXBhcnNlcic7XG5pbXBvcnQgZnMgZnJvbSAnLi9mcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cbmNvbnN0IEJQTElTVF9JREVOVElGSUVSID0ge1xuICBCVUZGRVI6IEJ1ZmZlci5mcm9tKCdicGxpc3QwMCcpLFxuICBURVhUOiAnYnBsaXN0MDAnXG59O1xuY29uc3QgUExJU1RfSURFTlRJRklFUiA9IHtcbiAgQlVGRkVSOiBCdWZmZXIuZnJvbSgnPCcpLFxuICBURVhUOiAnPCdcbn07XG5cbmxldCBwYXJzZUZpbGUgPSBCLnByb21pc2lmeShicGxpc3RQYXJzZS5wYXJzZUZpbGUpO1xuXG4vLyBYTUwgUGxpc3QgbGlicmFyeSBoZWxwZXJcbmFzeW5jIGZ1bmN0aW9uIHBhcnNlWG1sUGxpc3RGaWxlIChwbGlzdEZpbGVuYW1lKSB7XG4gIGxldCB4bWxDb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUocGxpc3RGaWxlbmFtZSwgJ3V0ZjgnKTtcbiAgcmV0dXJuIHhtbHBsaXN0LnBhcnNlKHhtbENvbnRlbnQpO1xufVxuXG4vKipcbiAqIFBhcnNlcyBhIGZpbGUgaW4geG1sIG9yIGJpbmFyeSBmb3JtYXQgb2YgcGxpc3RcbiAqIEBwYXJhbSB7c3RyaW5nfSBwbGlzdCBUaGUgcGxpc3QgZmlsZSBwYXRoXG4gKiBAcGFyYW0ge2Jvb2xlYW59IG11c3RFeGlzdCBJZiBzZXQgdG8gZmFsc2UsIHRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGFuIGVtcHR5IG9iamVjdCB3aGVuIHRoZSBmaWxlIGRvZXNuJ3QgZXhpc3RcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gcXVpZXQgSWYgc2V0IHRvIGZhbHNlLCB0aGUgcGxpc3QgcGF0aCB3aWxsIGJlIGxvZ2dlZCBpbiBkZWJ1ZyBsZXZlbFxuICogQHJldHVybnMge09iamVjdH0gcGFyc2VkIHBsaXN0IEpTIE9iamVjdFxuICovXG5hc3luYyBmdW5jdGlvbiBwYXJzZVBsaXN0RmlsZSAocGxpc3QsIG11c3RFeGlzdCA9IHRydWUsIHF1aWV0ID0gdHJ1ZSkge1xuICAvLyBoYW5kbGUgbm9uZXhpc3RhbnQgZmlsZVxuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwbGlzdCkpIHtcbiAgICBpZiAobXVzdEV4aXN0KSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgUGxpc3QgZmlsZSBkb2Vzbid0IGV4aXN0OiAnJHtwbGlzdH0nYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgUGxpc3QgZmlsZSAnJHtwbGlzdH0nIGRvZXMgbm90IGV4aXN0LiBSZXR1cm5pbmcgYW4gZW1wdHkgcGxpc3QuYCk7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuICB9XG5cbiAgbGV0IG9iaiA9IHt9O1xuICBsZXQgdHlwZSA9ICdiaW5hcnknO1xuICB0cnkge1xuICAgIG9iaiA9IGF3YWl0IHBhcnNlRmlsZShwbGlzdCk7XG4gICAgaWYgKG9iai5sZW5ndGgpIHtcbiAgICAgIG9iaiA9IG9ialswXTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBCaW5hcnkgZmlsZSAnJHtwbGlzdH0nJyBhcHBlYXJzIHRvIGJlIGVtcHR5YCk7XG4gICAgfVxuICB9IGNhdGNoIChpZ24pIHtcbiAgICB0cnkge1xuICAgICAgb2JqID0gYXdhaXQgcGFyc2VYbWxQbGlzdEZpbGUocGxpc3QpO1xuICAgICAgdHlwZSA9ICd4bWwnO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYENvdWxkIG5vdCBwYXJzZSBwbGlzdCBmaWxlICcke3BsaXN0fScgYXMgWE1MOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIGlmICghcXVpZXQpIHtcbiAgICBsb2cuZGVidWcoYFBhcnNlZCBwbGlzdCBmaWxlICcke3BsaXN0fScgYXMgJHt0eXBlfWApO1xuICB9XG4gIHJldHVybiBvYmo7XG59XG5cbi8qKlxuICogVXBkYXRlcyBhIHBsaXN0IGZpbGUgd2l0aCB0aGUgZ2l2ZW4gZmllbGRzXG4gKiBAcGFyYW0ge3N0cmluZ30gcGxpc3QgVGhlIHBsaXN0IGZpbGUgcGF0aFxuICogQHBhcmFtIHtPYmplY3R9IHVwZGF0ZWRGaWVsZHMgVGhlIHVwZGF0ZWQgZmllbGRzLXZhbHVlIHBhaXJzXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGJpbmFyeSBJZiBzZXQgdG8gZmFsc2UsIHRoZSBmaWxlIHdpbGwgYmUgY3JlYXRlZCBhcyBhIHhtbCBwbGlzdFxuICogQHBhcmFtIHtib29sZWFufSBtdXN0RXhpc3QgSWYgc2V0IHRvIGZhbHNlLCB0aGlzIG1ldGhvZCB3aWxsIHVwZGF0ZSBhbiBlbXB0eSBwbGlzdFxuICogQHBhcmFtIHtib29sZWFufSBxdWlldCBJZiBzZXQgdG8gZmFsc2UsIHRoZSBwbGlzdCBwYXRoIHdpbGwgYmUgbG9nZ2VkIGluIGRlYnVnIGxldmVsXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVBsaXN0RmlsZSAocGxpc3QsIHVwZGF0ZWRGaWVsZHMsIGJpbmFyeSA9IHRydWUsIG11c3RFeGlzdCA9IHRydWUsIHF1aWV0ID0gdHJ1ZSkge1xuICBsZXQgb2JqO1xuICB0cnkge1xuICAgIG9iaiA9IGF3YWl0IHBhcnNlUGxpc3RGaWxlKHBsaXN0LCBtdXN0RXhpc3QpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IHVwZGF0ZSBwbGlzdDogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICBfLmV4dGVuZChvYmosIHVwZGF0ZWRGaWVsZHMpO1xuICBsZXQgbmV3UGxpc3QgPSBiaW5hcnkgPyBicGxpc3RDcmVhdGUob2JqKSA6IHhtbHBsaXN0LmJ1aWxkKG9iaik7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKHBsaXN0LCBuZXdQbGlzdCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3Qgc2F2ZSBwbGlzdDogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICBpZiAoIXF1aWV0KSB7XG4gICAgbG9nLmRlYnVnKGBXcm90ZSBwbGlzdCBmaWxlICcke3BsaXN0fSdgKTtcbiAgfVxufVxuLyoqXG4gKiBDcmVhdGVzIGEgYmluYXJ5IHBsaXN0IEJ1ZmZlciBmcm9tIGFuIG9iamVjdFxuICogQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIG9iamVjdCB0byBiZSB0dXJuZWQgaW50byBhIGJpbmFyeSBwbGlzdFxuICogQHJldHVybnMge0J1ZmZlcn0gcGxpc3QgaW4gdGhlIGZvcm0gb2YgYSBiaW5hcnkgYnVmZmVyXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZUJpbmFyeVBsaXN0IChkYXRhKSB7XG4gIHJldHVybiBicGxpc3RDcmVhdGUoZGF0YSk7XG59XG5cbi8qKlxuICogUGFyc2VzIGEgQnVmZmVyIGludG8gYW4gT2JqZWN0XG4gKiBAcGFyYW0ge0J1ZmZlcn0gZGF0YSBUaGUgYmVmZmVyIG9mIGEgYmluYXJ5IHBsaXN0XG4gKi9cbmZ1bmN0aW9uIHBhcnNlQmluYXJ5UGxpc3QgKGRhdGEpIHtcbiAgcmV0dXJuIGJwbGlzdFBhcnNlLnBhcnNlQnVmZmVyKGRhdGEpO1xufVxuXG5mdW5jdGlvbiBnZXRYbWxQbGlzdCAoZGF0YSkge1xuICBpZiAoXy5pc1N0cmluZyhkYXRhKSAmJiBkYXRhLnN0YXJ0c1dpdGgoUExJU1RfSURFTlRJRklFUi5URVhUKSkge1xuICAgIHJldHVybiBkYXRhO1xuICB9XG4gIGlmIChfLmlzQnVmZmVyKGRhdGEpICYmIFBMSVNUX0lERU5USUZJRVIuQlVGRkVSLmNvbXBhcmUoZGF0YSwgMCwgUExJU1RfSURFTlRJRklFUi5CVUZGRVIubGVuZ3RoKSA9PT0gMCkge1xuICAgIHJldHVybiBkYXRhLnRvU3RyaW5nKCk7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGdldEJpbmFyeVBsaXN0IChkYXRhKSB7XG4gIGlmIChfLmlzU3RyaW5nKGRhdGEpICYmIGRhdGEuc3RhcnRzV2l0aChCUExJU1RfSURFTlRJRklFUi5URVhUKSkge1xuICAgIHJldHVybiBCdWZmZXIuZnJvbShkYXRhKTtcbiAgfVxuXG4gIGlmIChfLmlzQnVmZmVyKGRhdGEpICYmIEJQTElTVF9JREVOVElGSUVSLkJVRkZFUi5jb21wYXJlKGRhdGEsIDAsIEJQTElTVF9JREVOVElGSUVSLkJVRkZFUi5sZW5ndGgpID09PSAwKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbi8qKlxuICogQ3JlYXRlcyBhIHBsaXN0IGZyb20gYW4gb2JqZWN0XG4gKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBKUyBvYmplY3QgdG8gYmUgdHVybmVkIGludG8gYSBwbGlzdFxuICogQHBhcmFtIHtib29sZWFufSBiaW5hcnkgU2V0IGl0IHRvIHRydWUgZm9yIGEgYmluYXJ5IHBsaXN0XG4gKiBAcmV0dXJucyB7c3RyaW5nfEJ1ZmZlcn0gcmV0dXJucyBhIGJ1ZmZlciBvciBhIHN0cmluZyBpbiByZXNwZWN0IHRvIHRoZSBiaW5hcnkgcGFyYW1ldGVyXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVBsaXN0IChvYmplY3QsIGJpbmFyeSA9IGZhbHNlKSB7XG4gIGlmIChiaW5hcnkpIHtcbiAgICByZXR1cm4gY3JlYXRlQmluYXJ5UGxpc3Qob2JqZWN0KTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4geG1scGxpc3QuYnVpbGQob2JqZWN0KTtcbiAgfVxufVxuXG4vKipcbiAqIFBhcnNlcyBhbiBidWZmZXIgb3IgYSBzdHJpbmcgdG8gYSBKUyBvYmplY3QgYSBwbGlzdCBmcm9tIGFuIG9iamVjdFxuICogQHBhcmFtIHtzdHJpbmd8QnVmZmVyfSBkYXRhIFRoZSBwbGlzdCBpbiB0aGUgZm9ybSBvZiBzdHJpbmcgb3IgQnVmZmVyXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBwYXJzZWQgcGxpc3QgSlMgT2JqZWN0XG4gKiBAdGhyb3dzIFdpbGwgdGhyb3cgYW4gZXJyb3IgaWYgdGhlIHBsaXN0IHR5cGUgaXMgdW5rbm93blxuICovXG5mdW5jdGlvbiBwYXJzZVBsaXN0IChkYXRhKSB7XG4gIGxldCB0ZXh0UGxpc3QgPSBnZXRYbWxQbGlzdChkYXRhKTtcbiAgaWYgKHRleHRQbGlzdCkge1xuICAgIHJldHVybiB4bWxwbGlzdC5wYXJzZSh0ZXh0UGxpc3QpO1xuICB9XG5cbiAgbGV0IGJpbmFyeVBsaXN0ID0gZ2V0QmluYXJ5UGxpc3QoZGF0YSk7XG4gIGlmIChiaW5hcnlQbGlzdCkge1xuICAgIHJldHVybiBwYXJzZUJpbmFyeVBsaXN0KGJpbmFyeVBsaXN0KVswXTtcbiAgfVxuXG4gIHRocm93IG5ldyBFcnJvcihgVW5rbm93biB0eXBlIG9mIHBsaXN0LCBkYXRhOiAke2RhdGEudG9TdHJpbmcoKX1gKTtcbn1cblxuZXhwb3J0IHsgcGFyc2VQbGlzdEZpbGUsIHBhcnNlUGxpc3QsIGNyZWF0ZVBsaXN0LCB1cGRhdGVQbGlzdEZpbGUsIGNyZWF0ZUJpbmFyeVBsaXN0LCBwYXJzZUJpbmFyeVBsaXN0IH07XG4iXSwiZmlsZSI6ImxpYi9wbGlzdC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
